<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª¨ë°”ì¼ ë””ë²„ê¹…</title>
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <style>
        body { 
            padding: 10px; 
            font-size: 14px;
            background: #f8f9fa;
        }
        .debug-section { 
            margin: 10px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            background: white;
        }
        .debug-log { 
            background: #000; 
            color: #0f0; 
            padding: 10px; 
            border-radius: 5px; 
            max-height: 300px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .status-label {
            font-weight: bold;
        }
        .status-value {
            color: #666;
        }
        .status-good {
            color: #28a745;
        }
        .status-bad {
            color: #dc3545;
        }
        .status-warning {
            color: #ffc107;
        }
        .btn {
            margin: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h2>ğŸ” ëª¨ë°”ì¼ ë””ë²„ê¹…</h2>
        
        <div class="debug-section">
            <h4>í˜„ì¬ ìƒíƒœ</h4>
            <div id="status-container">
                <div class="status-item">
                    <span class="status-label">ì‚¬ìš©ì:</span>
                    <span id="user-status" class="status-value">í™•ì¸ ì¤‘...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Firebase:</span>
                    <span id="firebase-status" class="status-value">í™•ì¸ ì¤‘...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">ì¹´íŠ¸ (ë¡œì»¬):</span>
                    <span id="local-cart-status" class="status-value">í™•ì¸ ì¤‘...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">ì¹´íŠ¸ (Firebase):</span>
                    <span id="firebase-cart-status" class="status-value">í™•ì¸ ì¤‘...</span>
                </div>
                <div class="status-item">
                    <span class="status-label">ë™ê¸°í™”:</span>
                    <span id="sync-status" class="status-value">í™•ì¸ ì¤‘...</span>
                </div>
            </div>
        </div>
        
        <div class="debug-section">
            <h4>í…ŒìŠ¤íŠ¸ ì‘ì—…</h4>
            <button class="btn btn-primary btn-sm" onclick="refreshStatus()">ìƒíƒœ ìƒˆë¡œê³ ì¹¨</button>
            <button class="btn btn-success btn-sm" onclick="testAddProduct()">í…ŒìŠ¤íŠ¸ ìƒí’ˆ ì¶”ê°€</button>
            <button class="btn btn-info btn-sm" onclick="syncFromFirebase()">Firebaseì—ì„œ ë™ê¸°í™”</button>
            <button class="btn btn-warning btn-sm" onclick="clearLocalCart()">ë¡œì»¬ ì¹´íŠ¸ ë¹„ìš°ê¸°</button>
            <button class="btn btn-danger btn-sm" onclick="forceReloadScripts()">ìŠ¤í¬ë¦½íŠ¸ ê°•ì œ ì¬ë¡œë“œ</button>
            <button class="btn btn-info btn-sm" onclick="forceAuthRefresh()">Firebase Auth ìƒˆë¡œê³ ì¹¨</button>
            <button class="btn btn-secondary btn-sm" onclick="goToCart()">ì¹´íŠ¸ í˜ì´ì§€ë¡œ ì´ë™</button>
        </div>
        
        <div class="debug-section">
            <h4>ë””ë²„ê·¸ ë¡œê·¸</h4>
            <div id="debug-log" class="debug-log"></div>
            <button class="btn btn-outline-secondary btn-sm" onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <!-- ì• í”Œë¦¬ì¼€ì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ (ìˆœì„œ ì¤‘ìš”) -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/auth-utils.js"></script>
    
    <!-- ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ í™•ì¸ -->
    <script>
        // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ìƒíƒœ í™•ì¸
        function checkScriptsLoaded() {
            const scripts = {
                'firebase': typeof firebase !== 'undefined',
                'FirebaseService': typeof window.FirebaseService !== 'undefined',
                'CartSyncService': typeof window.CartSyncService !== 'undefined',
                'auth-utils': typeof getCurrentUser !== 'undefined'
            };
            
            console.log('ğŸ“‹ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ìƒíƒœ:', scripts);
            return scripts;
        }
        
        // í˜ì´ì§€ ë¡œë“œ í›„ ìŠ¤í¬ë¦½íŠ¸ ìƒíƒœ í™•ì¸
        window.addEventListener('load', () => {
            setTimeout(checkScriptsLoaded, 1000);
        });
    </script>
    
    <script>
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('debug-log');
            const logMessage = `[${timestamp}] ${message}\n`;
            logContainer.textContent += logMessage;
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('debug-log').textContent = '';
        }
        
        function updateStatus() {
            log('ğŸ“Š ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹œì‘');
            
            // ì‚¬ìš©ì ìƒíƒœ
            let user = firebase?.auth?.currentUser;
            if (!user && typeof getCurrentUser === 'function') {
                const authUtilsUser = getCurrentUser();
                if (authUtilsUser) {
                    user = authUtilsUser;
                }
            }
            
            const userStatus = document.getElementById('user-status');
            if (user) {
                userStatus.textContent = user.email;
                userStatus.className = 'status-good';
                log('âœ… ì‚¬ìš©ì: ' + user.email);
            } else {
                userStatus.textContent = 'ë¡œê·¸ì¸ ì•ˆë¨';
                userStatus.className = 'status-bad';
                log('âŒ ì‚¬ìš©ì: ë¡œê·¸ì¸ ì•ˆë¨');
            }
            
            // Firebase ìƒíƒœ
            const firebaseAvailable = window.FirebaseService?.isFirebaseAvailable();
            const firebaseStatus = document.getElementById('firebase-status');
            if (firebaseAvailable) {
                firebaseStatus.textContent = 'ì‚¬ìš© ê°€ëŠ¥';
                firebaseStatus.className = 'status-good';
                log('âœ… Firebase: ì‚¬ìš© ê°€ëŠ¥');
            } else {
                firebaseStatus.textContent = 'ì‚¬ìš© ë¶ˆê°€';
                firebaseStatus.className = 'status-bad';
                log('âŒ Firebase: ì‚¬ìš© ë¶ˆê°€');
            }
            
            // ë¡œì»¬ ì¹´íŠ¸
            const localCart = JSON.parse(localStorage.getItem('aetherCart') || '[]');
            const localCartStatus = document.getElementById('local-cart-status');
            localCartStatus.textContent = `${localCart.length}ê°œ ìƒí’ˆ`;
            localCartStatus.className = localCart.length > 0 ? 'status-good' : 'status-warning';
            log('ğŸ“¦ ë¡œì»¬ ì¹´íŠ¸: ' + localCart.length + 'ê°œ ìƒí’ˆ');
            
            // Firebase ì¹´íŠ¸ í™•ì¸
            checkFirebaseCart();
            
            // ë™ê¸°í™” ìƒíƒœ
            const canSync = user && firebaseAvailable && window.CartSyncService;
            const syncStatus = document.getElementById('sync-status');
            if (canSync) {
                syncStatus.textContent = 'ê°€ëŠ¥';
                syncStatus.className = 'status-good';
                log('âœ… ë™ê¸°í™”: ê°€ëŠ¥');
            } else {
                syncStatus.textContent = 'ë¶ˆê°€ëŠ¥';
                syncStatus.className = 'status-bad';
                log('âŒ ë™ê¸°í™”: ë¶ˆê°€ëŠ¥');
            }
        }
        
        async function checkFirebaseCart() {
            const firebaseCartStatus = document.getElementById('firebase-cart-status');
            
            if (!firebase?.auth?.currentUser || !window.CartSyncService) {
                firebaseCartStatus.textContent = 'í™•ì¸ ë¶ˆê°€';
                firebaseCartStatus.className = 'status-warning';
                return;
            }
            
            try {
                const userEmail = firebase.auth.currentUser.email;
                log('ğŸ” Firebase ì¹´íŠ¸ í™•ì¸ ì¤‘: ' + userEmail);
                
                const cartData = await window.CartSyncService.loadCartFromFirebase(userEmail);
                firebaseCartStatus.textContent = `${cartData.length}ê°œ ìƒí’ˆ`;
                firebaseCartStatus.className = cartData.length > 0 ? 'status-good' : 'status-warning';
                log('ğŸ“¦ Firebase ì¹´íŠ¸: ' + cartData.length + 'ê°œ ìƒí’ˆ');
                
                if (cartData.length > 0) {
                    log('ğŸ“‹ Firebase ì¹´íŠ¸ ë‚´ìš©: ' + JSON.stringify(cartData, null, 2));
                }
            } catch (error) {
                firebaseCartStatus.textContent = 'ì˜¤ë¥˜: ' + error.message;
                firebaseCartStatus.className = 'status-bad';
                log('âŒ Firebase ì¹´íŠ¸ í™•ì¸ ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        function refreshStatus() {
            log('ğŸ”„ ìƒíƒœ ìƒˆë¡œê³ ì¹¨');
            updateStatus();
        }
        
        function testAddProduct() {
            log('ğŸ›’ í…ŒìŠ¤íŠ¸ ìƒí’ˆ ì¶”ê°€');
            
            const testProduct = {
                id: 'mobile-test-' + Date.now(),
                name: 'ëª¨ë°”ì¼ í…ŒìŠ¤íŠ¸ ìƒí’ˆ',
                price: 1500,
                quantity: 1,
                addedAt: new Date().toISOString()
            };
            
            const cart = JSON.parse(localStorage.getItem('aetherCart') || '[]');
            cart.push(testProduct);
            localStorage.setItem('aetherCart', JSON.stringify(cart));
            
            log('âœ… í…ŒìŠ¤íŠ¸ ìƒí’ˆ ì¶”ê°€ ì™„ë£Œ');
            updateStatus();
        }
        
        async function syncFromFirebase() {
            log('ğŸ”„ Firebaseì—ì„œ ë™ê¸°í™” ì‹œì‘');
            
            // ìƒì„¸í•œ ìƒíƒœ í™•ì¸
            log('ğŸ” ë™ê¸°í™” ì¡°ê±´ í™•ì¸:');
            log('- firebase ê°ì²´: ' + (typeof firebase !== 'undefined' ? 'ì¡´ì¬' : 'ì—†ìŒ'));
            log('- firebase.auth: ' + (firebase?.auth ? 'ì¡´ì¬' : 'ì—†ìŒ'));
            log('- firebase.auth.currentUser: ' + (firebase?.auth?.currentUser ? firebase.auth.currentUser.email : 'ì—†ìŒ'));
            log('- window.CartSyncService: ' + (typeof window.CartSyncService !== 'undefined' ? 'ì¡´ì¬' : 'ì—†ìŒ'));
            log('- window.FirebaseService: ' + (typeof window.FirebaseService !== 'undefined' ? 'ì¡´ì¬' : 'ì—†ìŒ'));
            
            // Firebase Auth currentUserê°€ nullì¸ ê²½ìš° auth-utils.jsì—ì„œ ì‚¬ìš©ì ì •ë³´ í™•ì¸
            let currentUser = firebase?.auth?.currentUser;
            if (!currentUser && typeof getCurrentUser === 'function') {
                const authUtilsUser = getCurrentUser();
                if (authUtilsUser) {
                    log('ğŸ”§ Firebase Auth currentUserê°€ null - auth-utils.jsì—ì„œ ì‚¬ìš©ì ì •ë³´ ì‚¬ìš©');
                    log('ğŸ”§ auth-utils ì‚¬ìš©ì: ' + authUtilsUser.email);
                    
                    // Firebase Auth ìƒíƒœ ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì‹œë„
                    if (firebase?.auth) {
                        try {
                            await firebase.auth.authStateReady();
                            currentUser = firebase.auth.currentUser;
                            log('ğŸ”§ Firebase Auth ìƒíƒœ ìƒˆë¡œê³ ì¹¨ í›„: ' + (currentUser ? currentUser.email : 'ì—¬ì „íˆ null'));
                        } catch (error) {
                            log('âš ï¸ Firebase Auth ìƒíƒœ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: ' + error.message);
                        }
                    }
                }
            }
            
            if (!currentUser) {
                log('âŒ ë™ê¸°í™” ë¶ˆê°€: ì‚¬ìš©ì ë¡œê·¸ì¸ ì•ˆë¨');
                log('ğŸ’¡ Firebase Auth ìƒíƒœ ë™ê¸°í™” ë¬¸ì œ - ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”');
                return;
            }
            
            if (!window.CartSyncService) {
                log('âŒ ë™ê¸°í™” ë¶ˆê°€: CartSyncService ë¡œë“œ ì•ˆë¨');
                log('ğŸ”§ CartSyncService ìˆ˜ë™ ë¡œë“œ ì‹œë„...');
                
                // firebase-config.jsê°€ ì™„ì „íˆ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
                let attempts = 0;
                while (attempts < 50 && !window.CartSyncService) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                    log(`CartSyncService ë¡œë“œ ëŒ€ê¸° ì¤‘... (${attempts}/50)`);
                }
                
                if (!window.CartSyncService) {
                    log('âŒ CartSyncService ë¡œë“œ ì‹¤íŒ¨ - firebase-config.js í™•ì¸ í•„ìš”');
                    return;
                } else {
                    log('âœ… CartSyncService ë¡œë“œ ì„±ê³µ');
                }
            }
            
            try {
                const userEmail = firebase.auth.currentUser.email;
                log('ğŸ“§ ë™ê¸°í™” ì‚¬ìš©ì: ' + userEmail);
                
                const syncedCart = await window.CartSyncService.syncCart(userEmail);
                log('âœ… ë™ê¸°í™” ì™„ë£Œ: ' + syncedCart.length + 'ê°œ ìƒí’ˆ');
                
                if (syncedCart.length > 0) {
                    log('ğŸ“‹ ë™ê¸°í™”ëœ ì¹´íŠ¸: ' + JSON.stringify(syncedCart, null, 2));
                }
                
                updateStatus();
            } catch (error) {
                log('âŒ ë™ê¸°í™” ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        function clearLocalCart() {
            log('ğŸ—‘ï¸ ë¡œì»¬ ì¹´íŠ¸ ë¹„ìš°ê¸°');
            localStorage.removeItem('aetherCart');
            updateStatus();
        }
        
        function goToCart() {
            log('ğŸ›’ ì¹´íŠ¸ í˜ì´ì§€ë¡œ ì´ë™');
            window.location.href = 'cart.html';
        }
        
        function forceReloadScripts() {
            log('ğŸ”„ ìŠ¤í¬ë¦½íŠ¸ ê°•ì œ ì¬ë¡œë“œ ì‹œì‘');
            
            // í˜„ì¬ ìŠ¤í¬ë¦½íŠ¸ ìƒíƒœ í™•ì¸
            log('í˜„ì¬ ìŠ¤í¬ë¦½íŠ¸ ìƒíƒœ:');
            log('- firebase: ' + (typeof firebase !== 'undefined' ? 'ì¡´ì¬' : 'ì—†ìŒ'));
            log('- FirebaseService: ' + (typeof window.FirebaseService !== 'undefined' ? 'ì¡´ì¬' : 'ì—†ìŒ'));
            log('- CartSyncService: ' + (typeof window.CartSyncService !== 'undefined' ? 'ì¡´ì¬' : 'ì—†ìŒ'));
            
            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ëª¨ë“  ìŠ¤í¬ë¦½íŠ¸ ì¬ë¡œë“œ
            log('ğŸ“„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ìŠ¤í¬ë¦½íŠ¸ ì¬ë¡œë“œ...');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        }
        
        async function forceAuthRefresh() {
            log('ğŸ”„ Firebase Auth ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì‹œì‘');
            
            if (!firebase?.auth) {
                log('âŒ Firebase Auth ì—†ìŒ');
                return;
            }
            
            try {
                // í˜„ì¬ Auth ìƒíƒœ í™•ì¸
                const currentUser = firebase.auth.currentUser;
                log('í˜„ì¬ firebase.auth.currentUser: ' + (currentUser ? currentUser.email : 'null'));
                
                // auth-utils.js ì‚¬ìš©ìì™€ ë¹„êµ
                if (typeof getCurrentUser === 'function') {
                    const authUtilsUser = getCurrentUser();
                    log('auth-utils.js ì‚¬ìš©ì: ' + (authUtilsUser ? authUtilsUser.email : 'null'));
                    
                    if (authUtilsUser && !currentUser) {
                        log('ğŸ”§ Firebase Auth ìƒíƒœ ë™ê¸°í™” ë¬¸ì œ ê°ì§€');
                        log('ğŸ”§ Firebase Auth ìƒíƒœ ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì‹œë„...');
                        
                        // Firebase Auth ìƒíƒœ ìƒˆë¡œê³ ì¹¨
                        await firebase.auth.authStateReady();
                        const refreshedUser = firebase.auth.currentUser;
                        log('ìƒˆë¡œê³ ì¹¨ í›„ firebase.auth.currentUser: ' + (refreshedUser ? refreshedUser.email : 'ì—¬ì „íˆ null'));
                        
                        if (refreshedUser) {
                            log('âœ… Firebase Auth ìƒíƒœ ìƒˆë¡œê³ ì¹¨ ì„±ê³µ');
                            updateStatus();
                        } else {
                            log('âŒ Firebase Auth ìƒíƒœ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨');
                            log('ğŸ’¡ ë¡œê·¸ì•„ì›ƒ í›„ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ë³´ì„¸ìš”');
                        }
                    } else if (authUtilsUser && currentUser && authUtilsUser.email === currentUser.email) {
                        log('âœ… Firebase Auth ìƒíƒœ ì •ìƒ');
                    } else {
                        log('âš ï¸ Firebase Auth ìƒíƒœ ë¶ˆì¼ì¹˜');
                    }
                }
            } catch (error) {
                log('âŒ Firebase Auth ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜: ' + error.message);
            }
        }
        
        // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ëŒ€ê¸° í•¨ìˆ˜
        async function waitForScripts() {
            log('â³ í•„ìˆ˜ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ëŒ€ê¸° ì¤‘...');
            
            let attempts = 0;
            const maxAttempts = 100; // 10ì´ˆ ëŒ€ê¸°
            
            while (attempts < maxAttempts) {
                const scriptsLoaded = {
                    firebase: typeof firebase !== 'undefined',
                    FirebaseService: typeof window.FirebaseService !== 'undefined',
                    CartSyncService: typeof window.CartSyncService !== 'undefined'
                };
                
                if (scriptsLoaded.firebase && scriptsLoaded.FirebaseService && scriptsLoaded.CartSyncService) {
                    log('âœ… ëª¨ë“  í•„ìˆ˜ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');
                    return true;
                }
                
                attempts++;
                log(`ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ëŒ€ê¸° ì¤‘... (${attempts}/${maxAttempts})`);
                log(`- firebase: ${scriptsLoaded.firebase}`);
                log(`- FirebaseService: ${scriptsLoaded.FirebaseService}`);
                log(`- CartSyncService: ${scriptsLoaded.CartSyncService}`);
                
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            log('âŒ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ íƒ€ì„ì•„ì›ƒ');
            return false;
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ ëª¨ë°”ì¼ ë””ë²„ê¹… í˜ì´ì§€ ë¡œë“œ');
            log('ğŸ“± ë””ë°”ì´ìŠ¤: ' + (navigator.userAgent.includes('Mobile') ? 'ëª¨ë°”ì¼' : 'ë°ìŠ¤í¬í†±'));
            
            // ì¦‰ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸ (ê¸°ë³¸ ìƒíƒœ í‘œì‹œ)
            updateStatus();
            
            // Firebase ì´ˆê¸°í™” ëŒ€ê¸° (ë” ê°„ë‹¨í•œ ë°©ì‹)
            setTimeout(() => {
                log('â³ Firebase ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘...');
                updateStatus();
                
                // Firebase Auth ìƒíƒœ ë³€ê²½ ê°ì§€
                if (firebase?.auth) {
                    firebase.auth.onAuthStateChanged((user) => {
                        log('ğŸ” ì¸ì¦ ìƒíƒœ ë³€ê²½: ' + (user ? user.email : 'ë¡œê·¸ì•„ì›ƒ'));
                        updateStatus();
                    });
                }
            }, 2000);
            
            // ì¶”ê°€ ëŒ€ê¸° í›„ í•œ ë²ˆ ë” ìƒíƒœ ì—…ë°ì´íŠ¸
            setTimeout(() => {
                log('â³ ì¶”ê°€ ëŒ€ê¸° í›„ ìƒíƒœ ì—…ë°ì´íŠ¸');
                updateStatus();
            }, 5000);
        });
    </script>
</body>
</html>
