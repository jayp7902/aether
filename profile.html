<!DOCTYPE html>
<html lang="ja">
<head>
    <title>プロフィール - Aether</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Language" content="ja">
    <meta name="language" content="Japanese">
    <link rel="icon" type="image/png" href="assets/img/aether-icon.png?t=1750992166">
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/templatemo.css">
    <link rel="stylesheet" href="assets/css/custom.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800;900&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100;200;300;400;500;600;700;800;900&display=swap">
    <link rel="stylesheet" href="assets/css/fontawesome.min.css">
    
    <!-- QR Code Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <style>
        body {
            font-family: "Montserrat", sans-serif;
            background-color: #f8f9fa;
        }
        .japanese-text {
            font-family: "Noto Sans JP", sans-serif;
            font-weight: 400;
            line-height: 1.6;
        }
        .japanese-heading {
            font-family: "Noto Sans JP", sans-serif;
            font-weight: 600;
            line-height: 1.4;
        }

        /* 주문 상태별 스타일 (주문 관리 페이지와 동일) */
        .order-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-pending_payment {
            background: #fff3cd;
            color: #856404;
        }

        .status-processing {
            background: #cce5ff;
            color: #004085;
        }

        .status-shipping {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .status-default {
            background: #e2e3e5;
            color: #383d41;
        }
        
        /* 일본어 날짜 입력 필드 스타일 */
        input[type="date"][lang="ja"] {
            font-family: "Noto Sans JP", sans-serif;
            direction: ltr;
        }
        
        /* 빈 날짜 필드에 일본어 플레이스홀더 표시 */
        input[type="date"][lang="ja"]:invalid::-webkit-datetime-edit {
            color: transparent;
        }
        
        input[type="date"][lang="ja"]:invalid::before {
            content: attr(data-placeholder);
            color: #6c757d;
            font-family: "Noto Sans JP", sans-serif;
        }
        
        /* Firefox 지원 */
        input[type="date"][lang="ja"]::-moz-focus-inner {
            border: 0;
        }
        
        /* 생년월일 입력 필드 스타일 */
        #profile-birthdate, #edit-birthdate {
            font-family: "Noto Sans JP", sans-serif;
        }
        
        #profile-birthdate::placeholder, #edit-birthdate::placeholder {
            color: #6c757d;
            font-size: 14px;
        }
        
        /* 프로필 사진 업로드 스타일 */
        .profile-avatar {
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .profile-avatar:hover {
            transform: scale(1.05);
        }
        
        .profile-avatar.drag-over {
            border: 3px dashed #007bff;
            background-color: rgba(0, 123, 255, 0.1);
        }
        
        .upload-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .profile-avatar:hover .upload-overlay {
            opacity: 1;
        }
        
        .photo-upload-options {
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .upload-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 0 0 50px 50px;
            overflow: hidden;
        }
        
        .upload-progress-bar {
            height: 100%;
            background: #28a745;
            width: 0%;
            transition: width 0.3s ease;
        }
        .profile-container {
            min-height: 100vh;
            padding: 2rem 0;
        }
        .profile-card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            border-radius: 10px;
        }
        .profile-header {
            background-color: #000000;
            color: white;
            border-radius: 10px 10px 0 0;
            padding: 2rem;
            text-align: center;
        }
        .profile-body {
            padding: 2rem;
        }
        .form-control:focus {
            border-color: #6c757d;
            box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.25);
        }
        .btn-profile {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        .btn-profile:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            position: relative;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .profile-avatar:hover {
            background-color: #5a6268;
            transform: scale(1.05);
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .profile-avatar .upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 50%;
        }
        
        .profile-avatar:hover .upload-overlay {
            opacity: 1;
        }
        
        .profile-avatar .upload-overlay i {
            color: white;
            font-size: 1.2rem;
        }
        
        .profile-avatar input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        .profile-stats {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
        }
        .stat-item {
            text-align: center;
            padding: 0.5rem;
        }
        .tab-content,
        #profileTabContent.tab-content,
        .tab-pane {
            margin-top: 2rem !important;
            padding-top: 1rem !important;
        }
        
        /* 프로필 카드 바디 여백 추가 - Bootstrap 강제 덮어쓰기 */
        .profile-card .card-body,
        .card.profile-card .card-body,
        .col-md-8 .card.profile-card .card-body {
            padding: 2rem 1.5rem !important;
        }
        
        /* 탭 콘텐츠 내부 여백 강화 */
        .tab-pane .alert,
        .tab-pane form,
        .tab-pane .row {
            margin-top: 0 !important;
        }
        
        /* 탭 네비게이션과 콘텐츠 사이 여백 */
        .nav-tabs {
            margin-bottom: 0 !important;
        }
        
        /* 두 카드 사이 간격 추가 */
        .profile-container .row {
            margin-bottom: 3rem !important;
        }
        
        .profile-container .col-md-4,
        .profile-container .col-md-8 {
            margin-bottom: 2rem !important;
        }
        
        /* 모바일에서 여백 조정 */
        @media (max-width: 768px) {
            .profile-card .card-body,
            .card.profile-card .card-body,
            .col-md-8 .card.profile-card .card-body {
                padding: 1.5rem 1rem !important;
            }
            
            .tab-content,
            #profileTabContent.tab-content,
            .tab-pane {
                margin-top: 1.5rem !important;
                padding-top: 0.5rem !important;
            }
            
            .profile-container .row {
                margin-bottom: 2rem !important;
            }
            
            .profile-container .col-md-4,
            .profile-container .col-md-8 {
                margin-bottom: 1.5rem !important;
            }
        }
        
        @media (max-width: 480px) {
            .profile-card .card-body,
            .card.profile-card .card-body,
            .col-md-8 .card.profile-card .card-body {
                padding: 1rem 0.75rem !important;
            }
            
            .tab-content,
            #profileTabContent.tab-content,
            .tab-pane {
                margin-top: 1rem !important;
                padding-top: 0.5rem !important;
            }
            
            .profile-container .row {
                margin-bottom: 1.5rem !important;
            }
            
            .profile-container .col-md-4,
            .profile-container .col-md-8 {
                margin-bottom: 1rem !important;
            }
        }
      /* User dropdown hover fix */
      .dropdown-toggle:hover,
      .dropdown-toggle:focus,
      #user-name:hover {
          color: #343a40 !important;
          text-decoration: none !important;
      }
      .nav-link:hover {
          color: #343a40 !important;
      }
      /* Date input Japanese placeholder */
      input[type="date"]:lang(ja)::-webkit-datetime-edit-text {
          color: #6c757d;
      }
      input[type="date"]:lang(ja)::-webkit-datetime-edit-month-field,
      input[type="date"]:lang(ja)::-webkit-datetime-edit-day-field,
      input[type="date"]:lang(ja)::-webkit-datetime-edit-year-field {
          color: #6c757d;
      }
      
      /* 네비게이션바 텍스트 thin 서체 통일 */
      .navbar-nav .nav-link {
          font-family: "Montserrat", sans-serif !important;
          font-weight: 300 !important;
          font-size: 1rem !important;
      }
      
      .navbar-brand {
          font-family: "Montserrat", sans-serif !important;
          font-weight: 300 !important;
      }
      
      #user-name {
          font-family: "Montserrat", sans-serif !important;
          font-weight: 300 !important;
      }
      input[type="date"]:lang(ja)::-webkit-input-placeholder {
          color: #6c757d;
      }
      input[type="date"]:lang(ja)::placeholder {
          color: #6c757d;
      }
      
      /* 리얼 탭 디자인 - 겹치는 탭 스타일 - Bootstrap 강제 덮어쓰기 */
      .nav-tabs, 
      ul.nav.nav-tabs, 
      #profileTabs.nav-tabs {
          border-bottom: 1px solid #dee2e6 !important;
          margin-bottom: 0 !important;
          padding-left: 0 !important;
          display: flex !important;
          flex-wrap: nowrap !important;
      }
      
      .nav-tabs .nav-item, 
      ul.nav.nav-tabs .nav-item, 
      #profileTabs .nav-item {
          margin-bottom: -1px !important;
          margin-right: -2px !important;
          flex: 1 !important;
      }
      
      .nav-tabs .nav-link, 
      ul.nav.nav-tabs .nav-link, 
      #profileTabs .nav-link,
      .nav-tabs .nav-link button,
      ul.nav.nav-tabs .nav-link button,
      #profileTabs .nav-link button {
          color: #6c757d !important;
          border: 1px solid #dee2e6 !important;
          border-radius: 0 !important;
          margin-right: -1px !important;
          border-bottom: 1px solid #dee2e6 !important;
          padding: 12px 20px !important;
          font-size: 14px !important;
          background-color: #f8f9fa !important;
          position: relative !important;
          z-index: 1 !important;
          width: 100% !important;
          text-align: center !important;
      }
      
      /* 첫 번째 탭 - 왼쪽 둥근 모서리 */
      .nav-tabs .nav-item:first-child .nav-link,
      ul.nav.nav-tabs .nav-item:first-child .nav-link,
      #profileTabs .nav-item:first-child .nav-link,
      .nav-tabs .nav-item:first-child .nav-link button,
      ul.nav.nav-tabs .nav-item:first-child .nav-link button,
      #profileTabs .nav-item:first-child .nav-link button {
          border-top-left-radius: 8px !important;
          border-bottom-left-radius: 0 !important;
      }
      
      /* 마지막 탭 - 오른쪽 둥근 모서리 */
      .nav-tabs .nav-item:last-child .nav-link,
      ul.nav.nav-tabs .nav-item:last-child .nav-link,
      #profileTabs .nav-item:last-child .nav-link,
      .nav-tabs .nav-item:last-child .nav-link button,
      ul.nav.nav-tabs .nav-item:last-child .nav-link button,
      #profileTabs .nav-item:last-child .nav-link button {
          border-top-right-radius: 8px !important;
          border-bottom-right-radius: 0 !important;
      }
      
      /* 호버 효과 */
      .nav-tabs .nav-link:hover,
      ul.nav.nav-tabs .nav-link:hover,
      #profileTabs .nav-link:hover,
      .nav-tabs .nav-link button:hover,
      ul.nav.nav-tabs .nav-link button:hover,
      #profileTabs .nav-link button:hover {
          color: #495057 !important;
          background-color: #e9ecef !important;
          border-color: #dee2e6 #dee2e6 #dee2e6 !important;
          z-index: 2 !important;
      }
      
      /* 활성 탭 - 앞으로 나와서 연결됨 */
      .nav-tabs .nav-link.active,
      ul.nav.nav-tabs .nav-link.active,
      #profileTabs .nav-link.active,
      .nav-tabs .nav-link.active button,
      ul.nav.nav-tabs .nav-link.active button,
      #profileTabs .nav-link.active button {
          color: #212529 !important;
          background-color: #ffffff !important;
          border-color: #dee2e6 #dee2e6 #ffffff !important;
          border-bottom: 1px solid #ffffff !important;
          z-index: 3 !important;
          box-shadow: 0 -2px 4px rgba(0,0,0,0.1) !important;
      }
      
      .nav-tabs .nav-link.active:hover,
      ul.nav.nav-tabs .nav-link.active:hover,
      #profileTabs .nav-link.active:hover,
      .nav-tabs .nav-link.active button:hover,
      ul.nav.nav-tabs .nav-link.active button:hover,
      #profileTabs .nav-link.active button:hover {
          color: #212529 !important;
          background-color: #ffffff !important;
          border-color: #dee2e6 #dee2e6 #ffffff !important;
      }
      
      /* 모바일에서 리얼 탭 디자인 유지 */
      @media (max-width: 768px) {
          .nav-tabs, 
          ul.nav.nav-tabs, 
          #profileTabs.nav-tabs {
              flex-wrap: nowrap !important;
              border-bottom: 1px solid #dee2e6 !important;
              margin-bottom: 0 !important;
              padding-left: 0 !important;
              display: flex !important;
          }
          
          .nav-tabs .nav-item, 
          ul.nav.nav-tabs .nav-item, 
          #profileTabs .nav-item {
              flex: 1 !important;
              min-width: 0;
              margin-bottom: -1px !important;
              margin-right: -2px !important;
          }
          
          .nav-tabs .nav-link, 
          ul.nav.nav-tabs .nav-link, 
          #profileTabs .nav-link,
          .nav-tabs .nav-link button,
          ul.nav.nav-tabs .nav-link button,
          #profileTabs .nav-link button {
              font-size: 14px !important;
              padding: 12px 8px !important;
              text-align: center;
              white-space: nowrap;
              overflow: hidden;
              text-overflow: ellipsis;
              border: 1px solid #dee2e6 !important;
              border-radius: 0 !important;
              margin-right: -1px !important;
              border-bottom: 1px solid #dee2e6 !important;
              background-color: #f8f9fa !important;
              position: relative !important;
              z-index: 1 !important;
              width: 100% !important;
          }
          
          .nav-tabs .nav-item:first-child .nav-link {
              border-top-left-radius: 8px !important;
              border-bottom-left-radius: 0 !important;
          }
          
          .nav-tabs .nav-item:last-child .nav-link {
              border-top-right-radius: 8px !important;
              border-bottom-right-radius: 0 !important;
          }
          
          .nav-tabs .nav-link:hover {
              background-color: #e9ecef !important;
              border-color: #dee2e6 #dee2e6 #dee2e6 !important;
              z-index: 2 !important;
          }
          
          .nav-tabs .nav-link.active {
              background-color: #ffffff !important;
              border-color: #dee2e6 #dee2e6 #ffffff !important;
              border-bottom: 1px solid #ffffff !important;
              z-index: 3 !important;
              box-shadow: 0 -2px 4px rgba(0,0,0,0.1) !important;
          }
          
          .nav-tabs .nav-link i {
              font-size: 12px !important;
              margin-right: 4px !important;
          }
      }
      
      /* 더 작은 화면에서 리얼 탭 디자인 유지 */
      @media (max-width: 480px) {
          .nav-tabs .nav-link {
              font-size: 12px !important;
              padding: 10px 4px !important;
              border: 1px solid #dee2e6 !important;
              border-radius: 0 !important;
              margin-right: -1px !important;
              border-bottom: 1px solid #dee2e6 !important;
              background-color: #f8f9fa !important;
              position: relative !important;
              z-index: 1 !important;
          }
          
          .nav-tabs .nav-item:first-child .nav-link {
              border-top-left-radius: 8px !important;
              border-bottom-left-radius: 0 !important;
          }
          
          .nav-tabs .nav-item:last-child .nav-link {
              border-top-right-radius: 8px !important;
              border-bottom-right-radius: 0 !important;
          }
          
          .nav-tabs .nav-link:hover {
              background-color: #e9ecef !important;
              border-color: #dee2e6 #dee2e6 #dee2e6 !important;
              z-index: 2 !important;
          }
          
          .nav-tabs .nav-link.active {
              background-color: #ffffff !important;
              border-color: #dee2e6 #dee2e6 #ffffff !important;
              border-bottom: 1px solid #ffffff !important;
              z-index: 3 !important;
              box-shadow: 0 -2px 4px rgba(0,0,0,0.1) !important;
          }
          
          .nav-tabs .nav-link i {
              font-size: 10px !important;
              margin-right: 3px !important;
          }
      }
  </style>
</head>

<body>
    <!-- Start Top Nav -->
    <nav class="navbar navbar-expand-lg navbar-light" id="templatemo_nav_top" style="min-height: 20px; background-color: #000000 !important;">
        <div class="container text-light">
            <div class="w-100 d-flex justify-content-between">
                <div>
                    <!-- 빈 공간으로 블랙 바 유지 -->
                </div>
            </div>
        </div>
    </nav>
    <!-- Close Top Nav -->

    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-light shadow">
        <div class="container d-flex justify-content-between align-items-center">
            <!-- QR 코드 버튼 제거됨 -->

            <a class="navbar-brand text-success logo align-self-center" href="index.html">
                <img src="assets/img/logo.png" alt="Logo" class="img-fluid" style="max-height: 50px;">
            </a>

            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#templatemo_main_nav" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="align-self-center collapse navbar-collapse flex-fill d-lg-flex justify-content-lg-between" id="templatemo_main_nav">
                <!-- 모바일 메뉴 레이아웃 -->
                <div class="d-lg-none w-100">
                    <!-- 영문 메뉴 - 가로 정렬 -->
                    <div class="d-flex justify-content-center mb-4">
                        <ul class="nav navbar-nav d-flex flex-row gap-4">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="shop.html">Brand</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="info.html">Info</a>
                        </li>
                    </ul>
                </div>
                    
                    <!-- 아이콘들 - 가로 정렬, 좌우 여백 추가 -->
                    <div class="d-flex justify-content-center align-items-center gap-4 px-4">
                        <a href="cart.html" class="nav-link text-decoration-none">
                            <i class="fas fa-shopping-cart text-dark" style="font-size: 1.5rem;"></i>
                            <span class="badge bg-secondary ms-1" id="cart-count-mobile">0</span>
                        </a>
                        <div class="dropdown">
                            <a href="#" class="nav-link dropdown-toggle text-decoration-none" id="userDropdownMobile" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user text-dark" style="font-size: 1.5rem;"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-center" aria-labelledby="userDropdownMobile">
                                <li id="login-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="login.html">
                                        <i class="fas fa-sign-in-alt me-2"></i>Login
                                    </a>
                                </li>
                                <li id="register-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="register.html">
                                        <i class="fas fa-user-plus me-2"></i>Register
                                    </a>
                                </li>
                                <li id="profile-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="profile.html">
                                        <i class="fas fa-user-circle me-2"></i>Profile
                                    </a>
                                </li>
                                <li id="points-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="points.html">
                                        <i class="fas fa-coins me-2"></i>Points
                                    </a>
                                </li>
                                <li id="admin-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="admin-dashboard.html">
                                        <i class="fas fa-cog me-2"></i>管理ダッシュボード
                                    </a>
                                </li>
                                <li id="logout-menu-mobile" style="display: none;">
                                    <hr class="dropdown-divider">
                                </li>
                                <li id="logout-menu-item-mobile" style="display: none;">
                                    <a class="dropdown-item" href="#" onclick="logout()">
                                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                                    </a>
                                </li>
                            </ul>
                            </div>
                        </div>
                    </div>
                
                <!-- 데스크톱 메뉴 레이아웃 -->
                <div class="flex-fill d-none d-lg-block">
                    <ul class="nav navbar-nav d-flex justify-content-between mx-lg-auto" style="max-width: 400px; margin: 0 auto;">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="shop.html">Brand</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="info.html">Info</a>
                        </li>
                    </ul>
                </div>
                <div class="navbar align-self-center d-flex d-none d-lg-flex">
                    <a href="cart.html" class="nav-link text-decoration-none me-3">
                        <i class="fas fa-shopping-cart text-dark"></i>
                        <span class="badge bg-secondary" id="cart-count">0</span>
                    </a>
                    <div class="dropdown">
                        <a href="#" class="nav-link dropdown-toggle text-decoration-none" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user text-dark"></i>
                            <span id="user-name" class="d-none d-lg-inline ms-1"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li id="login-menu" style="display: none;">
                                <a class="dropdown-item" href="login.html">
                                    <i class="fas fa-sign-in-alt me-2"></i>Login
                                </a>
                            </li>
                            <li id="register-menu" style="display: none;">
                                <a class="dropdown-item" href="register.html">
                                    <i class="fas fa-user-plus me-2"></i>Register
                                </a>
                            </li>
                            <li id="profile-menu" style="display: none;">
                                <a class="dropdown-item" href="profile.html">
                                    <i class="fas fa-user-circle me-2"></i>Profile
                                </a>
                            </li>
                            <li id="points-menu" style="display: none;">
                                <a class="dropdown-item" href="points.html">
                                    <i class="fas fa-coins me-2"></i>Points
                                </a>
                            </li>
                            <li id="admin-menu" style="display: none;">
                                <a class="dropdown-item" href="admin-dashboard.html">
                                    <i class="fas fa-cog me-2"></i>管理ダッシュボード
                                </a>
                            </li>
                            <li id="logout-menu" style="display: none;">
                                <hr class="dropdown-divider">
                            </li>
                            <li id="logout-menu-item" style="display: none;">
                                <a class="dropdown-item" href="#" onclick="logout()">
                                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    <!-- Close Header -->

    <!-- QR Code Modal 제거됨 -->

    <!-- Profile Container -->
    <div class="profile-container">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <!-- Profile Card -->
                    <div class="card profile-card">
                        <div class="profile-header">
                            <div class="profile-avatar" id="profile-avatar-container" onclick="openPhotoUpload()">
                                <img id="profile-photo" src="" alt="プロフィール写真" style="display: none;">
                                <i class="fas fa-user fa-2x text-white" id="profile-photo-placeholder"></i>
                                <div class="upload-overlay">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <input type="file" id="profile-photo-input" accept="image/*" style="display: none;" onchange="handleProfilePhotoUpload(event)">
                            </div>
                            <div class="photo-upload-options mt-2" id="photo-upload-options" style="display: none;">
                                <button class="btn btn-sm btn-outline-light me-2" onclick="selectPhotoFromGallery()">
                                    <i class="fas fa-images me-1"></i>ギャラリー
                                </button>
                                <button class="btn btn-sm btn-outline-light" onclick="takePhotoWithCamera()">
                                    <i class="fas fa-camera me-1"></i>カメラ
                                </button>
                            </div>
                            <h4 class="japanese-heading mb-0" id="profile-display-name">-</h4>
                            <p class="japanese-text mb-0" id="profile-display-email">-</p>
                        </div>
                        <div class="profile-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-profile btn-dark japanese-text" onclick="showEditProfile()">
                                    <i class="fas fa-edit me-2"></i>プロフィール編集
                                </button>
                                <button class="btn btn-outline-secondary japanese-text" onclick="showChangePassword()">
                                    <i class="fas fa-key me-2"></i>パスワード変更
                                </button>
                                <button class="btn btn-outline-secondary japanese-text" onclick="showDeleteAccount()">
                                    <i class="fas fa-user-times me-2"></i>アカウント削除
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <!-- Profile Content -->
                    <div class="card profile-card">
                        <div class="card-body" style="padding: 2rem 1.5rem !important;">
                            <!-- Tab Navigation -->
                            <ul class="nav nav-tabs" id="profileTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active japanese-text" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">
                                        <i class="fas fa-user me-2"></i>基本情報
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link japanese-text" id="address-tab" data-bs-toggle="tab" data-bs-target="#address" type="button" role="tab">
                                        <i class="fas fa-map-marker-alt me-2"></i>配送先住所
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link japanese-text" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab">
                                        <i class="fas fa-shopping-bag me-2"></i>注文履歴
                                    </button>
                                </li>
                            </ul>

                            <!-- Tab Content -->
                            <div class="tab-content" id="profileTabContent" style="margin-top: 2rem !important; padding-top: 1rem !important;">
                                <!-- Basic Info Tab -->
                                <div class="tab-pane fade show active" id="info" role="tabpanel">
                                    <div class="alert alert-info japanese-text d-none" id="info-alert"></div>
                                    <form id="profile-form">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="profile-name" class="form-label japanese-text">お名前</label>
                                                <input type="text" class="form-control" id="profile-name" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="profile-email" class="form-label japanese-text">メールアドレス</label>
                                                <input type="email" class="form-control" id="profile-email" required>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="profile-phone" class="form-label japanese-text">電話番号</label>
                                                <input type="tel" class="form-control" id="profile-phone">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="profile-birthdate" class="form-label japanese-text">生年月日</label>
                                                <input type="text" class="form-control" id="profile-birthdate" placeholder="年/月/日 (例: 1990/01/15)" maxlength="10">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="profile-gender" class="form-label japanese-text">性別</label>
                                            <select class="form-control" id="profile-gender">
                                                <option value="">選択してください</option>
                                                <option value="male">男性</option>
                                                <option value="female">女性</option>
                                                <option value="other">その他</option>
                                                <option value="prefer-not-to-say">回答しない</option>
                                            </select>
                                        </div>
                                        <button type="submit" class="btn btn-profile btn-dark japanese-text">
                                            <i class="fas fa-save me-2"></i>基本情報を保存
                                        </button>
                                    </form>
                                </div>

                                <!-- Address Tab -->
                                <div class="tab-pane fade" id="address" role="tabpanel">
                                    <div class="alert alert-info japanese-text d-none" id="address-alert"></div>
                                    <form id="address-form">
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label for="postal-code" class="form-label japanese-text">郵便番号</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="postal-code" pattern="[0-9]{3}-[0-9]{4}" maxlength="8" placeholder="123-4567">
                                                    <button class="btn btn-outline-secondary" type="button" id="search-address-btn" onclick="searchAddress()">
                                                        <i class="fas fa-search"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-md-8 mb-3">
                                                <label for="prefecture" class="form-label japanese-text">都道府県</label>
                                                <input type="text" class="form-control" id="prefecture">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="city" class="form-label japanese-text">市区町村</label>
                                            <input type="text" class="form-control" id="city">
                                        </div>
                                        <div class="mb-3">
                                            <label for="address1" class="form-label japanese-text">住所1（町名・番地）</label>
                                            <input type="text" class="form-control" id="address1">
                                        </div>
                                        <div class="mb-3">
                                            <label for="address2" class="form-label japanese-text">住所2（建物名・部屋番号）</label>
                                            <input type="text" class="form-control" id="address2">
                                        </div>
                                        <button type="submit" class="btn btn-profile btn-dark japanese-text">
                                            <i class="fas fa-save me-2"></i>住所を保存
                                        </button>
                                    </form>
                                </div>

                                <!-- Orders Tab -->
                                <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title japanese-text mb-4">注文履歴</h5>
                                            <div id="orders-container">
                                                <div class="text-center py-4">
                                                    <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
                                                    <p class="japanese-text text-muted">注文履歴を読み込み中...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                        </div>
                    </div>
                </div>
            </div>

    <!-- Profile Edit Modal -->
    <div class="modal fade" id="profileEditModal" tabindex="-1" aria-labelledby="profileEditModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title japanese-heading" id="profileEditModalLabel">
                        <i class="fas fa-edit me-2"></i>プロフィール編集
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert d-none" id="profile-edit-alert"></div>
                    <form id="profile-edit-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-name" class="form-label japanese-text">お名前</label>
                                <input type="text" class="form-control" id="edit-name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-email" class="form-label japanese-text">メールアドレス</label>
                                <input type="email" class="form-control" id="edit-email" required readonly>
                                <div class="form-text japanese-text">メールアドレスは変更できません</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-phone" class="form-label japanese-text">電話番号</label>
                                <input type="tel" class="form-control" id="edit-phone">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-birthdate" class="form-label japanese-text">生年月日</label>
                                <input type="text" class="form-control" id="edit-birthdate" placeholder="年/月/日 (例: 1990/01/15)" maxlength="10">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="edit-gender" class="form-label japanese-text">性別</label>
                            <select class="form-control" id="edit-gender">
                                <option value="">選択してください</option>
                                <option value="male">男性</option>
                                <option value="female">女性</option>
                                <option value="other">その他</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary japanese-text" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-profile btn-dark japanese-text" onclick="saveProfileEdit()">
                        <i class="fas fa-save me-2"></i>保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Change Modal -->
    <div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title japanese-heading" id="passwordModalLabel">パスワード変更</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info japanese-text d-none" id="password-alert"></div>
                    <form id="password-form">
                        <div class="mb-3">
                            <label for="current-password" class="form-label japanese-text">現在のパスワード</label>
                            <input type="password" class="form-control" id="current-password" required>
                        </div>
                        <div class="mb-3">
                            <label for="new-password" class="form-label japanese-text">新しいパスワード</label>
                            <input type="password" class="form-control" id="new-password" required minlength="8">
                            <div class="form-text japanese-text">8文字以上で入力してください</div>
                        </div>
                        <div class="mb-3">
                            <label for="confirm-new-password" class="form-label japanese-text">新しいパスワード（確認）</label>
                            <input type="password" class="form-control" id="confirm-new-password" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary japanese-text" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-profile btn-dark japanese-text" onclick="changePassword()">
                        <i class="fas fa-key me-2"></i>パスワード変更
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Delete Modal -->
    <div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title japanese-heading" id="deleteAccountModalLabel">
                        <i class="fas fa-exclamation-triangle me-2"></i>アカウント削除
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-secondary japanese-text" role="alert">
                        <strong>⚠️ 重要な警告</strong><br>
                        アカウントを削除すると、以下のデータがすべて失われます：
                        <ul class="mt-2 mb-2">
                            <li>プロフィール情報</li>
                            <li>注文履歴</li>
                            <li>配送先住所</li>
                            <li>ポイント履歴</li>
                        </ul>
                        <strong>この操作は取り消すことができません。</strong>
                    </div>
                    
                    <div class="alert alert-warning japanese-text" role="alert">
                        <strong>📋 再登録制限について</strong><br>
                        アカウント削除後、同一のメールアドレスによる再登録は<strong>6ヶ月間制限</strong>されます。<br>
                        この制限は、ウェルカムボーナスポイントの濫用防止を目的としています。<br>
                        <small class="text-muted">詳細は<a href="#" onclick="showTermsModal()" class="text-decoration-none">利用規約</a>をご確認ください。</small>
                    </div>
                    
                    <div class="alert alert-light japanese-text d-none" id="delete-alert"></div>
                    
                    <form id="delete-account-form">
                        <div class="mb-3">
                            <label for="delete-password" class="form-label japanese-text">
                                <strong>パスワードを入力してアカウント削除を確認してください</strong>
                            </label>
                            <input type="password" class="form-control" id="delete-password" placeholder="現在のパスワード" required>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="delete-confirm" required>
                                <label class="form-check-label japanese-text" for="delete-confirm">
                                    <strong>上記の警告を理解し、アカウントを削除することに同意します</strong>
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary japanese-text" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>キャンセル
                    </button>
                    <button type="button" class="btn btn-danger japanese-text" onclick="confirmDeleteAccount()">
                        <i class="fas fa-trash-alt me-2"></i>アカウントを削除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript files -->
    <script src="assets/js/jquery-1.11.0.min.js"></script>
    <script src="assets/js/jquery-migrate-1.2.1.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/templatemo.js"></script>
    <script src="assets/js/custom.js"></script>
    

    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- Firebase 설정 및 유틸리티 -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/auth-utils.js"></script>

    <script>
        let profileUser = null;
        
        // 포인트 페이지 전용 변수들
        let pointsPageUser = null;
        
        // 포인트 페이지와 동일한 QR 코드 생성 함수 제거됨
        /*
        const generateQRCode = function(data, containerId) {
            try {
                console.log('QR코드 생성 시작, 데이터:', data, '타입:', typeof data);
                console.log('컨테이너 ID:', containerId);
                
                if (!data) {
                    console.error('QR코드 데이터가 없습니다');
                    return;
                }

                const container = document.getElementById(containerId);
                console.log('컨테이너 요소:', container);
                
                if (!container) {
                    console.error('컨테이너를 찾을 수 없습니다:', containerId);
                    return;
                }

                // 기존 내용 제거
                console.log('기존 컨테이너 내용 제거 전:', container.innerHTML);
                container.innerHTML = '';
                console.log('기존 컨테이너 내용 제거 후:', container.innerHTML);

                // QR 코드 생성
                console.log('qrcode 함수 확인:', typeof qrcode);
                if (typeof qrcode === 'undefined') {
                    throw new Error('qrcode 라이브러리가 로드되지 않았습니다');
                }
                
                const qr = qrcode(0, 'M');
                qr.addData(data);
                qr.make();

                // QR 코드 이미지 생성
                const qrImage = qr.createImgTag(5, 10);
                console.log('생성된 QR 코드 HTML:', qrImage);
                
                container.innerHTML = qrImage;
                console.log('컨테이너에 QR 코드 삽입 후:', container.innerHTML);

                console.log('QR코드 생성 성공');
            } catch (error) {
                console.error('QR코드 생성 오류:', error);
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = '<div class="text-danger">QR코드 생성 실패</div>';
                }
            }
        }
        */

        // QR 코드 표시 함수 제거됨
        /*
        const profileShowQRCode = async function() {
            console.log('=== QR코드 표시 함수 시작 ===');
            
            if (!pointsPageUser) {
                console.log('사용자 정보가 없어 QR코드를 생성할 수 없습니다');
                alert('ログインが必要です。');
                return;
            }

            try {
                // FirebaseService가 로드될 때까지 대기
                let attempts = 0;
                const maxAttempts = 100; // 10초 대기
                
                while (typeof window.FirebaseService === 'undefined' && attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                    if (attempts % 10 === 0) {
                        console.log(`FirebaseService 로드 대기 중... (${attempts}/100)`);
                    }
                }
                
                // Firebase 전용 QR 코드 시스템 사용
                if (typeof window.FirebaseService === 'function') {
                    console.log('✅ FirebaseService 발견, Firebase 전용 QR 토큰 사용');
                    
                    try {
                        // FirebaseService 클래스의 static 메서드 직접 호출
                        const qrToken = await window.FirebaseService.getOrCreateQRToken(pointsPageUser.uid);
                        console.log('✅ Firebase 전용 QR 토큰 사용:', qrToken);
                        
                        // 모달에 QR코드 생성 전 컨테이너 확인
                        const container = document.getElementById('qr-code-modal-container');
                        if (!container) {
                            console.error('QR 코드 컨테이너를 찾을 수 없습니다: qr-code-modal-container');
                            throw new Error('QR 코드 컨테이너를 찾을 수 없습니다');
                        }
                        console.log('QR 코드 컨테이너 발견:', container);
                        
                        // 모달에 QR코드 생성
                        generateQRCode(qrToken, 'qr-code-modal-container');
                        
                        // 모달 표시
                        const modal = new bootstrap.Modal(document.getElementById('qr-code-modal'));
                        modal.show();
                    } catch (methodError) {
                        console.error('FirebaseService.getOrCreateQRToken 호출 실패:', methodError);
                        throw new Error('FirebaseService 메서드 호출에 실패했습니다. Firebase 연결을 확인해주세요.');
                    }
                } else {
                    throw new Error('FirebaseService를 찾을 수 없습니다. Firebase 연결을 확인해주세요.');
                }
            } catch (error) {
                console.error('QR 코드 표시 실패:', error);
                alert('QRコードの表示中にエラーが発生しました');
            }
        }
        */

        // QR 코드 버튼 이벤트 리스너 설정 - 전역 함수 아님
        // QR 코드 관련 함수들 제거됨
        /*
        const setupQRCodeEventListeners = function() {
            // 모바일 QR 코드 버튼
            const mobileQRBtn = document.getElementById('qr-code-btn-mobile');
            if (mobileQRBtn) {
                mobileQRBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    // 페이지별 profileShowQRCode 함수 직접 호출
                    profileShowQRCode();
                });
                console.log('✅ 모바일 QR 코드 버튼 이벤트 리스너 등록 완료');
            }
            
            // 데스크톱 QR 코드 버튼
            const desktopQRBtn = document.getElementById('qr-code-btn');
            if (desktopQRBtn) {
                desktopQRBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    // 페이지별 profileShowQRCode 함수 직접 호출
                    profileShowQRCode();
                });
                console.log('✅ 데스크톱 QR 코드 버튼 이벤트 리스너 등록 완료');
            }
        }
        */

        // 중복된 DOMContentLoaded 이벤트 리스너 제거됨 - 아래의 이벤트 리스너 사용

        // 기본 정보 저장
        document.getElementById('profile-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const profileData = {
                    name: document.getElementById('profile-name').value,
                    email: document.getElementById('profile-email').value,
                    phone: document.getElementById('profile-phone').value,
                    birthdate: convertFromJapaneseDate(document.getElementById('profile-birthdate').value),
                    gender: document.getElementById('profile-gender').value
                };
                
                console.log('기본정보 저장 시작:', profileData);
                
                let saveSuccess = false;
                
                // Firebase 사용자인 경우
                try {
                    if (typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser && firebase.firestore) {
                        const user = firebase.auth().currentUser;
                        // 기본 사용자 정보 업데이트
                        await firebase.firestore().collection('users').doc(user.email).update({
                            name: profileData.name,
                            phone: profileData.phone,
                            profile: {
                                ...profileData,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            },
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        console.log('Firebase 기본정보 저장 성공');
                        saveSuccess = true;
                    }
                } catch (firebaseError) {
                    console.error('Firebase 저장 실패:', firebaseError);
                }
                
                // Firebase 전용
                console.log('✅ Firebase 기본정보 저장 성공');
                saveSuccess = true;
                
                // 결과 메시지 표시
                const alertDiv = document.getElementById('info-alert');
                if (saveSuccess) {
                    alertDiv.className = 'alert alert-secondary border-0 shadow-sm';
                    alertDiv.innerHTML = '<i class="fas fa-check-circle me-2 text-dark"></i><span class="text-dark">基本情報が保存されました</span>';
                    alertDiv.classList.remove('d-none');
                    
                    // 프로필 헤더 업데이트
                    await loadProfileHeader();
                    
                    // 3초 후 알림 숨기기
                    setTimeout(() => {
                        alertDiv.classList.add('d-none');
                    }, 3000);
                } else {
                    alertDiv.className = 'alert alert-secondary border-0 shadow-sm';
                    alertDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2 text-dark"></i><span class="text-dark">基本情報の保存に失敗しました</span>';
                    alertDiv.classList.remove('d-none');
                }
                
            } catch (error) {
                console.error('기본 정보 저장 중 오류:', error);
                const alertDiv = document.getElementById('info-alert');
                alertDiv.className = 'alert alert-secondary border-0 shadow-sm';
                alertDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2 text-dark"></i><span class="text-dark">基本情報の保存中にエラーが発生しました</span>';
                alertDiv.classList.remove('d-none');
            }
        });

        // 주소 저장
        document.getElementById('address-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const addressData = {
                postalCode: document.getElementById('postal-code').value,
                postal: document.getElementById('postal-code').value, // 체크아웃 페이지 호환성을 위해 추가
                prefecture: document.getElementById('prefecture').value,
                city: document.getElementById('city').value,
                address1: document.getElementById('address1').value,
                address2: document.getElementById('address2').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            // 필수 필드 검증
            if (!addressData.postalCode || !addressData.prefecture || !addressData.city || !addressData.address1) {
                const alertDiv = document.getElementById('address-alert');
                alertDiv.className = 'alert alert-secondary border-0 shadow-sm';
                alertDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2 text-dark"></i><span class="text-dark">郵便番号、都道府県、市区町村、住所1は必須項目です</span>';
                alertDiv.classList.remove('d-none');
                
                setTimeout(() => {
                    alertDiv.classList.add('d-none');
                }, 3000);
                
                return;
            }
            
            try {
                const user = firebase.auth().currentUser;
                if (user) {
                    // 저장 버튼 비활성화
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalBtnHtml = submitBtn.innerHTML;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>保存中...';

                    // Firestore에 주소 정보 저장 (이메일을 문서 ID로 사용)
                    await firebase.firestore().collection('users').doc(user.email).update({
                        address: addressData,
                        shippingAddress: addressData, // 체크아웃 페이지 호환성을 위해 추가
                        lastUsedAddress: addressData, // 체크아웃 페이지 호환성을 위해 추가
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // 성공 시 알림 메시지 표시
                    const alertDiv = document.getElementById('address-alert');
                    alertDiv.className = 'alert alert-secondary border-0 shadow-sm';
                    alertDiv.innerHTML = '<i class="fas fa-check-circle me-2 text-dark"></i><span class="text-dark">住所が保存されました</span>';
                    alertDiv.classList.remove('d-none');
                    
                    // 3초 후 성공 메시지 숨기기
                    setTimeout(() => {
                        alertDiv.classList.add('d-none');
                    }, 3000);

                    // 버튼 상태 복구
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnHtml;
                }
            } catch (error) {
                console.error('주소 저장 실패:', error);
                const alertDiv = document.getElementById('address-alert');
                alertDiv.className = 'alert alert-secondary border-0 shadow-sm';
                alertDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2 text-dark"></i><span class="text-dark">住所の保存に失敗しました</span>';
                alertDiv.classList.remove('d-none');

                // 3초 후 에러 메시지 숨기기
                setTimeout(() => {
                    alertDiv.classList.add('d-none');
                }, 3000);
            }
        });

        // 주문 이력 로드 함수 (개선됨)
        async function loadOrderHistory(userId) {
            const ordersContainer = document.getElementById('orders-container');
            
            try {
                console.log('주문 이력 로드 시작:', userId);
                console.log('FirebaseService 사용 가능:', typeof FirebaseService !== 'undefined');
                
                // 로딩 표시 (스피너만)
                ordersContainer.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-secondary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `;

                // Firebase에서만 주문 이력 조회 (로컬스토리지 사용 안함)
                let orders = [];
                
                if (typeof FirebaseService !== 'undefined' && FirebaseService.getOrderHistory) {
                    try {
                        orders = await FirebaseService.getOrderHistory(userId);
                        console.log('FirebaseService 주문 이력 조회 결과:', orders.length, '건');
                    } catch (serviceError) {
                        console.error('FirebaseService 주문 이력 조회 실패:', serviceError);
                        // Firebase 실패 시 빈 배열 반환 (로컬스토리지 폴백 제거)
                        orders = [];
                        console.log('Firebase 실패 - 주문 이력 없음');
                    }
                } else {
                    console.warn('FirebaseService를 사용할 수 없음 - 주문 이력 없음');
                    orders = [];
                }
                
                console.log('최종 주문 이력:', orders);

                // 주문을 날짜 순으로 정렬 (최신순)
                if (orders && orders.length > 0) {
                    orders.sort((a, b) => {
                        let dateA, dateB;
                        
                        // A 주문의 날짜 처리
                        if (a.orderDate && a.orderDate.seconds) {
                            dateA = new Date(a.orderDate.seconds * 1000);
                        } else if (a.orderDate && a.orderDate.toDate) {
                            dateA = a.orderDate.toDate();
                        } else if (a.orderDate) {
                            dateA = new Date(a.orderDate);
                        } else if (a.createdAt) {
                            dateA = new Date(a.createdAt);
                        } else {
                            dateA = new Date(0);
                        }
                        
                        // B 주문의 날짜 처리
                        if (b.orderDate && b.orderDate.seconds) {
                            dateB = new Date(b.orderDate.seconds * 1000);
                        } else if (b.orderDate && b.orderDate.toDate) {
                            dateB = b.orderDate.toDate();
                        } else if (b.orderDate) {
                            dateB = new Date(b.orderDate);
                        } else if (b.createdAt) {
                            dateB = new Date(b.createdAt);
                        } else {
                            dateB = new Date(0);
                        }
                        
                        // 최신순 정렬 (내림차순)
                        return dateB.getTime() - dateA.getTime();
                    });
                    
                    console.log('주문 이력 최신순 정렬 완료:', orders.length, '건');
                }

                if (!orders || orders.length === 0) {
                    // 주문 이력이 없는 경우 (신규 사용자)
                    console.log('주문 이력이 없음 - 신규 사용자 또는 주문 없음');
                    ordersContainer.innerHTML = `
                        <div class="text-center py-4">
                            <p class="japanese-text">注文履歴がありません</p>
                        </div>
                    `;
                    return;
                }
                
                // 주문이 있는 경우 계속 진행

                // 주문 이력 HTML 생성
                let ordersHtml = '';
                orders.forEach(order => {
                    // 주문 데이터를 전역 변수로 저장 (영수증 다운로드용)
                    const orderKey = `orderData_${order.id || order.orderId}`;
                    window[orderKey] = order;
                    console.log('주문 데이터 전역 변수 저장:', orderKey, order);

                    // 날짜 형식 처리 (다양한 형식 지원)
                    let orderDate;
                    if (order.orderDate && order.orderDate.seconds) {
                        // Firestore Timestamp
                        orderDate = new Date(order.orderDate.seconds * 1000);
                    } else if (order.orderDate && order.orderDate.toDate) {
                        // Firestore Timestamp 객체
                        orderDate = order.orderDate.toDate();
                    } else if (order.orderDate) {
                        // 일반 Date 문자열
                        orderDate = new Date(order.orderDate);
                    } else if (order.createdAt) {
                        // createdAt 사용 (폴백)
                        orderDate = new Date(order.createdAt);
                    } else {
                        // 날짜 정보가 없는 경우
                        orderDate = new Date();
                    }

                    const formattedDate = orderDate.toLocaleDateString('ja-JP', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    // 주문 총액 계산 (상품 가격은 이미 소비세 포함)
                    const totalWithTax = order.items.reduce((total, item) => total + (item.price * item.quantity), 0);
                    const subtotal = Math.floor(totalWithTax / 1.1); // 세전 가격
                    const tax = totalWithTax - subtotal; // 소비세
                    const shippingFee = totalWithTax >= 3000 ? 0 : 500; // 세포함 가격 기준
                    
                    // 포인트 정보 (Firebase에서 저장된 데이터 사용)
                    const usedPoints = order.usedPoints || order.pointDiscount || 0;
                    const earnedPoints = order.earnedPoints || Math.floor(subtotal * 0.03);
                    
                    // 최종 결제 금액 계산
                    const grossTotal = totalWithTax + shippingFee; // 총금액 (세금+배송비 포함)
                    const finalTotal = order.totalAmount || (grossTotal - usedPoints); // 실제 결제금액

                    ordersHtml += `
                        <div class="order-item mb-4">
                            <div class="card">
                                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                                    <span class="japanese-text">
                                        <i class="fas fa-shopping-bag me-2"></i>注文番号: ${order.id || order.orderId || 'N/A'}
                                    </span>
                                    <span class="japanese-text">${formattedDate}</span>
                                </div>
                                <div class="card-body">
                                    <div class="order-items mb-3">
                                        ${order.items.map(item => `
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <div>
                                                    <div class="japanese-heading">${item.name}</div>
                                                    <small class="text-muted japanese-text">${item.brand} × ${item.quantity}</small>
                                                </div>
                                                <div class="japanese-text">¥${(item.price * item.quantity).toLocaleString()}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div class="order-summary bg-light p-3 rounded">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="japanese-text">商品合計:</span>
                                            <span>¥${subtotal.toLocaleString()}</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="japanese-text">配送料:</span>
                                            <span>${shippingFee === 0 ? '無料' : '¥' + shippingFee.toLocaleString()}</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="japanese-text">消費税:</span>
                                            <span>¥${tax.toLocaleString()}</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="japanese-text">総額:</span>
                                            <span>¥${grossTotal.toLocaleString()}</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="japanese-text text-dark">ポイント使用:</span>
                                            <span class="text-dark">${usedPoints > 0 ? '-¥' + usedPoints.toLocaleString() : '¥0'}</span>
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between mb-3">
                                            <strong class="japanese-text">支払額:</strong>
                                            <strong>¥${finalTotal.toLocaleString()}</strong>
                                        </div>
                                        ${earnedPoints > 0 ? `
                                        <div class="d-flex justify-content-between">
                                            <span class="japanese-text text-muted"><small>獲得ポイント:</small></span>
                                            <span class="text-muted"><small>${earnedPoints}pt</small></span>
                                        </div>
                                        ` : ''}
                                        
                                    </div>
                                </div>
                                <div class="card-footer bg-light">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="japanese-text">
                                            <i class="fas fa-map-marker-alt me-2"></i>配送先:
                                            ${order.shipping?.prefecture || ''} ${order.shipping?.city || ''}
                                        </span>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="order-status ${getStatusClass(order.status)} japanese-text">
                                                ${getStatusText(order.status)}
                                            </span>
                                            ${order.status === 'completed' ? `
                                                <button class="btn btn-sm btn-outline-dark" onclick="downloadReceiptFromOrder('${order.id || order.orderId}')" title="領収書を表示・ダウンロード">
                                                    <i class="fas fa-receipt me-1"></i>領収書
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                ordersContainer.innerHTML = ordersHtml;

            } catch (error) {
                console.error('주문 이력 로드 실패:', error);
                ordersContainer.innerHTML = `
                    <div class="alert alert-danger japanese-text" role="alert">
                        <i class="fas fa-exclamation-circle me-2"></i>注文履歴の読み込みに失敗しました。
                        <br>
                        <small class="text-muted">${error.message}</small>
                    </div>
                `;
            }
        }
        
        // 로컬스토리지 주문 이력 조회 함수 (사용 안함 - Firebase 전용)
        function getOrderHistoryDirectly(userId) {
            console.warn('getOrderHistoryDirectly 함수는 더 이상 사용되지 않습니다. Firebase 전용으로 변경되었습니다.');
            return []; // 항상 빈 배열 반환
        }

        // 로그인 상태 확인 (Firebase 전용)
        function getLoginStatus() {
            try {
                // Firebase에서 현재 로그인된 사용자 확인
                if (typeof firebase !== 'undefined' && 
                    firebase.auth && 
                    firebase.apps && 
                    firebase.apps.length > 0 &&
                    firebase.apps[0].name === '[DEFAULT]') {
                    
                    const user = firebase.auth().currentUser;
                    if (user && user.email) {
                        return {
                            email: user.email,
                            uid: user.uid,
                            name: user.displayName || user.email.split('@')[0]
                        };
                    }
                }
                return null;
            } catch (error) {
                console.error('Firebase 로그인 상태 확인 중 오류:', error);
                return null;
            }
        }

        // 사용자 데이터 관리 함수 - Firebase 전용 시스템

        function getCurrentUser() {
            console.log('🔍 profile.html getCurrentUser 호출');
            
            // Firebase 사용자만 확인 (안전한 방식)
            try {
                // Firebase 기본 객체 확인
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    const firebaseUser = firebase.auth().currentUser;
                    console.log('🔍 profile.html Firebase currentUser:', firebaseUser ? firebaseUser.email : 'null');
                    
                    if (firebaseUser) {
                        console.log('✅ profile.html Firebase 사용자 확인됨:', firebaseUser.email);
                        return firebaseUser;
                    } else {
                        console.log('❌ profile.html Firebase 사용자 없음 (로그아웃 상태 또는 인증 상태 복원 중)');
                    }
                } else {
                    console.log('❌ profile.html Firebase Auth 사용 불가능 (Firebase 미초기화)');
                }
            } catch (error) {
                console.warn('profile.html Firebase 사용자 확인 중 오류:', error);
            }
            
            console.log('❌ profile.html 로그인된 사용자 없음');
            return null;
        }

        async function updateCurrentUser(updatedData) {
            const loginStatus = getLoginStatus();
            if (!loginStatus) return false;

            try {
                // Firebase Firestore에 사용자 데이터 업데이트
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    await firebase.firestore().collection('users').doc(loginStatus.email).update({
                        ...updatedData,
                        updatedAt: new Date().toISOString()
                    });
                    console.log('Firebase 사용자 데이터 업데이트 성공');
                    return true;
                }
            } catch (error) {
                console.error('Firebase 사용자 데이터 업데이트 실패:', error);
            }
            
            return false;
        }

        // 로그아웃 함수 (카트 정보 유지) - 모바일/웹 호환
        async function logout() {
            try {
                console.log('=== profile.html 로그아웃 시작 (카트 정보 유지) - 모바일/웹 호환 ===');
                
                // Firebase Auth 상태 변경 리스너 일시 중단 (모바일에서 중요)
                if (window.profileAuthStateUnsubscribe) {
                    window.profileAuthStateUnsubscribe();
                    window.profileAuthStateUnsubscribe = null;
                    console.log('✅ Firebase Auth 상태 변경 리스너 중단');
                }
                
                // Firebase 로그아웃
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    await firebase.auth().signOut();
                    console.log('✅ Firebase 로그아웃 완료');
                }
                
                // 사용자 정보 초기화 (카트 정보는 유지)
                profileUser = null;
                pointsPageUser = null;
                console.log('✅ 사용자 정보 초기화 완료');
                
                // 로그인 관련 localStorage 완전 정리 (모바일 호환)
                const loginKeys = [
                    'aetherLoginStatus', 'aetherLogin', 'aetherUser', 'aetherUserInfo',
                    'aetherAuthToken', 'aetherSession', 'aetherRemember'
                ];
                
                loginKeys.forEach(key => {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key);
                });
                
                // 모든 aether 관련 키 중 로그인 관련만 제거 (카트는 유지)
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('aether') && 
                        (key.includes('Login') || key.includes('Auth') || key.includes('User') || key.includes('Session'))) {
                        localStorage.removeItem(key);
                    }
                });
                
                Object.keys(sessionStorage).forEach(key => {
                    if (key.startsWith('aether') && 
                        (key.includes('Login') || key.includes('Auth') || key.includes('User') || key.includes('Session'))) {
                        sessionStorage.removeItem(key);
                    }
                });
                
                console.log('✅ 로그인 관련 localStorage/sessionStorage 완전 정리 완료');
                
                // 모바일 브라우저 캐시 정리 (가능한 경우)
                if ('caches' in window) {
                    try {
                        const cacheNames = await caches.keys();
                        for (const cacheName of cacheNames) {
                            if (cacheName.includes('aether') || cacheName.includes('auth')) {
                                await caches.delete(cacheName);
                                console.log(`✅ 캐시 삭제: ${cacheName}`);
                            }
                        }
                    } catch (cacheError) {
                        console.log('⚠️ 캐시 정리 중 오류 (무시 가능):', cacheError);
                    }
                }
                
                // 사용자 메뉴 직접 업데이트 (auth-utils.js 호출 방지)
                updateUserMenuDirectly();
                console.log('✅ 사용자 메뉴 직접 업데이트 완료');
                
                // 카트 개수 업데이트 (로그아웃 상태이므로 0으로 표시)
                updateCartCount();
                console.log('✅ 카트 개수 업데이트 완료');
                
                // 토스트 메시지 표시
                if (typeof window.showToast === 'function') {
                    window.showToast('ログアウトしました。', 'success', 2000);
                } else {
                    alert('ログアウトしました。');
                }
                
                console.log('✅ profile.html 로그아웃 성공 (카트 정보 유지) - 모바일/웹 호환');
                
                // 강제 페이지 새로고침과 함께 홈페이지로 리다이렉트 (모바일에서 확실한 로그아웃)
                setTimeout(() => {
                    // 모바일에서 확실한 로그아웃을 위해 강제 새로고침
                    window.location.replace('index.html');
                }, 1000);
                
            } catch (error) {
                console.error('❌ profile.html 로그아웃 중 오류:', error);
                
                // 오류가 발생해도 기본 정리 작업 수행
                profileUser = null;
                pointsPageUser = null;
                
                // Firebase Auth 상태 변경 리스너 중단
                if (window.profileAuthStateUnsubscribe) {
                    window.profileAuthStateUnsubscribe();
                    window.profileAuthStateUnsubscribe = null;
                }
                
                // 로그인 관련 localStorage 정리
                const loginKeys = [
                    'aetherLoginStatus', 'aetherLogin', 'aetherUser', 'aetherUserInfo',
                    'aetherAuthToken', 'aetherSession', 'aetherRemember'
                ];
                
                loginKeys.forEach(key => {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key);
                });
                
                // 사용자 메뉴 직접 업데이트
                updateUserMenuDirectly();
                
                updateCartCount();
                
                if (typeof window.showToast === 'function') {
                    window.showToast('ログアウトしました。', 'success', 2000);
                } else {
                    alert('ログアウトしました。');
                }
                
                // 강제 페이지 새로고침과 함께 홈페이지로 리다이렉트
                setTimeout(() => {
                    window.location.replace('index.html');
                }, 1000);
            }
        }
        
        // 사용자 메뉴 직접 업데이트 함수 (auth-utils.js 호출 방지) - 모바일/웹 호환
        function updateUserMenuDirectly() {
            try {
                console.log('🔧 profile.html 사용자 메뉴 직접 업데이트 시작 - 모바일/웹 호환');
                
                // 현재 로그인 상태 확인
                const currentUser = getCurrentUser();
                const isLoggedIn = currentUser !== null;
                
                console.log('🔍 현재 로그인 상태:', isLoggedIn ? '로그인됨' : '로그아웃됨');
                
                // 메뉴 요소들 정의
                const logoutMenus = ['logout-menu', 'logout-menu-item', 'logout-menu-mobile', 'logout-menu-item-mobile'];
                const profileMenus = ['profile-menu', 'profile-menu-mobile', 'points-menu', 'points-menu-mobile'];
                const loginMenus = ['login-menu', 'login-menu-mobile', 'register-menu', 'register-menu-mobile'];
                
                if (isLoggedIn) {
                    // 로그인 상태: 로그인 메뉴 숨기기, 로그아웃/프로필 메뉴 표시
                    console.log('🔧 로그인 상태 - 메뉴 업데이트');
                    
                    // 로그인 메뉴 숨기기
                    loginMenus.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'none';
                            console.log(`✅ ${id} 숨기기 완료`);
                        }
                    });
                    
                    // 로그아웃 메뉴 표시
                    logoutMenus.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'block';
                            console.log(`✅ ${id} 표시 완료`);
                        }
                    });
                    
                    // 프로필 메뉴 표시
                    profileMenus.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'block';
                            console.log(`✅ ${id} 표시 완료`);
                        }
                    });
                    
                    // 사용자 이름 표시
                    const userNameElement = document.getElementById('user-name');
                    if (userNameElement && currentUser.email) {
                        userNameElement.textContent = currentUser.displayName || currentUser.email.split('@')[0];
                        userNameElement.classList.remove('d-none');
                        console.log('✅ 사용자 이름 표시 완료:', userNameElement.textContent);
                    }
                    
                } else {
                    // 로그아웃 상태: 로그아웃/프로필 메뉴 숨기기, 로그인 메뉴 표시
                    console.log('🔧 로그아웃 상태 - 메뉴 업데이트');
                    
                    // 로그아웃 메뉴 숨기기
                    logoutMenus.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'none';
                            console.log(`✅ ${id} 숨기기 완료`);
                        }
                    });
                    
                    // 프로필 메뉴 숨기기
                    profileMenus.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'none';
                            console.log(`✅ ${id} 숨기기 완료`);
                        }
                    });
                    
                    // 로그인 메뉴 표시
                    loginMenus.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'block';
                            console.log(`✅ ${id} 표시 완료`);
                        }
                    });
                    
                    // 사용자 이름 요소 초기화
                    const userNameElement = document.getElementById('user-name');
                    if (userNameElement) {
                        userNameElement.textContent = '';
                        userNameElement.classList.add('d-none');
                        console.log('✅ 사용자 이름 요소 초기화 완료');
                    }
                }
                
                console.log('✅ profile.html 사용자 메뉴 직접 업데이트 완료 - 모바일/웹 호환');
                
            } catch (error) {
                console.error('❌ profile.html 사용자 메뉴 직접 업데이트 실패:', error);
            }
        }

        // 알림 표시
        function showAlert(elementId, message, type = 'success') {
            const alertElement = document.getElementById(elementId);
            alertElement.className = 'alert alert-' + type + ' japanese-text';
            alertElement.textContent = message;
            alertElement.classList.remove('d-none');
            
            setTimeout(() => {
                alertElement.classList.add('d-none');
            }, 3000);
        }

        // 프로필 편집 (현재는 탭 전환만)
        // 프로필 편집 모달 표시
        async function showEditProfile() {
            try {
                console.log('프로필 편집 모달 열기');
                
                // 현재 사용자 정보 로드
                let userData = null;
                
                // Firebase 사용자 확인
                const user = firebase.auth && firebase.auth().currentUser;
                if (user) {
                    try {
                    const userDoc = await firebase.firestore().collection('users').doc(user.email).get();
                    if (userDoc.exists) {
                            userData = userDoc.data();
                        }
                    } catch (firebaseError) {
                        console.warn('Firebase 사용자 정보 로드 실패:', firebaseError);
                    }
                }
                
                // Firebase 전용
                
                // 모달 필드 채우기
                if (userData) {
                    document.getElementById('edit-name').value = userData.name || '';
                    document.getElementById('edit-email').value = userData.email || '';
                    document.getElementById('edit-phone').value = userData.phone || '';
                    // 편집 모달의 생년월일을 일본어 형식으로 변환
                    const editBirthdate = userData.profile?.birthdate || '';
                    if (editBirthdate) {
                        const formattedEditDate = convertToJapaneseDate(editBirthdate);
                        document.getElementById('edit-birthdate').value = formattedEditDate;
                    } else {
                        document.getElementById('edit-birthdate').value = '';
                    }
                    document.getElementById('edit-gender').value = userData.profile?.gender || '';
            } else {
                    // 기본값 설정
                    document.getElementById('edit-email').value = '';
                    document.getElementById('edit-name').value = '';
                }
                
                // 모달 표시
                const modal = new bootstrap.Modal(document.getElementById('profileEditModal'));
            modal.show();
                
            } catch (error) {
                console.error('프로필 편집 모달 열기 오류:', error);
                alert('프로필 정보를 불러오는 중 오류가 발생했습니다.');
            }
        }

        // 계정 삭제 모달 표시
        function showDeleteAccount() {
            const modal = new bootstrap.Modal(document.getElementById('deleteAccountModal'));
            modal.show();
        }

        // 계정 삭제 확인 및 실행
        async function confirmDeleteAccount() {
            const password = document.getElementById('delete-password').value;
            const confirmCheckbox = document.getElementById('delete-confirm').checked;

            if (!password) {
                showDeleteAlert('パスワードを入力してください。', 'danger');
                return;
            }

            if (!confirmCheckbox) {
                showDeleteAlert('削除の確認にチェックを入れてください。', 'danger');
                return;
            }

            // 버튼 비활성화
            const deleteBtn = document.querySelector('#deleteAccountModal .btn-danger');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>削除中...';

            try {
                const loginStatus = getLoginStatus();
                if (!loginStatus) {
                    showDeleteAlert('ログイン情報が見つかりません。', 'danger');
                    return;
                }

                // 패스워드 검증
                const isValidPassword = await validatePassword(loginStatus.email, password);
                if (!isValidPassword) {
                    showDeleteAlert('パスワードが正しくありません。', 'danger');
                    return;
                }

                // 계정 삭제 실행 (Firebase 전용)
                let deleteResult;
                if (typeof FirebaseService !== 'undefined') {
                    deleteResult = await FirebaseService.deleteUserAccount(loginStatus.uid || loginStatus.email, loginStatus.email);
                } else {
                    console.error('❌ Firebase Service를 사용할 수 없음');
                    showDeleteAlert('アカウント削除サービスを利用できません。', 'danger');
                    return;
                }

                if (deleteResult.success) {
                    showDeleteAlert('アカウントが正常に削除されました。トップページに移動します...', 'success');
                    
                    // Firebase 전용 로그아웃 처리
                    
                    // Firebase Auth 로그아웃
                    if (typeof firebase !== 'undefined' && firebase.auth) {
                        try {
                            await firebase.auth().signOut();
                            console.log('Firebase Auth 로그아웃 완료');
                        } catch (signOutError) {
                            console.warn('Firebase Auth 로그아웃 실패:', signOutError);
                        }
                    }
                    
                    setTimeout(() => {
                        window.location.replace('index.html'); // replace로 변경하여 뒤로가기 방지
                    }, 2000);
                } else {
                    showDeleteAlert('アカウント削除に失敗しました: ' + deleteResult.error, 'danger');
                }
            } catch (error) {
                console.error('계정 삭제 중 오류:', error);
                showDeleteAlert('アカウント削除中にエラーが発生しました。', 'danger');
            } finally {
                // 성공한 경우가 아니면 버튼 복원
                setTimeout(() => {
                    if (deleteBtn.disabled) {
                        deleteBtn.disabled = false;
                        deleteBtn.innerHTML = originalText;
                    }
                }, 1000);
            }
        }

        // 패스워드 검증 (Firebase 전용)
        async function validatePassword(email, password) {
            try {
                // Firebase 전용 패스워드 검증
                if (typeof FirebaseService !== 'undefined' && FirebaseService.isFirebaseAvailable()) {
                    const result = await FirebaseService.loginUser(email, password);
                    return result.success;
                }

                console.warn('⚠️ Firebase Service를 사용할 수 없음');
                return false;
            } catch (error) {
                console.error('❌ 패스워드 검증 실패:', error);
                return false;
            }
        }

        // 계정 삭제 함수 - Firebase 전용 시스템

        // 삭제 알림 표시
        function showDeleteAlert(message, type = 'danger') {
            const alertDiv = document.getElementById('delete-alert');
            // danger 타입을 secondary로 변경하여 모노톤 색상 적용
            const alertType = type === 'danger' ? 'secondary' : type;
            alertDiv.className = 'alert alert-' + alertType + ' japanese-text';
            alertDiv.innerHTML = message;
            alertDiv.classList.remove('d-none');
            setTimeout(() => alertDiv.classList.add('d-none'), 5000);
        }

        // 사용자 메뉴 업데이트 (auth-utils.js 함수 사용)
        function updateUserMenuFromProfile() {
            console.log('프로필 페이지에서 사용자 메뉴 업데이트 시도');
            
            // profile.html 전용 메뉴 업데이트 로직
            try {
                // 현재 사용자 확인
                const currentUser = getCurrentUser();
                if (currentUser) {
                    console.log('✅ profile.html 사용자 확인됨:', currentUser.email);
                    
                    // 관리자 권한 확인
                    const isAdmin = currentUser.email === 'admin7@gmail.com';
                    console.log('관리자 권한:', isAdmin);
                    
                    // 관리자 메뉴 표시/숨김
                    const adminMenu = document.getElementById('admin-menu');
                    const adminMenuMobile = document.getElementById('admin-menu-mobile');
                    
                    if (adminMenu) {
                        adminMenu.style.display = isAdmin ? 'block' : 'none';
                        console.log('데스크톱 관리자 메뉴:', isAdmin ? '표시' : '숨김');
                    } else {
                        console.warn('admin-menu 요소를 찾을 수 없습니다');
                    }
                    
                    if (adminMenuMobile) {
                        adminMenuMobile.style.display = isAdmin ? 'block' : 'none';
                        console.log('모바일 관리자 메뉴:', isAdmin ? '표시' : '숨김');
                    } else {
                        console.warn('admin-menu-mobile 요소를 찾을 수 없습니다');
                    }
                    
                    // 사용자 메뉴 표시
                    const loginMenu = document.getElementById('login-menu');
                    const registerMenu = document.getElementById('register-menu');
                    const profileMenu = document.getElementById('profile-menu');
                    const pointsMenu = document.getElementById('points-menu');
                    const logoutMenu = document.getElementById('logout-menu');
                    const logoutMenuItem = document.getElementById('logout-menu-item');
                    
                    // 로그인/회원가입 메뉴 숨김
                    if (loginMenu) loginMenu.style.display = 'none';
                    if (registerMenu) registerMenu.style.display = 'none';
                    
                    // 프로필/포인트/로그아웃 메뉴 표시
                    if (profileMenu) profileMenu.style.display = 'block';
                    if (pointsMenu) pointsMenu.style.display = 'block';
                    if (logoutMenu) logoutMenu.style.display = 'block';
                    if (logoutMenuItem) logoutMenuItem.style.display = 'block';
                    
                    // 모바일 메뉴도 동일하게 처리
                    const loginMenuMobile = document.getElementById('login-menu-mobile');
                    const registerMenuMobile = document.getElementById('register-menu-mobile');
                    const profileMenuMobile = document.getElementById('profile-menu-mobile');
                    const pointsMenuMobile = document.getElementById('points-menu-mobile');
                    const logoutMenuMobile = document.getElementById('logout-menu-mobile');
                    const logoutMenuItemMobile = document.getElementById('logout-menu-item-mobile');
                    
                    if (loginMenuMobile) loginMenuMobile.style.display = 'none';
                    if (registerMenuMobile) registerMenuMobile.style.display = 'none';
                    if (profileMenuMobile) profileMenuMobile.style.display = 'block';
                    if (pointsMenuMobile) pointsMenuMobile.style.display = 'block';
                    if (logoutMenuMobile) logoutMenuMobile.style.display = 'block';
                    if (logoutMenuItemMobile) logoutMenuItemMobile.style.display = 'block';
                    
                    console.log('✅ profile.html 메뉴 업데이트 완료');
                } else {
                    console.log('❌ profile.html 로그인된 사용자 없음');
                    
                    // 로그인/회원가입 메뉴 표시
                    const loginMenu = document.getElementById('login-menu');
                    const registerMenu = document.getElementById('register-menu');
                    const profileMenu = document.getElementById('profile-menu');
                    const pointsMenu = document.getElementById('points-menu');
                    const logoutMenu = document.getElementById('logout-menu');
                    const logoutMenuItem = document.getElementById('logout-menu-item');
                    
                    if (loginMenu) loginMenu.style.display = 'block';
                    if (registerMenu) registerMenu.style.display = 'block';
                    if (profileMenu) profileMenu.style.display = 'none';
                    if (pointsMenu) pointsMenu.style.display = 'none';
                    if (logoutMenu) logoutMenu.style.display = 'none';
                    if (logoutMenuItem) logoutMenuItem.style.display = 'none';
                    
                    // 모바일 메뉴도 동일하게 처리
                    const loginMenuMobile = document.getElementById('login-menu-mobile');
                    const registerMenuMobile = document.getElementById('register-menu-mobile');
                    const profileMenuMobile = document.getElementById('profile-menu-mobile');
                    const pointsMenuMobile = document.getElementById('points-menu-mobile');
                    const logoutMenuMobile = document.getElementById('logout-menu-mobile');
                    const logoutMenuItemMobile = document.getElementById('logout-menu-item-mobile');
                    
                    if (loginMenuMobile) loginMenuMobile.style.display = 'block';
                    if (registerMenuMobile) registerMenuMobile.style.display = 'block';
                    if (profileMenuMobile) profileMenuMobile.style.display = 'none';
                    if (pointsMenuMobile) pointsMenuMobile.style.display = 'none';
                    if (logoutMenuMobile) logoutMenuMobile.style.display = 'none';
                    if (logoutMenuItemMobile) logoutMenuItemMobile.style.display = 'none';
                }
            } catch (error) {
                console.error('profile.html 메뉴 업데이트 오류:', error);
            }
        }

        // 카트 개수 업데이트 (Firebase 전용)
        async function updateCartCount() {
            console.log('🔢 profile.html updateCartCount 호출');
            
            try {
                // 현재 로그인된 사용자 확인
                const currentUser = getCurrentUser();
                if (!currentUser) {
                    console.log('📝 로그인되지 않은 사용자 - 카트 수량 0');
                    updateCartCountDisplay(0);
                    return;
                }
                
                console.log('✅ profile.html 로그인된 사용자 확인됨:', currentUser.email);
                
                // Firebase에서 카트 수량 가져오기
                if (typeof firebase !== 'undefined' && firebase.firestore && firebase.apps && firebase.apps.length > 0) {
                    console.log('✅ profile.html Firebase 사용 가능, 카트 데이터 조회 시작');
                    const db = firebase.firestore();
                    const cartDoc = await db.collection('userCarts').doc(currentUser.email).get();
                    
                    if (cartDoc.exists) {
                        const cartData = cartDoc.data().cart || [];
                        const totalItems = cartData.reduce((total, item) => total + (item.quantity || 1), 0);
                        console.log('✅ profile.html Firebase 카트 수량:', totalItems, '개');
                        updateCartCountDisplay(totalItems);
                    } else {
                        console.log('📝 profile.html Firebase 카트 없음 - 수량 0');
                        updateCartCountDisplay(0);
                    }
                } else {
                    console.log('📝 profile.html Firebase 사용 불가 - 수량 0');
                    updateCartCountDisplay(0);
                }
            } catch (error) {
                console.warn('⚠️ profile.html 카트 수량 업데이트 실패:', error);
                updateCartCountDisplay(0);
            }
        }

        // 카트 수량 표시 업데이트
        function updateCartCountDisplay(count) {
            // 데스크톱용 장바구니 카운트 업데이트
            const cartCountElement = document.getElementById('cart-count');
            if (cartCountElement) {
                cartCountElement.textContent = count;
                console.log('✅ profile.html 데스크톱 카트 수량 업데이트:', count, '개');
            } else {
                console.warn('⚠️ profile.html 데스크톱 카트 아이콘을 찾을 수 없습니다');
            }
            
            // 모바일용 장바구니 카운트 업데이트
            const cartCountMobileElement = document.getElementById('cart-count-mobile');
            if (cartCountMobileElement) {
                cartCountMobileElement.textContent = count;
                console.log('✅ profile.html 모바일 카트 수량 업데이트:', count, '개');
            } else {
                console.warn('⚠️ profile.html 모바일 카트 아이콘을 찾을 수 없습니다');
            }
            
            console.log('✅ profile.html 카트 수량 표시 업데이트 완료:', count, '개');
        }

        // 프로필 헤더 업데이트 함수
        function updateProfileHeader(userData) {
            try {
                console.log('프로필 헤더 업데이트 시작:', userData);
                
                const displayNameEl = document.getElementById('profile-display-name');
                const displayEmailEl = document.getElementById('profile-display-email');
                
                if (userData && userData.name && userData.email) {
                    if (displayNameEl) {
                        displayNameEl.textContent = userData.name;
                        console.log('프로필 이름 업데이트:', userData.name);
                    }
                    
                    if (displayEmailEl) {
                        displayEmailEl.textContent = userData.email;
                        console.log('프로필 이메일 업데이트:', userData.email);
                    }
                    
                    console.log('✅ 프로필 헤더 업데이트 완료');
                } else {
                    console.log('사용자 데이터 없음 - Firebase Auth에서 사용자 정보 가져오기 시도');
                    
                    // Firebase Auth에서 직접 사용자 정보 가져오기
                    const currentUser = getCurrentUser();
                    if (currentUser) {
                        const firebaseUserData = {
                            name: currentUser.displayName || currentUser.email.split('@')[0],
                            email: currentUser.email
                        };
                        
                        if (displayNameEl) {
                            displayNameEl.textContent = firebaseUserData.name;
                        }
                        
                        if (displayEmailEl) {
                            displayEmailEl.textContent = firebaseUserData.email;
                        }
                        
                        console.log('✅ Firebase Auth에서 사용자 정보 가져와서 프로필 헤더 업데이트 완료');
                    } else {
                        console.log('Firebase Auth에서도 사용자 정보를 찾을 수 없음 - 인증 상태 확인 대기');
                        // 로그인 페이지로 즉시 리다이렉트하지 않고 인증 상태 확인 대기
                    }
                }
            } catch (error) {
                console.error('프로필 헤더 업데이트 실패:', error);
                // 오류 발생 시에도 Firebase Auth에서 사용자 정보 확인
                const currentUser = getCurrentUser();
                if (!currentUser) {
                    console.log('오류 발생 후에도 사용자 정보 없음 - 인증 상태 확인 대기');
                    // 로그인 페이지로 즉시 리다이렉트하지 않고 인증 상태 확인 대기
                }
            }
        }

        // Firebase 연결 상태 체크
        async function checkFirebaseStatus() {
            console.log('=== Firebase 상태 체크 ===');
            console.log('- firebase 객체:', typeof firebase !== 'undefined' ? 'OK' : 'MISSING');
            console.log('- firebase.auth:', typeof firebase !== 'undefined' && firebase.auth ? 'OK' : 'MISSING');
            console.log('- firebase.firestore:', typeof firebase !== 'undefined' && firebase.firestore ? 'OK' : 'MISSING');
            console.log('- FirebaseService:', typeof FirebaseService !== 'undefined' ? 'OK' : 'MISSING');
            console.log('- 현재 사용자:', firebase && firebase.auth ? firebase.auth().currentUser?.email || 'None' : 'Cannot check');
            
            // Firestore 연결 테스트
            if (typeof window.checkFirestoreConnection === 'function') {
                const isConnected = await window.checkFirestoreConnection();
                console.log('- Firestore 연결:', isConnected ? 'OK' : 'FAILED');
                
                if (!isConnected) {
                    console.log('⚠️  Firestore 연결 실패');
                    // 오프라인 모드 메시지 비활성화
                    // showAlert('info-alert', 'オフラインモードで動作しています。一部機能が制限される場合があります。', 'warning');
                }
            }
            console.log('=======================');
        }  

        // 우편번호 자동 포맷팅
        document.getElementById('postal-code').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 3) {
                value = value.substring(0, 3) + '-' + value.substring(3);
            }
            e.target.value = value;
            
            // 우편번호가 완성되면(8자리) 자동으로 주소 검색
            if (value.length === 8) {
                searchAddress();
            }
        });

        // 우편번호로 주소 검색
        async function searchAddress() {
            const postalCodeInput = document.getElementById('postal-code');
            const searchBtn = document.getElementById('search-address-btn');
            const alertDiv = document.getElementById('address-alert');
            
            // 버튼 상태 변경
            const originalBtnHtml = searchBtn.innerHTML;
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                // 우편번호 형식 정리 (하이픈 제거)
                const postalCode = postalCodeInput.value.replace(/-/g, '');
                
                if (postalCode.length !== 7) {
                    throw new Error('郵便番号は7桁で入力してください。');
                }
                
                // 우편번호 API 호출
                const response = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${postalCode}`);
                const data = await response.json();
                
                if (data.status === 200 && data.results) {
                    if (data.results.length > 0) {
                    const result = data.results[0];
                    
                        // 주소 필드에 값 설정
                    document.getElementById('prefecture').value = result.address1;
                        document.getElementById('city').value = result.address2;
                        document.getElementById('address1').value = result.address3;
                        
                        // 성공 메시지 제거
                        alertDiv.classList.add('d-none');
                } else {
                        throw new Error('該当する住所が見つかりませんでした。');
                    }
                } else {
                    throw new Error('住所の検索に失敗しました。');
                }
            } catch (error) {
                // 에러 메시지 표시
                alertDiv.className = 'alert alert-danger japanese-text';
                alertDiv.textContent = error.message;
                alertDiv.classList.remove('d-none');
            } finally {
                // 버튼 상태 복구
                searchBtn.disabled = false;
                searchBtn.innerHTML = originalBtnHtml;
                
                // 3초 후 알림 메시지 숨기기
                setTimeout(() => {
                    alertDiv.classList.add('d-none');
                }, 3000);
            }
        }




        // 프로필 정보 자동 로드 함수
        async function loadSavedProfileInfo() {
            try {
                // 모바일 감지
                const isMobile = window.innerWidth <= 768;
                console.log('저장된 프로필 정보 로드 시작');
                console.log('📱 모바일 여부:', isMobile);
                console.log('📱 화면 크기:', window.innerWidth + 'x' + window.innerHeight);
                
                let profileData = null;
                
                // 1. Firebase에서 로드 시도 (안전한 방식)
                if (typeof window.FirebaseService !== 'undefined' && 
                    window.FirebaseService.isFirebaseAvailable() && 
                    typeof firebase !== 'undefined' && 
                    firebase.app && 
                    firebase.auth && 
                    firebase.firestore) {
                    try {
                        const user = firebase.auth().currentUser;
                        if (user && user.email) {
                            const userDoc = await firebase.firestore().collection('users').doc(user.email).get();
                            
                            if (userDoc.exists) {
                                profileData = userDoc.data();
                                console.log('Firebase에서 프로필 로드 성공');
                            }
                        }
                    } catch (firebaseError) {
                        console.warn('Firebase 프로필 로드 실패:', firebaseError);
                    }
                } else {
                    console.log('Firebase가 초기화되지 않았거나 사용할 수 없음');
                }
                
                // 2. Firebase 전용
                if (!profileData) {
                    console.log('⚠️ Firebase에서 프로필 데이터를 찾을 수 없음');
                }
                
                // 3. 프로필 정보 자동 입력
                if (profileData) {
                    // 기본 정보 탭의 필드들에 자동 입력
                    if (profileData.name) {
                        const profileNameField = document.getElementById('profile-name');
                        if (profileNameField && !profileNameField.value) {
                            profileNameField.value = profileData.name;
                            console.log('기본정보 이름 자동 입력:', profileData.name);
                        }
                    }
                    
                    if (profileData.email) {
                        const profileEmailField = document.getElementById('profile-email');
                        if (profileEmailField && !profileEmailField.value) {
                            profileEmailField.value = profileData.email;
                            console.log('기본정보 이메일 자동 입력:', profileData.email);
                        }
                    }
                    
                    if (profileData.phone) {
                        const profilePhoneField = document.getElementById('profile-phone');
                        if (profilePhoneField && !profilePhoneField.value) {
                            profilePhoneField.value = profileData.phone;
                            console.log('기본정보 전화번호 자동 입력:', profileData.phone);
                        }
                    }
                    
                    // 저장된 profile 데이터에서 성별, 생년월일 로드
                    if (profileData.profile) {
                        const profile = profileData.profile;
                        
                        if (profile.gender) {
                            const genderField = document.getElementById('profile-gender');
                            if (genderField && !genderField.value) {
                                genderField.value = profile.gender;
                                console.log('기본정보 성별 자동 입력:', profile.gender);
                            }
                        }
                        
                        if (profile.birthdate) {
                            const birthdateField = document.getElementById('profile-birthdate');
                            if (birthdateField && !birthdateField.value) {
                                birthdateField.value = profile.birthdate;
                                console.log('기본정보 생년월일 자동 입력:', profile.birthdate);
                            }
                        }
                    }
                    
                    // 기존 필드들도 유지 (하위 호환성)
                    if (profileData.name) {
                        const nameField = document.getElementById('full-name');
                        if (nameField && !nameField.value) nameField.value = profileData.name;
                    }
                    
                    if (profileData.phone) {
                        const phoneField = document.getElementById('phone');
                        if (phoneField && !phoneField.value) phoneField.value = profileData.phone;
                    }
                    
                    if (profileData.email) {
                        const emailField = document.getElementById('email');
                        if (emailField && !emailField.value) emailField.value = profileData.email;
                    }
                    
                    // 주소 정보 (최신 주문에서 자동 입력)
                    const address = profileData.address || profileData.lastUsedAddress;
                    console.log('🔍 프로필 페이지 주소 정보 로드:');
                    console.log('- address 객체:', address);
                    console.log('- address.postal:', address?.postal);
                    console.log('- address.postalCode:', address?.postalCode);
                    
                    if (address) {
                        const postalField = document.getElementById('postal-code');
                        const prefectureField = document.getElementById('prefecture');
                        const cityField = document.getElementById('city');
                        const address1Field = document.getElementById('address1');
                        const address2Field = document.getElementById('address2');
                        
                        if (postalField && !postalField.value) {
                            if (address.postal) {
                                postalField.value = address.postal;
                                console.log('✅ 우편번호 로드 (postal):', address.postal);
                            } else if (address.postalCode) {
                                postalField.value = address.postalCode;
                                console.log('✅ 우편번호 로드 (postalCode):', address.postalCode);
                            }
                        } else if (postalField && postalField.value) {
                            console.log('⚠️ 우편번호 필드에 이미 값이 있음:', postalField.value);
                        } else if (!postalField) {
                            console.log('❌ 우편번호 필드를 찾을 수 없음');
                        }
                        if (prefectureField && !prefectureField.value && address.prefecture) prefectureField.value = address.prefecture;
                        if (cityField && !cityField.value && address.city) cityField.value = address.city;
                        if (address1Field && !address1Field.value && address.address1) address1Field.value = address.address1;
                        if (address2Field && !address2Field.value && address.address2) address2Field.value = address.address2;
                    } else {
                        console.log('⚠️ 저장된 주소 정보가 없음');
                    }
                    
                    // 모바일에서 우편번호 로드 실패 시 재시도
                    if (isMobile && address) {
                        console.log('📱 모바일에서 우편번호 재시도 (2초 후)');
                        setTimeout(() => {
                            const postalField = document.getElementById('postal-code');
                            if (postalField && !postalField.value) {
                                if (address.postal) {
                                    postalField.value = address.postal;
                                    console.log('📱 모바일 우편번호 재시도 성공 (postal):', address.postal);
                                } else if (address.postalCode) {
                                    postalField.value = address.postalCode;
                                    console.log('📱 모바일 우편번호 재시도 성공 (postalCode):', address.postalCode);
                                }
                            }
                        }, 2000);
                    }
                    
                    console.log('프로필 정보 자동 입력 완료');
                    
                    // 사용자에게 알림
                    const alertDiv = document.getElementById('save-alert');
                    if (alertDiv) {
                        alertDiv.className = 'alert alert-info japanese-text';
                        alertDiv.innerHTML = '<i class="fas fa-info-circle me-2"></i>最新の注文情報からプロフィールを自動入力しました。';
                        alertDiv.classList.remove('d-none');
                        
                        // 5초 후 자동 숨김
            setTimeout(() => {
                            alertDiv.classList.add('d-none');
                        }, 5000);
                    }
                } else {
                    console.log('저장된 프로필 정보가 없습니다');
                }
                
            } catch (error) {
                console.error('프로필 정보 로드 오류:', error);
            }
        }
        
        // 프로필 헤더 정보 로드 함수
        async function loadProfileHeader() {
            try {
                console.log('프로필 헤더 정보 로드 시작');
                
                let userData = null;
                let userPoints = 0;
                
                // 1. Firebase에서 로드 시도 (안전한 방식)
                try {
                    if (typeof window.FirebaseService !== 'undefined' && 
                        window.FirebaseService.isFirebaseAvailable() && 
                        typeof firebase !== 'undefined' && 
                        firebase.app && 
                        firebase.auth && 
                        firebase.firestore) {
                        
                        let user = firebase.auth().currentUser;
                        
                        // Firebase Auth만 사용
                        if (!user) {
                            console.log('Firebase Auth currentUser가 null - 로그인 필요');
                        }
                        
                        if (user && user.email) {
                            // 이메일을 문서 ID로 사용
                            let userDoc = await firebase.firestore().collection('users').doc(user.email).get();
                            
                            if (userDoc.exists) {
                                const docData = userDoc.data();
                                userData = {
                                    name: docData.name || user.displayName || user.email.split('@')[0],
                                    email: user.email,
                                    points: docData.points || 0
                                };
                                userPoints = userData.points;
                                console.log('Firebase에서 사용자 정보 로드 성공:', userData);
                            } else {
                                // 문서가 없는 경우 기본 정보로 생성
                                userData = {
                                    name: user.displayName || user.email.split('@')[0],
                                    email: user.email,
                                    points: 0
                                };
                                console.log('Firebase 사용자 문서 없음, 기본 정보 사용:', userData);
                            }
                        }
                    } else {
                        console.log('Firebase가 초기화되지 않았거나 사용할 수 없음');
                    }
                } catch (firebaseError) {
                    console.warn('Firebase 사용자 정보 로드 실패:', firebaseError);
                }
                
                // 2. Firebase 전용
                if (!userData) {
                    console.log('⚠️ Firebase에서 사용자 정보를 찾을 수 없음');
                }
                
                // 3. 프로필 헤더 업데이트
                if (userData) {
                    const displayNameEl = document.getElementById('profile-display-name');
                    const displayEmailEl = document.getElementById('profile-display-email');
                    
                    // 중복 제거됨 - updateProfileHeader 함수 사용
                    console.log('프로필 헤더 업데이트 완료 (중복 제거됨)');
                } else {
                    console.log('사용자 데이터를 찾을 수 없음 - 기본 정보 표시');
                    // 기본 정보 표시
                    const displayNameEl = document.getElementById('profile-display-name');
                    const displayEmailEl = document.getElementById('profile-display-email');
                    
                    if (displayNameEl) {
                        displayNameEl.textContent = 'ゲ스트';
                    }
                    
                    if (displayEmailEl) {
                        displayEmailEl.textContent = 'Loading...';
                    }
                }
                
                
                // 5. 프로필 사진 로드 (Firebase에서)
                await loadProfilePhotoFromFirebase();
                
            } catch (error) {
                console.error('프로필 헤더 로드 오류:', error);
                // 에러가 발생해도 기본 정보는 표시
                const displayNameEl = document.getElementById('profile-display-name');
                const displayEmailEl = document.getElementById('profile-display-email');
                
                if (displayNameEl) {
                    displayNameEl.textContent = 'ゲ스트';
                }
                
                if (displayEmailEl) {
                    displayEmailEl.textContent = 'guest@example.com';
                }
            }
        }
        

        
        // 주문 이력 로드 함수 초기화 (병렬 처리 최적화)
        async function initializeProfile() {
            try {
                console.log('프로필 페이지 초기화 시작');
                
                // Firebase 사용자 ID 즉시 확인
                let userId = null;
                try {
                    if (typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) {
                        const firebaseUser = firebase.auth().currentUser;
                        userId = firebaseUser.uid;
                        console.log('Firebase 사용자 ID:', userId);
                    }
                } catch (firebaseError) {
                    console.warn('Firebase 사용자 확인 실패:', firebaseError);
                }
                
                // 병렬로 모든 작업 실행 (순차 실행 → 병렬 실행)
                const initPromises = [
                    loadProfileHeader(),
                    loadProfilePhotoFromFirebase(),
                    loadSavedProfileInfo()
                ];
                
                // 주문 이력 로드 추가
                if (userId) {
                    console.log('주문 이력 로드 시작:', userId);
                    initPromises.push(loadOrderHistory(userId));
                } else {
                    console.log('로그인 상태 불명 - 모든 주문 표시');
                    initPromises.push(loadOrderHistory('ALL_ORDERS'));
                }
                
                // 모든 작업을 병렬로 실행
                await Promise.allSettled(initPromises);
                
                console.log('프로필 페이지 초기화 완료');
                
            } catch (error) {
                console.error('프로필 초기화 오류:', error);
                // 에러가 발생해도 기본 정보는 표시
                try {
                    await loadProfileHeader();
                } catch (headerError) {
                    console.error('프로필 헤더 로드 실패:', headerError);
                }
            }
        }
        
        // 주문 상태 텍스트 변환 (주문 관리 페이지와 동일)
        function getStatusText(status) {
            const statusMap = {
                'pending': '処理待ち',
                'pending_payment': '支払い待ち',
                'processing': '処理中',
                'shipping': '配送中',
                'completed': '完了',
                'cancelled': 'キャンセル'
            };
            return statusMap[status] || status;
        }

        // 주문 상태별 CSS 클래스 반환
        function getStatusClass(status) {
            const statusClassMap = {
                'pending': 'status-pending',
                'pending_payment': 'status-pending_payment',
                'processing': 'status-processing',
                'shipping': 'status-shipping',
                'completed': 'status-completed',
                'cancelled': 'status-cancelled'
            };
            return statusClassMap[status] || 'status-default';
        }

        // 영수증 미리보기 모달 표시
        function downloadReceipt(orderId, orderData) {
            try {
                console.log('영수증 미리보기 시작:', orderId, orderData);
                
                if (!orderData) {
                    console.error('주문 데이터가 없습니다:', orderId);
                    alert('주문 데이터를 찾을 수 없습니다.');
                    return;
                }
                
                // 영수증 데이터 생성
                const receiptData = generateReceiptData(orderData);
                console.log('영수증 데이터 생성 완료:', receiptData);
                
                // 영수증 미리보기 모달 표시
                showReceiptPreviewModal(receiptData);
                
            } catch (error) {
                console.error('영수증 미리보기 실패:', error);
                alert('영수증 미리보기 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 주문 ID로 영수증 다운로드 (전역 변수에서 주문 데이터 찾기)
        function downloadReceiptFromOrder(orderId) {
            try {
                console.log('영수증 다운로드 시작 (주문 ID):', orderId);
                
                // 전역 변수에서 주문 데이터 찾기
                const orderData = window[`orderData_${orderId}`];
                
                if (!orderData) {
                    console.error('주문 데이터를 찾을 수 없습니다:', orderId);
                    console.log('사용 가능한 전역 변수들:', Object.keys(window).filter(key => key.startsWith('orderData_')));
                    alert('주문 데이터를 찾을 수 없습니다. 페이지를 새로고침해주세요.');
                    return;
                }
                
                console.log('주문 데이터 찾음:', orderData);
                
                // 영수증 미리보기 모달 표시
                downloadReceipt(orderId, orderData);
                
            } catch (error) {
                console.error('영수증 다운로드 실패:', error);
                alert('영수증 다운로드 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 영수증 미리보기 모달 표시 함수
        function showReceiptPreviewModal(receiptData) {
            try {
                console.log('영수증 미리보기 모달 시작:', receiptData);
                
                // 영수증 HTML 생성
                const receiptHTML = generateReceiptHTML(receiptData);
                console.log('영수증 HTML 생성 완료, 길이:', receiptHTML.length);
                
                // 기존 모달 제거
                const existingModal = document.getElementById('receiptPreviewModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // 모달 HTML 생성
                const modalHTML = `
                    <div class="modal fade" id="receiptPreviewModal" tabindex="-1" aria-labelledby="receiptPreviewModalLabel" aria-hidden="true" style="z-index: 1055;">
                        <div class="modal-dialog modal-xl modal-dialog-scrollable">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title japanese-heading" id="receiptPreviewModalLabel">
                                        <i class="fas fa-receipt me-2"></i>領収書 - ${receiptData.orderId}
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body p-0" style="max-height: 80vh; overflow-y: auto; text-align: center;">
                                    <div id="receipt-content" style="background: white; padding: 10px; font-family: 'Noto Sans JP', sans-serif; text-align: center; margin: 0 auto;">
                                        ${receiptHTML}
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary japanese-text" data-bs-dismiss="modal">
                                        <i class="fas fa-times me-1"></i>閉じる
                                    </button>
                                    <button type="button" class="btn btn-dark japanese-text" onclick="downloadReceiptPDF('${receiptData.orderId}')">
                                        <i class="fas fa-download me-1"></i>PDFダウンロード
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // 모달 HTML 추가
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                console.log('모달 HTML 추가 완료');
                
                // 모달 표시
                const modalElement = document.getElementById('receiptPreviewModal');
                if (modalElement) {
                    const modal = new bootstrap.Modal(modalElement, {
                        backdrop: true,
                        keyboard: true,
                        focus: true
                    });
                    
                    // 모달 이벤트 리스너 추가
                    modalElement.addEventListener('shown.bs.modal', function () {
                        console.log('모달 표시 완료');
                    });
                    
                    modalElement.addEventListener('hidden.bs.modal', function () {
                        console.log('모달 숨김 완료');
                        modalElement.remove();
                    });
                    
                    // 모달 표시
                    modal.show();
                    console.log('모달 표시 명령 완료');
                } else {
                    console.error('모달 요소를 찾을 수 없습니다');
                }
                
            } catch (error) {
                console.error('영수증 미리보기 모달 오류:', error);
                alert('영수증 미리보기 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 모달에서 PDF 다운로드 버튼 클릭 시 호출되는 함수
        function downloadReceiptPDF(orderId) {
            try {
                console.log('모달에서 PDF 다운로드 시작:', orderId);
                
                // html2pdf 라이브러리 확인
                if (typeof html2pdf === 'undefined') {
                    console.log('html2pdf 라이브러리 로드 중...');
                    
                    // html2pdf 라이브러리 동적 로드
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
                    script.onload = () => {
                        console.log('html2pdf 라이브러리 로드 완료');
                        // 약간의 지연 후 실행
                        setTimeout(() => {
                            executePDFDownload(orderId);
                        }, 200);
                    };
                    script.onerror = () => {
                        console.error('html2pdf 라이브러리 로드 실패');
                        alert('PDF 생성 라이브러리를 로드할 수 없습니다. 인쇄 기능을 사용해주세요.');
                    };
                    document.head.appendChild(script);
                } else {
                    console.log('html2pdf 라이브러리 이미 로드됨');
                    executePDFDownload(orderId);
                }
                
            } catch (error) {
                console.error('PDF 다운로드 실패:', error);
                alert('PDF 다운로드 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 실제 PDF 다운로드 실행 함수
        function executePDFDownload(orderId) {
            try {
                console.log('PDF 다운로드 실행:', orderId);
                
                // 모달 내의 영수증 내용 확인
                const receiptContent = document.getElementById('receipt-content');
                if (!receiptContent) {
                    console.error('영수증 내용을 찾을 수 없습니다');
                    alert('영수증 내용을 찾을 수 없습니다.');
                    return;
                }
                
                console.log('모달의 receipt-content 요소 확인됨');
                console.log('영수증 내용 길이:', receiptContent.innerHTML.length);
                
                // 모달의 실제 렌더링된 요소를 직접 사용하여 PDF 생성
                createReceiptPDF('', orderId); // HTML은 모달에서 직접 가져옴
                
            } catch (error) {
                console.error('PDF 다운로드 실행 실패:', error);
                alert('PDF 다운로드 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // PDF 생성 함수
        function generateReceiptPDF(receiptHTML, orderId) {
            try {
                console.log('PDF 생성 함수 호출:', orderId);
                
                // html2pdf 라이브러리가 로드되어 있는지 확인
                if (typeof html2pdf === 'undefined') {
                    console.log('html2pdf 라이브러리 로드 중...');
                    
                    // html2pdf 라이브러리 동적 로드
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
                    script.onload = () => {
                        console.log('html2pdf 라이브러리 로드 완료');
                        // 약간의 지연 후 실행 (라이브러리 초기화 대기)
                        setTimeout(() => {
                            createReceiptPDF(receiptHTML, orderId);
                        }, 100);
                    };
                    script.onerror = () => {
                        console.error('html2pdf 라이브러리 로드 실패');
                        alert('PDF 생성 라이브러리를 로드할 수 없습니다. 인쇄 기능을 사용해주세요.');
                    };
                    document.head.appendChild(script);
                } else {
                    console.log('html2pdf 라이브러리 이미 로드됨');
                    createReceiptPDF(receiptHTML, orderId);
                }
            } catch (error) {
                console.error('PDF 생성 실패:', error);
                alert('PDF 생성 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 인쇄 대화상자 열기 함수
        function openPrintDialog(receiptHTML) {
            try {
                console.log('인쇄 대화상자 열기');
                
                // 새 창 열기
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                if (printWindow) {
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>領収書</title>
                            <style>
                                body { margin: 0; padding: 0; }
                                @media print {
                                    body { margin: 0; padding: 0; }
                                    @page { size: A4; margin: 8mm; }
                                }
                            </style>
                        </head>
                        <body>
                            ${receiptHTML}
                        </body>
                        </html>
                    `);
                    
                    printWindow.document.close();
                    
                    // 인쇄 대화상자 열기
                    setTimeout(() => {
                        printWindow.print();
                        printWindow.close();
                    }, 500);
                } else {
                    alert('팝업이 차단되었습니다. 팝업 차단을 해제하고 다시 시도해주세요.');
                }
            } catch (error) {
                console.error('인쇄 대화상자 열기 실패:', error);
                alert('인쇄 대화상자를 열 수 없습니다.');
            }
        }

        // 실제 PDF 생성 함수
        function createReceiptPDF(receiptHTML, orderId) {
            try {
                console.log('PDF 생성 시작:', orderId);
                console.log('영수증 HTML 길이:', receiptHTML.length);
                
                // html2pdf 라이브러리 재확인
                if (typeof html2pdf === 'undefined') {
                    console.error('html2pdf 라이브러리가 로드되지 않았습니다');
                    alert('PDF 생성 라이브러리가 아직 로드되지 않았습니다. 잠시 후 다시 시도해주세요.');
                    return;
                }
                
                console.log('html2pdf 라이브러리 확인됨');
                
                // 모달에서 실제 렌더링된 요소를 사용
                const receiptContent = document.getElementById('receipt-content');
                let sourceElement;
                
                if (receiptContent && receiptContent.innerHTML.trim() !== '') {
                    console.log('모달의 receipt-content 사용');
                    console.log('모달 내용 확인:', receiptContent.innerHTML.substring(0, 200) + '...');
                    
                    // PDF 생성을 위해 스타일 강제 적용
                    receiptContent.style.textAlign = 'center';
                    receiptContent.style.margin = '0 auto';
                    receiptContent.style.width = '185mm';
                    receiptContent.style.maxWidth = '185mm';
                    
                    sourceElement = receiptContent;
                } else {
                    console.log('임시 div 생성');
                    // 임시 div 생성
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = receiptHTML;
                    tempDiv.style.position = 'absolute';
                    tempDiv.style.left = '-9999px';
                    tempDiv.style.top = '-9999px';
                    tempDiv.style.width = '185mm'; // 190mm → 185mm
                    tempDiv.style.maxWidth = '185mm';
                    tempDiv.style.background = 'white';
                    tempDiv.style.overflow = 'visible';
                    tempDiv.style.zIndex = '-1';
                    tempDiv.style.textAlign = 'center'; // 가운데 정렬
                    tempDiv.style.margin = '0 auto'; // 가운데 정렬
                    document.body.appendChild(tempDiv);
                    sourceElement = tempDiv;
                }
                
                // 소스 요소의 내용 확인
                console.log('소스 요소 내용 길이:', sourceElement.innerHTML.length);
                console.log('소스 요소 내용 미리보기:', sourceElement.innerHTML.substring(0, 300) + '...');
                
                console.log('PDF 생성 옵션 설정 중...');
                
                const opt = {
                    margin: [15, 15, 15, 15], /* 좌우 마진 완전 균등으로 가운데 정렬 */
                    filename: `領収書_${orderId}.pdf`,
                    image: { type: 'jpeg', quality: 0.95 },
                    html2canvas: { 
                        scale: 1.2, // 스케일 조정 (1.5 → 1.2)
                        useCORS: true,
                        letterRendering: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff',
                        logging: true,
                        width: 680, // 700 → 680 (완전 가운데 정렬을 위한 폭 조정)
                        height: 1000, // 1123 → 1000 (한 페이지에 맞춤)
                        scrollX: 0,
                        scrollY: 0,
                        windowWidth: 680,
                        windowHeight: 1000
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait',
                        compress: true,
                        precision: 2
                    },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };
                
                console.log('html2pdf 실행 중...');
                html2pdf().set(opt).from(sourceElement).save().then(() => {
                    console.log('PDF 생성 완료');
                    // 임시 div가 생성된 경우에만 제거
                    if (sourceElement.parentNode && sourceElement.parentNode === document.body) {
                        document.body.removeChild(sourceElement);
                    }
                }).catch((error) => {
                    console.error('PDF 생성 실패:', error);
                    console.log('PDF 생성 실패, 인쇄 대안 제공');
                    if (confirm('PDF 생성에 실패했습니다. 인쇄 대화상자를 열까요?')) {
                        openPrintDialog(sourceElement.innerHTML);
                    }
                    // 임시 div가 생성된 경우에만 제거
                    if (sourceElement.parentNode && sourceElement.parentNode === document.body) {
                        document.body.removeChild(sourceElement);
                    }
                });
                
            } catch (error) {
                console.error('PDF 생성 실패:', error);
                alert('PDF 생성 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 영수증 데이터 생성
        function generateReceiptData(orderData) {
            const orderDate = orderData.orderDate?.seconds ? 
                new Date(orderData.orderDate.seconds * 1000) : 
                new Date(orderData.orderDate || orderData.createdAt);
            
            const subtotal = orderData.subtotal || orderData.originalAmount || 0;
            const shippingFee = orderData.shippingFee || 0;
            const usedPoints = orderData.usedPoints || orderData.pointDiscount || 0;
            const totalAmount = orderData.totalAmount || 0;
            const earnedPoints = orderData.earnedPoints || 0;
            
            // 세금 계산 (상품금액 + 배송비에 10% 소비세)
            const totalBeforeTax = subtotal + shippingFee;
            const taxAmount = Math.floor(totalBeforeTax * 0.1); // 10% 소비세
            const totalWithTax = totalBeforeTax + taxAmount;
            
            // 영수증 번호 생성 (날짜 + 주문번호)
            const today = new Date();
            const dateStr = today.getFullYear().toString() + 
                           (today.getMonth() + 1).toString().padStart(2, '0') + 
                           today.getDate().toString().padStart(2, '0');
            const receiptNumber = `RCP-${dateStr}-${orderData.id || orderData.orderId}`;
            
            return {
                orderId: orderData.id || orderData.orderId,
                receiptNumber: receiptNumber,
                orderDate: orderDate.toLocaleString('ja-JP'),
                customerName: orderData.shipping?.name || orderData.customer?.name || 'N/A',
                customerEmail: orderData.customerEmail || orderData.userEmail || 'N/A',
                items: orderData.items || [],
                subtotal: subtotal,
                shippingFee: shippingFee,
                usedPoints: usedPoints,
                totalAmount: totalAmount,
                earnedPoints: earnedPoints,
                shippingAddress: orderData.shipping || orderData.shippingAddress || {},
                paymentMethod: orderData.paymentMethod || (orderData.payment?.method || 'N/A'),
                // 세금 정보 추가
                totalBeforeTax: totalBeforeTax,
                taxAmount: taxAmount,
                totalWithTax: totalWithTax
            };
        }

        // 새로운 영수증 HTML 생성 (이미지 기반)
        function generateReceiptHTML(receiptData) {
            try {
                console.log('새로운 영수증 HTML 생성 시작:', receiptData);
                
                const paymentMethodText = receiptData.paymentMethod === 'card' ? 'クレジットカード' : 
                                        receiptData.paymentMethod === 'bank-transfer' ? '銀行振込' : 
                                        receiptData.paymentMethod;
                
                const html = `
                <div class="receipt-container">
                    <style>
                        .receipt-container {
                            font-family: 'Noto Sans JP', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif !important;
                            width: 185mm; /* 190mm → 185mm (완전 가운데 정렬을 위한 폭 조정) */
                            min-height: 297mm;
                            margin: 0 auto; /* 가운데 정렬 */
                            padding: 8mm;
                            background: white;
                            color: #333;
                            box-sizing: border-box;
                            position: relative;
                            display: block;
                            overflow: visible;
                            page-break-inside: avoid;
                            font-size: 0.81em; /* 19% 줄임 (5% + 5% + 10%) */
                            text-align: center; /* 전체 내용 가운데 정렬 */
                        }
                        
                        .receipt-container * {
                            font-family: 'Noto Sans JP', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif !important;
                            line-height: 1.2 !important; /* 행간 줄임 */
                        }
                        
                        .receipt-header {
                            text-align: center;
                            margin-bottom: 10px; /* 15px → 10px */
                            border-bottom: 2px solid #333;
                            padding-bottom: 8px; /* 10px → 8px */
                            font-size: 1.05em; /* 헤더는 원래 크기 유지 */
                        }
                        
                        .company-logo {
                            margin-bottom: 10px;
                        }
                        
                        .company-logo img {
                            max-height: 75px; /* 50px → 75px (50% 증가) */
                            width: auto;
                        }
                        
                        .receipt-title {
                            font-size: 24px;
                            font-weight: bold;
                            margin: 10px 0;
                        }
                        
                        .receipt-info {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 15px;
                            font-size: 10px;
                        }
                        
                        .receipt-info-left {
                            text-align: left;
                        }
                        
                        .receipt-info-right {
                            text-align: right;
                        }
                        
                        .recipient-section {
                            text-align: center; /* 가운데 정렬 */
                            margin: 15px 0;
                            font-size: 16px;
                            font-weight: bold;
                        }
                        
                        .amount-section {
                            text-align: center; /* 가운데 정렬 */
                            margin: 15px 0;
                            font-size: 18px;
                            font-weight: bold;
                        }
                        
                        .detail-section {
                            margin-bottom: 10px; /* 15px → 10px */
                        }
                        
                        .detail-section.two-column {
                            display: flex;
                            gap: 15px; /* 20px → 15px */
                        }
                        
                        .detail-section.two-column .column {
                            flex: 1;
                            min-width: 0;
                        }
                        
                        .detail-title {
                            font-weight: bold;
                            margin-bottom: 5px; /* 8px → 5px */
                            padding: 3px; /* 5px → 3px */
                            background-color: #f5f5f5;
                            border-left: 3px solid #333;
                            font-size: 12px;
                        }
                        
                        .detail-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 2px; /* 3px → 2px */
                            padding: 1px 0; /* 2px → 1px */
                            font-size: 10px;
                        }
                        
                        .items-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 8px auto; /* 8px 0 → 8px auto (가운데 정렬) */
                            font-size: 1.05em; /* 상품명세는 원래 크기 유지 */
                        }
                        
                        .items-table th,
                        .items-table td {
                            border: 1px solid #ddd;
                            padding: 3px; /* 4px → 3px */
                            text-align: left;
                        }
                        
                        .items-table th {
                            background-color: #f5f5f5;
                            font-weight: bold;
                        }
                        
                        .total-section {
                            margin: 15px 0;
                        }
                        
                        .total-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 5px;
                            padding: 3px 0;
                            font-size: 10px;
                        }
                        
                        .total-final {
                            font-weight: bold;
                            font-size: 12px;
                            border-top: 2px solid #333;
                            padding-top: 5px;
                            margin-top: 5px;
                        }
                        
                        .payment-breakdown {
                            background-color: #f8f9fa;
                            padding: 8px;
                            margin: 10px 0;
                            border-radius: 3px;
                        }
                        
                        .tax-breakdown {
                            font-size: 9px;
                            color: #666;
                            margin-top: 5px;
                        }
                        
                        .disclaimer {
                            font-size: 8px;
                            color: #666;
                            margin-top: 10px;
                            text-align: center; /* right → center */
                        }
                        
                        .shipping-info {
                            background-color: #f8f9fa;
                            padding: 8px;
                            margin: 10px 0;
                            border-radius: 3px;
                        }
                        
                        @media print {
                            .receipt-container {
                                margin: 0 auto !important; /* 가운데 정렬 유지 */
                                padding: 8mm;
                                width: 185mm !important; /* 190mm → 185mm (완전 가운데 정렬을 위한 폭 조정) */
                                min-height: 297mm;
                                page-break-inside: avoid;
                                background: white !important;
                                color: black !important;
                                text-align: center !important; /* 가운데 정렬 유지 */
                            }
                            
                            .receipt-header,
                            .detail-section,
                            .items-table {
                                page-break-inside: avoid;
                            }
                        }
                        
                        @page {
                            size: A4;
                            margin: 8mm;
                        }
                    </style>
                    
                    <div class="receipt-header">
                        <div class="company-logo">
                            <img src="assets/img/logo.png" alt="Aether Store" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div style="display: none; font-size: 24px; font-weight: bold; color: #333;">Aether Store</div>
                        </div>
                        <div class="receipt-title">領収書</div>
                        <div class="receipt-info">
                            <div class="receipt-info-left">
                                <strong>領収書番号:</strong> ${receiptData.receiptNumber}<br>
                                <strong>発行日:</strong> ${new Date().toLocaleDateString('ja-JP')}
                            </div>
                            <div class="receipt-info-right">
                                <strong>注文番号:</strong> ${receiptData.orderId}<br>
                                <strong>注文日:</strong> ${receiptData.orderDate}
                            </div>
                        </div>
                    </div>
                    
                    <div class="recipient-section">
                        ${receiptData.customerName} 様
                    </div>
                    
                    <div class="amount-section">
                        <strong>${receiptData.totalWithTax.toLocaleString()}円領収しました</strong>
                    </div>
                    
                    <div class="detail-section two-column">
                        <div class="column">
                            <div class="detail-title">利用情報</div>
                            <div class="detail-row">
                                <span>注文番号:</span>
                                <span>${receiptData.orderId}</span>
                            </div>
                            <div class="detail-row">
                                <span>注文日:</span>
                                <span>${receiptData.orderDate}</span>
                            </div>
                            <div class="detail-row">
                                <span>お支払い方法:</span>
                                <span>${paymentMethodText}</span>
                            </div>
                            <div class="detail-row">
                                <span>発送日:</span>
                                <span>${new Date().toLocaleDateString('ja-JP')}</span>
                            </div>
                        </div>
                        
                        <div class="column">
                            <div class="detail-title">領収者情報</div>
                            <div class="detail-row">
                                <span>領収者:</span>
                                <span>株式会社JAYCOS</span>
                            </div>
                            <div class="detail-row">
                                <span>住所:</span>
                                <span>〒169-0072 東京都新宿区大久保2丁目21-10 ジュネス大久保 102号</span>
                            </div>
                            <div class="detail-row">
                                <span>電話番号:</span>
                                <span>03.3200.5547</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section two-column">
                        <div class="column">
                            <div class="detail-title">注文合計</div>
                            <div class="detail-row">
                                <span>商品小計:</span>
                                <span>¥${receiptData.subtotal.toLocaleString()}</span>
                            </div>
                            <div class="detail-row">
                                <span>配送料:</span>
                                <span>${receiptData.shippingFee === 0 ? '無料' : '¥' + receiptData.shippingFee.toLocaleString()}</span>
                            </div>
                            <div class="detail-row">
                                <span>小計:</span>
                                <span>¥${receiptData.totalBeforeTax.toLocaleString()}</span>
                            </div>
                            <div class="detail-row">
                                <span>消費税(10%):</span>
                                <span>¥${receiptData.taxAmount.toLocaleString()}</span>
                            </div>
                            <div class="detail-row total-final">
                                <span>総合計:</span>
                                <span>¥${receiptData.totalWithTax.toLocaleString()}</span>
                            </div>
                            <div class="detail-row">
                                <span>支払い金額:</span>
                                <span>¥${(receiptData.totalWithTax - receiptData.usedPoints).toLocaleString()}</span>
                            </div>
                        </div>
                        
                        <div class="column">
                            <div class="detail-title">配送情報</div>
                            <div class="detail-row">
                                <span>配送方法:</span>
                                <span>宅配便</span>
                            </div>
                            <div class="detail-row">
                                <span>お届け先:</span>
                                <span>${[
                                    receiptData.shippingAddress.postal || '',
                                    receiptData.shippingAddress.prefecture || '',
                                    receiptData.shippingAddress.city || '',
                                    receiptData.shippingAddress.address1 || '',
                                    receiptData.shippingAddress.address2 || ''
                                ].filter(part => part.trim() !== '').join(' ')}</span>
                            </div>
                        </div>
                    </div>
                    
                    ${receiptData.usedPoints > 0 ? `
                    <div class="payment-breakdown">
                        <div class="detail-title">支払い内訳</div>
                        <div class="detail-row">
                            <span>ポイント利用:</span>
                            <span>¥${receiptData.usedPoints.toLocaleString()}</span>
                        </div>
                        <div class="detail-row">
                            <span>${paymentMethodText}:</span>
                            <span>¥${(receiptData.totalWithTax - receiptData.usedPoints).toLocaleString()}</span>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="disclaimer">
                        ※表示金額は全て税込です<br>
                        ※支払い金額は総合計からポイントを除いた金額です
                    </div>
                    
                    
                    <div class="detail-section">
                        <div class="detail-title">商品明細</div>
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th>No.</th>
                                    <th>商品名</th>
                                    <th>数量</th>
                                    <th>単価(税込)</th>
                                    <th>税率</th>
                                    <th>小計(税込)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${receiptData.items.map((item, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${item.name}</td>
                                        <td>${item.quantity}</td>
                                        <td>¥${item.price.toLocaleString()}</td>
                                        <td>10%</td>
                                        <td>¥${(item.price * item.quantity).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="disclaimer">
                            ※表示金額は全て税込です
                        </div>
                    </div>
                </div>
                `;
                
                console.log('새로운 영수증 HTML 생성 완료, 길이:', html.length);
                return html;
                
            } catch (error) {
                console.error('영수증 HTML 생성 오류:', error);
                return '<div class="alert alert-danger">영수증 생성 중 오류가 발생했습니다.</div>';
            }
        }

        // 날짜 변환 함수들 (간단한 형식)
        function convertToJapaneseDate(dateString) {
            if (!dateString) return '';
            
            // ISO 형식 (YYYY-MM-DD)을 YYYY/MM/DD 형식으로 변환
            if (dateString.includes('-')) {
                return dateString.replace(/-/g, '/');
            }
            
            return dateString; // 이미 올바른 형식이면 그대로 반환
        }
        
        function convertFromJapaneseDate(japaneseDateString) {
            if (!japaneseDateString) return '';
            
            // YYYY/MM/DD 형식을 ISO 형식으로 변환
            if (japaneseDateString.includes('/')) {
                return japaneseDateString.replace(/\//g, '-');
            }
            
            return japaneseDateString; // 변환 실패 시 원본 반환
        }
        
        // 프로필 사진 업로드 관련 함수들
        let isUploading = false;
        
        // 프로필 사진 업로드 옵션 열기
        function openPhotoUpload() {
            const options = document.getElementById('photo-upload-options');
            if (options.style.display === 'none') {
                options.style.display = 'block';
                // 3초 후 자동으로 숨기기
                setTimeout(() => {
                    options.style.display = 'none';
                }, 3000);
            } else {
                options.style.display = 'none';
            }
        }
        
        // 갤러리에서 사진 선택
        function selectPhotoFromGallery() {
            const input = document.getElementById('profile-photo-input');
            input.accept = 'image/*';
            input.click();
            document.getElementById('photo-upload-options').style.display = 'none';
        }
        
        // 카메라로 사진 촬영
        function takePhotoWithCamera() {
            const input = document.getElementById('profile-photo-input');
            input.accept = 'image/*';
            input.capture = 'environment'; // 후면 카메라 우선
            input.click();
            document.getElementById('photo-upload-options').style.display = 'none';
        }
        
        // 드래그앤드롭 이벤트 설정
        function setupDragAndDrop() {
            const avatarContainer = document.getElementById('profile-avatar-container');
            
            // 드래그 오버 이벤트
            avatarContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.add('drag-over');
            });
            
            // 드래그 리브 이벤트
            avatarContainer.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('drag-over');
            });
            
            // 드롭 이벤트
            avatarContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleProfilePhotoUpload({ target: { files: files } });
                }
            });
        }
        
        // Firebase Storage 초기화 대기
        async function waitForFirebaseStorage() {
            let attempts = 0;
            const maxAttempts = 50;
            
            while (attempts < maxAttempts) {
                if (firebase && firebase.storage) {
                    console.log('Firebase Storage 사용 가능');
                    return true;
                }
                console.log(`Firebase Storage 초기화 대기 중... (${attempts + 1}/${maxAttempts})`);
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            throw new Error('Firebase Storage 초기화 시간 초과');
        }
        
        // 프로필 사진 업로드 처리
        async function handleProfilePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // 파일 크기 체크 (5MB 제한)
            if (file.size > 5 * 1024 * 1024) {
                alert('ファイルサイズが大きすぎます。5MB以下の画像を選択してください。');
                return;
            }
            
            // 파일 타입 체크
            if (!file.type.startsWith('image/')) {
                alert('画像ファイルを選択してください。');
                return;
            }
            
            if (isUploading) return;
            isUploading = true;
            
            try {
                // Firebase Storage 초기화 대기
                await waitForFirebaseStorage();
                
                // 업로드 진행률 표시
                showUploadProgress();
                
                // Firebase Storage에 업로드
                const downloadURL = await uploadProfilePhotoToFirebase(file);
                
                // 프로필 사진 표시
                displayProfilePhoto(downloadURL);
                
                // Firebase Firestore에 URL 저장
                await saveProfilePhotoURL(downloadURL);
                
                console.log('プロフィール写真のアップロードが完了しました:', downloadURL);
                
            } catch (error) {
                console.error('プロフィール写真のアップロードに失敗しました:', error);
                alert('プロフィール写真のアップロードに失敗しました。もう一度お試しください。');
            } finally {
                isUploading = false;
                hideUploadProgress();
            }
        }
        
        // Firebase Storage에 프로필 사진 업로드
        async function uploadProfilePhotoToFirebase(file) {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                throw new Error('ユーザーがログインしていません');
            }
            
            // Firebase Storage는 이미 waitForFirebaseStorage()에서 확인됨
            
            // 파일명 생성 (사용자 ID + 타임스탬프)
            const timestamp = Date.now();
            const fileName = `profile-photos/${currentUser.uid}_${timestamp}.jpg`;
            
            // Firebase Storage 참조
            const storageRef = firebase.storage().ref(fileName);
            
            // 이미지 압축 및 업로드
            const compressedFile = await compressImage(file);
            
            // 업로드 실행
            const uploadTask = storageRef.put(compressedFile);
            
            // 업로드 진행률 모니터링
            return new Promise((resolve, reject) => {
                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        updateUploadProgress(progress);
                    },
                    (error) => {
                        reject(error);
                    },
                    async () => {
                        try {
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            resolve(downloadURL);
                        } catch (error) {
                            reject(error);
                        }
                    }
                );
            });
        }
        
        // 이미지 압축
        function compressImage(file) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    // 최대 크기 설정 (400x400)
                    const maxSize = 400;
                    let { width, height } = img;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height = (height * maxSize) / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = (width * maxSize) / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // 이미지 그리기
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // JPEG로 변환 (품질 0.8)
                    canvas.toBlob(resolve, 'image/jpeg', 0.8);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }
        
        // Firebase Firestore에 프로필 사진 URL 저장
        async function saveProfilePhotoURL(photoURL) {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) return;
            
            try {
                const userRef = firebase.firestore().collection('users').doc(currentUser.email);
                await userRef.update({
                    profilePhotoURL: photoURL,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('プロフィール写真URLをFirestoreに保存しました');
            } catch (error) {
                console.error('プロフィール写真URLの保存に失敗しました:', error);
                throw error;
            }
        }
        
        // 프로필 사진 표시
        function displayProfilePhoto(photoURL) {
            const photoImg = document.getElementById('profile-photo');
            const placeholder = document.getElementById('profile-photo-placeholder');
            
            if (photoURL) {
                photoImg.src = photoURL;
                photoImg.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                photoImg.style.display = 'none';
                placeholder.style.display = 'block';
            }
        }
        
        // Firebase에서 프로필 사진 로드
        async function loadProfilePhotoFromFirebase() {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) return;
            
            try {
                const userDoc = await firebase.firestore().collection('users').doc(currentUser.email).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    if (userData.profilePhotoURL) {
                        displayProfilePhoto(userData.profilePhotoURL);
                        console.log('プロフィール写真をFirebaseから読み込みました');
                    }
                }
            } catch (error) {
                console.error('プロフィール写真の読み込みに失敗しました:', error);
            }
        }
        
        // 업로드 진행률 표시
        function showUploadProgress() {
            const avatarContainer = document.getElementById('profile-avatar-container');
            const progressHTML = `
                <div class="upload-progress">
                    <div class="upload-progress-bar" id="upload-progress-bar"></div>
                </div>
            `;
            avatarContainer.insertAdjacentHTML('beforeend', progressHTML);
        }
        
        // 업로드 진행률 업데이트
        function updateUploadProgress(progress) {
            const progressBar = document.getElementById('upload-progress-bar');
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
        }
        
        // 업로드 진행률 숨기기
        function hideUploadProgress() {
            const progress = document.querySelector('.upload-progress');
            if (progress) {
                progress.remove();
            }
        }
        
        // 간단한 생년월일 입력 필드 초기화
        
        // 생년월일 입력 필드 초기화 함수
        function initializeDateInputs() {
            console.log('생년월일 입력 필드 초기화 시작');
            
            // 생년월일 입력 필드에 자동 포맷팅 추가
            const birthdateInputs = ['profile-birthdate', 'edit-birthdate'];
            
            birthdateInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    // 입력 시 자동으로 슬래시 추가
                    input.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/\D/g, ''); // 숫자만 남기기
                        
                        if (value.length >= 4) {
                            value = value.substring(0, 4) + '/' + value.substring(4);
                        }
                        if (value.length >= 7) {
                            value = value.substring(0, 7) + '/' + value.substring(7, 9);
                        }
                        
                        e.target.value = value;
                    });
                    
                    // 포커스 시 플레이스홀더 표시
                    input.addEventListener('focus', function() {
                        if (!this.value) {
                            this.placeholder = '年/月/日 (例: 1990/01/15)';
                        }
                    });
                    
                    console.log('생년월일 입력 필드 초기화 완료:', inputId);
                }
            });
            
            // 페이지 언어 설정 확인
            if (document.documentElement.lang !== 'ja') {
                document.documentElement.lang = 'ja';
                console.log('문서 언어를 일본어로 설정');
            }
        }
        
        // 중복된 DOMContentLoaded 이벤트 리스너 제거됨 - 아래의 통합된 이벤트 리스너 사용
        
        // 주문 데이터 관리 - Firebase 전용 시스템
        
        // 저장된 주문 데이터 분석 함수
        function analyzeStoredOrders() {
            console.log('Firebase 전용 시스템 - 주문 분석');
            console.log('주문 데이터는 Firebase에서 확인하세요');
            return [];
        }
        
        // 주문 데이터 수정 함수 - Firebase 전용 시스템
        
        // 강제 주문 표시 함수 (디버깅용)
        function showAllOrders() {
            try {
                console.log('모든 주문 표시 모드 시작');
                loadOrderHistory('ALL_ORDERS');
            } catch (error) {
                console.error('모든 주문 표시 오류:', error);
            }
        }
        
        // 프로필 편집 저장
        async function saveProfileEdit() {
            try {
                const profileData = {
                    name: document.getElementById('edit-name').value,
                    email: document.getElementById('edit-email').value,
                    phone: document.getElementById('edit-phone').value,
                    profile: {
                        birthdate: convertFromJapaneseDate(document.getElementById('edit-birthdate').value),
                        gender: document.getElementById('edit-gender').value
                    }
                };
                
                console.log('프로필 저장 시작:', profileData);
                
                let saveSuccess = false;
                
                // Firebase에 저장
                const user = firebase.auth && firebase.auth().currentUser;
                if (user) {
                    try {
                        await firebase.firestore().collection('users').doc(user.email).update({
                            name: profileData.name,
                            phone: profileData.phone,
                            profile: profileData.profile,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        console.log('Firebase 프로필 저장 성공');
                        saveSuccess = true;
                    } catch (firebaseError) {
                        console.warn('Firebase 저장 실패:', firebaseError);
                    }
                }
                
                // Firebase 전용 - localStorage 사용 안함
                
                // 결과 처리
                if (saveSuccess) {
                    showProfileEditAlert('プロフィールが正常に保存されました。', 'success');
                    
                    // 프로필 헤더 업데이트
                    setTimeout(async () => {
                        await loadProfileHeader();
                        // 모달 닫기
                        const modal = bootstrap.Modal.getInstance(document.getElementById('profileEditModal'));
                        if (modal) modal.hide();
                    }, 1500);
                } else {
                    showProfileEditAlert('プロフィール 保存に失敗しました。', 'danger');
                }
                
            } catch (error) {
                console.error('프로필 저장 오류:', error);
                showProfileEditAlert('エラーが発生しました。', 'danger');
            }
        }
        
        // 프로필 편집 알림 표시
        function showProfileEditAlert(message, type) {
            const alertDiv = document.getElementById('profile-edit-alert');
            alertDiv.className = `alert alert-${type} japanese-text`;
            alertDiv.textContent = message;
            alertDiv.classList.remove('d-none');
            
            // 3초 후 숨기기
            setTimeout(() => {
                alertDiv.classList.add('d-none');
            }, 3000);
        }
        
        // 패스워드 변경 모달 표시
        function showChangePassword() {
            // 필드 초기화
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-new-password').value = '';
            
            // 알림 숨기기
            const alertDiv = document.getElementById('password-alert');
            alertDiv.classList.add('d-none');
            
            // 모달 표시
            const modal = new bootstrap.Modal(document.getElementById('passwordModal'));
            modal.show();
        }
        
        // 패스워드 변경 실행
        async function changePassword() {
            try {
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-new-password').value;
                
                // 입력 검증
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showPasswordAlert('すべてのフィールドを入力してください。', 'danger');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showPasswordAlert('新しいパスワードが一致しません。', 'danger');
                    return;
                }
                
                if (newPassword.length < 8) {
                    showPasswordAlert('パスワードは8文字以上で入力してください。', 'danger');
                    return;
                }
                
                let changeSuccess = false;
                
                // Firebase 패스워드 변경
                const user = firebase.auth && firebase.auth().currentUser;
                if (user) {
                    try {
                        // 현재 패스워드 확인
                        const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
                        await user.reauthenticateWithCredential(credential);
                        
                        // 새 패스워드로 변경
                        await user.updatePassword(newPassword);
                        console.log('Firebase 패스워드 변경 성공');
                        changeSuccess = true;
                    } catch (firebaseError) {
                        console.warn('Firebase 패스워드 변경 실패:', firebaseError);
                        if (firebaseError.code === 'auth/wrong-password') {
                            showPasswordAlert('現在のパスワードが正しくありません。', 'danger');
                            return;
                        }
                    }
                }
                
                // Firebase 전용 - localStorage 사용 안함
                
                // 결과 처리
                if (changeSuccess) {
                    showPasswordAlert('パスワードが正常に変更されました。', 'success');
                    
                    // 모달 닫기
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('passwordModal'));
                        if (modal) modal.hide();
                    }, 1500);
                } else {
                    showPasswordAlert('パスワード 変更に失敗しました。', 'danger');
                }
                
            } catch (error) {
                console.error('패스워드 변경 오류:', error);
                showPasswordAlert('エラーが発生しました。', 'danger');
            }
        }
        
        // 패스워드 알림 표시
        function showPasswordAlert(message, type) {
            const alertDiv = document.getElementById('password-alert');
            alertDiv.className = `alert alert-${type} japanese-text`;
            alertDiv.textContent = message;
            alertDiv.classList.remove('d-none');
            
            // 3초 후 숨기기
            setTimeout(() => {
                alertDiv.classList.add('d-none');
            }, 3000);
        }
        
        // 전역 함수 노출
        window.loadOrderHistory = loadOrderHistory;
        window.getOrderHistoryDirectly = getOrderHistoryDirectly;
        window.initializeProfile = initializeProfile;
        window.analyzeStoredOrders = analyzeStoredOrders;
        // window.fixOrderData = fixOrderData; // 제거됨 - Firebase 전용
        window.showAllOrders = showAllOrders;
        window.saveProfileEdit = saveProfileEdit;
        window.showChangePassword = showChangePassword;
        window.changePassword = changePassword;

        // QR 코드 관련 함수들 - 포인트 페이지와 동일한 방식 사용

                // 사용자 정보 관리 (포인트 페이지와 동일)

        // 사용자 정보 로드 함수 제거됨 - checkAuthState에서 처리

        // QR 코드 생성 함수들 - 포인트 페이지와 동일한 방식 사용

        // 인증 상태 확인 중복 실행 방지 플래그
        let authStateCheckInProgress = false;
        
        // 인증 상태 확인
        const checkAuthState = function() {
            if (authStateCheckInProgress) {
                console.log('인증 상태 확인 이미 진행 중, 중복 실행 방지');
                return;
            }
            authStateCheckInProgress = true;
            
            try {
                console.log('=== 인증 상태 확인 시작 ===');
                
                // Firebase 초기화 대기 (안전한 방식)
                const waitForFirebase = () => {
                    return new Promise((resolve) => {
                        const checkFirebase = () => {
                            if (typeof firebase !== 'undefined' && firebase.auth && firebase.firestore) {
                                console.log('Firebase 초기화 완료');
                                resolve();
                            } else {
                                setTimeout(checkFirebase, 100);
                            }
                        };
                        checkFirebase();
                    });
                };
                
                waitForFirebase().then(() => {
                    console.log('Firebase 인증 상태 확인 중...');
                    
                    // 인증 상태 변경 리스너 설정 (한 번만)
                    if (!window.profileAuthStateUnsubscribe) {
                        console.log('🔧 Firebase 인증 상태 변경 리스너 설정 중...');
                        window.profileAuthStateUnsubscribe = firebase.auth().onAuthStateChanged(function(user) {
                            console.log('🔄 Firebase 인증 상태 변경 감지:', user ? `로그인됨 (${user.email})` : '로그아웃됨');
                            if (user) {
                                console.log('✅ Firebase 인증 상태 변경: 로그인됨', user.email);
                                
                                // 사용자 메뉴 직접 업데이트 (auth-utils.js 호출 방지)
                                updateUserMenuDirectly();
                                console.log('✅ profile.html - 사용자 메뉴 직접 업데이트 완료');
                                
                                // 프로필 헤더 업데이트
                                const userData = {
                                    name: user.displayName || user.email.split('@')[0],
                                    email: user.email
                                };
                                updateProfileHeader(userData);
                                
                                // 프로필 페이지 초기화
                                initializeProfile();
                                
                                // 인증 상태 확인 완료
                                authStateCheckInProgress = false;
                            } else {
                                console.log('❌ Firebase 인증 상태 변경: 로그아웃됨');
                                // 로그아웃 상태에서는 즉시 리다이렉트하지 않고 잠시 대기
                                setTimeout(() => { 
                                    console.log('🔄 로그인 페이지로 리다이렉트');
                                    window.location.href = 'login.html'; 
                                }, 2000);
                            }
                        });
                        console.log('✅ Firebase 인증 상태 변경 리스너 설정 완료');
                    }
                    
                    // 현재 사용자 상태 확인 (더 긴 시간 대기)
                    let retryCount = 0;
                    const maxRetries = 20; // 20번으로 증가
                    
                    const checkCurrentUser = () => {
                        const currentUser = firebase.auth().currentUser;
                        console.log(`현재 Firebase 사용자 (시도 ${retryCount + 1}/${maxRetries}):`, currentUser ? currentUser.email : 'null');
                        
                        if (currentUser) {
                            console.log('✅ Firebase 사용자 로그인 상태 확인됨:', currentUser.email);
                            
                            // 사용자 메뉴 직접 업데이트 (auth-utils.js 호출 방지)
                            updateUserMenuDirectly();
                            console.log('✅ profile.html - 현재 사용자 메뉴 직접 업데이트 완료');
                            
                            // 프로필 헤더 업데이트
                            const userData = {
                                name: currentUser.displayName || currentUser.email.split('@')[0],
                                email: currentUser.email
                            };
                            updateProfileHeader(userData);
                            
                            // 프로필 페이지 초기화
                            initializeProfile();
                            
                            // 인증 상태 확인 완료
                            authStateCheckInProgress = false;
                        } else if (retryCount < maxRetries) {
                            retryCount++;
                            console.log(`Firebase 사용자 없음, ${retryCount}/${maxRetries} 재시도 중... (인증 상태 복원 대기)`);
                            setTimeout(checkCurrentUser, 500); // 500ms 후 재시도 (더 긴 간격)
                        } else {
                            console.log('❌ Firebase 사용자 로그아웃 상태 - 인증 상태 변경 리스너에서 처리 대기');
                            console.log('⏳ onAuthStateChanged 리스너에서 인증 상태 복원 대기 중...');
                            // 인증 상태 변경 리스너에서 처리하도록 대기
                        }
                    };
                    
                    // 즉시 첫 번째 확인 실행
                    checkCurrentUser();
                });
            } catch (error) {
                console.error('인증 상태 확인 중 오류:', error);
                authStateCheckInProgress = false; // 오류 시 플래그 리셋
                // 오류 발생 시에도 잠시 대기 후 재시도
                setTimeout(() => {
                    checkAuthState();
                }, 2000);
            }
        };

        // 사용자 메뉴 업데이트 (auth-utils.js의 함수 사용) - 제거됨, updateUserMenuDirectly 사용

        // 로그아웃 함수 - 제거됨, 위의 모바일/웹 호환 로그아웃 함수 사용

        // 프로필 사진 업로드 함수들 - Firebase 전용

        // 불필요한 함수들 제거됨 - checkAuthState에서 모든 인증 상태 관리

        // 중복 실행 방지 플래그
        let profilePageInitialized = false;
        
        // auth-utils.js 중복 초기화 방지
        window.profilePageInitialized = true;
        window.disableAuthUtilsInit = true; // auth-utils.js 초기화 비활성화
        
        // 통합된 DOMContentLoaded 이벤트 리스너 (최적화됨)
        document.addEventListener('DOMContentLoaded', function() {
            if (profilePageInitialized) {
                console.log('프로필 페이지 이미 초기화됨, 중복 실행 방지');
                return;
            }
            profilePageInitialized = true;
            
            console.log('프로필 페이지 DOM 로드 완료');
            
            // 즉시 실행할 초기화 작업들
            initializeDateInputs();
            setupDragAndDrop();
            
            // 여백 강제 적용 (즉시 실행)
            const tabContent = document.getElementById('profileTabContent');
            const cardBody = document.querySelector('.col-md-8 .card.profile-card .card-body');
            const profileRow = document.querySelector('.profile-container .row');
            const colLeft = document.querySelector('.profile-container .col-md-4');
            const colRight = document.querySelector('.profile-container .col-md-8');
            
            if (tabContent) {
                tabContent.style.marginTop = '2rem';
                tabContent.style.paddingTop = '1rem';
            }
            if (cardBody) {
                cardBody.style.padding = '2rem 1.5rem';
            }
            if (profileRow) {
                profileRow.style.marginBottom = '3rem';
            }
            if (colLeft) {
                colLeft.style.marginBottom = '2rem';
            }
            if (colRight) {
                colRight.style.marginBottom = '2rem';
            }
            
            // 드롭다운 초기화
            const dropdownElementList = [].slice.call(document.querySelectorAll('.dropdown-toggle'));
            dropdownElementList.map(function(dropdownToggleEl) {
                return new bootstrap.Dropdown(dropdownToggleEl);
            });
            
            // Firebase 초기화 대기 (안전한 방식)
            const firebaseInitCheck = setInterval(() => {
                // Firebase 기본 객체 확인
                if (typeof firebase !== 'undefined' && firebase.auth && firebase.firestore) {
                    console.log('Firebase 초기화 완료, 인증 상태 확인 시작');
                    clearInterval(firebaseInitCheck);
                    
                    // Firebase 초기화 완료 후 잠시 대기 후 인증 상태 확인
                    setTimeout(() => {
                        checkAuthState();
                    }, 1000); // 1초 대기 후 인증 상태 확인
                }
            }, 100); // 100ms 간격
            
            // 3초 후에도 Firebase가 초기화되지 않으면 타임아웃 (5초 → 3초로 단축)
            setTimeout(() => {
                if (typeof firebase === 'undefined' || !firebase.auth) {
                    console.error('Firebase 초기화 타임아웃');
                    clearInterval(firebaseInitCheck);
                }
            }, 3000);
        });

    </script>

    <!-- 利用規約 Modal -->
    <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title japanese-heading" id="termsModalLabel">利用規約</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body japanese-text">
                    <h6>第10条（アカウント削除および再登録制限）</h6>
                    <p>1. お客様がアカウントを削除した場合、当社は当該お客様の個人情報および関連データを削除します。</p>
                    <p>2. アカウント削除後、同一のメールアドレスによる再登録は6ヶ月間制限されます。この制限は、ウェルカムボーナスポイントの濫用防止およびサービスの健全な運営を目的とします。</p>
                    <p>3. 再登録制限期間中に同一メールアドレスで登録を試行した場合、当社は登録を拒否することができます。</p>
                    <p>4. 6ヶ月経過後、同一メールアドレスによる再登録が可能となります。</p>
                    <p>5. 当社は、システムの記録により削除されたアカウントの履歴を追跡し、不正な再登録を防止するための措置を講じることができます。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary japanese-text" data-bs-dismiss="modal">閉じる</button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
 