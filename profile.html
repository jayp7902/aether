<!DOCTYPE html>
<html lang="ja">
<head>
    <title>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« - Aether</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Language" content="ja">
    <meta name="language" content="Japanese">
    <link rel="icon" type="image/png" href="assets/img/aether-icon.png?t=1750992166">
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/templatemo.css">
    <link rel="stylesheet" href="assets/css/custom.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800;900&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100;200;300;400;500;600;700;800;900&display=swap">
    <link rel="stylesheet" href="assets/css/fontawesome.min.css">
    
    <!-- QR Code Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <style>
        body {
            font-family: "Montserrat", sans-serif;
            background-color: #f8f9fa;
        }
        .japanese-text {
            font-family: "Noto Sans JP", sans-serif;
            font-weight: 400;
            line-height: 1.6;
        }
        .japanese-heading {
            font-family: "Noto Sans JP", sans-serif;
            font-weight: 600;
            line-height: 1.4;
        }

        /* ì£¼ë¬¸ ìƒíƒœë³„ ìŠ¤íƒ€ì¼ (ì£¼ë¬¸ ê´€ë¦¬ í˜ì´ì§€ì™€ ë™ì¼) */
        .order-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-pending_payment {
            background: #fff3cd;
            color: #856404;
        }

        .status-processing {
            background: #cce5ff;
            color: #004085;
        }

        .status-shipping {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .status-default {
            background: #e2e3e5;
            color: #383d41;
        }
        
        /* ì¼ë³¸ì–´ ë‚ ì§œ ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        input[type="date"][lang="ja"] {
            font-family: "Noto Sans JP", sans-serif;
            direction: ltr;
        }
        
        /* ë¹ˆ ë‚ ì§œ í•„ë“œì— ì¼ë³¸ì–´ í”Œë ˆì´ìŠ¤í™€ë” í‘œì‹œ */
        input[type="date"][lang="ja"]:invalid::-webkit-datetime-edit {
            color: transparent;
        }
        
        input[type="date"][lang="ja"]:invalid::before {
            content: attr(data-placeholder);
            color: #6c757d;
            font-family: "Noto Sans JP", sans-serif;
        }
        
        /* Firefox ì§€ì› */
        input[type="date"][lang="ja"]::-moz-focus-inner {
            border: 0;
        }
        
        /* ìƒë…„ì›”ì¼ ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        #profile-birthdate, #edit-birthdate {
            font-family: "Noto Sans JP", sans-serif;
        }
        
        #profile-birthdate::placeholder, #edit-birthdate::placeholder {
            color: #6c757d;
            font-size: 14px;
        }
        
        /* í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ ìŠ¤íƒ€ì¼ */
        .profile-avatar {
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .profile-avatar:hover {
            transform: scale(1.05);
        }
        
        .profile-avatar.drag-over {
            border: 3px dashed #007bff;
            background-color: rgba(0, 123, 255, 0.1);
        }
        
        .upload-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .profile-avatar:hover .upload-overlay {
            opacity: 1;
        }
        
        .photo-upload-options {
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .upload-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 0 0 50px 50px;
            overflow: hidden;
        }
        
        .upload-progress-bar {
            height: 100%;
            background: #28a745;
            width: 0%;
            transition: width 0.3s ease;
        }
        .profile-container {
            min-height: 100vh;
            padding: 2rem 0;
        }
        .profile-card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            border-radius: 10px;
        }
        .profile-header {
            background-color: #000000;
            color: white;
            border-radius: 10px 10px 0 0;
            padding: 2rem;
            text-align: center;
        }
        .profile-body {
            padding: 2rem;
        }
        .form-control:focus {
            border-color: #6c757d;
            box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.25);
        }
        .btn-profile {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        .btn-profile:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            position: relative;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .profile-avatar:hover {
            background-color: #5a6268;
            transform: scale(1.05);
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .profile-avatar .upload-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 50%;
        }
        
        .profile-avatar:hover .upload-overlay {
            opacity: 1;
        }
        
        .profile-avatar .upload-overlay i {
            color: white;
            font-size: 1.2rem;
        }
        
        .profile-avatar input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        .profile-stats {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
        }
        .stat-item {
            text-align: center;
            padding: 0.5rem;
        }
        .tab-content,
        #profileTabContent.tab-content,
        .tab-pane {
            margin-top: 2rem !important;
            padding-top: 1rem !important;
        }
        
        /* í”„ë¡œí•„ ì¹´ë“œ ë°”ë”” ì—¬ë°± ì¶”ê°€ - Bootstrap ê°•ì œ ë®ì–´ì“°ê¸° */
        .profile-card .card-body,
        .card.profile-card .card-body,
        .col-md-8 .card.profile-card .card-body {
            padding: 2rem 1.5rem !important;
        }
        
        /* íƒ­ ì½˜í…ì¸  ë‚´ë¶€ ì—¬ë°± ê°•í™” */
        .tab-pane .alert,
        .tab-pane form,
        .tab-pane .row {
            margin-top: 0 !important;
        }
        
        /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ê³¼ ì½˜í…ì¸  ì‚¬ì´ ì—¬ë°± */
        .nav-tabs {
            margin-bottom: 0 !important;
        }
        
        /* ë‘ ì¹´ë“œ ì‚¬ì´ ê°„ê²© ì¶”ê°€ */
        .profile-container .row {
            margin-bottom: 3rem !important;
        }
        
        .profile-container .col-md-4,
        .profile-container .col-md-8 {
            margin-bottom: 2rem !important;
        }
        
        /* ëª¨ë°”ì¼ì—ì„œ ì—¬ë°± ì¡°ì • */
        @media (max-width: 768px) {
            .profile-card .card-body,
            .card.profile-card .card-body,
            .col-md-8 .card.profile-card .card-body {
                padding: 1.5rem 1rem !important;
            }
            
            .tab-content,
            #profileTabContent.tab-content,
            .tab-pane {
                margin-top: 1.5rem !important;
                padding-top: 0.5rem !important;
            }
            
            .profile-container .row {
                margin-bottom: 2rem !important;
            }
            
            .profile-container .col-md-4,
            .profile-container .col-md-8 {
                margin-bottom: 1.5rem !important;
            }
        }
        
        @media (max-width: 480px) {
            .profile-card .card-body,
            .card.profile-card .card-body,
            .col-md-8 .card.profile-card .card-body {
                padding: 1rem 0.75rem !important;
            }
            
            .tab-content,
            #profileTabContent.tab-content,
            .tab-pane {
                margin-top: 1rem !important;
                padding-top: 0.5rem !important;
            }
            
            .profile-container .row {
                margin-bottom: 1.5rem !important;
            }
            
            .profile-container .col-md-4,
            .profile-container .col-md-8 {
                margin-bottom: 1rem !important;
            }
        }
      /* User dropdown hover fix */
      .dropdown-toggle:hover,
      .dropdown-toggle:focus,
      #user-name:hover {
          color: #343a40 !important;
          text-decoration: none !important;
      }
      .nav-link:hover {
          color: #343a40 !important;
      }
      /* Date input Japanese placeholder */
      input[type="date"]:lang(ja)::-webkit-datetime-edit-text {
          color: #6c757d;
      }
      input[type="date"]:lang(ja)::-webkit-datetime-edit-month-field,
      input[type="date"]:lang(ja)::-webkit-datetime-edit-day-field,
      input[type="date"]:lang(ja)::-webkit-datetime-edit-year-field {
          color: #6c757d;
      }
      
      /* ë„¤ë¹„ê²Œì´ì…˜ë°” í…ìŠ¤íŠ¸ thin ì„œì²´ í†µì¼ */
      .navbar-nav .nav-link {
          font-family: "Montserrat", sans-serif !important;
          font-weight: 300 !important;
          font-size: 1rem !important;
      }
      
      .navbar-brand {
          font-family: "Montserrat", sans-serif !important;
          font-weight: 300 !important;
      }
      
      #user-name {
          font-family: "Montserrat", sans-serif !important;
          font-weight: 300 !important;
      }
      input[type="date"]:lang(ja)::-webkit-input-placeholder {
          color: #6c757d;
      }
      input[type="date"]:lang(ja)::placeholder {
          color: #6c757d;
      }
      
      /* ë¦¬ì–¼ íƒ­ ë””ìì¸ - ê²¹ì¹˜ëŠ” íƒ­ ìŠ¤íƒ€ì¼ - Bootstrap ê°•ì œ ë®ì–´ì“°ê¸° */
      .nav-tabs, 
      ul.nav.nav-tabs, 
      #profileTabs.nav-tabs {
          border-bottom: 1px solid #dee2e6 !important;
          margin-bottom: 0 !important;
          padding-left: 0 !important;
          display: flex !important;
          flex-wrap: nowrap !important;
      }
      
      .nav-tabs .nav-item, 
      ul.nav.nav-tabs .nav-item, 
      #profileTabs .nav-item {
          margin-bottom: -1px !important;
          margin-right: -2px !important;
          flex: 1 !important;
      }
      
      .nav-tabs .nav-link, 
      ul.nav.nav-tabs .nav-link, 
      #profileTabs .nav-link,
      .nav-tabs .nav-link button,
      ul.nav.nav-tabs .nav-link button,
      #profileTabs .nav-link button {
          color: #6c757d !important;
          border: 1px solid #dee2e6 !important;
          border-radius: 0 !important;
          margin-right: -1px !important;
          border-bottom: 1px solid #dee2e6 !important;
          padding: 12px 20px !important;
          font-size: 14px !important;
          background-color: #f8f9fa !important;
          position: relative !important;
          z-index: 1 !important;
          width: 100% !important;
          text-align: center !important;
      }
      
      /* ì²« ë²ˆì§¸ íƒ­ - ì™¼ìª½ ë‘¥ê·¼ ëª¨ì„œë¦¬ */
      .nav-tabs .nav-item:first-child .nav-link,
      ul.nav.nav-tabs .nav-item:first-child .nav-link,
      #profileTabs .nav-item:first-child .nav-link,
      .nav-tabs .nav-item:first-child .nav-link button,
      ul.nav.nav-tabs .nav-item:first-child .nav-link button,
      #profileTabs .nav-item:first-child .nav-link button {
          border-top-left-radius: 8px !important;
          border-bottom-left-radius: 0 !important;
      }
      
      /* ë§ˆì§€ë§‰ íƒ­ - ì˜¤ë¥¸ìª½ ë‘¥ê·¼ ëª¨ì„œë¦¬ */
      .nav-tabs .nav-item:last-child .nav-link,
      ul.nav.nav-tabs .nav-item:last-child .nav-link,
      #profileTabs .nav-item:last-child .nav-link,
      .nav-tabs .nav-item:last-child .nav-link button,
      ul.nav.nav-tabs .nav-item:last-child .nav-link button,
      #profileTabs .nav-item:last-child .nav-link button {
          border-top-right-radius: 8px !important;
          border-bottom-right-radius: 0 !important;
      }
      
      /* í˜¸ë²„ íš¨ê³¼ */
      .nav-tabs .nav-link:hover,
      ul.nav.nav-tabs .nav-link:hover,
      #profileTabs .nav-link:hover,
      .nav-tabs .nav-link button:hover,
      ul.nav.nav-tabs .nav-link button:hover,
      #profileTabs .nav-link button:hover {
          color: #495057 !important;
          background-color: #e9ecef !important;
          border-color: #dee2e6 #dee2e6 #dee2e6 !important;
          z-index: 2 !important;
      }
      
      /* í™œì„± íƒ­ - ì•ìœ¼ë¡œ ë‚˜ì™€ì„œ ì—°ê²°ë¨ */
      .nav-tabs .nav-link.active,
      ul.nav.nav-tabs .nav-link.active,
      #profileTabs .nav-link.active,
      .nav-tabs .nav-link.active button,
      ul.nav.nav-tabs .nav-link.active button,
      #profileTabs .nav-link.active button {
          color: #212529 !important;
          background-color: #ffffff !important;
          border-color: #dee2e6 #dee2e6 #ffffff !important;
          border-bottom: 1px solid #ffffff !important;
          z-index: 3 !important;
          box-shadow: 0 -2px 4px rgba(0,0,0,0.1) !important;
      }
      
      .nav-tabs .nav-link.active:hover,
      ul.nav.nav-tabs .nav-link.active:hover,
      #profileTabs .nav-link.active:hover,
      .nav-tabs .nav-link.active button:hover,
      ul.nav.nav-tabs .nav-link.active button:hover,
      #profileTabs .nav-link.active button:hover {
          color: #212529 !important;
          background-color: #ffffff !important;
          border-color: #dee2e6 #dee2e6 #ffffff !important;
      }
      
      /* ëª¨ë°”ì¼ì—ì„œ ë¦¬ì–¼ íƒ­ ë””ìì¸ ìœ ì§€ */
      @media (max-width: 768px) {
          .nav-tabs, 
          ul.nav.nav-tabs, 
          #profileTabs.nav-tabs {
              flex-wrap: nowrap !important;
              border-bottom: 1px solid #dee2e6 !important;
              margin-bottom: 0 !important;
              padding-left: 0 !important;
              display: flex !important;
          }
          
          .nav-tabs .nav-item, 
          ul.nav.nav-tabs .nav-item, 
          #profileTabs .nav-item {
              flex: 1 !important;
              min-width: 0;
              margin-bottom: -1px !important;
              margin-right: -2px !important;
          }
          
          .nav-tabs .nav-link, 
          ul.nav.nav-tabs .nav-link, 
          #profileTabs .nav-link,
          .nav-tabs .nav-link button,
          ul.nav.nav-tabs .nav-link button,
          #profileTabs .nav-link button {
              font-size: 14px !important;
              padding: 12px 8px !important;
              text-align: center;
              white-space: nowrap;
              overflow: hidden;
              text-overflow: ellipsis;
              border: 1px solid #dee2e6 !important;
              border-radius: 0 !important;
              margin-right: -1px !important;
              border-bottom: 1px solid #dee2e6 !important;
              background-color: #f8f9fa !important;
              position: relative !important;
              z-index: 1 !important;
              width: 100% !important;
          }
          
          .nav-tabs .nav-item:first-child .nav-link {
              border-top-left-radius: 8px !important;
              border-bottom-left-radius: 0 !important;
          }
          
          .nav-tabs .nav-item:last-child .nav-link {
              border-top-right-radius: 8px !important;
              border-bottom-right-radius: 0 !important;
          }
          
          .nav-tabs .nav-link:hover {
              background-color: #e9ecef !important;
              border-color: #dee2e6 #dee2e6 #dee2e6 !important;
              z-index: 2 !important;
          }
          
          .nav-tabs .nav-link.active {
              background-color: #ffffff !important;
              border-color: #dee2e6 #dee2e6 #ffffff !important;
              border-bottom: 1px solid #ffffff !important;
              z-index: 3 !important;
              box-shadow: 0 -2px 4px rgba(0,0,0,0.1) !important;
          }
          
          .nav-tabs .nav-link i {
              font-size: 12px !important;
              margin-right: 4px !important;
          }
      }
      
      /* ë” ì‘ì€ í™”ë©´ì—ì„œ ë¦¬ì–¼ íƒ­ ë””ìì¸ ìœ ì§€ */
      @media (max-width: 480px) {
          .nav-tabs .nav-link {
              font-size: 12px !important;
              padding: 10px 4px !important;
              border: 1px solid #dee2e6 !important;
              border-radius: 0 !important;
              margin-right: -1px !important;
              border-bottom: 1px solid #dee2e6 !important;
              background-color: #f8f9fa !important;
              position: relative !important;
              z-index: 1 !important;
          }
          
          .nav-tabs .nav-item:first-child .nav-link {
              border-top-left-radius: 8px !important;
              border-bottom-left-radius: 0 !important;
          }
          
          .nav-tabs .nav-item:last-child .nav-link {
              border-top-right-radius: 8px !important;
              border-bottom-right-radius: 0 !important;
          }
          
          .nav-tabs .nav-link:hover {
              background-color: #e9ecef !important;
              border-color: #dee2e6 #dee2e6 #dee2e6 !important;
              z-index: 2 !important;
          }
          
          .nav-tabs .nav-link.active {
              background-color: #ffffff !important;
              border-color: #dee2e6 #dee2e6 #ffffff !important;
              border-bottom: 1px solid #ffffff !important;
              z-index: 3 !important;
              box-shadow: 0 -2px 4px rgba(0,0,0,0.1) !important;
          }
          
          .nav-tabs .nav-link i {
              font-size: 10px !important;
              margin-right: 3px !important;
          }
      }
  </style>
</head>

<body>
    <!-- Start Top Nav -->
    <nav class="navbar navbar-expand-lg navbar-light" id="templatemo_nav_top" style="min-height: 20px; background-color: #000000 !important;">
        <div class="container text-light">
            <div class="w-100 d-flex justify-content-between">
                <div>
                    <!-- ë¹ˆ ê³µê°„ìœ¼ë¡œ ë¸”ë™ ë°” ìœ ì§€ -->
                </div>
            </div>
        </div>
    </nav>
    <!-- Close Top Nav -->

    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-light shadow">
        <div class="container d-flex justify-content-between align-items-center">
            <!-- QR ì½”ë“œ ë²„íŠ¼ ì œê±°ë¨ -->

            <a class="navbar-brand text-success logo align-self-center" href="index.html">
                <img src="assets/img/logo.png" alt="Logo" class="img-fluid" style="max-height: 50px;">
            </a>

            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#templatemo_main_nav" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="align-self-center collapse navbar-collapse flex-fill d-lg-flex justify-content-lg-between" id="templatemo_main_nav">
                <!-- ëª¨ë°”ì¼ ë©”ë‰´ ë ˆì´ì•„ì›ƒ -->
                <div class="d-lg-none w-100">
                    <!-- ì˜ë¬¸ ë©”ë‰´ - ê°€ë¡œ ì •ë ¬ -->
                    <div class="d-flex justify-content-center mb-4">
                        <ul class="nav navbar-nav d-flex flex-row gap-4">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="shop.html">Brand</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="info.html">Info</a>
                        </li>
                    </ul>
                </div>
                    
                    <!-- ì•„ì´ì½˜ë“¤ - ê°€ë¡œ ì •ë ¬, ì¢Œìš° ì—¬ë°± ì¶”ê°€ -->
                    <div class="d-flex justify-content-center align-items-center gap-4 px-4">
                        <a href="cart.html" class="nav-link text-decoration-none">
                            <i class="fas fa-shopping-cart text-dark" style="font-size: 1.5rem;"></i>
                            <span class="badge bg-secondary ms-1" id="cart-count-mobile">0</span>
                        </a>
                        <div class="dropdown">
                            <a href="#" class="nav-link dropdown-toggle text-decoration-none" id="userDropdownMobile" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user text-dark" style="font-size: 1.5rem;"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-center" aria-labelledby="userDropdownMobile">
                                <li id="login-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="login.html">
                                        <i class="fas fa-sign-in-alt me-2"></i>Login
                                    </a>
                                </li>
                                <li id="register-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="register.html">
                                        <i class="fas fa-user-plus me-2"></i>Register
                                    </a>
                                </li>
                                <li id="profile-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="profile.html">
                                        <i class="fas fa-user-circle me-2"></i>Profile
                                    </a>
                                </li>
                                <li id="points-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="points.html">
                                        <i class="fas fa-coins me-2"></i>Points
                                    </a>
                                </li>
                                <li id="admin-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="admin-dashboard.html">
                                        <i class="fas fa-cog me-2"></i>ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                                    </a>
                                </li>
                                <li id="logout-menu-mobile" style="display: none;">
                                    <hr class="dropdown-divider">
                                </li>
                                <li id="logout-menu-item-mobile" style="display: none;">
                                    <a class="dropdown-item" href="#" onclick="logout()">
                                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                                    </a>
                                </li>
                            </ul>
                            </div>
                        </div>
                    </div>
                
                <!-- ë°ìŠ¤í¬í†± ë©”ë‰´ ë ˆì´ì•„ì›ƒ -->
                <div class="flex-fill d-none d-lg-block">
                    <ul class="nav navbar-nav d-flex justify-content-between mx-lg-auto" style="max-width: 400px; margin: 0 auto;">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="shop.html">Brand</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="info.html">Info</a>
                        </li>
                    </ul>
                </div>
                <div class="navbar align-self-center d-flex d-none d-lg-flex">
                    <a href="cart.html" class="nav-link text-decoration-none me-3">
                        <i class="fas fa-shopping-cart text-dark"></i>
                        <span class="badge bg-secondary" id="cart-count">0</span>
                    </a>
                    <div class="dropdown">
                        <a href="#" class="nav-link dropdown-toggle text-decoration-none" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user text-dark"></i>
                            <span id="user-name" class="d-none d-lg-inline ms-1"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li id="login-menu" style="display: none;">
                                <a class="dropdown-item" href="login.html">
                                    <i class="fas fa-sign-in-alt me-2"></i>Login
                                </a>
                            </li>
                            <li id="register-menu" style="display: none;">
                                <a class="dropdown-item" href="register.html">
                                    <i class="fas fa-user-plus me-2"></i>Register
                                </a>
                            </li>
                            <li id="profile-menu" style="display: none;">
                                <a class="dropdown-item" href="profile.html">
                                    <i class="fas fa-user-circle me-2"></i>Profile
                                </a>
                            </li>
                            <li id="points-menu" style="display: none;">
                                <a class="dropdown-item" href="points.html">
                                    <i class="fas fa-coins me-2"></i>Points
                                </a>
                            </li>
                            <li id="admin-menu" style="display: none;">
                                <a class="dropdown-item" href="admin-dashboard.html">
                                    <i class="fas fa-cog me-2"></i>ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                                </a>
                            </li>
                            <li id="logout-menu" style="display: none;">
                                <hr class="dropdown-divider">
                            </li>
                            <li id="logout-menu-item" style="display: none;">
                                <a class="dropdown-item" href="#" onclick="logout()">
                                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    <!-- Close Header -->

    <!-- QR Code Modal ì œê±°ë¨ -->

    <!-- Profile Container -->
    <div class="profile-container">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <!-- Profile Card -->
                    <div class="card profile-card">
                        <div class="profile-header">
                            <div class="profile-avatar" id="profile-avatar-container" onclick="openPhotoUpload()">
                                <img id="profile-photo" src="" alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸ" style="display: none;">
                                <i class="fas fa-user fa-2x text-white" id="profile-photo-placeholder"></i>
                                <div class="upload-overlay">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <input type="file" id="profile-photo-input" accept="image/*" style="display: none;" onchange="handleProfilePhotoUpload(event)">
                            </div>
                            <div class="photo-upload-options mt-2" id="photo-upload-options" style="display: none;">
                                <button class="btn btn-sm btn-outline-light me-2" onclick="selectPhotoFromGallery()">
                                    <i class="fas fa-images me-1"></i>ã‚®ãƒ£ãƒ©ãƒªãƒ¼
                                </button>
                                <button class="btn btn-sm btn-outline-light" onclick="takePhotoWithCamera()">
                                    <i class="fas fa-camera me-1"></i>ã‚«ãƒ¡ãƒ©
                                </button>
                            </div>
                            <h4 class="japanese-heading mb-0" id="profile-display-name">-</h4>
                            <p class="japanese-text mb-0" id="profile-display-email">-</p>
                        </div>
                        <div class="profile-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-profile btn-dark japanese-text" onclick="showEditProfile()">
                                    <i class="fas fa-edit me-2"></i>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
                                </button>
                                <button class="btn btn-outline-secondary japanese-text" onclick="showChangePassword()">
                                    <i class="fas fa-key me-2"></i>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
                                </button>
                                <button class="btn btn-outline-secondary japanese-text" onclick="showDeleteAccount()">
                                    <i class="fas fa-user-times me-2"></i>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <!-- Profile Content -->
                    <div class="card profile-card">
                        <div class="card-body" style="padding: 2rem 1.5rem !important;">
                            <!-- Tab Navigation -->
                            <ul class="nav nav-tabs" id="profileTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active japanese-text" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab">
                                        <i class="fas fa-user me-2"></i>åŸºæœ¬æƒ…å ±
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link japanese-text" id="address-tab" data-bs-toggle="tab" data-bs-target="#address" type="button" role="tab">
                                        <i class="fas fa-map-marker-alt me-2"></i>é…é€å…ˆä½æ‰€
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link japanese-text" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab">
                                        <i class="fas fa-shopping-bag me-2"></i>æ³¨æ–‡å±¥æ­´
                                    </button>
                                </li>
                            </ul>

                            <!-- Tab Content -->
                            <div class="tab-content" id="profileTabContent" style="margin-top: 2rem !important; padding-top: 1rem !important;">
                                <!-- Basic Info Tab -->
                                <div class="tab-pane fade show active" id="info" role="tabpanel">
                                    <div class="alert alert-info japanese-text d-none" id="info-alert"></div>
                                    <form id="profile-form">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="profile-name" class="form-label japanese-text">ãŠåå‰</label>
                                                <input type="text" class="form-control" id="profile-name" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="profile-email" class="form-label japanese-text">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                                                <input type="email" class="form-control" id="profile-email" required>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="profile-phone" class="form-label japanese-text">é›»è©±ç•ªå·</label>
                                                <input type="tel" class="form-control" id="profile-phone">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="profile-birthdate" class="form-label japanese-text">ç”Ÿå¹´æœˆæ—¥</label>
                                                <input type="text" class="form-control" id="profile-birthdate" placeholder="å¹´/æœˆ/æ—¥ (ä¾‹: 1990/01/15)" maxlength="10">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="profile-gender" class="form-label japanese-text">æ€§åˆ¥</label>
                                            <select class="form-control" id="profile-gender">
                                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                                <option value="male">ç”·æ€§</option>
                                                <option value="female">å¥³æ€§</option>
                                                <option value="other">ãã®ä»–</option>
                                                <option value="prefer-not-to-say">å›ç­”ã—ãªã„</option>
                                            </select>
                                        </div>
                                        <button type="submit" class="btn btn-profile btn-dark japanese-text">
                                            <i class="fas fa-save me-2"></i>åŸºæœ¬æƒ…å ±ã‚’ä¿å­˜
                                        </button>
                                    </form>
                                </div>

                                <!-- Address Tab -->
                                <div class="tab-pane fade" id="address" role="tabpanel">
                                    <div class="alert alert-info japanese-text d-none" id="address-alert"></div>
                                    <form id="address-form">
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label for="postal-code" class="form-label japanese-text">éƒµä¾¿ç•ªå·</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="postal-code" pattern="[0-9]{3}-[0-9]{4}" maxlength="8" placeholder="123-4567">
                                                    <button class="btn btn-outline-secondary" type="button" id="search-address-btn" onclick="searchAddress()">
                                                        <i class="fas fa-search"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-md-8 mb-3">
                                                <label for="prefecture" class="form-label japanese-text">éƒ½é“åºœçœŒ</label>
                                                <input type="text" class="form-control" id="prefecture">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="city" class="form-label japanese-text">å¸‚åŒºç”ºæ‘</label>
                                            <input type="text" class="form-control" id="city">
                                        </div>
                                        <div class="mb-3">
                                            <label for="address1" class="form-label japanese-text">ä½æ‰€1ï¼ˆç”ºåãƒ»ç•ªåœ°ï¼‰</label>
                                            <input type="text" class="form-control" id="address1">
                                        </div>
                                        <div class="mb-3">
                                            <label for="address2" class="form-label japanese-text">ä½æ‰€2ï¼ˆå»ºç‰©åãƒ»éƒ¨å±‹ç•ªå·ï¼‰</label>
                                            <input type="text" class="form-control" id="address2">
                                        </div>
                                        <button type="submit" class="btn btn-profile btn-dark japanese-text">
                                            <i class="fas fa-save me-2"></i>ä½æ‰€ã‚’ä¿å­˜
                                        </button>
                                    </form>
                                </div>

                                <!-- Orders Tab -->
                                <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                                    <div class="card">
                                        <div class="card-body">
                                            <h5 class="card-title japanese-text mb-4">æ³¨æ–‡å±¥æ­´</h5>
                                            <div id="orders-container">
                                                <div class="text-center py-4">
                                                    <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
                                                    <p class="japanese-text text-muted">æ³¨æ–‡å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                        </div>
                    </div>
                </div>
            </div>

    <!-- Profile Edit Modal -->
    <div class="modal fade" id="profileEditModal" tabindex="-1" aria-labelledby="profileEditModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title japanese-heading" id="profileEditModalLabel">
                        <i class="fas fa-edit me-2"></i>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert d-none" id="profile-edit-alert"></div>
                    <form id="profile-edit-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-name" class="form-label japanese-text">ãŠåå‰</label>
                                <input type="text" class="form-control" id="edit-name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-email" class="form-label japanese-text">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                                <input type="email" class="form-control" id="edit-email" required readonly>
                                <div class="form-text japanese-text">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¤‰æ›´ã§ãã¾ã›ã‚“</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-phone" class="form-label japanese-text">é›»è©±ç•ªå·</label>
                                <input type="tel" class="form-control" id="edit-phone">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-birthdate" class="form-label japanese-text">ç”Ÿå¹´æœˆæ—¥</label>
                                <input type="text" class="form-control" id="edit-birthdate" placeholder="å¹´/æœˆ/æ—¥ (ä¾‹: 1990/01/15)" maxlength="10">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="edit-gender" class="form-label japanese-text">æ€§åˆ¥</label>
                            <select class="form-control" id="edit-gender">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="male">ç”·æ€§</option>
                                <option value="female">å¥³æ€§</option>
                                <option value="other">ãã®ä»–</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary japanese-text" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-profile btn-dark japanese-text" onclick="saveProfileEdit()">
                        <i class="fas fa-save me-2"></i>ä¿å­˜
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Change Modal -->
    <div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title japanese-heading" id="passwordModalLabel">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info japanese-text d-none" id="password-alert"></div>
                    <form id="password-form">
                        <div class="mb-3">
                            <label for="current-password" class="form-label japanese-text">ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                            <input type="password" class="form-control" id="current-password" required>
                        </div>
                        <div class="mb-3">
                            <label for="new-password" class="form-label japanese-text">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                            <input type="password" class="form-control" id="new-password" required minlength="8">
                            <div class="form-text japanese-text">8æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„</div>
                        </div>
                        <div class="mb-3">
                            <label for="confirm-new-password" class="form-label japanese-text">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰</label>
                            <input type="password" class="form-control" id="confirm-new-password" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary japanese-text" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="button" class="btn btn-profile btn-dark japanese-text" onclick="changePassword()">
                        <i class="fas fa-key me-2"></i>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Delete Modal -->
    <div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title japanese-heading" id="deleteAccountModalLabel">
                        <i class="fas fa-exclamation-triangle me-2"></i>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-secondary japanese-text" role="alert">
                        <strong>âš ï¸ é‡è¦ãªè­¦å‘Š</strong><br>
                        ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ãŒã™ã¹ã¦å¤±ã‚ã‚Œã¾ã™ï¼š
                        <ul class="mt-2 mb-2">
                            <li>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±</li>
                            <li>æ³¨æ–‡å±¥æ­´</li>
                            <li>é…é€å…ˆä½æ‰€</li>
                            <li>ãƒã‚¤ãƒ³ãƒˆå±¥æ­´</li>
                        </ul>
                        <strong>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã™ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚</strong>
                    </div>
                    
                    <div class="alert alert-warning japanese-text" role="alert">
                        <strong>ğŸ“‹ å†ç™»éŒ²åˆ¶é™ã«ã¤ã„ã¦</strong><br>
                        ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤å¾Œã€åŒä¸€ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã‚ˆã‚‹å†ç™»éŒ²ã¯<strong>6ãƒ¶æœˆé–“åˆ¶é™</strong>ã•ã‚Œã¾ã™ã€‚<br>
                        ã“ã®åˆ¶é™ã¯ã€ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒœãƒ¼ãƒŠã‚¹ãƒã‚¤ãƒ³ãƒˆã®æ¿«ç”¨é˜²æ­¢ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚<br>
                        <small class="text-muted">è©³ç´°ã¯<a href="#" onclick="showTermsModal()" class="text-decoration-none">åˆ©ç”¨è¦ç´„</a>ã‚’ã”ç¢ºèªãã ã•ã„ã€‚</small>
                    </div>
                    
                    <div class="alert alert-light japanese-text d-none" id="delete-alert"></div>
                    
                    <form id="delete-account-form">
                        <div class="mb-3">
                            <label for="delete-password" class="form-label japanese-text">
                                <strong>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„</strong>
                            </label>
                            <input type="password" class="form-control" id="delete-password" placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="delete-confirm" required>
                                <label class="form-check-label japanese-text" for="delete-confirm">
                                    <strong>ä¸Šè¨˜ã®è­¦å‘Šã‚’ç†è§£ã—ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ã«åŒæ„ã—ã¾ã™</strong>
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary japanese-text" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button type="button" class="btn btn-danger japanese-text" onclick="confirmDeleteAccount()">
                        <i class="fas fa-trash-alt me-2"></i>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript files -->
    <script src="assets/js/jquery-1.11.0.min.js"></script>
    <script src="assets/js/jquery-migrate-1.2.1.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/templatemo.js"></script>
    <script src="assets/js/custom.js"></script>
    

    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- Firebase ì„¤ì • ë° ìœ í‹¸ë¦¬í‹° -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/auth-utils.js"></script>

    <script>
        let profileUser = null;
        
        // í¬ì¸íŠ¸ í˜ì´ì§€ ì „ìš© ë³€ìˆ˜ë“¤
        let pointsPageUser = null;
        
        // í¬ì¸íŠ¸ í˜ì´ì§€ì™€ ë™ì¼í•œ QR ì½”ë“œ ìƒì„± í•¨ìˆ˜ ì œê±°ë¨
        /*
        const generateQRCode = function(data, containerId) {
            try {
                console.log('QRì½”ë“œ ìƒì„± ì‹œì‘, ë°ì´í„°:', data, 'íƒ€ì…:', typeof data);
                console.log('ì»¨í…Œì´ë„ˆ ID:', containerId);
                
                if (!data) {
                    console.error('QRì½”ë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }

                const container = document.getElementById(containerId);
                console.log('ì»¨í…Œì´ë„ˆ ìš”ì†Œ:', container);
                
                if (!container) {
                    console.error('ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', containerId);
                    return;
                }

                // ê¸°ì¡´ ë‚´ìš© ì œê±°
                console.log('ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ë‚´ìš© ì œê±° ì „:', container.innerHTML);
                container.innerHTML = '';
                console.log('ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ë‚´ìš© ì œê±° í›„:', container.innerHTML);

                // QR ì½”ë“œ ìƒì„±
                console.log('qrcode í•¨ìˆ˜ í™•ì¸:', typeof qrcode);
                if (typeof qrcode === 'undefined') {
                    throw new Error('qrcode ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                }
                
                const qr = qrcode(0, 'M');
                qr.addData(data);
                qr.make();

                // QR ì½”ë“œ ì´ë¯¸ì§€ ìƒì„±
                const qrImage = qr.createImgTag(5, 10);
                console.log('ìƒì„±ëœ QR ì½”ë“œ HTML:', qrImage);
                
                container.innerHTML = qrImage;
                console.log('ì»¨í…Œì´ë„ˆì— QR ì½”ë“œ ì‚½ì… í›„:', container.innerHTML);

                console.log('QRì½”ë“œ ìƒì„± ì„±ê³µ');
            } catch (error) {
                console.error('QRì½”ë“œ ìƒì„± ì˜¤ë¥˜:', error);
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = '<div class="text-danger">QRì½”ë“œ ìƒì„± ì‹¤íŒ¨</div>';
                }
            }
        }
        */

        // QR ì½”ë“œ í‘œì‹œ í•¨ìˆ˜ ì œê±°ë¨
        /*
        const profileShowQRCode = async function() {
            console.log('=== QRì½”ë“œ í‘œì‹œ í•¨ìˆ˜ ì‹œì‘ ===');
            
            if (!pointsPageUser) {
                console.log('ì‚¬ìš©ì ì •ë³´ê°€ ì—†ì–´ QRì½”ë“œë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚');
                return;
            }

            try {
                // FirebaseServiceê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
                let attempts = 0;
                const maxAttempts = 100; // 10ì´ˆ ëŒ€ê¸°
                
                while (typeof window.FirebaseService === 'undefined' && attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                    if (attempts % 10 === 0) {
                        console.log(`FirebaseService ë¡œë“œ ëŒ€ê¸° ì¤‘... (${attempts}/100)`);
                    }
                }
                
                // Firebase ì „ìš© QR ì½”ë“œ ì‹œìŠ¤í…œ ì‚¬ìš©
                if (typeof window.FirebaseService === 'function') {
                    console.log('âœ… FirebaseService ë°œê²¬, Firebase ì „ìš© QR í† í° ì‚¬ìš©');
                    
                    try {
                        // FirebaseService í´ë˜ìŠ¤ì˜ static ë©”ì„œë“œ ì§ì ‘ í˜¸ì¶œ
                        const qrToken = await window.FirebaseService.getOrCreateQRToken(pointsPageUser.uid);
                        console.log('âœ… Firebase ì „ìš© QR í† í° ì‚¬ìš©:', qrToken);
                        
                        // ëª¨ë‹¬ì— QRì½”ë“œ ìƒì„± ì „ ì»¨í…Œì´ë„ˆ í™•ì¸
                        const container = document.getElementById('qr-code-modal-container');
                        if (!container) {
                            console.error('QR ì½”ë“œ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: qr-code-modal-container');
                            throw new Error('QR ì½”ë“œ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                        }
                        console.log('QR ì½”ë“œ ì»¨í…Œì´ë„ˆ ë°œê²¬:', container);
                        
                        // ëª¨ë‹¬ì— QRì½”ë“œ ìƒì„±
                        generateQRCode(qrToken, 'qr-code-modal-container');
                        
                        // ëª¨ë‹¬ í‘œì‹œ
                        const modal = new bootstrap.Modal(document.getElementById('qr-code-modal'));
                        modal.show();
                    } catch (methodError) {
                        console.error('FirebaseService.getOrCreateQRToken í˜¸ì¶œ ì‹¤íŒ¨:', methodError);
                        throw new Error('FirebaseService ë©”ì„œë“œ í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Firebase ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                    }
                } else {
                    throw new Error('FirebaseServiceë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Firebase ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
            } catch (error) {
                console.error('QR ì½”ë“œ í‘œì‹œ ì‹¤íŒ¨:', error);
                alert('QRã‚³ãƒ¼ãƒ‰ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }
        */

        // QR ì½”ë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • - ì „ì—­ í•¨ìˆ˜ ì•„ë‹˜
        // QR ì½”ë“œ ê´€ë ¨ í•¨ìˆ˜ë“¤ ì œê±°ë¨
        /*
        const setupQRCodeEventListeners = function() {
            // ëª¨ë°”ì¼ QR ì½”ë“œ ë²„íŠ¼
            const mobileQRBtn = document.getElementById('qr-code-btn-mobile');
            if (mobileQRBtn) {
                mobileQRBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    // í˜ì´ì§€ë³„ profileShowQRCode í•¨ìˆ˜ ì§ì ‘ í˜¸ì¶œ
                    profileShowQRCode();
                });
                console.log('âœ… ëª¨ë°”ì¼ QR ì½”ë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
            }
            
            // ë°ìŠ¤í¬í†± QR ì½”ë“œ ë²„íŠ¼
            const desktopQRBtn = document.getElementById('qr-code-btn');
            if (desktopQRBtn) {
                desktopQRBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    // í˜ì´ì§€ë³„ profileShowQRCode í•¨ìˆ˜ ì§ì ‘ í˜¸ì¶œ
                    profileShowQRCode();
                });
                console.log('âœ… ë°ìŠ¤í¬í†± QR ì½”ë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
            }
        }
        */

        // ì¤‘ë³µëœ DOMContentLoaded ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¨ - ì•„ë˜ì˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì‚¬ìš©

        // ê¸°ë³¸ ì •ë³´ ì €ì¥
        document.getElementById('profile-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const profileData = {
                    name: document.getElementById('profile-name').value,
                    email: document.getElementById('profile-email').value,
                    phone: document.getElementById('profile-phone').value,
                    birthdate: convertFromJapaneseDate(document.getElementById('profile-birthdate').value),
                    gender: document.getElementById('profile-gender').value
                };
                
                console.log('ê¸°ë³¸ì •ë³´ ì €ì¥ ì‹œì‘:', profileData);
                
                let saveSuccess = false;
                
                // Firebase ì‚¬ìš©ìì¸ ê²½ìš°
                try {
                    if (typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser && firebase.firestore) {
                        const user = firebase.auth().currentUser;
                        // ê¸°ë³¸ ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
                        await firebase.firestore().collection('users').doc(user.email).update({
                            name: profileData.name,
                            phone: profileData.phone,
                            profile: {
                                ...profileData,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            },
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        console.log('Firebase ê¸°ë³¸ì •ë³´ ì €ì¥ ì„±ê³µ');
                        saveSuccess = true;
                    }
                } catch (firebaseError) {
                    console.error('Firebase ì €ì¥ ì‹¤íŒ¨:', firebaseError);
                }
                
                // Firebase ì „ìš©
                console.log('âœ… Firebase ê¸°ë³¸ì •ë³´ ì €ì¥ ì„±ê³µ');
                saveSuccess = true;
                
                // ê²°ê³¼ ë©”ì‹œì§€ í‘œì‹œ
                const alertDiv = document.getElementById('info-alert');
                if (saveSuccess) {
                    alertDiv.className = 'alert alert-secondary border-0 shadow-sm';
                    alertDiv.innerHTML = '<i class="fas fa-check-circle me-2 text-dark"></i><span class="text-dark">åŸºæœ¬æƒ…å ±ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ</span>';
                    alertDiv.classList.remove('d-none');
                    
                    // í”„ë¡œí•„ í—¤ë” ì—…ë°ì´íŠ¸
                    await loadProfileHeader();
                    
                    // 3ì´ˆ í›„ ì•Œë¦¼ ìˆ¨ê¸°ê¸°
                    setTimeout(() => {
                        alertDiv.classList.add('d-none');
                    }, 3000);
                } else {
                    alertDiv.className = 'alert alert-secondary border-0 shadow-sm';
                    alertDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2 text-dark"></i><span class="text-dark">åŸºæœ¬æƒ…å ±ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ</span>';
                    alertDiv.classList.remove('d-none');
                }
                
            } catch (error) {
                console.error('ê¸°ë³¸ ì •ë³´ ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
                const alertDiv = document.getElementById('info-alert');
                alertDiv.className = 'alert alert-secondary border-0 shadow-sm';
                alertDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2 text-dark"></i><span class="text-dark">åŸºæœ¬æƒ…å ±ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</span>';
                alertDiv.classList.remove('d-none');
            }
        });

        // ì£¼ì†Œ ì €ì¥
        document.getElementById('address-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const addressData = {
                postalCode: document.getElementById('postal-code').value,
                postal: document.getElementById('postal-code').value, // ì²´í¬ì•„ì›ƒ í˜ì´ì§€ í˜¸í™˜ì„±ì„ ìœ„í•´ ì¶”ê°€
                prefecture: document.getElementById('prefecture').value,
                city: document.getElementById('city').value,
                address1: document.getElementById('address1').value,
                address2: document.getElementById('address2').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            // í•„ìˆ˜ í•„ë“œ ê²€ì¦
            if (!addressData.postalCode || !addressData.prefecture || !addressData.city || !addressData.address1) {
                const alertDiv = document.getElementById('address-alert');
                alertDiv.className = 'alert alert-secondary border-0 shadow-sm';
                alertDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2 text-dark"></i><span class="text-dark">éƒµä¾¿ç•ªå·ã€éƒ½é“åºœçœŒã€å¸‚åŒºç”ºæ‘ã€ä½æ‰€1ã¯å¿…é ˆé …ç›®ã§ã™</span>';
                alertDiv.classList.remove('d-none');
                
                setTimeout(() => {
                    alertDiv.classList.add('d-none');
                }, 3000);
                
                return;
            }
            
            try {
                const user = firebase.auth().currentUser;
                if (user) {
                    // ì €ì¥ ë²„íŠ¼ ë¹„í™œì„±í™”
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalBtnHtml = submitBtn.innerHTML;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ä¿å­˜ä¸­...';

                    // Firestoreì— ì£¼ì†Œ ì •ë³´ ì €ì¥ (ì´ë©”ì¼ì„ ë¬¸ì„œ IDë¡œ ì‚¬ìš©)
                    await firebase.firestore().collection('users').doc(user.email).update({
                        address: addressData,
                        shippingAddress: addressData, // ì²´í¬ì•„ì›ƒ í˜ì´ì§€ í˜¸í™˜ì„±ì„ ìœ„í•´ ì¶”ê°€
                        lastUsedAddress: addressData, // ì²´í¬ì•„ì›ƒ í˜ì´ì§€ í˜¸í™˜ì„±ì„ ìœ„í•´ ì¶”ê°€
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // ì„±ê³µ ì‹œ ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ
                    const alertDiv = document.getElementById('address-alert');
                    alertDiv.className = 'alert alert-secondary border-0 shadow-sm';
                    alertDiv.innerHTML = '<i class="fas fa-check-circle me-2 text-dark"></i><span class="text-dark">ä½æ‰€ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ</span>';
                    alertDiv.classList.remove('d-none');
                    
                    // 3ì´ˆ í›„ ì„±ê³µ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                    setTimeout(() => {
                        alertDiv.classList.add('d-none');
                    }, 3000);

                    // ë²„íŠ¼ ìƒíƒœ ë³µêµ¬
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnHtml;
                }
            } catch (error) {
                console.error('ì£¼ì†Œ ì €ì¥ ì‹¤íŒ¨:', error);
                const alertDiv = document.getElementById('address-alert');
                alertDiv.className = 'alert alert-secondary border-0 shadow-sm';
                alertDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2 text-dark"></i><span class="text-dark">ä½æ‰€ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ</span>';
                alertDiv.classList.remove('d-none');

                // 3ì´ˆ í›„ ì—ëŸ¬ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                setTimeout(() => {
                    alertDiv.classList.add('d-none');
                }, 3000);
            }
        });

        // ì£¼ë¬¸ ì´ë ¥ ë¡œë“œ í•¨ìˆ˜ (ê°œì„ ë¨)
        async function loadOrderHistory(userId) {
            const ordersContainer = document.getElementById('orders-container');
            
            try {
                console.log('ì£¼ë¬¸ ì´ë ¥ ë¡œë“œ ì‹œì‘:', userId);
                console.log('FirebaseService ì‚¬ìš© ê°€ëŠ¥:', typeof FirebaseService !== 'undefined');
                
                // ë¡œë”© í‘œì‹œ (ìŠ¤í”¼ë„ˆë§Œ)
                ordersContainer.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-secondary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `;

                // Firebaseì—ì„œë§Œ ì£¼ë¬¸ ì´ë ¥ ì¡°íšŒ (ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì‚¬ìš© ì•ˆí•¨)
                let orders = [];
                
                if (typeof FirebaseService !== 'undefined' && FirebaseService.getOrderHistory) {
                    try {
                        orders = await FirebaseService.getOrderHistory(userId);
                        console.log('FirebaseService ì£¼ë¬¸ ì´ë ¥ ì¡°íšŒ ê²°ê³¼:', orders.length, 'ê±´');
                    } catch (serviceError) {
                        console.error('FirebaseService ì£¼ë¬¸ ì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨:', serviceError);
                        // Firebase ì‹¤íŒ¨ ì‹œ ë¹ˆ ë°°ì—´ ë°˜í™˜ (ë¡œì»¬ìŠ¤í† ë¦¬ì§€ í´ë°± ì œê±°)
                        orders = [];
                        console.log('Firebase ì‹¤íŒ¨ - ì£¼ë¬¸ ì´ë ¥ ì—†ìŒ');
                    }
                } else {
                    console.warn('FirebaseServiceë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ - ì£¼ë¬¸ ì´ë ¥ ì—†ìŒ');
                    orders = [];
                }
                
                console.log('ìµœì¢… ì£¼ë¬¸ ì´ë ¥:', orders);

                // ì£¼ë¬¸ì„ ë‚ ì§œ ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ìˆœ)
                if (orders && orders.length > 0) {
                    orders.sort((a, b) => {
                        let dateA, dateB;
                        
                        // A ì£¼ë¬¸ì˜ ë‚ ì§œ ì²˜ë¦¬
                        if (a.orderDate && a.orderDate.seconds) {
                            dateA = new Date(a.orderDate.seconds * 1000);
                        } else if (a.orderDate && a.orderDate.toDate) {
                            dateA = a.orderDate.toDate();
                        } else if (a.orderDate) {
                            dateA = new Date(a.orderDate);
                        } else if (a.createdAt) {
                            dateA = new Date(a.createdAt);
                        } else {
                            dateA = new Date(0);
                        }
                        
                        // B ì£¼ë¬¸ì˜ ë‚ ì§œ ì²˜ë¦¬
                        if (b.orderDate && b.orderDate.seconds) {
                            dateB = new Date(b.orderDate.seconds * 1000);
                        } else if (b.orderDate && b.orderDate.toDate) {
                            dateB = b.orderDate.toDate();
                        } else if (b.orderDate) {
                            dateB = new Date(b.orderDate);
                        } else if (b.createdAt) {
                            dateB = new Date(b.createdAt);
                        } else {
                            dateB = new Date(0);
                        }
                        
                        // ìµœì‹ ìˆœ ì •ë ¬ (ë‚´ë¦¼ì°¨ìˆœ)
                        return dateB.getTime() - dateA.getTime();
                    });
                    
                    console.log('ì£¼ë¬¸ ì´ë ¥ ìµœì‹ ìˆœ ì •ë ¬ ì™„ë£Œ:', orders.length, 'ê±´');
                }

                if (!orders || orders.length === 0) {
                    // ì£¼ë¬¸ ì´ë ¥ì´ ì—†ëŠ” ê²½ìš° (ì‹ ê·œ ì‚¬ìš©ì)
                    console.log('ì£¼ë¬¸ ì´ë ¥ì´ ì—†ìŒ - ì‹ ê·œ ì‚¬ìš©ì ë˜ëŠ” ì£¼ë¬¸ ì—†ìŒ');
                    ordersContainer.innerHTML = `
                        <div class="text-center py-4">
                            <p class="japanese-text">æ³¨æ–‡å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    `;
                    return;
                }
                
                // ì£¼ë¬¸ì´ ìˆëŠ” ê²½ìš° ê³„ì† ì§„í–‰

                // ì£¼ë¬¸ ì´ë ¥ HTML ìƒì„±
                let ordersHtml = '';
                orders.forEach(order => {
                    // ì£¼ë¬¸ ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ë¡œ ì €ì¥ (ì˜ìˆ˜ì¦ ë‹¤ìš´ë¡œë“œìš©)
                    const orderKey = `orderData_${order.id || order.orderId}`;
                    window[orderKey] = order;
                    console.log('ì£¼ë¬¸ ë°ì´í„° ì „ì—­ ë³€ìˆ˜ ì €ì¥:', orderKey, order);

                    // ë‚ ì§œ í˜•ì‹ ì²˜ë¦¬ (ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›)
                    let orderDate;
                    if (order.orderDate && order.orderDate.seconds) {
                        // Firestore Timestamp
                        orderDate = new Date(order.orderDate.seconds * 1000);
                    } else if (order.orderDate && order.orderDate.toDate) {
                        // Firestore Timestamp ê°ì²´
                        orderDate = order.orderDate.toDate();
                    } else if (order.orderDate) {
                        // ì¼ë°˜ Date ë¬¸ìì—´
                        orderDate = new Date(order.orderDate);
                    } else if (order.createdAt) {
                        // createdAt ì‚¬ìš© (í´ë°±)
                        orderDate = new Date(order.createdAt);
                    } else {
                        // ë‚ ì§œ ì •ë³´ê°€ ì—†ëŠ” ê²½ìš°
                        orderDate = new Date();
                    }

                    const formattedDate = orderDate.toLocaleDateString('ja-JP', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    // ì£¼ë¬¸ ì´ì•¡ ê³„ì‚° (ìƒí’ˆ ê°€ê²©ì€ ì´ë¯¸ ì†Œë¹„ì„¸ í¬í•¨)
                    const totalWithTax = order.items.reduce((total, item) => total + (item.price * item.quantity), 0);
                    const subtotal = Math.floor(totalWithTax / 1.1); // ì„¸ì „ ê°€ê²©
                    const tax = totalWithTax - subtotal; // ì†Œë¹„ì„¸
                    const shippingFee = totalWithTax >= 3000 ? 0 : 500; // ì„¸í¬í•¨ ê°€ê²© ê¸°ì¤€
                    
                    // í¬ì¸íŠ¸ ì •ë³´ (Firebaseì—ì„œ ì €ì¥ëœ ë°ì´í„° ì‚¬ìš©)
                    const usedPoints = order.usedPoints || order.pointDiscount || 0;
                    const earnedPoints = order.earnedPoints || Math.floor(subtotal * 0.03);
                    
                    // ìµœì¢… ê²°ì œ ê¸ˆì•¡ ê³„ì‚°
                    const grossTotal = totalWithTax + shippingFee; // ì´ê¸ˆì•¡ (ì„¸ê¸ˆ+ë°°ì†¡ë¹„ í¬í•¨)
                    const finalTotal = order.totalAmount || (grossTotal - usedPoints); // ì‹¤ì œ ê²°ì œê¸ˆì•¡

                    ordersHtml += `
                        <div class="order-item mb-4">
                            <div class="card">
                                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                                    <span class="japanese-text">
                                        <i class="fas fa-shopping-bag me-2"></i>æ³¨æ–‡ç•ªå·: ${order.id || order.orderId || 'N/A'}
                                    </span>
                                    <span class="japanese-text">${formattedDate}</span>
                                </div>
                                <div class="card-body">
                                    <div class="order-items mb-3">
                                        ${order.items.map(item => `
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <div>
                                                    <div class="japanese-heading">${item.name}</div>
                                                    <small class="text-muted japanese-text">${item.brand} Ã— ${item.quantity}</small>
                                                </div>
                                                <div class="japanese-text">Â¥${(item.price * item.quantity).toLocaleString()}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div class="order-summary bg-light p-3 rounded">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="japanese-text">å•†å“åˆè¨ˆ:</span>
                                            <span>Â¥${subtotal.toLocaleString()}</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="japanese-text">é…é€æ–™:</span>
                                            <span>${shippingFee === 0 ? 'ç„¡æ–™' : 'Â¥' + shippingFee.toLocaleString()}</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="japanese-text">æ¶ˆè²»ç¨:</span>
                                            <span>Â¥${tax.toLocaleString()}</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="japanese-text">ç·é¡:</span>
                                            <span>Â¥${grossTotal.toLocaleString()}</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="japanese-text text-dark">ãƒã‚¤ãƒ³ãƒˆä½¿ç”¨:</span>
                                            <span class="text-dark">${usedPoints > 0 ? '-Â¥' + usedPoints.toLocaleString() : 'Â¥0'}</span>
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between mb-3">
                                            <strong class="japanese-text">æ”¯æ‰•é¡:</strong>
                                            <strong>Â¥${finalTotal.toLocaleString()}</strong>
                                        </div>
                                        ${earnedPoints > 0 ? `
                                        <div class="d-flex justify-content-between">
                                            <span class="japanese-text text-muted"><small>ç²å¾—ãƒã‚¤ãƒ³ãƒˆ:</small></span>
                                            <span class="text-muted"><small>${earnedPoints}pt</small></span>
                                        </div>
                                        ` : ''}
                                        
                                    </div>
                                </div>
                                <div class="card-footer bg-light">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="japanese-text">
                                            <i class="fas fa-map-marker-alt me-2"></i>é…é€å…ˆ:
                                            ${order.shipping?.prefecture || ''} ${order.shipping?.city || ''}
                                        </span>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="order-status ${getStatusClass(order.status)} japanese-text">
                                                ${getStatusText(order.status)}
                                            </span>
                                            ${order.status === 'completed' ? `
                                                <button class="btn btn-sm btn-outline-dark" onclick="downloadReceiptFromOrder('${order.id || order.orderId}')" title="é ˜åæ›¸ã‚’è¡¨ç¤ºãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
                                                    <i class="fas fa-receipt me-1"></i>é ˜åæ›¸
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                ordersContainer.innerHTML = ordersHtml;

            } catch (error) {
                console.error('ì£¼ë¬¸ ì´ë ¥ ë¡œë“œ ì‹¤íŒ¨:', error);
                ordersContainer.innerHTML = `
                    <div class="alert alert-danger japanese-text" role="alert">
                        <i class="fas fa-exclamation-circle me-2"></i>æ³¨æ–‡å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚
                        <br>
                        <small class="text-muted">${error.message}</small>
                    </div>
                `;
            }
        }
        
        // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì£¼ë¬¸ ì´ë ¥ ì¡°íšŒ í•¨ìˆ˜ (ì‚¬ìš© ì•ˆí•¨ - Firebase ì „ìš©)
        function getOrderHistoryDirectly(userId) {
            console.warn('getOrderHistoryDirectly í•¨ìˆ˜ëŠ” ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Firebase ì „ìš©ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
            return []; // í•­ìƒ ë¹ˆ ë°°ì—´ ë°˜í™˜
        }

        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ (Firebase ì „ìš©)
        function getLoginStatus() {
            try {
                // Firebaseì—ì„œ í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì í™•ì¸
                if (typeof firebase !== 'undefined' && 
                    firebase.auth && 
                    firebase.apps && 
                    firebase.apps.length > 0 &&
                    firebase.apps[0].name === '[DEFAULT]') {
                    
                    const user = firebase.auth().currentUser;
                    if (user && user.email) {
                        return {
                            email: user.email,
                            uid: user.uid,
                            name: user.displayName || user.email.split('@')[0]
                        };
                    }
                }
                return null;
            } catch (error) {
                console.error('Firebase ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
                return null;
            }
        }

        // ì‚¬ìš©ì ë°ì´í„° ê´€ë¦¬ í•¨ìˆ˜ - Firebase ì „ìš© ì‹œìŠ¤í…œ

        function getCurrentUser() {
            console.log('ğŸ” profile.html getCurrentUser í˜¸ì¶œ');
            
            // Firebase ì‚¬ìš©ìë§Œ í™•ì¸ (ì•ˆì „í•œ ë°©ì‹)
            try {
                // Firebase ê¸°ë³¸ ê°ì²´ í™•ì¸
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    const firebaseUser = firebase.auth().currentUser;
                    console.log('ğŸ” profile.html Firebase currentUser:', firebaseUser ? firebaseUser.email : 'null');
                    
                    if (firebaseUser) {
                        console.log('âœ… profile.html Firebase ì‚¬ìš©ì í™•ì¸ë¨:', firebaseUser.email);
                        return firebaseUser;
                    } else {
                        console.log('âŒ profile.html Firebase ì‚¬ìš©ì ì—†ìŒ (ë¡œê·¸ì•„ì›ƒ ìƒíƒœ ë˜ëŠ” ì¸ì¦ ìƒíƒœ ë³µì› ì¤‘)');
                    }
                } else {
                    console.log('âŒ profile.html Firebase Auth ì‚¬ìš© ë¶ˆê°€ëŠ¥ (Firebase ë¯¸ì´ˆê¸°í™”)');
                }
            } catch (error) {
                console.warn('profile.html Firebase ì‚¬ìš©ì í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
            }
            
            console.log('âŒ profile.html ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì—†ìŒ');
            return null;
        }

        async function updateCurrentUser(updatedData) {
            const loginStatus = getLoginStatus();
            if (!loginStatus) return false;

            try {
                // Firebase Firestoreì— ì‚¬ìš©ì ë°ì´í„° ì—…ë°ì´íŠ¸
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    await firebase.firestore().collection('users').doc(loginStatus.email).update({
                        ...updatedData,
                        updatedAt: new Date().toISOString()
                    });
                    console.log('Firebase ì‚¬ìš©ì ë°ì´í„° ì—…ë°ì´íŠ¸ ì„±ê³µ');
                    return true;
                }
            } catch (error) {
                console.error('Firebase ì‚¬ìš©ì ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            }
            
            return false;
        }

        // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜ (ì¹´íŠ¸ ì •ë³´ ìœ ì§€) - ëª¨ë°”ì¼/ì›¹ í˜¸í™˜
        async function logout() {
            try {
                console.log('=== profile.html ë¡œê·¸ì•„ì›ƒ ì‹œì‘ (ì¹´íŠ¸ ì •ë³´ ìœ ì§€) - ëª¨ë°”ì¼/ì›¹ í˜¸í™˜ ===');
                
                // Firebase Auth ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ ì¼ì‹œ ì¤‘ë‹¨ (ëª¨ë°”ì¼ì—ì„œ ì¤‘ìš”)
                if (window.profileAuthStateUnsubscribe) {
                    window.profileAuthStateUnsubscribe();
                    window.profileAuthStateUnsubscribe = null;
                    console.log('âœ… Firebase Auth ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ ì¤‘ë‹¨');
                }
                
                // Firebase ë¡œê·¸ì•„ì›ƒ
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    await firebase.auth().signOut();
                    console.log('âœ… Firebase ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
                }
                
                // ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™” (ì¹´íŠ¸ ì •ë³´ëŠ” ìœ ì§€)
                profileUser = null;
                pointsPageUser = null;
                console.log('âœ… ì‚¬ìš©ì ì •ë³´ ì´ˆê¸°í™” ì™„ë£Œ');
                
                // ë¡œê·¸ì¸ ê´€ë ¨ localStorage ì™„ì „ ì •ë¦¬ (ëª¨ë°”ì¼ í˜¸í™˜)
                const loginKeys = [
                    'aetherLoginStatus', 'aetherLogin', 'aetherUser', 'aetherUserInfo',
                    'aetherAuthToken', 'aetherSession', 'aetherRemember'
                ];
                
                loginKeys.forEach(key => {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key);
                });
                
                // ëª¨ë“  aether ê´€ë ¨ í‚¤ ì¤‘ ë¡œê·¸ì¸ ê´€ë ¨ë§Œ ì œê±° (ì¹´íŠ¸ëŠ” ìœ ì§€)
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('aether') && 
                        (key.includes('Login') || key.includes('Auth') || key.includes('User') || key.includes('Session'))) {
                        localStorage.removeItem(key);
                    }
                });
                
                Object.keys(sessionStorage).forEach(key => {
                    if (key.startsWith('aether') && 
                        (key.includes('Login') || key.includes('Auth') || key.includes('User') || key.includes('Session'))) {
                        sessionStorage.removeItem(key);
                    }
                });
                
                console.log('âœ… ë¡œê·¸ì¸ ê´€ë ¨ localStorage/sessionStorage ì™„ì „ ì •ë¦¬ ì™„ë£Œ');
                
                // ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € ìºì‹œ ì •ë¦¬ (ê°€ëŠ¥í•œ ê²½ìš°)
                if ('caches' in window) {
                    try {
                        const cacheNames = await caches.keys();
                        for (const cacheName of cacheNames) {
                            if (cacheName.includes('aether') || cacheName.includes('auth')) {
                                await caches.delete(cacheName);
                                console.log(`âœ… ìºì‹œ ì‚­ì œ: ${cacheName}`);
                            }
                        }
                    } catch (cacheError) {
                        console.log('âš ï¸ ìºì‹œ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜ (ë¬´ì‹œ ê°€ëŠ¥):', cacheError);
                    }
                }
                
                // ì‚¬ìš©ì ë©”ë‰´ ì§ì ‘ ì—…ë°ì´íŠ¸ (auth-utils.js í˜¸ì¶œ ë°©ì§€)
                updateUserMenuDirectly();
                console.log('âœ… ì‚¬ìš©ì ë©”ë‰´ ì§ì ‘ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                
                // ì¹´íŠ¸ ê°œìˆ˜ ì—…ë°ì´íŠ¸ (ë¡œê·¸ì•„ì›ƒ ìƒíƒœì´ë¯€ë¡œ 0ìœ¼ë¡œ í‘œì‹œ)
                updateCartCount();
                console.log('âœ… ì¹´íŠ¸ ê°œìˆ˜ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                
                // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
                if (typeof window.showToast === 'function') {
                    window.showToast('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚', 'success', 2000);
                } else {
                    alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚');
                }
                
                console.log('âœ… profile.html ë¡œê·¸ì•„ì›ƒ ì„±ê³µ (ì¹´íŠ¸ ì •ë³´ ìœ ì§€) - ëª¨ë°”ì¼/ì›¹ í˜¸í™˜');
                
                // ê°•ì œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ê³¼ í•¨ê»˜ í™ˆí˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (ëª¨ë°”ì¼ì—ì„œ í™•ì‹¤í•œ ë¡œê·¸ì•„ì›ƒ)
                setTimeout(() => {
                    // ëª¨ë°”ì¼ì—ì„œ í™•ì‹¤í•œ ë¡œê·¸ì•„ì›ƒì„ ìœ„í•´ ê°•ì œ ìƒˆë¡œê³ ì¹¨
                    window.location.replace('index.html');
                }, 1000);
                
            } catch (error) {
                console.error('âŒ profile.html ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜:', error);
                
                // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ê¸°ë³¸ ì •ë¦¬ ì‘ì—… ìˆ˜í–‰
                profileUser = null;
                pointsPageUser = null;
                
                // Firebase Auth ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ ì¤‘ë‹¨
                if (window.profileAuthStateUnsubscribe) {
                    window.profileAuthStateUnsubscribe();
                    window.profileAuthStateUnsubscribe = null;
                }
                
                // ë¡œê·¸ì¸ ê´€ë ¨ localStorage ì •ë¦¬
                const loginKeys = [
                    'aetherLoginStatus', 'aetherLogin', 'aetherUser', 'aetherUserInfo',
                    'aetherAuthToken', 'aetherSession', 'aetherRemember'
                ];
                
                loginKeys.forEach(key => {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key);
                });
                
                // ì‚¬ìš©ì ë©”ë‰´ ì§ì ‘ ì—…ë°ì´íŠ¸
                updateUserMenuDirectly();
                
                updateCartCount();
                
                if (typeof window.showToast === 'function') {
                    window.showToast('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚', 'success', 2000);
                } else {
                    alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚');
                }
                
                // ê°•ì œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ê³¼ í•¨ê»˜ í™ˆí˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                setTimeout(() => {
                    window.location.replace('index.html');
                }, 1000);
            }
        }
        
        // ì‚¬ìš©ì ë©”ë‰´ ì§ì ‘ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (auth-utils.js í˜¸ì¶œ ë°©ì§€) - ëª¨ë°”ì¼/ì›¹ í˜¸í™˜
        function updateUserMenuDirectly() {
            try {
                console.log('ğŸ”§ profile.html ì‚¬ìš©ì ë©”ë‰´ ì§ì ‘ ì—…ë°ì´íŠ¸ ì‹œì‘ - ëª¨ë°”ì¼/ì›¹ í˜¸í™˜');
                
                // í˜„ì¬ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
                const currentUser = getCurrentUser();
                const isLoggedIn = currentUser !== null;
                
                console.log('ğŸ” í˜„ì¬ ë¡œê·¸ì¸ ìƒíƒœ:', isLoggedIn ? 'ë¡œê·¸ì¸ë¨' : 'ë¡œê·¸ì•„ì›ƒë¨');
                
                // ë©”ë‰´ ìš”ì†Œë“¤ ì •ì˜
                const logoutMenus = ['logout-menu', 'logout-menu-item', 'logout-menu-mobile', 'logout-menu-item-mobile'];
                const profileMenus = ['profile-menu', 'profile-menu-mobile', 'points-menu', 'points-menu-mobile'];
                const loginMenus = ['login-menu', 'login-menu-mobile', 'register-menu', 'register-menu-mobile'];
                
                if (isLoggedIn) {
                    // ë¡œê·¸ì¸ ìƒíƒœ: ë¡œê·¸ì¸ ë©”ë‰´ ìˆ¨ê¸°ê¸°, ë¡œê·¸ì•„ì›ƒ/í”„ë¡œí•„ ë©”ë‰´ í‘œì‹œ
                    console.log('ğŸ”§ ë¡œê·¸ì¸ ìƒíƒœ - ë©”ë‰´ ì—…ë°ì´íŠ¸');
                    
                    // ë¡œê·¸ì¸ ë©”ë‰´ ìˆ¨ê¸°ê¸°
                    loginMenus.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'none';
                            console.log(`âœ… ${id} ìˆ¨ê¸°ê¸° ì™„ë£Œ`);
                        }
                    });
                    
                    // ë¡œê·¸ì•„ì›ƒ ë©”ë‰´ í‘œì‹œ
                    logoutMenus.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'block';
                            console.log(`âœ… ${id} í‘œì‹œ ì™„ë£Œ`);
                        }
                    });
                    
                    // í”„ë¡œí•„ ë©”ë‰´ í‘œì‹œ
                    profileMenus.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'block';
                            console.log(`âœ… ${id} í‘œì‹œ ì™„ë£Œ`);
                        }
                    });
                    
                    // ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ
                    const userNameElement = document.getElementById('user-name');
                    if (userNameElement && currentUser.email) {
                        userNameElement.textContent = currentUser.displayName || currentUser.email.split('@')[0];
                        userNameElement.classList.remove('d-none');
                        console.log('âœ… ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ ì™„ë£Œ:', userNameElement.textContent);
                    }
                    
                } else {
                    // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ: ë¡œê·¸ì•„ì›ƒ/í”„ë¡œí•„ ë©”ë‰´ ìˆ¨ê¸°ê¸°, ë¡œê·¸ì¸ ë©”ë‰´ í‘œì‹œ
                    console.log('ğŸ”§ ë¡œê·¸ì•„ì›ƒ ìƒíƒœ - ë©”ë‰´ ì—…ë°ì´íŠ¸');
                    
                    // ë¡œê·¸ì•„ì›ƒ ë©”ë‰´ ìˆ¨ê¸°ê¸°
                    logoutMenus.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'none';
                            console.log(`âœ… ${id} ìˆ¨ê¸°ê¸° ì™„ë£Œ`);
                        }
                    });
                    
                    // í”„ë¡œí•„ ë©”ë‰´ ìˆ¨ê¸°ê¸°
                    profileMenus.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'none';
                            console.log(`âœ… ${id} ìˆ¨ê¸°ê¸° ì™„ë£Œ`);
                        }
                    });
                    
                    // ë¡œê·¸ì¸ ë©”ë‰´ í‘œì‹œ
                    loginMenus.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'block';
                            console.log(`âœ… ${id} í‘œì‹œ ì™„ë£Œ`);
                        }
                    });
                    
                    // ì‚¬ìš©ì ì´ë¦„ ìš”ì†Œ ì´ˆê¸°í™”
                    const userNameElement = document.getElementById('user-name');
                    if (userNameElement) {
                        userNameElement.textContent = '';
                        userNameElement.classList.add('d-none');
                        console.log('âœ… ì‚¬ìš©ì ì´ë¦„ ìš”ì†Œ ì´ˆê¸°í™” ì™„ë£Œ');
                    }
                }
                
                console.log('âœ… profile.html ì‚¬ìš©ì ë©”ë‰´ ì§ì ‘ ì—…ë°ì´íŠ¸ ì™„ë£Œ - ëª¨ë°”ì¼/ì›¹ í˜¸í™˜');
                
            } catch (error) {
                console.error('âŒ profile.html ì‚¬ìš©ì ë©”ë‰´ ì§ì ‘ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            }
        }

        // ì•Œë¦¼ í‘œì‹œ
        function showAlert(elementId, message, type = 'success') {
            const alertElement = document.getElementById(elementId);
            alertElement.className = 'alert alert-' + type + ' japanese-text';
            alertElement.textContent = message;
            alertElement.classList.remove('d-none');
            
            setTimeout(() => {
                alertElement.classList.add('d-none');
            }, 3000);
        }

        // í”„ë¡œí•„ í¸ì§‘ (í˜„ì¬ëŠ” íƒ­ ì „í™˜ë§Œ)
        // í”„ë¡œí•„ í¸ì§‘ ëª¨ë‹¬ í‘œì‹œ
        async function showEditProfile() {
            try {
                console.log('í”„ë¡œí•„ í¸ì§‘ ëª¨ë‹¬ ì—´ê¸°');
                
                // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
                let userData = null;
                
                // Firebase ì‚¬ìš©ì í™•ì¸
                const user = firebase.auth && firebase.auth().currentUser;
                if (user) {
                    try {
                    const userDoc = await firebase.firestore().collection('users').doc(user.email).get();
                    if (userDoc.exists) {
                            userData = userDoc.data();
                        }
                    } catch (firebaseError) {
                        console.warn('Firebase ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', firebaseError);
                    }
                }
                
                // Firebase ì „ìš©
                
                // ëª¨ë‹¬ í•„ë“œ ì±„ìš°ê¸°
                if (userData) {
                    document.getElementById('edit-name').value = userData.name || '';
                    document.getElementById('edit-email').value = userData.email || '';
                    document.getElementById('edit-phone').value = userData.phone || '';
                    // í¸ì§‘ ëª¨ë‹¬ì˜ ìƒë…„ì›”ì¼ì„ ì¼ë³¸ì–´ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                    const editBirthdate = userData.profile?.birthdate || '';
                    if (editBirthdate) {
                        const formattedEditDate = convertToJapaneseDate(editBirthdate);
                        document.getElementById('edit-birthdate').value = formattedEditDate;
                    } else {
                        document.getElementById('edit-birthdate').value = '';
                    }
                    document.getElementById('edit-gender').value = userData.profile?.gender || '';
            } else {
                    // ê¸°ë³¸ê°’ ì„¤ì •
                    document.getElementById('edit-email').value = '';
                    document.getElementById('edit-name').value = '';
                }
                
                // ëª¨ë‹¬ í‘œì‹œ
                const modal = new bootstrap.Modal(document.getElementById('profileEditModal'));
            modal.show();
                
            } catch (error) {
                console.error('í”„ë¡œí•„ í¸ì§‘ ëª¨ë‹¬ ì—´ê¸° ì˜¤ë¥˜:', error);
                alert('í”„ë¡œí•„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ê³„ì • ì‚­ì œ ëª¨ë‹¬ í‘œì‹œ
        function showDeleteAccount() {
            const modal = new bootstrap.Modal(document.getElementById('deleteAccountModal'));
            modal.show();
        }

        // ê³„ì • ì‚­ì œ í™•ì¸ ë° ì‹¤í–‰
        async function confirmDeleteAccount() {
            const password = document.getElementById('delete-password').value;
            const confirmCheckbox = document.getElementById('delete-confirm').checked;

            if (!password) {
                showDeleteAlert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'danger');
                return;
            }

            if (!confirmCheckbox) {
                showDeleteAlert('å‰Šé™¤ã®ç¢ºèªã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚', 'danger');
                return;
            }

            // ë²„íŠ¼ ë¹„í™œì„±í™”
            const deleteBtn = document.querySelector('#deleteAccountModal .btn-danger');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>å‰Šé™¤ä¸­...';

            try {
                const loginStatus = getLoginStatus();
                if (!loginStatus) {
                    showDeleteAlert('ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'danger');
                    return;
                }

                // íŒ¨ìŠ¤ì›Œë“œ ê²€ì¦
                const isValidPassword = await validatePassword(loginStatus.email, password);
                if (!isValidPassword) {
                    showDeleteAlert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚', 'danger');
                    return;
                }

                // ê³„ì • ì‚­ì œ ì‹¤í–‰ (Firebase ì „ìš©)
                let deleteResult;
                if (typeof FirebaseService !== 'undefined') {
                    deleteResult = await FirebaseService.deleteUserAccount(loginStatus.uid || loginStatus.email, loginStatus.email);
                } else {
                    console.error('âŒ Firebase Serviceë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ');
                    showDeleteAlert('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚', 'danger');
                    return;
                }

                if (deleteResult.success) {
                    showDeleteAlert('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæ­£å¸¸ã«å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™...', 'success');
                    
                    // Firebase ì „ìš© ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
                    
                    // Firebase Auth ë¡œê·¸ì•„ì›ƒ
                    if (typeof firebase !== 'undefined' && firebase.auth) {
                        try {
                            await firebase.auth().signOut();
                            console.log('Firebase Auth ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
                        } catch (signOutError) {
                            console.warn('Firebase Auth ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', signOutError);
                        }
                    }
                    
                    setTimeout(() => {
                        window.location.replace('index.html'); // replaceë¡œ ë³€ê²½í•˜ì—¬ ë’¤ë¡œê°€ê¸° ë°©ì§€
                    }, 2000);
                } else {
                    showDeleteAlert('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + deleteResult.error, 'danger');
                }
            } catch (error) {
                console.error('ê³„ì • ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
                showDeleteAlert('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'danger');
            } finally {
                // ì„±ê³µí•œ ê²½ìš°ê°€ ì•„ë‹ˆë©´ ë²„íŠ¼ ë³µì›
                setTimeout(() => {
                    if (deleteBtn.disabled) {
                        deleteBtn.disabled = false;
                        deleteBtn.innerHTML = originalText;
                    }
                }, 1000);
            }
        }

        // íŒ¨ìŠ¤ì›Œë“œ ê²€ì¦ (Firebase ì „ìš©)
        async function validatePassword(email, password) {
            try {
                // Firebase ì „ìš© íŒ¨ìŠ¤ì›Œë“œ ê²€ì¦
                if (typeof FirebaseService !== 'undefined' && FirebaseService.isFirebaseAvailable()) {
                    const result = await FirebaseService.loginUser(email, password);
                    return result.success;
                }

                console.warn('âš ï¸ Firebase Serviceë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ');
                return false;
            } catch (error) {
                console.error('âŒ íŒ¨ìŠ¤ì›Œë“œ ê²€ì¦ ì‹¤íŒ¨:', error);
                return false;
            }
        }

        // ê³„ì • ì‚­ì œ í•¨ìˆ˜ - Firebase ì „ìš© ì‹œìŠ¤í…œ

        // ì‚­ì œ ì•Œë¦¼ í‘œì‹œ
        function showDeleteAlert(message, type = 'danger') {
            const alertDiv = document.getElementById('delete-alert');
            // danger íƒ€ì…ì„ secondaryë¡œ ë³€ê²½í•˜ì—¬ ëª¨ë…¸í†¤ ìƒ‰ìƒ ì ìš©
            const alertType = type === 'danger' ? 'secondary' : type;
            alertDiv.className = 'alert alert-' + alertType + ' japanese-text';
            alertDiv.innerHTML = message;
            alertDiv.classList.remove('d-none');
            setTimeout(() => alertDiv.classList.add('d-none'), 5000);
        }

        // ì‚¬ìš©ì ë©”ë‰´ ì—…ë°ì´íŠ¸ (auth-utils.js í•¨ìˆ˜ ì‚¬ìš©)
        function updateUserMenuFromProfile() {
            console.log('í”„ë¡œí•„ í˜ì´ì§€ì—ì„œ ì‚¬ìš©ì ë©”ë‰´ ì—…ë°ì´íŠ¸ ì‹œë„');
            
            // profile.html ì „ìš© ë©”ë‰´ ì—…ë°ì´íŠ¸ ë¡œì§
            try {
                // í˜„ì¬ ì‚¬ìš©ì í™•ì¸
                const currentUser = getCurrentUser();
                if (currentUser) {
                    console.log('âœ… profile.html ì‚¬ìš©ì í™•ì¸ë¨:', currentUser.email);
                    
                    // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
                    const isAdmin = currentUser.email === 'admin7@gmail.com';
                    console.log('ê´€ë¦¬ì ê¶Œí•œ:', isAdmin);
                    
                    // ê´€ë¦¬ì ë©”ë‰´ í‘œì‹œ/ìˆ¨ê¹€
                    const adminMenu = document.getElementById('admin-menu');
                    const adminMenuMobile = document.getElementById('admin-menu-mobile');
                    
                    if (adminMenu) {
                        adminMenu.style.display = isAdmin ? 'block' : 'none';
                        console.log('ë°ìŠ¤í¬í†± ê´€ë¦¬ì ë©”ë‰´:', isAdmin ? 'í‘œì‹œ' : 'ìˆ¨ê¹€');
                    } else {
                        console.warn('admin-menu ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    }
                    
                    if (adminMenuMobile) {
                        adminMenuMobile.style.display = isAdmin ? 'block' : 'none';
                        console.log('ëª¨ë°”ì¼ ê´€ë¦¬ì ë©”ë‰´:', isAdmin ? 'í‘œì‹œ' : 'ìˆ¨ê¹€');
                    } else {
                        console.warn('admin-menu-mobile ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    }
                    
                    // ì‚¬ìš©ì ë©”ë‰´ í‘œì‹œ
                    const loginMenu = document.getElementById('login-menu');
                    const registerMenu = document.getElementById('register-menu');
                    const profileMenu = document.getElementById('profile-menu');
                    const pointsMenu = document.getElementById('points-menu');
                    const logoutMenu = document.getElementById('logout-menu');
                    const logoutMenuItem = document.getElementById('logout-menu-item');
                    
                    // ë¡œê·¸ì¸/íšŒì›ê°€ì… ë©”ë‰´ ìˆ¨ê¹€
                    if (loginMenu) loginMenu.style.display = 'none';
                    if (registerMenu) registerMenu.style.display = 'none';
                    
                    // í”„ë¡œí•„/í¬ì¸íŠ¸/ë¡œê·¸ì•„ì›ƒ ë©”ë‰´ í‘œì‹œ
                    if (profileMenu) profileMenu.style.display = 'block';
                    if (pointsMenu) pointsMenu.style.display = 'block';
                    if (logoutMenu) logoutMenu.style.display = 'block';
                    if (logoutMenuItem) logoutMenuItem.style.display = 'block';
                    
                    // ëª¨ë°”ì¼ ë©”ë‰´ë„ ë™ì¼í•˜ê²Œ ì²˜ë¦¬
                    const loginMenuMobile = document.getElementById('login-menu-mobile');
                    const registerMenuMobile = document.getElementById('register-menu-mobile');
                    const profileMenuMobile = document.getElementById('profile-menu-mobile');
                    const pointsMenuMobile = document.getElementById('points-menu-mobile');
                    const logoutMenuMobile = document.getElementById('logout-menu-mobile');
                    const logoutMenuItemMobile = document.getElementById('logout-menu-item-mobile');
                    
                    if (loginMenuMobile) loginMenuMobile.style.display = 'none';
                    if (registerMenuMobile) registerMenuMobile.style.display = 'none';
                    if (profileMenuMobile) profileMenuMobile.style.display = 'block';
                    if (pointsMenuMobile) pointsMenuMobile.style.display = 'block';
                    if (logoutMenuMobile) logoutMenuMobile.style.display = 'block';
                    if (logoutMenuItemMobile) logoutMenuItemMobile.style.display = 'block';
                    
                    console.log('âœ… profile.html ë©”ë‰´ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                } else {
                    console.log('âŒ profile.html ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì—†ìŒ');
                    
                    // ë¡œê·¸ì¸/íšŒì›ê°€ì… ë©”ë‰´ í‘œì‹œ
                    const loginMenu = document.getElementById('login-menu');
                    const registerMenu = document.getElementById('register-menu');
                    const profileMenu = document.getElementById('profile-menu');
                    const pointsMenu = document.getElementById('points-menu');
                    const logoutMenu = document.getElementById('logout-menu');
                    const logoutMenuItem = document.getElementById('logout-menu-item');
                    
                    if (loginMenu) loginMenu.style.display = 'block';
                    if (registerMenu) registerMenu.style.display = 'block';
                    if (profileMenu) profileMenu.style.display = 'none';
                    if (pointsMenu) pointsMenu.style.display = 'none';
                    if (logoutMenu) logoutMenu.style.display = 'none';
                    if (logoutMenuItem) logoutMenuItem.style.display = 'none';
                    
                    // ëª¨ë°”ì¼ ë©”ë‰´ë„ ë™ì¼í•˜ê²Œ ì²˜ë¦¬
                    const loginMenuMobile = document.getElementById('login-menu-mobile');
                    const registerMenuMobile = document.getElementById('register-menu-mobile');
                    const profileMenuMobile = document.getElementById('profile-menu-mobile');
                    const pointsMenuMobile = document.getElementById('points-menu-mobile');
                    const logoutMenuMobile = document.getElementById('logout-menu-mobile');
                    const logoutMenuItemMobile = document.getElementById('logout-menu-item-mobile');
                    
                    if (loginMenuMobile) loginMenuMobile.style.display = 'block';
                    if (registerMenuMobile) registerMenuMobile.style.display = 'block';
                    if (profileMenuMobile) profileMenuMobile.style.display = 'none';
                    if (pointsMenuMobile) pointsMenuMobile.style.display = 'none';
                    if (logoutMenuMobile) logoutMenuMobile.style.display = 'none';
                    if (logoutMenuItemMobile) logoutMenuItemMobile.style.display = 'none';
                }
            } catch (error) {
                console.error('profile.html ë©”ë‰´ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }

        // ì¹´íŠ¸ ê°œìˆ˜ ì—…ë°ì´íŠ¸ (Firebase ì „ìš©)
        async function updateCartCount() {
            console.log('ğŸ”¢ profile.html updateCartCount í˜¸ì¶œ');
            
            try {
                // í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì í™•ì¸
                const currentUser = getCurrentUser();
                if (!currentUser) {
                    console.log('ğŸ“ ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ì‚¬ìš©ì - ì¹´íŠ¸ ìˆ˜ëŸ‰ 0');
                    updateCartCountDisplay(0);
                    return;
                }
                
                console.log('âœ… profile.html ë¡œê·¸ì¸ëœ ì‚¬ìš©ì í™•ì¸ë¨:', currentUser.email);
                
                // Firebaseì—ì„œ ì¹´íŠ¸ ìˆ˜ëŸ‰ ê°€ì ¸ì˜¤ê¸°
                if (typeof firebase !== 'undefined' && firebase.firestore && firebase.apps && firebase.apps.length > 0) {
                    console.log('âœ… profile.html Firebase ì‚¬ìš© ê°€ëŠ¥, ì¹´íŠ¸ ë°ì´í„° ì¡°íšŒ ì‹œì‘');
                    const db = firebase.firestore();
                    const cartDoc = await db.collection('userCarts').doc(currentUser.email).get();
                    
                    if (cartDoc.exists) {
                        const cartData = cartDoc.data().cart || [];
                        const totalItems = cartData.reduce((total, item) => total + (item.quantity || 1), 0);
                        console.log('âœ… profile.html Firebase ì¹´íŠ¸ ìˆ˜ëŸ‰:', totalItems, 'ê°œ');
                        updateCartCountDisplay(totalItems);
                    } else {
                        console.log('ğŸ“ profile.html Firebase ì¹´íŠ¸ ì—†ìŒ - ìˆ˜ëŸ‰ 0');
                        updateCartCountDisplay(0);
                    }
                } else {
                    console.log('ğŸ“ profile.html Firebase ì‚¬ìš© ë¶ˆê°€ - ìˆ˜ëŸ‰ 0');
                    updateCartCountDisplay(0);
                }
            } catch (error) {
                console.warn('âš ï¸ profile.html ì¹´íŠ¸ ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                updateCartCountDisplay(0);
            }
        }

        // ì¹´íŠ¸ ìˆ˜ëŸ‰ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateCartCountDisplay(count) {
            // ë°ìŠ¤í¬í†±ìš© ì¥ë°”êµ¬ë‹ˆ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            const cartCountElement = document.getElementById('cart-count');
            if (cartCountElement) {
                cartCountElement.textContent = count;
                console.log('âœ… profile.html ë°ìŠ¤í¬í†± ì¹´íŠ¸ ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸:', count, 'ê°œ');
            } else {
                console.warn('âš ï¸ profile.html ë°ìŠ¤í¬í†± ì¹´íŠ¸ ì•„ì´ì½˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }
            
            // ëª¨ë°”ì¼ìš© ì¥ë°”êµ¬ë‹ˆ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            const cartCountMobileElement = document.getElementById('cart-count-mobile');
            if (cartCountMobileElement) {
                cartCountMobileElement.textContent = count;
                console.log('âœ… profile.html ëª¨ë°”ì¼ ì¹´íŠ¸ ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸:', count, 'ê°œ');
            } else {
                console.warn('âš ï¸ profile.html ëª¨ë°”ì¼ ì¹´íŠ¸ ì•„ì´ì½˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }
            
            console.log('âœ… profile.html ì¹´íŠ¸ ìˆ˜ëŸ‰ í‘œì‹œ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', count, 'ê°œ');
        }

        // í”„ë¡œí•„ í—¤ë” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateProfileHeader(userData) {
            try {
                console.log('í”„ë¡œí•„ í—¤ë” ì—…ë°ì´íŠ¸ ì‹œì‘:', userData);
                
                const displayNameEl = document.getElementById('profile-display-name');
                const displayEmailEl = document.getElementById('profile-display-email');
                
                if (userData && userData.name && userData.email) {
                    if (displayNameEl) {
                        displayNameEl.textContent = userData.name;
                        console.log('í”„ë¡œí•„ ì´ë¦„ ì—…ë°ì´íŠ¸:', userData.name);
                    }
                    
                    if (displayEmailEl) {
                        displayEmailEl.textContent = userData.email;
                        console.log('í”„ë¡œí•„ ì´ë©”ì¼ ì—…ë°ì´íŠ¸:', userData.email);
                    }
                    
                    console.log('âœ… í”„ë¡œí•„ í—¤ë” ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                } else {
                    console.log('ì‚¬ìš©ì ë°ì´í„° ì—†ìŒ - Firebase Authì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹œë„');
                    
                    // Firebase Authì—ì„œ ì§ì ‘ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    const currentUser = getCurrentUser();
                    if (currentUser) {
                        const firebaseUserData = {
                            name: currentUser.displayName || currentUser.email.split('@')[0],
                            email: currentUser.email
                        };
                        
                        if (displayNameEl) {
                            displayNameEl.textContent = firebaseUserData.name;
                        }
                        
                        if (displayEmailEl) {
                            displayEmailEl.textContent = firebaseUserData.email;
                        }
                        
                        console.log('âœ… Firebase Authì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì™€ì„œ í”„ë¡œí•„ í—¤ë” ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                    } else {
                        console.log('Firebase Authì—ì„œë„ ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ - ì¸ì¦ ìƒíƒœ í™•ì¸ ëŒ€ê¸°');
                        // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì¦‰ì‹œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ì§€ ì•Šê³  ì¸ì¦ ìƒíƒœ í™•ì¸ ëŒ€ê¸°
                    }
                }
            } catch (error) {
                console.error('í”„ë¡œí•„ í—¤ë” ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ Firebase Authì—ì„œ ì‚¬ìš©ì ì •ë³´ í™•ì¸
                const currentUser = getCurrentUser();
                if (!currentUser) {
                    console.log('ì˜¤ë¥˜ ë°œìƒ í›„ì—ë„ ì‚¬ìš©ì ì •ë³´ ì—†ìŒ - ì¸ì¦ ìƒíƒœ í™•ì¸ ëŒ€ê¸°');
                    // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì¦‰ì‹œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ì§€ ì•Šê³  ì¸ì¦ ìƒíƒœ í™•ì¸ ëŒ€ê¸°
                }
            }
        }

        // Firebase ì—°ê²° ìƒíƒœ ì²´í¬
        async function checkFirebaseStatus() {
            console.log('=== Firebase ìƒíƒœ ì²´í¬ ===');
            console.log('- firebase ê°ì²´:', typeof firebase !== 'undefined' ? 'OK' : 'MISSING');
            console.log('- firebase.auth:', typeof firebase !== 'undefined' && firebase.auth ? 'OK' : 'MISSING');
            console.log('- firebase.firestore:', typeof firebase !== 'undefined' && firebase.firestore ? 'OK' : 'MISSING');
            console.log('- FirebaseService:', typeof FirebaseService !== 'undefined' ? 'OK' : 'MISSING');
            console.log('- í˜„ì¬ ì‚¬ìš©ì:', firebase && firebase.auth ? firebase.auth().currentUser?.email || 'None' : 'Cannot check');
            
            // Firestore ì—°ê²° í…ŒìŠ¤íŠ¸
            if (typeof window.checkFirestoreConnection === 'function') {
                const isConnected = await window.checkFirestoreConnection();
                console.log('- Firestore ì—°ê²°:', isConnected ? 'OK' : 'FAILED');
                
                if (!isConnected) {
                    console.log('âš ï¸  Firestore ì—°ê²° ì‹¤íŒ¨');
                    // ì˜¤í”„ë¼ì¸ ëª¨ë“œ ë©”ì‹œì§€ ë¹„í™œì„±í™”
                    // showAlert('info-alert', 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã—ã¦ã„ã¾ã™ã€‚ä¸€éƒ¨æ©Ÿèƒ½ãŒåˆ¶é™ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚', 'warning');
                }
            }
            console.log('=======================');
        }  

        // ìš°í¸ë²ˆí˜¸ ìë™ í¬ë§·íŒ…
        document.getElementById('postal-code').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 3) {
                value = value.substring(0, 3) + '-' + value.substring(3);
            }
            e.target.value = value;
            
            // ìš°í¸ë²ˆí˜¸ê°€ ì™„ì„±ë˜ë©´(8ìë¦¬) ìë™ìœ¼ë¡œ ì£¼ì†Œ ê²€ìƒ‰
            if (value.length === 8) {
                searchAddress();
            }
        });

        // ìš°í¸ë²ˆí˜¸ë¡œ ì£¼ì†Œ ê²€ìƒ‰
        async function searchAddress() {
            const postalCodeInput = document.getElementById('postal-code');
            const searchBtn = document.getElementById('search-address-btn');
            const alertDiv = document.getElementById('address-alert');
            
            // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            const originalBtnHtml = searchBtn.innerHTML;
            searchBtn.disabled = true;
            searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                // ìš°í¸ë²ˆí˜¸ í˜•ì‹ ì •ë¦¬ (í•˜ì´í”ˆ ì œê±°)
                const postalCode = postalCodeInput.value.replace(/-/g, '');
                
                if (postalCode.length !== 7) {
                    throw new Error('éƒµä¾¿ç•ªå·ã¯7æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                }
                
                // ìš°í¸ë²ˆí˜¸ API í˜¸ì¶œ
                const response = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${postalCode}`);
                const data = await response.json();
                
                if (data.status === 200 && data.results) {
                    if (data.results.length > 0) {
                    const result = data.results[0];
                    
                        // ì£¼ì†Œ í•„ë“œì— ê°’ ì„¤ì •
                    document.getElementById('prefecture').value = result.address1;
                        document.getElementById('city').value = result.address2;
                        document.getElementById('address1').value = result.address3;
                        
                        // ì„±ê³µ ë©”ì‹œì§€ ì œê±°
                        alertDiv.classList.add('d-none');
                } else {
                        throw new Error('è©²å½“ã™ã‚‹ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                    }
                } else {
                    throw new Error('ä½æ‰€ã®æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
            } catch (error) {
                // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                alertDiv.className = 'alert alert-danger japanese-text';
                alertDiv.textContent = error.message;
                alertDiv.classList.remove('d-none');
            } finally {
                // ë²„íŠ¼ ìƒíƒœ ë³µêµ¬
                searchBtn.disabled = false;
                searchBtn.innerHTML = originalBtnHtml;
                
                // 3ì´ˆ í›„ ì•Œë¦¼ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                setTimeout(() => {
                    alertDiv.classList.add('d-none');
                }, 3000);
            }
        }




        // í”„ë¡œí•„ ì •ë³´ ìë™ ë¡œë“œ í•¨ìˆ˜
        async function loadSavedProfileInfo() {
            try {
                // ëª¨ë°”ì¼ ê°ì§€
                const isMobile = window.innerWidth <= 768;
                console.log('ì €ì¥ëœ í”„ë¡œí•„ ì •ë³´ ë¡œë“œ ì‹œì‘');
                console.log('ğŸ“± ëª¨ë°”ì¼ ì—¬ë¶€:', isMobile);
                console.log('ğŸ“± í™”ë©´ í¬ê¸°:', window.innerWidth + 'x' + window.innerHeight);
                
                let profileData = null;
                
                // 1. Firebaseì—ì„œ ë¡œë“œ ì‹œë„ (ì•ˆì „í•œ ë°©ì‹)
                if (typeof window.FirebaseService !== 'undefined' && 
                    window.FirebaseService.isFirebaseAvailable() && 
                    typeof firebase !== 'undefined' && 
                    firebase.app && 
                    firebase.auth && 
                    firebase.firestore) {
                    try {
                        const user = firebase.auth().currentUser;
                        if (user && user.email) {
                            const userDoc = await firebase.firestore().collection('users').doc(user.email).get();
                            
                            if (userDoc.exists) {
                                profileData = userDoc.data();
                                console.log('Firebaseì—ì„œ í”„ë¡œí•„ ë¡œë“œ ì„±ê³µ');
                            }
                        }
                    } catch (firebaseError) {
                        console.warn('Firebase í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨:', firebaseError);
                    }
                } else {
                    console.log('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ');
                }
                
                // 2. Firebase ì „ìš©
                if (!profileData) {
                    console.log('âš ï¸ Firebaseì—ì„œ í”„ë¡œí•„ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                }
                
                // 3. í”„ë¡œí•„ ì •ë³´ ìë™ ì…ë ¥
                if (profileData) {
                    // ê¸°ë³¸ ì •ë³´ íƒ­ì˜ í•„ë“œë“¤ì— ìë™ ì…ë ¥
                    if (profileData.name) {
                        const profileNameField = document.getElementById('profile-name');
                        if (profileNameField && !profileNameField.value) {
                            profileNameField.value = profileData.name;
                            console.log('ê¸°ë³¸ì •ë³´ ì´ë¦„ ìë™ ì…ë ¥:', profileData.name);
                        }
                    }
                    
                    if (profileData.email) {
                        const profileEmailField = document.getElementById('profile-email');
                        if (profileEmailField && !profileEmailField.value) {
                            profileEmailField.value = profileData.email;
                            console.log('ê¸°ë³¸ì •ë³´ ì´ë©”ì¼ ìë™ ì…ë ¥:', profileData.email);
                        }
                    }
                    
                    if (profileData.phone) {
                        const profilePhoneField = document.getElementById('profile-phone');
                        if (profilePhoneField && !profilePhoneField.value) {
                            profilePhoneField.value = profileData.phone;
                            console.log('ê¸°ë³¸ì •ë³´ ì „í™”ë²ˆí˜¸ ìë™ ì…ë ¥:', profileData.phone);
                        }
                    }
                    
                    // ì €ì¥ëœ profile ë°ì´í„°ì—ì„œ ì„±ë³„, ìƒë…„ì›”ì¼ ë¡œë“œ
                    if (profileData.profile) {
                        const profile = profileData.profile;
                        
                        if (profile.gender) {
                            const genderField = document.getElementById('profile-gender');
                            if (genderField && !genderField.value) {
                                genderField.value = profile.gender;
                                console.log('ê¸°ë³¸ì •ë³´ ì„±ë³„ ìë™ ì…ë ¥:', profile.gender);
                            }
                        }
                        
                        if (profile.birthdate) {
                            const birthdateField = document.getElementById('profile-birthdate');
                            if (birthdateField && !birthdateField.value) {
                                birthdateField.value = profile.birthdate;
                                console.log('ê¸°ë³¸ì •ë³´ ìƒë…„ì›”ì¼ ìë™ ì…ë ¥:', profile.birthdate);
                            }
                        }
                    }
                    
                    // ê¸°ì¡´ í•„ë“œë“¤ë„ ìœ ì§€ (í•˜ìœ„ í˜¸í™˜ì„±)
                    if (profileData.name) {
                        const nameField = document.getElementById('full-name');
                        if (nameField && !nameField.value) nameField.value = profileData.name;
                    }
                    
                    if (profileData.phone) {
                        const phoneField = document.getElementById('phone');
                        if (phoneField && !phoneField.value) phoneField.value = profileData.phone;
                    }
                    
                    if (profileData.email) {
                        const emailField = document.getElementById('email');
                        if (emailField && !emailField.value) emailField.value = profileData.email;
                    }
                    
                    // ì£¼ì†Œ ì •ë³´ (ìµœì‹  ì£¼ë¬¸ì—ì„œ ìë™ ì…ë ¥)
                    const address = profileData.address || profileData.lastUsedAddress;
                    console.log('ğŸ” í”„ë¡œí•„ í˜ì´ì§€ ì£¼ì†Œ ì •ë³´ ë¡œë“œ:');
                    console.log('- address ê°ì²´:', address);
                    console.log('- address.postal:', address?.postal);
                    console.log('- address.postalCode:', address?.postalCode);
                    
                    if (address) {
                        const postalField = document.getElementById('postal-code');
                        const prefectureField = document.getElementById('prefecture');
                        const cityField = document.getElementById('city');
                        const address1Field = document.getElementById('address1');
                        const address2Field = document.getElementById('address2');
                        
                        if (postalField && !postalField.value) {
                            if (address.postal) {
                                postalField.value = address.postal;
                                console.log('âœ… ìš°í¸ë²ˆí˜¸ ë¡œë“œ (postal):', address.postal);
                            } else if (address.postalCode) {
                                postalField.value = address.postalCode;
                                console.log('âœ… ìš°í¸ë²ˆí˜¸ ë¡œë“œ (postalCode):', address.postalCode);
                            }
                        } else if (postalField && postalField.value) {
                            console.log('âš ï¸ ìš°í¸ë²ˆí˜¸ í•„ë“œì— ì´ë¯¸ ê°’ì´ ìˆìŒ:', postalField.value);
                        } else if (!postalField) {
                            console.log('âŒ ìš°í¸ë²ˆí˜¸ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                        }
                        if (prefectureField && !prefectureField.value && address.prefecture) prefectureField.value = address.prefecture;
                        if (cityField && !cityField.value && address.city) cityField.value = address.city;
                        if (address1Field && !address1Field.value && address.address1) address1Field.value = address.address1;
                        if (address2Field && !address2Field.value && address.address2) address2Field.value = address.address2;
                    } else {
                        console.log('âš ï¸ ì €ì¥ëœ ì£¼ì†Œ ì •ë³´ê°€ ì—†ìŒ');
                    }
                    
                    // ëª¨ë°”ì¼ì—ì„œ ìš°í¸ë²ˆí˜¸ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„
                    if (isMobile && address) {
                        console.log('ğŸ“± ëª¨ë°”ì¼ì—ì„œ ìš°í¸ë²ˆí˜¸ ì¬ì‹œë„ (2ì´ˆ í›„)');
                        setTimeout(() => {
                            const postalField = document.getElementById('postal-code');
                            if (postalField && !postalField.value) {
                                if (address.postal) {
                                    postalField.value = address.postal;
                                    console.log('ğŸ“± ëª¨ë°”ì¼ ìš°í¸ë²ˆí˜¸ ì¬ì‹œë„ ì„±ê³µ (postal):', address.postal);
                                } else if (address.postalCode) {
                                    postalField.value = address.postalCode;
                                    console.log('ğŸ“± ëª¨ë°”ì¼ ìš°í¸ë²ˆí˜¸ ì¬ì‹œë„ ì„±ê³µ (postalCode):', address.postalCode);
                                }
                            }
                        }, 2000);
                    }
                    
                    console.log('í”„ë¡œí•„ ì •ë³´ ìë™ ì…ë ¥ ì™„ë£Œ');
                    
                    // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
                    const alertDiv = document.getElementById('save-alert');
                    if (alertDiv) {
                        alertDiv.className = 'alert alert-info japanese-text';
                        alertDiv.innerHTML = '<i class="fas fa-info-circle me-2"></i>æœ€æ–°ã®æ³¨æ–‡æƒ…å ±ã‹ã‚‰ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è‡ªå‹•å…¥åŠ›ã—ã¾ã—ãŸã€‚';
                        alertDiv.classList.remove('d-none');
                        
                        // 5ì´ˆ í›„ ìë™ ìˆ¨ê¹€
            setTimeout(() => {
                            alertDiv.classList.add('d-none');
                        }, 5000);
                    }
                } else {
                    console.log('ì €ì¥ëœ í”„ë¡œí•„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤');
                }
                
            } catch (error) {
                console.error('í”„ë¡œí•„ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        // í”„ë¡œí•„ í—¤ë” ì •ë³´ ë¡œë“œ í•¨ìˆ˜
        async function loadProfileHeader() {
            try {
                console.log('í”„ë¡œí•„ í—¤ë” ì •ë³´ ë¡œë“œ ì‹œì‘');
                
                let userData = null;
                let userPoints = 0;
                
                // 1. Firebaseì—ì„œ ë¡œë“œ ì‹œë„ (ì•ˆì „í•œ ë°©ì‹)
                try {
                    if (typeof window.FirebaseService !== 'undefined' && 
                        window.FirebaseService.isFirebaseAvailable() && 
                        typeof firebase !== 'undefined' && 
                        firebase.app && 
                        firebase.auth && 
                        firebase.firestore) {
                        
                        let user = firebase.auth().currentUser;
                        
                        // Firebase Authë§Œ ì‚¬ìš©
                        if (!user) {
                            console.log('Firebase Auth currentUserê°€ null - ë¡œê·¸ì¸ í•„ìš”');
                        }
                        
                        if (user && user.email) {
                            // ì´ë©”ì¼ì„ ë¬¸ì„œ IDë¡œ ì‚¬ìš©
                            let userDoc = await firebase.firestore().collection('users').doc(user.email).get();
                            
                            if (userDoc.exists) {
                                const docData = userDoc.data();
                                userData = {
                                    name: docData.name || user.displayName || user.email.split('@')[0],
                                    email: user.email,
                                    points: docData.points || 0
                                };
                                userPoints = userData.points;
                                console.log('Firebaseì—ì„œ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì„±ê³µ:', userData);
                            } else {
                                // ë¬¸ì„œê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ ì •ë³´ë¡œ ìƒì„±
                                userData = {
                                    name: user.displayName || user.email.split('@')[0],
                                    email: user.email,
                                    points: 0
                                };
                                console.log('Firebase ì‚¬ìš©ì ë¬¸ì„œ ì—†ìŒ, ê¸°ë³¸ ì •ë³´ ì‚¬ìš©:', userData);
                            }
                        }
                    } else {
                        console.log('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ');
                    }
                } catch (firebaseError) {
                    console.warn('Firebase ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', firebaseError);
                }
                
                // 2. Firebase ì „ìš©
                if (!userData) {
                    console.log('âš ï¸ Firebaseì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                }
                
                // 3. í”„ë¡œí•„ í—¤ë” ì—…ë°ì´íŠ¸
                if (userData) {
                    const displayNameEl = document.getElementById('profile-display-name');
                    const displayEmailEl = document.getElementById('profile-display-email');
                    
                    // ì¤‘ë³µ ì œê±°ë¨ - updateProfileHeader í•¨ìˆ˜ ì‚¬ìš©
                    console.log('í”„ë¡œí•„ í—¤ë” ì—…ë°ì´íŠ¸ ì™„ë£Œ (ì¤‘ë³µ ì œê±°ë¨)');
                } else {
                    console.log('ì‚¬ìš©ì ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ - ê¸°ë³¸ ì •ë³´ í‘œì‹œ');
                    // ê¸°ë³¸ ì •ë³´ í‘œì‹œ
                    const displayNameEl = document.getElementById('profile-display-name');
                    const displayEmailEl = document.getElementById('profile-display-email');
                    
                    if (displayNameEl) {
                        displayNameEl.textContent = 'ã‚²ìŠ¤íŠ¸';
                    }
                    
                    if (displayEmailEl) {
                        displayEmailEl.textContent = 'Loading...';
                    }
                }
                
                
                // 5. í”„ë¡œí•„ ì‚¬ì§„ ë¡œë“œ (Firebaseì—ì„œ)
                await loadProfilePhotoFromFirebase();
                
            } catch (error) {
                console.error('í”„ë¡œí•„ í—¤ë” ë¡œë“œ ì˜¤ë¥˜:', error);
                // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ê¸°ë³¸ ì •ë³´ëŠ” í‘œì‹œ
                const displayNameEl = document.getElementById('profile-display-name');
                const displayEmailEl = document.getElementById('profile-display-email');
                
                if (displayNameEl) {
                    displayNameEl.textContent = 'ã‚²ìŠ¤íŠ¸';
                }
                
                if (displayEmailEl) {
                    displayEmailEl.textContent = 'guest@example.com';
                }
            }
        }
        

        
        // ì£¼ë¬¸ ì´ë ¥ ë¡œë“œ í•¨ìˆ˜ ì´ˆê¸°í™” (ë³‘ë ¬ ì²˜ë¦¬ ìµœì í™”)
        async function initializeProfile() {
            try {
                console.log('í”„ë¡œí•„ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
                
                // Firebase ì‚¬ìš©ì ID ì¦‰ì‹œ í™•ì¸
                let userId = null;
                try {
                    if (typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) {
                        const firebaseUser = firebase.auth().currentUser;
                        userId = firebaseUser.uid;
                        console.log('Firebase ì‚¬ìš©ì ID:', userId);
                    }
                } catch (firebaseError) {
                    console.warn('Firebase ì‚¬ìš©ì í™•ì¸ ì‹¤íŒ¨:', firebaseError);
                }
                
                // ë³‘ë ¬ë¡œ ëª¨ë“  ì‘ì—… ì‹¤í–‰ (ìˆœì°¨ ì‹¤í–‰ â†’ ë³‘ë ¬ ì‹¤í–‰)
                const initPromises = [
                    loadProfileHeader(),
                    loadProfilePhotoFromFirebase(),
                    loadSavedProfileInfo()
                ];
                
                // ì£¼ë¬¸ ì´ë ¥ ë¡œë“œ ì¶”ê°€
                if (userId) {
                    console.log('ì£¼ë¬¸ ì´ë ¥ ë¡œë“œ ì‹œì‘:', userId);
                    initPromises.push(loadOrderHistory(userId));
                } else {
                    console.log('ë¡œê·¸ì¸ ìƒíƒœ ë¶ˆëª… - ëª¨ë“  ì£¼ë¬¸ í‘œì‹œ');
                    initPromises.push(loadOrderHistory('ALL_ORDERS'));
                }
                
                // ëª¨ë“  ì‘ì—…ì„ ë³‘ë ¬ë¡œ ì‹¤í–‰
                await Promise.allSettled(initPromises);
                
                console.log('í”„ë¡œí•„ í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
                
            } catch (error) {
                console.error('í”„ë¡œí•„ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ê¸°ë³¸ ì •ë³´ëŠ” í‘œì‹œ
                try {
                    await loadProfileHeader();
                } catch (headerError) {
                    console.error('í”„ë¡œí•„ í—¤ë” ë¡œë“œ ì‹¤íŒ¨:', headerError);
                }
            }
        }
        
        // ì£¼ë¬¸ ìƒíƒœ í…ìŠ¤íŠ¸ ë³€í™˜ (ì£¼ë¬¸ ê´€ë¦¬ í˜ì´ì§€ì™€ ë™ì¼)
        function getStatusText(status) {
            const statusMap = {
                'pending': 'å‡¦ç†å¾…ã¡',
                'pending_payment': 'æ”¯æ‰•ã„å¾…ã¡',
                'processing': 'å‡¦ç†ä¸­',
                'shipping': 'é…é€ä¸­',
                'completed': 'å®Œäº†',
                'cancelled': 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
            };
            return statusMap[status] || status;
        }

        // ì£¼ë¬¸ ìƒíƒœë³„ CSS í´ë˜ìŠ¤ ë°˜í™˜
        function getStatusClass(status) {
            const statusClassMap = {
                'pending': 'status-pending',
                'pending_payment': 'status-pending_payment',
                'processing': 'status-processing',
                'shipping': 'status-shipping',
                'completed': 'status-completed',
                'cancelled': 'status-cancelled'
            };
            return statusClassMap[status] || 'status-default';
        }

        // ì˜ìˆ˜ì¦ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ í‘œì‹œ
        function downloadReceipt(orderId, orderData) {
            try {
                console.log('ì˜ìˆ˜ì¦ ë¯¸ë¦¬ë³´ê¸° ì‹œì‘:', orderId, orderData);
                
                if (!orderData) {
                    console.error('ì£¼ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤:', orderId);
                    alert('ì£¼ë¬¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // ì˜ìˆ˜ì¦ ë°ì´í„° ìƒì„±
                const receiptData = generateReceiptData(orderData);
                console.log('ì˜ìˆ˜ì¦ ë°ì´í„° ìƒì„± ì™„ë£Œ:', receiptData);
                
                // ì˜ìˆ˜ì¦ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ í‘œì‹œ
                showReceiptPreviewModal(receiptData);
                
            } catch (error) {
                console.error('ì˜ìˆ˜ì¦ ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨:', error);
                alert('ì˜ìˆ˜ì¦ ë¯¸ë¦¬ë³´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì£¼ë¬¸ IDë¡œ ì˜ìˆ˜ì¦ ë‹¤ìš´ë¡œë“œ (ì „ì—­ ë³€ìˆ˜ì—ì„œ ì£¼ë¬¸ ë°ì´í„° ì°¾ê¸°)
        function downloadReceiptFromOrder(orderId) {
            try {
                console.log('ì˜ìˆ˜ì¦ ë‹¤ìš´ë¡œë“œ ì‹œì‘ (ì£¼ë¬¸ ID):', orderId);
                
                // ì „ì—­ ë³€ìˆ˜ì—ì„œ ì£¼ë¬¸ ë°ì´í„° ì°¾ê¸°
                const orderData = window[`orderData_${orderId}`];
                
                if (!orderData) {
                    console.error('ì£¼ë¬¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', orderId);
                    console.log('ì‚¬ìš© ê°€ëŠ¥í•œ ì „ì—­ ë³€ìˆ˜ë“¤:', Object.keys(window).filter(key => key.startsWith('orderData_')));
                    alert('ì£¼ë¬¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                console.log('ì£¼ë¬¸ ë°ì´í„° ì°¾ìŒ:', orderData);
                
                // ì˜ìˆ˜ì¦ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ í‘œì‹œ
                downloadReceipt(orderId, orderData);
                
            } catch (error) {
                console.error('ì˜ìˆ˜ì¦ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('ì˜ìˆ˜ì¦ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì˜ìˆ˜ì¦ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
        function showReceiptPreviewModal(receiptData) {
            try {
                console.log('ì˜ìˆ˜ì¦ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ ì‹œì‘:', receiptData);
                
                // ì˜ìˆ˜ì¦ HTML ìƒì„±
                const receiptHTML = generateReceiptHTML(receiptData);
                console.log('ì˜ìˆ˜ì¦ HTML ìƒì„± ì™„ë£Œ, ê¸¸ì´:', receiptHTML.length);
                
                // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
                const existingModal = document.getElementById('receiptPreviewModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // ëª¨ë‹¬ HTML ìƒì„±
                const modalHTML = `
                    <div class="modal fade" id="receiptPreviewModal" tabindex="-1" aria-labelledby="receiptPreviewModalLabel" aria-hidden="true" style="z-index: 1055;">
                        <div class="modal-dialog modal-xl modal-dialog-scrollable">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title japanese-heading" id="receiptPreviewModalLabel">
                                        <i class="fas fa-receipt me-2"></i>é ˜åæ›¸ - ${receiptData.orderId}
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body p-0" style="max-height: 80vh; overflow-y: auto; text-align: center;">
                                    <div id="receipt-content" style="background: white; padding: 10px; font-family: 'Noto Sans JP', sans-serif; text-align: center; margin: 0 auto;">
                                        ${receiptHTML}
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary japanese-text" data-bs-dismiss="modal">
                                        <i class="fas fa-times me-1"></i>é–‰ã˜ã‚‹
                                    </button>
                                    <button type="button" class="btn btn-dark japanese-text" onclick="downloadReceiptPDF('${receiptData.orderId}')">
                                        <i class="fas fa-download me-1"></i>PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // ëª¨ë‹¬ HTML ì¶”ê°€
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                console.log('ëª¨ë‹¬ HTML ì¶”ê°€ ì™„ë£Œ');
                
                // ëª¨ë‹¬ í‘œì‹œ
                const modalElement = document.getElementById('receiptPreviewModal');
                if (modalElement) {
                    const modal = new bootstrap.Modal(modalElement, {
                        backdrop: true,
                        keyboard: true,
                        focus: true
                    });
                    
                    // ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                    modalElement.addEventListener('shown.bs.modal', function () {
                        console.log('ëª¨ë‹¬ í‘œì‹œ ì™„ë£Œ');
                    });
                    
                    modalElement.addEventListener('hidden.bs.modal', function () {
                        console.log('ëª¨ë‹¬ ìˆ¨ê¹€ ì™„ë£Œ');
                        modalElement.remove();
                    });
                    
                    // ëª¨ë‹¬ í‘œì‹œ
                    modal.show();
                    console.log('ëª¨ë‹¬ í‘œì‹œ ëª…ë ¹ ì™„ë£Œ');
                } else {
                    console.error('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
            } catch (error) {
                console.error('ì˜ìˆ˜ì¦ ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ ì˜¤ë¥˜:', error);
                alert('ì˜ìˆ˜ì¦ ë¯¸ë¦¬ë³´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ëª¨ë‹¬ì—ì„œ PDF ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
        function downloadReceiptPDF(orderId) {
            try {
                console.log('ëª¨ë‹¬ì—ì„œ PDF ë‹¤ìš´ë¡œë“œ ì‹œì‘:', orderId);
                
                // html2pdf ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
                if (typeof html2pdf === 'undefined') {
                    console.log('html2pdf ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì¤‘...');
                    
                    // html2pdf ë¼ì´ë¸ŒëŸ¬ë¦¬ ë™ì  ë¡œë“œ
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
                    script.onload = () => {
                        console.log('html2pdf ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ');
                        // ì•½ê°„ì˜ ì§€ì—° í›„ ì‹¤í–‰
                        setTimeout(() => {
                            executePDFDownload(orderId);
                        }, 200);
                    };
                    script.onerror = () => {
                        console.error('html2pdf ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨');
                        alert('PDF ìƒì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¸ì‡„ ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                    };
                    document.head.appendChild(script);
                } else {
                    console.log('html2pdf ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ë¯¸ ë¡œë“œë¨');
                    executePDFDownload(orderId);
                }
                
            } catch (error) {
                console.error('PDF ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('PDF ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì‹¤ì œ PDF ë‹¤ìš´ë¡œë“œ ì‹¤í–‰ í•¨ìˆ˜
        function executePDFDownload(orderId) {
            try {
                console.log('PDF ë‹¤ìš´ë¡œë“œ ì‹¤í–‰:', orderId);
                
                // ëª¨ë‹¬ ë‚´ì˜ ì˜ìˆ˜ì¦ ë‚´ìš© í™•ì¸
                const receiptContent = document.getElementById('receipt-content');
                if (!receiptContent) {
                    console.error('ì˜ìˆ˜ì¦ ë‚´ìš©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    alert('ì˜ìˆ˜ì¦ ë‚´ìš©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                console.log('ëª¨ë‹¬ì˜ receipt-content ìš”ì†Œ í™•ì¸ë¨');
                console.log('ì˜ìˆ˜ì¦ ë‚´ìš© ê¸¸ì´:', receiptContent.innerHTML.length);
                
                // ëª¨ë‹¬ì˜ ì‹¤ì œ ë Œë”ë§ëœ ìš”ì†Œë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ì—¬ PDF ìƒì„±
                createReceiptPDF('', orderId); // HTMLì€ ëª¨ë‹¬ì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´
                
            } catch (error) {
                console.error('PDF ë‹¤ìš´ë¡œë“œ ì‹¤í–‰ ì‹¤íŒ¨:', error);
                alert('PDF ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // PDF ìƒì„± í•¨ìˆ˜
        function generateReceiptPDF(receiptHTML, orderId) {
            try {
                console.log('PDF ìƒì„± í•¨ìˆ˜ í˜¸ì¶œ:', orderId);
                
                // html2pdf ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                if (typeof html2pdf === 'undefined') {
                    console.log('html2pdf ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì¤‘...');
                    
                    // html2pdf ë¼ì´ë¸ŒëŸ¬ë¦¬ ë™ì  ë¡œë“œ
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
                    script.onload = () => {
                        console.log('html2pdf ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ');
                        // ì•½ê°„ì˜ ì§€ì—° í›„ ì‹¤í–‰ (ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ˆê¸°í™” ëŒ€ê¸°)
                        setTimeout(() => {
                            createReceiptPDF(receiptHTML, orderId);
                        }, 100);
                    };
                    script.onerror = () => {
                        console.error('html2pdf ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨');
                        alert('PDF ìƒì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¸ì‡„ ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                    };
                    document.head.appendChild(script);
                } else {
                    console.log('html2pdf ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ë¯¸ ë¡œë“œë¨');
                    createReceiptPDF(receiptHTML, orderId);
                }
            } catch (error) {
                console.error('PDF ìƒì„± ì‹¤íŒ¨:', error);
                alert('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì¸ì‡„ ëŒ€í™”ìƒì ì—´ê¸° í•¨ìˆ˜
        function openPrintDialog(receiptHTML) {
            try {
                console.log('ì¸ì‡„ ëŒ€í™”ìƒì ì—´ê¸°');
                
                // ìƒˆ ì°½ ì—´ê¸°
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                if (printWindow) {
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>é ˜åæ›¸</title>
                            <style>
                                body { margin: 0; padding: 0; }
                                @media print {
                                    body { margin: 0; padding: 0; }
                                    @page { size: A4; margin: 8mm; }
                                }
                            </style>
                        </head>
                        <body>
                            ${receiptHTML}
                        </body>
                        </html>
                    `);
                    
                    printWindow.document.close();
                    
                    // ì¸ì‡„ ëŒ€í™”ìƒì ì—´ê¸°
                    setTimeout(() => {
                        printWindow.print();
                        printWindow.close();
                    }, 500);
                } else {
                    alert('íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—… ì°¨ë‹¨ì„ í•´ì œí•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            } catch (error) {
                console.error('ì¸ì‡„ ëŒ€í™”ìƒì ì—´ê¸° ì‹¤íŒ¨:', error);
                alert('ì¸ì‡„ ëŒ€í™”ìƒìë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // ì‹¤ì œ PDF ìƒì„± í•¨ìˆ˜
        function createReceiptPDF(receiptHTML, orderId) {
            try {
                console.log('PDF ìƒì„± ì‹œì‘:', orderId);
                console.log('ì˜ìˆ˜ì¦ HTML ê¸¸ì´:', receiptHTML.length);
                
                // html2pdf ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¬í™•ì¸
                if (typeof html2pdf === 'undefined') {
                    console.error('html2pdf ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                    alert('PDF ìƒì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                console.log('html2pdf ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸ë¨');
                
                // ëª¨ë‹¬ì—ì„œ ì‹¤ì œ ë Œë”ë§ëœ ìš”ì†Œë¥¼ ì‚¬ìš©
                const receiptContent = document.getElementById('receipt-content');
                let sourceElement;
                
                if (receiptContent && receiptContent.innerHTML.trim() !== '') {
                    console.log('ëª¨ë‹¬ì˜ receipt-content ì‚¬ìš©');
                    console.log('ëª¨ë‹¬ ë‚´ìš© í™•ì¸:', receiptContent.innerHTML.substring(0, 200) + '...');
                    
                    // PDF ìƒì„±ì„ ìœ„í•´ ìŠ¤íƒ€ì¼ ê°•ì œ ì ìš©
                    receiptContent.style.textAlign = 'center';
                    receiptContent.style.margin = '0 auto';
                    receiptContent.style.width = '185mm';
                    receiptContent.style.maxWidth = '185mm';
                    
                    sourceElement = receiptContent;
                } else {
                    console.log('ì„ì‹œ div ìƒì„±');
                    // ì„ì‹œ div ìƒì„±
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = receiptHTML;
                    tempDiv.style.position = 'absolute';
                    tempDiv.style.left = '-9999px';
                    tempDiv.style.top = '-9999px';
                    tempDiv.style.width = '185mm'; // 190mm â†’ 185mm
                    tempDiv.style.maxWidth = '185mm';
                    tempDiv.style.background = 'white';
                    tempDiv.style.overflow = 'visible';
                    tempDiv.style.zIndex = '-1';
                    tempDiv.style.textAlign = 'center'; // ê°€ìš´ë° ì •ë ¬
                    tempDiv.style.margin = '0 auto'; // ê°€ìš´ë° ì •ë ¬
                    document.body.appendChild(tempDiv);
                    sourceElement = tempDiv;
                }
                
                // ì†ŒìŠ¤ ìš”ì†Œì˜ ë‚´ìš© í™•ì¸
                console.log('ì†ŒìŠ¤ ìš”ì†Œ ë‚´ìš© ê¸¸ì´:', sourceElement.innerHTML.length);
                console.log('ì†ŒìŠ¤ ìš”ì†Œ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°:', sourceElement.innerHTML.substring(0, 300) + '...');
                
                console.log('PDF ìƒì„± ì˜µì…˜ ì„¤ì • ì¤‘...');
                
                const opt = {
                    margin: [10, 8, 10, 8], /* ì—¬ë°± ì¤„ì„ - ìƒí•˜ì¢Œìš° ëª¨ë‘ ì¤„ì„ */
                    filename: `é ˜åæ›¸_${orderId}.pdf`,
                    image: { type: 'jpeg', quality: 1.0 }, // ìµœê³  í™”ì§ˆ
                    html2canvas: { 
                        scale: 2.0, // ìŠ¤ì¼€ì¼ 200% (ê³ í•´ìƒë„ë¡œ ë Œë”ë§ í›„ PDFì—ì„œ ì¶•ì†Œ)
                        useCORS: true,
                        letterRendering: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff',
                        logging: true,
                        // widthì™€ height ì œê±° - scaleë¡œë§Œ í¬ê¸° ì¡°ì •
                        scrollX: 0,
                        scrollY: 0,
                        windowWidth: 680,
                        windowHeight: 1000
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait',
                        compress: true,
                        precision: 2
                    },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };
                
                console.log('html2pdf ì‹¤í–‰ ì¤‘...');
                html2pdf().set(opt).from(sourceElement).save().then(() => {
                    console.log('PDF ìƒì„± ì™„ë£Œ');
                    // ì„ì‹œ divê°€ ìƒì„±ëœ ê²½ìš°ì—ë§Œ ì œê±°
                    if (sourceElement.parentNode && sourceElement.parentNode === document.body) {
                        document.body.removeChild(sourceElement);
                    }
                }).catch((error) => {
                    console.error('PDF ìƒì„± ì‹¤íŒ¨:', error);
                    console.log('PDF ìƒì„± ì‹¤íŒ¨, ì¸ì‡„ ëŒ€ì•ˆ ì œê³µ');
                    if (confirm('PDF ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸ì‡„ ëŒ€í™”ìƒìë¥¼ ì—´ê¹Œìš”?')) {
                        openPrintDialog(sourceElement.innerHTML);
                    }
                    // ì„ì‹œ divê°€ ìƒì„±ëœ ê²½ìš°ì—ë§Œ ì œê±°
                    if (sourceElement.parentNode && sourceElement.parentNode === document.body) {
                        document.body.removeChild(sourceElement);
                    }
                });
                
            } catch (error) {
                console.error('PDF ìƒì„± ì‹¤íŒ¨:', error);
                alert('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì˜ìˆ˜ì¦ ë°ì´í„° ìƒì„±
        function generateReceiptData(orderData) {
            const orderDate = orderData.orderDate?.seconds ? 
                new Date(orderData.orderDate.seconds * 1000) : 
                new Date(orderData.orderDate || orderData.createdAt);
            
            const subtotal = orderData.subtotal || orderData.originalAmount || 0;
            const shippingFee = orderData.shippingFee || 0;
            const usedPoints = orderData.usedPoints || orderData.pointDiscount || 0;
            const totalAmount = orderData.totalAmount || 0;
            const earnedPoints = orderData.earnedPoints || 0;
            
            // ì„¸ê¸ˆ ê³„ì‚° (ìƒí’ˆê¸ˆì•¡ + ë°°ì†¡ë¹„ì— 10% ì†Œë¹„ì„¸)
            const totalBeforeTax = subtotal + shippingFee;
            const taxAmount = Math.floor(totalBeforeTax * 0.1); // 10% ì†Œë¹„ì„¸
            const totalWithTax = totalBeforeTax + taxAmount;
            
            // ì˜ìˆ˜ì¦ ë²ˆí˜¸ ìƒì„± (ë‚ ì§œ + ì£¼ë¬¸ë²ˆí˜¸)
            const today = new Date();
            const dateStr = today.getFullYear().toString() + 
                           (today.getMonth() + 1).toString().padStart(2, '0') + 
                           today.getDate().toString().padStart(2, '0');
            const receiptNumber = `RCP-${dateStr}-${orderData.id || orderData.orderId}`;
            
            return {
                orderId: orderData.id || orderData.orderId,
                receiptNumber: receiptNumber,
                orderDate: orderDate.toLocaleString('ja-JP'),
                customerName: orderData.shipping?.name || orderData.customer?.name || 'N/A',
                customerEmail: orderData.customerEmail || orderData.userEmail || 'N/A',
                items: orderData.items || [],
                subtotal: subtotal,
                shippingFee: shippingFee,
                usedPoints: usedPoints,
                totalAmount: totalAmount,
                earnedPoints: earnedPoints,
                shippingAddress: orderData.shipping || orderData.shippingAddress || {},
                paymentMethod: orderData.paymentMethod || (orderData.payment?.method || 'N/A'),
                // ì„¸ê¸ˆ ì •ë³´ ì¶”ê°€
                totalBeforeTax: totalBeforeTax,
                taxAmount: taxAmount,
                totalWithTax: totalWithTax
            };
        }

        // ìƒˆë¡œìš´ ì˜ìˆ˜ì¦ HTML ìƒì„± (ì´ë¯¸ì§€ ê¸°ë°˜)
        function generateReceiptHTML(receiptData) {
            try {
                console.log('ìƒˆë¡œìš´ ì˜ìˆ˜ì¦ HTML ìƒì„± ì‹œì‘:', receiptData);
                
                const paymentMethodText = receiptData.paymentMethod === 'card' ? 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰' : 
                                        receiptData.paymentMethod === 'bank-transfer' ? 'éŠ€è¡ŒæŒ¯è¾¼' : 
                                        receiptData.paymentMethod;
                
                const html = `
                <div class="receipt-container">
                    <style>
                        .receipt-container {
                            font-family: 'Noto Sans JP', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif !important;
                            width: 185mm; /* 190mm â†’ 185mm (ì™„ì „ ê°€ìš´ë° ì •ë ¬ì„ ìœ„í•œ í­ ì¡°ì •) */
                            /* min-height ì œê±° - ë‚´ìš©ì— ë§ê²Œ ìë™ ì¡°ì • */
                            margin: 0 auto; /* ê°€ìš´ë° ì •ë ¬ */
                            padding: 6mm; /* 12mm â†’ 6mm (1í˜ì´ì§€ ë§ì¶”ê¸° ìœ„í•´ ì¤„ì„) */
                            background: white;
                            color: #333;
                            box-sizing: border-box;
                            position: relative;
                            display: block;
                            overflow: visible;
                            page-break-inside: avoid;
                            font-size: 0.81em; /* 19% ì¤„ì„ (5% + 5% + 10%) */
                            text-align: center; /* ì „ì²´ ë‚´ìš© ê°€ìš´ë° ì •ë ¬ */
                        }
                        
                        .receipt-container * {
                            font-family: 'Noto Sans JP', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif !important;
                            line-height: 1.2 !important; /* í–‰ê°„ ì¤„ì„ */
                        }
                        
                        .receipt-header {
                            text-align: center;
                            margin-bottom: 15px; /* 10px â†’ 15px (ì—¬ë°± ì¦ê°€) */
                            border-bottom: 2px solid #333;
                            padding-bottom: 8px; /* 10px â†’ 8px */
                            font-size: 1.05em; /* í—¤ë”ëŠ” ì›ë˜ í¬ê¸° ìœ ì§€ */
                        }
                        
                        .company-logo {
                            margin-bottom: 10px;
                        }
                        
                        .company-logo img {
                            max-height: 75px; /* 50px â†’ 75px (50% ì¦ê°€) */
                            width: auto;
                        }
                        
                        .receipt-title {
                            font-size: 24px;
                            font-weight: bold;
                            margin: 10px 0;
                        }
                        
                        .receipt-info {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 15px;
                            font-size: 10px;
                        }
                        
                        .receipt-info-left {
                            text-align: left;
                        }
                        
                        .receipt-info-right {
                            text-align: right;
                        }
                        
                        .recipient-section {
                            text-align: center; /* ê°€ìš´ë° ì •ë ¬ */
                            margin: 15px 0;
                            font-size: 16px;
                            font-weight: bold;
                        }
                        
                        .amount-section {
                            text-align: center; /* ê°€ìš´ë° ì •ë ¬ */
                            margin: 15px 0;
                            font-size: 18px;
                            font-weight: bold;
                        }
                        
                        .detail-section {
                            margin-bottom: 15px; /* 10px â†’ 15px (ì—¬ë°± ì¦ê°€) */
                        }
                        
                        .detail-section.two-column {
                            display: flex;
                            gap: 15px; /* 20px â†’ 15px */
                        }
                        
                        .detail-section.two-column .column {
                            flex: 1;
                            min-width: 0;
                        }
                        
                        .detail-title {
                            font-weight: bold;
                            margin-top: 10px; /* 20px â†’ 10px (ê°„ê²© ì¤„ì„) */
                            margin-bottom: 8px; /* 15px â†’ 8px (ê°„ê²© ì¤„ì„) */
                            padding: 4px; /* 8px â†’ 4px (íŒ¨ë”© ì¤„ì„) */
                            background-color: #f5f5f5;
                            border-left: 3px solid #333;
                            font-size: 12px;
                        }
                        
                        .detail-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 2px; /* 3px â†’ 2px */
                            padding: 1px 0; /* 2px â†’ 1px */
                            font-size: 10px;
                        }
                        
                        .items-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 15px auto; /* 8px â†’ 15px (í…Œì´ë¸” ì—¬ë°± ì¦ê°€) */
                            font-size: 1.05em; /* ìƒí’ˆëª…ì„¸ëŠ” ì›ë˜ í¬ê¸° ìœ ì§€ */
                        }
                        
                        .items-table th,
                        .items-table td {
                            border: 1px solid #ddd;
                            padding: 5px; /* 3px â†’ 5px (íŒ¨ë”© ì¦ê°€) */
                            text-align: left;
                        }
                        
                        .items-table th {
                            background-color: #f5f5f5;
                            font-weight: bold;
                        }
                        
                        .total-section {
                            margin: 15px 0;
                        }
                        
                        .total-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 5px;
                            padding: 3px 0;
                            font-size: 10px;
                        }
                        
                        .total-final {
                            font-weight: bold;
                            font-size: 12px;
                            border-top: 2px solid #333;
                            padding-top: 5px;
                            margin-top: 5px;
                        }
                        
                        .payment-breakdown {
                            background-color: #f8f9fa;
                            padding: 8px;
                            margin: 10px 0;
                            border-radius: 3px;
                        }
                        
                        .tax-breakdown {
                            font-size: 9px;
                            color: #666;
                            margin-top: 5px;
                        }
                        
                        .disclaimer {
                            font-size: 8px;
                            color: #666;
                            margin-top: 8px; /* 15px â†’ 8px (ê°„ê²© ì¤„ì„) */
                            margin-bottom: 8px; /* 15px â†’ 8px (ê°„ê²© ì¤„ì„) */
                            padding: 4px 0; /* 8px â†’ 4px (íŒ¨ë”© ì¤„ì„) */
                            text-align: center; /* right â†’ center */
                        }
                        
                        .shipping-info {
                            background-color: #f8f9fa;
                            padding: 8px;
                            margin: 10px 0;
                            border-radius: 3px;
                        }
                        
                        @media print {
                            .receipt-container {
                                margin: 0 auto !important; /* ê°€ìš´ë° ì •ë ¬ ìœ ì§€ */
                                padding: 6mm; /* 12mm â†’ 6mm (1í˜ì´ì§€ ë§ì¶”ê¸° ìœ„í•´ ì¤„ì„) */
                                width: 185mm !important; /* 190mm â†’ 185mm (ì™„ì „ ê°€ìš´ë° ì •ë ¬ì„ ìœ„í•œ í­ ì¡°ì •) */
                                /* min-height ì œê±° - ë‚´ìš©ì— ë§ê²Œ ìë™ ì¡°ì • */
                                page-break-inside: avoid;
                                background: white !important;
                                color: black !important;
                                text-align: center !important; /* ê°€ìš´ë° ì •ë ¬ ìœ ì§€ */
                            }
                            
                            .receipt-header,
                            .detail-section,
                            .items-table {
                                page-break-inside: avoid;
                            }
                        }
                        
                        @page {
                            size: A4;
                            margin: 8mm;
                        }
                    </style>
                    
                    <div class="receipt-header">
                        <div class="company-logo">
                            <img src="assets/img/logo.png" alt="Aether Store" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div style="display: none; font-size: 24px; font-weight: bold; color: #333;">Aether Store</div>
                        </div>
                        <div class="receipt-title">é ˜åæ›¸</div>
                        <div class="receipt-info">
                            <div class="receipt-info-left">
                                <strong>é ˜åæ›¸ç•ªå·:</strong> ${receiptData.receiptNumber}<br>
                                <strong>ç™ºè¡Œæ—¥:</strong> ${new Date().toLocaleDateString('ja-JP')}
                            </div>
                            <div class="receipt-info-right">
                                <strong>æ³¨æ–‡ç•ªå·:</strong> ${receiptData.orderId}<br>
                                <strong>æ³¨æ–‡æ—¥:</strong> ${receiptData.orderDate}
                            </div>
                        </div>
                    </div>
                    
                    <div class="recipient-section">
                        ${receiptData.customerName} æ§˜
                    </div>
                    
                    <div class="amount-section">
                        <strong>${receiptData.totalWithTax.toLocaleString()}å††é ˜åã—ã¾ã—ãŸ</strong>
                    </div>
                    
                    <div class="detail-section two-column">
                        <div class="column">
                            <div class="detail-title">åˆ©ç”¨æƒ…å ±</div>
                            <div class="detail-row">
                                <span>æ³¨æ–‡ç•ªå·:</span>
                                <span>${receiptData.orderId}</span>
                            </div>
                            <div class="detail-row">
                                <span>æ³¨æ–‡æ—¥:</span>
                                <span>${receiptData.orderDate}</span>
                            </div>
                            <div class="detail-row">
                                <span>ãŠæ”¯æ‰•ã„æ–¹æ³•:</span>
                                <span>${paymentMethodText}</span>
                            </div>
                            <div class="detail-row">
                                <span>ç™ºé€æ—¥:</span>
                                <span>${new Date().toLocaleDateString('ja-JP')}</span>
                            </div>
                        </div>
                        
                        <div class="column">
                            <div class="detail-title">é ˜åè€…æƒ…å ±</div>
                            <div class="detail-row">
                                <span>é ˜åè€…:</span>
                                <span>æ ªå¼ä¼šç¤¾JAYCOS</span>
                            </div>
                            <div class="detail-row">
                                <span>ä½æ‰€:</span>
                                <span>ã€’169-0072 æ±äº¬éƒ½æ–°å®¿åŒºå¤§ä¹…ä¿2ä¸ç›®21-10 ã‚¸ãƒ¥ãƒã‚¹å¤§ä¹…ä¿ 102å·</span>
                            </div>
                            <div class="detail-row">
                                <span>é›»è©±ç•ªå·:</span>
                                <span>03.3200.5547</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section two-column">
                        <div class="column">
                            <div class="detail-title">æ³¨æ–‡åˆè¨ˆ</div>
                            <div class="detail-row">
                                <span>å•†å“å°è¨ˆ:</span>
                                <span>Â¥${receiptData.subtotal.toLocaleString()}</span>
                            </div>
                            <div class="detail-row">
                                <span>é…é€æ–™:</span>
                                <span>${receiptData.shippingFee === 0 ? 'ç„¡æ–™' : 'Â¥' + receiptData.shippingFee.toLocaleString()}</span>
                            </div>
                            <div class="detail-row">
                                <span>å°è¨ˆ:</span>
                                <span>Â¥${receiptData.totalBeforeTax.toLocaleString()}</span>
                            </div>
                            <div class="detail-row">
                                <span>æ¶ˆè²»ç¨(10%):</span>
                                <span>Â¥${receiptData.taxAmount.toLocaleString()}</span>
                            </div>
                            <div class="detail-row total-final">
                                <span>ç·åˆè¨ˆ:</span>
                                <span>Â¥${receiptData.totalWithTax.toLocaleString()}</span>
                            </div>
                            <div class="detail-row">
                                <span>æ”¯æ‰•ã„é‡‘é¡:</span>
                                <span>Â¥${(receiptData.totalWithTax - receiptData.usedPoints).toLocaleString()}</span>
                            </div>
                        </div>
                        
                        <div class="column">
                            <div class="detail-title">é…é€æƒ…å ±</div>
                            <div class="detail-row">
                                <span>é…é€æ–¹æ³•:</span>
                                <span>å®…é…ä¾¿</span>
                            </div>
                            <div class="detail-row">
                                <span>ãŠå±Šã‘å…ˆ:</span>
                                <span>${[
                                    receiptData.shippingAddress.postal || '',
                                    receiptData.shippingAddress.prefecture || '',
                                    receiptData.shippingAddress.city || '',
                                    receiptData.shippingAddress.address1 || '',
                                    receiptData.shippingAddress.address2 || ''
                                ].filter(part => part.trim() !== '').join(' ')}</span>
                            </div>
                        </div>
                    </div>
                    
                    ${receiptData.usedPoints > 0 ? `
                    <div class="payment-breakdown">
                        <div class="detail-title">æ”¯æ‰•ã„å†…è¨³</div>
                        <div class="detail-row">
                            <span>ãƒã‚¤ãƒ³ãƒˆåˆ©ç”¨:</span>
                            <span>Â¥${receiptData.usedPoints.toLocaleString()}</span>
                        </div>
                        <div class="detail-row">
                            <span>${paymentMethodText}:</span>
                            <span>Â¥${(receiptData.totalWithTax - receiptData.usedPoints).toLocaleString()}</span>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="disclaimer">
                        â€»è¡¨ç¤ºé‡‘é¡ã¯å…¨ã¦ç¨è¾¼ã§ã™<br>
                        â€»æ”¯æ‰•ã„é‡‘é¡ã¯ç·åˆè¨ˆã‹ã‚‰ãƒã‚¤ãƒ³ãƒˆã‚’é™¤ã„ãŸé‡‘é¡ã§ã™
                    </div>
                    
                    
                    <div class="detail-section">
                        <div class="detail-title">å•†å“æ˜ç´°</div>
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th>No.</th>
                                    <th>å•†å“å</th>
                                    <th>æ•°é‡</th>
                                    <th>å˜ä¾¡(ç¨è¾¼)</th>
                                    <th>ç¨ç‡</th>
                                    <th>å°è¨ˆ(ç¨è¾¼)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${receiptData.items.map((item, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${item.name}</td>
                                        <td>${item.quantity}</td>
                                        <td>Â¥${item.price.toLocaleString()}</td>
                                        <td>10%</td>
                                        <td>Â¥${(item.price * item.quantity).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="disclaimer">
                            â€»è¡¨ç¤ºé‡‘é¡ã¯å…¨ã¦ç¨è¾¼ã§ã™
                        </div>
                    </div>
                </div>
                `;
                
                console.log('ìƒˆë¡œìš´ ì˜ìˆ˜ì¦ HTML ìƒì„± ì™„ë£Œ, ê¸¸ì´:', html.length);
                return html;
                
            } catch (error) {
                console.error('ì˜ìˆ˜ì¦ HTML ìƒì„± ì˜¤ë¥˜:', error);
                return '<div class="alert alert-danger">ì˜ìˆ˜ì¦ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ë‚ ì§œ ë³€í™˜ í•¨ìˆ˜ë“¤ (ê°„ë‹¨í•œ í˜•ì‹)
        function convertToJapaneseDate(dateString) {
            if (!dateString) return '';
            
            // ISO í˜•ì‹ (YYYY-MM-DD)ì„ YYYY/MM/DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            if (dateString.includes('-')) {
                return dateString.replace(/-/g, '/');
            }
            
            return dateString; // ì´ë¯¸ ì˜¬ë°”ë¥¸ í˜•ì‹ì´ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
        }
        
        function convertFromJapaneseDate(japaneseDateString) {
            if (!japaneseDateString) return '';
            
            // YYYY/MM/DD í˜•ì‹ì„ ISO í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            if (japaneseDateString.includes('/')) {
                return japaneseDateString.replace(/\//g, '-');
            }
            
            return japaneseDateString; // ë³€í™˜ ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜
        }
        
        // í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ ê´€ë ¨ í•¨ìˆ˜ë“¤
        let isUploading = false;
        
        // í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ ì˜µì…˜ ì—´ê¸°
        function openPhotoUpload() {
            const options = document.getElementById('photo-upload-options');
            if (options.style.display === 'none') {
                options.style.display = 'block';
                // 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ìˆ¨ê¸°ê¸°
                setTimeout(() => {
                    options.style.display = 'none';
                }, 3000);
            } else {
                options.style.display = 'none';
            }
        }
        
        // ê°¤ëŸ¬ë¦¬ì—ì„œ ì‚¬ì§„ ì„ íƒ
        function selectPhotoFromGallery() {
            const input = document.getElementById('profile-photo-input');
            input.accept = 'image/*';
            input.click();
            document.getElementById('photo-upload-options').style.display = 'none';
        }
        
        // ì¹´ë©”ë¼ë¡œ ì‚¬ì§„ ì´¬ì˜
        function takePhotoWithCamera() {
            const input = document.getElementById('profile-photo-input');
            input.accept = 'image/*';
            input.capture = 'environment'; // í›„ë©´ ì¹´ë©”ë¼ ìš°ì„ 
            input.click();
            document.getElementById('photo-upload-options').style.display = 'none';
        }
        
        // ë“œë˜ê·¸ì•¤ë“œë¡­ ì´ë²¤íŠ¸ ì„¤ì •
        function setupDragAndDrop() {
            const avatarContainer = document.getElementById('profile-avatar-container');
            
            // ë“œë˜ê·¸ ì˜¤ë²„ ì´ë²¤íŠ¸
            avatarContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.add('drag-over');
            });
            
            // ë“œë˜ê·¸ ë¦¬ë¸Œ ì´ë²¤íŠ¸
            avatarContainer.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('drag-over');
            });
            
            // ë“œë¡­ ì´ë²¤íŠ¸
            avatarContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleProfilePhotoUpload({ target: { files: files } });
                }
            });
        }
        
        // Firebase Storage ì´ˆê¸°í™” ëŒ€ê¸°
        async function waitForFirebaseStorage() {
            let attempts = 0;
            const maxAttempts = 50;
            
            while (attempts < maxAttempts) {
                if (firebase && firebase.storage) {
                    console.log('Firebase Storage ì‚¬ìš© ê°€ëŠ¥');
                    return true;
                }
                console.log(`Firebase Storage ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘... (${attempts + 1}/${maxAttempts})`);
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            throw new Error('Firebase Storage ì´ˆê¸°í™” ì‹œê°„ ì´ˆê³¼');
        }
        
        // í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ ì²˜ë¦¬
        async function handleProfilePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // íŒŒì¼ í¬ê¸° ì²´í¬ (5MB ì œí•œ)
            if (file.size > 5 * 1024 * 1024) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€‚5MBä»¥ä¸‹ã®ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            // íŒŒì¼ íƒ€ì… ì²´í¬
            if (!file.type.startsWith('image/')) {
                alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            if (isUploading) return;
            isUploading = true;
            
            try {
                // Firebase Storage ì´ˆê¸°í™” ëŒ€ê¸°
                await waitForFirebaseStorage();
                
                // ì—…ë¡œë“œ ì§„í–‰ë¥  í‘œì‹œ
                showUploadProgress();
                
                // Firebase Storageì— ì—…ë¡œë“œ
                const downloadURL = await uploadProfilePhotoToFirebase(file);
                
                // í”„ë¡œí•„ ì‚¬ì§„ í‘œì‹œ
                displayProfilePhoto(downloadURL);
                
                // Firebase Firestoreì— URL ì €ì¥
                await saveProfilePhotoURL(downloadURL);
                
                console.log('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸ:', downloadURL);
                
            } catch (error) {
                console.error('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            } finally {
                isUploading = false;
                hideUploadProgress();
            }
        }
        
        // Firebase Storageì— í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ
        async function uploadProfilePhotoToFirebase(file) {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                throw new Error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“');
            }
            
            // Firebase StorageëŠ” ì´ë¯¸ waitForFirebaseStorage()ì—ì„œ í™•ì¸ë¨
            
            // íŒŒì¼ëª… ìƒì„± (ì‚¬ìš©ì ID + íƒ€ì„ìŠ¤íƒ¬í”„)
            const timestamp = Date.now();
            const fileName = `profile-photos/${currentUser.uid}_${timestamp}.jpg`;
            
            // Firebase Storage ì°¸ì¡°
            const storageRef = firebase.storage().ref(fileName);
            
            // ì´ë¯¸ì§€ ì••ì¶• ë° ì—…ë¡œë“œ
            const compressedFile = await compressImage(file);
            
            // ì—…ë¡œë“œ ì‹¤í–‰
            const uploadTask = storageRef.put(compressedFile);
            
            // ì—…ë¡œë“œ ì§„í–‰ë¥  ëª¨ë‹ˆí„°ë§
            return new Promise((resolve, reject) => {
                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        updateUploadProgress(progress);
                    },
                    (error) => {
                        reject(error);
                    },
                    async () => {
                        try {
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            resolve(downloadURL);
                        } catch (error) {
                            reject(error);
                        }
                    }
                );
            });
        }
        
        // ì´ë¯¸ì§€ ì••ì¶•
        function compressImage(file) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    // ìµœëŒ€ í¬ê¸° ì„¤ì • (400x400)
                    const maxSize = 400;
                    let { width, height } = img;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height = (height * maxSize) / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = (width * maxSize) / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // JPEGë¡œ ë³€í™˜ (í’ˆì§ˆ 0.8)
                    canvas.toBlob(resolve, 'image/jpeg', 0.8);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }
        
        // Firebase Firestoreì— í”„ë¡œí•„ ì‚¬ì§„ URL ì €ì¥
        async function saveProfilePhotoURL(photoURL) {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) return;
            
            try {
                const userRef = firebase.firestore().collection('users').doc(currentUser.email);
                await userRef.update({
                    profilePhotoURL: photoURL,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸURLã‚’Firestoreã«ä¿å­˜ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸURLã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                throw error;
            }
        }
        
        // í”„ë¡œí•„ ì‚¬ì§„ í‘œì‹œ
        function displayProfilePhoto(photoURL) {
            const photoImg = document.getElementById('profile-photo');
            const placeholder = document.getElementById('profile-photo-placeholder');
            
            if (photoURL) {
                photoImg.src = photoURL;
                photoImg.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                photoImg.style.display = 'none';
                placeholder.style.display = 'block';
            }
        }
        
        // Firebaseì—ì„œ í”„ë¡œí•„ ì‚¬ì§„ ë¡œë“œ
        async function loadProfilePhotoFromFirebase() {
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) return;
            
            try {
                const userDoc = await firebase.firestore().collection('users').doc(currentUser.email).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    if (userData.profilePhotoURL) {
                        displayProfilePhoto(userData.profilePhotoURL);
                        console.log('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸã‚’Firebaseã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                    }
                }
            } catch (error) {
                console.error('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å†™çœŸã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            }
        }
        
        // ì—…ë¡œë“œ ì§„í–‰ë¥  í‘œì‹œ
        function showUploadProgress() {
            const avatarContainer = document.getElementById('profile-avatar-container');
            const progressHTML = `
                <div class="upload-progress">
                    <div class="upload-progress-bar" id="upload-progress-bar"></div>
                </div>
            `;
            avatarContainer.insertAdjacentHTML('beforeend', progressHTML);
        }
        
        // ì—…ë¡œë“œ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateUploadProgress(progress) {
            const progressBar = document.getElementById('upload-progress-bar');
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
        }
        
        // ì—…ë¡œë“œ ì§„í–‰ë¥  ìˆ¨ê¸°ê¸°
        function hideUploadProgress() {
            const progress = document.querySelector('.upload-progress');
            if (progress) {
                progress.remove();
            }
        }
        
        // ê°„ë‹¨í•œ ìƒë…„ì›”ì¼ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        
        // ìƒë…„ì›”ì¼ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” í•¨ìˆ˜
        function initializeDateInputs() {
            console.log('ìƒë…„ì›”ì¼ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” ì‹œì‘');
            
            // ìƒë…„ì›”ì¼ ì…ë ¥ í•„ë“œì— ìë™ í¬ë§·íŒ… ì¶”ê°€
            const birthdateInputs = ['profile-birthdate', 'edit-birthdate'];
            
            birthdateInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    // ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ ìŠ¬ë˜ì‹œ ì¶”ê°€
                    input.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/\D/g, ''); // ìˆ«ìë§Œ ë‚¨ê¸°ê¸°
                        
                        if (value.length >= 4) {
                            value = value.substring(0, 4) + '/' + value.substring(4);
                        }
                        if (value.length >= 7) {
                            value = value.substring(0, 7) + '/' + value.substring(7, 9);
                        }
                        
                        e.target.value = value;
                    });
                    
                    // í¬ì»¤ìŠ¤ ì‹œ í”Œë ˆì´ìŠ¤í™€ë” í‘œì‹œ
                    input.addEventListener('focus', function() {
                        if (!this.value) {
                            this.placeholder = 'å¹´/æœˆ/æ—¥ (ä¾‹: 1990/01/15)';
                        }
                    });
                    
                    console.log('ìƒë…„ì›”ì¼ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” ì™„ë£Œ:', inputId);
                }
            });
            
            // í˜ì´ì§€ ì–¸ì–´ ì„¤ì • í™•ì¸
            if (document.documentElement.lang !== 'ja') {
                document.documentElement.lang = 'ja';
                console.log('ë¬¸ì„œ ì–¸ì–´ë¥¼ ì¼ë³¸ì–´ë¡œ ì„¤ì •');
            }
        }
        
        // ì¤‘ë³µëœ DOMContentLoaded ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¨ - ì•„ë˜ì˜ í†µí•©ëœ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì‚¬ìš©
        
        // ì£¼ë¬¸ ë°ì´í„° ê´€ë¦¬ - Firebase ì „ìš© ì‹œìŠ¤í…œ
        
        // ì €ì¥ëœ ì£¼ë¬¸ ë°ì´í„° ë¶„ì„ í•¨ìˆ˜
        function analyzeStoredOrders() {
            console.log('Firebase ì „ìš© ì‹œìŠ¤í…œ - ì£¼ë¬¸ ë¶„ì„');
            console.log('ì£¼ë¬¸ ë°ì´í„°ëŠ” Firebaseì—ì„œ í™•ì¸í•˜ì„¸ìš”');
            return [];
        }
        
        // ì£¼ë¬¸ ë°ì´í„° ìˆ˜ì • í•¨ìˆ˜ - Firebase ì „ìš© ì‹œìŠ¤í…œ
        
        // ê°•ì œ ì£¼ë¬¸ í‘œì‹œ í•¨ìˆ˜ (ë””ë²„ê¹…ìš©)
        function showAllOrders() {
            try {
                console.log('ëª¨ë“  ì£¼ë¬¸ í‘œì‹œ ëª¨ë“œ ì‹œì‘');
                loadOrderHistory('ALL_ORDERS');
            } catch (error) {
                console.error('ëª¨ë“  ì£¼ë¬¸ í‘œì‹œ ì˜¤ë¥˜:', error);
            }
        }
        
        // í”„ë¡œí•„ í¸ì§‘ ì €ì¥
        async function saveProfileEdit() {
            try {
                const profileData = {
                    name: document.getElementById('edit-name').value,
                    email: document.getElementById('edit-email').value,
                    phone: document.getElementById('edit-phone').value,
                    profile: {
                        birthdate: convertFromJapaneseDate(document.getElementById('edit-birthdate').value),
                        gender: document.getElementById('edit-gender').value
                    }
                };
                
                console.log('í”„ë¡œí•„ ì €ì¥ ì‹œì‘:', profileData);
                
                let saveSuccess = false;
                
                // Firebaseì— ì €ì¥
                const user = firebase.auth && firebase.auth().currentUser;
                if (user) {
                    try {
                        await firebase.firestore().collection('users').doc(user.email).update({
                            name: profileData.name,
                            phone: profileData.phone,
                            profile: profileData.profile,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        console.log('Firebase í”„ë¡œí•„ ì €ì¥ ì„±ê³µ');
                        saveSuccess = true;
                    } catch (firebaseError) {
                        console.warn('Firebase ì €ì¥ ì‹¤íŒ¨:', firebaseError);
                    }
                }
                
                // Firebase ì „ìš© - localStorage ì‚¬ìš© ì•ˆí•¨
                
                // ê²°ê³¼ ì²˜ë¦¬
                if (saveSuccess) {
                    showProfileEditAlert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒæ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚', 'success');
                    
                    // í”„ë¡œí•„ í—¤ë” ì—…ë°ì´íŠ¸
                    setTimeout(async () => {
                        await loadProfileHeader();
                        // ëª¨ë‹¬ ë‹«ê¸°
                        const modal = bootstrap.Modal.getInstance(document.getElementById('profileEditModal'));
                        if (modal) modal.hide();
                    }, 1500);
                } else {
                    showProfileEditAlert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'danger');
                }
                
            } catch (error) {
                console.error('í”„ë¡œí•„ ì €ì¥ ì˜¤ë¥˜:', error);
                showProfileEditAlert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'danger');
            }
        }
        
        // í”„ë¡œí•„ í¸ì§‘ ì•Œë¦¼ í‘œì‹œ
        function showProfileEditAlert(message, type) {
            const alertDiv = document.getElementById('profile-edit-alert');
            alertDiv.className = `alert alert-${type} japanese-text`;
            alertDiv.textContent = message;
            alertDiv.classList.remove('d-none');
            
            // 3ì´ˆ í›„ ìˆ¨ê¸°ê¸°
            setTimeout(() => {
                alertDiv.classList.add('d-none');
            }, 3000);
        }
        
        // íŒ¨ìŠ¤ì›Œë“œ ë³€ê²½ ëª¨ë‹¬ í‘œì‹œ
        function showChangePassword() {
            // í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-new-password').value = '';
            
            // ì•Œë¦¼ ìˆ¨ê¸°ê¸°
            const alertDiv = document.getElementById('password-alert');
            alertDiv.classList.add('d-none');
            
            // ëª¨ë‹¬ í‘œì‹œ
            const modal = new bootstrap.Modal(document.getElementById('passwordModal'));
            modal.show();
        }
        
        // íŒ¨ìŠ¤ì›Œë“œ ë³€ê²½ ì‹¤í–‰
        async function changePassword() {
            try {
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-new-password').value;
                
                // ì…ë ¥ ê²€ì¦
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showPasswordAlert('ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'danger');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showPasswordAlert('æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚', 'danger');
                    return;
                }
                
                if (newPassword.length < 8) {
                    showPasswordAlert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'danger');
                    return;
                }
                
                let changeSuccess = false;
                
                // Firebase íŒ¨ìŠ¤ì›Œë“œ ë³€ê²½
                const user = firebase.auth && firebase.auth().currentUser;
                if (user) {
                    try {
                        // í˜„ì¬ íŒ¨ìŠ¤ì›Œë“œ í™•ì¸
                        const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
                        await user.reauthenticateWithCredential(credential);
                        
                        // ìƒˆ íŒ¨ìŠ¤ì›Œë“œë¡œ ë³€ê²½
                        await user.updatePassword(newPassword);
                        console.log('Firebase íŒ¨ìŠ¤ì›Œë“œ ë³€ê²½ ì„±ê³µ');
                        changeSuccess = true;
                    } catch (firebaseError) {
                        console.warn('Firebase íŒ¨ìŠ¤ì›Œë“œ ë³€ê²½ ì‹¤íŒ¨:', firebaseError);
                        if (firebaseError.code === 'auth/wrong-password') {
                            showPasswordAlert('ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚', 'danger');
                            return;
                        }
                    }
                }
                
                // Firebase ì „ìš© - localStorage ì‚¬ìš© ì•ˆí•¨
                
                // ê²°ê³¼ ì²˜ë¦¬
                if (changeSuccess) {
                    showPasswordAlert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£å¸¸ã«å¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚', 'success');
                    
                    // ëª¨ë‹¬ ë‹«ê¸°
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('passwordModal'));
                        if (modal) modal.hide();
                    }, 1500);
                } else {
                    showPasswordAlert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'danger');
                }
                
            } catch (error) {
                console.error('íŒ¨ìŠ¤ì›Œë“œ ë³€ê²½ ì˜¤ë¥˜:', error);
                showPasswordAlert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'danger');
            }
        }
        
        // íŒ¨ìŠ¤ì›Œë“œ ì•Œë¦¼ í‘œì‹œ
        function showPasswordAlert(message, type) {
            const alertDiv = document.getElementById('password-alert');
            alertDiv.className = `alert alert-${type} japanese-text`;
            alertDiv.textContent = message;
            alertDiv.classList.remove('d-none');
            
            // 3ì´ˆ í›„ ìˆ¨ê¸°ê¸°
            setTimeout(() => {
                alertDiv.classList.add('d-none');
            }, 3000);
        }
        
        // ì „ì—­ í•¨ìˆ˜ ë…¸ì¶œ
        window.loadOrderHistory = loadOrderHistory;
        window.getOrderHistoryDirectly = getOrderHistoryDirectly;
        window.initializeProfile = initializeProfile;
        window.analyzeStoredOrders = analyzeStoredOrders;
        // window.fixOrderData = fixOrderData; // ì œê±°ë¨ - Firebase ì „ìš©
        window.showAllOrders = showAllOrders;
        window.saveProfileEdit = saveProfileEdit;
        window.showChangePassword = showChangePassword;
        window.changePassword = changePassword;

        // QR ì½”ë“œ ê´€ë ¨ í•¨ìˆ˜ë“¤ - í¬ì¸íŠ¸ í˜ì´ì§€ì™€ ë™ì¼í•œ ë°©ì‹ ì‚¬ìš©

                // ì‚¬ìš©ì ì •ë³´ ê´€ë¦¬ (í¬ì¸íŠ¸ í˜ì´ì§€ì™€ ë™ì¼)

        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ í•¨ìˆ˜ ì œê±°ë¨ - checkAuthStateì—ì„œ ì²˜ë¦¬

        // QR ì½”ë“œ ìƒì„± í•¨ìˆ˜ë“¤ - í¬ì¸íŠ¸ í˜ì´ì§€ì™€ ë™ì¼í•œ ë°©ì‹ ì‚¬ìš©

        // ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ í”Œë˜ê·¸
        let authStateCheckInProgress = false;
        
        // ì¸ì¦ ìƒíƒœ í™•ì¸
        const checkAuthState = function() {
            if (authStateCheckInProgress) {
                console.log('ì¸ì¦ ìƒíƒœ í™•ì¸ ì´ë¯¸ ì§„í–‰ ì¤‘, ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€');
                return;
            }
            authStateCheckInProgress = true;
            
            try {
                console.log('=== ì¸ì¦ ìƒíƒœ í™•ì¸ ì‹œì‘ ===');
                
                // Firebase ì´ˆê¸°í™” ëŒ€ê¸° (ì•ˆì „í•œ ë°©ì‹)
                const waitForFirebase = () => {
                    return new Promise((resolve) => {
                        const checkFirebase = () => {
                            if (typeof firebase !== 'undefined' && firebase.auth && firebase.firestore) {
                                console.log('Firebase ì´ˆê¸°í™” ì™„ë£Œ');
                                resolve();
                            } else {
                                setTimeout(checkFirebase, 100);
                            }
                        };
                        checkFirebase();
                    });
                };
                
                waitForFirebase().then(() => {
                    console.log('Firebase ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘...');
                    
                    // ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (í•œ ë²ˆë§Œ)
                    if (!window.profileAuthStateUnsubscribe) {
                        console.log('ğŸ”§ Firebase ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì¤‘...');
                        window.profileAuthStateUnsubscribe = firebase.auth().onAuthStateChanged(function(user) {
                            console.log('ğŸ”„ Firebase ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€:', user ? `ë¡œê·¸ì¸ë¨ (${user.email})` : 'ë¡œê·¸ì•„ì›ƒë¨');
                            if (user) {
                                console.log('âœ… Firebase ì¸ì¦ ìƒíƒœ ë³€ê²½: ë¡œê·¸ì¸ë¨', user.email);
                                
                                // ì‚¬ìš©ì ë©”ë‰´ ì§ì ‘ ì—…ë°ì´íŠ¸ (auth-utils.js í˜¸ì¶œ ë°©ì§€)
                                updateUserMenuDirectly();
                                console.log('âœ… profile.html - ì‚¬ìš©ì ë©”ë‰´ ì§ì ‘ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                                
                                // í”„ë¡œí•„ í—¤ë” ì—…ë°ì´íŠ¸
                                const userData = {
                                    name: user.displayName || user.email.split('@')[0],
                                    email: user.email
                                };
                                updateProfileHeader(userData);
                                
                                // í”„ë¡œí•„ í˜ì´ì§€ ì´ˆê¸°í™”
                                initializeProfile();
                                
                                // ì¸ì¦ ìƒíƒœ í™•ì¸ ì™„ë£Œ
                                authStateCheckInProgress = false;
                            } else {
                                console.log('âŒ Firebase ì¸ì¦ ìƒíƒœ ë³€ê²½: ë¡œê·¸ì•„ì›ƒë¨');
                                // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œëŠ” ì¦‰ì‹œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ì§€ ì•Šê³  ì ì‹œ ëŒ€ê¸°
                                setTimeout(() => { 
                                    console.log('ğŸ”„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
                                    window.location.href = 'login.html'; 
                                }, 2000);
                            }
                        });
                        console.log('âœ… Firebase ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
                    }
                    
                    // í˜„ì¬ ì‚¬ìš©ì ìƒíƒœ í™•ì¸ (ë” ê¸´ ì‹œê°„ ëŒ€ê¸°)
                    let retryCount = 0;
                    const maxRetries = 20; // 20ë²ˆìœ¼ë¡œ ì¦ê°€
                    
                    const checkCurrentUser = () => {
                        const currentUser = firebase.auth().currentUser;
                        console.log(`í˜„ì¬ Firebase ì‚¬ìš©ì (ì‹œë„ ${retryCount + 1}/${maxRetries}):`, currentUser ? currentUser.email : 'null');
                        
                        if (currentUser) {
                            console.log('âœ… Firebase ì‚¬ìš©ì ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ë¨:', currentUser.email);
                            
                            // ì‚¬ìš©ì ë©”ë‰´ ì§ì ‘ ì—…ë°ì´íŠ¸ (auth-utils.js í˜¸ì¶œ ë°©ì§€)
                            updateUserMenuDirectly();
                            console.log('âœ… profile.html - í˜„ì¬ ì‚¬ìš©ì ë©”ë‰´ ì§ì ‘ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                            
                            // í”„ë¡œí•„ í—¤ë” ì—…ë°ì´íŠ¸
                            const userData = {
                                name: currentUser.displayName || currentUser.email.split('@')[0],
                                email: currentUser.email
                            };
                            updateProfileHeader(userData);
                            
                            // í”„ë¡œí•„ í˜ì´ì§€ ì´ˆê¸°í™”
                            initializeProfile();
                            
                            // ì¸ì¦ ìƒíƒœ í™•ì¸ ì™„ë£Œ
                            authStateCheckInProgress = false;
                        } else if (retryCount < maxRetries) {
                            retryCount++;
                            console.log(`Firebase ì‚¬ìš©ì ì—†ìŒ, ${retryCount}/${maxRetries} ì¬ì‹œë„ ì¤‘... (ì¸ì¦ ìƒíƒœ ë³µì› ëŒ€ê¸°)`);
                            setTimeout(checkCurrentUser, 500); // 500ms í›„ ì¬ì‹œë„ (ë” ê¸´ ê°„ê²©)
                        } else {
                            console.log('âŒ Firebase ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ ìƒíƒœ - ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆì—ì„œ ì²˜ë¦¬ ëŒ€ê¸°');
                            console.log('â³ onAuthStateChanged ë¦¬ìŠ¤ë„ˆì—ì„œ ì¸ì¦ ìƒíƒœ ë³µì› ëŒ€ê¸° ì¤‘...');
                            // ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆì—ì„œ ì²˜ë¦¬í•˜ë„ë¡ ëŒ€ê¸°
                        }
                    };
                    
                    // ì¦‰ì‹œ ì²« ë²ˆì§¸ í™•ì¸ ì‹¤í–‰
                    checkCurrentUser();
                });
            } catch (error) {
                console.error('ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
                authStateCheckInProgress = false; // ì˜¤ë¥˜ ì‹œ í”Œë˜ê·¸ ë¦¬ì…‹
                // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ì ì‹œ ëŒ€ê¸° í›„ ì¬ì‹œë„
                setTimeout(() => {
                    checkAuthState();
                }, 2000);
            }
        };

        // ì‚¬ìš©ì ë©”ë‰´ ì—…ë°ì´íŠ¸ (auth-utils.jsì˜ í•¨ìˆ˜ ì‚¬ìš©) - ì œê±°ë¨, updateUserMenuDirectly ì‚¬ìš©

        // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜ - ì œê±°ë¨, ìœ„ì˜ ëª¨ë°”ì¼/ì›¹ í˜¸í™˜ ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜ ì‚¬ìš©

        // í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ í•¨ìˆ˜ë“¤ - Firebase ì „ìš©

        // ë¶ˆí•„ìš”í•œ í•¨ìˆ˜ë“¤ ì œê±°ë¨ - checkAuthStateì—ì„œ ëª¨ë“  ì¸ì¦ ìƒíƒœ ê´€ë¦¬

        // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ í”Œë˜ê·¸
        let profilePageInitialized = false;
        
        // auth-utils.js ì¤‘ë³µ ì´ˆê¸°í™” ë°©ì§€
        window.profilePageInitialized = true;
        window.disableAuthUtilsInit = true; // auth-utils.js ì´ˆê¸°í™” ë¹„í™œì„±í™”
        
        // í†µí•©ëœ DOMContentLoaded ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ìµœì í™”ë¨)
        document.addEventListener('DOMContentLoaded', function() {
            if (profilePageInitialized) {
                console.log('í”„ë¡œí•„ í˜ì´ì§€ ì´ë¯¸ ì´ˆê¸°í™”ë¨, ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€');
                return;
            }
            profilePageInitialized = true;
            
            console.log('í”„ë¡œí•„ í˜ì´ì§€ DOM ë¡œë“œ ì™„ë£Œ');
            
            // ì¦‰ì‹œ ì‹¤í–‰í•  ì´ˆê¸°í™” ì‘ì—…ë“¤
            initializeDateInputs();
            setupDragAndDrop();
            
            // ì—¬ë°± ê°•ì œ ì ìš© (ì¦‰ì‹œ ì‹¤í–‰)
            const tabContent = document.getElementById('profileTabContent');
            const cardBody = document.querySelector('.col-md-8 .card.profile-card .card-body');
            const profileRow = document.querySelector('.profile-container .row');
            const colLeft = document.querySelector('.profile-container .col-md-4');
            const colRight = document.querySelector('.profile-container .col-md-8');
            
            if (tabContent) {
                tabContent.style.marginTop = '2rem';
                tabContent.style.paddingTop = '1rem';
            }
            if (cardBody) {
                cardBody.style.padding = '2rem 1.5rem';
            }
            if (profileRow) {
                profileRow.style.marginBottom = '3rem';
            }
            if (colLeft) {
                colLeft.style.marginBottom = '2rem';
            }
            if (colRight) {
                colRight.style.marginBottom = '2rem';
            }
            
            // ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
            const dropdownElementList = [].slice.call(document.querySelectorAll('.dropdown-toggle'));
            dropdownElementList.map(function(dropdownToggleEl) {
                return new bootstrap.Dropdown(dropdownToggleEl);
            });
            
            // Firebase ì´ˆê¸°í™” ëŒ€ê¸° (ì•ˆì „í•œ ë°©ì‹)
            const firebaseInitCheck = setInterval(() => {
                // Firebase ê¸°ë³¸ ê°ì²´ í™•ì¸
                if (typeof firebase !== 'undefined' && firebase.auth && firebase.firestore) {
                    console.log('Firebase ì´ˆê¸°í™” ì™„ë£Œ, ì¸ì¦ ìƒíƒœ í™•ì¸ ì‹œì‘');
                    clearInterval(firebaseInitCheck);
                    
                    // Firebase ì´ˆê¸°í™” ì™„ë£Œ í›„ ì ì‹œ ëŒ€ê¸° í›„ ì¸ì¦ ìƒíƒœ í™•ì¸
                    setTimeout(() => {
                        checkAuthState();
                    }, 1000); // 1ì´ˆ ëŒ€ê¸° í›„ ì¸ì¦ ìƒíƒœ í™•ì¸
                }
            }, 100); // 100ms ê°„ê²©
            
            // 3ì´ˆ í›„ì—ë„ Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šìœ¼ë©´ íƒ€ì„ì•„ì›ƒ (5ì´ˆ â†’ 3ì´ˆë¡œ ë‹¨ì¶•)
            setTimeout(() => {
                if (typeof firebase === 'undefined' || !firebase.auth) {
                    console.error('Firebase ì´ˆê¸°í™” íƒ€ì„ì•„ì›ƒ');
                    clearInterval(firebaseInitCheck);
                }
            }, 3000);
        });

    </script>

    <!-- åˆ©ç”¨è¦ç´„ Modal -->
    <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title japanese-heading" id="termsModalLabel">åˆ©ç”¨è¦ç´„</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body japanese-text">
                    <h6>ç¬¬10æ¡ï¼ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ãŠã‚ˆã³å†ç™»éŒ²åˆ¶é™ï¼‰</h6>
                    <p>1. ãŠå®¢æ§˜ãŒã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ãŸå ´åˆã€å½“ç¤¾ã¯å½“è©²ãŠå®¢æ§˜ã®å€‹äººæƒ…å ±ãŠã‚ˆã³é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚</p>
                    <p>2. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤å¾Œã€åŒä¸€ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã‚ˆã‚‹å†ç™»éŒ²ã¯6ãƒ¶æœˆé–“åˆ¶é™ã•ã‚Œã¾ã™ã€‚ã“ã®åˆ¶é™ã¯ã€ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒœãƒ¼ãƒŠã‚¹ãƒã‚¤ãƒ³ãƒˆã®æ¿«ç”¨é˜²æ­¢ãŠã‚ˆã³ã‚µãƒ¼ãƒ“ã‚¹ã®å¥å…¨ãªé‹å–¶ã‚’ç›®çš„ã¨ã—ã¾ã™ã€‚</p>
                    <p>3. å†ç™»éŒ²åˆ¶é™æœŸé–“ä¸­ã«åŒä¸€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ç™»éŒ²ã‚’è©¦è¡Œã—ãŸå ´åˆã€å½“ç¤¾ã¯ç™»éŒ²ã‚’æ‹’å¦ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
                    <p>4. 6ãƒ¶æœˆçµŒéå¾Œã€åŒä¸€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã‚ˆã‚‹å†ç™»éŒ²ãŒå¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚</p>
                    <p>5. å½“ç¤¾ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã®è¨˜éŒ²ã«ã‚ˆã‚Šå‰Šé™¤ã•ã‚ŒãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å±¥æ­´ã‚’è¿½è·¡ã—ã€ä¸æ­£ãªå†ç™»éŒ²ã‚’é˜²æ­¢ã™ã‚‹ãŸã‚ã®æªç½®ã‚’è¬›ã˜ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary japanese-text" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
 