<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management - Aether</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/custom.css">
    
    <style>
        /* ì£¼ë¬¸ ê´€ë¦¬ ì‹œìŠ¤í…œ ì „ìš© ìŠ¤íƒ€ì¼ */
        .order-management-container {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }
        
        .order-header {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .order-stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            border-left: 4px solid #6c757d;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            text-align: center;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .stat-card.active {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            border-left-width: 6px;
        }
        
        .stat-card.pending { border-left-color: #ffc107; }
        .stat-card.processing { border-left-color: #17a2b8; }
        .stat-card.shipping { border-left-color: #007bff; }
        .stat-card.completed { border-left-color: #28a745; }
        .stat-card.cancelled { border-left-color: #dc3545; }
        
        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: #212529;
            margin-bottom: 0.3rem;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1.2;
        }
        
        .order-filters {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        
        .order-list-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .order-item {
            border-bottom: 1px solid #e9ecef;
            padding: 1.5rem;
            transition: background-color 0.3s ease;
        }
        
        .order-item:hover {
            background-color: #f8f9fa;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .order-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-pending { background: #fff3cd; color: #856404; }
        .status-pending_payment { background: #fff3cd; color: #856404; }
        .status-processing { background: #d1ecf1; color: #0c5460; }
        .status-shipping { background: #cce5ff; color: #004085; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        
        .order-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn-action {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-view { background: #6c757d; color: white; border: none; }
        .btn-view:hover { background: #5a6268; color: white; }
        
        .btn-process { background: #17a2b8; color: white; border: none; }
        .btn-process:hover { background: #138496; color: white; }
        
        .btn-ship { background: #007bff; color: white; border: none; }
        .btn-ship:hover { background: #0056b3; color: white; }
        
        .btn-complete { background: #28a745; color: white; border: none; }
        .btn-complete:hover { background: #1e7e34; color: white; }
        
        .btn-cancel { background: #dc3545; color: white; border: none; }
        .btn-cancel:hover { background: #c82333; color: white; }
        
        .japanese-heading {
            font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
            font-weight: 600;
            color: #212529;
        }
        
        .japanese-text {
            font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
            color: #6c757d;
        }
        
        .empty-orders {
            text-align: center;
            padding: 4rem 2rem;
            color: #6c757d;
        }
        
        .empty-orders i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: 0.3em;
        }
        
        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .order-management-container {
                padding: 1rem 0;
            }
            
            .order-header {
                padding: 1.5rem;
                margin-bottom: 1rem;
            }
            
            .order-stats-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 0.5rem;
            }
            
            .stat-card {
                padding: 0.8rem 0.5rem;
            }
            
            .stat-number {
                font-size: 1.4rem;
            }
            
            .stat-label {
                font-size: 0.65rem;
            }
            
            .order-item {
                padding: 1rem;
            }
            
            .order-actions {
                justify-content: center;
                margin-top: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            .order-stats-grid {
                gap: 0.3rem;
            }
            
            .stat-card {
                padding: 0.6rem 0.3rem;
            }
            
            .stat-number {
                font-size: 1.2rem;
            }
            
            .stat-label {
                font-size: 0.6rem;
            }
        }
    </style>
</head>
<body>
    <div class="order-management-container">
        <div class="container-fluid">
            <!-- í—¤ë” -->
            <div class="order-header">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="japanese-heading mb-2">
                            <i class="fas fa-shopping-cart me-3"></i>æ³¨æ–‡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
                        </h1>
                        <p class="japanese-text mb-0">Order Management System</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary" onclick="refreshOrders()">
                            <i class="fas fa-sync-alt me-2"></i>æ›´æ–°
                        </button>
                        <button class="btn btn-dark" onclick="exportOrders()">
                            <i class="fas fa-download me-2"></i>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                        </button>
                        <a href="admin-dashboard.html" class="btn btn-outline-dark">
                            <i class="fas fa-arrow-left me-2"></i>ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                        </a>
                    </div>
                </div>
                
                <!-- ì£¼ë¬¸ í†µê³„ -->
                <div class="order-stats-grid">
                    <div class="stat-card pending" onclick="filterByStatus('pending')" data-status="pending">
                        <div class="stat-number" id="pending-count">0</div>
                        <div class="stat-label">å‡¦ç†å¾…ã¡</div>
                    </div>
                    <div class="stat-card processing" onclick="filterByStatus('processing')" data-status="processing">
                        <div class="stat-number" id="processing-count">0</div>
                        <div class="stat-label">å‡¦ç†ä¸­</div>
                    </div>
                    <div class="stat-card shipping" onclick="filterByStatus('shipping')" data-status="shipping">
                        <div class="stat-number" id="shipping-count">0</div>
                        <div class="stat-label">é…é€ä¸­</div>
                    </div>
                    <div class="stat-card completed" onclick="filterByStatus('completed')" data-status="completed">
                        <div class="stat-number" id="completed-count">0</div>
                        <div class="stat-label">å®Œäº†</div>
                    </div>
                    <div class="stat-card cancelled" onclick="filterByStatus('cancelled')" data-status="cancelled">
                        <div class="stat-number" id="cancelled-count">0</div>
                        <div class="stat-label">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div>
                    </div>
                </div>
            </div>
            
            <!-- í•„í„° -->
            <div class="order-filters">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label japanese-text">æ³¨æ–‡çŠ¶æ…‹</label>
                        <select class="form-select" id="status-filter" onchange="filterOrders()">
                            <option value="">å…¨ã¦</option>
                            <option value="pending">å‡¦ç†å¾…ã¡</option>
                            <option value="processing">å‡¦ç†ä¸­</option>
                            <option value="shipping">é…é€ä¸­</option>
                            <option value="completed">å®Œäº†</option>
                            <option value="cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label japanese-text">æœŸé–“</label>
                        <select class="form-select" id="date-filter" onchange="filterOrders()">
                            <option value="today">ä»Šæ—¥</option>
                            <option value="week">ä»Šé€±</option>
                            <option value="month">ä»Šæœˆ</option>
                            <option value="all">å…¨æœŸé–“</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label japanese-text">æ¤œç´¢</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="search-input" 
                                   placeholder="æ³¨æ–‡ç•ªå·ã€é¡§å®¢åã§æ¤œç´¢" onkeyup="searchOrders()">
                            <button class="btn btn-outline-secondary" onclick="clearSearch()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label japanese-text">&nbsp;</label>
                        <div>
                            <button class="btn btn-outline-secondary w-100" onclick="clearAllFilters()">
                                <i class="fas fa-filter me-1"></i>ãƒªã‚»ãƒƒãƒˆ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ì£¼ë¬¸ ëª©ë¡ -->
            <div class="order-list-container">
                <div id="orders-container">
                    <div class="loading-spinner">
                        <div class="spinner-border text-secondary" role="status">
                            <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ì£¼ë¬¸ ìƒì„¸ ëª¨ë‹¬ -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-labelledby="orderDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title japanese-heading" id="orderDetailModalLabel">æ³¨æ–‡è©³ç´°</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="order-detail-content">
                    <!-- ì£¼ë¬¸ ìƒì„¸ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                    <button type="button" class="btn btn-dark" onclick="printOrder()">å°åˆ·</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- Firebase Config -->
    <script src="assets/js/firebase-config.js"></script>
    
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let allOrders = [];
        let filteredOrders = [];
        let currentUser = null;
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ ì£¼ë¬¸ ê´€ë¦¬ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘');
            initializeOrderManagement();
        });
        
        // ì£¼ë¬¸ ê´€ë¦¬ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        function initializeOrderManagement() {
            console.log('ğŸ” Firebase ì´ˆê¸°í™” ì´ë²¤íŠ¸ ëŒ€ê¸° ì¤‘...');
            
            // Firebase ì´ˆê¸°í™” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            window.addEventListener('firebaseInitialized', function(event) {
                console.log('ğŸ‰ Firebase ì´ˆê¸°í™” ì´ë²¤íŠ¸ ìˆ˜ì‹ :', event.detail);
                
                // FirebaseService ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
                if (window.FirebaseService && !window.FirebaseService.db) {
                    const firebaseService = new window.FirebaseService();
                    window.FirebaseService.db = firebaseService.db;
                    console.log('âœ… FirebaseService ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì™„ë£Œ');
                }
                
                // ì£¼ë¬¸ ë°ì´í„° ë¡œë“œ ì‹œì‘
                setTimeout(() => {
                    console.log('ğŸ“Š ì£¼ë¬¸ ë°ì´í„° ë¡œë“œ ì‹œì‘');
                    loadOrders();
                }, 500);
            });
            
            // ë°±ì—…: FirebaseService ì§ì ‘ í™•ì¸ (ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ì§€ ì•Šì€ ê²½ìš°)
            setTimeout(() => {
                if (window.FirebaseService && window.FirebaseService.db) {
                    console.log('âœ… FirebaseService ì§ì ‘ í™•ì¸ ì„±ê³µ, ì£¼ë¬¸ ë°ì´í„° ë¡œë“œ ì‹œì‘');
                    loadOrders();
                } else {
                    console.log('âš ï¸ Firebase ì´ˆê¸°í™” ì´ë²¤íŠ¸ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...');
                }
            }, 2000);
        }
        
        // ì£¼ë¬¸ ë°ì´í„° ë¡œë“œ
        function loadOrders() {
            console.log('ğŸ“Š Firebaseì—ì„œ ì£¼ë¬¸ ë°ì´í„° ë¡œë“œ ì‹œì‘');
            
            // ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ Firestore ì¸ìŠ¤í„´ìŠ¤ í™•ì¸
            let db = null;
            
            if (window.FirebaseService && window.FirebaseService.db) {
                db = window.FirebaseService.db;
                console.log('âœ… FirebaseService.db ì‚¬ìš©');
            } else if (window.db) {
                db = window.db;
                console.log('âœ… window.db ì‚¬ìš©');
            } else {
                console.error('âŒ Firestore ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                console.log('ğŸ” ì‚¬ìš© ê°€ëŠ¥í•œ ê°ì²´ë“¤:');
                console.log('- window.FirebaseService:', typeof window.FirebaseService);
                console.log('- window.FirebaseService.db:', typeof window.FirebaseService?.db);
                console.log('- window.db:', typeof window.db);
                showError('Firebase ì—°ê²°ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const ordersRef = db.collection('orders');
            console.log('ğŸ“‹ orders ì»¬ë ‰ì…˜ ì°¸ì¡° ìƒì„± ì™„ë£Œ');
            
            ordersRef.orderBy('orderDate', 'desc').get()
                .then((querySnapshot) => {
                    allOrders = [];
                    console.log('ğŸ“‹ Firestore ì¿¼ë¦¬ ê²°ê³¼:', querySnapshot.size, 'ê°œ ë¬¸ì„œ');
                    
                    querySnapshot.forEach((doc) => {
                        const orderData = doc.data();
                        orderData.id = doc.id;
                        console.log('ğŸ“„ ì£¼ë¬¸ ë°ì´í„°:', doc.id, orderData);
                        allOrders.push(orderData);
                    });
                    
                    // ë‚ ì§œë³„ë¡œ ë‹¤ì‹œ ì •ë ¬ (ìµœì‹ ìˆœ)
                    allOrders.sort((a, b) => {
                        const dateA = new Date(a.orderDate || a.createdAt || 0);
                        const dateB = new Date(b.orderDate || b.createdAt || 0);
                        return dateB - dateA;
                    });
                    
                    console.log('âœ… ì£¼ë¬¸ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', allOrders.length, 'ê°œ (ìµœì‹ ìˆœ ì •ë ¬)');
                    
                    if (allOrders.length === 0) {
                        console.log('âš ï¸ ì£¼ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. Firebase ì½˜ì†”ì—ì„œ orders ì»¬ë ‰ì…˜ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                        showEmptyState();
                    } else {
                        // ì´ˆê¸° í•„í„°ë§ ì ìš© (ëª¨ë“  ì£¼ë¬¸ í‘œì‹œ)
                        filteredOrders = [...allOrders];
                        updateOrderStatistics();
                        displayOrders();
                    }
                })
                .catch((error) => {
                    console.error('âŒ ì£¼ë¬¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    showError('ì£¼ë¬¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                });
        }
        
        // ë¹ˆ ìƒíƒœ í‘œì‹œ
        function showEmptyState() {
            const container = document.getElementById('orders-container');
            container.innerHTML = `
                <div class="empty-orders">
                    <i class="fas fa-shopping-cart"></i>
                    <h4 class="japanese-heading">æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h4>
                    <p class="japanese-text">Firebase Firestoreã®ordersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    <p class="japanese-text">ãƒ†ã‚¹ãƒˆç”¨ã®æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ</p>
                    <button class="btn btn-secondary" onclick="createTestOrders()">
                        <i class="fas fa-plus me-2"></i>ãƒ†ã‚¹ãƒˆæ³¨æ–‡ã‚’ä½œæˆ
                    </button>
                </div>
            `;
        }
        
        // í…ŒìŠ¤íŠ¸ ì£¼ë¬¸ ìƒì„±
        function createTestOrders() {
            if (!confirm('ãƒ†ã‚¹ãƒˆç”¨ã®æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            const testOrders = [
                {
                    orderDate: new Date().toISOString(),
                    status: 'pending',
                    items: [
                        { name: 'LALARECIPE BAKUCHINOL EYE CREAM', quantity: 1, price: 2980 },
                        { name: 'YUZU VITA C CREAM', quantity: 2, price: 3500 }
                    ],
                    totalAmount: 9980,
                    customer: { 
                        name: 'ç”°ä¸­å¤ªéƒ', 
                        email: 'tanaka@example.com', 
                        phone: '090-1234-5678' 
                    },
                    shippingAddress: {
                        name: 'ç”°ä¸­å¤ªéƒ',
                        address: 'æ±äº¬éƒ½æ¸‹è°·åŒºæµæ¯”å¯¿1-2-3',
                        phone: '090-1234-5678'
                    }
                },
                {
                    orderDate: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(),
                    status: 'processing',
                    items: [
                        { name: 'COSCELL GREEN PAPAYA PDRN PORE AMPOULE', quantity: 1, price: 4200 }
                    ],
                    totalAmount: 4200,
                    customer: { 
                        name: 'ä½è—¤èŠ±å­', 
                        email: 'sato@example.com', 
                        phone: '090-2345-6789' 
                    },
                    shippingAddress: {
                        name: 'ä½è—¤èŠ±å­',
                        address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚åŒ—åŒºæ¢…ç”°1-1-1',
                        phone: '090-2345-6789'
                    }
                },
                {
                    orderDate: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                    status: 'shipping',
                    items: [
                        { name: 'LUCINDE RETINOL VOLUME EYEBAG CREAM', quantity: 1, price: 3800 },
                        { name: 'MAKE HEAL GREEN PAPAYA PDRN PORE AMPOULE', quantity: 1, price: 4500 }
                    ],
                    totalAmount: 8300,
                    customer: { 
                        name: 'éˆ´æœ¨ä¸€éƒ', 
                        email: 'suzuki@example.com', 
                        phone: '090-3456-7890' 
                    },
                    shippingAddress: {
                        name: 'éˆ´æœ¨ä¸€éƒ',
                        address: 'ç¥å¥ˆå·çœŒæ¨ªæµœå¸‚è¥¿åŒºã¿ãªã¨ã¿ã‚‰ã„2-2-2',
                        phone: '090-3456-7890'
                    }
                }
            ];
            
            console.log('ğŸ“ í…ŒìŠ¤íŠ¸ ì£¼ë¬¸ ë°ì´í„° ìƒì„± ì¤‘...');
            
            // Firebaseì— í…ŒìŠ¤íŠ¸ ì£¼ë¬¸ ì¶”ê°€
            const batch = window.FirebaseService.db.batch();
            testOrders.forEach((order, index) => {
                const docRef = window.FirebaseService.db.collection('orders').doc();
                batch.set(docRef, order);
            });
            
            batch.commit()
                .then(() => {
                    console.log('âœ… í…ŒìŠ¤íŠ¸ ì£¼ë¬¸ ë°ì´í„° ìƒì„± ì™„ë£Œ');
                    showSuccess('ãƒ†ã‚¹ãƒˆæ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚');
                    // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
                    loadOrders();
                })
                .catch((error) => {
                    console.error('âŒ í…ŒìŠ¤íŠ¸ ì£¼ë¬¸ ìƒì„± ì‹¤íŒ¨:', error);
                    showError('ãƒ†ã‚¹ãƒˆæ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                });
        }
        
        // ì£¼ë¬¸ í†µê³„ ì—…ë°ì´íŠ¸
        function updateOrderStatistics() {
            const stats = {
                pending: 0,
                pending_payment: 0,
                processing: 0,
                shipping: 0,
                completed: 0,
                cancelled: 0
            };
            
            allOrders.forEach(order => {
                if (stats.hasOwnProperty(order.status)) {
                    stats[order.status]++;
                }
            });
            
            // pendingê³¼ pending_paymentë¥¼ í•©ì³ì„œ í‘œì‹œ
            document.getElementById('pending-count').textContent = stats.pending + stats.pending_payment;
            document.getElementById('processing-count').textContent = stats.processing;
            document.getElementById('shipping-count').textContent = stats.shipping;
            document.getElementById('completed-count').textContent = stats.completed;
            document.getElementById('cancelled-count').textContent = stats.cancelled;
        }
        
        // í†µê³„ ì¹´ë“œ í´ë¦­ìœ¼ë¡œ í•„í„°ë§
        function filterByStatus(status) {
            // ëª¨ë“  í†µê³„ ì¹´ë“œì—ì„œ active í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.stat-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // í´ë¦­ëœ ì¹´ë“œì— active í´ë˜ìŠ¤ ì¶”ê°€
            const clickedCard = document.querySelector(`[data-status="${status}"]`);
            if (clickedCard) {
                clickedCard.classList.add('active');
            }
            
            // ìƒíƒœ í•„í„° ì„¤ì •
            document.getElementById('status-filter').value = status;
            
            // í•„í„°ë§ ì ìš©
            filterOrders();
        }
        
        // ì£¼ë¬¸ ëª©ë¡ í‘œì‹œ
        function displayOrders() {
            const container = document.getElementById('orders-container');
            
            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <div class="empty-orders">
                        <i class="fas fa-shopping-cart"></i>
                        <h4 class="japanese-heading">æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“</h4>
                        <p class="japanese-text">æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            filteredOrders.forEach(order => {
                html += createOrderItemHTML(order);
            });
            
            container.innerHTML = html;
        }
        
        // ì£¼ë¬¸ ì•„ì´í…œ HTML ìƒì„±
        function createOrderItemHTML(order) {
            // ë‚ ì§œ ì²˜ë¦¬ - ì—¬ëŸ¬ í•„ë“œì—ì„œ ë‚ ì§œ ì°¾ê¸° (ë‚ ì§œ + ì‹œê°„)
            let orderDate = 'ë‚ ì§œ ì—†ìŒ';
            if (order.orderDate) {
                const date = new Date(order.orderDate.seconds ? order.orderDate.seconds * 1000 : order.orderDate);
                if (!isNaN(date.getTime())) {
                    orderDate = date.toLocaleDateString('ja-JP') + ' ' + date.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                }
            } else if (order.createdAt) {
                const date = new Date(order.createdAt.seconds ? order.createdAt.seconds * 1000 : order.createdAt);
                if (!isNaN(date.getTime())) {
                    orderDate = date.toLocaleDateString('ja-JP') + ' ' + date.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                }
            }
            
            const totalAmount = order.totalAmount ? order.totalAmount.toLocaleString() : '0';
            
            // ê³ ê° ì´ë¦„ ì²˜ë¦¬ - shipping.name ìš°ì„ , ì—¬ëŸ¬ í•„ë“œì—ì„œ ì´ë¦„ ì°¾ê¸°
            let customerName = 'ä¸æ˜';
            if (order.shipping && order.shipping.name && order.shipping.name !== 'null') {
                customerName = order.shipping.name;
            } else if (order.customer && order.customer.name && order.customer.name !== 'null') {
                customerName = order.customer.name;
            } else if (order.userName && order.userName !== 'null') {
                customerName = order.userName;
            } else if (order.customerName && order.customerName !== 'null') {
                customerName = order.customerName;
            }
            
            const customerEmail = order.customer ? order.customer.email : (order.customerEmail || order.userEmail || '');
            
            // ë°°ì†¡ ì£¼ì†Œ ì²˜ë¦¬
            let shippingAddress = '';
            if (order.shipping) {
                const parts = [];
                if (order.shipping.prefecture) parts.push(order.shipping.prefecture);
                if (order.shipping.city) parts.push(order.shipping.city);
                if (order.shipping.address1) parts.push(order.shipping.address1);
                if (order.shipping.address2) parts.push(order.shipping.address2);
                shippingAddress = parts.join(' ');
            }
            
            // ê²°ì œ ë°©ë²• ì²˜ë¦¬
            let paymentMethod = 'ä¸æ˜';
            if (order.paymentMethod) {
                paymentMethod = order.paymentMethod === 'card' ? 'ã‚«ãƒ¼ãƒ‰' : 
                               order.paymentMethod === 'bank-transfer' ? 'éŠ€è¡ŒæŒ¯è¾¼' : order.paymentMethod;
            } else if (order.payment && order.payment.method) {
                paymentMethod = order.payment.method === 'card' ? 'ã‚«ãƒ¼ãƒ‰' : 
                               order.payment.method === 'bank-transfer' ? 'éŠ€è¡ŒæŒ¯è¾¼' : order.payment.method;
            }
            
            return `
                <div class="order-item">
                    <div class="row align-items-center">
                        <div class="col-md-2">
                            <div class="fw-bold">${order.id}</div>
                            <small class="text-muted">${orderDate}</small>
                        </div>
                        <div class="col-md-2">
                            <div class="fw-bold">${customerName}</div>
                            <small class="text-muted">${customerEmail}</small>
                            ${shippingAddress ? `<br><small class="text-muted">${shippingAddress}</small>` : ''}
                        </div>
                        <div class="col-md-2">
                            <span class="order-status status-${order.status}">
                                ${getStatusText(order.status)}
                            </span>
                        </div>
                        <div class="col-md-2">
                            <div class="fw-bold">Â¥${totalAmount}</div>
                            <small class="text-muted">${order.items ? order.items.length : 0} å•†å“</small>
                            <br><small class="text-muted">${paymentMethod}</small>
                        </div>
                        <div class="col-md-4">
                            <div class="order-actions">
                                <button class="btn btn-action btn-view" onclick="viewOrderDetail('${order.id}')">
                                    <i class="fas fa-eye me-1"></i>è©³ç´°
                                </button>
                                ${getActionButtons(order.status, order.id)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ìƒíƒœë³„ ì•¡ì…˜ ë²„íŠ¼ ìƒì„±
        function getActionButtons(status, orderId) {
            switch(status) {
                case 'pending':
                case 'pending_payment':
                    return `
                        <button class="btn btn-action btn-process" onclick="updateOrderStatus('${orderId}', 'processing')">
                            <i class="fas fa-check me-1"></i>å‡¦ç†é–‹å§‹
                        </button>
                        <button class="btn btn-action btn-cancel" onclick="updateOrderStatus('${orderId}', 'cancelled')">
                            <i class="fas fa-times me-1"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                    `;
                case 'processing':
                    return `
                        <button class="btn btn-action btn-ship" onclick="updateOrderStatus('${orderId}', 'shipping')">
                            <i class="fas fa-truck me-1"></i>é…é€é–‹å§‹
                        </button>
                    `;
                case 'shipping':
                    return `
                        <button class="btn btn-action btn-complete" onclick="updateOrderStatus('${orderId}', 'completed')">
                            <i class="fas fa-check-circle me-1"></i>å®Œäº†
                        </button>
                    `;
                case 'completed':
                    return `<span class="text-muted">å®Œäº†æ¸ˆã¿</span>`;
                case 'cancelled':
                    return `<span class="text-muted">ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿</span>`;
                default:
                    return '';
            }
        }
        
        // ìƒíƒœ í…ìŠ¤íŠ¸ ë³€í™˜
        function getStatusText(status) {
            const statusMap = {
                'pending': 'å‡¦ç†å¾…ã¡',
                'pending_payment': 'æ”¯æ‰•ã„å¾…ã¡',
                'processing': 'å‡¦ç†ä¸­',
                'shipping': 'é…é€ä¸­',
                'completed': 'å®Œäº†',
                'cancelled': 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
            };
            return statusMap[status] || status;
        }
        
        // ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateOrderStatus(orderId, newStatus) {
            if (!confirm('æ³¨æ–‡çŠ¶æ…‹ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            if (!window.FirebaseService || !window.FirebaseService.db) {
                console.error('âŒ FirebaseServiceë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                showError('Firebase ì—°ê²°ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            const orderRef = window.FirebaseService.db.collection('orders').doc(orderId);
            
            orderRef.update({
                status: newStatus,
                updatedAt: new Date().toISOString()
            })
            .then(() => {
                console.log('âœ… ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', orderId, newStatus);
                
                // ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
                const orderIndex = allOrders.findIndex(order => order.id === orderId);
                if (orderIndex !== -1) {
                    allOrders[orderIndex].status = newStatus;
                    updateOrderStatistics();
                    displayOrders();
                }
                
                // ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡ (í–¥í›„ êµ¬í˜„)
                sendOrderStatusNotification(orderId, newStatus);
                
                showSuccess('æ³¨æ–‡çŠ¶æ…‹ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚');
            })
            .catch((error) => {
                console.error('âŒ ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                showError('æ³¨æ–‡çŠ¶æ…‹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            });
        }
        
        // ì£¼ë¬¸ ìƒì„¸ ë³´ê¸°
        function viewOrderDetail(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) {
                showError('æ³¨æ–‡æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            const modalContent = createOrderDetailHTML(order);
            document.getElementById('order-detail-content').innerHTML = modalContent;
            
            const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
            modal.show();
        }
        
        // ì£¼ë¬¸ ìƒì„¸ HTML ìƒì„±
        function createOrderDetailHTML(order) {
            // ë‚ ì§œ ì²˜ë¦¬ - ì—¬ëŸ¬ í•„ë“œì—ì„œ ë‚ ì§œ ì°¾ê¸° (ë‚ ì§œ + ì‹œê°„)
            let orderDate = 'ë‚ ì§œ ì—†ìŒ';
            if (order.orderDate) {
                const date = new Date(order.orderDate.seconds ? order.orderDate.seconds * 1000 : order.orderDate);
                if (!isNaN(date.getTime())) {
                    orderDate = date.toLocaleString('ja-JP');
                }
            } else if (order.createdAt) {
                const date = new Date(order.createdAt.seconds ? order.createdAt.seconds * 1000 : order.createdAt);
                if (!isNaN(date.getTime())) {
                    orderDate = date.toLocaleString('ja-JP');
                }
            }
            
            const totalAmount = order.totalAmount ? order.totalAmount.toLocaleString() : '0';
            
            // ê³ ê° ì´ë¦„ ì²˜ë¦¬ - shipping.name ìš°ì„ , ì—¬ëŸ¬ í•„ë“œì—ì„œ ì´ë¦„ ì°¾ê¸°
            let customerName = 'ä¸æ˜';
            if (order.shipping && order.shipping.name && order.shipping.name !== 'null') {
                customerName = order.shipping.name;
            } else if (order.customer && order.customer.name && order.customer.name !== 'null') {
                customerName = order.customer.name;
            } else if (order.userName && order.userName !== 'null') {
                customerName = order.userName;
            } else if (order.customerName && order.customerName !== 'null') {
                customerName = order.customerName;
            }
            
            const customerEmail = order.customer ? order.customer.email : (order.customerEmail || order.userEmail || 'ä¸æ˜');
            const customerPhone = order.shipping ? order.shipping.phone : (order.customer ? order.customer.phone : (order.customerPhone || 'ä¸æ˜'));
            
            // ë°°ì†¡ ì£¼ì†Œ ì²˜ë¦¬ (ìƒì„¸ ëª¨ë‹¬ìš©)
            let fullShippingAddress = '';
            if (order.shipping) {
                const parts = [];
                if (order.shipping.postal) parts.push(`ã€’${order.shipping.postal}`);
                if (order.shipping.prefecture) parts.push(order.shipping.prefecture);
                if (order.shipping.city) parts.push(order.shipping.city);
                if (order.shipping.address1) parts.push(order.shipping.address1);
                if (order.shipping.address2) parts.push(order.shipping.address2);
                fullShippingAddress = parts.join(' ');
            }
            
            // ê²°ì œ ë°©ë²• ì²˜ë¦¬
            let paymentMethod = 'ä¸æ˜';
            if (order.paymentMethod) {
                paymentMethod = order.paymentMethod === 'card' ? 'ã‚«ãƒ¼ãƒ‰' : 
                               order.paymentMethod === 'bank-transfer' ? 'éŠ€è¡ŒæŒ¯è¾¼' : order.paymentMethod;
            } else if (order.payment && order.payment.method) {
                paymentMethod = order.payment.method === 'card' ? 'ã‚«ãƒ¼ãƒ‰' : 
                               order.payment.method === 'bank-transfer' ? 'éŠ€è¡ŒæŒ¯è¾¼' : order.payment.method;
            }
            
            let itemsHTML = '';
            if (order.items && order.items.length > 0) {
                itemsHTML = order.items.map(item => `
                    <tr>
                        <td>${item.name}</td>
                        <td class="text-center">${item.quantity}</td>
                        <td class="text-end">Â¥${item.price ? item.price.toLocaleString() : '0'}</td>
                        <td class="text-end">Â¥${(item.price * item.quantity).toLocaleString()}</td>
                    </tr>
                `).join('');
            }
            
            return `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="japanese-heading">æ³¨æ–‡æƒ…å ±</h6>
                        <table class="table table-sm">
                            <tr><td>æ³¨æ–‡ç•ªå·:</td><td>${order.id}</td></tr>
                            <tr><td>æ³¨æ–‡æ—¥æ™‚:</td><td>${orderDate}</td></tr>
                            <tr><td>çŠ¶æ…‹:</td><td><span class="order-status status-${order.status}">${getStatusText(order.status)}</span></td></tr>
                            <tr><td>åˆè¨ˆé‡‘é¡:</td><td class="fw-bold">Â¥${totalAmount}</td></tr>
                            <tr><td>æ”¯æ‰•ã„æ–¹æ³•:</td><td>${paymentMethod}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="japanese-heading">é¡§å®¢æƒ…å ±</h6>
                        <table class="table table-sm">
                            <tr><td>åå‰:</td><td>${customerName}</td></tr>
                            <tr><td>ãƒ¡ãƒ¼ãƒ«:</td><td>${customerEmail}</td></tr>
                            <tr><td>é›»è©±:</td><td>${customerPhone}</td></tr>
                            ${fullShippingAddress ? `<tr><td>é…é€å…ˆ:</td><td>${fullShippingAddress}</td></tr>` : ''}
                        </table>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6 class="japanese-heading">æ³¨æ–‡å•†å“</h6>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>å•†å“å</th>
                                    <th class="text-center">æ•°é‡</th>
                                    <th class="text-end">å˜ä¾¡</th>
                                    <th class="text-end">å°è¨ˆ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHTML}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        // í•„í„°ë§ í•¨ìˆ˜ë“¤
        function filterOrders() {
            const statusFilter = document.getElementById('status-filter').value;
            const dateFilter = document.getElementById('date-filter').value;
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            filteredOrders = allOrders.filter(order => {
                // ìƒíƒœ í•„í„°
                if (statusFilter) {
                    if (statusFilter === 'pending') {
                        // pending í•„í„°ëŠ” pendingê³¼ pending_payment ëª¨ë‘ í¬í•¨
                        if (order.status !== 'pending' && order.status !== 'pending_payment') {
                            return false;
                        }
                    } else if (order.status !== statusFilter) {
                        return false;
                    }
                }
                
                // ë‚ ì§œ í•„í„°
                if (dateFilter !== 'all') {
                    // ë‚ ì§œ ì²˜ë¦¬ - ì—¬ëŸ¬ í•„ë“œì—ì„œ ë‚ ì§œ ì°¾ê¸°
                    let orderDate = null;
                    if (order.orderDate) {
                        orderDate = new Date(order.orderDate.seconds ? order.orderDate.seconds * 1000 : order.orderDate);
                    } else if (order.createdAt) {
                        orderDate = new Date(order.createdAt.seconds ? order.createdAt.seconds * 1000 : order.createdAt);
                    }
                    
                    if (!orderDate || isNaN(orderDate.getTime())) return false;
                    
                    const now = new Date();
                    
                    switch(dateFilter) {
                        case 'today':
                            if (orderDate.toDateString() !== now.toDateString()) return false;
                            break;
                        case 'week':
                            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            if (orderDate < weekAgo) return false;
                            break;
                        case 'month':
                            const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                            if (orderDate < monthAgo) return false;
                            break;
                    }
                }
                
                // ê²€ìƒ‰ í•„í„°
                if (searchTerm) {
                    const searchableText = `${order.id} ${order.customer ? order.customer.name : ''} ${order.customer ? order.customer.email : ''}`.toLowerCase();
                    if (!searchableText.includes(searchTerm)) return false;
                }
                
                return true;
            });
            
            displayOrders();
        }
        
        function searchOrders() {
            filterOrders();
        }
        
        function clearSearch() {
            document.getElementById('search-input').value = '';
            filterOrders();
        }
        
        function clearAllFilters() {
            // ëª¨ë“  í†µê³„ ì¹´ë“œì—ì„œ active í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.stat-card').forEach(card => {
                card.classList.remove('active');
            });
            
            document.getElementById('status-filter').value = '';
            document.getElementById('date-filter').value = 'all';
            document.getElementById('search-input').value = '';
            filterOrders();
        }
        
        function refreshOrders() {
            loadOrders();
        }
        
        function exportOrders() {
            // CSV ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ (í–¥í›„ êµ¬í˜„)
            showInfo('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™ã€‚');
        }
        
        function printOrder() {
            window.print();
        }
        
        // ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡ (í–¥í›„ êµ¬í˜„)
        function sendOrderStatusNotification(orderId, newStatus) {
            console.log('ğŸ“§ ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡ ì˜ˆì •:', orderId, newStatus);
            // Gmail API ì—°ë™ í›„ êµ¬í˜„
        }
        
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function showSuccess(message) {
            // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ (í–¥í›„ êµ¬í˜„)
            console.log('âœ…', message);
        }
        
        function showError(message) {
            // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ (í–¥í›„ êµ¬í˜„)
            console.error('âŒ', message);
        }
        
        function showInfo(message) {
            // ì •ë³´ ë©”ì‹œì§€ í‘œì‹œ (í–¥í›„ êµ¬í˜„)
            console.log('â„¹ï¸', message);
        }
        
        // ì´ˆê¸° í•„í„°ë§ ì ìš© (ì œê±° - loadOrdersì—ì„œ ì²˜ë¦¬)
    </script>
</body>
</html>
