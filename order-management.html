<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management - Aether</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/custom.css">
    
    <style>
        /* ì£¼ë¬¸ ê´€ë¦¬ ì‹œìŠ¤í…œ ì „ìš© ìŠ¤íƒ€ì¼ */
        .order-management-container {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }
        
        .order-header {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .order-stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            border-left: 4px solid #6c757d;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            text-align: center;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .stat-card.active {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            border-left-width: 6px;
        }
        
        .stat-card.pending { border-left-color: #ffc107; }
        .stat-card.processing { border-left-color: #17a2b8; }
        .stat-card.shipping { border-left-color: #007bff; }
        .stat-card.completed { border-left-color: #28a745; }
        .stat-card.cancelled { border-left-color: #dc3545; }
        
        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: #212529;
            margin-bottom: 0.3rem;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            line-height: 1.2;
        }
        
        .order-filters {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        
        /* ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ ìŠ¤íƒ€ì¼ */
        .date-navigation {
            text-align: center;
            padding: 1rem 0;
        }
        
        .date-nav-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .date-nav-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #333;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .date-nav-btn:hover {
            background: #f8f9fa;
            color: #007bff;
        }
        
        .current-date-display {
            text-align: center;
        }
        
        .date-year {
            font-size: 1rem;
            color: #666;
            margin-bottom: 0.25rem;
        }
        
        .date-main {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .date-month-day {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
        }
        
        .date-weekday {
            font-size: 1rem;
            color: #666;
        }
        
        .adjacent-dates {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
        }
        
        .adjacent-date {
            font-size: 0.9rem;
            color: #999;
        }
        
        /* í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .order-list-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .order-item {
            border-bottom: 1px solid #e9ecef;
            padding: 1.5rem;
            transition: background-color 0.3s ease;
        }
        
        .order-item:hover {
            background-color: #f8f9fa;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .order-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-pending { background: #fff3cd; color: #856404; }
        .status-pending_payment { background: #fff3cd; color: #856404; }
        .status-processing { background: #d1ecf1; color: #0c5460; }
        .status-shipping { background: #cce5ff; color: #004085; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        
        .order-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn-action {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-view { background: #6c757d; color: white; border: none; }
        .btn-view:hover { background: #5a6268; color: white; }
        
        .btn-process { background: #17a2b8; color: white; border: none; }
        .btn-process:hover { background: #138496; color: white; }
        
        .btn-ship { background: #007bff; color: white; border: none; }
        .btn-ship:hover { background: #0056b3; color: white; }
        
        .btn-complete { background: #28a745; color: white; border: none; }
        .btn-complete:hover { background: #1e7e34; color: white; }
        
        .btn-cancel { background: #dc3545; color: white; border: none; }
        .btn-cancel:hover { background: #c82333; color: white; }
        
        /* ë°˜í’ˆ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ì™„ë£Œëœ ì£¼ë¬¸ì˜ ì·¨ì†Œ ë²„íŠ¼) */
        .btn-return { background: #fd7e14; color: white; }
        .btn-return:hover { background: #e55a00; color: white; }
        
        .japanese-heading {
            font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
            font-weight: 600;
            color: #212529;
        }
        
        .japanese-text {
            font-family: 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif;
            color: #6c757d;
        }
        
        .empty-orders {
            text-align: center;
            padding: 4rem 2rem;
            color: #6c757d;
        }
        
        .empty-orders i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: 0.3em;
        }
        
        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .order-management-container {
                padding: 1rem 0;
            }
            
            .order-header {
                padding: 1.5rem;
                margin-bottom: 1rem;
            }
            
            .order-stats-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 0.5rem;
            }
            
            .stat-card {
                padding: 0.8rem 0.5rem;
            }
            
            .stat-number {
                font-size: 1.4rem;
            }
            
            .stat-label {
                font-size: 0.65rem;
            }
            
            .order-item {
                padding: 1rem;
            }
            
            .order-actions {
                justify-content: center;
                margin-top: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            .order-stats-grid {
                gap: 0.3rem;
            }
            
            .stat-card {
                padding: 0.6rem 0.3rem;
            }
            
            .stat-number {
                font-size: 1.2rem;
            }
            
            .stat-label {
                font-size: 0.6rem;
            }
        }
    </style>
</head>
<body>
    <div class="order-management-container">
        <div class="container-fluid">
            <!-- í—¤ë” -->
            <div class="order-header">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="japanese-heading mb-2">
                            <i class="fas fa-shopping-cart me-3"></i>æ³¨æ–‡ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
                        </h1>
                        <p class="japanese-text mb-0">Order Management System</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary" onclick="refreshOrders()">
                            <i class="fas fa-sync-alt me-2"></i>æ›´æ–°
                        </button>
                        <button class="btn btn-dark" onclick="exportOrders()">
                            <i class="fas fa-download me-2"></i>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                        </button>
                        <a href="admin-dashboard.html" class="btn btn-outline-dark">
                            <i class="fas fa-arrow-left me-2"></i>ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                        </a>
                    </div>
                </div>
                
                <!-- ì£¼ë¬¸ í†µê³„ -->
                <div class="order-stats-grid">
                    <div class="stat-card pending" onclick="filterByStatus('pending')" data-status="pending">
                        <div class="stat-number" id="pending-count">0</div>
                        <div class="stat-label">å‡¦ç†å¾…ã¡</div>
                    </div>
                    <div class="stat-card processing" onclick="filterByStatus('processing')" data-status="processing">
                        <div class="stat-number" id="processing-count">0</div>
                        <div class="stat-label">å‡¦ç†ä¸­</div>
                    </div>
                    <div class="stat-card shipping" onclick="filterByStatus('shipping')" data-status="shipping">
                        <div class="stat-number" id="shipping-count">0</div>
                        <div class="stat-label">é…é€ä¸­</div>
                    </div>
                    <div class="stat-card completed" onclick="filterByStatus('completed')" data-status="completed">
                        <div class="stat-number" id="completed-count">0</div>
                        <div class="stat-label">å®Œäº†</div>
                    </div>
                    <div class="stat-card cancelled" onclick="filterByStatus('cancelled')" data-status="cancelled">
                        <div class="stat-number" id="cancelled-count">0</div>
                        <div class="stat-label">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div>
                    </div>
                </div>
            </div>
            
            <!-- í•„í„° -->
            <div class="order-filters">
                <!-- ìƒë‹¨ í•„í„° ì„ íƒ í•„ë“œë“¤ -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <label class="form-label japanese-text">æ³¨æ–‡çŠ¶æ…‹</label>
                        <select class="form-select" id="status-filter" onchange="filterOrders()">
                            <option value="">å…¨ã¦</option>
                            <option value="pending">å‡¦ç†å¾…ã¡</option>
                            <option value="processing">å‡¦ç†ä¸­</option>
                            <option value="shipping">é…é€ä¸­</option>
                            <option value="completed">å®Œäº†</option>
                            <option value="cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label japanese-text">æœŸé–“</label>
                        <select class="form-select" id="date-filter" onchange="onDateFilterChange()">
                            <option value="today">ä»Šæ—¥</option>
                            <option value="month">ä»Šæœˆ</option>
                            <option value="year">ä»Šå¹´</option>
                            <option value="all">å…¨æœŸé–“</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label japanese-text">æ¤œç´¢</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="search-input" 
                                   placeholder="æ³¨æ–‡ç•ªå·ã€é¡§å®¢åã§æ¤œç´¢" onkeyup="searchOrders()">
                            <button class="btn btn-outline-secondary" onclick="clearSearch()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label japanese-text">&nbsp;</label>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary flex-fill" onclick="clearAllFilters()">
                                <i class="fas fa-filter me-1"></i>ãƒªã‚»ãƒƒãƒˆ
                            </button>
                            <button class="btn btn-outline-dark flex-fill" onclick="downloadCSV()">
                                <i class="fas fa-download me-1"></i>CSV
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- í•˜ë‹¨ ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ -->
                <div class="row">
                    <div class="col-12">
                        <div class="date-navigation">
                            <div class="date-nav-container">
                                <button class="date-nav-btn" onclick="navigateDate(-1)">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <div class="current-date-display">
                                    <div class="date-year" id="current-year">2025å¹´</div>
                                    <div class="date-main">
                                        <span class="date-month-day" id="current-month-day">10æœˆ2æ—¥</span>
                                        <span class="date-weekday" id="current-weekday">(é‡‘)</span>
                                    </div>
                                </div>
                                <button class="date-nav-btn" onclick="navigateDate(1)">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                            <div class="adjacent-dates">
                                <span class="adjacent-date" id="prev-date">2025å¹´ 10æœˆ1æ—¥ (é‡‘)</span>
                                <span class="adjacent-date" id="next-date">2025å¹´ 10æœˆ3æ—¥ (é‡‘)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ì£¼ë¬¸ ëª©ë¡ -->
            <div class="order-list-container">
                <div id="orders-container">
                    <div class="loading-spinner">
                        <div class="spinner-border text-secondary" role="status">
                            <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ì£¼ë¬¸ ìƒì„¸ ëª¨ë‹¬ -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-labelledby="orderDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title japanese-heading" id="orderDetailModalLabel">æ³¨æ–‡è©³ç´°</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="order-detail-content">
                    <!-- ì£¼ë¬¸ ìƒì„¸ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                    <button type="button" class="btn btn-dark" onclick="printOrder()">å°åˆ·</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- Firebase Config -->
    <script src="assets/js/firebase-config-new.js"></script>
    
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let allOrders = [];
        let filteredOrders = [];
        let currentUser = null;
        let currentDate = new Date(); // í˜„ì¬ ì„ íƒëœ ë‚ ì§œ
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ ì£¼ë¬¸ ê´€ë¦¬ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘');
            
            // DOM ë¡œë“œ í›„ ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ê³  ì´ˆê¸°í™” (Firebase ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ëŒ€ê¸°)
            setTimeout(() => {
                initializeOrderManagement();
                updateDateDisplay();
            }, 100);
        });
        
        // ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜
        function navigateDate(direction) {
            const dateFilter = document.getElementById('date-filter').value;
            
            switch(dateFilter) {
                case 'month':
                    // ì›” ë‹¨ìœ„ë¡œ ì´ë™ - í•´ë‹¹ ì›”ì˜ ì²«ì§¸ ë‚ ë¡œ ì„¤ì •
                    currentDate.setMonth(currentDate.getMonth() + direction);
                    currentDate.setDate(1); // ì›”ì˜ ì²«ì§¸ ë‚ ë¡œ ì„¤ì •
                    break;
                case 'year':
                    // ë…„ ë‹¨ìœ„ë¡œ ì´ë™ - í•´ë‹¹ ë…„ì˜ 1ì›” 1ì¼ë¡œ ì„¤ì •
                    currentDate.setFullYear(currentDate.getFullYear() + direction);
                    currentDate.setMonth(0); // 1ì›”
                    currentDate.setDate(1); // 1ì¼
                    break;
                case 'today':
                default:
                    // ì¼ ë‹¨ìœ„ë¡œ ì´ë™ (ê¸°ë³¸ê°’)
                    currentDate.setDate(currentDate.getDate() + direction);
                    break;
            }
            
            updateDateDisplay();
            
            // ë‚ ì§œ ì´ë™ í›„ í•´ë‹¹ ê¸°ê°„ì˜ ì£¼ë¬¸ í‘œì‹œ
            console.log('ğŸ”„ ë‚ ì§œ ì´ë™ìœ¼ë¡œ ì¸í•œ ì¬í•„í„°ë§:', currentDate.toLocaleDateString('ja-JP'));
            if (allOrders.length > 0) {
                if (dateFilter === 'today') {
                    // ì¼ ë‹¨ìœ„ í•„í„°ëŠ” íŠ¹ì • ë‚ ì§œë§Œ í‘œì‹œ
                    applySpecificDateFilter(allOrders, currentDate);
                } else {
                    // ì›”/ë…„ ë‹¨ìœ„ í•„í„°ëŠ” í•´ë‹¹ ê¸°ê°„ ì „ì²´ í‘œì‹œ
                    applyDateFilter(allOrders, dateFilter);
                }
            } else {
                // ì£¼ë¬¸ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë‹¤ì‹œ ë¡œë“œ
                loadOrders();
            }
        }
        
        // ë‚ ì§œ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateDateDisplay() {
            const dateFilter = document.getElementById('date-filter').value;
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1;
            const date = currentDate.getDate();
            const weekday = currentDate.toLocaleDateString('ja-JP', { weekday: 'short' });
            
            // í˜„ì¬ ë‚ ì§œ í‘œì‹œ (ê¸°ê°„ì— ë”°ë¼ ë‹¤ë¥´ê²Œ)
            document.getElementById('current-year').textContent = `${year}å¹´`;
            
            switch(dateFilter) {
                case 'today':
                    document.getElementById('current-month-day').textContent = `${month}æœˆ${date}æ—¥`;
                    document.getElementById('current-weekday').textContent = `(${weekday})`;
                    break;
                case 'month':
                    document.getElementById('current-month-day').textContent = `${month}æœˆ`;
                    document.getElementById('current-weekday').textContent = '';
                    break;
                case 'year':
                    document.getElementById('current-month-day').textContent = `${year}å¹´`;
                    document.getElementById('current-weekday').textContent = '';
                    break;
                default:
                    document.getElementById('current-month-day').textContent = `${month}æœˆ${date}æ—¥`;
                    document.getElementById('current-weekday').textContent = `(${weekday})`;
                    break;
            }
            
            // ì´ì „/ë‹¤ìŒ ë‚ ì§œ í‘œì‹œ (ê¸°ê°„ì— ë”°ë¼ ë‹¤ë¥´ê²Œ)
            const prevDate = new Date(currentDate);
            const nextDate = new Date(currentDate);
            
            switch(dateFilter) {
                case 'today':
                    prevDate.setDate(currentDate.getDate() - 1);
                    nextDate.setDate(currentDate.getDate() + 1);
                    break;
                case 'month':
                    prevDate.setMonth(currentDate.getMonth() - 1);
                    nextDate.setMonth(currentDate.getMonth() + 1);
                    break;
                case 'year':
                    prevDate.setFullYear(currentDate.getFullYear() - 1);
                    nextDate.setFullYear(currentDate.getFullYear() + 1);
                    break;
                default:
                    prevDate.setDate(currentDate.getDate() - 1);
                    nextDate.setDate(currentDate.getDate() + 1);
                    break;
            }
            
            const formatAdjacentDate = (date, filter) => {
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const weekday = date.toLocaleDateString('ja-JP', { weekday: 'short' });
                
                switch(filter) {
                    case 'today':
                        return `${year}å¹´ ${month}æœˆ${day}æ—¥ (${weekday})`;
                    case 'month':
                        return `${year}å¹´ ${month}æœˆ`;
                    case 'year':
                        return `${year}å¹´`;
                    default:
                        return `${year}å¹´ ${month}æœˆ${day}æ—¥ (${weekday})`;
                }
            };
            
            document.getElementById('prev-date').textContent = formatAdjacentDate(prevDate, dateFilter);
            document.getElementById('next-date').textContent = formatAdjacentDate(nextDate, dateFilter);
        }
        
        // ê¸°ê°„ í•„í„° ë³€ê²½ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
        function onDateFilterChange() {
            const dateFilter = document.getElementById('date-filter').value;
            
            // ê¸°ê°„ì— ë”°ë¼ í˜„ì¬ ë‚ ì§œë¥¼ ì ì ˆíˆ ì„¤ì •
            const now = new Date();
            
            switch(dateFilter) {
                case 'today':
                    // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¤ì •
                    currentDate = new Date(now);
                    break;
                case 'month':
                    // ì´ë²ˆ ë‹¬ 1ì¼ë¡œ ì„¤ì •
                    currentDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    break;
                case 'year':
                    // ì˜¬í•´ 1ì›” 1ì¼ë¡œ ì„¤ì •
                    currentDate = new Date(now.getFullYear(), 0, 1);
                    break;
                case 'all':
                    // ì „ì²´ ê¸°ê°„ì´ë¯€ë¡œ ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ ìˆ¨ê¸°ê¸°
                    document.querySelector('.date-navigation').style.display = 'none';
                    filterOrders();
                    return;
            }
            
            // ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ í‘œì‹œ
            document.querySelector('.date-navigation').style.display = 'block';
            
            // ë‚ ì§œ í‘œì‹œ ì—…ë°ì´íŠ¸
            updateDateDisplay();
            
            // ê¸°ì¡´ ì£¼ë¬¸ ë°ì´í„°ì— ìƒˆë¡œìš´ ë‚ ì§œ í•„í„° ì ìš©
            console.log('ğŸ”„ ë‚ ì§œ í•„í„° ë³€ê²½ìœ¼ë¡œ ì¸í•œ ì¬í•„í„°ë§:', dateFilter);
            if (allOrders.length > 0) {
                if (dateFilter === 'today') {
                    // ì˜¤ëŠ˜ í•„í„° ì„ íƒ ì‹œ currentDateë¥¼ ì˜¤ëŠ˜ë¡œ ì„¤ì •
                    currentDate = new Date();
                    updateDateDisplay();
                }
                applyDateFilter(allOrders, dateFilter);
            } else {
                // ì£¼ë¬¸ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë‹¤ì‹œ ë¡œë“œ
                loadOrders();
            }
        }
        
        // ì£¼ë¬¸ ê´€ë¦¬ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        function initializeOrderManagement() {
            console.log('ğŸ” ì£¼ë¬¸ ê´€ë¦¬ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘');
            
            // Firebase ì´ˆê¸°í™” ìƒíƒœ í™•ì¸ í•¨ìˆ˜
            function checkFirebaseAndLoad() {
                console.log('ğŸ” Firebase ì´ˆê¸°í™” ìƒíƒœ í™•ì¸ ì¤‘...');
                
                // ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ Firebase ìƒíƒœ í™•ì¸
                let isFirebaseReady = false;
                
                // ë°©ë²• 1: window.FirebaseService í™•ì¸ (ë” ì •í™•í•œ í™•ì¸)
                if (window.FirebaseService && window.FirebaseService.db && window.FirebaseService.db.collection) {
                    console.log('âœ… FirebaseService.db ì‚¬ìš© ê°€ëŠ¥');
                    isFirebaseReady = true;
                }
                // ë°©ë²• 2: window.db í™•ì¸ (ë” ì •í™•í•œ í™•ì¸)
                else if (window.db && window.db.collection) {
                    console.log('âœ… window.db ì‚¬ìš© ê°€ëŠ¥');
                    isFirebaseReady = true;
                }
                // ë°©ë²• 3: firebase.apps í™•ì¸
                else if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
                    console.log('âœ… firebase.apps ì‚¬ìš© ê°€ëŠ¥');
                    // FirebaseService ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
                    if (window.FirebaseService) {
                        const firebaseService = new window.FirebaseService();
                        window.FirebaseService.db = firebaseService.db;
                        console.log('âœ… FirebaseService ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì™„ë£Œ');
                        isFirebaseReady = true;
                    }
                }
                
                if (isFirebaseReady) {
                    console.log('ğŸ‰ Firebase ì¤€ë¹„ ì™„ë£Œ, ì£¼ë¬¸ ë°ì´í„° ë¡œë“œ ì‹œì‘');
                    setTimeout(() => {
                        loadOrders();
                    }, 300);
                } else {
                    console.log('â³ Firebase ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘...');
                    console.log('ğŸ” Firebase ìƒíƒœ ë””ë²„ê¹…:', {
                        FirebaseService: !!window.FirebaseService,
                        FirebaseServiceDb: !!window.FirebaseService?.db,
                        FirebaseServiceDbCollection: !!window.FirebaseService?.db?.collection,
                        windowDb: !!window.db,
                        windowDbCollection: !!window.db?.collection,
                        firebaseApps: !!(typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0)
                    });
                }
                
                return isFirebaseReady;
            }
            
            // ì¦‰ì‹œ í™•ì¸ ì‹œë„
            if (!checkFirebaseAndLoad()) {
                // Firebase ì´ˆê¸°í™” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                window.addEventListener('firebaseInitialized', function(event) {
                    console.log('ğŸ‰ Firebase ì´ˆê¸°í™” ì´ë²¤íŠ¸ ìˆ˜ì‹ :', event.detail);
                    checkFirebaseAndLoad();
                });
                
                // ë°±ì—…: ì£¼ê¸°ì  í™•ì¸ (ìµœëŒ€ 15ì´ˆ)
                let attempts = 0;
                const maxAttempts = 30; // 15ì´ˆ (500ms * 30)
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    console.log(`ğŸ”„ Firebase ìƒíƒœ í™•ì¸ ì‹œë„ ${attempts}/${maxAttempts}`);
                    
                    if (checkFirebaseAndLoad() || attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        if (attempts >= maxAttempts) {
                            console.error('âŒ Firebase ì´ˆê¸°í™” ì‹œê°„ ì´ˆê³¼');
                            showError('Firebase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                            
                            // ì¬ì‹œë„ ë²„íŠ¼ ì¶”ê°€
                            const retryButton = document.createElement('button');
                            retryButton.className = 'btn btn-secondary mt-2';
                            retryButton.innerHTML = 'ğŸ”„ ì¬ì‹œë„';
                            retryButton.onclick = () => {
                                window.location.reload();
                            };
                            
                            const errorContainer = document.getElementById('error-container');
                            if (errorContainer) {
                                errorContainer.appendChild(retryButton);
                            }
                        }
                    }
                }, 500);
            }
        }
        
        // ì£¼ë¬¸ ë°ì´í„° ë¡œë“œ
        function loadOrders() {
            console.log('ğŸ“Š Firebaseì—ì„œ ì£¼ë¬¸ ë°ì´í„° ë¡œë“œ ì‹œì‘');
            
            // ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ Firestore ì¸ìŠ¤í„´ìŠ¤ í™•ì¸
            let db = null;
            
            if (window.FirebaseService && window.FirebaseService.db && window.FirebaseService.db.collection) {
                db = window.FirebaseService.db;
                console.log('âœ… FirebaseService.db ì‚¬ìš©');
            } else if (window.db && window.db.collection) {
                db = window.db;
                console.log('âœ… window.db ì‚¬ìš©');
            } else {
                console.error('âŒ Firestore ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                console.log('ğŸ” ì‚¬ìš© ê°€ëŠ¥í•œ ê°ì²´ë“¤:');
                console.log('- window.FirebaseService:', typeof window.FirebaseService);
                console.log('- window.FirebaseService.db:', typeof window.FirebaseService?.db);
                console.log('- window.FirebaseService.db.collection:', typeof window.FirebaseService?.db?.collection);
                console.log('- window.db:', typeof window.db);
                console.log('- window.db.collection:', typeof window.db?.collection);
                showError('Firebase ì—°ê²°ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const ordersRef = db.collection('orders');
            console.log('ğŸ“‹ orders ì»¬ë ‰ì…˜ ì°¸ì¡° ìƒì„± ì™„ë£Œ');
            
            // í˜„ì¬ ë‚ ì§œ í•„í„° ê°’ ê°€ì ¸ì˜¤ê¸°
            const dateFilter = document.getElementById('date-filter')?.value || 'today';
            console.log('ğŸ“… ì ìš©í•  ë‚ ì§œ í•„í„°:', dateFilter);
            
            // ëª¨ë“  ì£¼ë¬¸ì„ ë¡œë“œí•œ í›„ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì—ì„œ í•„í„°ë§
            let query = ordersRef;
            
            // orderByë¥¼ ìœ„í•œ í•„ë“œ ê²°ì • (ì—¬ëŸ¬ í•„ë“œ ì‹œë„)
            let orderByField = 'orderDate';
            try {
                query = query.orderBy('orderDate', 'desc');
            } catch (error) {
                console.log('âš ï¸ orderDateë¡œ ì •ë ¬ ì‹¤íŒ¨, createdAt ì‹œë„:', error);
                orderByField = 'createdAt';
                query = query.orderBy('createdAt', 'desc');
            }
            
            console.log('ğŸ“… ì •ë ¬ í•„ë“œ:', orderByField);
            
            query.get()
                .then((querySnapshot) => {
                    allOrders = [];
                    console.log('ğŸ“‹ Firestore ì¿¼ë¦¬ ê²°ê³¼:', querySnapshot.size, 'ê°œ ë¬¸ì„œ');
                    
                    // ì²« ë²ˆì§¸ ë¬¸ì„œì˜ êµ¬ì¡° í™•ì¸ (ë””ë²„ê¹…ìš©)
                    if (querySnapshot.size > 0) {
                        const firstDoc = querySnapshot.docs[0];
                        console.log('ğŸ” ì²« ë²ˆì§¸ ì£¼ë¬¸ ë¬¸ì„œ êµ¬ì¡°:', firstDoc.data());
                        console.log('ğŸ” ì£¼ë¬¸ ë‚ ì§œ í•„ë“œë“¤:', {
                            orderDate: firstDoc.data().orderDate,
                            createdAt: firstDoc.data().createdAt,
                            timestamp: firstDoc.data().timestamp
                        });
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const orderData = doc.data();
                        orderData.id = doc.id;
                        console.log('ğŸ“„ ì£¼ë¬¸ ë°ì´í„°:', doc.id, orderData);
                        allOrders.push(orderData);
                    });
                    
                    // ë‚ ì§œë³„ë¡œ ë‹¤ì‹œ ì •ë ¬ (ìµœì‹ ìˆœ)
                    allOrders.sort((a, b) => {
                        const dateA = new Date(a.orderDate || a.createdAt || 0);
                        const dateB = new Date(b.orderDate || b.createdAt || 0);
                        return dateB - dateA;
                    });
                    
                    console.log('âœ… ì£¼ë¬¸ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', allOrders.length, 'ê°œ (ìµœì‹ ìˆœ ì •ë ¬)');
                    
                    if (allOrders.length === 0) {
                        console.log('âš ï¸ ì£¼ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. Firebase ì½˜ì†”ì—ì„œ orders ì»¬ë ‰ì…˜ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                        showEmptyState();
                    } else {
                        // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì—ì„œ ë‚ ì§œ í•„í„°ë§ ì ìš©
                        console.log('ğŸ” í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ë‚ ì§œ í•„í„°ë§ ì‹œì‘:', dateFilter);
                        applyDateFilter(allOrders, dateFilter);
                    }
                })
                .catch((error) => {
                    console.error('âŒ ì£¼ë¬¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    
                    // ë‚ ì§œ í•„í„° ì¿¼ë¦¬ ì‹¤íŒ¨ ì‹œ ì „ì²´ ì£¼ë¬¸ ë¡œë“œ ì‹œë„
                    if (dateFilter !== 'all') {
                        console.log('ğŸ”„ ë‚ ì§œ í•„í„° ì‹¤íŒ¨, ì „ì²´ ì£¼ë¬¸ ë¡œë“œ ì‹œë„');
                        ordersRef.orderBy('orderDate', 'desc').get()
                            .then((querySnapshot) => {
                                allOrders = [];
                                console.log('ğŸ“‹ ì „ì²´ ì£¼ë¬¸ ì¿¼ë¦¬ ê²°ê³¼:', querySnapshot.size, 'ê°œ ë¬¸ì„œ');
                                
                                querySnapshot.forEach((doc) => {
                                    const orderData = doc.data();
                                    orderData.id = doc.id;
                                    console.log('ğŸ“„ ì „ì²´ ì£¼ë¬¸ ë°ì´í„°:', doc.id, orderData);
                                    allOrders.push(orderData);
                                });
                                
                                console.log('âœ… ì „ì²´ ì£¼ë¬¸ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', allOrders.length, 'ê°œ (ìµœì‹ ìˆœ ì •ë ¬)');
                                
                                if (allOrders.length === 0) {
                                    console.log('âš ï¸ ì£¼ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. Firebase ì½˜ì†”ì—ì„œ orders ì»¬ë ‰ì…˜ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                                }
                                
                                displayOrders();
                            })
                            .catch((fallbackError) => {
                                console.error('âŒ ì „ì²´ ì£¼ë¬¸ ë¡œë“œë„ ì‹¤íŒ¨:', fallbackError);
                                showError('ì£¼ë¬¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + fallbackError.message);
                            });
                    } else {
                        showError('ì£¼ë¬¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    }
                });
        }
        
        // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ë‚ ì§œ í•„í„°ë§ í•¨ìˆ˜
        function applyDateFilter(orders, dateFilter) {
            console.log('ğŸ” ë‚ ì§œ í•„í„°ë§ ì ìš©:', dateFilter, 'ì£¼ë¬¸ ìˆ˜:', orders.length);
            
            if (dateFilter === 'all') {
                // ì „ì²´ ê¸°ê°„ - ëª¨ë“  ì£¼ë¬¸ í‘œì‹œ
                filteredOrders = [...orders];
                console.log('ğŸ“… ì „ì²´ ê¸°ê°„ í•„í„° ì ìš©:', filteredOrders.length, 'ê°œ ì£¼ë¬¸');
            } else {
                const now = new Date();
                filteredOrders = orders.filter(order => {
                    // ì£¼ë¬¸ ë‚ ì§œ ì¶”ì¶œ (ì—¬ëŸ¬ í•„ë“œ ì‹œë„)
                    let orderDate = null;
                    
                    if (order.orderDate) {
                        if (order.orderDate.toDate && typeof order.orderDate.toDate === 'function') {
                            orderDate = order.orderDate.toDate();
                        } else if (order.orderDate.seconds) {
                            orderDate = new Date(order.orderDate.seconds * 1000);
                        } else {
                            orderDate = new Date(order.orderDate);
                        }
                    } else if (order.createdAt) {
                        if (order.createdAt.toDate && typeof order.createdAt.toDate === 'function') {
                            orderDate = order.createdAt.toDate();
                        } else if (order.createdAt.seconds) {
                            orderDate = new Date(order.createdAt.seconds * 1000);
                        } else {
                            orderDate = new Date(order.createdAt);
                        }
                    } else if (order.timestamp) {
                        orderDate = new Date(order.timestamp);
                    }
                    
                    if (!orderDate || isNaN(orderDate.getTime())) {
                        console.log('âš ï¸ ë‚ ì§œë¥¼ ì°¾ì„ ìˆ˜ ì—†ëŠ” ì£¼ë¬¸:', order.id);
                        return false;
                    }
                    
                    switch(dateFilter) {
                        case 'today':
                            // ì˜¤ëŠ˜ - currentDate ì‚¬ìš© (ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ê³¼ ì¼ì¹˜)
                            return orderDate.toDateString() === currentDate.toDateString();
                            
                        case 'month':
                            // ì„ íƒëœ ë‹¬ - currentDate ê¸°ì¤€
                            return orderDate.getFullYear() === currentDate.getFullYear() && 
                                   orderDate.getMonth() === currentDate.getMonth();
                            
                        case 'year':
                            // ì„ íƒëœ ë…„ - currentDate ê¸°ì¤€
                            return orderDate.getFullYear() === currentDate.getFullYear();
                            
                        default:
                            return true;
                    }
                });
                
                console.log('ğŸ“… ë‚ ì§œ í•„í„°ë§ ê²°ê³¼:', dateFilter, 'â†’', filteredOrders.length, 'ê°œ ì£¼ë¬¸');
            }
            
            updateOrderStatistics();
            displayOrders();
        }
        
        // íŠ¹ì • ë‚ ì§œ í•„í„°ë§ í•¨ìˆ˜ (ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ìš©)
        function applySpecificDateFilter(orders, targetDate) {
            console.log('ğŸ” íŠ¹ì • ë‚ ì§œ í•„í„°ë§ ì ìš©:', targetDate.toLocaleDateString('ja-JP'), 'ì£¼ë¬¸ ìˆ˜:', orders.length);
            
            const startOfDay = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate());
            const endOfDay = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate() + 1);
            
            filteredOrders = orders.filter(order => {
                // ì£¼ë¬¸ ë‚ ì§œ ì¶”ì¶œ (ì—¬ëŸ¬ í•„ë“œ ì‹œë„)
                let orderDate = null;
                
                if (order.orderDate) {
                    if (order.orderDate.toDate && typeof order.orderDate.toDate === 'function') {
                        orderDate = order.orderDate.toDate();
                    } else if (order.orderDate.seconds) {
                        orderDate = new Date(order.orderDate.seconds * 1000);
                    } else {
                        orderDate = new Date(order.orderDate);
                    }
                } else if (order.createdAt) {
                    if (order.createdAt.toDate && typeof order.createdAt.toDate === 'function') {
                        orderDate = order.createdAt.toDate();
                    } else if (order.createdAt.seconds) {
                        orderDate = new Date(order.createdAt.seconds * 1000);
                    } else {
                        orderDate = new Date(order.createdAt);
                    }
                } else if (order.timestamp) {
                    orderDate = new Date(order.timestamp);
                }
                
                if (!orderDate || isNaN(orderDate.getTime())) {
                    console.log('âš ï¸ ë‚ ì§œë¥¼ ì°¾ì„ ìˆ˜ ì—†ëŠ” ì£¼ë¬¸:', order.id);
                    return false;
                }
                
                // í•´ë‹¹ ë‚ ì§œ ë²”ìœ„ ë‚´ì— ìˆëŠ”ì§€ í™•ì¸
                return orderDate >= startOfDay && orderDate < endOfDay;
            });
            
            console.log('ğŸ“… íŠ¹ì • ë‚ ì§œ í•„í„°ë§ ê²°ê³¼:', targetDate.toLocaleDateString('ja-JP'), 'â†’', filteredOrders.length, 'ê°œ ì£¼ë¬¸');
            
            updateOrderStatistics();
            displayOrders();
        }
        
        // ë¹ˆ ìƒíƒœ í‘œì‹œ
        function showEmptyState() {
            const container = document.getElementById('orders-container');
            container.innerHTML = `
                <div class="empty-orders">
                    <i class="fas fa-shopping-cart"></i>
                    <h4 class="japanese-heading">æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h4>
                    <p class="japanese-text">Firebase Firestoreã®ordersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    <p class="japanese-text">ãƒ†ã‚¹ãƒˆç”¨ã®æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ</p>
                    <button class="btn btn-secondary" onclick="createTestOrders()">
                        <i class="fas fa-plus me-2"></i>ãƒ†ã‚¹ãƒˆæ³¨æ–‡ã‚’ä½œæˆ
                    </button>
                </div>
            `;
        }
        
        // í…ŒìŠ¤íŠ¸ ì£¼ë¬¸ ìƒì„±
        function createTestOrders() {
            if (!confirm('ãƒ†ã‚¹ãƒˆç”¨ã®æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            const testOrders = [
                {
                    orderDate: new Date().toISOString(),
                    status: 'pending',
                    items: [
                        { name: 'LALARECIPE BAKUCHINOL EYE CREAM', quantity: 1, price: 2980 },
                        { name: 'YUZU VITA C CREAM', quantity: 2, price: 3500 }
                    ],
                    totalAmount: 9980,
                    customer: { 
                        name: 'ç”°ä¸­å¤ªéƒ', 
                        email: 'tanaka@example.com', 
                        phone: '090-1234-5678' 
                    },
                    shippingAddress: {
                        name: 'ç”°ä¸­å¤ªéƒ',
                        address: 'æ±äº¬éƒ½æ¸‹è°·åŒºæµæ¯”å¯¿1-2-3',
                        phone: '090-1234-5678'
                    }
                },
                {
                    orderDate: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(),
                    status: 'processing',
                    items: [
                        { name: 'COSCELL GREEN PAPAYA PDRN PORE AMPOULE', quantity: 1, price: 4200 }
                    ],
                    totalAmount: 4200,
                    customer: { 
                        name: 'ä½è—¤èŠ±å­', 
                        email: 'sato@example.com', 
                        phone: '090-2345-6789' 
                    },
                    shippingAddress: {
                        name: 'ä½è—¤èŠ±å­',
                        address: 'å¤§é˜ªåºœå¤§é˜ªå¸‚åŒ—åŒºæ¢…ç”°1-1-1',
                        phone: '090-2345-6789'
                    }
                },
                {
                    orderDate: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                    status: 'shipping',
                    items: [
                        { name: 'LUCINDE RETINOL VOLUME EYEBAG CREAM', quantity: 1, price: 3800 },
                        { name: 'MAKE HEAL GREEN PAPAYA PDRN PORE AMPOULE', quantity: 1, price: 4500 }
                    ],
                    totalAmount: 8300,
                    customer: { 
                        name: 'éˆ´æœ¨ä¸€éƒ', 
                        email: 'suzuki@example.com', 
                        phone: '090-3456-7890' 
                    },
                    shippingAddress: {
                        name: 'éˆ´æœ¨ä¸€éƒ',
                        address: 'ç¥å¥ˆå·çœŒæ¨ªæµœå¸‚è¥¿åŒºã¿ãªã¨ã¿ã‚‰ã„2-2-2',
                        phone: '090-3456-7890'
                    }
                }
            ];
            
            console.log('ğŸ“ í…ŒìŠ¤íŠ¸ ì£¼ë¬¸ ë°ì´í„° ìƒì„± ì¤‘...');
            
            // Firebaseì— í…ŒìŠ¤íŠ¸ ì£¼ë¬¸ ì¶”ê°€
            const batch = window.FirebaseService.db.batch();
            testOrders.forEach((order, index) => {
                const docRef = window.FirebaseService.db.collection('orders').doc();
                batch.set(docRef, order);
            });
            
            batch.commit()
                .then(() => {
                    console.log('âœ… í…ŒìŠ¤íŠ¸ ì£¼ë¬¸ ë°ì´í„° ìƒì„± ì™„ë£Œ');
                    showSuccess('ãƒ†ã‚¹ãƒˆæ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚');
                    // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
                    loadOrders();
                })
                .catch((error) => {
                    console.error('âŒ í…ŒìŠ¤íŠ¸ ì£¼ë¬¸ ìƒì„± ì‹¤íŒ¨:', error);
                    showError('ãƒ†ã‚¹ãƒˆæ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                });
        }
        
        // ì£¼ë¬¸ í†µê³„ ì—…ë°ì´íŠ¸
        function updateOrderStatistics() {
            const stats = {
                pending: 0,
                pending_payment: 0,
                processing: 0,
                shipping: 0,
                completed: 0,
                cancelled: 0
            };
            
            allOrders.forEach(order => {
                if (stats.hasOwnProperty(order.status)) {
                    stats[order.status]++;
                }
            });
            
            // pendingê³¼ pending_paymentë¥¼ í•©ì³ì„œ í‘œì‹œ
            document.getElementById('pending-count').textContent = stats.pending + stats.pending_payment;
            document.getElementById('processing-count').textContent = stats.processing;
            document.getElementById('shipping-count').textContent = stats.shipping;
            document.getElementById('completed-count').textContent = stats.completed;
            document.getElementById('cancelled-count').textContent = stats.cancelled;
        }
        
        // í†µê³„ ì¹´ë“œ í´ë¦­ìœ¼ë¡œ í•„í„°ë§
        function filterByStatus(status) {
            console.log('ğŸ“Š í†µê³„ ì¹´ë“œ í´ë¦­:', status);
            
            // ëª¨ë“  í†µê³„ ì¹´ë“œì—ì„œ active í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.stat-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // í´ë¦­ëœ ì¹´ë“œì— active í´ë˜ìŠ¤ ì¶”ê°€
            const clickedCard = document.querySelector(`[data-status="${status}"]`);
            if (clickedCard) {
                clickedCard.classList.add('active');
                console.log('âœ… í™œì„± ì¹´ë“œ ì„¤ì •:', status);
            }
            
            // ìƒíƒœ í•„í„° ì„¤ì •
            document.getElementById('status-filter').value = status;
            
            // í•„í„°ë§ ì ìš©
            filterOrders();
            
            console.log('ğŸ” í•„í„°ë§ ì ìš© ì™„ë£Œ');
        }
        
        // ì£¼ë¬¸ ëª©ë¡ í‘œì‹œ
        function displayOrders() {
            const container = document.getElementById('orders-container');
            
            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <div class="empty-orders">
                        <i class="fas fa-shopping-cart"></i>
                        <h4 class="japanese-heading">æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“</h4>
                        <p class="japanese-text">æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            filteredOrders.forEach(order => {
                html += createOrderItemHTML(order);
            });
            
            container.innerHTML = html;
        }
        
        // ì£¼ë¬¸ ì•„ì´í…œ HTML ìƒì„±
        function createOrderItemHTML(order) {
            // ë‚ ì§œ ì²˜ë¦¬ - ì—¬ëŸ¬ í•„ë“œì—ì„œ ë‚ ì§œ ì°¾ê¸° (ë‚ ì§œ + ì‹œê°„)
            let orderDate = 'ë‚ ì§œ ì—†ìŒ';
            if (order.orderDate) {
                const date = new Date(order.orderDate.seconds ? order.orderDate.seconds * 1000 : order.orderDate);
                if (!isNaN(date.getTime())) {
                    orderDate = date.toLocaleDateString('ja-JP') + ' ' + date.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                }
            } else if (order.createdAt) {
                const date = new Date(order.createdAt.seconds ? order.createdAt.seconds * 1000 : order.createdAt);
                if (!isNaN(date.getTime())) {
                    orderDate = date.toLocaleDateString('ja-JP') + ' ' + date.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
                }
            }
            
            // ê¸ˆì•¡ ì •ë³´ ì²˜ë¦¬
            const subtotal = order.subtotal || order.originalAmount || 0;
            const shippingFee = order.shippingFee || order.shipping?.shippingFee || 0;
            const usedPoints = order.usedPoints || order.pointDiscount || 0;
            const totalAmount = order.totalAmount || 0;
            
            // ê³ ê° ì´ë¦„ ì²˜ë¦¬ - shipping.name ìš°ì„ , ì—¬ëŸ¬ í•„ë“œì—ì„œ ì´ë¦„ ì°¾ê¸°
            let customerName = 'ä¸æ˜';
            if (order.shipping && order.shipping.name && order.shipping.name !== 'null') {
                customerName = order.shipping.name;
            } else if (order.customer && order.customer.name && order.customer.name !== 'null') {
                customerName = order.customer.name;
            } else if (order.userName && order.userName !== 'null') {
                customerName = order.userName;
            } else if (order.customerName && order.customerName !== 'null') {
                customerName = order.customerName;
            }
            
            const customerEmail = order.customer ? order.customer.email : (order.customerEmail || order.userEmail || '');
            
            // ë°°ì†¡ ì£¼ì†Œ ì²˜ë¦¬
            let shippingAddress = '';
            if (order.shipping) {
                const parts = [];
                if (order.shipping.prefecture) parts.push(order.shipping.prefecture);
                if (order.shipping.city) parts.push(order.shipping.city);
                if (order.shipping.address1) parts.push(order.shipping.address1);
                if (order.shipping.address2) parts.push(order.shipping.address2);
                shippingAddress = parts.join(' ');
            }
            
            // ê²°ì œ ë°©ë²• ì²˜ë¦¬
            let paymentMethod = 'ä¸æ˜';
            if (order.paymentMethod) {
                paymentMethod = order.paymentMethod === 'card' ? 'ã‚«ãƒ¼ãƒ‰' : 
                               order.paymentMethod === 'bank-transfer' ? 'éŠ€è¡ŒæŒ¯è¾¼' : order.paymentMethod;
            } else if (order.payment && order.payment.method) {
                paymentMethod = order.payment.method === 'card' ? 'ã‚«ãƒ¼ãƒ‰' : 
                               order.payment.method === 'bank-transfer' ? 'éŠ€è¡ŒæŒ¯è¾¼' : order.payment.method;
            }
            
            return `
                <div class="order-item">
                    <div class="row align-items-center">
                        <div class="col-md-2">
                            <div class="fw-bold">${order.id}</div>
                            <small class="text-muted">${orderDate}</small>
                        </div>
                        <div class="col-md-2">
                            <div class="fw-bold">${customerName}</div>
                            <small class="text-muted">${customerEmail}</small>
                            ${shippingAddress ? `<br><small class="text-muted">${shippingAddress}</small>` : ''}
                        </div>
                        <div class="col-md-2">
                            <span class="order-status status-${order.status}">
                                ${getStatusText(order.status)}
                            </span>
                        </div>
                        <div class="col-md-2">
                            <div class="fw-bold">Â¥${totalAmount.toLocaleString()}</div>
                            <small class="text-muted">å•†å“: Â¥${subtotal.toLocaleString()}</small>
                            ${shippingFee > 0 ? `<br><small class="text-muted">é…é€: Â¥${shippingFee.toLocaleString()}</small>` : ''}
                            ${usedPoints > 0 ? `<br><small class="text-muted">ãƒã‚¤ãƒ³ãƒˆ: -Â¥${usedPoints.toLocaleString()}</small>` : ''}
                            <br><small class="text-muted">${paymentMethod}</small>
                        </div>
                        <div class="col-md-4">
                            <div class="order-actions">
                                <button class="btn btn-action btn-view" onclick="viewOrderDetail('${order.id}')">
                                    <i class="fas fa-eye me-1"></i>è©³ç´°
                                </button>
                                ${getActionButtons(order.status, order.id)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ìƒíƒœë³„ ì•¡ì…˜ ë²„íŠ¼ ìƒì„±
        function getActionButtons(status, orderId) {
            let buttons = '';
            
            // ìƒíƒœë³„ ë©”ì¸ ì•¡ì…˜ ë²„íŠ¼
            switch(status) {
                case 'pending':
                case 'pending_payment':
                    buttons += `
                        <button class="btn btn-action btn-process" onclick="updateOrderStatus('${orderId}', 'processing')">
                            <i class="fas fa-check me-1"></i>å‡¦ç†é–‹å§‹
                        </button>
                    `;
                    break;
                case 'processing':
                    buttons += `
                        <button class="btn btn-action btn-ship" onclick="updateOrderStatus('${orderId}', 'shipping')">
                            <i class="fas fa-truck me-1"></i>é…é€é–‹å§‹
                        </button>
                    `;
                    break;
                case 'shipping':
                    buttons += `
                        <button class="btn btn-action btn-complete" onclick="updateOrderStatus('${orderId}', 'completed')">
                            <i class="fas fa-check-circle me-1"></i>å®Œäº†
                        </button>
                    `;
                    break;
                case 'completed':
                    buttons += `<span class="text-muted">å®Œäº†æ¸ˆã¿</span>`;
                    break;
                case 'cancelled':
                    buttons += `<span class="text-muted">ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿</span>`;
                    break;
            }
            
            // ëª¨ë“  ìƒíƒœì—ì„œ ì·¨ì†Œ ë²„íŠ¼ í‘œì‹œ (ë°˜í’ˆ ì²˜ë¦¬ í¬í•¨)
            if (status !== 'cancelled') {
                // ì™„ë£Œëœ ì£¼ë¬¸ì˜ ê²½ìš° ë°˜í’ˆìœ¼ë¡œ í‘œì‹œ
                const cancelText = status === 'completed' ? 'è¿”å“' : 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
                const cancelIcon = status === 'completed' ? 'fa-undo' : 'fa-times';
                const cancelClass = status === 'completed' ? 'btn btn-action btn-cancel btn-return' : 'btn btn-action btn-cancel';
                
                buttons += `
                    <button class="${cancelClass}" onclick="updateOrderStatus('${orderId}', 'cancelled')">
                        <i class="fas ${cancelIcon} me-1"></i>${cancelText}
                    </button>
                `;
            }
            
            return buttons;
        }
        
        // ìƒíƒœ í…ìŠ¤íŠ¸ ë³€í™˜
        function getStatusText(status) {
            const statusMap = {
                'pending': 'å‡¦ç†å¾…ã¡',
                'pending_payment': 'æ”¯æ‰•ã„å¾…ã¡',
                'processing': 'å‡¦ç†ä¸­',
                'shipping': 'é…é€ä¸­',
                'completed': 'å®Œäº†',
                'cancelled': 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
            };
            return statusMap[status] || status;
        }
        
        // ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸
        async function updateOrderStatus(orderId, newStatus) {
            if (!confirm('æ³¨æ–‡çŠ¶æ…‹ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            if (!window.FirebaseService || !window.FirebaseService.db) {
                console.error('âŒ FirebaseServiceë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                showError('Firebase ì—°ê²°ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            const orderRef = window.FirebaseService.db.collection('orders').doc(orderId);
            
            try {
                await orderRef.update({
                    status: newStatus,
                    updatedAt: new Date().toISOString()
                });
                
                console.log('âœ… ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', orderId, newStatus);
                
                // ë°°ì†¡ ì™„ë£Œ ì‹œ í¬ì¸íŠ¸ ë¶€ì—¬
                if (newStatus === 'delivered' || newStatus === 'completed') {
                    console.log('ğŸ“¦ ë°°ì†¡ ì™„ë£Œ - í¬ì¸íŠ¸ ë¶€ì—¬ ì‹œì‘');
                    const pointResult = await window.FirebaseService.awardPointsOnDelivery(orderId);
                    
                    if (pointResult.success) {
                        console.log('âœ… ë°°ì†¡ ì™„ë£Œ í¬ì¸íŠ¸ ë¶€ì—¬ ì„±ê³µ:', pointResult.pointsEarned);
                        showSuccess(`æ³¨æ–‡å®Œäº†ï¼${pointResult.pointsEarned}ãƒã‚¤ãƒ³ãƒˆãŒä»˜ä¸ã•ã‚Œã¾ã—ãŸã€‚`);
                    } else {
                        console.error('âŒ ë°°ì†¡ ì™„ë£Œ í¬ì¸íŠ¸ ë¶€ì—¬ ì‹¤íŒ¨:', pointResult.error);
                        showError('í¬ì¸íŠ¸ ë¶€ì—¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + pointResult.message);
                    }
                }
                
                // ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸
                const orderIndex = allOrders.findIndex(order => order.id === orderId);
                if (orderIndex !== -1) {
                    allOrders[orderIndex].status = newStatus;
                    updateOrderStatistics();
                    displayOrders();
                }
                
                // ë°°ì†¡ ì‹œì‘ì‹œ ë°°ì†¡ ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ
                if (newStatus === 'shipped') {
                    showShippingModal(orderId);
                } else {
                    // ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡
                    sendOrderStatusNotification(orderId, newStatus);
                }
                
                if (newStatus !== 'delivered' && newStatus !== 'completed') {
                    showSuccess('æ³¨æ–‡çŠ¶æ…‹ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚');
                }
                
            } catch (error) {
                console.error('âŒ ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                showError('æ³¨æ–‡çŠ¶æ…‹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            }
        }

        // ë°°ì†¡ ë²ˆí˜¸ ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ
        function showShippingModal(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'shippingModal';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">é…é€æƒ…å ±å…¥åŠ›</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="trackingNumber" class="form-label">é…é€è¿½è·¡ç•ªå·</label>
                                <input type="text" class="form-control" id="trackingNumber" placeholder="é…é€è¿½è·¡ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                            </div>
                            <div class="mb-3">
                                <label for="shippingCompany" class="form-label">é…é€ä¼šç¤¾</label>
                                <select class="form-select" id="shippingCompany">
                                    <option value="yamato">ãƒ¤ãƒãƒˆé‹è¼¸</option>
                                    <option value="sagawa">ä½å·æ€¥ä¾¿</option>
                                    <option value="japan-post">æ—¥æœ¬éƒµä¾¿</option>
                                    <option value="other">ãã®ä»–</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="estimatedDelivery" class="form-label">é…é”äºˆå®šæ—¥</label>
                                <input type="date" class="form-control" id="estimatedDelivery">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button type="button" class="btn btn-dark" onclick="confirmShipping('${orderId}')">é…é€é–‹å§‹</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // ëª¨ë‹¬ì´ ë‹«í ë•Œ ì œê±°
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }

        // ë°°ì†¡ ì‹œì‘ í™•ì¸
        function confirmShipping(orderId) {
            const trackingNumber = document.getElementById('trackingNumber').value;
            const shippingCompany = document.getElementById('shippingCompany').value;
            const estimatedDelivery = document.getElementById('estimatedDelivery').value;
            
            if (!trackingNumber) {
                alert('é…é€è¿½è·¡ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            if (!window.FirebaseService || !window.FirebaseService.db) {
                console.error('âŒ FirebaseServiceë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                showError('Firebase ì—°ê²°ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            const orderRef = window.FirebaseService.db.collection('orders').doc(orderId);
            
            orderRef.update({
                trackingNumber: trackingNumber,
                shippingCompany: shippingCompany,
                estimatedDelivery: estimatedDelivery,
                shippedAt: new Date().toISOString()
            })
            .then(() => {
                console.log('âœ… ë°°ì†¡ ì •ë³´ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', orderId);
                
                // ë°°ì†¡ ì‹œì‘ ë©”ì¼ ë°œì†¡
                sendShippingStartEmail(orderId);
                
                // ëª¨ë‹¬ ë‹«ê¸°
                const modal = bootstrap.Modal.getInstance(document.getElementById('shippingModal'));
                modal.hide();
                
                showSuccess('é…é€æƒ…å ±ãŒæ›´æ–°ã•ã‚Œã€é…é€é–‹å§‹ãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚');
            })
            .catch((error) => {
                console.error('âŒ ë°°ì†¡ ì •ë³´ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                showError('é…é€æƒ…å ±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            });
        }

        // ë°°ì†¡ ì‹œì‘ ë©”ì¼ ë°œì†¡
        async function sendShippingStartEmail(orderId) {
            try {
                const order = allOrders.find(o => o.id === orderId);
                if (!order) return;
                
                console.log('ë°°ì†¡ ì‹œì‘ ë©”ì¼ ë°œì†¡ ì‹œì‘:', orderId);
                
                const response = await fetch('/.netlify/functions/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        to: order.customerEmail || order.userEmail,
                        subject: 'é…é€é–‹å§‹ã®ãŠçŸ¥ã‚‰ã› - Aether Store',
                        type: 'shipping-start',
                        data: {
                            orderId: orderId,
                            trackingNumber: document.getElementById('trackingNumber').value,
                            customerName: order.customerName || order.userName,
                            estimatedDelivery: document.getElementById('estimatedDelivery').value
                        }
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('ë°°ì†¡ ì‹œì‘ ë©”ì¼ ë°œì†¡ ì™„ë£Œ');
                } else {
                    console.error('ë°°ì†¡ ì‹œì‘ ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨:', result.error);
                }
                
            } catch (error) {
                console.error('ë°°ì†¡ ì‹œì‘ ë©”ì¼ ë°œì†¡ ì˜¤ë¥˜:', error);
            }
        }
        
        // ì£¼ë¬¸ ìƒì„¸ ë³´ê¸°
        function viewOrderDetail(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) {
                showError('æ³¨æ–‡æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            const modalContent = createOrderDetailHTML(order);
            document.getElementById('order-detail-content').innerHTML = modalContent;
            
            const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
            modal.show();
        }
        
        // ì£¼ë¬¸ ìƒì„¸ HTML ìƒì„±
        function createOrderDetailHTML(order) {
            // ë‚ ì§œ ì²˜ë¦¬ - ì—¬ëŸ¬ í•„ë“œì—ì„œ ë‚ ì§œ ì°¾ê¸° (ë‚ ì§œ + ì‹œê°„)
            let orderDate = 'ë‚ ì§œ ì—†ìŒ';
            if (order.orderDate) {
                const date = new Date(order.orderDate.seconds ? order.orderDate.seconds * 1000 : order.orderDate);
                if (!isNaN(date.getTime())) {
                    orderDate = date.toLocaleString('ja-JP');
                }
            } else if (order.createdAt) {
                const date = new Date(order.createdAt.seconds ? order.createdAt.seconds * 1000 : order.createdAt);
                if (!isNaN(date.getTime())) {
                    orderDate = date.toLocaleString('ja-JP');
                }
            }
            
            // ê¸ˆì•¡ ì •ë³´ ì²˜ë¦¬ (ìƒì„¸ ëª¨ë‹¬ìš©)
            const subtotal = order.subtotal || order.originalAmount || 0;
            const shippingFee = order.shippingFee || order.shipping?.shippingFee || 0;
            const usedPoints = order.usedPoints || order.pointDiscount || 0;
            const totalAmount = order.totalAmount || 0;
            
            // ê³ ê° ì´ë¦„ ì²˜ë¦¬ - shipping.name ìš°ì„ , ì—¬ëŸ¬ í•„ë“œì—ì„œ ì´ë¦„ ì°¾ê¸°
            let customerName = 'ä¸æ˜';
            if (order.shipping && order.shipping.name && order.shipping.name !== 'null') {
                customerName = order.shipping.name;
            } else if (order.customer && order.customer.name && order.customer.name !== 'null') {
                customerName = order.customer.name;
            } else if (order.userName && order.userName !== 'null') {
                customerName = order.userName;
            } else if (order.customerName && order.customerName !== 'null') {
                customerName = order.customerName;
            }
            
            const customerEmail = order.customer ? order.customer.email : (order.customerEmail || order.userEmail || 'ä¸æ˜');
            const customerPhone = order.shipping ? order.shipping.phone : (order.customer ? order.customer.phone : (order.customerPhone || 'ä¸æ˜'));
            
            // ë°°ì†¡ ì£¼ì†Œ ì²˜ë¦¬ (ìƒì„¸ ëª¨ë‹¬ìš©)
            let fullShippingAddress = '';
            if (order.shipping) {
                const parts = [];
                if (order.shipping.postal) parts.push(`ã€’${order.shipping.postal}`);
                if (order.shipping.prefecture) parts.push(order.shipping.prefecture);
                if (order.shipping.city) parts.push(order.shipping.city);
                if (order.shipping.address1) parts.push(order.shipping.address1);
                if (order.shipping.address2) parts.push(order.shipping.address2);
                fullShippingAddress = parts.join(' ');
            }
            
            // ê²°ì œ ë°©ë²• ì²˜ë¦¬
            let paymentMethod = 'ä¸æ˜';
            if (order.paymentMethod) {
                paymentMethod = order.paymentMethod === 'card' ? 'ã‚«ãƒ¼ãƒ‰' : 
                               order.paymentMethod === 'bank-transfer' ? 'éŠ€è¡ŒæŒ¯è¾¼' : order.paymentMethod;
            } else if (order.payment && order.payment.method) {
                paymentMethod = order.payment.method === 'card' ? 'ã‚«ãƒ¼ãƒ‰' : 
                               order.payment.method === 'bank-transfer' ? 'éŠ€è¡ŒæŒ¯è¾¼' : order.payment.method;
            }
            
            let itemsHTML = '';
            if (order.items && order.items.length > 0) {
                itemsHTML = order.items.map(item => `
                    <tr>
                        <td>${item.name}</td>
                        <td class="text-center">${item.quantity}</td>
                        <td class="text-end">Â¥${item.price ? item.price.toLocaleString() : '0'}</td>
                        <td class="text-end">Â¥${(item.price * item.quantity).toLocaleString()}</td>
                    </tr>
                `).join('');
            }
            
            return `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="japanese-heading">æ³¨æ–‡æƒ…å ±</h6>
                        <table class="table table-sm">
                            <tr><td>æ³¨æ–‡ç•ªå·:</td><td>${order.id}</td></tr>
                            <tr><td>æ³¨æ–‡æ—¥æ™‚:</td><td>${orderDate}</td></tr>
                            <tr><td>çŠ¶æ…‹:</td><td><span class="order-status status-${order.status}">${getStatusText(order.status)}</span></td></tr>
                            <tr><td>å•†å“é‡‘é¡:</td><td>Â¥${subtotal.toLocaleString()}</td></tr>
                            ${shippingFee > 0 ? `<tr><td>é…é€æ–™:</td><td>Â¥${shippingFee.toLocaleString()}</td></tr>` : ''}
                            ${usedPoints > 0 ? `<tr><td>ãƒã‚¤ãƒ³ãƒˆä½¿ç”¨:</td><td>-Â¥${usedPoints.toLocaleString()}</td></tr>` : ''}
                            <tr><td>åˆè¨ˆé‡‘é¡:</td><td class="fw-bold">Â¥${totalAmount.toLocaleString()}</td></tr>
                            <tr><td>æ”¯æ‰•ã„æ–¹æ³•:</td><td>${paymentMethod}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="japanese-heading">é¡§å®¢æƒ…å ±</h6>
                        <table class="table table-sm">
                            <tr><td>åå‰:</td><td>${customerName}</td></tr>
                            <tr><td>ãƒ¡ãƒ¼ãƒ«:</td><td>${customerEmail}</td></tr>
                            <tr><td>é›»è©±:</td><td>${customerPhone}</td></tr>
                            ${fullShippingAddress ? `<tr><td>é…é€å…ˆ:</td><td>${fullShippingAddress}</td></tr>` : ''}
                        </table>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6 class="japanese-heading">æ³¨æ–‡å•†å“</h6>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>å•†å“å</th>
                                    <th class="text-center">æ•°é‡</th>
                                    <th class="text-end">å˜ä¾¡</th>
                                    <th class="text-end">å°è¨ˆ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHTML}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        // í•„í„°ë§ í•¨ìˆ˜ë“¤
        function filterOrders() {
            const statusFilter = document.getElementById('status-filter').value;
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            console.log('ğŸ” í•„í„°ë§ ì‹œì‘ (ìƒíƒœ ë° ê²€ìƒ‰ì–´ë§Œ):', { statusFilter, searchTerm });
            console.log('ğŸ“Š ì „ì²´ ì£¼ë¬¸ ìˆ˜:', allOrders.length);
            
            filteredOrders = allOrders.filter(order => {
                // ìƒíƒœ í•„í„°
                if (statusFilter) {
                    if (statusFilter === 'pending') {
                        // pending í•„í„°ëŠ” pendingê³¼ pending_payment ëª¨ë‘ í¬í•¨
                        if (order.status !== 'pending' && order.status !== 'pending_payment') {
                            return false;
                        }
                    } else if (order.status !== statusFilter) {
                        return false;
                    }
                }
                
                // ê²€ìƒ‰ í•„í„°
                if (searchTerm) {
                    const searchableText = `${order.id} ${order.customer ? order.customer.name : ''} ${order.customer ? order.customer.email : ''}`.toLowerCase();
                    if (!searchableText.includes(searchTerm)) return false;
                }
                
                return true;
            });
            
            console.log('âœ… í•„í„°ë§ ì™„ë£Œ:', filteredOrders.length, 'ê°œ ì£¼ë¬¸ í‘œì‹œ');
            displayOrders();
        }
        
        function searchOrders() {
            filterOrders();
        }
        
        function clearSearch() {
            document.getElementById('search-input').value = '';
            filterOrders();
        }
        
        function clearAllFilters() {
            // ëª¨ë“  í†µê³„ ì¹´ë“œì—ì„œ active í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.stat-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // í•„í„° ì´ˆê¸°í™”
            document.getElementById('status-filter').value = '';
            document.getElementById('date-filter').value = 'today';
            document.getElementById('search-input').value = '';
            
            // ë‚ ì§œë¥¼ ì˜¤ëŠ˜ë¡œ ì´ˆê¸°í™”
            currentDate = new Date();
            
            // ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ í‘œì‹œ
            document.querySelector('.date-navigation').style.display = 'block';
            
            updateDateDisplay();
            
            // ê¸°ì¡´ ì£¼ë¬¸ ë°ì´í„°ì— ì˜¤ëŠ˜ ë‚ ì§œ í•„í„° ì ìš©
            console.log('ğŸ”„ ë¦¬ì…‹ìœ¼ë¡œ ì¸í•œ ì¬í•„í„°ë§ (ì˜¤ëŠ˜ ë‚ ì§œ)');
            if (allOrders.length > 0) {
                applyDateFilter(allOrders, 'today');
            } else {
                // ì£¼ë¬¸ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë‹¤ì‹œ ë¡œë“œ
                loadOrders();
            }
        }
        
        function refreshOrders() {
            loadOrders();
        }
        
        // CSV ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        function downloadCSV() {
            try {
                console.log('ğŸ“Š CSV ë‹¤ìš´ë¡œë“œ ì‹œì‘');
                
                // í˜„ì¬ í•„í„°ë§ëœ ì£¼ë¬¸ ë°ì´í„° ì‚¬ìš©
                const ordersToExport = filteredOrders.length > 0 ? filteredOrders : allOrders;
                
                if (ordersToExport.length === 0) {
                    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                    return;
                }
                
                // CSV í—¤ë” ì •ì˜
                const headers = [
                    'æ³¨æ–‡ç•ªå·',
                    'æ³¨æ–‡æ—¥æ™‚',
                    'é¡§å®¢å',
                    'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹',
                    'é›»è©±ç•ªå·',
                    'é…é€å…ˆä½æ‰€',
                    'æ³¨æ–‡çŠ¶æ…‹',
                    'æ”¯æ‰•ã„æ–¹æ³•',
                    'å•†å“é‡‘é¡',
                    'é…é€æ–™',
                    'ãƒã‚¤ãƒ³ãƒˆä½¿ç”¨',
                    'åˆè¨ˆé‡‘é¡',
                    'å•†å“è©³ç´°'
                ];
                
                // CSV ë°ì´í„° ìƒì„±
                const csvData = ordersToExport.map(order => {
                    // ë‚ ì§œ ì²˜ë¦¬
                    let orderDate = '';
                    if (order.orderDate) {
                        const date = new Date(order.orderDate.seconds ? order.orderDate.seconds * 1000 : order.orderDate);
                        if (!isNaN(date.getTime())) {
                            orderDate = date.toLocaleString('ja-JP');
                        }
                    } else if (order.createdAt) {
                        const date = new Date(order.createdAt.seconds ? order.createdAt.seconds * 1000 : order.createdAt);
                        if (!isNaN(date.getTime())) {
                            orderDate = date.toLocaleString('ja-JP');
                        }
                    }
                    
                    // ê³ ê° ì´ë¦„ ì²˜ë¦¬
                    let customerName = '';
                    if (order.shipping && order.shipping.name && order.shipping.name !== 'null') {
                        customerName = order.shipping.name;
                    } else if (order.customer && order.customer.name && order.customer.name !== 'null') {
                        customerName = order.customer.name;
                    } else if (order.userName && order.userName !== 'null') {
                        customerName = order.userName;
                    } else if (order.customerName && order.customerName !== 'null') {
                        customerName = order.customerName;
                    }
                    
                    // ì´ë©”ì¼ ì²˜ë¦¬
                    const customerEmail = order.customer ? order.customer.email : (order.customerEmail || order.userEmail || '');
                    
                    // ì „í™”ë²ˆí˜¸ ì²˜ë¦¬
                    const customerPhone = order.shipping ? order.shipping.phone : (order.customer ? order.customer.phone : (order.customerPhone || ''));
                    
                    // ë°°ì†¡ ì£¼ì†Œ ì²˜ë¦¬
                    let shippingAddress = '';
                    if (order.shipping) {
                        const parts = [];
                        if (order.shipping.postal) parts.push(order.shipping.postal);
                        if (order.shipping.prefecture) parts.push(order.shipping.prefecture);
                        if (order.shipping.city) parts.push(order.shipping.city);
                        if (order.shipping.address1) parts.push(order.shipping.address1);
                        if (order.shipping.address2) parts.push(order.shipping.address2);
                        shippingAddress = parts.join(' ');
                    }
                    
                    // ì£¼ë¬¸ ìƒíƒœ ì²˜ë¦¬
                    const orderStatus = getStatusText(order.status);
                    
                    // ê²°ì œ ë°©ë²• ì²˜ë¦¬
                    let paymentMethod = '';
                    if (order.paymentMethod) {
                        paymentMethod = order.paymentMethod === 'card' ? 'ã‚«ãƒ¼ãƒ‰' : 'éŠ€è¡ŒæŒ¯è¾¼';
                    } else if (order.payment && order.payment.method) {
                        paymentMethod = order.payment.method === 'card' ? 'ã‚«ãƒ¼ãƒ‰' : 'éŠ€è¡ŒæŒ¯è¾¼';
                    }
                    
                    // ê¸ˆì•¡ ì •ë³´ ì²˜ë¦¬
                    const subtotal = order.subtotal || order.originalAmount || 0;
                    const shippingFee = order.shippingFee || order.shipping?.shippingFee || 0;
                    const usedPoints = order.usedPoints || order.pointDiscount || 0;
                    const totalAmount = order.totalAmount || 0;
                    
                    // ìƒí’ˆ ìƒì„¸ ì •ë³´ ì²˜ë¦¬
                    let productDetails = '';
                    if (order.items && order.items.length > 0) {
                        productDetails = order.items.map(item => {
                            const quantity = item.quantity || 1;
                            const price = item.price || 0;
                            return `${item.name || item.productName || 'å•†å“'} x${quantity} (Â¥${price.toLocaleString()})`;
                        }).join('; ');
                    }
                    
                    return [
                        order.id || '',
                        orderDate,
                        customerName,
                        customerEmail,
                        customerPhone,
                        shippingAddress,
                        orderStatus,
                        paymentMethod,
                        subtotal.toLocaleString(),
                        shippingFee.toLocaleString(),
                        usedPoints.toLocaleString(),
                        totalAmount.toLocaleString(),
                        productDetails
                    ];
                });
                
                // CSV ë¬¸ìì—´ ìƒì„±
                const csvContent = [
                    headers.join(','),
                    ...csvData.map(row => 
                        row.map(field => {
                            // í•„ë“œì— ì‰¼í‘œë‚˜ ë”°ì˜´í‘œê°€ ìˆìœ¼ë©´ ë”°ì˜´í‘œë¡œ ê°ì‹¸ê¸°
                            const fieldStr = String(field || '');
                            if (fieldStr.includes(',') || fieldStr.includes('"') || fieldStr.includes('\n')) {
                                return `"${fieldStr.replace(/"/g, '""')}"`;
                            }
                            return fieldStr;
                        }).join(',')
                    )
                ].join('\n');
                
                // BOM ì¶”ê°€ (Excelì—ì„œ í•œê¸€ ê¹¨ì§ ë°©ì§€)
                const BOM = '\uFEFF';
                const csvWithBOM = BOM + csvContent;
                
                // íŒŒì¼ëª… ìƒì„± (í˜„ì¬ ë‚ ì§œì™€ í•„í„° ì •ë³´ í¬í•¨)
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const statusFilter = document.getElementById('status-filter').value;
                const dateFilter = document.getElementById('date-filter').value;
                
                let fileName = `æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿_${dateStr}`;
                if (statusFilter) {
                    const statusText = getStatusText(statusFilter);
                    fileName += `_${statusText}`;
                }
                if (dateFilter !== 'all') {
                    fileName += `_${dateFilter}`;
                }
                fileName += '.csv';
                
                // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log(`âœ… CSV ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: ${fileName} (${ordersToExport.length}ê±´)`);
                
                // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                showToast('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success', 3000);
                
            } catch (error) {
                console.error('âŒ CSV ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            }
        }
        
        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showToast(message, type = 'info', duration = 3000) {
            // ê¸°ì¡´ í† ìŠ¤íŠ¸ ì œê±°
            const existingToast = document.querySelector('.custom-toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // í† ìŠ¤íŠ¸ ìƒì„±
            const toast = document.createElement('div');
            toast.className = 'custom-toast';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                background: #f8f9fa;
                border: 1px solid #6c757d;
                border-radius: 8px;
                padding: 12px 16px;
                color: #343a40;
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                font-size: 14px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                animation: slideInRight 0.3s ease-out;
            `;
            
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-check-circle" style="color: #28a745;"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // ìë™ ì œê±°
            setTimeout(() => {
                if (toast && toast.parentNode) {
                    toast.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => {
                        if (toast && toast.parentNode) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, duration);
        }
        
        function exportOrders() {
            // CSV ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ (í–¥í›„ êµ¬í˜„)
            showInfo('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™ã€‚');
        }
        
        function printOrder() {
            window.print();
        }
        
        // ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡
        async function sendOrderStatusNotification(orderId, newStatus) {
            try {
                console.log('ğŸ“§ ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡ ì‹œì‘:', orderId, newStatus);
                
                // ì£¼ë¬¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const orderData = allOrders.find(order => order.id === orderId);
                if (!orderData) {
                    console.error('ì£¼ë¬¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', orderId);
                    return;
                }
                
                // ì·¨ì†Œ ìƒíƒœì¼ ë•Œë§Œ ì·¨ì†Œ ë©”ì¼ ë°œì†¡
                if (newStatus === 'cancelled') {
                    const cancelReason = 'ç®¡ç†è€…ã«ã‚ˆã‚‹ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
                    const result = await window.FirebaseService.sendOrderCancelledEmail(orderData, cancelReason);
                    
                    if (result.success) {
                        console.log('âœ… ì£¼ë¬¸ ì·¨ì†Œ ë©”ì¼ ë°œì†¡ ì™„ë£Œ:', orderId);
                    } else {
                        console.error('âŒ ì£¼ë¬¸ ì·¨ì†Œ ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨:', result.error);
                    }
                }
                
            } catch (error) {
                console.error('âŒ ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡ ì˜¤ë¥˜:', error);
            }
        }
        
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function showSuccess(message) {
            // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ (í–¥í›„ êµ¬í˜„)
            console.log('âœ…', message);
        }
        
        function showError(message) {
            // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ (í–¥í›„ êµ¬í˜„)
            console.error('âŒ', message);
        }
        
        function showInfo(message) {
            // ì •ë³´ ë©”ì‹œì§€ í‘œì‹œ (í–¥í›„ êµ¬í˜„)
            console.log('â„¹ï¸', message);
        }
        
        // ì´ˆê¸° í•„í„°ë§ ì ìš© (ì œê±° - loadOrdersì—ì„œ ì²˜ë¦¬)
    </script>
</body>
</html>
