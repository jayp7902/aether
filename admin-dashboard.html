<!DOCTYPE html>
<html lang="ja">
<head>
    <title>管理者ダッシュボード - Aether</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="cache-control" content="max-age=0">
    <meta name="expires" content="0">
    <meta name="expires" content="Tue, 01 Jan 1980 1:00:00 GMT">
    <meta name="pragma" content="no-cache">
    
    <!-- Google Fonts - Noto Sans JP (小塚 기반) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap&v=3" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap&v=3" rel="stylesheet"></noscript>
    
    <link rel="apple-touch-icon" href="assets/img/aether-icon.png">
    <link rel="shortcut icon" type="image/x-icon" href="assets/img/aether-icon.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/templatemo.css">
    <link rel="stylesheet" href="assets/css/custom.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800;900&display=swap">
    <link rel="stylesheet" href="assets/css/fontawesome.min.css">
    
    <!-- QR Code Scanner Library -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <style>
        body {
            font-family: "Montserrat", sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }
        
        .japanese-text {
            font-family: "Noto Sans JP", "Hiragino Sans", "Yu Gothic", "Meiryo", sans-serif !important;
            font-weight: 400;
            line-height: 1.6;
            font-display: swap;
        }
        
        .japanese-heading {
            font-family: "Noto Sans JP", "Hiragino Sans", "Yu Gothic", "Meiryo", sans-serif !important;
            font-weight: 600;
            line-height: 1.4;
            font-display: swap;
        }
        
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .admin-header {
            background: linear-gradient(135deg, #343a40 0%, #495057 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        /* 날짜 입력 필드 일본어 설정 */
        input[type="date"] {
            color-scheme: light;
        }
        
        /* 커스텀 날짜 입력 필드 컨테이너 */
        .custom-date-input-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .custom-date-input-container input[type="date"] {
            width: 100%;
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #212529;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        
        .custom-date-input-container input[type="date"]:focus {
            color: #212529;
            background-color: #fff;
            border-color: #86b7fe;
            outline: 0;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        
        .custom-date-placeholder {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            font-style: italic;
            pointer-events: none;
            z-index: 1;
            background: white;
            padding: 0 4px;
        }
        
        /* Bootstrap 기본 알림 숨기기 */
        .alert {
            display: none !important;
        }
        
        .alert-success,
        .alert-danger,
        .alert-warning,
        .alert-info {
            display: none !important;
        }
        
        /* 알림 애니메이션 */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* 모바일 반응형 헤더 */
        @media (max-width: 767.98px) {
            .admin-header {
                padding: 20px 15px;
                text-align: center;
            }
            
            .admin-header .row {
                flex-direction: column;
                align-items: center;
            }
            
            .admin-header .col-md-3,
            .admin-header .col-md-6 {
                width: 100%;
                text-align: center;
                margin-bottom: 15px;
            }
            
            .admin-header .col-md-3:last-child {
                margin-bottom: 0;
            }
            
            .admin-header .text-end {
                text-align: center !important;
            }
            
            .admin-header h2 {
                font-size: 1.5rem;
                margin-bottom: 5px;
            }
            
            .admin-header p {
                font-size: 0.9rem;
                margin-bottom: 15px;
            }
            
            .admin-header img {
                max-height: 50px;
                margin-bottom: 10px;
            }
        }
        
        .stats-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        /* 모바일 반응형 통계 섹션 */
        @media (max-width: 767.98px) {
            .stats-section {
                padding: 15px 10px;
                text-align: center;
            }
            
            .stats-section .row {
                justify-content: center;
                margin: 0 -2px;
            }
            
            .stats-section .col-3 {
                padding: 0 2px;
                margin-bottom: 10px;
            }
            
            .stat-card {
                text-align: center;
                padding: 8px 2px;
                border-radius: 6px;
                background: #f8f9fa;
                border: 1px solid #e9ecef;
            }
            
            .stat-number {
                font-size: 1rem;
                font-weight: bold;
                margin-bottom: 3px;
            }
            
            .stat-card .japanese-text {
                font-size: 0.65rem;
                margin: 0;
                line-height: 1.2;
            }
        }
        
        .scanner-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        /* 모바일 반응형 네비게이션 탭 */
        @media (max-width: 767.98px) {
            .admin-nav-tabs {
                text-align: center;
                margin-bottom: 20px;
            }
            
            .admin-nav-tabs .nav {
                flex-direction: column;
                align-items: center;
            }
            
            .admin-nav-tabs .nav-item {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .admin-nav-tabs .nav-link {
                width: 100%;
                text-align: center;
                padding: 12px 20px;
                border-radius: 8px;
            }
        }
        
        .customer-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: none;
        }
        
        .point-management {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }
        
        #scanner-video {
            width: 100%;
            max-width: 400px;
            height: 300px;
            border-radius: 10px;
            border: 3px solid #343a40;
            background: #000;
        }
        
        .scan-overlay {
            position: relative;
            display: inline-block;
        }
        
        .scan-line {
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 2px;
            background: #28a745;
            animation: scan 2s infinite;
        }
        
        @keyframes scan {
            0% { transform: translateY(-150px); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(150px); opacity: 0; }
        }
        
        .btn-large {
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 10px;
            margin: 10px;
            min-width: 200px;
        }
        
        .customer-card {
            background: linear-gradient(135deg, #343a40 0%, #6c757d 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .points-display {
            font-size: 5rem;
            font-weight: 900;
            margin: 10px 0;
            line-height: 1.2;
        }
        
        .amount-input {
            font-size: 1.5rem;
            text-align: center;
            border-radius: 10px;
            border: 2px solid #dee2e6;
            padding: 15px;
        }
        
        .quick-amounts {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .quick-amount-btn {
            padding: 10px 20px;
            border: 2px solid #343a40;
            background: white;
            color: #343a40;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .quick-amount-btn:hover,
        .quick-amount-btn.active {
            background: #343a40;
            color: white;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid #343a40;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #343a40;
        }
        
        .manual-input-section {
            margin-top: 20px;
            padding: 20px;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        /* 상품 카드 반응형 스타일 */
        .product-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid #e9ecef;
        }
        
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .product-card .card-title {
            font-size: 0.9rem;
            font-weight: 600;
            line-height: 1.2;
        }
        
        .product-card .product-meta .badge {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
        }
        
        .product-card .price {
            font-size: 1rem;
            font-weight: 600;
        }
        
        /* 모바일에서 상품 카드 최적화 */
        @media (max-width: 767.98px) {
            .product-card .card-img-top {
                height: 150px !important;
            }
            
            .product-card .card-title {
                font-size: 0.9rem;
                line-height: 1.2;
            }
            
            .product-card .card-text {
                font-size: 0.8rem;
            }
            
            .product-card .product-meta .badge {
                font-size: 0.7rem;
                padding: 0.25rem 0.5rem;
            }
            
            .product-card .price {
                font-size: 0.9rem;
                font-weight: bold;
            }
            
            .product-card .btn-group .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.8rem;
            }
            
            .product-card .btn-group .btn i {
                font-size: 0.8rem;
            }
        }
        
        /* 태블릿에서 상품 카드 최적화 */
        @media (min-width: 768px) and (max-width: 991.98px) {
            .product-card .card-img-top {
                height: 180px !important;
            }
        }
        
        .admin-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
        }
                /* ========== 주문 관리 시스템 스타일 ========== */
        
        /* 네비게이션 탭 스타일 */
        .admin-nav-tabs {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .nav-section {
            margin-bottom: 30px;
        }
        
        .nav-section h5 {
            font-family: "Montserrat", sans-serif;
            font-weight: 300;
            color: #6c757d;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .admin-nav-tabs .nav-pills .nav-link {
            border-radius: 25px;
            margin: 0 5px;
            color: #6c757d;
            border: 2px solid transparent;
            padding: 12px 20px;
            font-weight: 500;
        }

        .admin-nav-tabs .nav-pills .nav-link.active {
            background: #343a40;
            border-color: #343a40;
            color: white;
        }

        .admin-nav-tabs .nav-pills .nav-link:hover {
            background: #f8f9fa;
            border-color: #dee2e6;
        }

        /* 탭 전환 애니메이션 */
        .tab-pane {
            transition: opacity 0.3s ease-in-out;
        }
        
        .tab-pane.fade {
            opacity: 0;
        }
        
        .tab-pane.fade.show {
            opacity: 1;
        }

        /* 탭 컨텐츠 여백 제거 */
        .tab-content {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }
        
        .tab-pane {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }
        
        /* 각 탭 섹션의 여백 제거 */
        .brand-management,
        .product-management,
        .customer-management,
        .analytics-management {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }
        
        /* 브랜드/상품 관리 헤더 여백 제거 */
        .brand-header,
        .product-header {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }

        /* 모든 탭 컨텐츠의 여백 완전 제거 */
        #admin-tab-content {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }
        
        #admin-tab-content > .tab-pane {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }
        
        /* 네비게이션 탭과 컨텐츠 사이 간격 제거 */
        .admin-nav-tabs + .tab-content {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }

        /* 탭 컨텐츠 기본 숨김 */
        .tab-pane {
            display: none !important;
        }
        
        /* 활성 탭만 표시 */
        .tab-pane.show {
            display: block !important;
        }

        /* 포인트 관리 탭 내부 섹션들 초기 상태 */
        #points-section .scanner-section {
            display: block;
        }
        
        #points-section .customer-section {
            display: none;
        }
        
        #points-section .point-management {
            display: none;
        }

        /* 주문 관리 스타일 */
        .order-management {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            margin-top: 0 !important;
            padding-top: 0 !important;
        }

        .order-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .order-stat-card {
            background: linear-gradient(135deg, #343a40 0%, #495057 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .order-stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .order-filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .order-card {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
            background: white;
        }

        .order-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .order-id {
            font-size: 1.1rem;
            font-weight: bold;
            color: #343a40;
        }

        .order-date {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .order-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            text-align: center;
            min-width: 90px;
        }

        .status-pending { background: #fff3cd; color: #856404; }
        .status-processing { background: #cce5ff; color: #004085; }
        .status-shipping { background: #d1ecf1; color: #0c5460; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }

        .order-customer {
            margin-bottom: 10px;
        }

        .customer-name {
            font-weight: 600;
            color: #343a40;
        }

        .customer-email {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .order-items {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .item-row:last-child {
            border-bottom: none;
        }

        .item-name {
            font-weight: 500;
            flex: 1;
        }

        .item-quantity {
            color: #6c757d;
            margin: 0 10px;
            min-width: 50px;
        }

        .item-price {
            font-weight: bold;
            color: #343a40;
            min-width: 80px;
            text-align: right;
        }

        .order-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #dee2e6;
        }

        .total-amount {
            font-size: 1.3rem;
            font-weight: bold;
            color: #343a40;
        }

        .order-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .empty-orders {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-orders i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* ========== 브랜드/상품 관리 시스템 스타일 ========== */

        /* 탭 컨텐츠 여백 조정 */
        .tab-pane {
            padding-top: 0 !important;
            margin-top: 0 !important;
        }
        
        .tab-content {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }
        
        #admin-tab-content {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }
        
        /* Bootstrap 탭 기본 여백 오버라이드 */
        .tab-content > .tab-pane {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }
        
        .tab-content > .active {
            margin-top: 0 !important;
            padding-top: 0 !important;
        }
        
        /* 중복된 네비게이션 버튼 숨기기 */
        .tab-content .nav-pills {
            display: none !important;
        }
        
        .tab-content .admin-nav-tabs {
            display: none !important;
        }
        
        /* 탭 컨텐츠 내부의 중복된 버튼들 숨기기 */
        .tab-pane .nav-pills {
            display: none !important;
        }
        
        .tab-pane .admin-nav-tabs {
            display: none !important;
        }

        /* 브랜드 관리 스타일 */
        .brand-management, .product-management {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            margin-top: 0 !important;
            padding-top: 0 !important;
        }

        .brand-card, .product-card {
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            background: white;
        }

        .brand-card:hover, .product-card:hover {
            border-color: #6c757d;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .brand-logo {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }

        .product-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }

        .brand-header, .product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            margin-top: 0 !important;
            padding-top: 0 !important;
        }

        .brand-actions, .product-actions {
            display: flex;
            gap: 10px;
        }

        /* 이미지 업로드 스타일 */
        .image-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .image-upload-area:hover {
            border-color: #6c757d;
            background: #e9ecef;
        }

        .image-upload-area.drag-over {
            border-color: #28a745;
            background: #d4edda;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);
        }

        .image-upload-area.small {
            padding: 20px;
            min-height: 120px;
        }

        .image-upload-area.small .fa-2x {
            font-size: 1.5rem;
        }

        .upload-icon {
            font-size: 3rem;
            color: #6c757d;
            margin-bottom: 15px;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        /* 상태 배지 스타일 */
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        /* 검색/필터 스타일 */
        .search-filter-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        
        .filter-row .col-md-4 {
            margin-left: auto;
        }

        /* 통계 카드 */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .mini-stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 2px solid #dee2e6;
        }

        /* 모달 배경 클릭 방지 */
        .modal-backdrop {
            pointer-events: none;
        }
        
        .modal-backdrop.show {
            pointer-events: auto;
        }
        
        #brandModal {
            pointer-events: auto;
        }
        
        #brandModal .modal-dialog {
            pointer-events: auto;
        }

        .mini-stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #343a40;
        }

        .mini-stat-label {
            color: #6c757d;
            font-size: 14px;
            margin-top: 5px;
        }

        /* 탭 전환 스타일 */
        .tab-pane {
            display: none;
        }
        
        .tab-pane.show.active {
            display: block;
        }
        
        /* 뱃지 날짜 필드 컨테이너 */
        #badge-date-fields-container {
            display: block !important;
            visibility: visible !important;
        }
        
        /* 일본어 날짜 필드 스타일 */
        #product-badge-start,
        #product-badge-end {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif;
            direction: ltr;
            text-align: left;
        }
        
        #product-badge-start[lang="ja-JP"],
        #product-badge-end[lang="ja-JP"] {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif;
        }
        
        .card.mt-4 {
            display: block !important;
            visibility: visible !important;
        }
        
        /* 포인트 관리 탭은 기본적으로 표시 */
        #points-section {
            display: block;
        }
        
        /* 탭 컨텐츠 여백 추가 */
        .tab-pane {
            padding-top: 2rem;
        }
        
        .tab-pane .order-management,
        .tab-pane .brand-management,
        .tab-pane .product-management,
        .tab-pane .scanner-section {
            margin-top: 1rem;
            padding-top: 3rem !important;
        }
        
        /* 개별 클래스별 패딩 강제 적용 */
        .order-management {
            padding-top: 3rem !important;
        }
        
        .brand-management {
            padding-top: 3rem !important;
        }
        
        .product-management {
            padding-top: 3rem !important;
        }
        
        .scanner-section {
            padding-top: 3rem !important;
        }
        
        /* 브랜드 관리 모바일 최적화 */
        @media (max-width: 767.98px) {
            .brand-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .brand-header .d-flex {
                width: 100%;
            }
            
            .brand-header .btn {
                width: 100%;
                padding: 12px 20px;
                font-size: 1rem;
            }
            
            /* 통계 카드 모바일 최적화 */
            .mini-stat-card {
                padding: 15px 10px;
                margin-bottom: 10px;
            }
            
            .mini-stat-number {
                font-size: 1.5rem;
            }
            
            .mini-stat-label {
                font-size: 0.8rem;
            }
            
            /* 브랜드 카드 모바일 최적화 - 2개씩 배치 */
            #brands-container {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .brand-card {
                flex: 0 0 calc(50% - 5px);
                min-width: 0;
            }
            
            .brand-card .row {
                flex-direction: column;
            }
            
            .brand-card .col-md-1,
            .brand-card .col-md-2,
            .brand-card .col-md-3 {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .brand-card .brand-logo {
                max-width: 60px;
                max-height: 60px;
                margin: 0 auto;
                display: block;
            }
            
            .brand-card h5 {
                font-size: 1rem;
                text-align: center;
            }
            
            .brand-card p {
                font-size: 0.8rem;
                text-align: center;
            }
            
            .brand-card .brand-actions {
                text-align: center;
            }
            
            .brand-card .brand-actions .btn {
                width: 100%;
                margin-bottom: 5px;
                font-size: 0.8rem;
                padding: 8px 12px;
            }
        }

        /* 포인트 이력 스타일 */
        .point-history-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .point-history-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .point-history-list {
            padding: 0;
        }

        .point-history-item {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 15px 20px;
            transition: background-color 0.2s ease;
        }

        .point-history-item:last-child {
            border-bottom: none;
        }

        .point-history-item:hover {
            background-color: #f8f9fa;
        }

        .point-description {
            font-weight: 500;
            color: #343a40;
            margin-bottom: 5px;
        }

        .point-amount {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .point-amount.text-success {
            color: #343a40 !important;
        }

        .point-amount.text-danger {
            color: #dc3545 !important;
        }

        /* 모바일 반응형 */
        @media (max-width: 767.98px) {
            .point-history-section {
                padding: 15px;
            }
            
            .point-history-item {
                padding: 12px 15px;
            }
            
            .point-description {
                font-size: 0.9rem;
            }
            
            .point-amount {
                font-size: 1rem;
            }
        }

        /* 기간 선택 기능 스타일 */
        .period-selector {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .period-selector .btn-group .btn {
            border-radius: 4px;
            margin-right: 2px;
            font-weight: 500;
            min-width: 50px;
        }

        .period-selector .btn-group .btn.active {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }

        .period-selector .btn-group .btn:not(.active) {
            background-color: white;
            border-color: #6c757d;
            color: #6c757d;
        }

        .period-selector .btn-group .btn:not(.active):hover {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }

        .date-navigation .btn {
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .date-navigation .btn:hover {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }

        #current-period {
            font-size: 1rem;
            color: #495057;
            min-width: 150px;
            text-align: center;
        }

        /* 반응형 기간 선택 */
        @media (max-width: 768px) {
            .period-selector .d-flex {
                flex-direction: column;
                gap: 1rem;
            }
            
            .period-selector .btn-group {
                justify-content: center;
            }
            
            .date-navigation {
                justify-content: center;
            }
            
            #current-period {
                font-size: 0.9rem;
                min-width: 120px;
            }
        }

        /* 매출 분석 카드 반응형 */
        @media (max-width: 768px) {
            .card-body .row .col-3 {
                margin-bottom: 1rem;
            }
            
            .card-body .row .col-3:last-child {
                margin-bottom: 0;
            }
        }

        @media (max-width: 576px) {
            .card-body .row .col-3 {
                margin-bottom: 0.5rem;
            }
            
            .card-body .row .col-3 h4 {
                font-size: 1.1rem;
            }
            
            .card-body .row .col-3 p {
                font-size: 0.85rem;
            }
        }
    </style>
</head>

<body>
    <!-- 관리자 알림 -->
    <div id="admin-alert-container"></div>

    <div class="admin-container">
        <!-- 관리자 헤더 -->
        <div class="admin-header">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <img src="assets/img/logo.png" alt="Aether Logo" class="img-fluid" style="max-height: 60px;">
                </div>
                <div class="col-md-6">
                    <h2 class="mb-0 japanese-heading">管理者ダッシュボード</h2>
                    <p class="mb-0 japanese-text">ポイント管理システム</p>
                </div>
                <div class="col-md-3 text-end">
                    <div class="japanese-text">
                        <div><i class="fas fa-user-shield me-1"></i><span id="admin-name"></span></div>
                        <div id="current-time" style="font-size: 1.1rem; font-weight: bold;"></div>
                        <button class="btn btn-outline-light btn-sm mt-1" onclick="logout()">
                            <i class="fas fa-sign-out-alt me-1"></i>ログアウト
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 일일 통계 섹션 -->
        <div class="stats-section">
            <h3 class="japanese-heading mb-4">
                <i class="fas fa-chart-bar me-2"></i>本日の実績
            </h3>
            <div class="row">
                <div class="col-3 col-md-3">
                    <div class="stat-card">
                        <div class="stat-number" id="today-earned">0</div>
                        <div class="japanese-text">獲得ポイント</div>
                    </div>
                </div>
                <div class="col-3 col-md-3">
                    <div class="stat-card">
                        <div class="stat-number" id="today-used">0</div>
                        <div class="japanese-text">使用ポイント</div>
                    </div>
                </div>
                <div class="col-3 col-md-3">
                    <div class="stat-card">
                        <div class="stat-number" id="today-transactions">0</div>
                        <div class="japanese-text">取引回数</div>
                    </div>
                </div>
                <div class="col-3 col-md-3">
                    <div class="stat-card">
                        <div class="stat-number" id="today-customers">0</div>
                        <div class="japanese-text">お客様数</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 관리자 네비게이션 탭 -->
        <div class="admin-nav-tabs">
            <!-- 비즈니스 관리 섹션 -->
            <div class="nav-section mb-4">
                <h5 class="text-muted mb-3 text-center">
                    <i class="fas fa-briefcase me-2"></i>ビジネス管理
                </h5>
                <ul class="nav nav-pills justify-content-center" id="business-nav" role="tablist">
                <li class="nav-item" role="presentation">
                                                <button class="nav-link active" id="points-tab" type="button" role="tab" aria-controls="points-section" aria-selected="true" onclick="switchToPoints()">
                        <i class="fas fa-coins me-2"></i>ポイント管理
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                        <button class="nav-link" id="orders-tab" type="button" role="tab" aria-controls="orders-section" aria-selected="false" onclick="switchToOrders()">
                        <i class="fas fa-shopping-cart me-2"></i>注文管理
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                        <button class="nav-link" id="brands-tab" type="button" role="tab" aria-controls="brands-section" aria-selected="false" onclick="switchToBrands()">
                        <i class="fas fa-building me-2"></i>ブランド管理
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                        <button class="nav-link" id="products-tab" type="button" role="tab" aria-controls="products-section" aria-selected="false" onclick="switchToProducts()">
                        <i class="fas fa-box me-2"></i>商品管理
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                        <button class="nav-link" id="customers-tab" type="button" role="tab" aria-controls="customers-section" aria-selected="false" onclick="switchToCustomers()">
                        <i class="fas fa-users me-2"></i>顧客管理
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                        <button class="nav-link" id="analytics-tab" type="button" role="tab" aria-controls="analytics-section" aria-selected="false" onclick="switchToAnalytics()">
                        <i class="fas fa-chart-line me-2"></i>分析
                    </button>
                </li>
            </ul>
            </div>
            
            <!-- 콘텐츠 관리 섹션 -->
            <div class="nav-section">
                <h5 class="text-muted mb-3 text-center">
                    <i class="fas fa-palette me-2"></i>コンテンツ管理
                </h5>
                <ul class="nav nav-pills justify-content-center" id="content-nav" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="homepage-tab" type="button" role="tab" aria-controls="homepage-section" aria-selected="false" onclick="switchToHomepageTab()">
                            <i class="fas fa-home me-2"></i>ホームページ管理
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="footer-tab" type="button" role="tab" aria-controls="footer-section" aria-selected="false" onclick="switchToFooterTab()">
                            <i class="fas fa-shoe-prints me-2"></i>フッター管理
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- 탭 컨텐츠 -->
        <div class="tab-content" id="admin-tab-content">
            <!-- 포인트 관리 탭 -->
            <div class="tab-pane fade show active" id="points-section" role="tabpanel" aria-labelledby="points-tab">
        <!-- QR스캐너 섹션 -->
                <div class="scanner-section pt-5" id="scanner-section">
            <h3 class="japanese-heading mb-4">
                <i class="fas fa-qrcode me-2"></i>QRコードスキャン
            </h3>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="scan-overlay">
                        <video id="scanner-video" autoplay muted playsinline></video>
                        <div class="scan-line"></div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-dark btn-large" onclick="startScanner()">
                            <i class="fas fa-camera me-2"></i>スキャン開始
                        </button>
                        <button class="btn btn-secondary btn-large" onclick="stopScanner()">
                            <i class="fas fa-stop me-2"></i>停止
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="manual-input-section">
                        <h5 class="japanese-heading">手動入力</h5>
                        <p class="japanese-text text-muted">QRコードが読み取れない場合</p>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="manual-qr-input" placeholder="QRトークンを入力">
                            <button class="btn btn-outline-secondary" onclick="processManualQR()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5 class="japanese-heading">顧客検索</h5>
                        <div class="input-group mb-3">
                            <input type="email" class="form-control" id="customer-email-search" placeholder="メールアドレスで検索">
                            <button class="btn btn-outline-secondary" onclick="searchCustomerByEmail()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 고객 정보 섹션 -->
        <div class="customer-section" id="customer-section">
            <h3 class="japanese-heading mb-4">
                <i class="fas fa-user me-2"></i>お客様情報
            </h3>
            
            <div class="customer-card">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="mb-1" id="customer-name">お客様名</h4>
                        <p class="mb-0" id="customer-email">メールアドレス</p>
                        <small id="customer-last-visit">最終訪問: -</small>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="japanese-text">現在のポイント</div>
                        <div class="points-display" id="customer-points">0</div>
                        <div class="japanese-text">Point</div>
                    </div>
                </div>
            </div>

            <!-- 포인트 이력 섹션 -->
            <div class="point-history-section mt-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="japanese-heading mb-0">
                        <i class="fas fa-history me-2"></i>ポイント履歴
                    </h5>
                    <button class="btn btn-outline-secondary btn-sm" onclick="refreshCustomerPointHistory()">
                        <i class="fas fa-sync-alt me-1"></i>更新
                    </button>
                </div>
                
                <div class="point-history-container">
                    <div id="customer-point-history" class="point-history-list">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-history fa-2x mb-2"></i>
                            <p class="japanese-text">ポイント履歴がありません</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center">
                <button class="btn btn-outline-secondary btn-large" onclick="resetScanner()">
                    <i class="fas fa-arrow-left me-2"></i>戻る
                </button>
                <button class="btn btn-dark btn-large" onclick="showPointManagement()">
                    <i class="fas fa-coins me-2"></i>ポイント管理
                </button>
            </div>
        </div>

        <!-- 포인트 관리 섹션 -->
        <div class="point-management" id="point-management">
            <h3 class="japanese-heading mb-4">
                <i class="fas fa-coins me-2"></i>ポイント管理
            </h3>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="japanese-heading mb-0">購入ポイント付与</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label japanese-text">購入金額（円）</label>
                                <input type="number" class="form-control amount-input" id="purchase-amount" placeholder="0" min="0">
                            </div>
                            
                            <div class="quick-amounts">
                                <div class="quick-amount-btn" onclick="setPurchaseAmount(1000)">¥1,000</div>
                                <div class="quick-amount-btn" onclick="setPurchaseAmount(2000)">¥2,000</div>
                                <div class="quick-amount-btn" onclick="setPurchaseAmount(3000)">¥3,000</div>
                                <div class="quick-amount-btn" onclick="setPurchaseAmount(5000)">¥5,000</div>
                                <div class="quick-amount-btn" onclick="setPurchaseAmount(10000)">¥10,000</div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label japanese-text">付与ポイント（3%）</label>
                                <div class="input-group">
                                    <input type="number" class="form-control amount-input" id="points-to-add" readonly>
                                    <span class="input-group-text">P</span>
                                </div>
                            </div>
                            
                            <button class="btn btn-dark btn-large w-100" onclick="addPurchasePoints()">
                                <i class="fas fa-plus me-2"></i>ポイント付与
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="japanese-heading mb-0">手動ポイント操作</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label japanese-text">ポイント数</label>
                                <input type="number" class="form-control amount-input" id="manual-points" placeholder="0" min="0">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label japanese-text">理由</label>
                                <select class="form-control" id="point-reason">
                                    <option value="店舗購入">店舗購入</option>
                                    <option value="特別付与">特別付与</option>
                                    <option value="イベント特典">イベント特典</option>
                                    <option value="誕生日特典">誕生日特典</option>
                                    <option value="キャンペーン">キャンペーン</option>
                                    <option value="ポイント使用">ポイント使用</option>
                                    <option value="修正">修正</option>
                                    <option value="その他">その他</option>
                                </select>
                            </div>
                            
                            <div class="row">
                                <div class="col-6">
                                    <button class="btn btn-secondary w-100" onclick="addManualPoints()">
                                        <i class="fas fa-plus me-2"></i>追加
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-outline-secondary w-100" onclick="subtractManualPoints()">
                                        <i class="fas fa-minus me-2"></i>差引
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <button class="btn btn-outline-secondary btn-large" onclick="backToCustomerInfo()">
                    <i class="fas fa-arrow-left me-2"></i>お客様情報に戻る
                </button>
                <button class="btn btn-dark btn-large" onclick="resetScanner()">
                    <i class="fas fa-home me-2"></i>最初に戻る
                </button>
            </div>
        </div>
    </div>

                </div>
            </div>
            <!-- 포인트 관리 탭 끝 -->

            <!-- 주문 관리 탭 -->
            <div class="tab-pane fade" id="orders-section" role="tabpanel" aria-labelledby="orders-tab">
                <div class="order-management pt-5">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="japanese-heading mb-0">
                            <i class="fas fa-shopping-cart me-2"></i>注文管理
                        </h3>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary" onclick="refreshOrders()">
                                <i class="fas fa-sync-alt me-1"></i>更新
                            </button>
                            <button class="btn btn-dark" onclick="exportOrders()">
                                <i class="fas fa-download me-1"></i>エクスポート
                            </button>
                        </div>
                    </div>

                    <!-- 주문 통계 -->
                    <div class="order-stats-grid">
                        <div class="order-stat-card">
                            <div class="order-stat-number" id="today-orders">0</div>
                            <div class="stat-label japanese-text">本日の注文</div>
                        </div>
                        <div class="order-stat-card">
                            <div class="order-stat-number" id="today-sales">¥0</div>
                            <div class="stat-label japanese-text">本日の売上</div>
                        </div>
                        <div class="order-stat-card">
                            <div class="order-stat-number" id="pending-orders">0</div>
                            <div class="stat-label japanese-text">処理待ち</div>
                        </div>
                        <div class="order-stat-card">
                            <div class="order-stat-number" id="total-customers">0</div>
                            <div class="stat-label japanese-text">総顧客数</div>
                        </div>
                    </div>

                    <!-- 주문 필터 -->
                    <div class="order-filters">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label japanese-text">注文状態</label>
                                <select class="form-select" id="status-filter" onchange="filterOrders()">
                                    <option value="">全て</option>
                                    <option value="pending">処理待ち</option>
                                    <option value="processing">処理中</option>
                                    <option value="shipping">配送中</option>
                                    <option value="completed">完了</option>
                                    <option value="cancelled">キャンセル</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label japanese-text">期間</label>
                                <select class="form-select" id="date-filter" onchange="filterOrders()">
                                    <option value="today">今日</option>
                                    <option value="week">今週</option>
                                    <option value="month">今月</option>
                                    <option value="all">全期間</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label japanese-text">検索</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="search-input" placeholder="注文番号、顧客名で検索" onkeyup="searchOrders()">
                                    <button class="btn btn-outline-secondary" onclick="clearSearch()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label japanese-text">&nbsp;</label>
                                <div>
                                    <button class="btn btn-outline-secondary w-100" onclick="clearAllFilters()">
                                        <i class="fas fa-filter me-1"></i>リセット
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 주문 목록 -->
                    <div id="orders-container">
                        <div class="empty-orders">
                            <i class="fas fa-shopping-cart"></i>
                            <h4 class="japanese-heading">注文データを読み込み中...</h4>
                            <p class="japanese-text">잠시만 기다려주세요.</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 주문 관리 탭 끝 -->

            <!-- 브랜드 관리 탭 -->
            <div class="tab-pane fade" id="brands-section" role="tabpanel" aria-labelledby="brands-tab">
                <div class="brand-management pt-5">
                    <!-- 브랜드 관리 헤더 -->
                    <div class="brand-header">
                        <h3 class="japanese-heading">
                            <i class="fas fa-building me-2"></i>ブランド管理
                        </h3>
                        <div class="d-flex gap-2">
                            <button class="btn btn-dark" onclick="showAddBrandModal()">
                                <i class="fas fa-plus me-2"></i>新しいブランドを追加
                            </button>
                            <div class="btn-group">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-tag me-2"></i>バッジ管理
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="updateBrandsWithBadges()">
                                        <i class="fas fa-plus me-2"></i>バッジフィールド追加
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="addSampleBadgesToBrands()">
                                        <i class="fas fa-palette me-2"></i>サンプルバッジ追加
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="resetBrandBadges()">
                                        <i class="fas fa-trash me-2"></i>バッジ情報初期化
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 브랜드 통계 -->
                    <div class="row mb-4">
                        <div class="col-4">
                        <div class="mini-stat-card">
                            <div class="mini-stat-number" id="total-brands">0</div>
                            <div class="mini-stat-label">総ブランド数</div>
                        </div>
                        </div>
                        <div class="col-4">
                        <div class="mini-stat-card">
                            <div class="mini-stat-number" id="active-brands">0</div>
                            <div class="mini-stat-label">アクティブブランド</div>
                        </div>
                        </div>
                        <div class="col-4">
                        <div class="mini-stat-card">
                            <div class="mini-stat-number" id="total-products">0</div>
                            <div class="mini-stat-label">総商品数</div>
                            </div>
                        </div>
                    </div>

                    <!-- 검색/필터 섹션 -->
                    <div class="search-filter-section">
                        <div class="filter-row">
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="brand-search" placeholder="ブランド検索..." oninput="filterBrands()">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="brand-status-filter" onchange="filterBrands()">
                                    <option value="">全ステータス</option>
                                    <option value="active">アクティブ</option>
                                    <option value="inactive">非アクティブ</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary" onclick="clearBrandFilters()">
                                    <i class="fas fa-times me-1"></i>リセット
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 브랜드 목록 -->
                    <div id="brands-container">
                        <div class="text-center py-5">
                            <i class="fas fa-building fa-3x text-muted mb-3"></i>
                            <p class="text-muted">登録されたブランドがありません。</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 상품 관리 탭 -->
            <div class="tab-pane fade" id="products-section" role="tabpanel" aria-labelledby="products-tab">
                <div class="product-management pt-5">
                    <!-- 상품 관리 헤더 -->
                    <div class="product-header">
                        <h3 class="japanese-heading">
                            <i class="fas fa-box me-2"></i>商品管理
                        </h3>
                        <div class="d-flex gap-2">
                            <button class="btn btn-dark" onclick="console.log('버튼 클릭됨'); if (typeof window.showAddProductModal === 'function') { window.showAddProductModal(); } else { console.error('showAddProductModal 함수를 찾을 수 없습니다'); }">
                                <i class="fas fa-plus me-2"></i>新しい商品を追加
                            </button>
                            <div class="btn-group">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-tag me-2"></i>商品バッジ管理
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="updateProductsWithBadges()">
                                        <i class="fas fa-plus me-2"></i>バッジフィールド追加
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="addSampleBadgesToProducts()">
                                        <i class="fas fa-palette me-2"></i>サンプルバッジ追加
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="resetProductBadges()">
                                        <i class="fas fa-trash me-2"></i>バッジ情報初期化
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 상품 통계 -->
                    <div class="row mb-4">
                        <div class="col-4">
                        <div class="mini-stat-card">
                            <div class="mini-stat-number" id="total-products-count">0</div>
                                <div class="mini-stat-label">総商品数</div>
                        </div>
                        </div>
                        <div class="col-4">
                        <div class="mini-stat-card">
                            <div class="mini-stat-number" id="active-products">0</div>
                                <div class="mini-stat-label">アクティブ商品</div>
                        </div>
                        </div>
                        <div class="col-4">
                        <div class="mini-stat-card">
                            <div class="mini-stat-number" id="low-stock-products">0</div>
                                <div class="mini-stat-label">在庫不足</div>
                            </div>
                        </div>
                    </div>

                    <!-- 검색 섹션 -->
                    <div class="search-filter-section">
                        <div class="filter-row">
                            <div class="col-md-6">
                                <input type="text" class="form-control" id="product-search" placeholder="商品名（英語）で検索..." onkeyup="filterProducts()">
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="brand-filter" onchange="filterProducts()">
                                    <option value="">すべてのブランド</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 상품 목록 -->
                    <div id="products-container">
                        <div class="text-center py-5">
                            <i class="fas fa-box fa-3x text-muted mb-3"></i>
                            <p class="text-muted">登録された商品がありません。</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 고객 관리 탭 -->
            <div class="tab-pane fade" id="customers-section" role="tabpanel" aria-labelledby="customers-tab">
                <div class="order-management pt-5">
                    <h3 class="japanese-heading">
                        <i class="fas fa-users me-2"></i>顧客管理
                    </h3>
                    
                    <!-- 고객 검색 및 필터 -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="customer-search" placeholder="顧客名・メールアドレスで検索" onkeyup="searchCustomers()">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="customer-filter">
                                <option value="all">すべての顧客</option>
                                <option value="new">新規顧客</option>
                                <option value="vip">VIP顧客</option>
                                <option value="inactive">非アクティブ</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-secondary" onclick="refreshCustomers()">
                                <i class="fas fa-sync-alt me-2"></i>更新
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-secondary" onclick="showEmailCampaignModal()">
                                <i class="fas fa-envelope me-2"></i>メール送信
                            </button>
                </div>
            </div>

                    <!-- 고객 통계 카드 (가로 한 줄, 모노톤) -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-3">
                                            <h4 class="text-dark mb-1" id="total-customers-count">0</h4>
                                            <p class="text-muted japanese-text mb-0">総顧客数</p>
                                        </div>
                                        <div class="col-3">
                                            <h4 class="text-secondary mb-1" id="new-customers-count">0</h4>
                                            <p class="text-muted japanese-text mb-0">新規顧客</p>
                                        </div>
                                        <div class="col-3">
                                            <h4 class="text-dark mb-1" id="vip-customers-count">0</h4>
                                            <p class="text-muted japanese-text mb-0">VIP顧客</p>
                                        </div>
                                        <div class="col-3">
                                            <h4 class="text-secondary mb-1" id="avg-order-value-customers">¥0</h4>
                                            <p class="text-muted japanese-text mb-0">平均購入額</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 고객 목록 -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="japanese-heading mb-0">
                                <i class="fas fa-list me-2"></i>顧客一覧
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th class="japanese-text">顧客情報</th>
                                            <th class="japanese-text">顧客等級</th>
                                            <th class="japanese-text">最終訪問日</th>
                                            <th class="japanese-text">注文数</th>
                                            <th class="japanese-text">総購入額</th>
                                            <th class="japanese-text">ポイント</th>
                                            <th class="japanese-text">ステータス</th>
                                            <th class="japanese-text">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="customers-table-body">
                                        <tr>
                                            <td colspan="8" class="text-center text-muted">
                                                <i class="fas fa-spinner fa-spin me-2"></i>データ読み込み中...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 분석 탭 -->
            <div class="tab-pane fade" id="analytics-section" role="tabpanel" aria-labelledby="analytics-tab">
                <div class="order-management pt-5">
                    <h3 class="japanese-heading">
                        <i class="fas fa-chart-line me-2"></i>分析
                    </h3>
                    
                    <!-- 분석 필터 (제거됨 - 기간 선택 기능으로 대체) -->

                    <!-- 기간 선택 기능 -->
                    <div class="period-selector mb-4">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="btn-group" role="group" aria-label="기간 선택">
                                <button type="button" class="btn btn-outline-secondary active" data-period="day" id="period-day">日</button>
                                <button type="button" class="btn btn-outline-secondary" data-period="week" id="period-week">週</button>
                                <button type="button" class="btn btn-outline-secondary" data-period="month" id="period-month">月</button>
                                <button type="button" class="btn btn-outline-secondary" data-period="year" id="period-year">年</button>
                            </div>
                            <div class="date-navigation d-flex align-items-center">
                                <button class="btn btn-outline-secondary btn-sm" id="prev-period" title="前の期間">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <span class="mx-3 japanese-text fw-bold" id="current-period">2024年1月15日</span>
                                <button class="btn btn-outline-secondary btn-sm" id="next-period" title="次の期間">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 매출 분석 카드 (가로 한 줄) -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-3">
                                            <h4 class="text-dark mb-1" id="total-revenue">¥0</h4>
                                            <p class="text-muted japanese-text mb-0">総売上</p>
                                        </div>
                                        <div class="col-3">
                                            <h4 class="text-secondary mb-1" id="total-orders">0</h4>
                                            <p class="text-muted japanese-text mb-0">総注文数</p>
                                        </div>
                                        <div class="col-3">
                                            <h4 class="text-dark mb-1" id="avg-order-value">¥0</h4>
                                            <p class="text-muted japanese-text mb-0">平均注文金額</p>
                                        </div>
                                        <div class="col-3">
                                            <h4 class="text-secondary mb-1" id="total-customers-analytics">0</h4>
                                            <p class="text-muted japanese-text mb-0">総顧客数</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 매출 추이 차트 -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white">
                                    <h5 class="japanese-heading mb-0">
                                        <i class="fas fa-chart-line me-2"></i>売上推移
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="revenueChart" height="100"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 상품별 매출 순위 -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white">
                                    <h5 class="japanese-heading mb-0">
                                        <i class="fas fa-trophy me-2"></i>人気商品TOP5
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="top-products-list">
                                        <div class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin me-2"></i>データ読み込み中...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white">
                                    <h5 class="japanese-heading mb-0">
                                        <i class="fas fa-users me-2"></i>顧客分析
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <h4 class="text-dark mb-1" id="new-customers">0</h4>
                                            <p class="text-muted japanese-text mb-0">新規顧客</p>
                                        </div>
                                        <div class="col-6">
                                            <h4 class="text-secondary mb-1" id="returning-customers">0</h4>
                                            <p class="text-muted japanese-text mb-0">リピート顧客</p>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="text-center">
                                        <h4 class="text-dark mb-1" id="repeat-rate">0%</h4>
                                        <p class="text-muted japanese-text mb-0">リピート率</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 포인트 분석 -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white">
                                    <h5 class="japanese-heading mb-0">
                                        <i class="fas fa-coins me-2"></i>ポイント分析
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <h4 class="text-dark mb-1" id="points-earned">0</h4>
                                            <p class="text-muted japanese-text mb-0">獲得ポイント</p>
                                        </div>
                                        <div class="col-6">
                                            <h4 class="text-secondary mb-1" id="points-used">0</h4>
                                            <p class="text-muted japanese-text mb-0">使用ポイント</p>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="text-center">
                                        <h4 class="text-dark mb-1" id="points-utilization">0%</h4>
                                        <p class="text-muted japanese-text mb-0">ポイント利用率</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white">
                                    <h5 class="japanese-heading mb-0">
                                        <i class="fas fa-clock me-2"></i>注文ステータス
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="order-status-chart">
                                        <div class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin me-2"></i>データ読み込み中...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ホームページ管理タブ -->
            <div class="tab-pane fade" id="homepage-section" role="tabpanel" aria-labelledby="homepage-tab">
                <div class="order-management pt-5">
                    <h3 class="japanese-heading mb-4">
                        <i class="fas fa-home me-2"></i>ホームページ管理
                    </h3>
                    
                    <!-- スライダー管理 -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="japanese-heading mb-0">
                                <i class="fas fa-images me-2"></i>メインスライダー管理
                            </h5>
                            <button class="btn btn-dark" onclick="openSliderModal()">
                                <i class="fas fa-plus me-2"></i>スライダー追加
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="sliders-container">
                                <!-- スライダーリストがここに動的に読み込まれます -->
                            </div>
                        </div>
                    </div>

                    <!-- BEST ITEM 관리 -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="japanese-heading mb-0">
                                <i class="fas fa-star me-2"></i>BEST ITEM管理
                            </h5>
                            <button class="btn btn-dark" onclick="openBestItemModal()">
                                <i class="fas fa-edit me-2"></i>編集
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="best-items-container">
                                <!-- BEST ITEMリストがここに動的に読み込まれます -->
                            </div>
                        </div>
                    </div>

                    <!-- Featured Product 관리 -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="japanese-heading mb-0">
                                <i class="fas fa-gift me-2"></i>Featured Product管理
                            </h5>
                            <button class="btn btn-dark" onclick="openFeaturedProductModal()">
                                <i class="fas fa-edit me-2"></i>編集
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="featured-products-container">
                                <!-- Featured Productリストがここに動的に読み込まれます -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 푸터 관리 탭 -->
            <div class="tab-pane fade" id="footer-section" role="tabpanel" aria-labelledby="footer-tab">
                <div class="order-management pt-5">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="japanese-heading mb-0">
                        <i class="fas fa-shoe-prints me-2"></i>フッター管理
                    </h3>
                        <button type="button" class="btn btn-outline-secondary" onclick="window.createDefaultFooterData()">
                            <i class="fas fa-plus me-2"></i>기본 데이터 생성
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h5 class="japanese-heading mb-0">
                                <i class="fas fa-edit me-2"></i>フッター情報編集
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="footerForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="japanese-heading">会社情報</h6>
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="row g-3">
                                                    <!-- 주소 -->
                                                    <div class="col-12">
                                                        <label class="form-label">
                                                            <i class="fas fa-map-marker-alt me-2 text-secondary"></i>住所
                                                        </label>
                                                        <input type="text" class="form-control" id="company-address" placeholder="住所を入力してください">
                                                    </div>
                                                    
                                                    <!-- 이메일 -->
                                                    <div class="col-12">
                                                        <label class="form-label">
                                                            <i class="fas fa-envelope me-2 text-secondary"></i>メールアドレス
                                                        </label>
                                                        <input type="email" class="form-control" id="company-email" placeholder="メールアドレスを入力してください">
                                                    </div>
                                                    
                                                    <!-- 전화번호 -->
                                                    <div class="col-12">
                                                        <label class="form-label">
                                                            <i class="fas fa-phone me-2 text-secondary"></i>電話番号
                                                        </label>
                                                        <input type="tel" class="form-control" id="company-phone" placeholder="電話番号を入力してください">
                                                    </div>
                                                    
                                                    <!-- 팩스 -->
                                                    <div class="col-12">
                                                        <label class="form-label">
                                                            <i class="fas fa-fax me-2 text-secondary"></i>ファックス
                                                        </label>
                                                        <input type="tel" class="form-control" id="company-fax" placeholder="ファックス番号を入力してください">
                                                </div>
                                                    
                                                    <!-- 운영시간 -->
                                                    <div class="col-12">
                                                        <label class="form-label">
                                                            <i class="fas fa-clock me-2 text-secondary"></i>営業時間
                                                        </label>
                                                        <input type="text" class="form-control" id="company-hours" placeholder="営業時間を入力してください (例: 平日 9:00-18:00)">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="japanese-heading">Further Info リンク</h6>
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="row mb-3">
                                                    <div class="col-md-4">
                                                        <input type="text" class="form-control" id="new-further-info-name" placeholder="リンク名を入力">
                                                    </div>
                                                    <div class="col-md-4">
                                                        <input type="text" class="form-control" id="new-further-info-link" placeholder="リンク先 (例: about.html)">
                                                    </div>
                                                    <div class="col-md-4">
                                                        <button type="button" class="btn btn-secondary w-100" onclick="window.addFurtherInfoLink()">
                                                            <i class="fas fa-plus me-2"></i>リンク追加
                                                        </button>
                                                    </div>
                                                </div>
                                                <div id="further-info-links-list">
                                                    <!-- Further Info 링크가 여기에 동적으로 생성됩니다 -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 브랜드명 관리 섹션 -->
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <h6 class="japanese-heading">ブランド名管理</h6>
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="row mb-3">
                                                    <div class="col-md-4">
                                                        <input type="text" class="form-control" id="new-brand-name" placeholder="新しいブランド名を入力">
                                                    </div>
                                                    <div class="col-md-4">
                                                        <input type="text" class="form-control" id="new-brand-link" placeholder="ブランドページリンク (例: brands/lalarecipe.html)">
                                                    </div>
                                                    <div class="col-md-4">
                                                        <button type="button" class="btn btn-secondary w-100" onclick="window.addBrandName()">
                                                            <i class="fas fa-plus me-2"></i>ブランド追加
                                                        </button>
                                                    </div>
                                                </div>
                                                <div id="brand-names-list">
                                                    <!-- 브랜드명 리스트가 여기에 동적으로 생성됩니다 -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-center mt-4">
                                    <button type="button" class="btn btn-dark" onclick="window.saveFooterContent()">
                                        <i class="fas fa-save me-2"></i>保存
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <!-- 탭 컨텐츠 끝 -->

    </div>

    <!-- 商品追加/編集モーダル -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel">新しい商品を追加</h5>
                    <button type="button" class="btn-close" onclick="confirmCloseProductModal()" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto; padding: 20px;">
                    <form id="productForm">
                        <input type="hidden" id="product-id" name="id">
                        
                        <div class="row">
                            <!-- 左列: 基本情報 -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="product-code" class="form-label">商品コード</label>
                                    <input type="text" class="form-control" id="product-code" name="code">
                                    <div class="form-text">商品の一意なコード</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="product-name-en" class="form-label">商品名（英語）</label>
                                    <input type="text" class="form-control" id="product-name-en" name="nameEn">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="product-name-jp" class="form-label">商品名(日本語)</label>
                                    <input type="text" class="form-control" id="product-name-jp" name="nameJp">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="product-brand" class="form-label">ブランド</label>
                                    <select class="form-select" id="product-brand" name="brandCode">
                                        <option value="">ブランドを選択</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">商品タイプ</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="productType" id="product-type-simple" value="simple" checked onchange="toggleOptionSection()">
                                        <label class="form-check-label" for="product-type-simple">
                                            単品商品 (オプションなし)
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="productType" id="product-type-option" value="option" onchange="toggleOptionSection()">
                                        <label class="form-check-label" for="product-type-option">
                                            オプション商品 (複数オプション選択可能)
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="product-price" class="form-label">販売価格 (円)</label>
                                    <input type="number" class="form-control" id="product-price" name="price" min="0">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="product-sale-price" class="form-label">セール価格 (円)</label>
                                    <input type="number" class="form-control" id="product-sale-price" name="salePrice" min="0">
                                    <div class="form-text">セール価格を設定すると、販売価格に取り消し線が表示されます</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="product-stock" class="form-label">在庫数</label>
                                    <input type="number" class="form-control" id="product-stock" name="stock" min="0">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="product-status" class="form-label">ステータス</label>
                                    <select class="form-select" id="product-status" name="status">
                                        <option value="active">アクティブ</option>
                                        <option value="inactive">非アクティブ</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="product-priority" class="form-label">表示順序 (優先度)</label>
                                    <input type="number" class="form-control" id="product-priority" name="priority" min="0" max="100" value="50">
                                    <div class="form-text">数値が大きいほど上位に表示されます (0-100)</div>
                                </div>
                                
                                
                                <!-- オプション設定セクション (オプション商品の場合のみ表示) -->
                                <div id="option-settings-section" class="mb-3" style="display: none;">
                                    <label class="form-label">オプション設定</label>
                                    <div class="border rounded p-3">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <span class="text-muted small">オプションを追加して商品のバリエーションを設定できます</span>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addProductOption()">
                                                <i class="fas fa-plus me-1"></i>オプション追加
                                            </button>
                                        </div>
                                        
                                        <div id="product-options-list">
                                            <!-- オプションがここに動的に追加されます -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 右列: 画像アップロード -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="product-image" class="form-label">メイン画像</label>
                                    <div class="image-upload-area" 
                                         id="product-image-drop-zone"
                                         onclick="document.getElementById('product-image').click()"
                                         ondrop="handleProductImageDrop(event)"
                                         ondragover="handleProductImageDragOver(event)"
                                         ondragleave="handleProductImageDragLeave(event)">
                                        <div id="product-image-preview" style="display: none; position: relative;">
                                            <img id="product-preview-img" src="" alt="プレビュー" style="max-width: 100%; max-height: 200px;">
                                            <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1" 
                                                    onclick="deleteProductImage('main')" title="画像を削除">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <div id="product-upload-placeholder">
                                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                            <p class="text-muted">クリックまたはドラッグ&ドロップで画像をアップロード</p>
                                            <p class="small text-muted">JPG, PNG, GIF (最大 5MB)</p>
                                        </div>
                                    </div>
                                    <input type="file" id="product-image" name="image" accept="image/*" style="display: none;" onchange="previewProductImage(this)">
                                    <div class="form-text">推奨サイズ: 400x400px</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="product-image-url" class="form-label">画像URL (オプション)</label>
                                    <input type="url" class="form-control" id="product-image-url" name="imageUrl" placeholder="https://example.com/image.jpg">
                                    <div class="form-text">画像URLを直接入力することもできます</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">追加画像 (3枚)</label>
                                    <div class="row">
                                        <div class="col-md-4 mb-2">
                                            <div class="image-upload-area small" 
                                                 id="product-image-1-drop-zone"
                                                 onclick="document.getElementById('product-image-1').click()"
                                                 ondrop="handleProductImage1Drop(event)"
                                                 ondragover="handleProductImageDragOver(event)"
                                                 ondragleave="handleProductImageDragLeave(event)">
                                                <div id="product-image-1-preview" style="display: none; position: relative;">
                                                    <img id="product-preview-img-1" src="" alt="プレビュー" style="max-width: 100%; max-height: 120px;">
                                                    <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1" 
                                                            onclick="deleteProductImage('additional1')" title="画像を削除">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                                <div id="product-upload-placeholder-1">
                                                    <i class="fas fa-plus fa-2x text-muted mb-2"></i>
                                                    <p class="text-muted small">追加画像 1</p>
                                                </div>
                                            </div>
                                            <input type="file" id="product-image-1" name="image1" accept="image/*" style="display: none;" onchange="previewProductImage1(this)">
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="image-upload-area small" 
                                                 id="product-image-2-drop-zone"
                                                 onclick="document.getElementById('product-image-2').click()"
                                                 ondrop="handleProductImage2Drop(event)"
                                                 ondragover="handleProductImageDragOver(event)"
                                                 ondragleave="handleProductImageDragLeave(event)">
                                                <div id="product-image-2-preview" style="display: none; position: relative;">
                                                    <img id="product-preview-img-2" src="" alt="プレビュー" style="max-width: 100%; max-height: 120px;">
                                                    <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1" 
                                                            onclick="deleteProductImage('additional2')" title="画像を削除">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                                <div id="product-upload-placeholder-2">
                                                    <i class="fas fa-plus fa-2x text-muted mb-2"></i>
                                                    <p class="text-muted small">追加画像 2</p>
                                                </div>
                                            </div>
                                            <input type="file" id="product-image-2" name="image2" accept="image/*" style="display: none;" onchange="previewProductImage2(this)">
                                        </div>
                                        <div class="col-md-4 mb-2">
                                            <div class="image-upload-area small" 
                                                 id="product-image-3-drop-zone"
                                                 onclick="document.getElementById('product-image-3').click()"
                                                 ondrop="handleProductImage3Drop(event)"
                                                 ondragover="handleProductImageDragOver(event)"
                                                 ondragleave="handleProductImageDragLeave(event)">
                                                <div id="product-image-3-preview" style="display: none; position: relative;">
                                                    <img id="product-preview-img-3" src="" alt="プレビュー" style="max-width: 100%; max-height: 120px;">
                                                    <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1" 
                                                            onclick="deleteProductImage('additional3')" title="画像を削除">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                                <div id="product-upload-placeholder-3">
                                                    <i class="fas fa-plus fa-2x text-muted mb-2"></i>
                                                    <p class="text-muted small">追加画像 3</p>
                                                </div>
                                            </div>
                                            <input type="file" id="product-image-3" name="image3" accept="image/*" style="display: none;" onchange="previewProductImage3(this)">
                                        </div>
                                    </div>
                                    <div class="form-text">推奨サイズ: 400x400px</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="product-detail-image" class="form-label">商品詳細画像</label>
                                    <div class="image-upload-area" 
                                         id="product-detail-image-drop-zone"
                                         onclick="document.getElementById('product-detail-image').click()"
                                         ondrop="handleProductDetailImageDrop(event)"
                                         ondragover="handleProductImageDragOver(event)"
                                         ondragleave="handleProductImageDragLeave(event)">
                                        <div id="product-detail-image-preview" style="display: none; position: relative;">
                                            <img id="product-detail-preview-img" src="" alt="プレビュー" style="max-width: 100%; max-height: 200px;">
                                            <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1" 
                                                    onclick="deleteProductImage('detail')" title="画像を削除">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <div id="product-detail-upload-placeholder">
                                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                            <p class="text-muted">クリックまたはドラッグ&ドロップで詳細画像をアップロード</p>
                                            <p class="small text-muted">JPG, PNG, GIF (最大 15MB)</p>
                                        </div>
                                    </div>
                                    <input type="file" id="product-detail-image" name="detailImage" accept="image/*" style="display: none;" onchange="previewProductDetailImage(this)">
                                    <div class="form-text">推奨サイズ: 800x600px</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">現在の画像URL</label>
                                    <input type="text" class="form-control" id="product-current-url" readonly placeholder="アップロード後に表示されます">
                                </div>
                                
                                <!-- 숨겨진 필드들: 기존 이미지 데이터 보존용 -->
                                <input type="hidden" id="product-current-additional-images" name="currentAdditionalImages" value="">
                                <input type="hidden" id="product-current-detail-image-url" name="currentDetailImageUrl" value="">
                                
                                
                                <div class="mb-3">
                                    <label for="product-capacity" class="form-label">容量</label>
                                    <input type="text" class="form-control" id="product-capacity" name="capacity" placeholder="例: 30ml, 50g">
                                </div>
                            </div>
                        </div>
                        
                        <!-- 商品バッジ設定セクション -->
                        <div class="card mt-4" style="display: block !important; visibility: visible !important;">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-tag me-2"></i>商品バッジ設定
                                </h6>
                            </div>
                            <div class="card-body" style="display: block !important; visibility: visible !important;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="product-badge-type" class="form-label">バッジタイプ</label>
                                            <select class="form-select" id="product-badge-type">
                                                <option value="">バッジなし</option>
                                                <option value="NEW">NEW</option>
                                                <option value="SALE">SALE</option>
                                                <option value="HOT">HOT</option>
                                                <option value="LIMITED">LIMITED</option>
                                                <option value="POPULAR">POPULAR</option>
                                                <option value="BEST">BEST</option>
                                                <option value="CUSTOM">カスタム</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="product-badge-color" class="form-label">バッジカラー</label>
                                            <select class="form-select" id="product-badge-color">
                                                <option value="red">赤色</option>
                                                <option value="blue">青色</option>
                                                <option value="green">緑色</option>
                                                <option value="orange">オレンジ色</option>
                                                <option value="purple">紫色</option>
                                                <option value="dark">黒色</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3" id="new-product-custom-badge-text-container" style="display: none;">
                                    <label for="product-badge-text" class="form-label">カスタムバッジテキスト</label>
                                    <input type="text" class="form-control" id="product-badge-text" placeholder="例: 特価、新商品" maxlength="10">
                                    <div class="form-text">最大10文字まで入力可能</div>
                                </div>
                                
                                <!-- 뱃지 날짜 필드는 JavaScript로 동적 생성 -->
                                <div id="badge-date-fields-container">
                                    <!-- JavaScript로 동적 생성될 필드들 -->
                                </div>
                                
                            </div>
                        </div>
                        
                                    
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-dark" onclick="saveProduct()">
                        <i class="fas fa-save me-2"></i>保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ブランド追加/編集モーダル -->
    <div class="modal fade" id="brandModal" tabindex="-1" aria-labelledby="brandModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="brandModalLabel">新しいブランドを追加</h5>
                </div>
                <div class="modal-body">
                    <form id="brandForm">
                        <input type="hidden" id="brand-id" name="brandId">
                        
                        <div class="row">
                            <!-- 左列: 基本情報 -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="brand-code" class="form-label">ブランドコード <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="brand-code" name="code" required placeholder="例: lalarecipe">
                                    <div class="form-text">英数字のみ、小文字推奨</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="brand-name-kr" class="form-label">ブランド名（英語）<span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="brand-name-kr" name="nameKr" required placeholder="例: LALARECIPE">
                                    <div class="form-text">メインのブランド名として表示されます</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="brand-name-jp" class="form-label">ブランド名（日本語）<span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="brand-name-jp" name="nameJp" required placeholder="例: ララレシピ">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="brand-description" class="form-label">説明</label>
                                    <textarea class="form-control" id="brand-description" name="description" rows="3" placeholder="ブランドの簡単な説明を入力してください"></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="brand-priority" class="form-label">表示優先度</label>
                                    <input type="number" class="form-control" id="brand-priority" name="priority" min="1" max="100" value="50" placeholder="1-100 (数字が大きいほど上位に表示)">
                                    <div class="form-text">1-100の範囲で設定。数字が大きいほど上位に表示されます。</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="brand-status" class="form-label">ステータス</label>
                                    <select class="form-select" id="brand-status" name="status">
                                        <option value="active">アクティブ</option>
                                        <option value="inactive">非アクティブ</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- 右列: 画像アップロード -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="brand-logo" class="form-label">ブランドロゴ</label>
                                    <div class="image-upload-area" 
                                         id="brand-logo-drop-zone"
                                         onclick="document.getElementById('brand-logo').click()"
                                         ondrop="handleBrandLogoDrop(event)"
                                         ondragover="handleBrandImageDragOver(event)"
                                         ondragleave="handleBrandImageDragLeave(event)">
                                        <div id="brand-logo-preview" style="display: none; position: relative;">
                                            <img id="brand-logo-preview-img" src="" alt="プレビュー" style="max-width: 100%; max-height: 150px;">
                                            <button type="button" class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-1" onclick="removeBrandLogo()" title="ロゴを削除">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                        <div id="brand-logo-upload-placeholder">
                                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                            <p class="text-muted">クリックまたはドラッグ&ドロップでロゴをアップロード</p>
                                            <p class="small text-muted">JPG, PNG, GIF (最大 5MB)</p>
                                        </div>
                                    </div>
                                    <input type="file" id="brand-logo" name="logo" accept="image/*" style="display: none;" onchange="previewBrandLogo(this)">
                                    <div class="form-text">推奨サイズ: 480x80px (ブランドテンプレートページ上部に表示)<br><small class="text-muted">最大ファイルサイズ: 10MB</small></div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">現在のロゴURL</label>
                                    <input type="text" class="form-control" id="brand-logo-current-url" readonly placeholder="アップロード後に表示されます">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="brand-image" class="form-label">ブランド大代表画像</label>
                                    <div class="image-upload-area" 
                                         id="brand-image-drop-zone"
                                         onclick="document.getElementById('brand-image').click()"
                                         ondrop="handleBrandImageDrop(event)"
                                         ondragover="handleBrandImageDragOver(event)"
                                         ondragleave="handleBrandImageDragLeave(event)">
                                        <div id="brand-image-preview" style="display: none; position: relative;">
                                            <img id="brand-preview-img" src="" alt="プレビュー" style="max-width: 100%; max-height: 200px;">
                                            <button type="button" class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-1" onclick="removeBrandImage()" title="画像を削除">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                        <div id="brand-upload-placeholder">
                                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                            <p class="text-muted">クリックまたはドラッグ&ドロップで画像をアップロード</p>
                                            <p class="small text-muted">JPG, PNG, GIF (最大 5MB)</p>
                                        </div>
                                    </div>
                                    <input type="file" id="brand-image" name="image" accept="image/*" style="display: none;" onchange="previewBrandImage(this)">
                                    <div class="form-text">推奨サイズ: 400x300px (shop.htmlページに表示)<br><small class="text-muted">最大ファイルサイズ: 10MB</small></div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">現在の画像URL</label>
                                    <input type="text" class="form-control" id="brand-current-url" readonly placeholder="アップロード後に表示されます">
                                </div>
                            </div>
                        </div>
                        
                        <!-- 新しいバッジ設定セクション -->
                        <div class="card mt-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-tag me-2"></i>バッジ設定
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- バッジタイプとカラー -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="brand-badge-type" class="form-label">バッジタイプ</label>
                                            <select class="form-select" id="brand-badge-type" onchange="updateBadgeSettings()">
                                                <option value="">バッジなし</option>
                                                <option value="NEW">NEW</option>
                                                <option value="SALE">SALE</option>
                                                <option value="HOT">HOT</option>
                                                <option value="LIMITED">LIMITED</option>
                                                <option value="POPULAR">POPULAR</option>
                                                <option value="CUSTOM">カスタム</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="brand-badge-color" class="form-label">バッジカラー</label>
                                            <select class="form-select" id="brand-badge-color" onchange="updateBadgeSettings()">
                                                <option value="red">赤</option>
                                                <option value="blue">青</option>
                                                <option value="green">緑</option>
                                                <option value="orange">オレンジ</option>
                                                <option value="purple">紫</option>
                                                <option value="dark">黒</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- カスタムバッジテキスト -->
                                <div class="mb-3" id="custom-badge-text-container" style="display: none;">
                                    <label for="brand-badge-text" class="form-label">カスタムバッジテキスト</label>
                                    <input type="text" class="form-control" id="brand-badge-text" placeholder="例: 特価, 新商品" maxlength="10">
                                    <div class="form-text">最大10文字まで入力可能</div>
                                </div>
                                
                                <!-- バッジ表示期間 -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="brand-badge-start" class="form-label">バッジ開始日</label>
                                            <input type="date" class="form-control" id="brand-badge-start" name="badgeStart">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="brand-badge-end" class="form-label">バッジ終了日</label>
                                            <input type="date" class="form-control" id="brand-badge-end" name="badgeEnd">
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" onclick="cancelBrandEdit()">キャンセル</button>
                    <button type="button" class="btn btn-dark" onclick="saveBrand()">
                        <i class="fas fa-save me-2"></i>保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 이메일 캠페인 모달 -->
    <div class="modal fade" id="emailCampaignModal" tabindex="-1" aria-labelledby="emailCampaignModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title japanese-heading" id="emailCampaignModalLabel">
                        <i class="fas fa-envelope me-2"></i>メールキャンペーン
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="email-campaign-form">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="campaign-type" class="form-label japanese-text">キャンペーンタイプ</label>
                                <select class="form-select" id="campaign-type" onchange="updateCampaignTemplate()">
                                    <option value="birthday">誕生日お祝い</option>
                                    <option value="welcome">ウェルカムメール</option>
                                    <option value="promotion">プロモーション</option>
                                    <option value="abandoned-cart">カート放棄リマインド</option>
                                    <option value="order-confirmation">注文確認</option>
                                    <option value="shipping-notification">配送通知</option>
                                    <option value="custom">カスタム</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="target-segment" class="form-label japanese-text">対象セグメント</label>
                                <select class="form-select" id="target-segment">
                                    <option value="all">すべての顧客</option>
                                    <option value="new">新規顧客</option>
                                    <option value="vip">VIP顧客</option>
                                    <option value="inactive">非アクティブ顧客</option>
                                    <option value="high-value">高額購入顧客</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="email-subject" class="form-label japanese-text">件名</label>
                            <input type="text" class="form-control" id="email-subject" placeholder="メールの件名を入力">
                        </div>
                        
                        <div class="mb-3">
                            <label for="email-content" class="form-label japanese-text">内容</label>
                            <textarea class="form-control" id="email-content" rows="8" placeholder="メールの内容を入力"></textarea>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="send-time" class="form-label japanese-text">送信タイミング</label>
                                <select class="form-select" id="send-time">
                                    <option value="immediate">即座に送信</option>
                                    <option value="scheduled">スケジュール送信</option>
                                </select>
                            </div>
                            <div class="col-md-6" id="schedule-time-container" style="display: none;">
                                <label for="schedule-datetime" class="form-label japanese-text">送信日時</label>
                                <input type="datetime-local" class="form-control" id="schedule-datetime">
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>送信対象:</strong> <span id="target-count">0</span>名の顧客
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-secondary" onclick="sendEmailCampaign()">
                        <i class="fas fa-paper-plane me-2"></i>送信
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    
    <script src="assets/js/jquery-1.11.0.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/firebase-config.js?v=3.0"></script>
    <script src="create-initial-brands.js"></script>
    <script src="update-brands-with-badges.js"></script>
    <script src="cleanup-products.js"></script>
    <script src="check-product-ids.js"></script>
    <script src="migrate-to-firebase.js"></script>
    
    <!-- 탭 전환 함수들 -->
    <script>
        // 전역 탭 전환 함수들
        function switchToPoints() {
            console.log('📋 포인트 관리 탭으로 전환');
            hideAllTabs();
            showTab('points-section');
            updateTabButtons('points-tab');
        }
        
        function switchToOrders() {
            console.log('📋 주문 관리 탭으로 전환');
            hideAllTabs();
            showTab('orders-section');
            updateTabButtons('orders-tab');
            
            // Firebase에서 실제 주문 데이터 로드
            console.log('🔥 Firebase에서 주문 데이터 로드 시작...');
            if (typeof loadOrders === 'function') {
                loadOrders().catch(error => {
                    console.error('❌ 주문 로드 실패:', error);
                });
            } else {
                console.warn('loadOrders 함수를 찾을 수 없습니다');
            }
            
            // 기본 테스트 주문 데이터 (백업용)
            const emergencyOrders = [
                {
                    id: 'ORD-001',
                    orderDate: '2025-08-30T07:52:43.658Z',
                    status: 'pending',
                    items: [
                        { name: 'LALARECIPE BAKUCHINOL EYE CREAM', quantity: 1, price: 2980 },
                        { name: 'YUZU VITA C CREAM', quantity: 2, price: 3500 }
                    ],
                    totalAmount: 9980,
                    customer: { name: '田中太郎', email: 'tanaka@example.com' }
                },
                {
                    id: 'ORD-002',
                    orderDate: '2025-08-29T07:52:43.658Z',
                    status: 'completed',
                    items: [
                        { name: 'COSCELL GREEN PAPAYA PDRN PORE AMPOULE', quantity: 1, price: 4200 }
                    ],
                    totalAmount: 4200,
                    customer: { name: '佐藤花子', email: 'sato@example.com' }
                },
                {
                    id: 'ORD-003',
                    orderDate: '2025-08-30T06:52:43.658Z',
                    status: 'processing',
                    items: [
                        { name: 'MAKE HEAL 1.P.L CUSHION', quantity: 1, price: 3800 },
                        { name: 'MONDAY MUSEUM GREEN INSPIRATION GLOW DROP', quantity: 1, price: 2500 }
                    ],
                    totalAmount: 6300,
                    customer: { name: '鈴木次郎', email: 'suzuki@example.com' }
                }
            ];
            
            window.allOrders = emergencyOrders;
            window.filteredOrders = [...emergencyOrders];
            
            // 직접 주문 표시
            const container = document.getElementById('orders-container');
            if (container) {
                let html = '';
                emergencyOrders.forEach((order, index) => {
                    const statusClass = `status-${order.status}`;
                    const statusText = {
                        'pending': '処理待ち',
                        'processing': '処理中',
                        'shipping': '配送中',
                        'completed': '完了',
                        'cancelled': 'キャンセル'
                    }[order.status] || order.status;
                    
                    const orderDate = new Date(order.orderDate).toLocaleString('ja-JP');
                    const earnedPoints = Math.floor((order.totalAmount || 0) * 0.03);
                    
                    html += `
                        <div class="order-card">
                            <div class="order-header">
                                <div>
                                    <div class="order-id">${order.id}</div>
                                    <div class="order-date">${orderDate}</div>
                                </div>
                                <div class="order-status ${statusClass}">${statusText}</div>
                            </div>
                            <div class="order-customer">
                                <div class="customer-name">${order.customer.name}</div>
                                <div class="customer-email">${order.customer.email}</div>
                            </div>
                            <div class="order-items">
                                ${order.items.map(item => `
                                    <div class="item-row">
                                        <span class="item-name">${item.name}</span>
                                        <span class="item-quantity">×${item.quantity}</span>
                                        <span class="item-price">¥${item.price.toLocaleString()}</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="order-total">
                                <div class="japanese-text">
                                    <small>獲得ポイント: ${earnedPoints}P</small>
                                </div>
                                <div class="total-amount">合計: ¥${(order.totalAmount || 0).toLocaleString()}</div>
                            </div>
                            <div class="order-actions">
                                <button class="btn btn-outline-secondary btn-sm" onclick="viewOrderDetail('${order.id}')">
                                    <i class="fas fa-eye me-1"></i>詳細
                                </button>
                                ${order.status === 'pending' ? `
                                    <button class="btn btn-secondary btn-sm" onclick="updateOrderStatus('${order.id}', 'processing')">
                                        <i class="fas fa-play me-1"></i>処理開始
                                    </button>
                                ` : ''}
                                ${order.status === 'processing' ? `
                                    <button class="btn btn-secondary btn-sm" onclick="updateOrderStatus('${order.id}', 'shipping')">
                                        <i class="fas fa-truck me-1"></i>配送開始
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                console.log('✅ 주문 HTML 직접 생성 완료');
            }
            
            // 주문 통계 업데이트
            const todayOrders = document.getElementById('today-orders');
            const todaySales = document.getElementById('today-sales');
            const pendingOrders = document.getElementById('pending-orders');
            const totalCustomers = document.getElementById('total-customers');
            
            if (todayOrders) todayOrders.textContent = emergencyOrders.length;
            if (todaySales) todaySales.textContent = '¥' + emergencyOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0).toLocaleString();
            if (pendingOrders) pendingOrders.textContent = emergencyOrders.filter(o => o.status === 'pending').length;
            if (totalCustomers) totalCustomers.textContent = emergencyOrders.length;
            
            console.log('✅ 주문 데이터 즉시 표시 완료:', emergencyOrders.length, '개');
        }
        
        function switchToBrands() {
            console.log('📋 브랜드 관리 탭으로 전환');
            hideAllTabs();
            showTab('brands-section');
            updateTabButtons('brands-tab');
            
            // Firebase에서 브랜드 데이터 로드
            console.log('🔥 Firebase에서 브랜드 데이터 로드...');
            loadBrands();
        }
        
        
        // 브랜드 편집 모달 닫기
        window.closeBrandEditModal = function() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('brandModal'));
            if (modal) {
                modal.hide();
            }
        }
        
        // 배지 미리보기 업데이트 함수 (편집 모달용)
        window.updateBadgePreview = function() {
            const badgeType = document.getElementById('brand-badge-type').value;
            const badgeColor = document.getElementById('brand-badge-color').value;
            const badgeText = document.getElementById('brand-badge-text').value;
            const customContainer = document.getElementById('new-custom-badge-text-container');
            const previewBadge = document.getElementById('new-preview-badge');
            
            // 사용자 정의 텍스트 컨테이너 표시/숨김
            if (badgeType === 'CUSTOM') {
                customContainer.style.display = 'block';
            } else {
                customContainer.style.display = 'none';
            }
            
            // 배지 표시/숨김
            if (badgeType && badgeType !== '' && badgeType !== 'NONE') {
                previewBadge.style.display = 'block';
                
                // 배지 텍스트 설정
                if (badgeType === 'CUSTOM') {
                    previewBadge.textContent = badgeText || 'CUSTOM';
                } else {
                    previewBadge.textContent = badgeType;
                }
                
                // 배지 색상 설정
                const colorMap = {
                    'red': '#dc3545',
                    'blue': '#0d6efd',
                    'green': '#198754',
                    'orange': '#fd7e14',
                    'purple': '#6f42c1',
                    'dark': '#212529'
                };
                previewBadge.style.backgroundColor = colorMap[badgeColor] || '#dc3545';
            } else {
                previewBadge.style.display = 'none';
            }
        }
        
        // 新しいバッジ設定関数
        window.updateBadgeSettings = function() {
            const badgeTypeField = document.getElementById('brand-badge-type');
            const customContainer = document.getElementById('custom-badge-text-container');
            
            if (!badgeTypeField) {
                return;
            }
            
            const badgeType = badgeTypeField.value;
            
            // カスタムテキストコンテナの表示/非表示
            if (customContainer) {
                if (badgeType === 'CUSTOM') {
                    customContainer.style.display = 'block';
                } else {
                    customContainer.style.display = 'none';
                }
            }
        }
        
        // 상품 배지 미리보기 함수 제거됨 (미리보기 섹션 삭제로 인해 불필요)
        
        // 상품 배지 미리보기 함수 제거됨 (미리보기 섹션 삭제로 인해 불필요)
        
        // 브랜드 편집 저장 (기존 모달용)
        window.saveBrandEdit = function() {
            // 기존 saveBrand 함수 호출
            saveBrand();
        }
        
        // 브랜드 삭제 함수
        window.deleteBrand = function(brandId) {
            if (confirm('このブランドを削除してもよろしいですか？')) {
                console.log('🗑️ 브랜드 삭제:', brandId);
                
                // 배열에서 브랜드 제거
                window.allBrands = window.allBrands.filter(b => b.id !== brandId);
                window.filteredBrands = [...window.allBrands];
                
                // 화면 새로고침
                switchToBrands();
                
                // 성공 메시지
                showAlert('ブランドが削除されました。', 'success');
            }
        }
        
        function switchToProducts() {
            console.log('📋 상품 관리 탭으로 전환');
            hideAllTabs();
            showTab('products-section');
            updateTabButtons('products-tab');
            
            // Firebase에서 상품 데이터 로드
            console.log('🚀 Firebase에서 상품 데이터 로드...');
            loadProducts();
        }
        
        // 상품 편집 함수
        window.editProduct = function(productId) {
            console.log('🔧 상품 편집 시작:', productId);
            console.log('현재 상품 데이터:', window.allProductsList);
            
            // 여러 위치에서 상품 찾기 시도
            let product = null;
            
            // 1. window.allProductsList에서 찾기
            if (window.allProductsList && window.allProductsList.length > 0) {
                product = window.allProductsList.find(p => p.id === productId);
                console.log('allProductsList에서 찾기 시도:', product);
            }
            
            // 2. window.allProducts에서 찾기
            if (!product && window.allProducts && window.allProducts.length > 0) {
                product = window.allProducts.find(p => p.id === productId);
                console.log('allProducts에서 찾기 시도:', product);
            }
            
            // 3. filteredProductsList에서 찾기
            if (!product && window.filteredProductsList && window.filteredProductsList.length > 0) {
                product = window.filteredProductsList.find(p => p.id === productId);
                console.log('filteredProductsList에서 찾기 시도:', product);
            }
            
            if (!product) {
                console.error('❌ 상품을 찾을 수 없습니다:', productId);
                console.error('사용 가능한 상품 ID들:', {
                    allProductsList: window.allProductsList?.map(p => p.id) || [],
                    allProducts: window.allProducts?.map(p => p.id) || [],
                    filteredProductsList: window.filteredProductsList?.map(p => p.id) || []
                });
                showAlert('商品が見つかりません。', 'danger');
                return;
            }
            
            // 상품 편집 모달 열기
            const modalHtml = `
                <div class="modal fade" id="productEditModal" tabindex="-1" aria-labelledby="productEditModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="productEditModalLabel">
                                    <i class="fas fa-edit me-2"></i>상품 편집
                                </h5>
                            </div>
                            <div class="modal-body">
                                <form id="productEditForm">
                                    <input type="hidden" id="edit-product-id" value="${product.id}">
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="edit-product-name-en" class="form-label">商品名（英語） <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="edit-product-name-en" value="${product.nameEn || ''}" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="edit-product-name-kr" class="form-label">商品名（韓国語）</label>
                                                <input type="text" class="form-control" id="edit-product-name-kr" value="${product.nameKr || ''}">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="edit-product-brand" class="form-label">브랜드</label>
                                                <select class="form-select" id="edit-product-brand">
                                                    <option value="LALARECIPE" ${product.brandName === 'LALARECIPE' ? 'selected' : ''}>LALARECIPE</option>
                                                    <option value="LUCINDE" ${product.brandName === 'LUCINDE' ? 'selected' : ''}>LUCINDE</option>
                                                    <option value="COSCELL" ${product.brandName === 'COSCELL' ? 'selected' : ''}>COSCELL</option>
                                                    <option value="Make heal" ${product.brandName === 'Make heal' ? 'selected' : ''}>Make heal</option>
                                                    <option value="Monday Museum" ${product.brandName === 'Monday Museum' ? 'selected' : ''}>Monday Museum</option>
                                                    <option value="Plareceta" ${product.brandName === 'Plareceta' ? 'selected' : ''}>Plareceta</option>
                                                    <option value="Catch By Sonyouna" ${product.brandName === 'Catch By Sonyouna' ? 'selected' : ''}>Catch By Sonyouna</option>
                                                    <option value="Medipeel" ${product.brandName === 'Medipeel' ? 'selected' : ''}>Medipeel</option>
                                                    <option value="Dancing Whale" ${product.brandName === 'Dancing Whale' ? 'selected' : ''}>Dancing Whale</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="edit-product-status" class="form-label">상태</label>
                                                <select class="form-select" id="edit-product-status">
                                                    <option value="active" ${product.status === 'active' ? 'selected' : ''}>アクティブ</option>
                                                    <option value="inactive" ${product.status === 'inactive' ? 'selected' : ''}>非アクティブ</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="edit-product-price" class="form-label">販売価格 (¥)</label>
                                                <input type="number" class="form-control" id="edit-product-price" value="${product.price || 0}" min="0">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="edit-product-sale-price" class="form-label">セール価格 (¥)</label>
                                                <input type="number" class="form-control" id="edit-product-sale-price" value="${product.salePrice || 0}" min="0">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="edit-product-stock" class="form-label">在庫</label>
                                                <input type="number" class="form-control" id="edit-product-stock" value="${product.stock || 0}" min="0">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="edit-product-image-url" class="form-label">이미지 URL</label>
                                                <input type="url" class="form-control" id="edit-product-image-url" value="${product.imageUrl || ''}" placeholder="https://example.com/image.jpg">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">현재 이미지 미리보기</label>
                                        <div class="text-center">
                                            <img src="${product.imageUrl || 'assets/img/placeholder-brand.svg'}" alt="${product.nameEn}" class="img-fluid" style="max-height: 200px;" 
                                                 onerror="this.src='assets/img/placeholder-brand.svg'">
                                        </div>
                                    </div>
                                    
                                    <!-- 商品バッジ設定セクション -->
                                    <div class="card mt-4">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-tag me-2"></i>商品バッジ設定
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="edit-product-badge-type" class="form-label">バッジタイプ</label>
                                                        <select class="form-select" id="edit-product-badge-type" onchange="updateProductBadgePreview()">
                                                            <option value="">バッジなし</option>
                                                            <option value="NEW" ${product.badgeType === 'NEW' ? 'selected' : ''}>NEW</option>
                                                            <option value="SALE" ${product.badgeType === 'SALE' ? 'selected' : ''}>SALE</option>
                                                            <option value="HOT" ${product.badgeType === 'HOT' ? 'selected' : ''}>HOT</option>
                                                            <option value="LIMITED" ${product.badgeType === 'LIMITED' ? 'selected' : ''}>LIMITED</option>
                                                            <option value="POPULAR" ${product.badgeType === 'POPULAR' ? 'selected' : ''}>POPULAR</option>
                                                            <option value="BEST" ${product.badgeType === 'BEST' ? 'selected' : ''}>BEST</option>
                                                            <option value="CUSTOM" ${product.badgeType === 'CUSTOM' ? 'selected' : ''}>カスタム</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="edit-product-badge-color" class="form-label">バッジカラー</label>
                                                        <select class="form-select" id="edit-product-badge-color" onchange="updateProductBadgePreview()">
                                                            <option value="red" ${product.badgeColor === 'red' ? 'selected' : ''}>赤色</option>
                                                            <option value="blue" ${product.badgeColor === 'blue' ? 'selected' : ''}>青色</option>
                                                            <option value="green" ${product.badgeColor === 'green' ? 'selected' : ''}>緑色</option>
                                                            <option value="orange" ${product.badgeColor === 'orange' ? 'selected' : ''}>オレンジ色</option>
                                                            <option value="purple" ${product.badgeColor === 'purple' ? 'selected' : ''}>紫色</option>
                                                            <option value="dark" ${product.badgeColor === 'dark' ? 'selected' : ''}>黒色</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3" id="product-custom-badge-text-container" style="display: ${product.badgeType === 'CUSTOM' ? 'block' : 'none'};">
                                                <label for="edit-product-badge-text" class="form-label">カスタムバッジテキスト</label>
                                                <input type="text" class="form-control" id="edit-product-badge-text" value="${product.badgeText || ''}" placeholder="例: 特価、新商品" maxlength="10">
                                                <div class="form-text">最大10文字まで入力可能</div>
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="edit-product-badge-start" class="form-label">バッジ開始日</label>
                                                        <input type="date" class="form-control" id="edit-product-badge-start" value="${product.badgeStartDate || ''}" lang="ja" locale="ja-JP">
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="edit-product-badge-end" class="form-label">バッジ終了日</label>
                                                        <input type="date" class="form-control" id="edit-product-badge-end" value="${product.badgeEndDate || ''}" lang="ja" locale="ja-JP">
                                                    </div>
                                                </div>
                                            </div>
                                            
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-outline-secondary" onclick="closeProductEditModal()">キャンセル</button>
                                <button type="button" class="btn btn-secondary" onclick="saveProductEdit()">保存</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 기존 모달 제거
            const existingModal = document.getElementById('productEditModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 새 모달 추가
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 모달 표시
            const modal = new bootstrap.Modal(document.getElementById('productEditModal'));
            modal.show();
        }
        
        // 기존 편집 모달 관련 함수들 제거됨 (통합 모달 사용)
        
        
        // 상품 삭제 함수 (Firebase에서 실제 삭제)
        window.deleteProduct = async function(productId) {
            if (!confirm('정말로 이 상품을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                return;
            }
            
            try {
                console.log('🗑️ Firebase에서 상품 삭제:', productId);
                
                // Firebase에서 상품 삭제
                if (typeof firebase !== 'undefined' && firebase && firebase.firestore) {
                    const db = firebase.firestore();
                    await db.collection('products').doc(productId).delete();
                    console.log('✅ Firebase에서 상품 삭제 완료');
                } else {
                    console.warn('⚠️ Firebase를 사용할 수 없습니다. 메모리에서만 삭제합니다.');
                }
                
                // 메모리에서도 상품 제거
                if (window.allProducts) {
                window.allProducts = window.allProducts.filter(p => p.id !== productId);
                }
                if (window.allProductsList) {
                    window.allProductsList = window.allProductsList.filter(p => p.id !== productId);
                }
                if (window.filteredProductsList) {
                    window.filteredProductsList = window.filteredProductsList.filter(p => p.id !== productId);
                }
                if (window.filteredProducts) {
                    window.filteredProducts = window.filteredProducts.filter(p => p.id !== productId);
                }
                
                // 화면 새로고침
                switchToProducts();
                
                // 성공 메시지
                showAlert('상품이 삭제되었습니다.', 'success');
                
            } catch (error) {
                console.error('❌ 상품 삭제 오류:', error);
                showAlert(`상품 삭제에 실패했습니다: ${error.message}`, 'danger');
            }
        }
        
        function switchToCustomers() {
            console.log('📋 고객 관리 탭으로 전환');
            hideAllTabs();
            showTab('customers-section');
            updateTabButtons('customers-tab');
            setTimeout(() => {
                if (typeof loadCustomers === 'function') loadCustomers();
            }, 100);
        }
        
        function switchToAnalytics() {
            console.log('📋 분석 탭으로 전환');
            hideAllTabs();
            showTab('analytics-section');
            updateTabButtons('analytics-tab');
        }
        
        function switchToHomepageTab() {
            console.log('🔄 홈페이지 탭 클릭됨');
            
            // 모든 탭 숨기기
            const allSections = ['points-section', 'orders-section', 'brands-section', 'products-section', 'customers-section', 'analytics-section', 'homepage-section', 'footer-section'];
            allSections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.style.display = 'none';
                    section.classList.remove('show', 'active');
                }
            });
            
            // 홈페이지 섹션만 표시
            const homepageSection = document.getElementById('homepage-section');
            if (homepageSection) {
                homepageSection.style.display = 'block';
                homepageSection.classList.add('show', 'active');
            }
            
            // 탭 버튼 상태 업데이트
            const allTabs = ['points-tab', 'orders-tab', 'brands-tab', 'products-tab', 'customers-tab', 'analytics-tab', 'homepage-tab', 'footer-tab'];
            allTabs.forEach(tabId => {
                const tab = document.getElementById(tabId);
                if (tab) {
                    if (tabId === 'homepage-tab') {
                        tab.classList.add('active');
                        tab.setAttribute('aria-selected', 'true');
                    } else {
                        tab.classList.remove('active');
                        tab.setAttribute('aria-selected', 'false');
                    }
                }
            });
            
            console.log('✅ 홈페이지 관리 탭 전환 완료');
        }
        
        function switchToFooterTab() {
            console.log('🔄 푸터 탭 클릭됨');
            
            // 모든 탭 숨기기
            const allSections = ['points-section', 'orders-section', 'brands-section', 'products-section', 'customers-section', 'analytics-section', 'homepage-section', 'footer-section'];
            allSections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.style.display = 'none';
                    section.classList.remove('show', 'active');
                }
            });
            
            // 푸터 섹션만 표시
            const footerSection = document.getElementById('footer-section');
            if (footerSection) {
                footerSection.style.display = 'block';
                footerSection.classList.add('show', 'active');
            }
            
            // 탭 버튼 상태 업데이트
            const allTabs = ['points-tab', 'orders-tab', 'brands-tab', 'products-tab', 'customers-tab', 'analytics-tab', 'homepage-tab', 'footer-tab'];
            allTabs.forEach(tabId => {
                const tab = document.getElementById(tabId);
                if (tab) {
                    if (tabId === 'footer-tab') {
                        tab.classList.add('active');
                        tab.setAttribute('aria-selected', 'true');
                    } else {
                        tab.classList.remove('active');
                        tab.setAttribute('aria-selected', 'false');
                    }
                }
            });
            
            // 푸터 데이터 로드
            if (typeof window.loadFooterData === 'function') {
                window.loadFooterData();
            }
            
            console.log('✅ 푸터 관리 탭 전환 완료');
        }
        
        // 전역 탭 전환 헬퍼 함수들
        function hideAllTabs() {
            const sections = ['points-section', 'orders-section', 'brands-section', 'products-section', 'customers-section', 'analytics-section', 'homepage-section', 'footer-section'];
            sections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show', 'active');
                    section.style.display = 'none';
                }
            });
        }
        
        function showTab(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.add('show', 'active');
                section.style.display = 'block';
            }
        }
        
        function updateTabButtons(activeTabId) {
            const tabs = ['points-tab', 'orders-tab', 'brands-tab', 'products-tab', 'customers-tab', 'analytics-tab', 'homepage-tab', 'footer-tab'];
            tabs.forEach(tabId => {
                const tab = document.getElementById(tabId);
                if (tab) {
                    if (tabId === activeTabId) {
                        tab.classList.add('active');
                        tab.setAttribute('aria-selected', 'true');
                    } else {
                        tab.classList.remove('active');
                        tab.setAttribute('aria-selected', 'false');
                    }
                }
            });
        }
    </script>

    <script>
        let scanner = null;
        let currentCustomer = null;
        let currentAdmin = null;
        
        // 커스텀 확인 모달 생성
        function createCustomConfirmModal(title, message, confirmText, cancelText, onConfirm, onCancel) {
            const modalId = 'customConfirmModal';
            
            // 기존 모달 제거
            const existingModal = document.getElementById(modalId);
            if (existingModal) {
                existingModal.remove();
            }
            
            const modalHtml = `
                <div class="modal fade" id="${modalId}" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content border-0 shadow-lg" style="border-radius: 12px; background: #ffffff;">
                            <div class="modal-body p-4">
                                <div class="text-center mb-4">
                                    <div class="mb-3">
                                        <i class="fas fa-question-circle" style="font-size: 3rem; color: #6c757d;"></i>
                                    </div>
                                    <h5 class="modal-title mb-3" style="color: #212529; font-weight: 600;">${title}</h5>
                                    <p class="text-muted mb-0" style="line-height: 1.5;">${message}</p>
                                </div>
                                <div class="d-flex gap-3 justify-content-center">
                                    <button type="button" class="btn btn-outline-secondary px-4 py-2" style="border-radius: 8px; font-weight: 500;" onclick="closeCustomConfirmModal(false)">
                                        ${cancelText || 'キャンセル'}
                                    </button>
                                    <button type="button" class="btn btn-dark px-4 py-2" style="border-radius: 8px; font-weight: 500;" onclick="closeCustomConfirmModal(true)">
                                        ${confirmText || '確認'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById(modalId));
            
            // 이벤트 핸들러 저장
            window.currentConfirmModal = {
                modal: modal,
                onConfirm: onConfirm,
                onCancel: onCancel
            };
            
            modal.show();
        }
        
        // 커스텀 확인 모달 닫기
        function closeCustomConfirmModal(confirmed) {
            const modalElement = document.getElementById('customConfirmModal');
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                modal.hide();
                
                if (confirmed && window.currentConfirmModal && window.currentConfirmModal.onConfirm) {
                    window.currentConfirmModal.onConfirm();
                } else if (!confirmed && window.currentConfirmModal && window.currentConfirmModal.onCancel) {
                    window.currentConfirmModal.onCancel();
                }
                
                // 정리
                window.currentConfirmModal = null;
                setTimeout(() => {
                    if (modalElement && modalElement.parentNode) {
                        modalElement.remove();
                    }
                }, 300);
            }
        }
        let todayStats = {
            earnedPoints: 0,
            usedPoints: 0,
            transactions: 0,
            customers: new Set()
        };

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            // Firebase 초기화 완료 후 관리자 대시보드 초기화
            waitForFirebaseAndInitialize();
            initializeTabNavigation();
            
            // 초기 탭 상태 설정
            setTimeout(() => {
                // 모든 탭 컨텐츠 숨기기
                const tabContents = document.querySelectorAll('.tab-pane');
                tabContents.forEach(content => {
                    content.classList.remove('show', 'active');
                    content.style.display = 'none';
                });
                
                // 포인트 관리 탭만 표시
                const pointsSection = document.getElementById('points-section');
                if (pointsSection) {
                    pointsSection.classList.add('show', 'active');
                    pointsSection.style.display = 'block';
                }
            }, 100);
        });

        // Firebase 초기화 완료 후 관리자 대시보드 초기화
        async function waitForFirebaseAndInitialize() {
            try {
                console.log('Firebase 초기화 대기 중...');
                
                // Firebase SDK 로드 확인
                let attempts = 0;
                const maxAttempts = 100; // 20초 대기
                
                while (attempts < maxAttempts) {
                    // Firebase SDK가 로드되었는지 확인
                    if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
                        console.log('✅ Firebase SDK 로드 완료');
                        
                        // Firebase 초기화 시도
                        try {
                            if (!firebase.apps.length) {
                                firebase.initializeApp({
                                    apiKey: "AIzaSyDMXVksXuTT0rY33GHwlnE1a9tAGbviNFc",
                                    authDomain: "aether-fixed.firebaseapp.com",
                                    projectId: "aether-fixed",
                                    storageBucket: "aether-fixed.firebasestorage.app",
                                    messagingSenderId: "229862254275",
                                    appId: "1:229862254275:web:7190d726004e2da72b2476",
                                    measurementId: "G-2P6DLVTECY"
                                });
                            }
                            
                            // Firestore 초기화
                            const db = firebase.firestore();
                            console.log('✅ Firestore 초기화 완료');
                            
                            // Auth 초기화 확인 및 디버깅
                            if (firebase.auth) {
                                console.log('✅ Auth 초기화 완료');
                                console.log('🔍 Auth 상태 즉시 확인:', firebase.auth().currentUser ? firebase.auth().currentUser.email : 'null');
                            }
                            
                            // Auth 초기화
                            const auth = firebase.auth();
                            console.log('✅ Auth 초기화 완료');
                            
                            // Auth 상태 변경 리스너 설정
                            auth.onAuthStateChanged((user) => {
                                console.log('🔍 Auth 상태 변경 감지:', user ? user.email : 'null');
                                if (user) {
                                    console.log('✅ 사용자 로그인 감지:', user.email);
                                } else {
                                    console.log('❌ 사용자 로그아웃 감지');
                                }
                            });
                            
                            // Storage 초기화
                            const storage = firebase.storage();
                            console.log('✅ Storage 초기화 완료');
                            
                            // Auth 상태 즉시 확인
                            const currentUser = auth.currentUser;
                            console.log('🔍 Auth 현재 사용자:', currentUser ? currentUser.email : 'null');
                            
                            // 관리자 대시보드 초기화
                            console.log('🔄 관리자 권한 확인 시작...');
                            
                            // Auth 상태가 확실히 설정된 후 권한 확인
                            setTimeout(async () => {
                                console.log('🔍 지연된 Auth 상태 확인:', auth.currentUser ? auth.currentUser.email : 'null');
                            await checkAdminPermission();
                            }, 500);
                            
                            return;
                            
                        } catch (firebaseError) {
                            console.error('Firebase 초기화 실패:', firebaseError);
                            // Firebase 초기화 실패해도 관리자 대시보드는 초기화
                            setTimeout(async () => {
                        await checkAdminPermission();
                            }, 1000);
                        return;
                        }
                    }
                    
                    attempts++;
                    console.log(`Firebase 대기 시도 ${attempts}/${maxAttempts}:`, {
                        firebase: typeof firebase !== 'undefined',
                        firebaseApps: typeof firebase !== 'undefined' ? firebase.apps?.length || 0 : 0
                    });
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                console.warn('Firebase 초기화 시간 초과, 기본 모드로 진행');
                // Firebase 없이도 관리자 대시보드 초기화
                await checkAdminPermission();
                
            } catch (error) {
                console.error('Firebase 초기화 대기 중 오류:', error);
                // 오류가 발생해도 관리자 대시보드는 초기화
                await checkAdminPermission();
            }
        }

        // 탭 네비게이션 초기화
        function initializeTabNavigation() {
            // Bootstrap 탭 기능 활성화
            const tabElements = document.querySelectorAll('button[data-bs-toggle="pill"]');
            tabElements.forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const targetId = this.getAttribute('data-bs-target');
                    console.log('탭 클릭됨:', targetId);
                    
                    // 모든 탭에서 active 클래스 제거
                    tabElements.forEach(t => {
                        t.classList.remove('active');
                        t.setAttribute('aria-selected', 'false');
                    });
                    
                    // 모든 탭 컨텐츠 숨기기
                    const tabContents = document.querySelectorAll('.tab-pane');
                    tabContents.forEach(content => {
                        content.classList.remove('show', 'active');
                        content.style.display = 'none';
                    });
                    
                    // 클릭된 탭 활성화
                    this.classList.add('active');
                    this.setAttribute('aria-selected', 'true');
                    
                    // 해당 탭 컨텐츠 표시
                    const targetContent = document.querySelector(targetId);
                    if (targetContent) {
                        targetContent.classList.add('show', 'active');
                        targetContent.style.display = 'block';
                        console.log('탭 컨텐츠 표시됨:', targetId);
                    }
                });
            });
        }

        // 관리자 권한 확인
        async function checkAdminPermission() {
            try {
                console.log('🔍 관리자 권한 확인 함수 시작 - v1758519002');
                console.log('🔍 현재 시간:', new Date().toISOString());
                
                // Firebase Auth에서 현재 로그인된 사용자 확인
                console.log('🔍 Firebase Auth 로그인 상태 확인');
                console.log('🔍 Firebase 객체 상태:', {
                    firebase: typeof firebase !== 'undefined',
                    auth: typeof firebase?.auth === 'function',
                    currentUser: firebase?.auth?.()?.currentUser
                });
                
                let currentUser = null;
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    currentUser = firebase.auth().currentUser;
                    console.log('🔍 Firebase Auth currentUser:', currentUser);
                    
                    // 추가 디버깅: Auth 상태 확인
                    if (currentUser) {
                        console.log('✅ 로그인된 사용자 발견:', {
                            email: currentUser.email,
                            uid: currentUser.uid,
                            emailVerified: currentUser.emailVerified,
                            displayName: currentUser.displayName
                        });
                    } else {
                        console.log('❌ 로그인된 사용자 없음');
                        
                        // 디버깅: Auth 상태를 더 자세히 확인
                        console.log('🔍 Auth 상태 상세 확인:');
                        console.log('- firebase.auth():', firebase.auth());
                        console.log('- firebase.auth().currentUser:', firebase.auth().currentUser);
                        console.log('- firebase.auth().onAuthStateChanged 함수:', typeof firebase.auth().onAuthStateChanged);
                        
                        // Auth 상태 변경 리스너로 즉시 확인
                        console.log('🔍 Auth 상태 변경 리스너로 즉시 확인 시도');
                        const immediateCheck = firebase.auth().onAuthStateChanged((user) => {
                            console.log('🔍 Auth 상태 변경 감지:', user ? user.email : 'null');
                            if (user) {
                                console.log('✅ 즉시 사용자 발견, 관리자 권한 확인 시작');
                                immediateCheck(); // 리스너 해제
                                checkAdminPermissionWithUser(user);
                            }
                        });
                    }
                }
                
                // Firebase Auth 상태 변경 리스너를 통해 로그인 상태 확인
                if (!currentUser) {
                    console.log('❌ Firebase Auth에 로그인된 사용자 없음 - Auth 상태 리스너 설정');
                    
                    // Firebase Auth 상태 변경을 기다림
                    return new Promise((resolve) => {
                        let resolved = false; // 중복 실행 방지
                        
                        const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
                            if (resolved) return; // 이미 처리됨
                            resolved = true;
                            unsubscribe(); // 리스너 해제
                            
                            if (user) {
                                console.log('✅ Firebase Auth 상태 변경으로 사용자 발견:', user.email);
                                checkAdminPermissionWithUser(user);
                            } else {
                                console.log('❌ Firebase Auth 상태 변경으로도 사용자 없음');
                                showAccessDenied('ログインが必要です。');
                            }
                            resolve();
                        });
                        
                        // 1초 후 타임아웃 (더 빠른 응답)
                        setTimeout(() => {
                            if (resolved) return; // 이미 처리됨
                            resolved = true;
                            unsubscribe();
                            console.log('⏰ Firebase Auth 상태 확인 타임아웃 (1초)');
                            showAccessDenied('ログインが必要です。');
                            resolve();
                        }, 1000);
                    });
                }

                // currentUser가 존재하는 경우에만 진행
                const userInfo = {
                    email: currentUser.email,
                    name: currentUser.displayName || currentUser.email,
                    uid: currentUser.uid
                };
                console.log('현재 사용자:', userInfo);

                // Firebase 초기화 대기
                let attempts = 0;
                const maxAttempts = 50;
                
                while (attempts < maxAttempts) {
                    console.log(`Firebase 초기화 대기 중... (${attempts + 1}/${maxAttempts})`);
                    console.log('FirebaseService 상태:', {
                        'FirebaseService 정의됨': typeof FirebaseService !== 'undefined',
                        'isFirebaseAvailable 함수': typeof FirebaseService?.isFirebaseAvailable === 'function',
                        'firebase 객체': typeof firebase !== 'undefined',
                        'firebase.auth': typeof firebase?.auth === 'function'
                    });
                    
                    if (typeof FirebaseService !== 'undefined' && 
                        typeof FirebaseService.isFirebaseAvailable === 'function' && 
                        FirebaseService.isFirebaseAvailable()) {
                        console.log('✅ Firebase 사용 가능, 관리자 권한 확인 시작');
                        
                        // Firebase Auth 상태 변경 리스너 설정
                        if (typeof firebase !== 'undefined' && firebase.auth) {
                            firebase.auth().onAuthStateChanged((user) => {
                                if (user) {
                                    console.log('✅ Firebase Auth 상태 변경: 로그인됨', user.email);
                                    // 로그인된 경우 관리자 권한 재확인
                                    if (user.email === userInfo.email) {
                                        console.log('✅ 동일한 사용자, 관리자 권한 유지');
                                    } else {
                                        console.log('🔄 다른 사용자 로그인, 관리자 권한 재확인 필요');
                                        checkAdminPermission();
                                    }
                                } else {
                                    console.log('❌ Firebase Auth 상태 변경: 로그아웃됨');
                                    showAccessDenied('ログインが必要です。');
                                }
                            });
                        }
                        
                        break;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 200));
                    attempts++;
                }
                
                if (attempts >= maxAttempts) {
                    console.error('❌ Firebase 초기화 시간 초과');
                    console.log('FirebaseService 대신 직접 Firebase 사용 시도...');
                    
                    // Firebase Auth 상태 변경 리스너 설정
                    if (typeof firebase !== 'undefined' && firebase.auth) {
                        firebase.auth().onAuthStateChanged((user) => {
                            if (user) {
                                console.log('✅ Firebase Auth 상태 변경: 로그인됨', user.email);
                                // 로그인된 경우 관리자 권한 재확인
                                if (user.email === userInfo.email) {
                                    console.log('✅ 동일한 사용자, 관리자 권한 유지');
                                } else {
                                    console.log('🔄 다른 사용자 로그인, 관리자 권한 재확인 필요');
                                    checkAdminPermission();
                                }
                            } else {
                                console.log('❌ Firebase Auth 상태 변경: 로그아웃됨');
                                showAccessDenied('ログインが必要です。');
                            }
                        });
                    }
                    
                    // FirebaseService가 사용 불가능할 때 직접 Firebase 사용
                    if (typeof firebase !== 'undefined' && firebase.auth && firebase.firestore) {
                        console.log('✅ 직접 Firebase 사용 가능, 관리자 권한 확인 시작');
                    } else {
                        showAccessDenied('Firebase接続に失敗しました。ページを再読み込みしてください。');
                        return;
                    }
                }

                // 관리자 권한 확인
                console.log('🔍 FirebaseService.isAdmin 호출 시작:', userInfo.email);
                let isAdmin = false;
                
                try {
                    if (typeof FirebaseService !== 'undefined' && typeof FirebaseService.isAdmin === 'function') {
                        isAdmin = await FirebaseService.isAdmin(userInfo.email);
                        console.log('🔍 관리자 권한 확인 결과:', isAdmin);
                    } else {
                        console.log('FirebaseService.isAdmin 사용 불가능, 직접 Firebase 사용');
                        // 직접 Firebase를 사용하여 관리자 권한 확인
                        const db = firebase.firestore();
                        const adminDoc = await db.collection('admins').doc('admin-emails').get();
                        
                        if (adminDoc.exists) {
                            const adminData = adminDoc.data();
                            const adminEmails = adminData.emails || [];
                            isAdmin = adminEmails.includes(userInfo.email);
                            console.log('🔍 직접 Firebase 관리자 권한 확인 결과:', isAdmin);
                        } else {
                            console.log('❌ 관리자 문서를 찾을 수 없습니다');
                            isAdmin = false;
                        }
                    }
                } catch (error) {
                    console.error('❌ 관리자 권한 확인 중 오류:', error);
                    isAdmin = false;
                }
                
                if (isAdmin) {
                    console.log('관리자 권한 확인됨:', userInfo.email);
                    initializeAdminDashboard(userInfo);
                } else {
                    console.log('❌ 관리자 권한 없음:', userInfo.email);
                    showAccessDenied('管理者権限がありません。');
                }
            } catch (error) {
                console.error('관리자 권한 확인 실패:', error);
                showAccessDenied('権限確認中にエラーが発生しました。');
            }
        }

        // 사용자 정보로 관리자 권한 확인
        async function checkAdminPermissionWithUser(user) {
            try {
                console.log('🔍 사용자 정보로 관리자 권한 확인 시작:', user.email);
                
                const userInfo = {
                    email: user.email,
                    name: user.displayName || user.email,
                    uid: user.uid
                };
                console.log('현재 사용자:', userInfo);

                // Firebase 초기화 대기
                let attempts = 0;
                const maxAttempts = 50;
                
                while (attempts < maxAttempts) {
                    console.log(`Firebase 초기화 대기 중... (${attempts + 1}/${maxAttempts})`);
                    console.log('FirebaseService 상태:', {
                        'FirebaseService 정의됨': typeof FirebaseService !== 'undefined',
                        'isFirebaseAvailable 함수': typeof FirebaseService?.isFirebaseAvailable === 'function',
                        'firebase 객체': typeof firebase !== 'undefined',
                        'firebase.auth': typeof firebase?.auth === 'function'
                    });
                    
                    if (typeof FirebaseService !== 'undefined' && 
                        typeof FirebaseService.isFirebaseAvailable === 'function' && 
                        FirebaseService.isFirebaseAvailable()) {
                        console.log('✅ Firebase 사용 가능, 관리자 권한 확인 시작');
                        break;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 200));
                    attempts++;
                }
                
                if (attempts >= maxAttempts) {
                    console.error('❌ Firebase 초기화 시간 초과');
                    showAccessDenied('Firebase接続に失敗しました。ページを再読み込みしてください。');
                    return;
                }

                // 관리자 권한 확인
                console.log('🔍 FirebaseService.isAdmin 호출 시작:', userInfo.email);
                let isAdmin = false;
                
                try {
                    if (typeof FirebaseService !== 'undefined' && typeof FirebaseService.isAdmin === 'function') {
                        isAdmin = await FirebaseService.isAdmin(userInfo.email);
                        console.log('🔍 관리자 권한 확인 결과:', isAdmin);
                    } else {
                        console.log('FirebaseService.isAdmin 사용 불가능, 직접 Firebase 사용');
                        // 직접 Firebase를 사용하여 관리자 권한 확인
                        const db = firebase.firestore();
                        const adminDoc = await db.collection('admins').doc('admin-emails').get();
                        
                        if (adminDoc.exists) {
                            const adminData = adminDoc.data();
                            const adminEmails = adminData.emails || [];
                            isAdmin = adminEmails.includes(userInfo.email);
                            console.log('🔍 직접 Firebase 관리자 권한 확인 결과:', isAdmin);
                        } else {
                            console.log('❌ 관리자 문서를 찾을 수 없습니다');
                            isAdmin = false;
                        }
                    }
                } catch (error) {
                    console.error('❌ 관리자 권한 확인 중 오류:', error);
                    isAdmin = false;
                }
                
                if (isAdmin) {
                    console.log('관리자 권한 확인됨:', userInfo.email);
                    initializeAdminDashboard(userInfo);
                } else {
                    console.log('❌ 관리자 권한 없음:', userInfo.email);
                    showAccessDenied('管理者権限がありません。');
                }
            } catch (error) {
                console.error('❌ 관리자 권한 확인 실패:', error);
                showAccessDenied('権限確認中にエラーが発生しました。');
            }
        }

        // 접근 거부 메시지 표시
        function showAccessDenied(message) {
            console.log('🚫 접근 거부 메시지 표시:', message);
            document.body.innerHTML = `
                <div class="container mt-5">
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h2 class="text-danger">🚫 アクセス拒否</h2>
                                    <p class="mt-3">${message}</p>
                                    <a href="index.html" class="btn btn-secondary">ホームに戻る</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 관리자 대시보드 초기화
        async function initializeAdminDashboard(userInfo) {
            try {
                console.log('관리자 대시보드 초기화 시작');
                
                // 로그인된 사용자 정보로 관리자 설정
                currentAdmin = {
                    email: userInfo.email,
                    name: userInfo.name || userInfo.email
                };
                console.log('관리자 설정됨:', currentAdmin.email);
                
                // Firebase 초기화 확인
                if (typeof firebase === 'undefined' || !firebase.apps || firebase.apps.length === 0) {
                    console.warn('Firebase가 초기화되지 않았습니다. 기본 모드로 진행합니다.');
                    // Firebase 없이도 기본 기능은 작동하도록 설정
                    window.firebase = null;
                } else {
                    console.log('✅ Firebase 초기화 확인됨');
                    
                    // Firebase Auth 상태 확인 (로그인 시도하지 않음)
                    try {
                                const authUser = firebase.auth().currentUser;
                                if (authUser) {
                            console.log('✅ 이미 로그인된 사용자:', authUser.email);
                            // 로그인된 사용자 정보로 currentAdmin 업데이트
                            currentAdmin.email = authUser.email;
                            currentAdmin.name = authUser.displayName || authUser.email;
                        } else {
                            console.log('ℹ️ Firebase Auth에 로그인된 사용자가 없습니다. 로컬 로그인 정보 사용');
                        }
                    } catch (authError) {
                        console.warn('Firebase Auth 확인 오류:', authError);
                        console.log('ℹ️ Firebase Auth 오류 무시하고 로컬 정보 사용');
                    }
                }
                
                // Firebase Auth 상태 재확인
                const authUser = firebase.auth().currentUser;
                if (!authUser) {
                    console.log('Firebase Auth 로그인 필요');
                    try {
                        // 현재 로그인된 관리자 계정으로 Firebase Auth 로그인 시도
                        const currentAdminEmail = currentAdmin.email;
                        
                        // 보안상 비밀번호는 하드코딩하지 않고, 이미 인증된 세션 사용
                        console.log('⚠️ 보안상 하드코딩된 비밀번호 사용을 중단합니다.');
                        console.log('현재 로그인된 관리자:', currentAdminEmail);
                                // 로그인된 사용자 정보로 currentAdmin 업데이트
                                const authUser = firebase.auth().currentUser;
                                if (authUser) {
                                    currentAdmin.email = authUser.email;
                                    currentAdmin.name = authUser.email;
                                }
                        // 익명 로그인으로 대체 (이미지 업로드를 위해)
                                try {
                                    await firebase.auth().signInAnonymously();
                            console.log('✅ Firebase Auth 익명 로그인 성공 (이미지 업로드용)');
                                } catch (anonError) {
                                    console.log('익명 로그인도 실패:', anonError.code);
                                    // Firebase Storage 없이 진행
                                    console.log('⚠️ Firebase Storage 기능 비활성화');
                                }
                    } catch (error) {
                        console.log('Firebase Auth 로그인 전체 실패:', error);
                            // Firebase Storage 없이 진행
                            console.log('⚠️ Firebase Storage 기능 비활성화');
                    }
                } else {
                    console.log('✅ Firebase Auth 이미 로그인됨:', authUser.email);
                    // 이미 로그인된 사용자 정보로 currentAdmin 업데이트
                    currentAdmin.email = authUser.email;
                    currentAdmin.name = authUser.email;
                }
                
                // UI 업데이트
                updateAdminUI();
                updateDateTime();
                setInterval(updateDateTime, 1000);
                
                // 일일 통계 로드 (선택적)
                try {
                    await loadTodayStats();
                } catch (statsError) {
                    console.warn('일일 통계 로드 실패 (무시됨):', statsError);
                }
                
                // 구매 금액 계산 리스너 설정 (선택적)
                try {
                    setupPurchaseAmountListener();
                } catch (listenerError) {
                    console.warn('리스너 설정 실패 (무시됨):', listenerError);
                }
                
                console.log('관리자 대시보드 초기화 완료');
                
            } catch (error) {
                console.error('관리자 대시보드 초기화 실패:', error);
                showAdminAlert('ダッシュボードの初期化に失敗しました', 'danger');
            }
        }

        // 관리자 UI 업데이트
        function updateAdminUI() {
            if (currentAdmin) {
                document.getElementById('admin-name').textContent = currentAdmin.name || currentAdmin.email;
            }
        }

        // 날짜/시간 업데이트
        function updateDateTime() {
            const now = new Date();
            const timeOptions = { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            };
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = now.toLocaleTimeString('ja-JP', timeOptions);
            }
        }

        // 일일 통계 로드
        async function loadTodayStats() {
            try {
                // FirebaseService가 로드되지 않은 경우 기본값 설정
                if (!window.FirebaseService || typeof FirebaseService.getAdminDailyStats !== 'function') {
                    console.warn('FirebaseService가 로드되지 않았습니다. 기본 통계값을 설정합니다.');
                    document.getElementById('today-earned').textContent = '0';
                    document.getElementById('today-used').textContent = '0';
                    document.getElementById('today-transactions').textContent = '0';
                    document.getElementById('today-customers').textContent = '0';
                    return;
                }
                
                const result = await FirebaseService.getAdminDailyStats();
                
                if (result.success) {
                    const stats = result.stats;
                    document.getElementById('today-earned').textContent = stats.earnedPoints.toLocaleString();
                    document.getElementById('today-used').textContent = stats.usedPoints.toLocaleString();
                    document.getElementById('today-transactions').textContent = stats.totalTransactions.toLocaleString();
                    
                    // 고유 고객 수 계산
                    const uniqueCustomers = new Set();
                    stats.transactions.forEach(t => {
                        if (t.userId) uniqueCustomers.add(t.userId);
                    });
                    document.getElementById('today-customers').textContent = uniqueCustomers.size.toLocaleString();
                    
                    console.log('일일 통계 로드 완료:', stats);
                } else {
                    console.error('일일 통계 로드 실패:', result.error);
                    // 기본값 설정
                    document.getElementById('today-earned').textContent = '0';
                    document.getElementById('today-used').textContent = '0';
                    document.getElementById('today-transactions').textContent = '0';
                    document.getElementById('today-customers').textContent = '0';
                }
            } catch (error) {
                console.error('일일 통계 로드 중 오류:', error);
                // 기본값 설정
                document.getElementById('today-earned').textContent = '0';
                document.getElementById('today-used').textContent = '0';
                document.getElementById('today-transactions').textContent = '0';
                document.getElementById('today-customers').textContent = '0';
            }
        }

        // QR 스캐너 시작
        async function startScanner() {
            try {
                const video = document.getElementById('scanner-video');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 400 },
                        height: { ideal: 300 }
                    } 
                });
                
                video.srcObject = stream;
                video.play();
                
                // QR 코드 스캔 시작
                scanQRCode();
                
                showAdminAlert('QRスキャンを開始しました', 'success');
                
            } catch (error) {
                console.error('카메라 접근 실패:', error);
                showAdminAlert('カメラにアクセスできません。権限を確認してください。', 'danger');
            }
        }

        // QR 스캐너 중지
        function stopScanner() {
            const video = document.getElementById('scanner-video');
            if (video.srcObject) {
                const tracks = video.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                video.srcObject = null;
            }
            if (scanner) {
                clearInterval(scanner);
                scanner = null;
            }
            showAdminAlert('QRスキャンを停止しました', 'info');
        }

        // QR 코드 스캔
        function scanQRCode() {
            const video = document.getElementById('scanner-video');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            scanner = setInterval(() => {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code) {
                        console.log('QR 코드 감지:', code.data);
                        processQRCode(code.data);
                        stopScanner();
                    }
                }
            }, 100);
        }

        // 수동 QR 입력 처리
        function processManualQR() {
            const qrInput = document.getElementById('manual-qr-input');
            const qrCode = qrInput.value.trim();
            
            if (qrCode) {
                processQRCode(qrCode);
                qrInput.value = '';
            } else {
                showAdminAlert('QRトークンを入力してください', 'warning');
            }
        }

        // QR 코드 처리
        async function processQRCode(qrData) {
            try {
                console.log('=== 관리자: QR코드 처리 시작 ===');
                console.log('QR데이터:', qrData);
                
                showAdminAlert('QRコードを処理中...', 'info');
                
                // QR토큰으로 사용자 조회
                const result = await FirebaseService.getUserByQRToken(qrData.trim());
                console.log('사용자 조회 결과:', result);
                
                if (result.success) {
                    currentCustomer = result.user;
                    console.log('관리자 대시보드에 설정된 고객 정보:', currentCustomer);
                    console.log('고객 포인트:', currentCustomer.points, '타입:', typeof currentCustomer.points);
                    showCustomerInfo();
                    showAdminAlert(`${currentCustomer.name || currentCustomer.email} 様の情報を読み込みました`, 'success');
                } else {
                    console.error('QR코드 처리 실패:', result.error);
                    showAdminAlert('有効なQRコードではありません。', 'danger');
                }
                
            } catch (error) {
                console.error('QR 코드 처리 예외:', error);
                showAdminAlert('QRコードの処理中にエラーが発生しました。', 'danger');
            }
        }

        // 이메일로 고객 검색
        async function searchCustomerByEmail() {
            const email = document.getElementById('customer-email-search').value.trim();
            
            if (!email) {
                showAdminAlert('メールアドレスを入力してください', 'warning');
                return;
            }
            
            try {
                showAdminAlert('お客様を検索中...', 'info');
                
                // Firebase에서 사용자 검색
                console.log('🔥 Firebase에서 사용자 검색:', email);
                
                if (!firebase || !firebase.firestore) {
                    throw new Error('Firebase가 초기화되지 않았습니다');
                }
                
                const db = firebase.firestore();
                
                // 이메일로 사용자 검색 (문서 ID가 이메일인 경우)
                let userDoc = null;
                try {
                    userDoc = await db.collection('users').doc(email).get();
                } catch (error) {
                    console.log('이메일로 문서 검색 실패, 쿼리로 재시도:', error);
                }
                
                // 문서 ID로 찾지 못한 경우 쿼리로 검색
                if (!userDoc || !userDoc.exists) {
                    const querySnapshot = await db.collection('users').where('email', '==', email).limit(1).get();
                    if (!querySnapshot.empty) {
                        userDoc = querySnapshot.docs[0];
                    }
                }
                
                if (userDoc && userDoc.exists) {
                    const userData = userDoc.data();
                    currentCustomer = {
                        uid: userDoc.id,
                        name: userData.name || userData.displayName || 'Unknown',
                        email: userData.email || email,
                        points: userData.points || 0,
                        phone: userData.phone || '',
                        createdAt: userData.createdAt
                    };
                    showCustomerInfo();
                    showAdminAlert(`${currentCustomer.name || currentCustomer.email} 様を見つけました`, 'success');
                } else {
                    showAdminAlert('該当するお客様が見つかりません', 'warning');
                }
                
                document.getElementById('customer-email-search').value = '';
                
            } catch (error) {
                console.error('고객 검색 실패:', error);
                showAdminAlert('お客様の検索中にエラーが発生しました', 'danger');
            }
        }

        // 고객 정보 표시
        function showCustomerInfo() {
            document.getElementById('scanner-section').style.display = 'none';
            document.getElementById('customer-section').style.display = 'block';
            document.getElementById('point-management').style.display = 'none';
            
            console.log('showCustomerInfo 호출됨, currentCustomer:', currentCustomer);
            console.log('포인트 값:', currentCustomer.points, '타입:', typeof currentCustomer.points);
            
            // 고객 정보 업데이트
            document.getElementById('customer-name').textContent = currentCustomer.name || 'お客様';
            document.getElementById('customer-email').textContent = currentCustomer.email || '';
            
            const pointsValue = currentCustomer.points || 0;
            console.log('표시할 포인트 값:', pointsValue);
            document.getElementById('customer-points').textContent = pointsValue.toLocaleString();
            
            // 최종 방문일 (나중에 구현)
            document.getElementById('customer-last-visit').textContent = '最終訪問: 今日';
            
            // 포인트 이력 로드
            loadCustomerPointHistory();
        }

        // 포인트 관리 화면 표시
        function showPointManagement() {
            document.getElementById('customer-section').style.display = 'none';
            document.getElementById('point-management').style.display = 'block';
        }

        // 고객 정보로 돌아가기
        function backToCustomerInfo() {
            document.getElementById('point-management').style.display = 'none';
            document.getElementById('customer-section').style.display = 'block';
        }

        // 스캐너 초기화
        function resetScanner() {
            stopScanner();
            currentCustomer = null;
            
            document.getElementById('scanner-section').style.display = 'block';
            document.getElementById('customer-section').style.display = 'none';
            document.getElementById('point-management').style.display = 'none';
            
            // 폼 초기화
            document.getElementById('purchase-amount').value = '';
            document.getElementById('points-to-add').value = '';
            document.getElementById('manual-points').value = '';
            document.getElementById('manual-qr-input').value = '';
            document.getElementById('customer-email-search').value = '';
            document.querySelectorAll('.quick-amount-btn').forEach(btn => btn.classList.remove('active'));
        }

        // 구매 금액 설정
        function setPurchaseAmount(amount) {
            document.getElementById('purchase-amount').value = amount;
            calculatePoints();
            
            // 활성 버튼 표시
            document.querySelectorAll('.quick-amount-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // 구매 금액 입력 리스너 설정
        function setupPurchaseAmountListener() {
            const purchaseAmountElement = document.getElementById('purchase-amount');
            if (purchaseAmountElement) {
                purchaseAmountElement.addEventListener('input', calculatePoints);
                console.log('구매 금액 리스너 설정 완료');
            } else {
                console.warn('purchase-amount 요소를 찾을 수 없습니다. 리스너 설정을 건너뜁니다.');
            }
        }

        // 포인트 계산 (3%)
        function calculatePoints() {
            const amount = parseInt(document.getElementById('purchase-amount').value) || 0;
            const points = Math.floor(amount * 0.03);
            document.getElementById('points-to-add').value = points;
        }

        // 구매 포인트 적립
        async function addPurchasePoints() {
            const amount = parseInt(document.getElementById('purchase-amount').value);
            const points = parseInt(document.getElementById('points-to-add').value);
            
            if (!amount || points <= 0) {
                showAdminAlert('購入金額を入力してください', 'warning');
                return;
            }
            
            createCustomConfirmModal(
                'ポイント付与確認',
                `${points}ポイントを付与しますか？<br><small class="text-muted">購入金額: ¥${amount.toLocaleString()}</small>`,
                'ポイント付与',
                'キャンセル',
                () => executeAddPurchasePoints(amount, points),
                () => {}
            );
        }
        
        // 포인트 적립 실행 함수
        async function executeAddPurchasePoints(amount, points) {
            try {
                showAdminAlert('ポイントを付与中...', 'info');
                
                const result = await FirebaseService.addPoints(
                    currentCustomer.uid,
                    points,
                    `店舗購入 ¥${amount.toLocaleString()}`
                );
                
                if (result.success) {
                    // 고객 포인트 업데이트
                    currentCustomer.points += points;
                    document.getElementById('customer-points').textContent = currentCustomer.points.toLocaleString();
                    
                    // 통계 업데이트
                    await loadTodayStats();
                    
                    // 성공 메시지
                    showAdminAlert(`${points}ポイントを付与しました！`, 'success');
                    
                    // 폼 초기화
                    document.getElementById('purchase-amount').value = '';
                    document.getElementById('points-to-add').value = '';
                    document.querySelectorAll('.quick-amount-btn').forEach(btn => btn.classList.remove('active'));
                    
                } else {
                    showAdminAlert('ポイント付与に失敗しました。', 'danger');
                }
                
            } catch (error) {
                console.error('포인트 적립 실패:', error);
                showAdminAlert('ポイント付与中にエラーが発生しました。', 'danger');
            }
        }

        // 수동 포인트 추가
        async function addManualPoints() {
            const points = parseInt(document.getElementById('manual-points').value);
            const reason = document.getElementById('point-reason').value;
            
            if (!points || points <= 0) {
                showAdminAlert('ポイント数を入力してください', 'warning');
                return;
            }
            
            createCustomConfirmModal(
                'ポイント追加確認',
                `${points}ポイントを追加しますか？<br><small class="text-muted">理由: ${reason}</small>`,
                'ポイント追加',
                'キャンセル',
                () => executeAddManualPoints(points, reason),
                () => {}
            );
        }
        
        // 수동 포인트 추가 실행 함수
        async function executeAddManualPoints(points, reason) {
            try {
                showAdminAlert('ポイントを追加中...', 'info');
                
                const result = await FirebaseService.addPoints(
                    currentCustomer.uid,
                    points,
                    reason
                );
                
                if (result.success) {
                    currentCustomer.points += points;
                    document.getElementById('customer-points').textContent = currentCustomer.points.toLocaleString();
                    await loadTodayStats();
                    showAdminAlert(`${points}ポイントを追加しました！`, 'success');
                    document.getElementById('manual-points').value = '';
                    
                    // 포인트 이력 새로고침
                    loadCustomerPointHistory();
                } else {
                    showAdminAlert('ポイント追加に失敗しました。', 'danger');
                }
                
            } catch (error) {
                console.error('수동 포인트 추가 실패:', error);
                showAdminAlert('ポイント追加中にエラーが発生しました。', 'danger');
            }
        }

        // 수동 포인트 차감
        async function subtractManualPoints() {
            const points = parseInt(document.getElementById('manual-points').value);
            const reason = document.getElementById('point-reason').value;
            
            if (!points || points <= 0) {
                showAdminAlert('ポイント数を入力してください', 'warning');
                return;
            }
            
            if (currentCustomer.points < points) {
                showAdminAlert('お客様のポイントが不足しています', 'warning');
                return;
            }
            
            createCustomConfirmModal(
                'ポイント差引確認',
                `${points}ポイントを差し引きますか？<br><small class="text-muted">理由: ${reason}</small>`,
                'ポイント差引',
                'キャンセル',
                () => executeSubtractManualPoints(points, reason),
                () => {}
            );
            return;
            
        }
        
        // 수동 포인트 차감 실행 함수
        async function executeSubtractManualPoints(points, reason) {
            try {
                showAdminAlert('ポイントを差し引き中...', 'info');
                
                const result = await FirebaseService.usePoints(
                    currentCustomer.uid,
                    points,
                    reason
                );
                
                if (result.success) {
                    // 서버에서 반환된 정확한 포인트 값 사용
                    currentCustomer.points = result.points;
                    document.getElementById('customer-points').textContent = currentCustomer.points.toLocaleString();
                    await loadTodayStats();
                    showAdminAlert(`${points}ポイントを差し引きました。`, 'success');
                    document.getElementById('manual-points').value = '';
                    
                    // 포인트 이력 새로고침
                    loadCustomerPointHistory();
                } else {
                    showAdminAlert(`ポイント差引に失敗しました: ${result.error || '不明なエラー'}`, 'danger');
                }
                
            } catch (error) {
                console.error('수동 포인트 차감 실패:', error);
                showAdminAlert('ポイント差引中にエラーが発生しました。', 'danger');
            }
        }

        // 관리자 알림 표시 (모노톤 스타일)
        function showAdminAlert(message, type = 'info') {
            console.log('showAdminAlert 호출됨:', message, type);
            
            // 모노톤 색상 매핑
            const colorMap = {
                'success': { bg: '#f8f9fa', border: '#343a40', text: '#343a40' },
                'danger': { bg: '#f8f9fa', border: '#6c757d', text: '#343a40' },
                'warning': { bg: '#f8f9fa', border: '#495057', text: '#343a40' },
                'info': { bg: '#f8f9fa', border: '#6c757d', text: '#343a40' }
            };
            
            const colors = colorMap[type] || colorMap['info'];
            
            // 기존 알림 제거
            const existingAlert = document.querySelector('.admin-custom-alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // 새 알림 생성
            const alertDiv = document.createElement('div');
            alertDiv.className = 'admin-custom-alert';
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                max-width: 400px;
                background: ${colors.bg};
                border: 1px solid ${colors.border};
                border-radius: 8px;
                padding: 12px 16px;
                color: ${colors.text};
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                font-size: 14px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                display: flex;
                align-items: center;
                justify-content: space-between;
                animation: slideInRight 0.3s ease-out;
            `;
            
            // 아이콘 설정
            const iconMap = {
                'success': 'fas fa-check-circle',
                'danger': 'fas fa-exclamation-circle',
                'warning': 'fas fa-exclamation-triangle',
                'info': 'fas fa-info-circle'
            };
            
            const icon = iconMap[type] || iconMap['info'];
            
            alertDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                    <i class="${icon}" style="color: ${colors.border}; font-size: 16px;"></i>
                    <span>${message}</span>
                </div>
                <button type="button" onclick="this.parentElement.remove()" style="
                    background: none;
                    border: none;
                    color: ${colors.border};
                    font-size: 18px;
                    cursor: pointer;
                    padding: 0;
                    margin-left: 12px;
                    width: 20px;
                    height: 20px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">&times;</button>
            `;
            
            document.body.appendChild(alertDiv);
            console.log('관리자 알림 요소가 DOM에 추가됨:', alertDiv);
            
            // 3초 후 자동 제거
            setTimeout(() => {
                if (alertDiv && alertDiv.parentNode) {
                    console.log('관리자 알림 자동 제거 시작');
                    alertDiv.style.animation = 'slideOutRight 0.3s ease-in';
                    setTimeout(() => {
                        if (alertDiv && alertDiv.parentNode) {
                            alertDiv.remove();
                            console.log('관리자 알림 요소 제거됨');
                        }
                    }, 300);
                }
            }, 3000);
        }

        // 로그아웃
        function logout() {
            if (confirm('ログアウトしますか？')) {
                if (firebase.auth()) {
                    firebase.auth().signOut();
                }
                
                window.location.href = 'index.html';
            }
        }

        // 페이지 언로드 시 카메라 정리
        window.addEventListener('beforeunload', function() {
            stopScanner();
        });

        // ========== 주문 관리 시스템 JavaScript ==========
        
        let allOrders = [];
        let filteredOrders = [];

        // 주문 데이터 표준화 함수
        function standardizeOrderData(order, sourceKey) {
            try {
                console.log(`🔄 주문 데이터 표준화: ${order.id || 'unknown'} from ${sourceKey}`);
                
                // 날짜 처리 함수
                function parseOrderDate(dateValue) {
                    if (!dateValue) return new Date().toISOString();
                    
                    // Firebase Timestamp 객체인 경우
                    if (dateValue.seconds && typeof dateValue.seconds === 'number') {
                        console.log('🕐 Firebase Timestamp 변환:', dateValue);
                        return new Date(dateValue.seconds * 1000).toISOString();
                    }
                    
                    // 이미 ISO 문자열인 경우
                    if (typeof dateValue === 'string') {
                        return dateValue;
                    }
                    
                    // Date 객체인 경우
                    if (dateValue instanceof Date) {
                        return dateValue.toISOString();
                    }
                    
                    // 그 외의 경우 현재 시간
                    return new Date().toISOString();
                }
                
                // 기본 구조 생성
                const standardized = {
                    id: order.id || order.orderId || 'UNKNOWN-' + Date.now(),
                    orderDate: parseOrderDate(order.orderDate || order.createdAt || order.timestamp),
                    status: order.status || 'pending',
                    items: order.items || [],
                    totalAmount: 0,
                    earnedPoints: 0,
                    customer: {
                        name: '',
                        email: '',
                        phone: ''
                    }
                };
                
                // 총액 계산
                if (order.totalAmount) {
                    standardized.totalAmount = order.totalAmount;
                } else if (order.total) {
                    standardized.totalAmount = order.total;
                } else if (order.items && Array.isArray(order.items)) {
                    standardized.totalAmount = order.items.reduce((sum, item) => {
                        return sum + ((item.price || 0) * (item.quantity || 1));
                    }, 0);
                }
                
                // 적립 포인트
                if (order.earnedPoints || order.pointsEarned) {
                    standardized.earnedPoints = order.earnedPoints || order.pointsEarned;
                } else {
                    standardized.earnedPoints = Math.floor(standardized.totalAmount * 0.03);
                }
                
                // 고객 정보 추출
                if (order.customer) {
                    standardized.customer = {
                        name: order.customer.name || order.customer.displayName || '',
                        email: order.customer.email || '',
                        phone: order.customer.phone || ''
                    };
                } else if (order.userEmail || order.shipping) {
                    standardized.customer = {
                        name: order.userName || order.shipping?.name || '게스트',
                        email: order.userEmail || order.email || '',
                        phone: order.shipping?.phone || ''
                    };
                }
                
                // 배송 정보
                if (order.shipping) {
                    standardized.shippingAddress = `${order.shipping.prefecture || ''} ${order.shipping.city || ''} ${order.shipping.address1 || ''}`.trim();
                } else if (order.shippingAddress) {
                    standardized.shippingAddress = order.shippingAddress;
                }
                
                console.log(`✅ 표준화 완료:`, {
                    id: standardized.id,
                    total: standardized.totalAmount,
                    customer: standardized.customer.name || standardized.customer.email,
                    items: standardized.items.length
                });
                
                return standardized;
                
            } catch (error) {
                console.error(`❌ 주문 데이터 표준화 실패:`, error, order);
                return {
                    id: 'ERROR-' + Date.now(),
                    orderDate: new Date().toISOString(),
                    status: 'error',
                    items: [],
                    totalAmount: 0,
                    earnedPoints: 0,
                    customer: { name: 'Error', email: '', phone: '' }
                };
            }
        }

        // 주문 관리 초기화
        function initializeOrderManagement() {
            console.log('🔄 주문 관리 시스템 초기화 시작');
            
            try {
                // 탭 상태 확인 (참고용)
                const ordersSection = document.getElementById('orders-section');
                console.log('📋 주문 관리 탭 상태:', {
                    exists: !!ordersSection,
                    isActive: ordersSection?.classList.contains('active'),
                    isVisible: ordersSection?.classList.contains('show')
                });
                
                // 주문 컨테이너 확인
                const ordersContainer = document.getElementById('orders-container');
                if (!ordersContainer) {
                    console.error('❌ orders-container를 찾을 수 없습니다');
                    const container = document.querySelector('.order-management');
                    if (container) {
                        container.innerHTML = '<div class="alert alert-danger">주문 컨테이너를 찾을 수 없습니다.</div>';
                    }
                    return;
                }
                console.log('✅ orders-container 발견');
                
                // Firebase 전용 시스템 - localStorage 사용 안함
                console.log('🔥 Firebase 전용 주문 관리 시스템');
                
                // Firebase에서 주문 데이터 로드
                console.log('📊 Firebase에서 주문 데이터 로드 시작');
                
                console.log('📊 주문 목록 로드 시작');
                loadOrders();
                
                console.log('📈 주문 통계 로드 시작');
                loadOrderStatistics();
                
                console.log('✅ 주문 관리 시스템 초기화 완료');
                
            } catch (error) {
                console.error('❌ 주문 관리 시스템 초기화 오류:', error);
                const container = document.querySelector('.order-management');
                if (container) {
                    container.innerHTML = `<div class="alert alert-danger">시스템 초기화 중 오류가 발생했습니다: ${error.message}</div>`;
                }
            }
        }

        // 테스트용 주문 데이터 생성 함수 제거됨 - Firebase에서 실제 데이터만 사용

        // 주문 데이터 로드 (Firebase 전용)
        async function loadOrders() {
            try {
                console.log('📥 Firebase 전용 주문 데이터 로드 시작...');
                
                let allOrders = [];
                
                // Firebase 전용 시스템 - localStorage 사용 안함
                console.log('🔥 Firebase 전용 주문 관리 시스템');
                
                // Firebase에서 주문 데이터 로드
                if (typeof firebase !== 'undefined' && firebase.firestore && firebase.apps && firebase.apps.length > 0) {
                    try {
                        console.log('🔥 Firebase에서 주문 데이터 로드 시도...');
                        const db = firebase.firestore();
                        
                        // 먼저 전체 주문 수 확인
                        const ordersSnapshot = await db.collection('orders').get();
                        console.log('📊 Firebase orders 컬렉션 전체 문서 수:', ordersSnapshot.size);
                        
                        if (!ordersSnapshot.empty) {
                            const firebaseOrders = ordersSnapshot.docs.map(doc => {
                                const data = doc.data();
                                console.log('📄 주문 문서:', doc.id, data);
                                
                                // 날짜 처리 개선
                                let orderDate = new Date();
                                if (data.createdAt) {
                                    if (data.createdAt.toDate) {
                                        orderDate = data.createdAt.toDate();
                                    } else if (data.createdAt.seconds) {
                                        orderDate = new Date(data.createdAt.seconds * 1000);
                                    } else {
                                        orderDate = new Date(data.createdAt);
                                    }
                                } else if (data.orderDate) {
                                    orderDate = new Date(data.orderDate);
                                }
                                
                                return {
                                    ...data,
                                    id: doc.id,
                                    orderDate: orderDate.toISOString(),
                                    createdAt: orderDate.toISOString(),
                                    status: data.status || 'pending',
                                    totalAmount: data.totalAmount || data.total || 0
                                };
                            });
                            
                            console.log('📋 Firebase에서 로드한 주문:', firebaseOrders.length, '개');
                            firebaseOrders.forEach((order, i) => {
                                console.log(`주문 ${i + 1}:`, {
                                    id: order.id,
                                    date: order.orderDate,
                                    total: order.totalAmount,
                                    status: order.status
                                });
                            });
                            
                            allOrders = firebaseOrders;
                        } else {
                            console.log('📭 Firebase orders 컬렉션이 비어있습니다');
                        }
                    } catch (firebaseError) {
                        console.error('❌ Firebase 주문 로드 실패:', firebaseError);
                        console.error('에러 상세:', firebaseError.message);
                    }
                } else {
                    console.warn('⚠️ Firebase가 초기화되지 않았습니다');
                }
                
                if (allOrders.length === 0) {
                    console.log('📭 주문 데이터가 없습니다.');
                    console.log('💡 테스트 주문을 생성하거나 실제 주문을 해보세요.');
                    window.allOrders = [];
                    window.filteredOrders = [];
                displayOrders();
                    return;
                }
                
                console.log('📋 전체 주문 개수:', allOrders.length);
                console.log('📋 주문 데이터 상세:', allOrders);
                
                // window.allOrders 설정
                window.allOrders = allOrders;
                console.log('✅ window.allOrders 설정 완료:', window.allOrders.length, '개');
                
                // 주문 데이터 정규화
                const normalizedOrders = allOrders.map((order, index) => {
                    console.log(`🔧 주문 ${index + 1} 정규화:`, order);
                    return {
                        ...order,
                        orderDate: order.orderDate || order.createdAt || order.timestamp || new Date().toISOString(),
                        status: order.status || 'pending',
                        id: order.id || order.orderId || 'ORDER-' + Date.now(),
                        // 사용자 정보 정규화
                        userId: order.userId || order.userEmail || order.customerEmail,
                        userEmail: order.userEmail || order.customerEmail || order.userId,
                        userName: order.userName || order.customer?.name || order.customerName,
                        customerEmail: order.customerEmail || order.userEmail || order.userId,
                        customer: order.customer || {
                            name: order.userName || order.customerName || '게스트',
                            email: order.userEmail || order.customerEmail || order.userId,
                            phone: order.customer?.phone || ''
                        }
                    };
                });
                
                window.allOrders = normalizedOrders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));
                window.filteredOrders = [...window.allOrders];
                
                console.log('📊 정렬된 주문:', window.allOrders.length + '건');
                if (window.allOrders.length > 0) {
                    console.log('🔍 첫 번째 주문:', window.allOrders[0]);
                    console.log('🔍 마지막 주문:', window.allOrders[window.allOrders.length - 1]);
                }
                
                displayOrders();
                console.log('✅ 주문 데이터 로드 완료:', window.allOrders.length + '건');
                
                // 주문 통계 업데이트 (데이터 로드 완료 후)
                console.log('📊 주문 통계 업데이트 시작...');
                if (typeof loadOrderStatistics === 'function') {
                    loadOrderStatistics();
                }
                
            } catch (error) {
                console.error('❌ 주문 로드 실패:', error);
                showOrderError('注文データの読み込みに失敗しました: ' + error.message);
            }
        }

        // 주문 표시
        function displayOrders() {
            console.log('🖼️ 주문 표시 시작...');
            const container = document.getElementById('orders-container');
            
            if (!container) {
                console.error('❌ orders-container를 찾을 수 없습니다!');
                return;
            }
            
            console.log('📊 표시할 주문 수:', window.filteredOrders.length);
            
            if (window.filteredOrders.length === 0) {
                console.log('📭 주문이 없어서 빈 상태 표시');
                container.innerHTML = `
                    <div class="empty-orders text-center p-4">
                        <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                        <h4 class="japanese-heading">注文がありません</h4>
                        <p class="japanese-text text-muted">現在の条件に一致する注文がありません。</p>
                            <div class="d-flex gap-2 justify-content-center mt-3">
                                <button class="btn btn-dark" onclick="generateTestOrders(); loadOrders(); loadOrderStatistics();">
                                    <i class="fas fa-plus me-2"></i>テストデータ生成
                        </button>
                            </div>
                    </div>
                `;
                return;
            }

            console.log('🏗️ 주문 카드 생성 중...');
            let html = '';
            window.filteredOrders.forEach((order, index) => {
                console.log(`📄 ${index + 1}번째 주문 카드 생성:`, order.id);
                html += generateOrderCard(order);
            });

            console.log('✅ HTML 설정 완료, 길이:', html.length);
            console.log('📄 생성된 HTML:', html.substring(0, 200) + '...');
            
            container.innerHTML = html;
            
            // DOM에 실제로 추가되었는지 확인
            setTimeout(() => {
                const orderCards = container.querySelectorAll('.order-card');
                console.log('🎨 주문 표시 완료 - DOM에 추가된 카드 수:', orderCards.length);
                
                if (orderCards.length === 0 && html.length > 0) {
                    console.error('❌ HTML은 생성되었지만 DOM에 카드가 없습니다!');
                    console.log('🔍 컨테이너 상태:', {
                        innerHTML: container.innerHTML.substring(0, 200),
                        children: container.children.length,
                        display: getComputedStyle(container).display,
                        visibility: getComputedStyle(container).visibility
                    });
                }
            }, 100);
        }

        // 주문 카드 HTML 생성
        function generateOrderCard(order) {
            try {
                console.log('🔍 주문 카드 생성 중:', order);
                
                const statusClass = 'status-' + (order.status || 'pending');
                const statusText = getStatusText(order.status || 'pending');
                
                // 날짜 처리 개선
                let orderDate;
                if (order.orderDate && order.orderDate.seconds) {
                    // Firebase Timestamp 객체
                    orderDate = new Date(order.orderDate.seconds * 1000).toLocaleString('ja-JP');
                } else {
                    // ISO 문자열 또는 일반 날짜
                    orderDate = new Date(order.orderDate || order.timestamp || Date.now()).toLocaleString('ja-JP');
                }
                
                // 고객 정보 처리 - 다양한 구조 대응
                let customerName = '게스트';
                let customerEmail = '';
                
                // 우선순위: customer 객체 > 개별 필드들
                if (order.customer && order.customer.name) {
                    customerName = order.customer.name;
                    customerEmail = order.customer.email || '';
                } else if (order.userName) {
                    customerName = order.userName;
                    customerEmail = order.userEmail || order.customerEmail || '';
                } else if (order.customerName) {
                    customerName = order.customerName;
                    customerEmail = order.customerEmail || '';
                } else if (order.userEmail) {
                    customerEmail = order.userEmail;
                    customerName = order.userEmail.split('@')[0]; // 이메일에서 이름 추출
                } else if (order.customerEmail) {
                    customerEmail = order.customerEmail;
                    customerName = order.customerEmail.split('@')[0]; // 이메일에서 이름 추출
                }
                
                // 관리자 계정인지 확인 (동적으로 관리자 이메일 목록 확인)
                // Firebase에서 관리자 이메일 목록을 가져와서 확인하는 것이 더 좋지만, 
                // 현재는 단순히 이메일 도메인으로 관리자 여부를 판단
                if (customerEmail && customerEmail.includes('@') && 
                    (customerEmail.includes('admin') || customerEmail.includes('aether'))) {
                    customerName = '관리자';
                }
                
                return `
                    <div class="order-card">
                        <div class="order-header">
                            <div>
                                <div class="order-id">${order.id}</div>
                                <div class="order-date">${orderDate}</div>
                            </div>
                            <div class="order-status ${statusClass}">${statusText}</div>
                        </div>
                        
                        <div class="order-customer">
                            <div class="customer-name">${customerName}</div>
                            <div class="customer-email">${customerEmail}</div>
                        </div>
                        
                        <div class="order-items">
                            ${(order.items || []).map(item => {
                                const itemName = item.name || item.title || item.productName || 'Unknown Product';
                                const itemQuantity = item.quantity || 1;
                                const itemPrice = item.price || 0;
                                return `
                                    <div class="item-row">
                                        <span class="item-name">${itemName}</span>
                                        <span class="item-quantity">×${itemQuantity}</span>
                                        <span class="item-price">¥${itemPrice.toLocaleString()}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    
                        <div class="order-total">
                            <div class="japanese-text">
                                <small>獲得ポイント: ${(order.earnedPoints || Math.floor((order.originalAmount || order.totalAmount || 0) * 0.03))}P</small>
                                ${(order.usedPoints || order.pointDiscount || 0) > 0 ? `<br><small class="text-dark fw-bold">使用ポイント: ${(order.usedPoints || order.pointDiscount || 0).toLocaleString()}P</small>` : ''}
                            </div>
                            <div class="total-amount">
                                ${(order.usedPoints || order.pointDiscount || 0) > 0 ? 
                                    `<div class="text-muted"><small>定価: ¥${(order.originalAmount || order.totalAmount || 0).toLocaleString()}</small></div>` : ''}
                                合計: ¥${(order.totalAmount || 0).toLocaleString()}
                            </div>
                        </div>
                        
                        <div class="order-actions">
                            ${generateStatusButtons(order)}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('❌ 주문 카드 생성 오류:', error, order);
                return `
                    <div class="order-card border-danger">
                        <div class="alert alert-danger">
                            주문 카드 생성 오류: ${error.message}<br>
                            주문 ID: ${order.id || 'Unknown'}
                        </div>
                    </div>
                `;
            }
        }

        // 상태별 버튼 생성
        function generateStatusButtons(order) {
            let buttons = `
                <button class="btn btn-outline-secondary btn-sm" onclick="viewOrderDetail('${order.id}')">
                    <i class="fas fa-eye me-1"></i>詳細
                </button>
            `;
            
            switch(order.status) {
                case 'pending':
                    buttons += `
                        <button class="btn btn-secondary btn-sm" onclick="updateOrderStatus('${order.id}', 'processing')">
                            <i class="fas fa-play me-1"></i>処理開始
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="updateOrderStatus('${order.id}', 'cancelled')">
                            <i class="fas fa-times me-1"></i>キャンセル
                        </button>
                    `;
                    break;
                case 'processing':
                    buttons += `
                        <button class="btn btn-secondary btn-sm" onclick="updateOrderStatus('${order.id}', 'shipping')">
                            <i class="fas fa-truck me-1"></i>配送開始
                        </button>
                    `;
                    break;
                case 'shipping':
                    buttons += `
                        <button class="btn btn-secondary btn-sm" onclick="updateOrderStatus('${order.id}', 'completed')">
                            <i class="fas fa-check me-1"></i>完了
                        </button>
                    `;
                    break;
            }
            
            return buttons;
        }

        // 상태 텍스트 변환
        function getStatusText(status) {
            const statusMap = {
                'pending': '処理待ち',
                'processing': '処理中',
                'shipping': '配送中',
                'completed': '完了',
                'cancelled': 'キャンセル'
            };
            return statusMap[status] || status;
        }

        // 주문 상태 업데이트
        function updateOrderStatus(orderId, newStatus) {
            const statusText = getStatusText(newStatus);
            
            if (!confirm(`注文 ${orderId} の状態を「${statusText}」に変更しますか？`)) {
                return;
            }
            
            try {
                // Firebase에서 주문 상태 업데이트
                console.log('🔥 Firebase에서 주문 상태 업데이트:', orderId, '->', newStatus);
                    
                    loadOrders();
                    loadOrderStatistics();
                    showAdminAlert(`注文状態を「${statusText}」に変更しました`, 'success');
                
            } catch (error) {
                console.error('주문 상태 업데이트 실패:', error);
                showAdminAlert('注文状態の更新に失敗しました', 'danger');
            }
        }

        // 주문 상세 보기 - 모달로 개선
        function viewOrderDetail(orderId) {
            const order = window.allOrders.find(o => o.id === orderId);
            if (!order) {
                console.warn('주문을 찾을 수 없습니다:', orderId);
                return;
            }
            
            showOrderDetailModal(order);
        }
        
        // スライダー管理モーダル
        function openSliderModal() {
            
            const modalHtml = `
                <div class="slider-custom-modal" id="sliderModal" tabindex="-1" aria-labelledby="sliderModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="sliderModalLabel">
                                    <i class="fas fa-images me-2"></i>メインスライダー管理
                                </h5>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="mb-3">
                                            <button class="btn btn-dark" onclick="addNewSlider()">
                                                <i class="fas fa-plus me-2"></i>新規スライダー追加
                                            </button>
                                        </div>
                                        <div id="sliders-list">
                                            <!-- スライダーリストがここに動的に読み込まれます -->
                                        </div>
                                    </div>

                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeSliderModal()">
                                    <i class="fas fa-times me-2"></i>キャンセル
                                </button>
                                <button type="button" class="btn btn-dark" onclick="saveSliders()">
                                    <i class="fas fa-save me-2"></i>保存
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 기존 모달 제거
            const existingModal = document.getElementById('sliderModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 새 모달 추가
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 모달 표시 (커스텀 방식)
            const modalElement = document.getElementById('sliderModal');
            if (modalElement) {
                modalElement.classList.add('show');
                
                // 모달 외부 클릭 시 닫기
                modalElement.addEventListener('click', function(e) {
                    if (e.target === modalElement) {
                        closeSliderModal();
                    }
                });
                
                // ESC 키로 모달 닫기
                const handleEscape = function(e) {
                    if (e.key === 'Escape') {
                        closeSliderModal();
                        document.removeEventListener('keydown', handleEscape);
                    }
                };
                document.addEventListener('keydown', handleEscape);
            }
            
            // スライダーデータロード
            loadSlidersData();
        }
        
        // スライダーモーダル閉じる
        function closeSliderModal() {
            const modalElement = document.getElementById('sliderModal');
            if (modalElement) {
                // 모달 숨기기
                modalElement.classList.remove('show');
                
                // 모달 요소 제거
                setTimeout(() => {
                    if (modalElement && modalElement.parentNode) {
                        modalElement.parentNode.removeChild(modalElement);
                    }
                }, 300);
            }
        }
        
        // BEST ITEM管理モーダル
        function openBestItemModal() {
            const modalHtml = `
                <div class="modal fade" id="bestItemModal" tabindex="-1" aria-labelledby="bestItemModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="bestItemModalLabel">
                                    <i class="fas fa-star me-2"></i>BEST ITEM管理
                                </h5>
                            </div>
                            <div class="modal-body">
                                <div id="best-items-list">
                                    <!-- BEST ITEMリストがここに動的に読み込まれます -->
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            `;
            
            // 기존 모달 제거
            const existingModal = document.getElementById('bestItemModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 새 모달 추가
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 모달 표시
            const modal = new bootstrap.Modal(document.getElementById('bestItemModal'));
            modal.show();
            
            // BEST ITEM 데이터 로드
            loadBestItemsData();
            
            // 스크롤 문제 해결을 위한 특별 처리
            setTimeout(() => {
                const modalElement = document.getElementById('bestItemModal');
                if (modalElement) {
                    // 모달 바디에 스크롤 이벤트 리스너 추가
                    const modalBody = modalElement.querySelector('.modal-body');
                    if (modalBody) {
                        modalBody.addEventListener('wheel', function(e) {
                            e.stopPropagation();
                        }, { passive: true });
                        
                        // 모달 전체에 스크롤 이벤트 리스너 추가
                        modalElement.addEventListener('wheel', function(e) {
                            e.stopPropagation();
                        }, { passive: true });
                    }
                }
            }, 100);
        }
        
        // BEST ITEM 모달 닫기
        function closeBestItemModal() {
            // 스크롤 이벤트 리스너 정리
            const modalElement = document.getElementById('bestItemModal');
            if (modalElement) {
                const modalBody = modalElement.querySelector('.modal-body');
                if (modalBody) {
                    // 기존 이벤트 리스너 제거 (새로운 이벤트 리스너로 교체)
                    const newModalBody = modalBody.cloneNode(true);
                    modalBody.parentNode.replaceChild(newModalBody, modalBody);
                }
            }
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('bestItemModal'));
            if (modal) {
                modal.hide();
            }
        }
        
        // Featured Product 관리 모달
        function openFeaturedProductModal() {
            // Featured Product 모달 스타일 추가
            if (!document.getElementById('featured-product-modal-styles')) {
                const style = document.createElement('style');
                style.id = 'featured-product-modal-styles';
                style.textContent = `
                    #featuredProductModal .modal-body {
                        overflow-y: auto;
                        max-height: 70vh;
                    }
                    #featuredProductModal .modal-content {
                        overflow: hidden;
                    }
                    #featuredProductModal {
                        overflow: hidden !important;
                    }
                `;
                document.head.appendChild(style);
            }
            const modalHtml = `
                <div class="modal fade" id="featuredProductModal" tabindex="-1" aria-labelledby="featuredProductModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="featuredProductModalLabel">
                                    <i class="fas fa-gift me-2"></i>Featured Product管理
                                </h5>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div id="featured-products-list">
                                            <!-- Featured Productリストがここに動的に読み込まれます -->
                                        </div>
                                    </div>

                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            `;
            
            // 기존 모달 제거
            const existingModal = document.getElementById('featuredProductModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 새 모달 추가
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 모달 표시
            const modal = new bootstrap.Modal(document.getElementById('featuredProductModal'));
            modal.show();
            
            // Featured Product 데이터 로드
            loadFeaturedProductsData();
            
            // 마우스 스크롤 이벤트 리스너 추가
            const modalElement = document.getElementById('featuredProductModal');
            const modalBody = modalElement.querySelector('.modal-body');
            
            if (modalElement) {
                modalElement.addEventListener('wheel', function(e) {
                    e.stopPropagation();
                });
            }
            
            if (modalBody) {
                modalBody.addEventListener('wheel', function(e) {
                    e.stopPropagation();
                });
            }
        }
        
        // Featured Product 모달 닫기
        function closeFeaturedProductModal() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('featuredProductModal'));
            if (modal) {
                modal.hide();
            }
            
            // 모달 바디 이벤트 리스너 정리
            const modalElement = document.getElementById('featuredProductModal');
            if (modalElement) {
                const modalBody = modalElement.querySelector('.modal-body');
                if (modalBody) {
                    const newModalBody = modalBody.cloneNode(true);
                    modalBody.parentNode.replaceChild(newModalBody, modalBody);
                }
            }
        }
        
        // 주문 상세 모달 표시
        function showOrderDetailModal(order) {
            const modalHtml = `
                <div class="modal fade" id="orderDetailModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title japanese-heading">
                                    <i class="fas fa-receipt me-2"></i>注文詳細 - ${order.id}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${generateOrderDetailContent(order)}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i>閉じる
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="printShippingLabel('${order.id}')">
                                    <i class="fas fa-print me-1"></i>配送ラベル印刷
                                </button>
                                <button type="button" class="btn btn-dark" onclick="generateShippingInfo('${order.id}')">
                                    <i class="fas fa-shipping-fast me-1"></i>配送処理
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 기존 모달 제거
            const existingModal = document.getElementById('orderDetailModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 새 모달 추가
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 모달 표시
            const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
            modal.show();
        }
        
        // 주문 상세 내용 생성
        function generateOrderDetailContent(order) {
            // 날짜 처리
            let orderDate;
            if (order.orderDate && order.orderDate.seconds) {
                orderDate = new Date(order.orderDate.seconds * 1000);
            } else {
                orderDate = new Date(order.orderDate || Date.now());
            }
            
            const formattedDate = orderDate.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            
            const formattedTime = orderDate.toLocaleTimeString('ja-JP');
            
            // 배송 정보
            const shipping = order.shipping || {};
            const shippingAddress = order.shippingAddress || 
                `${shipping.prefecture || ''} ${shipping.city || ''} ${shipping.address1 || ''} ${shipping.address2 || ''}`.trim();
            
            return `
                <!-- 주문 기본 정보 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="japanese-heading mb-0">
                                    <i class="fas fa-info-circle me-1"></i>注文情報
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-sm-4"><strong>注文番号:</strong></div>
                                    <div class="col-sm-8">${order.id}</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-sm-4"><strong>注文日時:</strong></div>
                                    <div class="col-sm-8">${formattedDate}<br><small class="text-muted">${formattedTime}</small></div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-sm-4"><strong>状態:</strong></div>
                                    <div class="col-sm-8">
                                        <span class="order-status status-${order.status}">${getStatusText(order.status)}</span>
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-sm-4"><strong>合計金額:</strong></div>
                                    <div class="col-sm-8">
                                        ${(order.usedPoints || order.pointDiscount || 0) > 0 ? 
                                            `<div class="text-muted"><small>定価: ¥${(order.originalAmount || order.totalAmount || 0).toLocaleString()}</small></div>` : ''}
                                        <strong class="text-success">¥${(order.totalAmount || 0).toLocaleString()}</strong>
                                </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-sm-4"><strong>獲得ポイント:</strong></div>
                                    <div class="col-sm-8">${order.earnedPoints || Math.floor((order.originalAmount || order.totalAmount || 0) * 0.03)}P</div>
                                </div>
                                ${(order.usedPoints || order.pointDiscount || 0) > 0 ? `
                                <div class="row">
                                    <div class="col-sm-4"><strong>使用ポイント:</strong></div>
                                    <div class="col-sm-8"><span class="text-dark fw-bold">${(order.usedPoints || order.pointDiscount || 0).toLocaleString()}P</span></div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="japanese-heading mb-0">
                                    <i class="fas fa-user me-1"></i>顧客情報
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-sm-4"><strong>お名前:</strong></div>
                                    <div class="col-sm-8">${order.customer.name || '게스트'}</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-sm-4"><strong>メール:</strong></div>
                                    <div class="col-sm-8">${order.customer.email || 'N/A'}</div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-4"><strong>電話番号:</strong></div>
                                    <div class="col-sm-8">${order.customer.phone || shipping.phone || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 주문 상품 목록 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="japanese-heading mb-0">
                            <i class="fas fa-shopping-bag me-1"></i>注文商品 (${order.items.length}点)
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>商品名</th>
                                        <th>ブランド</th>
                                        <th class="text-center">数量</th>
                                        <th class="text-end">単価</th>
                                        <th class="text-end">小計</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${order.items.map(item => `
                                        <tr>
                                            <td>${item.name || item.title || item.productName || 'Unknown Product'}</td>
                                            <td><small class="text-muted">${item.brand || 'N/A'}</small></td>
                                            <td class="text-center">${item.quantity || 1}</td>
                                            <td class="text-end">¥${(item.price || 0).toLocaleString()}</td>
                                            <td class="text-end"><strong>¥${((item.price || 0) * (item.quantity || 1)).toLocaleString()}</strong></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                <tfoot>
                                    ${(order.usedPoints || order.pointDiscount || 0) > 0 ? `
                                    <tr class="table-light">
                                        <td colspan="4" class="text-end"><small class="text-muted">定価:</small></td>
                                        <td class="text-end"><small class="text-muted">¥${(order.originalAmount || order.totalAmount || 0).toLocaleString()}</small></td>
                                    </tr>
                                    <tr class="table-secondary">
                                        <td colspan="4" class="text-end fw-bold">ポイント割引:</td>
                                        <td class="text-end fw-bold">-¥${(order.usedPoints || order.pointDiscount || 0).toLocaleString()}</td>
                                    </tr>
                                    ` : ''}
                                    <tr class="table-secondary">
                                        <th colspan="4" class="text-end">最終合計:</th>
                                        <th class="text-end">¥${(order.totalAmount || 0).toLocaleString()}</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- 포인트 이력 섹션 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="japanese-heading mb-0">
                            <i class="fas fa-coins me-1"></i>ポイント履歴
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-success"><i class="fas fa-plus-circle me-1"></i>獲得ポイント:</span>
                                    <strong class="text-success">+${order.earnedPoints || Math.floor((order.originalAmount || order.totalAmount || 0) * 0.03)}P</strong>
                                </div>
                                <small class="text-muted">商品購入によるポイント獲得 (3%)</small>
                            </div>
                            ${(order.usedPoints || order.pointDiscount || 0) > 0 ? `
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-dark"><i class="fas fa-minus-circle me-1"></i>使用ポイント:</span>
                                    <strong class="text-dark fw-bold">-${(order.usedPoints || order.pointDiscount || 0).toLocaleString()}P</strong>
                                </div>
                                <small class="text-muted">商品購入時のポイント使用</small>
                            </div>
                            ` : `
                            <div class="col-md-6">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-muted"><i class="fas fa-minus-circle me-1"></i>使用ポイント:</span>
                                    <span class="text-muted">0P</span>
                                </div>
                                <small class="text-muted">ポイント未使用</small>
                            </div>
                            `}
                        </div>
                    </div>
                </div>
                
                <!-- 배송 정보 -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="japanese-heading mb-0">
                            <i class="fas fa-truck me-1"></i>配送情報
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><strong>配送先お名前:</strong></label>
                                    <div>${shipping.name || order.customer.name || 'N/A'}</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label"><strong>電話番号:</strong></label>
                                    <div>${shipping.phone || 'N/A'}</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label"><strong>郵便番号:</strong></label>
                                    <div>${shipping.postal || 'N/A'}</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><strong>配送先住所:</strong></label>
                                    <div class="border p-2 bg-light">
                                        ${shippingAddress || 'N/A'}
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label"><strong>配送状態:</strong></label>
                                    <div>
                                        <span class="order-status status-${order.status}">${getStatusText(order.status)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 배송 처리 옵션 -->
                        <div class="mt-3 pt-3 border-top">
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label"><strong>配送業者:</strong></label>
                                    <select class="form-select form-select-sm" id="shippingCompany-${order.id}">
                                        <option value="yamato">ヤマト運輸</option>
                                        <option value="sagawa">佐川急便</option>
                                        <option value="post">日本郵便</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label"><strong>配送方法:</strong></label>
                                    <select class="form-select form-select-sm" id="shippingMethod-${order.id}">
                                        <option value="standard">通常配送</option>
                                        <option value="express">速達</option>
                                        <option value="cool">クール便</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label"><strong>追跡番号:</strong></label>
                                    <input type="text" class="form-control form-control-sm" id="trackingNumber-${order.id}" 
                                           placeholder="配送開始時に入力">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 배송 라벨 인쇄
        function printShippingLabel(orderId) {
            const order = window.allOrders.find(o => o.id === orderId);
            if (!order) {
                console.warn('주문을 찾을 수 없습니다:', orderId);
                return;
            }
            
            // 배송 라벨 HTML 생성
            const shippingLabelHtml = generateShippingLabelHTML(order);
            
            // 새 창에서 인쇄
            const printWindow = window.open('', '_blank');
            printWindow.document.write(shippingLabelHtml);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            
            showAdminAlert('配送ラベルを印刷しました', 'success');
        }
        
        // 배송 라벨 HTML 생성
        function generateShippingLabelHTML(order) {
            const shipping = order.shipping || {};
            const shippingAddress = order.shippingAddress || 
                `${shipping.prefecture || ''} ${shipping.city || ''} ${shipping.address1 || ''} ${shipping.address2 || ''}`.trim();
            
            // 날짜 처리
            let orderDate;
            if (order.orderDate && order.orderDate.seconds) {
                orderDate = new Date(order.orderDate.seconds * 1000);
            } else {
                orderDate = new Date(order.orderDate || Date.now());
            }
            
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="utf-8">
                    <title>配送ラベル - ${order.id}</title>
                    <style>
                        body { font-family: "Noto Sans JP", Arial, sans-serif; margin: 20px; }
                        .shipping-label { border: 2px solid #000; padding: 20px; max-width: 600px; }
                        .header { text-align: center; border-bottom: 1px solid #000; padding-bottom: 10px; margin-bottom: 15px; }
                        .section { margin-bottom: 15px; }
                        .section-title { font-weight: bold; font-size: 14px; margin-bottom: 5px; }
                        .address-box { border: 1px solid #000; padding: 10px; min-height: 80px; }
                        .order-info { display: flex; justify-content: space-between; }
                        .barcode { text-align: center; font-family: monospace; letter-spacing: 2px; font-size: 18px; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="shipping-label">
                        <div class="header">
                            <h2>Aether 配送ラベル</h2>
                            <div class="barcode">||||| ${order.id} |||||</div>
                        </div>
                        
                        <div class="order-info">
                            <div><strong>注文番号:</strong> ${order.id}</div>
                            <div><strong>注文日:</strong> ${orderDate.toLocaleDateString('ja-JP')}</div>
                            <div><strong>商品点数:</strong> ${order.items.length}点</div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">【配送先】</div>
                            <div class="address-box">
                                <div><strong>〒${shipping.postal || ''}</strong></div>
                                <div>${shippingAddress}</div>
                                <div style="margin-top: 10px;"><strong>${shipping.name || order.customer.name} 様</strong></div>
                                <div>TEL: ${shipping.phone || 'N/A'}</div>
                            </div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">【配送元】</div>
                            <div class="address-box">
                                <div><strong>〒100-0001</strong></div>
                                <div>東京都千代田区千代田1-1</div>
                                <div style="margin-top: 10px;"><strong>Aether株式会社</strong></div>
                                <div>TEL: 03-1234-5678</div>
                            </div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">【商品一覧】</div>
                            ${order.items.map(item => `
                                <div>• ${item.name || item.title} × ${item.quantity || 1}</div>
                            `).join('')}
                        </div>
                        
                        <div class="section">
                            <div style="display: flex; justify-content: space-between;">
                                <div><strong>合計金額: ¥${(order.totalAmount || 0).toLocaleString()}</strong></div>
                                <div><strong>配送方法: 通常配送</strong></div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px; font-size: 12px; color: #666;">
                            このラベルは自動生成されました - ${new Date().toLocaleString('ja-JP')}
                        </div>
                    </div>
                </body>
                </html>
            `;
        }
        
        // 배송 처리
        function generateShippingInfo(orderId) {
            const order = window.allOrders.find(o => o.id === orderId);
            if (!order) {
                console.warn('주문을 찾을 수 없습니다:', orderId);
                return;
            }
            
            // 모달에서 선택된 값들 가져오기
            const shippingCompany = document.getElementById(`shippingCompany-${orderId}`)?.value || 'yamato';
            const shippingMethod = document.getElementById(`shippingMethod-${orderId}`)?.value || 'standard';
            const trackingNumber = document.getElementById(`trackingNumber-${orderId}`)?.value;
            
            if (!trackingNumber) {
                showAdminAlert('追跡番号を入力してください', 'warning');
                return;
            }
            
            // 주문 상태 업데이트
            updateOrderStatus(orderId, 'shipping');
            
            // Firebase에서 배송 정보 저장
            console.log('🔥 Firebase에서 배송 정보 저장:', orderId);
                
                // 배송 정보 알림
                const companyNames = {
                    yamato: 'ヤマト運輸',
                    sagawa: '佐川急便', 
                    post: '日本郵便'
                };
                
                const methodNames = {
                    standard: '通常配送',
                    express: '速達',
                    cool: 'クール便'
                };
                
                showAdminAlert(
                    `配送処理完了<br>` +
                    `業者: ${companyNames[shippingCompany]}<br>` +
                    `方法: ${methodNames[shippingMethod]}<br>` +
                    `追跡番号: ${trackingNumber}`,
                    'success'
                );
                
                // 모달 닫기
                const modal = bootstrap.Modal.getInstance(document.getElementById('orderDetailModal'));
                if (modal) modal.hide();
                
                // 주문 목록 새로고침
                loadOrders();
        }

        // 기간 선택 기능 변수
        let currentPeriod = 'day';
        let currentDate = new Date();
        let currentYear = currentDate.getFullYear();
        let currentMonth = currentDate.getMonth();
        let currentDay = currentDate.getDate();

        // 기간 선택 기능 초기화
        function initializePeriodSelector() {
            console.log('📅 기간 선택 기능 초기화 시작');
            
            // 기간 버튼 이벤트 리스너
            document.querySelectorAll('[data-period]').forEach(button => {
                button.addEventListener('click', function() {
                    const period = this.getAttribute('data-period');
                    selectPeriod(period);
                });
            });
            
            // 날짜 네비게이션 버튼 이벤트 리스너
            document.getElementById('prev-period').addEventListener('click', function() {
                navigatePeriod(-1);
            });
            
            document.getElementById('next-period').addEventListener('click', function() {
                navigatePeriod(1);
            });
            
            // 초기 날짜 표시
            updatePeriodDisplay();
            console.log('✅ 기간 선택 기능 초기화 완료');
        }

        // 기간 선택
        function selectPeriod(period) {
            console.log('📅 기간 선택:', period);
            currentPeriod = period;
            
            // 활성 버튼 변경
            document.querySelectorAll('[data-period]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-period="${period}"]`).classList.add('active');
            
            // 날짜 표시 업데이트
            updatePeriodDisplay();
            
            // 분석 섹션의 모든 지표 업데이트
            if (analyticsData && analyticsData.orders) {
                updateSalesMetrics();
                updateCustomerMetrics();
                updatePointMetrics();
                updateBottomAnalytics();
            }
            
            // 주문 관리 탭의 통계도 업데이트
            loadOrderStatistics();
        }

        // 날짜 네비게이션
        function navigatePeriod(direction) {
            console.log('📅 날짜 네비게이션:', direction);
            
            if (currentPeriod === 'day') {
                currentDate.setDate(currentDate.getDate() + direction);
            } else if (currentPeriod === 'week') {
                currentDate.setDate(currentDate.getDate() + (direction * 7));
            } else if (currentPeriod === 'month') {
                currentDate.setMonth(currentDate.getMonth() + direction);
            } else if (currentPeriod === 'year') {
                currentDate.setFullYear(currentDate.getFullYear() + direction);
            }
            
            currentYear = currentDate.getFullYear();
            currentMonth = currentDate.getMonth();
            currentDay = currentDate.getDate();
            
            updatePeriodDisplay();
            
            // 분석 섹션의 모든 지표 업데이트
            if (analyticsData && analyticsData.orders) {
                updateSalesMetrics();
                updateCustomerMetrics();
                updatePointMetrics();
                updateBottomAnalytics();
            }
            
            // 주문 관리 탭의 통계도 업데이트
            loadOrderStatistics();
        }

        // 기간 표시 업데이트
        function updatePeriodDisplay() {
            const periodElement = document.getElementById('current-period');
            if (!periodElement) return;
            
            let displayText = '';
            
            if (currentPeriod === 'day') {
                displayText = `${currentYear}年${currentMonth + 1}月${currentDay}日`;
            } else if (currentPeriod === 'week') {
                const startOfWeek = new Date(currentDate);
                startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                
                displayText = `${startOfWeek.getFullYear()}年${startOfWeek.getMonth() + 1}月${startOfWeek.getDate()}日 - ${endOfWeek.getFullYear()}年${endOfWeek.getMonth() + 1}月${endOfWeek.getDate()}日`;
            } else if (currentPeriod === 'month') {
                displayText = `${currentYear}年${currentMonth + 1}月`;
            } else if (currentPeriod === 'year') {
                displayText = `${currentYear}年`;
            }
            
            periodElement.textContent = displayText;
        }

        // 선택된 기간의 주문 필터링
        function filterOrdersByPeriod(orders) {
            if (!orders || !Array.isArray(orders)) {
                return [];
            }
            
            const filteredOrders = orders.filter(order => {
                let orderDate;
                
                // Firebase Timestamp 객체 처리 (createdAt 우선 사용)
                if (order.createdAt && order.createdAt.seconds) {
                    orderDate = new Date(order.createdAt.seconds * 1000);
                } else if (order.orderDate && order.orderDate.seconds) {
                    orderDate = new Date(order.orderDate.seconds * 1000);
                } else if (order.timestamp && order.timestamp.seconds) {
                    orderDate = new Date(order.timestamp.seconds * 1000);
                } else if (order.createdAt && typeof order.createdAt === 'string') {
                    orderDate = new Date(order.createdAt);
                } else if (order.orderDate && typeof order.orderDate === 'string') {
                    orderDate = new Date(order.orderDate);
                } else if (order.timestamp && typeof order.timestamp === 'string') {
                    orderDate = new Date(order.timestamp);
                } else {
                    orderDate = new Date(order.createdAt || order.orderDate || order.timestamp || Date.now());
                }
                
                const orderYear = orderDate.getFullYear();
                const orderMonth = orderDate.getMonth();
                const orderDay = orderDate.getDate();
                
                if (currentPeriod === 'day') {
                    return orderYear === currentYear && 
                           orderMonth === currentMonth && 
                           orderDay === currentDay;
                } else if (currentPeriod === 'week') {
                    const startOfWeek = new Date(currentDate);
                    startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
                    startOfWeek.setHours(0, 0, 0, 0);
                    
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    endOfWeek.setHours(23, 59, 59, 999);
                    
                    return orderDate >= startOfWeek && orderDate <= endOfWeek;
                } else if (currentPeriod === 'month') {
                    return orderYear === currentYear && orderMonth === currentMonth;
                } else if (currentPeriod === 'year') {
                    return orderYear === currentYear;
                }
                
                return false;
            });
            
            console.log(`📊 ${currentPeriod} 기간 필터링 결과:`, filteredOrders.length, '개 주문');
            return filteredOrders;
        }

        // 분석 카드 라벨 업데이트
        function updateAnalyticsLabels() {
            const revenueLabel = document.querySelector('#total-revenue').parentElement.querySelector('p');
            const ordersLabel = document.querySelector('#total-orders').parentElement.querySelector('p');
            const avgOrderLabel = document.querySelector('#avg-order-value').parentElement.querySelector('p');
            
            let periodText = '';
            if (currentPeriod === 'day') {
                periodText = '本日の';
            } else if (currentPeriod === 'week') {
                periodText = '今週の';
            } else if (currentPeriod === 'month') {
                periodText = '今月の';
            } else if (currentPeriod === 'year') {
                periodText = '今年の';
            }
            
            if (revenueLabel) revenueLabel.textContent = periodText + '売上';
            if (ordersLabel) ordersLabel.textContent = periodText + '注文数';
            if (avgOrderLabel) avgOrderLabel.textContent = periodText + '平均注文金額';
        }

        // 하단 분석 데이터 업데이트
        function updateBottomAnalytics() {
            if (!analyticsData || !analyticsData.orders) {
                console.warn('⚠️ analyticsData가 없습니다');
                return;
            }
            
            // 기간별 필터링된 주문
            const filteredOrders = filterOrdersByPeriod(analyticsData.orders);
            
            // 고객 분석 업데이트
            const customerEmails = new Set();
            const newCustomerEmails = new Set();
            
            filteredOrders.forEach(order => {
                const email = order.customerEmail || order.email || '';
                if (email) {
                    customerEmails.add(email);
                    
                    // 신규 고객 판단 (첫 주문인지 확인)
                    const previousOrders = analyticsData.orders.filter(o => {
                        const orderDate = o.orderDate && o.orderDate.seconds ? 
                            new Date(o.orderDate.seconds * 1000) : new Date(o.orderDate || 0);
                        const currentOrderDate = order.orderDate && order.orderDate.seconds ? 
                            new Date(order.orderDate.seconds * 1000) : new Date(order.orderDate || 0);
                        return o.customerEmail === email && orderDate < currentOrderDate;
                    });
                    
                    if (previousOrders.length === 0) {
                        newCustomerEmails.add(email);
                    }
                }
            });
            
            const totalCustomers = customerEmails.size;
            const newCustomers = newCustomerEmails.size;
            const returningCustomers = totalCustomers - newCustomers;
            const repeatRate = totalCustomers > 0 ? Math.round((returningCustomers / totalCustomers) * 100) : 0;
            
            // 포인트 분석 업데이트
            let pointsEarned = 0;
            let pointsUsed = 0;
            
            filteredOrders.forEach(order => {
                pointsEarned += order.earnedPoints || 0;
                pointsUsed += order.usedPoints || 0;
            });
            
            const pointsUtilization = pointsEarned > 0 ? Math.round((pointsUsed / pointsEarned) * 100) : 0;
            
            // DOM 업데이트
            const newCustomersEl = document.getElementById('new-customers');
            const returningCustomersEl = document.getElementById('returning-customers');
            const repeatRateEl = document.getElementById('repeat-rate');
            const pointsEarnedEl = document.getElementById('points-earned');
            const pointsUsedEl = document.getElementById('points-used');
            const pointsUtilizationEl = document.getElementById('points-utilization');
            
            if (newCustomersEl) newCustomersEl.textContent = newCustomers.toLocaleString();
            if (returningCustomersEl) returningCustomersEl.textContent = returningCustomers.toLocaleString();
            if (repeatRateEl) repeatRateEl.textContent = repeatRate + '%';
            if (pointsEarnedEl) pointsEarnedEl.textContent = pointsEarned.toLocaleString();
            if (pointsUsedEl) pointsUsedEl.textContent = pointsUsed.toLocaleString();
            if (pointsUtilizationEl) pointsUtilizationEl.textContent = pointsUtilization + '%';
            
            console.log(`📊 ${currentPeriod} 기간 하단 분석 업데이트:`, {
                newCustomers,
                returningCustomers,
                repeatRate,
                pointsEarned,
                pointsUsed,
                pointsUtilization
            });
        }

        // 주문 통계 로드
        function loadOrderStatistics() {
            try {
                console.log('📈 주문 통계 계산 시작...');
                
                // allOrders가 정의되어 있는지 확인
                if (!window.allOrders || !Array.isArray(window.allOrders)) {
                    console.warn('⚠️ window.allOrders가 정의되지 않았거나 배열이 아닙니다:', window.allOrders);
                    console.log('📋 현재 allOrders 상태:', typeof window.allOrders, window.allOrders);
                    
                    // 기본값으로 설정
                    const todayOrdersEl = document.getElementById('today-orders');
                    const todaySalesEl = document.getElementById('today-sales');
                    const pendingOrdersEl = document.getElementById('pending-orders');
                    const totalCustomersEl = document.getElementById('total-customers');
                    
                    if (todayOrdersEl) todayOrdersEl.textContent = '0';
                    if (todaySalesEl) todaySalesEl.textContent = '¥0';
                    if (pendingOrdersEl) pendingOrdersEl.textContent = '0';
                    if (totalCustomersEl) totalCustomersEl.textContent = '0';
                    return;
                }
                
                console.log('📅 현재 선택된 기간:', currentPeriod);
                console.log('📊 전체 주문 수:', window.allOrders.length);
                
                // 기간별 필터링된 주문
                const filteredOrders = filterOrdersByPeriod(window.allOrders);
                console.log('📊 필터링된 주문 수:', filteredOrders.length);
                
                // 매출 계산 - 다양한 필드명 대응
                const periodSales = filteredOrders.reduce((sum, order) => {
                    const amount = order.totalAmount || order.total || 
                        (order.items ? order.items.reduce((s, item) => s + ((item.price || 0) * (item.quantity || 1)), 0) : 0);
                    return sum + amount;
                }, 0);
                
                const pendingCount = window.allOrders.filter(order => (order.status || 'pending') === 'pending').length;
                
                // 고객 수 계산 - 다양한 구조 대응
                const customerEmails = new Set();
                window.allOrders.forEach(order => {
                    let email = '';
                    if (order.customer && order.customer.email) {
                        email = order.customer.email;
                    } else if (order.customerEmail) {
                        email = order.customerEmail;
                    } else if (order.userEmail) {
                        email = order.userEmail;
                    }
                    if (email) customerEmails.add(email);
                });
                const customers = customerEmails.size;
                
                console.log('📊 통계 계산 완료:', {
                    filteredOrders: filteredOrders.length,
                    periodSales,
                    pendingCount,
                    customers
                });
            
                // 주문 관리 탭의 통계 업데이트 (분석 섹션과 구분)
                const todayOrdersEl = document.getElementById('today-orders');
                const todaySalesEl = document.getElementById('today-sales');
                const pendingOrdersEl = document.getElementById('pending-orders');
                const totalCustomersEl = document.getElementById('total-customers');
                
                if (todayOrdersEl) todayOrdersEl.textContent = filteredOrders.length;
                if (todaySalesEl) todaySalesEl.textContent = `¥${periodSales.toLocaleString()}`;
                if (pendingOrdersEl) pendingOrdersEl.textContent = pendingCount;
                if (totalCustomersEl) totalCustomersEl.textContent = customers;
                
                // 분석 섹션의 매출 지표도 업데이트 (기간별 필터링 적용)
                updateSalesMetrics();
                
                console.log('✅ 주문 통계 업데이트 완료');
                
            } catch (error) {
                console.error('❌ 주문 통계 로드 실패:', error);
                // 기본값으로 설정
                const todayOrdersEl = document.getElementById('today-orders');
                const todaySalesEl = document.getElementById('today-sales');
                const pendingOrdersEl = document.getElementById('pending-orders');
                const totalCustomersEl = document.getElementById('total-customers');
                
                if (todayOrdersEl) todayOrdersEl.textContent = '0';
                if (todaySalesEl) todaySalesEl.textContent = '¥0';
                if (pendingOrdersEl) pendingOrdersEl.textContent = '0';
                if (totalCustomersEl) totalCustomersEl.textContent = '0';
            }
        }

        // 필터링 함수들
        function filterOrders() {
            const statusFilter = document.getElementById('status-filter')?.value || '';
            const dateFilter = document.getElementById('date-filter')?.value || 'today';
            
            window.filteredOrders = window.allOrders.filter(order => {
                // 상태 필터
                if (statusFilter && order.status !== statusFilter) return false;
                
                // 날짜 필터
                const orderDate = new Date(order.orderDate);
                const now = new Date();
                
                if (dateFilter === 'today') {
                    if (orderDate.toDateString() !== now.toDateString()) return false;
                } else if (dateFilter === 'week') {
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    if (orderDate < weekAgo) return false;
                } else if (dateFilter === 'month') {
                    const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    if (orderDate < monthAgo) return false;
                }
                
                return true;
            });
            
            displayOrders();
        }

        function searchOrders() {
            const searchTerm = document.getElementById('search-input')?.value.toLowerCase() || '';
            
            if (!searchTerm) {
                filterOrders();
                return;
            }
            
            window.filteredOrders = window.allOrders.filter(order => {
                const searchFields = [
                    order.id.toLowerCase(),
                    order.customer.name.toLowerCase(),
                    order.customer.email.toLowerCase()
                ];
                return searchFields.some(field => field.includes(searchTerm));
            });
            
            displayOrders();
        }

        function clearSearch() {
            const searchInput = document.getElementById('search-input');
            if (searchInput) searchInput.value = '';
            filterOrders();
        }

        function clearAllFilters() {
            const statusFilter = document.getElementById('status-filter');
            const dateFilter = document.getElementById('date-filter');
            const searchInput = document.getElementById('search-input');
            
            if (statusFilter) statusFilter.value = '';
            if (dateFilter) dateFilter.value = 'today';
            if (searchInput) searchInput.value = '';
            
            filterOrders();
        }

        function refreshOrders() {
            console.log('🔄 주문 데이터 강제 새로고침');
            
            // 기존 데이터 초기화
            window.allOrders = [];
            window.filteredOrders = [];
            
            // 전체 초기화 다시 실행
            initializeOrderManagement();
            loadOrders();
            loadOrderStatistics();
            
            showAdminAlert('注文データを更新しました', 'success');
        }

        function exportOrders() {
            try {
                const exportData = {
                    exportDate: new Date().toISOString(),
                totalOrders: window.filteredOrders.length,
                orders: window.filteredOrders
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `aether_orders_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showAdminAlert('注文データをエクスポートしました', 'success');
                
            } catch (error) {
                console.error('주문 내보내기 실패:', error);
                showAdminAlert('エクスポートに失敗しました', 'danger');
            }
        }

        function showOrderError(message) {
            const container = document.getElementById('orders-container');
            if (container) {
                container.innerHTML = `
                    <div class="empty-orders">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                        <h4 class="japanese-heading">エラー</h4>
                        <p class="japanese-text">${message}</p>
                        <button class="btn btn-secondary" onclick="loadOrders()">再試行</button>
                    </div>
                `;
            }
        }

        // 전역 탭 전환 함수들 (DOMContentLoaded 이벤트 리스너 밖에 정의)
        window.switchToPoints = function() {
            console.log('📋 포인트 관리 탭으로 전환');
            hideAllTabs();
            showTab('points-section');
            updateTabButtons('points-tab');
        };
        
        window.switchToOrders = function() {
            console.log('📋 주문 관리 탭으로 전환');
            hideAllTabs();
            showTab('orders-section');
            updateTabButtons('orders-tab');
            if (typeof loadOrders === 'function') {
                loadOrders();
                loadOrderStatistics();
            }
        };
        
        window.switchToBrands = function() {
            console.log('📋 브랜드 관리 탭으로 전환');
            hideAllTabs();
            showTab('brands-section');
            updateTabButtons('brands-tab');
            if (typeof loadBrands === 'function') {
                loadBrands();
            }
        };
        
        window.switchToProducts = function() {
            console.log('📋 상품 관리 탭으로 전환');
            hideAllTabs();
            showTab('products-section');
            updateTabButtons('products-tab');
            
            // 상품 데이터 강제 로드
            console.log('🔄 상품 데이터 강제 로드 시작...');
            if (typeof window.loadProducts === 'function') {
                window.loadProducts().then(() => {
                    console.log('✅ 상품 데이터 로드 완료');
                    // 검색 필드 초기화
                    const searchInput = document.getElementById('product-search');
                    if (searchInput) {
                        searchInput.value = '';
                    }
                    // 브랜드 필터 초기화
                    const brandFilter = document.getElementById('brand-filter');
                    if (brandFilter) {
                        brandFilter.value = '';
                    }
                    // 모든 상품 표시
                    if (window.allProductsList && window.allProductsList.length > 0) {
                        filteredProductsList = [...window.allProductsList];
                        console.log('🔄 filteredProductsList 설정 완료:', filteredProductsList.length, '개');
                        displayProducts();
                    } else {
                        console.warn('⚠️ 상품 데이터가 없어서 표시할 수 없습니다');
                    }
                }).catch(error => {
                    console.error('❌ 상품 데이터 로드 실패:', error);
                });
            } else {
                console.error('❌ loadProducts 함수를 찾을 수 없습니다');
            }
            
            // 브랜드 필터 로드
            if (typeof loadBrandFilter === 'function') {
                loadBrandFilter();
            }
        };
        
        window.switchToCustomers = function() {
            console.log('📋 고객 관리 탭으로 전환');
            hideAllTabs();
            showTab('customers-section');
            updateTabButtons('customers-tab');
        };
        
        window.switchToAnalytics = function() {
            console.log('📋 분석 탭으로 전환');
            hideAllTabs();
            showTab('analytics-section');
            updateTabButtons('analytics-tab');
        };
        
        window.switchToHomepageTab = function() {
            console.log('📋 홈페이지 관리 탭으로 전환');
            hideAllTabs();
            showTab('homepage-section');
            updateTabButtons('homepage-tab');
        };
        
        window.switchToFooterTab = function() {
            console.log('📋 푸터 관리 탭으로 전환');
            hideAllTabs();
            showTab('footer-section');
            updateTabButtons('footer-tab');
            
            // 푸터 데이터 로드
            if (typeof window.loadFooterData === 'function') {
                window.loadFooterData();
            }
        };
        

        

        


        // Bootstrap 탭 이벤트 리스너
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Bootstrap 탭 이벤트 초기화');
            
            // 페이지 로드 시 일본어 로케일 설정
            setJapaneseLocale();
            
            // 탭 전환 함수들이 정의되었는지 확인 (함수 정의 후에 확인)
            setTimeout(() => {
                console.log('🔍 탭 전환 함수 확인:', {
                    switchToPoints: typeof window.switchToPoints,
                    switchToOrders: typeof window.switchToOrders,
                    switchToBrands: typeof window.switchToBrands,
                    switchToProducts: typeof window.switchToProducts,
                    switchToCustomers: typeof window.switchToCustomers,
                    switchToAnalytics: typeof window.switchToAnalytics,
                    switchToHomepage: typeof window.switchToHomepage,
                    switchToFooter: typeof window.switchToFooter
                });
                
                console.log('✅ 탭 전환 함수 초기화 완료');
            }, 100);
            
            // Bootstrap 탭 이벤트 리스너
            const ordersTab = document.getElementById('orders-tab');
            const brandsTab = document.getElementById('brands-tab');
            const productsTab = document.getElementById('products-tab');
            
            // 주문 관리 탭 - 데이터 로드
            if (ordersTab) {
                ordersTab.addEventListener('shown.bs.tab', function() {
                    console.log('주문 관리 탭 활성화됨');
                    setTimeout(() => {
                        console.log('🔄 주문 데이터 새로고침 시작...');
                        initializeOrderManagement();
                        loadOrders();
                        loadOrderStatistics();
                        console.log('✅ 주문 데이터 새로고침 완료');
                    }, 100);
                });
            }
            
            // 브랜드 관리 탭 - 데이터 로드
            if (brandsTab) {
                brandsTab.addEventListener('shown.bs.tab', function() {
                    console.log('브랜드 관리 탭 활성화됨');
                    setTimeout(() => {
                        loadBrands();
                    }, 100);
                });
            }
            
            // 상품 관리 탭 - 데이터 로드
            if (productsTab) {
                productsTab.addEventListener('shown.bs.tab', function() {
                    console.log('상품 관리 탭 활성화됨');
                    setTimeout(() => {
                        loadProducts();
                        // 브랜드 필터도 로드
                        if (typeof loadBrandFilter === 'function') {
                            loadBrandFilter();
                        }
                    }, 100);
                });
            }
            
            // 디버깅을 위한 전역 함수들
            window.testOrderTab = function() {
                console.log('테스트: 주문 관리 탭 강제 활성화');
                if (ordersTab) {
                    ordersTab.click();
                } else {
                    console.error('주문 관리 탭을 찾을 수 없습니다');
                }
            };
            
            window.resetOrderData = function() {
                console.log('🧹 주문 데이터 초기화 (Firebase 전용)');
                loadOrders();
                console.log('✅ 주문 데이터 로드 완료');
            };
            

            

            
            window.forceInitializeOrders = function() {
                console.log('🔄 강제 주문 관리 초기화');
                
                // 탭 활성화
                const ordersTab = document.getElementById('orders-tab');
                const ordersSection = document.getElementById('orders-section');
                
                if (ordersTab && ordersSection) {
                    // 모든 탭 비활성화
                    document.querySelectorAll('.nav-link').forEach(tab => tab.classList.remove('active'));
                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.remove('show', 'active');
                    });
                    
                    // 주문 관리 탭 활성화
                    ordersTab.classList.add('active');
                    ordersSection.classList.add('show', 'active');
                    
                    console.log('✅ 탭 활성화 완료');
                    
                    // 초기화 실행
                    setTimeout(() => {
                        initializeOrderManagement();
                    }, 100);
                } else {
                    console.error('❌ 탭 요소를 찾을 수 없습니다');
                }
            };
            
            // 실시간 주문 업데이트 감지
            window.startOrderWatcher = function() {
                console.log('👀 주문 데이터 감시 시작');
                
                // Firebase 전용 시스템 - localStorage 감지 제거
                console.log('ℹ️ Firebase 전용 시스템 - localStorage 변경 감지 사용 안함');
                
                // 주기적 체크 (5초마다)
                setInterval(() => {
                    const ordersSection = document.getElementById('orders-section');
                    if (ordersSection && ordersSection.classList.contains('active')) {
                        // 새로운 주문이 있는지 확인
                        const currentCount = window.allOrders ? window.allOrders.length : 0;
                        checkForNewOrders().then(newCount => {
                            if (newCount > currentCount) {
                                console.log('🆕 새로운 주문 감지:', newCount - currentCount + '개');
                                loadOrders();
                                loadOrderStatistics();
                            }
                        });
                    }
                }, 5000);
            };
            
            // 새로운 주문 체크 함수
            window.checkForNewOrders = async function() {
                try {
                    console.log('🔍 Firebase에서 새로운 주문 체크 시작...');
                    
                    if (typeof firebase !== 'undefined' && firebase.firestore && firebase.apps && firebase.apps.length > 0) {
                        const db = firebase.firestore();
                        const ordersSnapshot = await db.collection('orders').get();
                        const currentCount = ordersSnapshot.size;
                        
                        console.log('📊 Firebase orders 컬렉션 현재 문서 수:', currentCount);
                        return currentCount;
                    } else {
                        console.warn('⚠️ Firebase가 초기화되지 않았습니다');
                        return 0;
                    }
                } catch (error) {
                    console.error('새로운 주문 체크 실패:', error);
                    return 0;
                }
            };
            
            // 주문 감시 시작
            setTimeout(() => {
                startOrderWatcher();
            }, 1000);
            
            // 테스트용 실제 주문 데이터 생성 함수
            window.createTestRealOrder = function() {
                console.log('🛒 실제 주문 형식 테스트 데이터 생성');
                
                const testOrder = {
                    id: 'LOCAL-' + Date.now(),
                    userEmail: 'test@aether.com',
                    userName: 'テスト太郎',
                    items: [
                        {
                            id: 'test-product-1',
                            name: 'YUZU SELF FOAMING 3IN1 CLEANER',
                            brand: 'LALARECIPE',
                            price: 2980,
                            quantity: 1
                        },
                        {
                            id: 'test-product-2', 
                            name: 'GREEN PAPAYA PDRN PORE AMPOULE',
                            brand: 'COSCELL',
                            price: 4200,
                            quantity: 2
                        }
                    ],
                    shipping: {
                        name: 'テスト太郎',
                        phone: '090-1234-5678',
                        postal: '100-0001',
                        prefecture: '東京都',
                        city: '千代田区',
                        address1: '丸の内1-1-1'
                    },
                    createdAt: new Date().toISOString(),
                    status: 'pending'
                };
                
                // 총액 계산
                testOrder.totalAmount = testOrder.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                testOrder.earnedPoints = Math.floor(testOrder.totalAmount * 0.03);
                
                // Firebase에 테스트 주문 저장
                console.log('🔥 Firebase에 테스트 주문 저장:', testOrder.id);
                
                console.log('✅ 테스트 주문 생성 완료:', testOrder.id);
                console.log('💰 총액:', testOrder.totalAmount + '円');
                console.log('🎁 적립 포인트:', testOrder.earnedPoints + 'P');
                
                // 주문 목록 새로고침
                refreshOrders();
                
                return testOrder;
            };
        });

        // ========== 브랜드/상품 관리 시스템 JavaScript ==========

        // Firebase Storage는 firebase-config.js에서 전역으로 초기화됨

        // Firebase Storage는 firebase-config.js에서 전역적으로 초기화됩니다
        // 페이지 로드 시 Firebase Storage 확인
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (typeof window.storage !== 'undefined' && window.storage) {
                    console.log('✅ Firebase Storage 사용 가능');
                } else if (typeof firebase !== 'undefined' && firebase.storage) {
                    // 백업: firebase-config.js에서 초기화가 안된 경우
                    window.storage = firebase.storage();
                    console.log('✅ Firebase Storage 백업 초기화 완료');
                } else {
                    console.warn('⚠️ Firebase Storage를 사용할 수 없습니다');
                }
            }, 1000);
        });

        // =========================================
        // 공통 함수
        // =========================================
        
        /**
         * 알림 메시지 표시 (모노톤 스타일)
         */
        function showAlert(message, type = 'info') {
            console.log('showAlert 호출됨:', message, type);
            // 모노톤 색상 매핑
            const colorMap = {
                'success': { bg: '#f8f9fa', border: '#343a40', text: '#343a40' },
                'danger': { bg: '#f8f9fa', border: '#6c757d', text: '#343a40' },
                'warning': { bg: '#f8f9fa', border: '#495057', text: '#343a40' },
                'info': { bg: '#f8f9fa', border: '#6c757d', text: '#343a40' }
            };
            
            const colors = colorMap[type] || colorMap['info'];
            
            // 기존 알림 제거
            const existingAlert = document.querySelector('.custom-alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // 새 알림 생성
            const alertDiv = document.createElement('div');
            alertDiv.className = 'custom-alert';
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                max-width: 400px;
                background: ${colors.bg};
                border: 1px solid ${colors.border};
                border-radius: 8px;
                padding: 12px 16px;
                color: ${colors.text};
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                font-size: 14px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                display: flex;
                align-items: center;
                justify-content: space-between;
                animation: slideInRight 0.3s ease-out;
            `;
            
            // 아이콘 설정
            const iconMap = {
                'success': 'fas fa-check-circle',
                'danger': 'fas fa-exclamation-circle',
                'warning': 'fas fa-exclamation-triangle',
                'info': 'fas fa-info-circle'
            };
            
            const icon = iconMap[type] || iconMap['info'];
            
            alertDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                    <i class="${icon}" style="color: ${colors.border}; font-size: 16px;"></i>
                    <span>${message}</span>
                </div>
                <button type="button" onclick="this.parentElement.remove()" style="
                    background: none;
                    border: none;
                    color: ${colors.border};
                    font-size: 18px;
                    cursor: pointer;
                    padding: 0;
                    margin-left: 12px;
                    width: 20px;
                    height: 20px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">&times;</button>
            `;
            
            document.body.appendChild(alertDiv);
            console.log('알림 요소가 DOM에 추가됨:', alertDiv);
            
            // 3초 후 자동 제거
            setTimeout(() => {
                if (alertDiv && alertDiv.parentNode) {
                    console.log('알림 자동 제거 시작');
                    alertDiv.style.animation = 'slideOutRight 0.3s ease-in';
            setTimeout(() => {
                if (alertDiv && alertDiv.parentNode) {
                    alertDiv.remove();
                            console.log('알림 요소 제거됨');
                }
                    }, 300);
                }
            }, 3000);
        }

        // =========================================
        // 브랜드 관리 JavaScript
        // =========================================

        // 전역 변수
        let allBrands = [];
        let allProducts = [];
        let filteredBrands = [];
        let filteredProducts = [];

        // 브랜드 관리 탭 클릭 이벤트는 위에서 이미 처리됨
        // 상품 관리 탭 클릭 이벤트는 위에서 이미 처리됨

        // 브랜드 로드 (강화된 버전)
        // 브랜드별 상품 수 조회 함수
        async function getProductCountForBrand(brandCode) {
            try {
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    const db = firebase.firestore();
                    const productsQuery = await db.collection('products')
                        .where('brandCode', '==', brandCode)
                        .where('status', '==', 'active')
                        .get();
                    return productsQuery.size;
                }
                return 0;
            } catch (error) {
                console.error(`브랜드 ${brandCode} 상품 수 조회 실패:`, error);
                return 0;
            }
        }

        async function loadBrands() {
            try {
                console.log('📊 브랜드 데이터 로드 시작 (강화된 버전)');
                
                // 1. Firebase에서 강제 로드 시도
                if (typeof firebase !== 'undefined' && firebase && firebase.firestore) {
                    try {
                        console.log('🔥 Firebase에서 브랜드 데이터 강제 로드 시도...');
                const db = firebase.firestore();
                        
                        // 타임아웃 설정
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Firebase 타임아웃')), 10000)
                        );
                        
                        const brandsPromise = db.collection('brands').get();
                        const brandsSnapshot = await Promise.race([brandsPromise, timeoutPromise]);
                        
                        if (brandsSnapshot && !brandsSnapshot.empty) {
                            console.log('📋 Firebase에서 브랜드 문서 개수:', brandsSnapshot.docs.length);
                
                allBrands = brandsSnapshot.docs.map(doc => {
                    const data = doc.data();
                                console.log('📦 브랜드 데이터:', doc.id, {
                                    code: data.code,
                                    nameEn: data.nameEn,
                                    nameJp: data.nameJp,
                                    description: data.description
                                });
                    return {
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt && data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt,
                        updatedAt: data.updatedAt && data.updatedAt.toDate ? data.updatedAt.toDate() : data.updatedAt
                    };
                });
                            window.allBrands = allBrands;
                            
                            console.log('✅ Firebase 브랜드 로드 완료:', allBrands.length, '개');
                            
                            // 각 브랜드의 실제 상품 수 조회
                            console.log('📊 각 브랜드의 상품 수 조회 시작...');
                            for (let i = 0; i < allBrands.length; i++) {
                                const brand = allBrands[i];
                                if (brand.code) {
                                    const productCount = await getProductCountForBrand(brand.code);
                                    allBrands[i].productCount = productCount;
                                    console.log(`📦 ${brand.nameKr} (${brand.code}): ${productCount}개 상품`);
                                }
                            }
                            
                            // 우선순위 설정 및 정렬
                            allBrands = allBrands.map(brand => ({
                                ...brand,
                                priority: brand.priority || 50
                            }));
                            
                            allBrands.sort((a, b) => {
                                if (b.priority !== a.priority) {
                                    return b.priority - a.priority;
                                }
                                return (a.nameKr || '').localeCompare(b.nameKr || '');
                            });
                
                filteredBrands = [...allBrands];
                            displayBrands();
                            updateBrandStats();
                            return;
                        } else {
                            console.log('📭 Firebase에 브랜드 데이터가 없습니다.');
                        }
                    } catch (firebaseError) {
                        console.warn('Firebase 브랜드 로드 실패:', firebaseError);
                    }
                } else {
                    console.log('⚠️ Firebase가 사용할 수 없습니다.');
                }
                
                // Firebase에 브랜드 데이터가 없는 경우
                console.log('📭 Firebase에 브랜드 데이터가 없습니다. 빈 상태로 표시합니다.');
                allBrands = [];
                            window.allBrands = allBrands;
                            filteredBrands = [...allBrands];
                            
                displayBrands();
                updateBrandStats();
                
            } catch (error) {
                console.error('❌ 브랜드 로드 실패:', error);
                showAlert('ブランドデータの読み込みに失敗しました: ' + error.message, 'warning');
                
                // 오류 발생 시 빈 상태로 표시
                allBrands = [];
                window.allBrands = allBrands;
                filteredBrands = [...allBrands];
                displayBrands();
                updateBrandStats();
            }
        }

        // 브랜드 표시
        function displayBrands() {
            const container = document.getElementById('brands-container');
            if (!container) {
                console.error('brands-container를 찾을 수 없습니다');
                return;
            }
            
            if (filteredBrands.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-building fa-3x text-muted mb-3"></i>
                        <p class="text-muted">登録されたブランドがありません。</p>
                        <button class="btn btn-outline-secondary mt-3" onclick="initializeBrandSystem()">
                            <i class="fas fa-database me-2"></i>初期ブランド作成
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '';
            filteredBrands.forEach((brand, index) => {
                try {
                    const statusClass = brand.status === 'active' ? 'status-active' : 'status-inactive';
                    const statusText = brand.status === 'active' ? 'アクティブ' : '非アクティブ';
                    
                    // 이미지 URL 결정 (우선순위: imageData -> logoUrl -> logoPath -> placeholder)
                    let imageUrl = 'assets/img/placeholder-brand.svg';
                    if (brand.imageData && brand.imageData.trim() !== '') {
                        imageUrl = brand.imageData;
                    } else if (brand.logoUrl && brand.logoUrl.trim() !== '') {
                        imageUrl = brand.logoUrl;
                    } else if (brand.logoPath && brand.logoPath.trim() !== '') {
                        imageUrl = brand.logoPath;
                    }
                    
                    html += `
                        <div class="brand-card" data-brand-id="${brand.id}">
                            <div class="row align-items-center">
                                <div class="col-md-1">
                                    <img src="${imageUrl}" 
                                         class="brand-logo" 
                                         alt="${brand.nameKr || 'Brand Logo'}" 
                                         onerror="handleBrandImageError(this)"
                                         onload="console.log('✅ 브랜드 이미지 로드 성공:', '${brand.nameKr}')">
                                </div>
                                <div class="col-md-3">
                                    <h5 class="mb-1">${brand.nameEn || brand.nameJp || brand.nameKr || brand.code || 'Unknown Brand'}</h5>
                                    <p class="text-muted mb-1">${brand.nameJp && brand.nameEn ? brand.nameJp : ''}</p>
                                    <small class="text-muted">コード: ${brand.code || 'N/A'}</small>
                                    <small class="text-muted d-block">保存名: ${brand.nameEn || '未設定'}</small>
                                </div>
                                <div class="col-md-3">
                                    <p class="mb-1">${brand.description || '説明なし'}</p>
                                    <span class="status-badge ${statusClass}">${statusText}</span>
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted">商品数</small>
                                    <div class="fw-bold">${brand.productCount || 0}点</div>
                                    <small class="text-muted">優先度</small>
                                    <div class="fw-bold">${brand.priority || 50}</div>
                                </div>
                                <div class="col-md-3">
                                    <div class="brand-actions">
                                        <button class="btn btn-outline-secondary btn-sm me-2" onclick="editBrand('${brand.id}')">
                                            <i class="fas fa-edit me-1"></i>編集
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="deleteBrand('${brand.id}', '${brand.nameKr || brand.nameEn || 'Unknown Brand'}')">
                                            <i class="fas fa-trash me-1"></i>削除
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error(`ブランド ${index} 表示中エラー:`, error, brand);
                }
            });
            
            container.innerHTML = html;
            console.log(`✅ ${filteredBrands.length}個のブランド表示完了`);
        }

        // 기존 브랜드들에 우선순위 필드 추가
        async function addPriorityToExistingBrands() {
            try {
                showAlert('既存ブランドに優先度を追加中...', 'info');
                
                const db = firebase.firestore();
                const brandsQuery = await db.collection('brands').get();
                
                let updatedCount = 0;
                const batch = db.batch();
                
                brandsQuery.docs.forEach((doc, index) => {
                    const brandData = doc.data();
                    if (brandData.priority === undefined) {
                        // 우선순위가 없는 브랜드에 기본값 50 설정
                        batch.update(doc.ref, {
                            priority: 50,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        updatedCount++;
                    }
                });
                
                if (updatedCount > 0) {
                    await batch.commit();
                    showAlert(`${updatedCount}個のブランドに優先度が追加されました！`, 'success');
                    await loadBrands(); // 브랜드 목록 새로고침
                } else {
                    showAlert('すべてのブランドに既に優先度が設定されています。', 'info');
                }
                
            } catch (error) {
                console.error('❌ 우선순위 추가 오류:', error);
                showAlert(`優先度の追加に失敗しました: ${error.message}`, 'danger');
            }
        }

        // 브랜드 이미지 로딩 오류 처리
        function handleBrandImageError(img) {
            console.warn('❌ 브랜드 이미지 로드 실패:', img.src);
            img.src = 'assets/img/placeholder-brand.svg';
            img.alt = 'ブランドロゴ';
        }

        // 브랜드 통계 업데이트
        function updateBrandStats() {
            const totalBrandsEl = document.getElementById('total-brands');
            const activeBrandsEl = document.getElementById('active-brands');
            const totalProductsEl = document.getElementById('total-products');
            
            if (totalBrandsEl) totalBrandsEl.textContent = allBrands.length;
            if (activeBrandsEl) activeBrandsEl.textContent = allBrands.filter(b => b.status === 'active').length;
            if (totalProductsEl) totalProductsEl.textContent = allProducts.length;
        }

        // 상품 로드 함수 (통합된 버전)
        window.loadProducts = async function() {
            try {
                console.log('📦 상품 데이터 로드 시작 (통합된 버전)');
                
                // 먼저 브랜드 데이터가 로드되었는지 확인
                if (!window.allBrands || window.allBrands.length === 0) {
                    console.log('🔄 브랜드 데이터가 없습니다 -> 브랜드 로드');
                    await loadBrands();
                }
                
                // Firebase에서 상품 데이터 로드 시도
                if (typeof firebase !== 'undefined' && firebase && firebase.firestore) {
                    try {
                        console.log('🔥 Firebase에서 상품 데이터 로드 시도...');
                        const db = firebase.firestore();
                        
                        // 타임아웃 설정
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Firebase 타임아웃')), 10000)
                        );
                        
                        const productsPromise = db.collection('products').get();
                        const productsSnapshot = await Promise.race([productsPromise, timeoutPromise]);
                        
                        if (productsSnapshot && !productsSnapshot.empty) {
                            console.log('📋 Firebase에서 상품 문서 개수:', productsSnapshot.docs.length);
                            
                            const products = productsSnapshot.docs.map(doc => {
                                const data = doc.data();
                                console.log('📦 상품 데이터:', doc.id, data);
                                return {
                                    id: doc.id,
                                    ...data,
                                    createdAt: data.createdAt && data.createdAt.toDate ? data.createdAt.toDate() : data.createdAt,
                                    updatedAt: data.updatedAt && data.updatedAt.toDate ? data.updatedAt.toDate() : data.updatedAt
                                };
                            });
                            
                            // 전역 변수에 저장
                            window.allProductsList = products;
                            window.filteredProductsList = [...products];
                            
                            console.log('✅ Firebase 상품 로드 완료:', products.length, '개');
                            displayProducts(products);
                            updateProductStats(products);
                            return;
                        } else {
                            console.log('📭 Firebase에 상품 데이터가 없습니다.');
                        }
                    } catch (firebaseError) {
                        console.warn('Firebase 상품 로드 실패:', firebaseError);
                    }
                } else {
                    console.log('⚠️ Firebase가 사용할 수 없습니다.');
                }
                
                // Firebase에서 데이터를 가져올 수 없으면 빈 배열로 설정
                console.log('📦 Firebase에 상품 데이터가 없습니다. 빈 상태로 표시합니다.');
                window.allProductsList = [];
                window.filteredProductsList = [];
                
                console.log('✅ 상품 데이터 로드 완료: 0개');
                displayProducts([]);
                updateProductStats([]);
                
            } catch (error) {
                console.error('❌ 상품 로드 실패:', error);
                showAlert('상품 데이터 로드에 실패했습니다: ' + error.message, 'warning');
                
                // 오류 발생 시 빈 배열로 설정
                window.allProductsList = [];
                window.filteredProductsList = [];
                displayProducts([]);
                updateProductStats([]);
            }
        }

        // 상품 표시 함수 (통합된 버전)
        window.displayProducts = function(products = null) {
            const container = document.getElementById('products-container');
            if (!container) {
                console.error('❌ 상품 컨테이너를 찾을 수 없습니다');
                return;
            }
            
            // 매개변수가 없으면 전역 변수 사용
            const productsToShow = products || window.filteredProductsList || window.allProductsList || [];
            
            // 디버깅: 상품 데이터 구조 확인
            if (productsToShow && productsToShow.length > 0) {
                console.log('🔍 상품 데이터 구조 확인 (첫 번째 상품):', productsToShow[0]);
                console.log('🔍 상품명 필드들:', {
                    nameEn: productsToShow[0].nameEn,
                    nameJp: productsToShow[0].nameJp
                });
            }
            
            if (!productsToShow || productsToShow.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-box fa-3x text-muted mb-3"></i>
                        <p class="text-muted">등록된 상품이 없습니다.</p>
                        <button class="btn btn-outline-secondary mt-3" onclick="createSampleProducts()">
                            <i class="fas fa-plus me-2"></i>샘플 상품 생성
                        </button>
                </div>
            `;
                return;
            }
            
            let html = '';
            productsToShow.forEach((product, index) => {
                const statusClass = product.status === 'active' ? 'status-active' : 'status-inactive';
                const statusText = product.status === 'active' ? 'アクティブ' : '非アクティブ';
                
                // 이미지 URL 결정
                let imageUrl = 'assets/img/placeholder-brand.svg';
                if (product.imageUrl && product.imageUrl.trim() !== '') {
                    imageUrl = product.imageUrl;
                } else if (product.imagePath && product.imagePath.trim() !== '') {
                    imageUrl = product.imagePath;
                }
                
                // 배지 정보 처리
                let badgeHtml = '';
                const colorMap = {
                    'red': '#dc3545',
                    'blue': '#0d6efd',
                    'green': '#198754',
                    'orange': '#fd7e14',
                    'purple': '#6f42c1',
                    'dark': '#212529'
                };
                
                if (product.badgeType && product.badgeType !== '') {
                    const badgeText = product.badgeType === 'CUSTOM' ? (product.badgeText || 'CUSTOM') : product.badgeType;
                    const badgeColor = colorMap[product.badgeColor] || '#dc3545';
                    badgeHtml = `<span class="badge" style="background-color: ${badgeColor}; color: white; font-size: 10px; margin-left: 5px;">${badgeText}</span>`;
                }

                html += `
                    <div class="col-6 col-md-6 col-lg-4 mb-4">
                        <div class="card product-card h-100" data-product-id="${product.id}">
                            <div class="position-relative">
                                <img src="${imageUrl}" alt="${product.nameEn}" class="card-img-top"
                                     onerror="this.src='assets/img/placeholder-product.jpg'"
                                     style="height: 150px; object-fit: cover;">
                                ${product.badgeType && product.badgeType !== '' ? `
                                    <span class="badge" style="position: absolute; top: 8px; right: 8px; background-color: ${colorMap[product.badgeColor] || '#dc3545'}; color: white; font-size: 11px; padding: 4px 8px; border-radius: 4px; z-index: 10;">
                                        ${product.badgeType === 'CUSTOM' ? (product.badgeText || 'CUSTOM') : product.badgeType}
                                    </span>
                                ` : ''}
                            </div>
                            <div class="card-body">
                                <h6 class="card-title mb-2">${product.nameEn || product.nameJp || '商品名なし'}</h6>
                                <div class="product-meta mb-2">
                                    <span class="badge bg-secondary me-1">${product.brandName || product.brandCode || '不明'}</span>
                                    <span class="badge ${statusClass}">${statusText}</span>
                                ${badgeHtml}
                            </div>
                                <div class="d-flex justify-content-between align-items-center">
                                <div class="product-price">
                                    ${product.salePrice && product.salePrice > 0 ? 
                                        `<span class="original-price text-muted" style="text-decoration: line-through; font-size: 0.9em;">¥${(product.price || 0).toLocaleString()}</span><br>
                                         <span class="sale-price text-dark fw-bold">¥${product.salePrice.toLocaleString()}</span>` :
                                            `<span class="regular-price fw-bold">¥${(product.price || 0).toLocaleString()}</span>`
                                    }
                                </div>
                                    <div class="btn-group">
                                        <button class="btn btn-outline-secondary btn-sm" onclick="editProduct('${product.id}')" title="編集">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteProduct('${product.id}')" title="削除">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = `<div class="row">${html}</div>`;
        }
        
        // 샘플 상품 생성
        async function createSampleProducts() {
            try {
                if (!firebase || !firebase.firestore) {
                    showAlert('Firebase가 초기화되지 않았습니다.', 'warning');
                    return;
                }
                
                const db = firebase.firestore();
                const sampleProducts = [
                    {
                        nameEn: 'BAKUCHINOL EYE CREAM',
                        nameKr: '바쿠치놀 아이 크림',
                        brandName: 'LALARECIPE',
                        price: 2980,
                        stock: 50,
                        status: 'active',
                        imageUrl: 'assets/img/PRODUCTS/lalarecipe-bakuchinol-eye-cream.jpg',
                        description: '강력한 안티에이징 성분 바쿠치놀을 함유한 아이 크림',
                        createdAt: new Date(),
                        updatedAt: new Date()
                    },
                    {
                        nameEn: 'YUZU VITA C CREAM',
                        nameKr: '유자 비타민 C 크림',
                        brandName: 'LALARECIPE',
                        price: 3500,
                        stock: 30,
                        status: 'active',
                        imageUrl: 'assets/img/PRODUCTS/lalarecipe-yuzu-vita-c-cream.jpg',
                        description: '유자 추출물과 비타민 C를 함유한 브라이트닝 크림',
                        createdAt: new Date(),
                        updatedAt: new Date()
                    },
                    {
                        nameEn: 'GREEN PAPAYA PDRN PORE AMPOULE',
                        nameKr: '그린 파파야 PDRN 모공 앰플',
                        brandName: 'COSCELL',
                        price: 4200,
                        stock: 25,
                        status: 'active',
                        imageUrl: 'assets/img/PRODUCTS/coscell-green-papaya-pdrn-pore-ampoule.jpg',
                        description: '파파야 추출물과 PDRN을 함유한 모공 개선 앰플',
                        createdAt: new Date(),
                        updatedAt: new Date()
                    }
                ];
                
                const batch = db.batch();
                sampleProducts.forEach(product => {
                    // 상품명을 기반으로 문서 ID 생성
                    let productDocId = '';
                    
                    // 1차 시도: 영어명 사용
                    if (product.nameEn && product.nameEn.trim()) {
                        productDocId = product.nameEn.toLowerCase()
                            .replace(/\s+/g, '-')
                            .replace(/[^a-z0-9-]/g, '')
                            .substring(0, 50);
                    }
                    
                    // 2차 시도: 일본어명 사용
                    if (!productDocId && product.nameJp && product.nameJp.trim()) {
                        productDocId = product.nameJp.toLowerCase()
                            .replace(/\s+/g, '-')
                            .replace(/[^a-z0-9-]/g, '')
                            .substring(0, 50);
                    }
                    
                    // 4차 시도: 타임스탬프 기반
                    if (!productDocId) {
                        productDocId = `product-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    }
                    
                    const docRef = db.collection('products').doc(productDocId);
                    batch.set(docRef, product);
                });
                
                await batch.commit();
                console.log('✅ 샘플 상품 생성 완료');
                showAlert('샘플 상품이 생성되었습니다.', 'success');
                
                // 상품 목록 새로고침
                loadProducts();
                
            } catch (error) {
                console.error('❌ 샘플 상품 생성 실패:', error);
                showAlert('샘플 상품 생성에 실패했습니다: ' + error.message, 'danger');
            }
        }
        
        // Firebase 강제 초기화 함수
        async function forceInitializeFirebase() {
            try {
                console.log('🔥 Firebase 강제 초기화 시작...');
                
                if (typeof firebase === 'undefined') {
                    console.error('Firebase SDK가 로드되지 않았습니다.');
                    return false;
                }
                
                // Firebase 앱 초기화
                if (!firebase.apps.length) {
                    firebase.initializeApp({
                        apiKey: "AIzaSyDMXVksXuTT0rY33GHwlnE1a9tAGbviNFc",
                        authDomain: "aether-fixed.firebaseapp.com",
                        projectId: "aether-fixed",
                        storageBucket: "aether-fixed.firebasestorage.app",
                        messagingSenderId: "229862254275",
                        appId: "1:229862254275:web:7190d726004e2da72b2476",
                        measurementId: "G-2P6DLVTECY"
                    });
                }
                
                // Firestore 초기화
                const db = firebase.firestore();
                console.log('✅ Firestore 초기화 완료');
                
                // Auth 초기화
                const auth = firebase.auth();
                console.log('✅ Auth 초기화 완료');
                
                // 보안상 하드코딩된 비밀번호 사용 중단
                console.log('⚠️ 보안상 하드코딩된 비밀번호 사용을 중단합니다.');
                console.log('현재 로그인된 관리자:', currentAdmin?.email);
                
                console.log('✅ Firebase 강제 초기화 완료');
                return true;
                
            } catch (error) {
                console.error('❌ Firebase 강제 초기화 실패:', error);
                return false;
            }
        }
        
        // 강제 데이터 로드 함수
        async function forceLoadData() {
            try {
                console.log('🚀 강제 데이터 로드 시작...');
                
                // Firebase 강제 초기화
                const firebaseReady = await forceInitializeFirebase();
                
                if (firebaseReady) {
                    console.log('🔥 Firebase 준비됨, 데이터 로드 시도...');
                    
                    // 브랜드 데이터 강제 로드
                    await loadBrands();
                    
                    // 상품 데이터 강제 로드
                    await loadProducts();
                    
                    console.log('✅ 강제 데이터 로드 완료');
                    showAlert('데이터 로드가 완료되었습니다.', 'success');
                } else {
                    console.log('⚠️ Firebase 초기화 실패, 기본 데이터 사용');
                    await loadBrands();
                    await loadProducts();
                }
                
            } catch (error) {
                console.error('❌ 강제 데이터 로드 실패:', error);
                showAlert('데이터 로드에 실패했습니다: ' + error.message, 'warning');
            }
        }
        
        // 긴급 데이터 로드 함수 제거됨 - Firebase 전용 시스템
        
        // Firebase 직접 접근 함수
        window.directFirebaseAccess = async function() {
            try {
                console.log('🔥 Firebase 직접 접근 시도...');
                
                if (typeof firebase === 'undefined') {
                    console.error('Firebase SDK가 로드되지 않았습니다.');
                    return;
                }
                
                // Firestore 직접 접근
                const db = firebase.firestore();
                console.log('✅ Firestore 접근 성공');
                
                // 브랜드 컬렉션 확인
                const brandsSnapshot = await db.collection('brands').get();
                console.log('브랜드 문서 개수:', brandsSnapshot.docs.length);
                
                if (!brandsSnapshot.empty) {
                    brandsSnapshot.docs.forEach(doc => {
                        console.log('브랜드:', doc.id, doc.data());
                    });
                }
                
                // 상품 컬렉션 확인
                const productsSnapshot = await db.collection('products').get();
                console.log('상품 문서 개수:', productsSnapshot.docs.length);
                
                if (!productsSnapshot.empty) {
                    productsSnapshot.docs.forEach(doc => {
                        console.log('상품:', doc.id, doc.data());
                    });
                }
                
                console.log('✅ Firebase 직접 접근 완료');
                
            } catch (error) {
                console.error('❌ Firebase 직접 접근 실패:', error);
            }
        };



        // 画像アップロード機能 (Firebase Storage 방식)
        async function uploadImageToFirebase(file, brandCode) {
            try {
                // Firebase 초기화 확인
                if (!firebase || !firebase.storage) {
                    throw new Error('Firebase Storage가 초기화되지 않았습니다.');
                }
                
                // 인증 상태 확인 (재시도 메커니즘 포함)
                let user = firebase.auth().currentUser;
                if (!user) {
                    console.log('⚠️ Firebase Auth 인증 없음, 강제 로그인 시도...');
                    
                    // 보안상 하드코딩된 비밀번호 사용 중단, 익명 로그인 사용
                    try {
                        console.log('⚠️ 보안상 하드코딩된 비밀번호 사용을 중단합니다.');
                        console.log('현재 로그인된 관리자:', currentAdmin?.email);
                        
                        // 익명 로그인으로 Firebase Storage 접근
                        await firebase.auth().signInAnonymously();
                        user = firebase.auth().currentUser;
                        console.log('✅ 익명 로그인 성공 (이미지 업로드용)');
                    } catch (anonLoginError) {
                        console.log('익명 로그인 실패:', anonLoginError.code);
                        throw new Error('Firebase 인증이 필요합니다. 페이지를 새로고침해주세요.');
                    }
                }
                console.log('✅ 인증된 사용자:', user.email || '익명 사용자');
                
                // 파일 크기 제한 (10MB)
                const maxSize = 10 * 1024 * 1024; // 10MB
                if (file.size > maxSize) {
                    throw new Error(`파일 크기가 너무 큽니다. 최대 10MB까지 허용됩니다. (현재: ${Math.round(file.size / (1024 * 1024))}MB)`);
                }
                
                showAlert('画像をアップロード中です...', 'info');
                
                // Firebase Storage에 업로드
                const timestamp = Date.now();
                const fileExtension = file.name.split('.').pop();
                const fileName = `${brandCode}_${timestamp}.${fileExtension}`;
                const storageRef = firebase.storage().ref(`brands/${fileName}`);
                
                console.log('🔥 Firebase Storage 업로드 시작:', fileName);
                
                // 파일 업로드
                const uploadTask = storageRef.put(file);
                
                // 업로드 진행률 모니터링
                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log(`📤 업로드 진행률: ${Math.round(progress)}%`);
                    },
                    (error) => {
                        console.error('❌ 업로드 실패:', error);
                        throw error;
                    }
                );
                
                // 업로드 완료 대기
                const snapshot = await uploadTask;
                const downloadURL = await snapshot.ref.getDownloadURL();
                
                console.log('✅ Firebase Storage 업로드 성공:', downloadURL);
                return {
                    success: true,
                    url: downloadURL,
                    path: `brands/${fileName}`,
                    fileName: fileName,
                    fileSize: file.size,
                    fileType: file.type
                };
                
            } catch (error) {
                console.error('❌ 画像アップロード失敗:', error);
                
                // CORS 오류인 경우 특별 처리
                if (error.message && error.message.includes('CORS')) {
                    showAlert('CORS 오류가 발생했습니다. Firebase Storage 설정을 확인해주세요.', 'danger');
                } else {
                showAlert(`画像アップロードに失敗しました: ${error.message}`, 'danger');
                }
                
                return {
                    success: false,
                    error: error.message
                };
            }
        }
        
        // 이미지 압축 및 Base64 변환 함수
        async function compressAndConvertToBase64(file) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // 최대 크기 설정 (800px)
                    const maxWidth = 800;
                    const maxHeight = 800;
                    
                    let { width, height } = img;
                    
                    // 비율 유지하면서 크기 조정
                    if (width > height) {
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width = (width * maxHeight) / height;
                            height = maxHeight;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // 이미지 그리기
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // JPEG로 압축 (품질 0.7)
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    resolve(compressedDataUrl);
                };
                
                img.onerror = function() {
                    reject(new Error('이미지 로드에 실패했습니다.'));
                };
                
                // 파일을 이미지로 로드
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                };
                reader.onerror = function() {
                    reject(new Error('파일 읽기에 실패했습니다.'));
                };
                reader.readAsDataURL(file);
            });
        }

        // 既存画像をFirebase Storageに移行
        async function migrateLocalImagesToFirebase() {
            try {
                showAlert('画像移行を開始します...', 'info');
                
                if (allBrands.length === 0) {
                    showAlert('移行するブランドがありません。', 'warning');
                    return;
                }
                
                let successCount = 0;
                let failCount = 0;
                
                for (const brand of allBrands) {
                    try {
                        // ローカル画像のパスをチェック
                        if (!brand.logoUrl || !brand.logoUrl.startsWith('assets/img/SHOP BRAND/')) {
                            console.log(`⏭️ ${brand.nameKr}: 既にFirebase Storageを使用中`);
                            continue;
                        }
                        
                        // ローカル画像をBlobとして取得
                        console.log(`📤 ${brand.nameKr}の画像を移行中...`);
                        
                        const response = await fetch(brand.logoUrl);
                        if (!response.ok) {
                            throw new Error(`画像の取得に失敗: ${response.status}`);
                        }
                        
                        const blob = await response.blob();
                        const file = new File([blob], `${brand.code}.jpg`, { type: 'image/jpeg' });
                        
                        // Firebase Storageにアップロード
                        const uploadResult = await uploadImageToFirebase(file, brand.code);
                        
                        if (uploadResult.success) {
                            // Firestoreのブランド情報を更新
                            const db = firebase.firestore();
                            await db.collection('brands').doc(brand.id).update({
                                logoUrl: uploadResult.url,
                                logoPath: uploadResult.path,
                                migratedToFirebase: true,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            console.log(`✅ ${brand.nameKr}: 移行完了`);
                            successCount++;
                        } else {
                            failCount++;
                        }
                        
                        // 少し待機（レート制限回避）
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                    } catch (error) {
                        console.error(`❌ ${brand.nameKr}の移行失敗:`, error);
                        failCount++;
                    }
                }
                
                showAlert(`画像移行完了！成功: ${successCount}件、失敗: ${failCount}件`, 'success');
                
                // ブランドリストを再読込
                await loadBrands();
                
            } catch (error) {
                console.error('❌ 画像移行エラー:', error);
                showAlert(`画像移行に失敗しました: ${error.message}`, 'danger');
            }
        }

        // ブランド 추가モーダル表示
        function showAddBrandModal() {
            // Bootstrap モーダルを開く (static backdrop 설정)
            const modalElement = document.getElementById('brandModal');
            const modal = new bootstrap.Modal(modalElement, {
                backdrop: 'static',
                keyboard: false
            });
            
            // フォームをクリア
            document.getElementById('brandForm').reset();
            document.getElementById('brand-id').value = '';
            document.getElementById('brandModalLabel').textContent = '新しいブランドを追加';
            
            // プレビュー画像をクリア
            clearBrandImagePreviews();
            
            modal.show();
        }

        // 브랜드 이미지 프리뷰 초기화
        function clearBrandImagePreviews() {
            // 브랜드 로고 프리뷰 초기화
            const logoPreview = document.getElementById('brand-logo-preview');
            const logoPlaceholder = document.getElementById('brand-logo-upload-placeholder');
            const logoInput = document.getElementById('brand-logo');
            
            if (logoPreview) logoPreview.style.display = 'none';
            if (logoPlaceholder) logoPlaceholder.style.display = 'block';
            if (logoInput) logoInput.value = '';
            
            // 브랜드 대표이미지 프리뷰 초기화
            const imagePreview = document.getElementById('brand-image-preview');
            const imagePlaceholder = document.getElementById('brand-upload-placeholder');
            const imageInput = document.getElementById('brand-image');
            
            if (imagePreview) imagePreview.style.display = 'none';
            if (imagePlaceholder) imagePlaceholder.style.display = 'block';
            if (imageInput) imageInput.value = '';
            
            // URL 필드 초기화
            document.getElementById('brand-current-url').value = '';
            document.getElementById('brand-logo-current-url').value = '';
        }

        // 브랜드 로고 삭제
        function removeBrandLogo() {
            console.log('🗑️ 브랜드 로고 삭제 시작');
            
            const logoPreview = document.getElementById('brand-logo-preview');
            const logoPlaceholder = document.getElementById('brand-logo-upload-placeholder');
            const logoInput = document.getElementById('brand-logo');
            const logoUrlField = document.getElementById('brand-logo-current-url');
            const logoPreviewImg = document.getElementById('brand-logo-preview-img');
            
            console.log('🔍 요소 확인:', {
                logoPreview: !!logoPreview,
                logoPlaceholder: !!logoPlaceholder,
                logoInput: !!logoInput,
                logoUrlField: !!logoUrlField,
                logoPreviewImg: !!logoPreviewImg
            });
            
            // 미리보기 숨기기
            if (logoPreview) {
            logoPreview.style.display = 'none';
                console.log('✅ 로고 미리보기 숨김');
            }
            
            // 플레이스홀더 표시
            if (logoPlaceholder) {
            logoPlaceholder.style.display = 'block';
                console.log('✅ 로고 플레이스홀더 표시');
            }
            
            // 입력 필드 초기화
            if (logoInput) {
            logoInput.value = '';
                console.log('✅ 로고 입력 필드 초기화');
            }
            
            if (logoUrlField) {
            logoUrlField.value = '';
                console.log('✅ 로고 URL 필드 초기화');
            }
            
            // 이미지 소스 초기화
            if (logoPreviewImg) {
                logoPreviewImg.src = '';
                console.log('✅ 로고 이미지 소스 초기화');
            }
            
            console.log('✅ 브랜드 로고 삭제 완료');
            showAlert('ブランドロゴが削除されました。', 'success');
        }

        // 브랜드 대표이미지 삭제
        function removeBrandImage() {
            console.log('🗑️ 브랜드 대표이미지 삭제 시작');
            
            const imagePreview = document.getElementById('brand-image-preview');
            const imagePlaceholder = document.getElementById('brand-upload-placeholder');
            const imageInput = document.getElementById('brand-image');
            const imageUrlField = document.getElementById('brand-current-url');
            const imagePreviewImg = document.getElementById('brand-preview-img');
            
            console.log('🔍 요소 확인:', {
                imagePreview: !!imagePreview,
                imagePlaceholder: !!imagePlaceholder,
                imageInput: !!imageInput,
                imageUrlField: !!imageUrlField,
                imagePreviewImg: !!imagePreviewImg
            });
            
            // 미리보기 숨기기
            if (imagePreview) {
            imagePreview.style.display = 'none';
                console.log('✅ 이미지 미리보기 숨김');
            }
            
            // 플레이스홀더 표시
            if (imagePlaceholder) {
            imagePlaceholder.style.display = 'block';
                console.log('✅ 이미지 플레이스홀더 표시');
            }
            
            // 입력 필드 초기화
            if (imageInput) {
            imageInput.value = '';
                console.log('✅ 이미지 입력 필드 초기화');
            }
            
            if (imageUrlField) {
            imageUrlField.value = '';
                console.log('✅ 이미지 URL 필드 초기화');
            }
            
            // 이미지 소스 초기화
            if (imagePreviewImg) {
                imagePreviewImg.src = '';
                console.log('✅ 이미지 소스 초기화');
            }
            
            console.log('✅ 브랜드 대표이미지 삭제 완료');
            showAlert('ブランド代表画像が削除されました。', 'success');
        }

        // 모달 닫기 차단 (확인 없이)
        function confirmCloseModal() {
            // 아무것도 하지 않음 - 모달이 닫히지 않음
            return false;
        }

        // 브랜드 편집 취소
        function cancelBrandEdit() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('brandModal'));
            modal.hide();
        }

        // 모달 이벤트 리스너 설정
        document.addEventListener('DOMContentLoaded', function() {
            const brandModal = document.getElementById('brandModal');
            if (brandModal) {
                // 모달이 표시될 때 이벤트 리스너 추가
                brandModal.addEventListener('show.bs.modal', function() {
                    // 배경 클릭 이벤트 완전 차단
                    this.addEventListener('click', function(e) {
                        if (e.target === this) {
                            e.preventDefault();
                            e.stopPropagation();
                            return false;
                        }
                    });
                    
                    // ESC 키 이벤트 완전 차단
                    const escHandler = function(e) {
                        if (e.key === 'Escape') {
                            e.preventDefault();
                            e.stopPropagation();
                            return false;
                        }
                    };
                    document.addEventListener('keydown', escHandler);
                    
                    // 모달이 숨겨질 때 ESC 키 이벤트 리스너 제거
                    brandModal.addEventListener('hidden.bs.modal', function() {
                        document.removeEventListener('keydown', escHandler);
                    }, { once: true });
                });
            }
        });

        // ブランドロゴプレビュー機能
        function previewBrandLogo(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                processBrandLogoFile(file);
            }
        }

        // ブランドロゴファイル処理
        function processBrandLogoFile(file) {
            // ファイルサイズチェック (10MB)
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                const currentSize = Math.round(file.size / (1024 * 1024));
                showAlert(`ファイルサイズが大きすぎます。10MB以下のファイルを選択してください。 (現在: ${currentSize}MB)`, 'danger');
                return;
            }
            
            // ファイルタイプチェック
            if (!file.type.startsWith('image/')) {
                showAlert('画像ファイルのみアップロード可能です。', 'danger');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('brand-logo-preview');
                const placeholder = document.getElementById('brand-logo-upload-placeholder');
                const previewImg = document.getElementById('brand-logo-preview-img');
                
                previewImg.src = e.target.result;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
            
            // ファイル input에 파일 설정
            const fileInput = document.getElementById('brand-logo');
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
        }

        // ブランドロゴドラッグ&ドロップ機能
        function handleBrandLogoDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const dropZone = document.getElementById('brand-logo-drop-zone');
            dropZone.classList.remove('drag-over');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                processBrandLogoFile(file);
            }
        }

        // 画像プレビュー機能
        function previewBrandImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                processBrandImageFile(file);
            }
        }

        // ブランド画像ファイル処理
        function processBrandImageFile(file) {
            // ファイルサイズチェック (10MB)
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                const currentSize = Math.round(file.size / (1024 * 1024));
                showAlert(`ファイルサイズが大きすぎます。10MB以下のファイルを選択してください。 (現在: ${currentSize}MB)`, 'danger');
                return;
            }
            
            // ファイルタイプチェック
            if (!file.type.startsWith('image/')) {
                showAlert('画像ファイルのみアップロード可能です。', 'danger');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('brand-image-preview');
                const placeholder = document.getElementById('brand-upload-placeholder');
                const previewImg = document.getElementById('brand-preview-img');
                
                previewImg.src = e.target.result;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
            
            // ファイル input에 파일 설정
            const fileInput = document.getElementById('brand-image');
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
        }

        // ブランド画像ドラッグ&ドロップ機能
        function handleBrandImageDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const dropZone = document.getElementById('brand-image-drop-zone');
            dropZone.classList.remove('drag-over');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                processBrandImageFile(file);
            }
        }

        function handleBrandImageDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const dropZone = document.getElementById('brand-image-drop-zone');
            dropZone.classList.add('drag-over');
        }

        function handleBrandImageDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const dropZone = document.getElementById('brand-image-drop-zone');
            dropZone.classList.remove('drag-over');
        }

        // ブランド保存機能
        async function saveBrand() {
            try {
                // 폼 요소 존재 확인
                const form = document.getElementById('brandForm');
                if (!form) {
                    throw new Error('브랜드 폼을 찾을 수 없습니다.');
                }
                
                const formData = new FormData(form);
                const brandIdElement = document.getElementById('brand-id');
                const brandId = brandIdElement ? brandIdElement.value : '';
                
                // 必須フィールドのチェック - DOM 요소에서 직접 가져오기
                const code = document.getElementById('brand-code').value.trim();
                const nameEn = document.getElementById('brand-name-kr').value.trim();
                const nameJp = document.getElementById('brand-name-jp').value.trim();
                
                if (!code || !nameEn || !nameJp) {
                    showAlert('必須フィールドを入力してください。', 'danger');
                    return;
                }
                
                // ブランドコードの重複チェック (新規追加の場合)
                if (!brandId) {
                    const existingBrand = allBrands.find(b => b.code === code);
                    if (existingBrand) {
                        showAlert('このブランドコードは既に存在します。', 'danger');
                        return;
                    }
                }
                
                // Firebase 연결 상태 확인
                if (!navigator.onLine) {
                    throw new Error('인터넷 연결이 없습니다. 네트워크 연결을 확인해주세요.');
                }
                
                showAlert('ブランドを保存中です...', 'info');
                
                let logoUrl = document.getElementById('brand-current-url').value;
                let logoPath = '';
                let brandLogoUrl = document.getElementById('brand-logo-current-url').value;
                let brandLogoPath = '';
                
                // ブランド 대표이미지가アップロードされている場合
                const imageFile = document.getElementById('brand-image').files[0];
                if (imageFile) {
                    const uploadResult = await uploadImageToFirebase(imageFile, `${code}_main`);
                    if (uploadResult.success) {
                        logoUrl = uploadResult.url;
                        logoPath = uploadResult.path;
                    } else {
                        showAlert('ブランド大代表画像のアップロードに失敗しました。', 'danger');
                        return;
                    }
                }
                
                // ブランドロゴがアップロードされている場合
                const logoFile = document.getElementById('brand-logo').files[0];
                if (logoFile) {
                    const uploadResult = await uploadImageToFirebase(logoFile, `${code}_logo`);
                    if (uploadResult.success) {
                        brandLogoUrl = uploadResult.url;
                        brandLogoPath = uploadResult.path;
                    } else {
                        showAlert('ブランドロゴのアップロードに失敗しました。', 'danger');
                        return;
                    }
                }
                
                // ブランドデータの準備
                const brandData = {
                    code: code,
                    nameEn: nameEn,
                    nameJp: nameJp,
                    description: formData.get('description') || '',
                    priority: parseInt(formData.get('priority')) || 50,
                    status: formData.get('status') || 'active',
                    logoUrl: logoUrl,  // 브랜드 대표이미지 (shop.html용)
                    logoPath: logoPath,
                    brandLogoUrl: brandLogoUrl,  // 브랜드 로고 (brand-template.html용)
                    brandLogoPath: brandLogoPath,
                    productCount: 0,
                    // 배지 정보 추가 (안전한 null 체크)
                    badgeType: document.getElementById('brand-badge-type')?.value || '',
                    badgeColor: document.getElementById('brand-badge-color')?.value || 'secondary',
                    badgeText: document.getElementById('brand-badge-text')?.value || '',
                    badgeStartDate: document.getElementById('brand-badge-start')?.value || '',
                    badgeEndDate: document.getElementById('brand-badge-end')?.value || '',
                    // Firebase Storage URL만 저장 (Base64 데이터 제거)
                    imageData: null,
                    logoData: null,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // 디버깅: 저장될 브랜드 데이터 로그
                console.log('💾 저장될 브랜드 데이터:', {
                    code: brandData.code,
                    nameEn: brandData.nameEn,
                    nameJp: brandData.nameJp,
                    description: brandData.description
                });
                
                // 문서 크기 확인 (Firestore 제한: 1MB)
                const jsonString = JSON.stringify(brandData);
                const documentSize = new Blob([jsonString]).size;
                const maxDocumentSize = 1024 * 1024; // 1MB
                
                console.log(`📊 브랜드 문서 크기: ${Math.round(documentSize / 1024)}KB`);
                
                if (documentSize > maxDocumentSize) {
                    const sizeInMB = (documentSize / (1024 * 1024)).toFixed(2);
                    throw new Error(`브랜드 데이터가 너무 큽니다 (${sizeInMB}MB). 이미지를 더 작게 압축하거나 제거해주세요.`);
                }
                
                if (!brandId) {
                    // 新規追加
                    brandData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                }
                
                // Firestoreに保存
                const db = firebase.firestore();
                if (brandId) {
                    // 更新
                    try {
                        await db.collection('brands').doc(brandId).update(brandData);
                        console.log('브랜드 업데이트 완료');
                        showAlert('ブランドが更新されました！', 'success');
                    } catch (updateError) {
                        console.error('브랜드 업데이트 오류:', updateError);
                        if (updateError.code === 'unavailable') {
                            throw new Error('Firebase 서버에 연결할 수 없습니다. 잠시 후 다시 시도해주세요.');
                        } else if (updateError.code === 'permission-denied') {
                            throw new Error('업데이트 권한이 없습니다. 관리자 권한을 확인해주세요.');
                        } else {
                            throw updateError;
                        }
                    }
                } else {
                    // 新規追加 - nameEn을 문서 ID로 사용
                    const brandDocId = nameEn.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
                    try {
                        await db.collection('brands').doc(brandDocId).set(brandData);
                        console.log('브랜드 추가 완료:', brandDocId);
                        showAlert('新しいブランドが追加されました！', 'success');
                    } catch (setError) {
                        console.error('브랜드 추가 오류:', setError);
                        if (setError.code === 'unavailable') {
                            throw new Error('Firebase 서버에 연결할 수 없습니다. 잠시 후 다시 시도해주세요.');
                        } else if (setError.code === 'permission-denied') {
                            throw new Error('저장 권한이 없습니다. 관리자 권한을 확인해주세요.');
                        } else {
                            throw setError;
                        }
                    }
                }
                
                // モーダルを閉じる
                const modal = bootstrap.Modal.getInstance(document.getElementById('brandModal'));
                modal.hide();
                
                // ブランドリストを再読込
                await loadBrands();
                
            } catch (error) {
                console.error('❌ ブランド保存エラー:', error);
                showAlert(`ブランドの保存に失敗しました: ${error.message}`, 'danger');
            }
        }

        window.editBrand = function(brandId) {
            const brand = allBrands.find(b => b.id === brandId);
            if (!brand) {
                showAlert('ブランドが見つかりません。', 'danger');
                return;
            }
            
            // モーダルのタイトルを変更
            const modalLabel = document.getElementById('brandModalLabel');
            if (modalLabel) {
                modalLabel.textContent = 'ブランドを編集';
            }
            
            // 이미지 프리뷰 초기화
            clearBrandImagePreviews();
            
            // フォームにデータを設定 (필드 존재 확인 후)
            const brandIdField = document.getElementById('brand-id');
            const brandCodeField = document.getElementById('brand-code');
            const brandNameKrField = document.getElementById('brand-name-kr');
            const brandNameJpField = document.getElementById('brand-name-jp');
            const brandDescriptionField = document.getElementById('brand-description');
            const brandPriorityField = document.getElementById('brand-priority');
            const brandStatusField = document.getElementById('brand-status');
            const brandCurrentUrlField = document.getElementById('brand-current-url');
            const brandLogoCurrentUrlField = document.getElementById('brand-logo-current-url');
            
            if (brandIdField) brandIdField.value = brand.id;
            if (brandCodeField) brandCodeField.value = brand.code || '';
            if (brandNameKrField) brandNameKrField.value = brand.nameEn || '';
            if (brandNameJpField) brandNameJpField.value = brand.nameJp || '';
            if (brandDescriptionField) brandDescriptionField.value = brand.description || '';
            if (brandPriorityField) brandPriorityField.value = brand.priority || 50;
            if (brandStatusField) brandStatusField.value = brand.status || 'active';
            if (brandCurrentUrlField) brandCurrentUrlField.value = brand.logoUrl || '';
            if (brandLogoCurrentUrlField) brandLogoCurrentUrlField.value = brand.brandLogoUrl || '';
            
            // バッジ情報を設定 (필드 존재 확인 후)
            const badgeTypeField = document.getElementById('brand-badge-type');
            const badgeColorField = document.getElementById('brand-badge-color');
            const badgeTextField = document.getElementById('brand-badge-text');
            const badgeStartField = document.getElementById('brand-badge-start');
            const badgeEndField = document.getElementById('brand-badge-end');
            
            if (badgeTypeField) badgeTypeField.value = brand.badgeType || '';
            if (badgeColorField) badgeColorField.value = brand.badgeColor || 'red';
            if (badgeTextField) badgeTextField.value = brand.badgeText || '';
            if (badgeStartField) badgeStartField.value = brand.badgeStartDate || '';
            if (badgeEndField) badgeEndField.value = brand.badgeEndDate || '';
            
            // バッジ設定を更新
            if (typeof updateBadgeSettings === 'function') {
                setTimeout(() => {
                    updateBadgeSettings();
                }, 100);
            }
            
            // 既存ブランド大代表画像のプレビュー
            if (brand.logoUrl) {
                const preview = document.getElementById('brand-image-preview');
                const placeholder = document.getElementById('brand-upload-placeholder');
                const previewImg = document.getElementById('brand-preview-img');
                
                console.log('🖼️ 브랜드 대표이미지 미리보기 설정:', brand.logoUrl);
                console.log('🔍 요소 확인:', {
                    preview: !!preview,
                    placeholder: !!placeholder,
                    previewImg: !!previewImg
                });
                
                if (previewImg) {
                previewImg.src = brand.logoUrl;
                }
                if (preview) {
                preview.style.display = 'block';
                }
                if (placeholder) {
                placeholder.style.display = 'none';
                }
            } else {
                // 이미지가 없는 경우 플레이스홀더 표시
                const preview = document.getElementById('brand-image-preview');
                const placeholder = document.getElementById('brand-upload-placeholder');
                
                if (preview) {
                    preview.style.display = 'none';
                }
                if (placeholder) {
                    placeholder.style.display = 'block';
                }
            }
            
            // 既存ブランドロゴのプレビュー
            if (brand.brandLogoUrl) {
                const logoPreview = document.getElementById('brand-logo-preview');
                const logoPlaceholder = document.getElementById('brand-logo-upload-placeholder');
                const logoPreviewImg = document.getElementById('brand-logo-preview-img');
                
                console.log('🏷️ 브랜드 로고 미리보기 설정:', brand.brandLogoUrl);
                console.log('🔍 요소 확인:', {
                    logoPreview: !!logoPreview,
                    logoPlaceholder: !!logoPlaceholder,
                    logoPreviewImg: !!logoPreviewImg
                });
                
                if (logoPreviewImg) {
                logoPreviewImg.src = brand.brandLogoUrl;
                }
                if (logoPreview) {
                logoPreview.style.display = 'block';
                }
                if (logoPlaceholder) {
                logoPlaceholder.style.display = 'none';
                }
            } else {
                // 로고가 없는 경우 플레이스홀더 표시
                const logoPreview = document.getElementById('brand-logo-preview');
                const logoPlaceholder = document.getElementById('brand-logo-upload-placeholder');
                
                if (logoPreview) {
                    logoPreview.style.display = 'none';
                }
                if (logoPlaceholder) {
                    logoPlaceholder.style.display = 'block';
                }
            }
            
            // モーダルを開く (static backdrop 설정)
            const modalElement = document.getElementById('brandModal');
            const modal = new bootstrap.Modal(modalElement, {
                backdrop: 'static',
                keyboard: false
            });
            modal.show();
        }

        // 브랜드 삭제 함수
        function deleteBrand(brandId, brandName) {
            // 확인 대화상자 표시
            if (confirm(`"${brandName}" 브랜드를 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.`)) {
                console.log('🗑️ 브랜드 삭제 시작:', brandId, brandName);
                console.log('🔍 삭제 전 allBrands 개수:', allBrands.length);
                console.log('🔍 삭제 전 filteredBrands 개수:', filteredBrands.length);
                
                // Firebase에서 브랜드 삭제
                if (typeof FirebaseService !== 'undefined' && FirebaseService.isFirebaseAvailable()) {
                    FirebaseService.deleteBrand(brandId)
                        .then(result => {
                            console.log('🔥 FirebaseService.deleteBrand 결과:', result);
                            if (result.success) {
                                console.log('✅ 브랜드 삭제 성공:', brandId);
                                showAlert(`"${brandName}" 브랜드가 성공적으로 삭제되었습니다.`, 'success');
                                
                                // 로컬 배열에서도 제거
                                const beforeAllBrands = allBrands.length;
                                const beforeFilteredBrands = filteredBrands.length;
                                
                                allBrands = allBrands.filter(brand => brand.id !== brandId);
                                filteredBrands = filteredBrands.filter(brand => brand.id !== brandId);
                                
                                console.log('🔍 삭제 후 allBrands 개수:', allBrands.length, `(${beforeAllBrands} → ${allBrands.length})`);
                                console.log('🔍 삭제 후 filteredBrands 개수:', filteredBrands.length, `(${beforeFilteredBrands} → ${filteredBrands.length})`);
                                
                               // 브랜드 목록 다시 렌더링
                               displayBrands();
                                
                                // 통계 업데이트
                                updateBrandStats();
                                
                                // 삭제 확인을 위해 잠시 후 Firebase에서 다시 조회
                                setTimeout(async () => {
                                    try {
                                        const db = firebase.firestore();
                                        const doc = await db.collection('brands').doc(brandId).get();
                                        console.log('🔍 삭제 확인 - Firebase 문서 존재 여부:', doc.exists);
                                        if (doc.exists) {
                                            console.warn('⚠️ 경고: Firebase에서 브랜드가 삭제되지 않았습니다!');
                                        } else {
                                            console.log('✅ 확인: Firebase에서 브랜드가 성공적으로 삭제되었습니다.');
                                        }
                                    } catch (error) {
                                        console.error('❌ 삭제 확인 중 오류:', error);
                                    }
                                }, 1000);
                            } else {
                                console.error('❌ 브랜드 삭제 실패:', result.error);
                                showAlert(`브랜드 삭제에 실패했습니다: ${result.error}`, 'danger');
                            }
                        })
                        .catch(error => {
                            console.error('❌ 브랜드 삭제 중 오류:', error);
                            showAlert(`브랜드 삭제 중 오류가 발생했습니다: ${error.message}`, 'danger');
                        });
                } else {
                    console.error('❌ Firebase 사용 불가');
                    showAlert('Firebase 연결이 필요합니다. 페이지를 새로고침해주세요.', 'danger');
                }
            }
        }

        // 브랜드 검색 및 필터링
        function filterBrands() {
                    const brandSearchElement = document.getElementById('brand-search');
        const brandStatusFilterElement = document.getElementById('brand-status-filter');
        const searchTerm = brandSearchElement ? brandSearchElement.value.toLowerCase() : '';
        const statusFilter = brandStatusFilterElement ? brandStatusFilterElement.value : '';
            
            filteredBrands = allBrands.filter(brand => {
                // 검색어 필터링
                const matchesSearch = !searchTerm || 
                    (brand.nameKr && brand.nameKr.toLowerCase().includes(searchTerm)) ||
                    (brand.nameJp && brand.nameJp.toLowerCase().includes(searchTerm)) ||
                    (brand.code && brand.code.toLowerCase().includes(searchTerm)) ||
                    (brand.description && brand.description.toLowerCase().includes(searchTerm));
                
                // 상태 필터링
                const matchesStatus = !statusFilter || brand.status === statusFilter;
                
                return matchesSearch && matchesStatus;
            });
            
            // 우선순위 순으로 정렬 유지
            filteredBrands.sort((a, b) => {
                if (b.priority !== a.priority) {
                    return b.priority - a.priority;  // 우선순위 높은 순
                }
                return (a.nameKr || '').localeCompare(b.nameKr || '');  // 같은 우선순위면 알파벳 순
            });
            
            displayBrands();
            updateBrandStats();
        }

        function clearBrandFilters() {
            const searchInput = document.getElementById('brand-search');
            const statusFilter = document.getElementById('brand-status-filter');
            
            if (searchInput) searchInput.value = '';
            if (statusFilter) statusFilter.value = '';
            
            filteredBrands = [...allBrands];
            displayBrands();
        }

        // 상품 관리 시스템 (브랜드용 변수와 별도)
        let allProductsList = [];
        let filteredProductsList = [];
        let productOptionCounter = 0; // 옵션 추가 카운터

        // 상품 추가모ーダル表示
        window.showAddProductModal = async function() {
            try {
                console.log('🔄 상품 추가 모달 열기 시작...');
                console.log('현재 DOM 상태:', document.readyState);
                console.log('Bootstrap 사용 가능:', typeof bootstrap !== 'undefined');
                
                // 모달 요소 확인
                const modalElement = document.getElementById('productModal');
                console.log('모달 요소:', modalElement);
                if (!modalElement) {
                    console.error('❌ 상품 모달 요소를 찾을 수 없습니다');
                    showAlert('상품 모달을 찾을 수 없습니다.', 'danger');
                    return;
                }
                
                console.log('Bootstrap Modal 생성 시도...');
                const modal = new bootstrap.Modal(modalElement, {
                    backdrop: 'static',  // 배경 클릭으로 닫히지 않음
                    keyboard: false      // ESC 키로 닫히지 않음
                });
                console.log('Bootstrap Modal 생성 완료:', modal);
            
                // 폼 초기화
                console.log('폼 초기화 시작...');
                const form = document.getElementById('productForm');
                console.log('폼 요소:', form);
                if (form) {
                    form.reset();
                    console.log('폼 리셋 완료');
                }
                
                // 옵션 카운터 리셋
                productOptionCounter = 0;
                console.log('옵션 카운터 리셋:', productOptionCounter);
                
                const productIdField = document.getElementById('product-id');
                console.log('상품 ID 필드:', productIdField);
                if (productIdField) {
                    productIdField.value = '';
                }
                
                const modalLabel = document.getElementById('productModalLabel');
                console.log('모달 라벨:', modalLabel);
                if (modalLabel) {
                    modalLabel.textContent = '新しい商品を追加';
                }
            
                // 우선순위 기본값 설정
                const priorityField = document.getElementById('product-priority');
                console.log('우선순위 필드:', priorityField);
                if (priorityField) {
                    priorityField.value = '50';
                }
                
                // 모든 이미지 미리보기 초기화
                console.log('이미지 미리보기 초기화...');
                if (typeof clearAllProductImagePreviews === 'function') {
                clearAllProductImagePreviews();
                } else {
                    console.warn('clearAllProductImagePreviews 함수를 찾을 수 없습니다');
                }
            
            // 브랜드 데이터가 로드되지 않았다면 로드
                console.log('브랜드 데이터 확인...');
                if (typeof window.allBrands === 'undefined' || !window.allBrands || window.allBrands.length === 0) {
                console.log('🔄 브랜드 데이터 로드 중...');
                await loadBrands();
                } else {
                    console.log('브랜드 데이터 이미 로드됨:', window.allBrands.length, '개');
            }
            
                // 브랜드 선택肢 업데이트
                console.log('브랜드 선택肢 업데이트...');
                if (typeof updateBrandOptions === 'function') {
            updateBrandOptions();
                } else {
                    console.warn('updateBrandOptions 함수를 찾을 수 없습니다');
                }
            
                // 모달 표시
                console.log('모달 표시 시도...');
            modal.show();
                console.log('✅ 상품 추가 모달 열기 완료');
                
                // 모달이 완전히 표시된 후 뱃지 날짜 필드 생성
                setTimeout(() => {
                    console.log('🔍 새 상품 모달 표시 후 뱃지 날짜 필드 생성...');
                    createBadgeDateFields();
                }, 500);
                
            } catch (error) {
                console.error('❌ 상품 추가 모달 열기 오류:', error);
                showAlert('상품 추가 모달을 열 수 없습니다: ' + error.message, 'danger');
            }
        }

        // ブランド選択肢更新
        function updateBrandOptions() {
            const brandSelect = document.getElementById('product-brand');
            if (!brandSelect) {
                console.error('product-brand select 요소를 찾을 수 없습니다');
                return;
            }
            
            console.log('🔍 브랜드 옵션 업데이트 시작');
            console.log('🔍 window.allBrands 상태:', {
                exists: typeof window.allBrands !== 'undefined',
                length: window.allBrands ? window.allBrands.length : 0,
                data: window.allBrands
            });
            
            brandSelect.innerHTML = '<option value="">ブランドを選択</option>';
            
            if (typeof window.allBrands === 'undefined' || !window.allBrands || window.allBrands.length === 0) {
                console.warn('⚠️ 브랜드 데이터가 없습니다');
                brandSelect.innerHTML = '<option value="">ブランドデータ를 로드 중...</option>';
                return;
            }
            
            window.allBrands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand.code;
                option.textContent = brand.nameEn || brand.nameJp || brand.code;
                brandSelect.appendChild(option);
            });
            
            console.log('✅ 브랜드 옵션 업데이트 완료:', window.allBrands.length, '개');
        }

        // 編集用ブランド選択肢更新（既存の選択を保持）
        function updateBrandOptionsForEdit(selectedBrandCode) {
            const brandSelect = document.getElementById('product-brand');
            if (!brandSelect) {
                console.error('product-brand select 요소를 찾을 수 없습니다');
                return;
            }
            
            brandSelect.innerHTML = '<option value="">ブランドを選択</option>';
            
            if (typeof window.allBrands === 'undefined' || !window.allBrands || window.allBrands.length === 0) {
                console.warn('⚠️ 브랜드 데이터가 없습니다');
                brandSelect.innerHTML = '<option value="">ブランドデータをロード中...</option>';
                return;
            }
            
            window.allBrands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand.code;
                option.textContent = brand.nameEn || brand.nameJp || brand.code;
                if (brand.code === selectedBrandCode) {
                    option.selected = true;
                }
                brandSelect.appendChild(option);
            });
            
            console.log('✅ 편집용 브랜드 옵션 업데이트 완료:', window.allBrands.length, '개, 선택된 브랜드:', selectedBrandCode);
        }

        // 商品画像プレビュー機能
        function previewProductImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                processProductImageFile(file);
            }
        }

        // 商品画像ファイル処理
        function processProductImageFile(file) {
            // ファイルサイズチェック (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showAlert('ファイルサイズが5MBを超えています。', 'danger');
                return;
            }
            
            // ファイルタイプチェック
            if (!file.type.startsWith('image/')) {
                showAlert('画像ファイルのみアップロード可能です。', 'danger');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('product-image-preview');
                const placeholder = document.getElementById('product-upload-placeholder');
                const previewImg = document.getElementById('product-preview-img');
                
                previewImg.src = e.target.result;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
            
            // ファイル input에 파일 설정
            const fileInput = document.getElementById('product-image');
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
        }

        // 商品画像ドラッグ&ドロップ機能
        function handleProductImageDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const dropZone = document.getElementById('product-image-drop-zone');
            dropZone.classList.remove('drag-over');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                processProductImageFile(file);
            }
        }

        function handleProductImageDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const dropZone = event.currentTarget;
            dropZone.classList.add('drag-over');
        }

        function handleProductImageDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const dropZone = event.currentTarget;
            dropZone.classList.remove('drag-over');
        }

        // 追加画像1のドラッグ&ドロップ機能
        function handleProductImage1Drop(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const dropZone = document.getElementById('product-image-1-drop-zone');
            dropZone.classList.remove('drag-over');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                processProductImage1File(file);
            }
        }

        function processProductImage1File(file) {
            if (file.size > 5 * 1024 * 1024) {
                showAlert('ファイルサイズが5MBを超えています。', 'danger');
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                showAlert('画像ファイルのみアップロード可能です。', 'danger');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('product-image-1-preview');
                const placeholder = document.getElementById('product-upload-placeholder-1');
                const previewImg = document.getElementById('product-preview-img-1');
                
                previewImg.src = e.target.result;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
            
            const fileInput = document.getElementById('product-image-1');
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
        }

        function previewProductImage1(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                processProductImage1File(file);
            }
        }

        // 追加画像2のドラッグ&ドロップ機能
        function handleProductImage2Drop(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const dropZone = document.getElementById('product-image-2-drop-zone');
            dropZone.classList.remove('drag-over');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                processProductImage2File(file);
            }
        }

        function processProductImage2File(file) {
            if (file.size > 5 * 1024 * 1024) {
                showAlert('ファイルサイズが5MBを超えています。', 'danger');
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                showAlert('画像ファイルのみアップロード可能です。', 'danger');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('product-image-2-preview');
                const placeholder = document.getElementById('product-upload-placeholder-2');
                const previewImg = document.getElementById('product-preview-img-2');
                
                previewImg.src = e.target.result;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
            
            const fileInput = document.getElementById('product-image-2');
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
        }

        function previewProductImage2(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                processProductImage2File(file);
            }
        }

        // 追加画像3のドラッグ&ドロップ機能
        function handleProductImage3Drop(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const dropZone = document.getElementById('product-image-3-drop-zone');
            dropZone.classList.remove('drag-over');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                processProductImage3File(file);
            }
        }

        function processProductImage3File(file) {
            if (file.size > 5 * 1024 * 1024) {
                showAlert('ファイルサイズが5MBを超えています。', 'danger');
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                showAlert('画像ファイルのみアップロード可能です。', 'danger');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('product-image-3-preview');
                const placeholder = document.getElementById('product-upload-placeholder-3');
                const previewImg = document.getElementById('product-preview-img-3');
                
                previewImg.src = e.target.result;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
            
            const fileInput = document.getElementById('product-image-3');
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
        }

        function previewProductImage3(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                processProductImage3File(file);
            }
        }

        // 商品詳細画像のドラッグ&ドロップ機能
        function handleProductDetailImageDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const dropZone = document.getElementById('product-detail-image-drop-zone');
            dropZone.classList.remove('drag-over');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                processProductDetailImageFile(file);
            }
        }

        function processProductDetailImageFile(file) {
            if (file.size > 15 * 1024 * 1024) {
                showAlert('ファイルサイズが15MBを超えています。', 'danger');
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                showAlert('画像ファイルのみアップロード可能です。', 'danger');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('product-detail-image-preview');
                const placeholder = document.getElementById('product-detail-upload-placeholder');
                const previewImg = document.getElementById('product-detail-preview-img');
                
                previewImg.src = e.target.result;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
            
            const fileInput = document.getElementById('product-detail-image');
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
        }

        function previewProductDetailImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                processProductDetailImageFile(file);
            }
        }

        // 商品保存機能
        async function saveProduct() {
            try {
                const form = document.getElementById('productForm');
                const formData = new FormData(form);
                const productId = document.getElementById('product-id').value;
                
                // フィールドの取得
                const code = formData.get('code')?.trim() || '';
                const nameEn = formData.get('nameEn')?.trim() || '';
                const nameJp = formData.get('nameJp')?.trim() || '';
                const brandCode = formData.get('brandCode') || '';
                const price = parseInt(formData.get('price')) || 0;
                const salePrice = parseInt(formData.get('salePrice')) || 0;
                const stock = parseInt(formData.get('stock')) || 0;
                
                // 상품 타입 확인
                const productType = document.querySelector('input[name="productType"]:checked')?.value || 'simple';
                console.log('상품 타입:', productType);
                
                // 옵션 데이터 수집
                let productOptions = [];
                if (productType === 'option') {
                    productOptions = collectProductOptions();
                    console.log('수집된 옵션 데이터:', productOptions);
                }
                
                showAlert('商品を保存中です...', 'info');
                
                // 기존 이미지 데이터 보존 (편집 모드에서 중요!)
                let imageUrl = document.getElementById('product-current-url').value;
                let imagePath = '';
                
                // 기존 추가 이미지 데이터 보존 (정확히 3개 슬롯 관리)
                let additionalImages = ['', '', '']; // 3개 슬롯 고정
                const existingAdditionalImages = document.getElementById('product-current-additional-images')?.value;
                if (existingAdditionalImages) {
                    try {
                        const parsedImages = JSON.parse(existingAdditionalImages);
                        console.log('✅ 기존 추가 이미지 데이터 발견:', parsedImages);
                        
                        // 기존 데이터를 3개 슬롯에 맞게 정리
                        for (let i = 0; i < 3; i++) {
                            if (parsedImages[i]) {
                                additionalImages[i] = parsedImages[i];
                            }
                        }
                        console.log('✅ 정리된 추가 이미지 데이터:', additionalImages);
                    } catch (e) {
                        console.log('⚠️ 기존 추가 이미지 데이터 파싱 실패, 빈 배열로 시작');
                        additionalImages = ['', '', ''];
                    }
                }
                
                // 기존 상세 이미지 데이터 보존
                let detailImageUrl = document.getElementById('product-current-detail-image-url')?.value || '';
                if (detailImageUrl) {
                    console.log('✅ 기존 상세 이미지 데이터 보존:', detailImageUrl);
                }
                
                // メイン画像がアップロードされている場合
                const imageFile = document.getElementById('product-image').files[0];
                if (imageFile) {
                    // 기존 메인 이미지가 있으면 Firebase Storage에서 삭제
                    const currentImageUrl = document.getElementById('product-current-url').value;
                    if (currentImageUrl && currentImageUrl.includes('firebasestorage.googleapis.com')) {
                        try {
                            console.log('🗑️ 기존 메인 이미지 삭제 시도:', currentImageUrl);
                            const storage = firebase.storage();
                            const oldImageRef = storage.refFromURL(currentImageUrl);
                            await oldImageRef.delete();
                            console.log('✅ 기존 메인 이미지 삭제 완료');
                        } catch (error) {
                            console.error('❌ 기존 메인 이미지 삭제 실패:', error);
                            // 삭제 실패해도 새 이미지 업로드는 계속 진행
                        }
                    }
                    
                    const uploadResult = await uploadImageToFirebase(imageFile, code);
                    if (uploadResult.success) {
                        imageUrl = uploadResult.url;
                        imagePath = uploadResult.path;
                    } else {
                        showAlert('メイン画像のアップロードに失敗しました。', 'danger');
                        return;
                    }
                }
                
                // 追加画像1がアップロードされている場合
                const imageFile1 = document.getElementById('product-image-1').files[0];
                if (imageFile1) {
                    try {
                        // 기존 추가 이미지 1이 있으면 Firebase Storage에서 삭제
                        if (additionalImages[0] && additionalImages[0].includes('firebasestorage.googleapis.com')) {
                            try {
                                console.log('🗑️ 기존 추가 이미지 1 삭제 시도:', additionalImages[0]);
                                const storage = firebase.storage();
                                const oldImageRef = storage.refFromURL(additionalImages[0]);
                                await oldImageRef.delete();
                                console.log('✅ 기존 추가 이미지 1 삭제 완료');
                            } catch (error) {
                                console.error('❌ 기존 추가 이미지 1 삭제 실패:', error);
                            }
                        }
                        
                    const uploadResult = await uploadImageToFirebase(imageFile1, `${code}_1`);
                    if (uploadResult.success) {
                            // 첫 번째 슬롯에 직접 할당
                            additionalImages[0] = uploadResult.url;
                            console.log('✅ 추가 이미지 1 업로드 성공:', uploadResult.url);
                    } else {
                            console.log('⚠️ 추가 이미지 1 업로드 실패, 기존 데이터 유지');
                        }
                    } catch (error) {
                        console.log('⚠️ 추가 이미지 1 업로드 오류, 기존 데이터 유지:', error);
                    }
                }
                
                // 追加画像2がアップロードされている場合
                const imageFile2 = document.getElementById('product-image-2').files[0];
                if (imageFile2) {
                    try {
                        // 기존 추가 이미지 2가 있으면 Firebase Storage에서 삭제
                        if (additionalImages[1] && additionalImages[1].includes('firebasestorage.googleapis.com')) {
                            try {
                                console.log('🗑️ 기존 추가 이미지 2 삭제 시도:', additionalImages[1]);
                                const storage = firebase.storage();
                                const oldImageRef = storage.refFromURL(additionalImages[1]);
                                await oldImageRef.delete();
                                console.log('✅ 기존 추가 이미지 2 삭제 완료');
                            } catch (error) {
                                console.error('❌ 기존 추가 이미지 2 삭제 실패:', error);
                            }
                        }
                        
                    const uploadResult = await uploadImageToFirebase(imageFile2, `${code}_2`);
                    if (uploadResult.success) {
                            // 두 번째 슬롯에 직접 할당
                            additionalImages[1] = uploadResult.url;
                            console.log('✅ 추가 이미지 2 업로드 성공:', uploadResult.url);
                    } else {
                            console.log('⚠️ 추가 이미지 2 업로드 실패, 기존 데이터 유지');
                        }
                    } catch (error) {
                        console.log('⚠️ 추가 이미지 2 업로드 오류, 기존 데이터 유지:', error);
                    }
                }
                
                // 追加画像3がアップロードされている場合
                const imageFile3 = document.getElementById('product-image-3').files[0];
                if (imageFile3) {
                    try {
                        // 기존 추가 이미지 3이 있으면 Firebase Storage에서 삭제
                        if (additionalImages[2] && additionalImages[2].includes('firebasestorage.googleapis.com')) {
                            try {
                                console.log('🗑️ 기존 추가 이미지 3 삭제 시도:', additionalImages[2]);
                                const storage = firebase.storage();
                                const oldImageRef = storage.refFromURL(additionalImages[2]);
                                await oldImageRef.delete();
                                console.log('✅ 기존 추가 이미지 3 삭제 완료');
                            } catch (error) {
                                console.error('❌ 기존 추가 이미지 3 삭제 실패:', error);
                            }
                        }
                        
                    const uploadResult = await uploadImageToFirebase(imageFile3, `${code}_3`);
                    if (uploadResult.success) {
                            // 세 번째 슬롯에 직접 할당
                            additionalImages[2] = uploadResult.url;
                            console.log('✅ 추가 이미지 3 업로드 성공:', uploadResult.url);
                    } else {
                            console.log('⚠️ 추가 이미지 3 업로드 실패, 기존 데이터 유지');
                        }
                    } catch (error) {
                        console.log('⚠️ 추가 이미지 3 업로드 오류, 기존 데이터 유지:', error);
                    }
                }
                
                // 詳細画像がアップロードされている場合
                const detailImageFile = document.getElementById('product-detail-image').files[0];
                if (detailImageFile) {
                    try {
                        // 기존 상세 이미지가 있으면 Firebase Storage에서 삭제
                        if (detailImageUrl && detailImageUrl.includes('firebasestorage.googleapis.com')) {
                            try {
                                console.log('🗑️ 기존 상세 이미지 삭제 시도:', detailImageUrl);
                                const storage = firebase.storage();
                                const oldImageRef = storage.refFromURL(detailImageUrl);
                                await oldImageRef.delete();
                                console.log('✅ 기존 상세 이미지 삭제 완료');
                            } catch (error) {
                                console.error('❌ 기존 상세 이미지 삭제 실패:', error);
                            }
                        }
                        
                    const uploadResult = await uploadImageToFirebase(detailImageFile, `${code}_detail`);
                    if (uploadResult.success) {
                        detailImageUrl = uploadResult.url;
                            console.log('✅ 상세 이미지 업로드 성공');
                    } else {
                            console.log('⚠️ 상세 이미지 업로드 실패, 기존 데이터 유지');
                        }
                    } catch (error) {
                        console.log('⚠️ 상세 이미지 업로드 오류, 기존 데이터 유지:', error);
                    }
                }
                
                // ブランド情報を取得
                console.log('🔍 브랜드 찾기 시도:', {
                    brandCode: brandCode,
                    allBrandsLength: allBrands ? allBrands.length : 0,
                    allBrands: allBrands
                });
                
                const brand = allBrands.find(b => b.code === brandCode);
                console.log('🔍 찾은 브랜드:', brand);
                
                if (!brand) {
                    console.warn('⚠️ 브랜드를 찾을 수 없음:', brandCode);
                    console.log('🔍 사용 가능한 브랜드 코드들:', allBrands.map(b => b.code));
                }
                
                // 빈 이미지 슬롯 정리 (빈 문자열 제거)
                const cleanedAdditionalImages = additionalImages.filter(img => img && img.trim() !== '');
                
                // 商品データの準備
                console.log('🔍 상품 저장 데이터 확인:', {
                    code: code,
                    nameEn: nameEn,
                    nameJp: nameJp,
                    brandCode: brandCode,
                    imageUrl: imageUrl,
                    additionalImages: cleanedAdditionalImages,
                    detailImageUrl: detailImageUrl
                });
                
                const productData = {
                    code: code,
                    nameEn: nameEn, // 영어명 필드
                    nameJp: nameJp, // 일본어명 필드 (영어명으로 대체하지 않음)
                    brandCode: brandCode,
                    brandName: brand ? (brand.nameEn || brand.nameJp || brand.nameKr || brandCode) : brandCode,
                    category: formData.get('category') || '',
                    price: price,
                    salePrice: salePrice,
                    originalPrice: parseInt(formData.get('originalPrice')) || null,
                    stock: stock,
                    status: formData.get('status') || 'active',
                    priority: parseInt(formData.get('priority')) || 50,
                    imageUrl: imageUrl,
                    imagePath: imagePath,
                    additionalImages: cleanedAdditionalImages,
                    detailImageUrl: detailImageUrl,
                    capacity: formData.get('capacity') || '',
                    // 상품 배지 정보 추가 (안전한 접근)
                    badgeType: document.getElementById('product-badge-type')?.value || '',
                    badgeColor: document.getElementById('product-badge-color')?.value || '',
                    badgeText: document.getElementById('product-badge-text')?.value || '',
                    badgeStartDate: document.getElementById('product-badge-start')?.value || '',
                    badgeEndDate: document.getElementById('product-badge-end')?.value || '',
                    // 새로운 상품 타입 시스템
                    productType: productType,
                    productOptions: productOptions,
                    // 기존 색상 옵션 (호환성을 위해 유지)
                    colorOptions: [],
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (!productId) {
                    // 新規追加
                    productData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                }
                
                // Firestoreに保存
                const db = firebase.firestore();
                if (productId) {
                    // 更新
                    await db.collection('products').doc(productId).update(productData);
                    console.log('✅ 상품 업데이트 완료, 문서 ID:', productId);
                    console.log('🔍 최종 업데이트된 이미지 데이터:', {
                        imageUrl: productData.imageUrl,
                        additionalImages: productData.additionalImages,
                        detailImageUrl: productData.detailImageUrl
                    });
                    showAlert('商品が更新されました！', 'success');
                } else {
                    // 新規追加 - 상품명을 기반으로 문서 ID 생성
                    let productDocId = '';
                    
                    // 1차 시도: 영어명 사용
                    if (productData.nameEn && productData.nameEn.trim()) {
                        productDocId = productData.nameEn.toLowerCase()
                            .replace(/\s+/g, '-')
                            .replace(/[^a-z0-9-]/g, '')
                            .substring(0, 50);
                    }
                    
                    // 2차 시도: 일본어명 사용
                    if (!productDocId && productData.nameJp && productData.nameJp.trim()) {
                        productDocId = productData.nameJp.toLowerCase()
                            .replace(/\s+/g, '-')
                            .replace(/[^a-z0-9-]/g, '')
                            .substring(0, 50);
                    }
                    
                    // 4차 시도: 코드 사용
                    if (!productDocId && productData.code && productData.code.trim()) {
                        productDocId = productData.code.toLowerCase()
                            .replace(/\s+/g, '-')
                            .replace(/[^a-z0-9-]/g, '')
                            .substring(0, 50);
                    }
                    
                    // 5차 시도: 타임스탬프 기반 ID 생성
                    if (!productDocId) {
                        productDocId = `product-${Date.now()}`;
                    }
                    
                    console.log('🔍 상품 ID 생성 디버깅:', {
                        '원본 nameJp': productData.nameJp,
                        '원본 nameKr': productData.nameKr,
                        '원본 nameEn': productData.nameEn,
                        '원본 code': productData.code,
                        '생성된 productDocId': productDocId,
                        'productData': productData
                    });
                    
                    await db.collection('products').doc(productDocId).set(productData);
                    console.log('✅ 상품 저장 완료, 문서 ID:', productDocId);
                    console.log('🔍 최종 저장된 이미지 데이터:', {
                        imageUrl: productData.imageUrl,
                        additionalImages: productData.additionalImages,
                        detailImageUrl: productData.detailImageUrl
                    });
                    showAlert(`新しい商品が追加されました！ (ID: ${productDocId})`, 'success');
                }
                
                // モーダルを閉じる
                const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
                modal.hide();
                
                // 商品リストを再読込
                await loadProducts();
                
            } catch (error) {
                console.error('❌ 商品保存エラー:', error);
                showAlert(`商品の保存に失敗しました: ${error.message}`, 'danger');
            }
        }

        // 商品編集機能
        function editProduct(productId) {
            console.log('🔧 상품 편집 함수 호출:', productId);
            console.log('현재 상품 데이터:', allProductsList);
            
            // 여러 위치에서 상품 찾기 시도
            let product = null;
            
            // 1. allProductsList에서 찾기
            if (allProductsList && allProductsList.length > 0) {
                product = allProductsList.find(p => p.id === productId);
                console.log('allProductsList에서 찾기 시도:', product);
            }
            
            // 2. window.allProductsList에서 찾기
            if (!product && window.allProductsList && window.allProductsList.length > 0) {
                product = window.allProductsList.find(p => p.id === productId);
                console.log('window.allProductsList에서 찾기 시도:', product);
            }
            
            // 3. window.allProducts에서 찾기
            if (!product && window.allProducts && window.allProducts.length > 0) {
                product = window.allProducts.find(p => p.id === productId);
                console.log('window.allProducts에서 찾기 시도:', product);
            }
            
            if (!product) {
                console.error('❌ 상품을 찾을 수 없습니다:', productId);
                console.error('사용 가능한 상품 ID들:', {
                    allProductsList: allProductsList?.map(p => p.id) || [],
                    windowAllProductsList: window.allProductsList?.map(p => p.id) || [],
                    windowAllProducts: window.allProducts?.map(p => p.id) || []
                });
                showAlert('商品が見つかりません。', 'danger');
                return;
            }
            
            // 통합 모달로 편집 모드 열기
            openProductEditModal(product);
        }

        // 이미지 미리보기 강제 표시 함수
        function forceShowImagePreview(imageUrl) {
            console.log('🔧 이미지 미리보기 강제 표시 함수 호출:', imageUrl);
            
            const previewImg = document.getElementById('product-preview-img');
            const preview = document.getElementById('product-image-preview');
            const placeholder = document.getElementById('product-upload-placeholder');
            
            if (!previewImg || !preview || !placeholder) {
                console.error('❌ 이미지 미리보기 요소를 찾을 수 없습니다');
                return;
            }
            
            // 1단계: 컨테이너 표시
            preview.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 1000 !important;';
            placeholder.style.cssText = 'display: none !important; visibility: hidden !important;';
            
            // 2단계: 이미지 설정
            previewImg.src = imageUrl;
            previewImg.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; max-width: 100% !important; max-height: 200px !important; width: auto !important; height: auto !important;';
            
            // 3단계: 이미지 로드 완료 후 재확인
            previewImg.onload = function() {
                console.log('✅ 이미지 로드 완료, 최종 확인');
                
                // 최종 강제 표시
                preview.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 1000 !important;';
                previewImg.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; max-width: 100% !important; max-height: 200px !important; width: auto !important; height: auto !important;';
                
                console.log('🔍 최종 상태 확인:', {
                    previewDisplay: preview.style.display,
                    previewVisibility: preview.style.visibility,
                    imgDisplay: previewImg.style.display,
                    imgVisibility: previewImg.style.visibility,
                    imgSrc: previewImg.src,
                    imgNaturalWidth: previewImg.naturalWidth,
                    imgNaturalHeight: previewImg.naturalHeight
                });
            };
            
            previewImg.onerror = function() {
                console.error('❌ 이미지 로드 실패:', imageUrl);
                preview.style.display = 'none';
                placeholder.style.display = 'block';
            };
        }

        // 상품 편집 모달 열기 함수 (통합 모달 사용)
        function openProductEditModal(product) {
            console.log('🔧 상품 편집 모달 열기 (통합 모달):', product);
            
            // 통합 모달 열기
            const modalElement = document.getElementById('productModal');
            if (!modalElement) {
                console.error('❌ 상품 모달 요소를 찾을 수 없습니다');
                showAlert('상품 모달을 찾을 수 없습니다.', 'danger');
                return;
            }
            
            // Bootstrap Modal 생성
            const modal = new bootstrap.Modal(modalElement);
            
            // 모달 제목 변경
            const modalLabel = document.getElementById('productModalLabel');
            if (modalLabel) {
                modalLabel.textContent = '商品を編集';
            }
            
            // 폼 초기화 (편집 모드에서는 이미지 미리보기는 유지)
            const form = document.getElementById('productForm');
            if (form) {
                // 편집 모드에서는 이미지 미리보기를 유지하기 위해 폼 리셋을 건너뜀
                // form.reset(); // 이미지 미리보기 유지를 위해 주석 처리
            }
            
            // 옵션 카운터 리셋
            productOptionCounter = 0;
            
            // 상품 ID 설정
            const productIdField = document.getElementById('product-id');
            if (productIdField) {
                productIdField.value = product.id;
            }
            
            // 브랜드 옵션 업데이트 (편집용)
            updateBrandOptionsForEdit(product.brandCode);
            
            // 상품 데이터로 폼 채우기
            fillProductForm(product);
            
            // 모달 표시
            modal.show();
            
            // 모달이 완전히 표시된 후 뱃지 날짜 필드 생성 및 이미지 미리보기 재설정
            setTimeout(() => {
                console.log('🔍 편집 모달 표시 후 뱃지 날짜 필드 생성...');
                createBadgeDateFields();
                
                // 이미지 미리보기 재설정 (모달 표시 후)
                console.log('🔍 편집 모달에서 이미지 미리보기 재설정...');
                fillProductForm(product);
                
                // 추가: 이미지 미리보기 강제 표시
                if (product.imageUrl) {
                    setTimeout(() => {
                        console.log('🔧 이미지 미리보기 강제 표시 시작...');
                        forceShowImagePreview(product.imageUrl);
                        
                        // 추가 이미지들도 강제 표시
                        if (product.additionalImages && Array.isArray(product.additionalImages) && product.additionalImages.length > 0) {
                            console.log('🔧 추가 이미지들 강제 표시 시작:', product.additionalImages);
                            
                            // 추가 이미지 1 강제 표시
                            if (product.additionalImages[0]) {
                                const previewImg1 = document.getElementById('product-preview-img-1');
                                const preview1 = document.getElementById('product-image-1-preview');
                                const placeholder1 = document.getElementById('product-upload-placeholder-1');
                                
                                if (previewImg1 && preview1 && placeholder1) {
                                    previewImg1.src = product.additionalImages[0];
                                    preview1.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important;');
                                    placeholder1.setAttribute('style', 'display: none !important; visibility: hidden !important;');
                                    previewImg1.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important; max-width: 100% !important; max-height: 120px !important;');
                                    console.log('🔧 추가 이미지 1 강제 표시 완료');
                                }
                            }
                            
                            // 추가 이미지 2 강제 표시
                            if (product.additionalImages[1]) {
                                const previewImg2 = document.getElementById('product-preview-img-2');
                                const preview2 = document.getElementById('product-image-2-preview');
                                const placeholder2 = document.getElementById('product-upload-placeholder-2');
                                
                                if (previewImg2 && preview2 && placeholder2) {
                                    previewImg2.src = product.additionalImages[1];
                                    preview2.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important;');
                                    placeholder2.setAttribute('style', 'display: none !important; visibility: hidden !important;');
                                    previewImg2.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important; max-width: 100% !important; max-height: 120px !important;');
                                    console.log('🔧 추가 이미지 2 강제 표시 완료');
                                }
                            }
                            
                            // 추가 이미지 3 강제 표시
                            if (product.additionalImages[2]) {
                                const previewImg3 = document.getElementById('product-preview-img-3');
                                const preview3 = document.getElementById('product-image-3-preview');
                                const placeholder3 = document.getElementById('product-upload-placeholder-3');
                                
                                if (previewImg3 && preview3 && placeholder3) {
                                    previewImg3.src = product.additionalImages[2];
                                    preview3.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important;');
                                    placeholder3.setAttribute('style', 'display: none !important; visibility: hidden !important;');
                                    previewImg3.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important; max-width: 100% !important; max-height: 120px !important;');
                                    console.log('🔧 추가 이미지 3 강제 표시 완료');
                                }
                            }
                        } else {
                            console.log('⚠️ 강제 표시할 추가 이미지가 없습니다');
                        }
                        
                        // 상세 이미지도 강제 표시
                        if (product.detailImageUrl) {
                            console.log('🔧 상세 이미지 강제 표시 시작:', product.detailImageUrl);
                            
                            const previewDetailImg = document.getElementById('product-detail-preview-img');
                            const previewDetail = document.getElementById('product-detail-image-preview');
                            const placeholderDetail = document.getElementById('product-detail-upload-placeholder');
                            
                            console.log('🔍 상세 이미지 강제 표시 요소들:', { previewDetailImg, previewDetail, placeholderDetail });
                            
                            if (previewDetailImg && previewDetail && placeholderDetail) {
                                previewDetailImg.src = product.detailImageUrl;
                                previewDetail.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important;');
                                placeholderDetail.setAttribute('style', 'display: none !important; visibility: hidden !important;');
                                previewDetailImg.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important; max-width: 100% !important; max-height: 200px !important;');
                                console.log('🔧 상세 이미지 강제 표시 완료');
                            } else {
                                console.warn('⚠️ 상세 이미지 강제 표시 요소를 찾을 수 없습니다');
                            }
                        } else {
                            console.log('⚠️ 강제 표시할 상세 이미지가 없습니다');
                        }
                    }, 200);
                }
            }, 500);
        }
        
        // 상품 폼 데이터 채우기 함수
        function fillProductForm(product) {
            console.log('📝 상품 폼 데이터 채우기:', product);
                console.log('🔍 상품명 필드들 확인:', {
                    nameEn: product.nameEn,
                    nameJp: product.nameJp
                });
            
            // 기본 정보
            setFieldValue('product-code', product.code || '');
            setFieldValue('product-name-en', product.nameEn || '');
            console.log('🔍 영문명 필드 설정:', {
                'product.nameEn': product.nameEn,
                '설정할 값': product.nameEn || ''
            });
            setFieldValue('product-name-jp', product.nameJp || '');
            setFieldValue('product-brand', product.brandCode || '');
            setFieldValue('product-price', product.price || 0);
            setFieldValue('product-sale-price', product.salePrice || 0);
            setFieldValue('product-stock', product.stock || 0);
            setFieldValue('product-status', product.status || 'active');
            setFieldValue('product-priority', product.priority || 50);
            setFieldValue('product-capacity', product.capacity || '');
            
            // 상품 타입
            const productType = product.productType || 'simple';
            const simpleRadio = document.getElementById('product-type-simple');
            const optionRadio = document.getElementById('product-type-option');
            if (simpleRadio && optionRadio) {
                if (productType === 'simple') {
                    simpleRadio.checked = true;
                } else {
                    optionRadio.checked = true;
                }
                toggleOptionSection(); // 옵션 섹션 표시/숨김
            }
            
            // 이미지 URL
            setFieldValue('product-image-url', product.imageUrl || '');
            setFieldValue('product-current-url', product.imageUrl || '');
            
            // 추가 이미지들 설정 - 기존 데이터를 숨겨진 필드에 저장
            if (product.additionalImages && Array.isArray(product.additionalImages)) {
                console.log('🔍 추가 이미지 설정:', product.additionalImages);
                console.log('🔍 추가 이미지 개수:', product.additionalImages.length);
                
                // 추가 이미지들을 콘솔에 출력하여 확인
                product.additionalImages.forEach((img, index) => {
                    console.log(`🔍 추가 이미지 ${index + 1}:`, img);
                });
                
                // 기존 추가 이미지 데이터를 숨겨진 필드에 저장 (JSON 형태로)
                setFieldValue('product-current-additional-images', JSON.stringify(product.additionalImages));
                console.log('✅ 기존 추가 이미지 데이터를 숨겨진 필드에 저장:', product.additionalImages);
            } else {
                // 추가 이미지가 없으면 빈 배열로 설정
                setFieldValue('product-current-additional-images', JSON.stringify([]));
                console.log('⚠️ 추가 이미지가 없어서 빈 배열로 설정');
            }
            
            // 상세 이미지 설정 - 기존 데이터를 숨겨진 필드에 저장
            if (product.detailImageUrl) {
                console.log('🔍 상세 이미지 설정:', product.detailImageUrl);
                setFieldValue('product-current-detail-image-url', product.detailImageUrl);
                console.log('✅ 기존 상세 이미지 데이터를 숨겨진 필드에 저장:', product.detailImageUrl);
            } else {
                console.log('⚠️ 상품에 상세 이미지 URL이 없습니다');
                setFieldValue('product-current-detail-image-url', '');
            }
            
            // 배지 설정
            setFieldValue('product-badge-type', product.badgeType || '');
            setFieldValue('product-badge-color', product.badgeColor || 'red');
            setFieldValue('product-badge-text', product.badgeText || '');
            
            // 뱃지 날짜 필드는 동적 생성 후 설정
            setTimeout(() => {
                setFieldValue('product-badge-start', product.badgeStartDate || '');
                setFieldValue('product-badge-end', product.badgeEndDate || '');
                
                console.log('🔍 뱃지 날짜 필드 설정 완료:', {
                    badgeStartDate: product.badgeStartDate,
                    badgeEndDate: product.badgeEndDate,
                    startField: document.getElementById('product-badge-start'),
                    endField: document.getElementById('product-badge-end')
                });
            }, 100);
            
            // 배지 타입에 따른 커스텀 텍스트 표시/숨김
            const customBadgeContainer = document.getElementById('new-product-custom-badge-text-container');
            if (customBadgeContainer) {
                customBadgeContainer.style.display = product.badgeType === 'CUSTOM' ? 'block' : 'none';
            }
            
            // 이미지 미리보기 설정 (지연 실행으로 DOM 요소 확실히 로드 후 설정)
            setTimeout(() => {
            if (product.imageUrl) {
                console.log('🔍 메인 이미지 미리보기 설정 (지연):', product.imageUrl);
                forceShowImagePreview(product.imageUrl);
            } else {
                console.log('⚠️ 상품에 이미지 URL이 없습니다');
            }
            
                // 추가 이미지들 미리보기 설정 - 통합 모달에서도 활성화
                if (product.additionalImages && Array.isArray(product.additionalImages) && product.additionalImages.length > 0) {
                    console.log('🔍 추가 이미지 미리보기 설정:', product.additionalImages);
                    
                    // 추가 이미지 1 미리보기
                    if (product.additionalImages[0]) {
                        console.log('🔍 추가 이미지 1 설정 시도:', product.additionalImages[0]);
                        const previewImg1 = document.getElementById('product-preview-img-1');
                        const preview1 = document.getElementById('product-image-1-preview');
                        const placeholder1 = document.getElementById('product-upload-placeholder-1');
                        
                        console.log('🔍 추가 이미지 1 요소들:', { previewImg1, preview1, placeholder1 });
                        
                        if (previewImg1 && preview1 && placeholder1) {
                            previewImg1.src = product.additionalImages[0];
                            preview1.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important;');
                            placeholder1.setAttribute('style', 'display: none !important; visibility: hidden !important;');
                            previewImg1.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important; max-width: 100% !important; max-height: 120px !important;');
                            console.log('✅ 추가 이미지 1 미리보기 설정 완료');
                        } else {
                            console.warn('⚠️ 추가 이미지 1 요소를 찾을 수 없습니다');
                        }
                    }
                    
                    // 추가 이미지 2 미리보기
                    if (product.additionalImages[1]) {
                        console.log('🔍 추가 이미지 2 설정 시도:', product.additionalImages[1]);
                        const previewImg2 = document.getElementById('product-preview-img-2');
                        const preview2 = document.getElementById('product-image-2-preview');
                        const placeholder2 = document.getElementById('product-upload-placeholder-2');
                        
                        console.log('🔍 추가 이미지 2 요소들:', { previewImg2, preview2, placeholder2 });
                        
                        if (previewImg2 && preview2 && placeholder2) {
                            previewImg2.src = product.additionalImages[1];
                            preview2.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important;');
                            placeholder2.setAttribute('style', 'display: none !important; visibility: hidden !important;');
                            previewImg2.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important; max-width: 100% !important; max-height: 120px !important;');
                            console.log('✅ 추가 이미지 2 미리보기 설정 완료');
                        } else {
                            console.warn('⚠️ 추가 이미지 2 요소를 찾을 수 없습니다');
                        }
                    }
                    
                    // 추가 이미지 3 미리보기
                    if (product.additionalImages[2]) {
                        console.log('🔍 추가 이미지 3 설정 시도:', product.additionalImages[2]);
                        const previewImg3 = document.getElementById('product-preview-img-3');
                        const preview3 = document.getElementById('product-image-3-preview');
                        const placeholder3 = document.getElementById('product-upload-placeholder-3');
                        
                        console.log('🔍 추가 이미지 3 요소들:', { previewImg3, preview3, placeholder3 });
                        
                        if (previewImg3 && preview3 && placeholder3) {
                            previewImg3.src = product.additionalImages[2];
                            preview3.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important;');
                            placeholder3.setAttribute('style', 'display: none !important; visibility: hidden !important;');
                            previewImg3.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important; max-width: 100% !important; max-height: 120px !important;');
                            console.log('✅ 추가 이미지 3 미리보기 설정 완료');
                        } else {
                            console.warn('⚠️ 추가 이미지 3 요소를 찾을 수 없습니다');
                        }
                    }
                } else {
                    console.log('⚠️ 추가 이미지가 없거나 배열이 아닙니다:', product.additionalImages);
                }
                
                // 상세 이미지 미리보기 설정 - 통합 모달에서도 활성화
                if (product.detailImageUrl) {
                    console.log('🔍 상세 이미지 미리보기 설정 시도:', product.detailImageUrl);
                    
                    // 가능한 상세 이미지 요소 ID들 확인
                    const possibleIds = [
                        'product-detail-preview-img',
                        'product-detail-image-preview',
                        'product-detail-upload-placeholder'
                    ];
                    
                    possibleIds.forEach(id => {
                        const element = document.getElementById(id);
                        console.log(`🔍 상세 이미지 요소 확인 ${id}:`, element);
                    });
                    
                    const previewDetailImg = document.getElementById('product-detail-preview-img');
                    const previewDetail = document.getElementById('product-detail-image-preview');
                    const placeholderDetail = document.getElementById('product-detail-upload-placeholder');
                    
                    console.log('🔍 상세 이미지 요소들:', { previewDetailImg, previewDetail, placeholderDetail });
                    
                    if (previewDetailImg && previewDetail && placeholderDetail) {
                        previewDetailImg.src = product.detailImageUrl;
                        previewDetail.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important;');
                        placeholderDetail.setAttribute('style', 'display: none !important; visibility: hidden !important;');
                        previewDetailImg.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important; max-width: 100% !important; max-height: 200px !important;');
                        console.log('✅ 상세 이미지 미리보기 설정 완료');
                    } else {
                        console.warn('⚠️ 상세 이미지 요소를 찾을 수 없습니다');
                    }
                } else {
                    console.log('⚠️ 상품에 상세 이미지 URL이 없습니다');
                }
            }, 300); // 300ms 지연으로 DOM 요소 확실히 로드 후 실행
        }
        
        // 필드 값 설정 헬퍼 함수
        function setFieldValue(fieldId, value) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.value = value;
                console.log(`🔧 필드 설정: ${fieldId} = "${value}"`);
            } else {
                console.error(`❌ 필드를 찾을 수 없습니다: ${fieldId}`);
            }
        }
        
        // 기존 동적 모달 코드 제거를 위한 주석
        /*
                <div class="modal fade" id="productEditModal" tabindex="-1" aria-labelledby="productEditModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="productEditModalLabel">
                                    <i class="fas fa-edit me-2"></i>상품 편집
                                </h5>
                            </div>
                            <div class="modal-body">
                                <form id="productEditForm">
                                    <input type="hidden" id="edit-product-id" value="${product.id}">
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="edit-product-name-en" class="form-label">商品名（英語） <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="edit-product-name-en" value="${product.nameEn || ''}" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="edit-product-name-kr" class="form-label">商品名（韓国語）</label>
                                                <input type="text" class="form-control" id="edit-product-name-kr" value="${product.nameKr || ''}">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="edit-product-brand" class="form-label">브랜드</label>
                                                <select class="form-select" id="edit-product-brand">
                                                    <option value="LALARECIPE" ${product.brandName === 'LALARECIPE' ? 'selected' : ''}>LALARECIPE</option>
                                                    <option value="LUCINDE" ${product.brandName === 'LUCINDE' ? 'selected' : ''}>LUCINDE</option>
                                                    <option value="COSCELL" ${product.brandName === 'COSCELL' ? 'selected' : ''}>COSCELL</option>
                                                    <option value="Make heal" ${product.brandName === 'Make heal' ? 'selected' : ''}>Make heal</option>
                                                    <option value="Monday Museum" ${product.brandName === 'Monday Museum' ? 'selected' : ''}>Monday Museum</option>
                                                    <option value="Plareceta" ${product.brandName === 'Plareceta' ? 'selected' : ''}>Plareceta</option>
                                                    <option value="Catch By Sonyouna" ${product.brandName === 'Catch By Sonyouna' ? 'selected' : ''}>Catch By Sonyouna</option>
                                                    <option value="Medipeel" ${product.brandName === 'Medipeel' ? 'selected' : ''}>Medipeel</option>
                                                    <option value="Dancing Whale" ${product.brandName === 'Dancing Whale' ? 'selected' : ''}>Dancing Whale</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="edit-product-status" class="form-label">상태</label>
                                                <select class="form-select" id="edit-product-status">
                                                    <option value="active" ${product.status === 'active' ? 'selected' : ''}>アクティブ</option>
                                                    <option value="inactive" ${product.status === 'inactive' ? 'selected' : ''}>非アクティブ</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="edit-product-price" class="form-label">販売価格 (¥)</label>
                                                <input type="number" class="form-control" id="edit-product-price" value="${product.price || 0}" min="0">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="edit-product-sale-price" class="form-label">セール価格 (¥)</label>
                                                <input type="number" class="form-control" id="edit-product-sale-price" value="${product.salePrice || 0}" min="0">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="edit-product-stock" class="form-label">在庫</label>
                                                <input type="number" class="form-control" id="edit-product-stock" value="${product.stock || 0}" min="0">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="edit-product-image-url" class="form-label">이미지 URL</label>
                                                <input type="url" class="form-control" id="edit-product-image-url" value="${product.imageUrl || ''}" placeholder="https://example.com/image.jpg">
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">현재 이미지 미리보기</label>
                                        <div class="text-center">
                                            <img src="${product.imageUrl || 'assets/img/placeholder-brand.svg'}" alt="${product.nameEn}" class="img-fluid" style="max-height: 200px;" 
                                                 onerror="this.src='assets/img/placeholder-brand.svg'">
                                        </div>
                                    </div>
                                    
                                    <!-- 商品バッジ設定セクション -->
                                    <div class="card mt-4">
                                        <div class="card-header">
                                            <h6 class="mb-0">
                                                <i class="fas fa-tag me-2"></i>商品バッジ設定
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="edit-product-badge-type" class="form-label">バッジタイプ</label>
                                                        <select class="form-select" id="edit-product-badge-type">
                                                            <option value="">バッジなし</option>
                                                            <option value="NEW" ${product.badgeType === 'NEW' ? 'selected' : ''}>NEW</option>
                                                            <option value="SALE" ${product.badgeType === 'SALE' ? 'selected' : ''}>SALE</option>
                                                            <option value="HOT" ${product.badgeType === 'HOT' ? 'selected' : ''}>HOT</option>
                                                            <option value="LIMITED" ${product.badgeType === 'LIMITED' ? 'selected' : ''}>LIMITED</option>
                                                            <option value="POPULAR" ${product.badgeType === 'POPULAR' ? 'selected' : ''}>POPULAR</option>
                                                            <option value="BEST" ${product.badgeType === 'BEST' ? 'selected' : ''}>BEST</option>
                                                            <option value="CUSTOM" ${product.badgeType === 'CUSTOM' ? 'selected' : ''}>カスタム</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="edit-product-badge-color" class="form-label">バッジカラー</label>
                                                        <select class="form-select" id="edit-product-badge-color">
                                                            <option value="red" ${product.badgeColor === 'red' ? 'selected' : ''}>赤色</option>
                                                            <option value="blue" ${product.badgeColor === 'blue' ? 'selected' : ''}>青色</option>
                                                            <option value="green" ${product.badgeColor === 'green' ? 'selected' : ''}>緑色</option>
                                                            <option value="orange" ${product.badgeColor === 'orange' ? 'selected' : ''}>オレンジ色</option>
                                                            <option value="purple" ${product.badgeColor === 'purple' ? 'selected' : ''}>紫色</option>
                                                            <option value="dark" ${product.badgeColor === 'dark' ? 'selected' : ''}>黒色</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3" id="product-custom-badge-text-container" style="display: ${product.badgeType === 'CUSTOM' ? 'block' : 'none'};">
                                                <label for="edit-product-badge-text" class="form-label">カスタムバッジテキスト</label>
                                                <input type="text" class="form-control" id="edit-product-badge-text" value="${product.badgeText || ''}" placeholder="例: 特価、新商品" maxlength="10">
                                                <div class="form-text">最大10文字まで入力可能</div>
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="edit-product-badge-start" class="form-label">バッジ開始日</label>
                                                        <input type="date" class="form-control" id="edit-product-badge-start" value="${product.badgeStartDate || ''}" lang="ja" locale="ja-JP">
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="edit-product-badge-end" class="form-label">バッジ終了日</label>
                                                        <input type="date" class="form-control" id="edit-product-badge-end" value="${product.badgeEndDate || ''}" lang="ja" locale="ja-JP">
                                                    </div>
                                                </div>
                                            </div>
                                            
                                        </div>
                                    </div>
                                    
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-outline-secondary" onclick="closeProductEditModal()">キャンセル</button>
                                <button type="button" class="btn btn-secondary" onclick="saveProductEdit()">保存</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 기존 모달 제거
            const existingModal = document.getElementById('productEditModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 새 모달 추가
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 모달 표시
            const modal = new bootstrap.Modal(document.getElementById('productEditModal'));
            modal.show();
            
            // 기존 색상 옵션 데이터 로드
            loadExistingColorOptions(product.colorOptions || []);
        }
        */
        
        
        // 중복된 deleteProduct 함수 제거됨 - 위의 window.deleteProduct 사용

        // 색상 옵션 관련 함수들 제거됨 (통합 모달 사용)
        
        // 상품 타입에 따른 옵션 섹션 표시/숨김
        function toggleOptionSection() {
            const simpleType = document.getElementById('product-type-simple');
            const optionType = document.getElementById('product-type-option');
            const optionSection = document.getElementById('option-settings-section');
            
            if (simpleType && simpleType.checked) {
                optionSection.style.display = 'none';
                // 옵션 리스트 초기화
                const optionsList = document.getElementById('product-options-list');
                if (optionsList) {
                    optionsList.innerHTML = '';
                }
                // 옵션 카운터 리셋
                productOptionCounter = 0;
            } else if (optionType && optionType.checked) {
                optionSection.style.display = 'block';
            }
        }
        
        // 상품 옵션 추가
        window.addProductOption = function() {
            productOptionCounter++;
            const optionsList = document.getElementById('product-options-list');
            
            const optionHtml = `
                <div class="product-option-row border rounded p-3 mb-2" data-option-id="${productOptionCounter}">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <label class="form-label small">オプション名</label>
                            <input type="text" class="form-control form-control-sm" 
                                   placeholder="例: 1号, 2号, 3号" 
                                   name="optionName_${productOptionCounter}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">在庫数</label>
                            <input type="number" class="form-control form-control-sm" 
                                   placeholder="0" min="0" 
                                   name="optionStock_${productOptionCounter}">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeProductOption(${productOptionCounter})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            optionsList.insertAdjacentHTML('beforeend', optionHtml);
        };
        
        // 상품 옵션 삭제
        window.removeProductOption = function(optionId) {
            const optionRow = document.querySelector(`[data-option-id="${optionId}"]`);
            if (optionRow) {
                optionRow.remove();
            }
        };
        
        // 상품 옵션 데이터 수집
        window.collectProductOptions = function() {
            const options = [];
            const optionsList = document.getElementById('product-options-list');
            
            if (!optionsList) {
                return options;
            }
            
            const optionRows = optionsList.querySelectorAll('.product-option-row');
            
            optionRows.forEach((row, index) => {
                const nameInput = row.querySelector('input[name^="optionName_"]');
                const stockInput = row.querySelector('input[name^="optionStock_"]');
                
                const optionName = nameInput?.value?.trim();
                const stock = parseInt(stockInput?.value) || 0;
                
                if (optionName) {
                    options.push({
                        id: `option_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        name: optionName,
                        stock: stock,
                        isActive: true
                    });
                }
            });
            
            return options;
        };
        
        // 色オプション追加
        window.addColorOption = function() {
            colorOptionCounter++;
            const colorOptionsList = document.getElementById('color-options-list');
            
                    const colorOptionHtml = `
                        <div class="color-option-row border rounded p-3 mb-2" data-option-id="${colorOptionCounter}">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <label class="form-label small">色名</label>
                                    <input type="text" class="form-control form-control-sm" 
                                           placeholder="例: レッド 1号" 
                                           name="colorName_${colorOptionCounter}">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">在庫数</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           placeholder="0" min="0" 
                                           name="colorStock_${colorOptionCounter}">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small">価格調整</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           placeholder="0" min="0" 
                                           name="colorPriceAdjustment_${colorOptionCounter}">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">画像URL</label>
                                    <input type="url" class="form-control form-control-sm" 
                                           placeholder="https://..." 
                                           name="colorImageUrl_${colorOptionCounter}">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label small">&nbsp;</label>
                                    <button type="button" class="btn btn-outline-secondary btn-sm w-100" 
                                            onclick="removeColorOption(${colorOptionCounter})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
            
            colorOptionsList.insertAdjacentHTML('beforeend', colorOptionHtml);
        };
        
        // 色オプション削除
        window.removeColorOption = function(optionId) {
            const optionRow = document.querySelector(`[data-option-id="${optionId}"]`);
            if (optionRow) {
                optionRow.remove();
            }
        };
        
        // 色オプションデータ収集 (편집 모달용)
        window.collectColorOptions = function() {
            const colorOptions = [];
            const colorOptionsList = document.getElementById('color-options-list');
            
            if (!colorOptionsList) {
                console.log('색상 옵션 리스트를 찾을 수 없습니다');
                return colorOptions;
            }
            
            const optionRows = colorOptionsList.querySelectorAll('.color-option-row');
            console.log('편집 모달 색상 옵션 행 개수:', optionRows.length);
            
                    optionRows.forEach((row, index) => {
                        const nameInput = row.querySelector('input[name^="colorName_"]');
                        const stockInput = row.querySelector('input[name^="colorStock_"]');
                        const priceAdjustmentInput = row.querySelector('input[name^="colorPriceAdjustment_"]');
                        const imageUrlInput = row.querySelector('input[name^="colorImageUrl_"]');
                        
                        console.log(`옵션 ${index + 1}:`, {
                            nameInput: nameInput?.value,
                            stockInput: stockInput?.value,
                            priceAdjustmentInput: priceAdjustmentInput?.value,
                            imageUrlInput: imageUrlInput?.value
                        });
                        
                        if (nameInput && stockInput) {
                            const colorName = nameInput.value.trim();
                            const stock = parseInt(stockInput.value) || 0;
                            const priceAdjustment = parseInt(priceAdjustmentInput?.value) || 0;
                            const imageUrl = imageUrlInput?.value?.trim() || '';
                            
                            if (colorName) {
                                colorOptions.push({
                                    id: `color_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                    name: colorName,
                                    stock: stock,
                                    priceAdjustment: priceAdjustment,
                                    imageUrl: imageUrl,
                                    isActive: true
                                });
                            }
                        }
                    });
            
            console.log('수집된 색상 옵션:', colorOptions);
            return colorOptions;
        };
        
        // 新商品用色オプション追加
        window.addNewColorOption = function() {
            colorOptionCounter++;
            const colorOptionsList = document.getElementById('new-color-options-list');
            
            const colorOptionHtml = `
                <div class="color-option-row border rounded p-3 mb-2" data-option-id="${colorOptionCounter}">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <label class="form-label small">色名</label>
                            <input type="text" class="form-control form-control-sm" 
                                   placeholder="例: レッド 1号" 
                                   name="newColorName_${colorOptionCounter}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">在庫数</label>
                            <input type="number" class="form-control form-control-sm" 
                                   placeholder="0" min="0" 
                                   name="newColorStock_${colorOptionCounter}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">価格調整</label>
                            <input type="number" class="form-control form-control-sm" 
                                   placeholder="0" min="0" 
                                   name="newColorPriceAdjustment_${colorOptionCounter}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">画像URL</label>
                            <input type="url" class="form-control form-control-sm" 
                                   placeholder="https://..." 
                                   name="newColorImageUrl_${colorOptionCounter}">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label small">&nbsp;</label>
                            <button type="button" class="btn btn-outline-secondary btn-sm w-100" 
                                    onclick="removeNewColorOption(${colorOptionCounter})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            colorOptionsList.insertAdjacentHTML('beforeend', colorOptionHtml);
        };
        
        // 新商品用色オプション削除
        window.removeNewColorOption = function(optionId) {
            const optionRow = document.querySelector(`[data-option-id="${optionId}"]`);
            if (optionRow) {
                optionRow.remove();
            }
        };
        
        // 新商品用色オプションデータ収集
        window.collectNewColorOptions = function() {
            const colorOptions = [];
            const colorOptionsList = document.getElementById('new-color-options-list');
            
            if (!colorOptionsList) {
                console.log('새 상품 색상 옵션 리스트를 찾을 수 없습니다');
                return colorOptions;
            }
            
            const optionRows = colorOptionsList.querySelectorAll('.color-option-row');
            console.log('새 상품 색상 옵션 행 개수:', optionRows.length);
            
                    optionRows.forEach((row, index) => {
                        const nameInput = row.querySelector('input[name^="newColorName_"]');
                        const stockInput = row.querySelector('input[name^="newColorStock_"]');
                        const priceAdjustmentInput = row.querySelector('input[name^="newColorPriceAdjustment_"]');
                        const imageUrlInput = row.querySelector('input[name^="newColorImageUrl_"]');
                        
                        console.log(`새 상품 옵션 ${index + 1}:`, {
                            nameInput: nameInput?.value,
                            stockInput: stockInput?.value,
                            priceAdjustmentInput: priceAdjustmentInput?.value,
                            imageUrlInput: imageUrlInput?.value
                        });
                        
                        if (nameInput && stockInput) {
                            const colorName = nameInput.value.trim();
                            const stock = parseInt(stockInput.value) || 0;
                            const priceAdjustment = parseInt(priceAdjustmentInput?.value) || 0;
                            const imageUrl = imageUrlInput?.value?.trim() || '';
                            
                            if (colorName) {
                                colorOptions.push({
                                    id: `color_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                    name: colorName,
                                    stock: stock,
                                    priceAdjustment: priceAdjustment,
                                    imageUrl: imageUrl,
                                    isActive: true
                                });
                            }
                        }
                    });
            
            console.log('수집된 새 상품 색상 옵션:', colorOptions);
            return colorOptions;
        };

        // 商品表示機能 (brand-template.html 방식 적용)
        function displayProducts() {
            console.log('🎨 displayProducts 함수 시작');
            console.log('📊 현재 상품 데이터:', {
                allProductsList: allProductsList ? allProductsList.length : 'undefined',
                filteredProductsList: filteredProductsList ? filteredProductsList.length : 'undefined',
                windowAllProductsList: window.allProductsList ? window.allProductsList.length : 'undefined'
            });
            
            const container = document.getElementById('products-container');
            if (!container) {
                console.error('❌ 상품 컨테이너를 찾을 수 없습니다');
                return;
            }
            
            console.log('📦 상품 컨테이너 찾음:', container);
            
            if (!filteredProductsList || filteredProductsList.length === 0) {
                console.log('⚠️ 표시할 상품이 없음 - 메시지 표시');
                const searchTerm = document.getElementById('product-search')?.value?.trim();
                const hasSearchTerm = searchTerm && searchTerm.length > 0;
                
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <p class="text-muted">
                            ${hasSearchTerm ? 
                                `"${searchTerm}" に一致する商品が見つかりません。` : 
                                '商品が見つかりません。'
                            }
                        </p>
                        ${hasSearchTerm ? 
                            '<p class="text-muted small">別のキーワードで検索してみてください。</p>' : 
                            ''
                        }
                    </div>
                `;
                return;
            }
            
            console.log('🎯 상품 카드 생성 시작:', filteredProductsList.length, '개');
            console.log('📋 표시할 상품들:', filteredProductsList.map(p => p.nameEn || p.nameJp || p.nameKr));
            console.log('🔍 filteredProductsList 상세 정보:', filteredProductsList);
            
            const productsHTML = filteredProductsList.map(product => {
                // 배지 정보 처리
                let badgeHtml = '';
                const colorMap = {
                    'red': '#dc3545',
                    'blue': '#0d6efd',
                    'green': '#198754',
                    'orange': '#fd7e14',
                    'purple': '#6f42c1',
                    'dark': '#212529'
                };
                
                if (product.badgeType && product.badgeType !== '') {
                    const badgeText = product.badgeType === 'CUSTOM' ? (product.badgeText || 'CUSTOM') : product.badgeType;
                    const badgeColor = colorMap[product.badgeColor] || '#dc3545';
                    badgeHtml = `<span class="badge" style="background-color: ${badgeColor}; color: white; font-size: 10px; margin-left: 5px;">${badgeText}</span>`;
                }

                return `
                <div class="col-6 col-md-6 col-lg-4 mb-4">
                    <div class="card product-card h-100">
                        <div class="position-relative">
                            <img src="${product.imageUrl || 'assets/img/placeholder-product.jpg'}" 
                                 class="card-img-top" alt="${product.nameJp}"
                                 onerror="this.src='assets/img/placeholder-product.jpg'"
                                 style="height: 150px; object-fit: cover;">
                            ${product.badgeType && product.badgeType !== '' ? `
                                <span class="badge" style="position: absolute; top: 8px; right: 8px; background-color: ${colorMap[product.badgeColor] || '#dc3545'}; color: white; font-size: 11px; padding: 4px 8px; border-radius: 4px; z-index: 10;">
                                    ${product.badgeType === 'CUSTOM' ? (product.badgeText || 'CUSTOM') : product.badgeType}
                                </span>
                            ` : ''}
                        </div>
                        <div class="card-body">
                            <h6 class="card-title mb-2">${product.nameEn || product.nameJp || '商品名なし'}</h6>
                            <div class="product-meta mb-2">
                                <span class="badge bg-secondary me-1">${product.brandName || '不明'}</span>
                                <span class="badge bg-${product.stock > 10 ? 'success' : product.stock > 0 ? 'warning' : 'danger'}">
                                    ${product.stock > 10 ? '在庫あり' : product.stock > 0 ? '在庫少' : '在庫切れ'}
                                </span>
                                ${badgeHtml}
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="price fw-bold">¥${product.price?.toLocaleString() || '0'}</span>
                                <div class="btn-group">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="editProduct('${product.id}')" title="編集">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="deleteProduct('${product.id}')" title="削除">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
            
            container.innerHTML = `<div class="row">${productsHTML}</div>`;
            console.log('✅ 상품 카드 HTML 생성 완료 - DOM에 적용됨');
        }

        // 브랜드 목록 로드 및 드롭다운 채우기
        async function loadBrandFilter() {
            try {
                console.log('🏷️ 브랜드 필터 로드 시작');
                
                // Firebase에서 브랜드 데이터 로드
                const brandsSnapshot = await firebase.firestore().collection('brands').get();
                const brands = [];
                
                brandsSnapshot.forEach(doc => {
                    const data = doc.data();
                    brands.push({
                        id: doc.id,
                        code: data.code,
                        name: data.name || data.nameJp || 'Unknown Brand',
                        nameJp: data.nameJp || data.name || 'Unknown Brand'
                    });
                });
                
                // 브랜드 이름으로 정렬
                brands.sort((a, b) => a.name.localeCompare(b.name));
                
                // 드롭다운 채우기
                const brandFilter = document.getElementById('brand-filter');
                if (brandFilter) {
                    // 기존 옵션 유지 (첫 번째 "すべてのブランド" 옵션)
                    brandFilter.innerHTML = '<option value="">すべてのブランド</option>';
                    
                    // 브랜드 옵션 추가
                    brands.forEach(brand => {
                        const option = document.createElement('option');
                        option.value = brand.code;
                        option.textContent = brand.nameJp || brand.name;
                        brandFilter.appendChild(option);
                    });
                    
                    console.log('✅ 브랜드 필터 로드 완료:', brands.length, '개 브랜드');
                }
                
            } catch (error) {
                console.error('❌ 브랜드 필터 로드 실패:', error);
            }
        }

        // 商品検索機能 (영어명 + 브랜드 필터링)
        function filterProducts() {
            const searchInput = document.getElementById('product-search');
            const brandFilter = document.getElementById('brand-filter');
            
            if (!searchInput || !brandFilter) {
                console.error('❌ 검색 입력 필드 또는 브랜드 필터를 찾을 수 없습니다');
                return;
            }
            
            const searchTerm = searchInput.value.toLowerCase().trim();
            const selectedBrandId = brandFilter.value;
            
            console.log('🔍 상품 검색 조건:', {
                검색어: searchTerm,
                브랜드: selectedBrandId
            });
            
            // 상품 데이터 소스 확인 (window.allProductsList 우선 사용)
            let productsToSearch = [];
            if (window.allProductsList && window.allProductsList.length > 0) {
                productsToSearch = window.allProductsList;
                console.log('📦 window.allProductsList 사용:', productsToSearch.length, '개');
            } else if (allProductsList && allProductsList.length > 0) {
                productsToSearch = allProductsList;
                console.log('📦 allProductsList 사용:', productsToSearch.length, '개');
            } else {
                console.warn('⚠️ 검색할 상품이 없습니다 - 상품 데이터를 먼저 로드해주세요');
                console.log('🔍 데이터 소스 상태:', {
                    windowAllProductsList: window.allProductsList ? window.allProductsList.length : 'undefined',
                    allProductsList: allProductsList ? allProductsList.length : 'undefined'
                });
                return;
            }
            
            // 필터링 적용
            filteredProductsList = productsToSearch.filter(product => {
                let matchesSearch = true;
                let matchesBrand = true;
                
                // 검색어 필터링
                if (searchTerm) {
                    const nameEn = (product.nameEn || '').toLowerCase();
                    matchesSearch = nameEn.includes(searchTerm);
                }
                
                // 브랜드 필터링
                if (selectedBrandId) {
                    matchesBrand = product.brandCode === selectedBrandId;
                }
                
                const isMatch = matchesSearch && matchesBrand;
                
                if (isMatch) {
                    console.log('✅ 매칭 상품:', product.nameEn, '→', product.nameJp, '(브랜드:', product.brandCode, ')');
                }
                
                return isMatch;
            });
            
            console.log('🔍 필터링 결과:', filteredProductsList.length, '개 상품');
            
            // 우선순위 순으로 정렬 (높은 우선순위가 먼저)
            filteredProductsList.sort((a, b) => {
                const priorityA = a.priority || 50;
                const priorityB = b.priority || 50;
                if (priorityB !== priorityA) {
                    return priorityB - priorityA;  // 우선순위 높은 순
                }
                return (a.nameJp || '').localeCompare(b.nameJp || '');  // 같은 우선순위면 알파벳 순
            });
            
            // 강제로 displayProducts 호출 및 디버깅
            console.log('🔄 displayProducts 강제 호출 시작');
            console.log('🔍 호출 전 filteredProductsList 상태:', filteredProductsList ? filteredProductsList.length : 'undefined');
            
            // 즉시 displayProducts 호출
            try {
            displayProducts();
                console.log('✅ displayProducts 호출 성공');
                
                // DOM 확인
                setTimeout(() => {
                    const container = document.getElementById('products-container');
                    if (container) {
                        console.log('🔍 DOM 확인 - 컨테이너 내용:', container.innerHTML.length, '문자');
                        console.log('🔍 DOM 확인 - 자식 요소 수:', container.children.length);
                    }
                }, 100);
                
            } catch (error) {
                console.error('❌ displayProducts 호출 실패:', error);
            }
            
            // 대안: 직접 DOM 조작으로 검색 결과 표시
            console.log('🔄 대안: 직접 DOM 조작으로 검색 결과 표시');
            forceDisplaySearchResults();
        }
        
        // 강제로 검색 결과를 DOM에 직접 표시하는 함수
        function forceDisplaySearchResults() {
            console.log('🚀 forceDisplaySearchResults 시작');
            
            const container = document.getElementById('products-container');
            if (!container) {
                console.error('❌ products-container를 찾을 수 없습니다');
                return;
            }
            
            if (!filteredProductsList || filteredProductsList.length === 0) {
                console.log('⚠️ 표시할 검색 결과가 없습니다');
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <p class="text-muted">검색 결과가 없습니다.</p>
                    </div>
                `;
                return;
            }
            
            console.log('🎯 직접 DOM 조작으로 상품 카드 생성:', filteredProductsList.length, '개');
            
            // 검색 결과를 직접 HTML로 생성
            const searchResultsHTML = filteredProductsList.map(product => {
                console.log('🎨 카드 생성:', product.nameEn);
                return `
                <div class="col-6 col-md-6 col-lg-4 mb-4">
                    <div class="card product-card h-100">
                        <div class="position-relative">
                            <img src="${product.imageUrl || 'assets/img/placeholder-product.jpg'}" 
                                 class="card-img-top" alt="${product.nameJp || product.nameEn}"
                                 onerror="this.src='assets/img/placeholder-product.jpg'"
                                 style="height: 150px; object-fit: cover;">
                        </div>
                        <div class="card-body">
                            <h6 class="card-title mb-2">${product.nameEn || product.nameJp || '상품명 없음'}</h6>
                            <div class="product-meta mb-2">
                                <span class="badge bg-secondary me-1">${product.brandName || product.brandCode || '브랜드 미상'}</span>
                                <span class="badge bg-${product.stock > 10 ? 'success' : product.stock > 0 ? 'warning' : 'danger'}">
                                    ${product.stock > 10 ? '재고있음' : product.stock > 0 ? '재고부족' : '품절'}
                                </span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="price fw-bold">¥${product.price?.toLocaleString() || '0'}</span>
                                <div class="btn-group">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="editProduct('${product.id}')" title="편집">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="deleteProduct('${product.id}')" title="삭제">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            
            // DOM에 직접 적용
            container.innerHTML = `<div class="row">${searchResultsHTML}</div>`;
            console.log('✅ 검색 결과 직접 DOM 적용 완료');
        }

        // 商品検索クリア
        function clearProductFilters() {
            console.log('🔄 검색 필터 클리어 시작');
            
            // 검색 필드 클리어
            const searchInput = document.getElementById('product-search');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // 브랜드 필터 클리어
            const brandFilter = document.getElementById('brand-filter');
            if (brandFilter) {
                brandFilter.value = '';
            }
            
            // 상품 데이터 소스 확인
            if (window.allProductsList && window.allProductsList.length > 0) {
                filteredProductsList = [...window.allProductsList];
                console.log('📦 전체 상품 복원:', filteredProductsList.length, '개');
            } else if (allProductsList && allProductsList.length > 0) {
                filteredProductsList = [...allProductsList];
                console.log('📦 전체 상품 복원 (로컬):', filteredProductsList.length, '개');
            } else {
                filteredProductsList = [];
                console.log('⚠️ 복원할 상품 데이터가 없습니다');
            }
            
            // 기존 displayProducts와 강제 DOM 조작 모두 시도
            displayProducts();
            forceDisplaySearchResults();
        }


        // 상품 통계 업데이트 함수 (매개변수 추가)
        function updateProductStats(products = null) {
            const productsToCount = products || window.allProductsList || [];
            const totalProducts = productsToCount.length;
            const activeProducts = productsToCount.filter(p => p.status === 'active').length;
            const lowStockProducts = productsToCount.filter(p => p.stock > 0 && p.stock <= 10).length;
            
            const totalProductsEl = document.getElementById('total-products-count');
            const activeProductsEl = document.getElementById('active-products');
            const lowStockProductsEl = document.getElementById('low-stock-products');
            
            if (totalProductsEl) totalProductsEl.textContent = totalProducts;
            if (activeProductsEl) activeProductsEl.textContent = activeProducts;
            if (lowStockProductsEl) lowStockProductsEl.textContent = lowStockProducts;
        }

        // 브랜드 필터 함수 제거됨 (검색만 사용)

        // 모든 상품 이미지 미리보기 초기화
        function clearAllProductImagePreviews() {
            // 메인 이미지 초기화
            const mainPreview = document.getElementById('product-image-preview');
            const mainPlaceholder = document.getElementById('product-upload-placeholder');
            const mainInput = document.getElementById('product-image');
            
            if (mainPreview) mainPreview.style.display = 'none';
            if (mainPlaceholder) mainPlaceholder.style.display = 'block';
            if (mainInput) mainInput.value = '';
            
            // 추가 이미지 1 초기화
            const preview1 = document.getElementById('product-image-1-preview');
            const placeholder1 = document.getElementById('product-upload-placeholder-1');
            const input1 = document.getElementById('product-image-1');
            
            if (preview1) preview1.style.display = 'none';
            if (placeholder1) placeholder1.style.display = 'block';
            if (input1) input1.value = '';
            
            // 추가 이미지 2 초기화
            const preview2 = document.getElementById('product-image-2-preview');
            const placeholder2 = document.getElementById('product-upload-placeholder-2');
            const input2 = document.getElementById('product-image-2');
            
            if (preview2) preview2.style.display = 'none';
            if (placeholder2) placeholder2.style.display = 'block';
            if (input2) input2.value = '';
            
            // 추가 이미지 3 초기화
            const preview3 = document.getElementById('product-image-3-preview');
            const placeholder3 = document.getElementById('product-upload-placeholder-3');
            const input3 = document.getElementById('product-image-3');
            
            if (preview3) preview3.style.display = 'none';
            if (placeholder3) placeholder3.style.display = 'block';
            if (input3) input3.value = '';
            
            // 상세 이미지 초기화
            const detailPreview = document.getElementById('product-detail-image-preview');
            const detailPlaceholder = document.getElementById('product-detail-upload-placeholder');
            const detailInput = document.getElementById('product-detail-image');
            
            if (detailPreview) detailPreview.style.display = 'none';
            if (detailPlaceholder) detailPlaceholder.style.display = 'block';
            if (detailInput) detailInput.value = '';
            
            // 현재 URL 필드 초기화
            const currentUrlField = document.getElementById('product-current-url');
            if (currentUrlField) currentUrlField.value = '';
            
            console.log('모든 상품 이미지 미리보기 초기화 완료');
        }

        // 商品画像削除機能
        async function deleteProductImage(imageType) {
            if (!confirm('この画像を削除しますか？')) {
                return;
            }
            
            try {
                let imageUrl = '';
                let deletedFromFirebase = false;
            
            switch (imageType) {
                case 'main':
                    // メイン画像削除
                    const mainPreview = document.getElementById('product-image-preview');
                    const mainPlaceholder = document.getElementById('product-upload-placeholder');
                    const mainInput = document.getElementById('product-image');
                        const mainImg = document.getElementById('product-preview-img');
                        
                        // 기존 이미지 URL 가져오기
                        imageUrl = mainImg ? mainImg.src : '';
                    
                    mainPreview.style.display = 'none';
                    mainPlaceholder.style.display = 'block';
                    mainInput.value = '';
                    document.getElementById('product-current-url').value = '';
                    break;
                    
                case 'additional1':
                    // 追加画像1削除
                    const preview1 = document.getElementById('product-image-1-preview');
                    const placeholder1 = document.getElementById('product-upload-placeholder-1');
                    const input1 = document.getElementById('product-image-1');
                        const img1 = document.getElementById('product-preview-img-1');
                        
                        imageUrl = img1 ? img1.src : '';
                    
                    preview1.style.display = 'none';
                    placeholder1.style.display = 'block';
                    input1.value = '';
                    break;
                    
                case 'additional2':
                    // 追加画像2削除
                    const preview2 = document.getElementById('product-image-2-preview');
                    const placeholder2 = document.getElementById('product-upload-placeholder-2');
                    const input2 = document.getElementById('product-image-2');
                        const img2 = document.getElementById('product-preview-img-2');
                        
                        imageUrl = img2 ? img2.src : '';
                    
                    preview2.style.display = 'none';
                    placeholder2.style.display = 'block';
                    input2.value = '';
                    break;
                    
                case 'additional3':
                    // 追加画像3削除
                    const preview3 = document.getElementById('product-image-3-preview');
                    const placeholder3 = document.getElementById('product-upload-placeholder-3');
                    const input3 = document.getElementById('product-image-3');
                        const img3 = document.getElementById('product-preview-img-3');
                        
                        imageUrl = img3 ? img3.src : '';
                    
                    preview3.style.display = 'none';
                    placeholder3.style.display = 'block';
                    input3.value = '';
                    break;
                    
                case 'detail':
                    // 詳細画像削除
                    const detailPreview = document.getElementById('product-detail-image-preview');
                    const detailPlaceholder = document.getElementById('product-detail-upload-placeholder');
                    const detailInput = document.getElementById('product-detail-image');
                        const detailImg = document.getElementById('product-detail-preview-img');
                        
                        imageUrl = detailImg ? detailImg.src : '';
                    
                    detailPreview.style.display = 'none';
                    detailPlaceholder.style.display = 'block';
                    detailInput.value = '';
                    break;
            }
            
                // Firebase Storage에서 이미지 삭제
                if (imageUrl && imageUrl.includes('firebasestorage.googleapis.com')) {
                    try {
                        console.log('🗑️ Firebase Storage에서 이미지 삭제 시도:', imageUrl);
                        
                        // Firebase Storage 참조 생성
                        const storage = firebase.storage();
                        const imageRef = storage.refFromURL(imageUrl);
                        
                        // 이미지 삭제
                        await imageRef.delete();
                        console.log('✅ Firebase Storage에서 이미지 삭제 완료');
                        deletedFromFirebase = true;
                        
                    } catch (error) {
                        console.error('❌ Firebase Storage 이미지 삭제 실패:', error);
                        // Firebase 삭제 실패해도 UI에서는 삭제 처리
                    }
                }
                
                // 성공 메시지
                const message = deletedFromFirebase ? 
                    '画像を削除しました（Firebase Storageからも削除されました）。' : 
                    '画像を削除しました。';
                showAlert(message, 'success');
                
            } catch (error) {
                console.error('❌ 이미지 삭제 오류:', error);
                showAlert('画像削除中にエラーが発生しました。', 'danger');
            }
        }

        // モーダル閉じる機能 (확인 없이 바로 닫기)
        function confirmCloseProductModal() {
            try {
                closeProductModal();
            } catch (error) {
                console.error('모달 닫기 오류:', error);
                // 오류 발생 시 강제로 모달 닫기
                closeProductModal();
            }
        }
        
        // 모달 닫기 헬퍼 함수
        function closeProductModal() {
            try {
                const modalElement = document.getElementById('productModal');
                if (modalElement) {
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                    modal.hide();
            } else {
                        // Modal 인스턴스가 없으면 새로 생성해서 닫기
                        const newModal = new bootstrap.Modal(modalElement);
                        newModal.hide();
                    }
                }
            } catch (error) {
                console.error('모달 닫기 실패:', error);
                // 최후의 수단: DOM에서 직접 숨기기
                const modalElement = document.getElementById('productModal');
                if (modalElement) {
                    modalElement.style.display = 'none';
                    modalElement.classList.remove('show');
                    document.body.classList.remove('modal-open');
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }
                }
            }
        }

        // イベントリスナー設定
        const productSearchElement = document.getElementById('product-search');
        
        if (productSearchElement) productSearchElement.addEventListener('input', filterProducts);

        // 브랜드/상품 관리 시스템 초기화는 위의 DOMContentLoaded 이벤트에서 처리됨

        // ========== 홈페이지 관리 시스템 ==========
        
        // 홈페이지 데이터 로드
        window.loadHomepageData = async function() {
            try {
                console.log('🏠 홈페이지 데이터 로드 시작');
                
                // スライダーデータロード
                if (typeof window.loadSlidersData === 'function') {
                    await window.loadSlidersData();
                }
                
                // BEST ITEM 데이터 로드
                if (typeof window.loadBestItemsData === 'function') {
                    await window.loadBestItemsData();
                }
                
                // Featured Product 데이터 로드
                if (typeof window.loadFeaturedProductsData === 'function') {
                    await window.loadFeaturedProductsData();
                }
                
                console.log('✅ 홈페이지 데이터 로드 완료');
                
            } catch (error) {
                console.error('❌ 홈페이지 데이터 로드 오류:', error);
                showAlert('홈페이지 데이터 로드 중 오류가 발생했습니다.', 'danger');
            }
        }

        // スライダーデータロード
        window.loadSlidersData = async function() {
            try {
                console.log('🖼️ 슬라이더 데이터 로드 시작');
                
                let sliders = [];
                
                // 전역 변수에 데이터가 있으면 우선 사용
                const currentSliders = window.getCurrentSliders();
                if (currentSliders && currentSliders.length > 0) {
                    sliders = currentSliders;
                    console.log('📊 전역 변수에서 슬라이더 데이터 로드:', sliders.length, '개');
                } else {
                    // Firebase에서 데이터 로드 시도
                    if (window.firebase && window.firebase.firestore) {
                        const snapshot = await window.firebase.firestore().collection('homepage_sliders').orderBy('order').get();
                        sliders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        console.log('📊 Firebase에서 슬라이더 데이터 로드:', sliders.length, '개');
                    }
                    
                    // 데이터가 없으면 빈 배열로 설정 (Firebase 전용)
                    if (sliders.length === 0) {
                        sliders = [];
                        console.log('📝 Firebase에 슬라이더 데이터 없음');
                    }
                }
                
                // スライダーリスト表示
                window.displaySlidersList(sliders);
                
                console.log('✅ 슬라이더 데이터 로드 완료');
                
            } catch (error) {
                console.error('❌ 슬라이더 데이터 로드 오류:', error);
                window.displaySlidersList([]);
            }
        }

        // 基本スライダーデータ
        // 기본 슬라이더 데이터 제거됨 - Firebase 전용 시스템

        // スライダーリスト表示
        window.displaySlidersList = function(sliders) {
            const container = document.getElementById('sliders-list');
            if (!container) return;
            
            // 전역 변수에 데이터 저장
            window.setCurrentSliders(sliders);
            
            container.innerHTML = sliders.map((slider, index) => `
                <div class="card mb-3 slider-item" data-slider-id="${slider.id}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">スライダー ${index + 1}</h6>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="editSlider('${slider.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="deleteSlider('${slider.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <img src="${slider.brandLogo}" alt="ブランドロゴ" class="img-fluid" style="max-height: 60px;">
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <strong>タイトル:</strong> ${slider.title || 'なし'}
                                </div>
                                <div class="mb-2">
                                    <strong>サブタイトル:</strong> ${slider.subtitle || 'なし'}
                                </div>
                                <div class="mb-2">
                                    <strong>説明:</strong> ${slider.description ? slider.description.substring(0, 100) + '...' : 'なし'}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-2">
                                    <strong>順序:</strong> ${slider.order}
                                </div>
                                <div class="mb-2">
                                    <strong>リンク:</strong> ${slider.link || 'なし'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }



        // 新規スライダー追加
        window.addNewSlider = function() {
            const sliders = window.getCurrentSliders();
            const newOrder = Math.max(...sliders.map(s => s.order), 0) + 1;
            
            const newSlider = {
                id: 'slider-' + Date.now(),
                order: newOrder,
                brandLogo: '',
                title: '',
                subtitle: '',
                description: '',
                bannerImage: '',
                link: ''
            };
            
            sliders.push(newSlider);
            window.displaySlidersList(sliders);
            
            showAlert('新規スライダーが追加されました。', 'success');
        }

        // スライダー編集
        window.editSlider = function(sliderId) {
            const sliders = window.getCurrentSliders();
            const slider = sliders.find(s => s.id === sliderId);
            
            if (!slider) {
                showAlert('スライダーが見つかりません。', 'danger');
                return;
            }
            
            window.openSliderEditModal(slider);
        }
        
        // スライダー編集モーダル開く
        window.openSliderEditModal = function(slider) {
            
            const modalHtml = `
                <div class="slider-custom-modal" id="sliderEditModal" tabindex="-1" aria-labelledby="sliderEditModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="sliderEditModalLabel">
                                    <i class="fas fa-edit me-2"></i>スライダー編集
                                </h5>
                            </div>
                            <div class="modal-body">
                                <form id="sliderEditForm">
                                    <input type="hidden" id="edit-slider-id" value="${slider.id}">
                                    
                                    <div class="row">
                                        <div class="col-md-8">
                                            <div class="mb-3">
                                                <label for="edit-slider-order" class="form-label">順序 <span class="text-danger">*</span></label>
                                                <input type="number" class="form-control" id="edit-slider-order" value="${slider.order}" min="1" required>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <input type="text" class="form-control" id="edit-slider-title" value="${slider.title || ''}" placeholder="タイトル (英語) - 例: Recipe to make you happy">
                                            </div>
                                            
                                            <div class="mb-3">
                                                <input type="text" class="form-control" id="edit-slider-subtitle" value="${slider.subtitle || ''}" placeholder="サブタイトル (日本語) - 例: あなたを楽しませるレシピ">
                                            </div>
                                            
                                            <div class="mb-3">
                                                <textarea class="form-control" id="edit-slider-description" rows="3" placeholder="説明 - スライダー説明を入力してください">${slider.description || ''}</textarea>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="edit-slider-link" class="form-label">リンク URL</label>
                                                <input type="text" class="form-control" id="edit-slider-link" value="${slider.link || ''}" placeholder="例: brand-template.html?brand=lalarecipe">
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="edit-slider-brand-logo" class="form-label">ブランドロゴ</label>
                                                <div class="drag-drop-area" id="brand-logo-drop-area" style="border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; background-color: #f8f9fa; cursor: pointer; transition: all 0.3s ease;">
                                                    <div id="brand-logo-preview" style="display: ${slider.brandLogo ? 'block' : 'none'};">
                                                        <img id="brand-logo-preview-img" src="${slider.brandLogo || ''}" alt="ブランドロゴ" class="img-fluid" style="max-height: 60px; margin-bottom: 10px;" onerror="this.style.display='none'">
                                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="removeBrandLogo()">削除</button>
                                                    </div>
                                                    <div id="brand-logo-upload-text" style="display: ${slider.brandLogo ? 'none' : 'block'};">
                                                        <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                                        <p class="mb-0 text-muted">画像をドラッグ＆ドロップ<br>またはクリックして選択</p>
                                                    </div>
                                                </div>
                                                <input type="hidden" id="edit-slider-brand-logo" value="${slider.brandLogo || ''}">
                                                <div class="form-text text-muted">
                                                    <i class="fas fa-info-circle me-1"></i>推奨サイズ: 120x60px (メインスライダー上部に表示)
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="edit-slider-banner-image" class="form-label">バナー画像</label>
                                                <div class="drag-drop-area" id="banner-image-drop-area" style="border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; background-color: #f8f9fa; cursor: pointer; transition: all 0.3s ease;">
                                                    <div id="banner-image-preview" style="display: ${slider.bannerImage ? 'block' : 'none'};">
                                                        <img id="banner-image-preview-img" src="${slider.bannerImage || ''}" alt="バナー画像" class="img-fluid" style="max-height: 120px; margin-bottom: 10px;" onerror="this.style.display='none'">
                                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="removeBannerImage()">削除</button>
                                                    </div>
                                                    <div id="banner-image-upload-text" style="display: ${slider.bannerImage ? 'none' : 'block'};">
                                                        <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                                        <p class="mb-0 text-muted">画像をドラッグ＆ドロップ<br>またはクリックして選択</p>
                                                    </div>
                                                </div>
                                                <input type="hidden" id="edit-slider-banner-image" value="${slider.bannerImage || ''}">
                                                <div class="form-text text-muted">
                                                    <i class="fas fa-info-circle me-1"></i>推奨サイズ: 800x400px (メインスライダー背景に表示)
                                                </div>
                                            </div>
                                            
                                            <div class="card">
                                                <div class="card-header">
                                                    <h6 class="japanese-heading mb-0">プレビュー</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div id="slider-edit-preview">
                                                        <!-- プレビューがここに動的に表示されます -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeSliderEditModal()">
                                    <i class="fas fa-times me-2"></i>キャンセル
                                </button>
                                <button type="button" class="btn btn-dark" onclick="saveSliderEdit()">
                                    <i class="fas fa-save me-2"></i>保存
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 기존 모달 제거
            const existingModal = document.getElementById('sliderEditModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 새 모달 추가
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 모달 표시 (커스텀 방식)
            const modalElement = document.getElementById('sliderEditModal');
            if (modalElement) {
                modalElement.classList.add('show');
                
                // 모달 외부 클릭 시 닫기
                modalElement.addEventListener('click', function(e) {
                    if (e.target === modalElement) {
                        window.closeSliderEditModal();
                    }
                });
                
                // ESC 키로 모달 닫기
                const handleEscape = function(e) {
                    if (e.key === 'Escape') {
                        window.closeSliderEditModal();
                        document.removeEventListener('keydown', handleEscape);
                    }
                };
                document.addEventListener('keydown', handleEscape);
            }
            
            // 실시간 미리보기 업데이트
            setupSliderEditPreview();
            // 초기 프리뷰 표시
            setTimeout(() => {
                updateSliderEditPreview();
                // 초기 이미지 프리뷰 설정
                setupInitialImagePreviews();
            }, 100);
        }
        
        // スライダー編集モーダル閉じる
        window.closeSliderEditModal = function() {
            const modalElement = document.getElementById('sliderEditModal');
            if (modalElement) {
                // 모달 숨기기
                modalElement.classList.remove('show');
                
                // 모달 요소 제거
                setTimeout(() => {
                    if (modalElement && modalElement.parentNode) {
                        modalElement.parentNode.removeChild(modalElement);
                    }
                }, 300);
            }
        }
        
        // スライダー編集プレビュー設定
        window.setupSliderEditPreview = function() {
            const inputs = ['edit-slider-title', 'edit-slider-subtitle', 'edit-slider-description', 'edit-slider-order', 'edit-slider-brand-logo', 'edit-slider-banner-image'];
            
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', updateSliderEditPreview);
                }
            });
            
            // 드래그 앤 드롭 설정
            setupDragAndDrop();
            
            // 초기 이미지 프리뷰 설정
            setupInitialImagePreviews();
        }
        
        // 드래그 앤 드롭 설정
        function setupDragAndDrop() {
            const brandLogoArea = document.getElementById('brand-logo-drop-area');
            const bannerImageArea = document.getElementById('banner-image-drop-area');
            
            if (brandLogoArea) {
                brandLogoArea.addEventListener('dragover', handleDragOver);
                brandLogoArea.addEventListener('dragleave', handleDragLeave);
                brandLogoArea.addEventListener('drop', (e) => handleDrop(e, 'brand-logo'));
                brandLogoArea.addEventListener('click', () => openFileDialog('brand-logo'));
                brandLogoArea.addEventListener('mouseenter', handleMouseEnter);
                brandLogoArea.addEventListener('mouseleave', handleMouseLeave);
            }
            
            if (bannerImageArea) {
                bannerImageArea.addEventListener('dragover', handleDragOver);
                bannerImageArea.addEventListener('dragleave', handleDragLeave);
                bannerImageArea.addEventListener('drop', (e) => handleDrop(e, 'banner-image'));
                bannerImageArea.addEventListener('click', () => openFileDialog('banner-image'));
                bannerImageArea.addEventListener('mouseenter', handleMouseEnter);
                bannerImageArea.addEventListener('mouseleave', handleMouseLeave);
            }
        }
        
        // 마우스 진입 처리
        function handleMouseEnter(e) {
            e.currentTarget.style.borderColor = '#007bff';
            e.currentTarget.style.backgroundColor = '#e3f2fd';
        }
        
        // 마우스 이탈 처리
        function handleMouseLeave(e) {
            e.currentTarget.style.borderColor = '#ccc';
            e.currentTarget.style.backgroundColor = '#f8f9fa';
        }
        
        // 드래그 이탈 처리
        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.style.borderColor = '#ccc';
            e.currentTarget.style.backgroundColor = '#f8f9fa';
        }
        
        // 드래그 오버 처리
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.style.borderColor = '#007bff';
            e.currentTarget.style.backgroundColor = '#e3f2fd';
        }
        
        // 드롭 처리
        function handleDrop(e, type) {
            e.preventDefault();
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageUrl = e.target.result;
                        updateImagePreview(type, imageUrl);
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            // 스타일 복원
            e.currentTarget.style.borderColor = '#ccc';
            e.currentTarget.style.backgroundColor = '#f8f9fa';
        }
        
        // 파일 다이얼로그 열기
        function openFileDialog(type) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageUrl = e.target.result;
                        updateImagePreview(type, imageUrl);
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }
        
        // 이미지 프리뷰 업데이트
        function updateImagePreview(type, imageUrl) {
            const hiddenInput = document.getElementById(`edit-slider-${type === 'brand-logo' ? 'brand-logo' : 'banner-image'}`);
            const previewDiv = document.getElementById(`${type}-preview`);
            const previewImg = document.getElementById(`${type}-preview-img`);
            const uploadTextDiv = document.getElementById(`${type}-upload-text`);
            
            if (hiddenInput && previewDiv && previewImg && uploadTextDiv) {
                hiddenInput.value = imageUrl;
                previewImg.src = imageUrl;
                
                if (imageUrl && imageUrl.trim() !== '') {
                    previewDiv.style.display = 'block';
                    uploadTextDiv.style.display = 'none';
                } else {
                    previewDiv.style.display = 'none';
                    uploadTextDiv.style.display = 'block';
                }
                
                // 프리뷰 업데이트
                updateSliderEditPreview();
            }
        }
        
        // 브랜드 로고 삭제
        window.removeBrandLogo = function() {
            updateImagePreview('brand-logo', '');
            const previewDiv = document.getElementById('brand-logo-preview');
            const uploadTextDiv = document.getElementById('brand-logo-upload-text');
            if (previewDiv && uploadTextDiv) {
                previewDiv.style.display = 'none';
                uploadTextDiv.style.display = 'block';
            }
        }
        
        // 배너 이미지 삭제
        window.removeBannerImage = function() {
            updateImagePreview('banner-image', '');
            const previewDiv = document.getElementById('banner-image-preview');
            const uploadTextDiv = document.getElementById('banner-image-upload-text');
            if (previewDiv && uploadTextDiv) {
                previewDiv.style.display = 'none';
                uploadTextDiv.style.display = 'block';
            }
        }
        
        // 초기 이미지 프리뷰 설정
        function setupInitialImagePreviews() {
            const brandLogoInput = document.getElementById('edit-slider-brand-logo');
            const bannerImageInput = document.getElementById('edit-slider-banner-image');
            
            if (brandLogoInput && brandLogoInput.value) {
                updateImagePreview('brand-logo', brandLogoInput.value);
            }
            
            if (bannerImageInput && bannerImageInput.value) {
                updateImagePreview('banner-image', bannerImageInput.value);
            }
        }
        
        // スライダー編集プレビュー更新
        window.updateSliderEditPreview = function() {
            const editSliderTitleElement = document.getElementById('edit-slider-title');
            const editSliderSubtitleElement = document.getElementById('edit-slider-subtitle');
            const editSliderDescriptionElement = document.getElementById('edit-slider-description');
            const editSliderOrderElement = document.getElementById('edit-slider-order');
            const editSliderBrandLogoElement = document.getElementById('edit-slider-brand-logo');
            const editSliderBannerImageElement = document.getElementById('edit-slider-banner-image');
            
            const title = editSliderTitleElement ? editSliderTitleElement.value : '';
            const subtitle = editSliderSubtitleElement ? editSliderSubtitleElement.value : '';
            const description = editSliderDescriptionElement ? editSliderDescriptionElement.value : '';
            const order = editSliderOrderElement ? editSliderOrderElement.value : '';
            const brandLogo = editSliderBrandLogoElement ? editSliderBrandLogoElement.value : '';
            const bannerImage = editSliderBannerImageElement ? editSliderBannerImageElement.value : '';
            
            // 미리보기 컨테이너 업데이트
            const previewContainer = document.getElementById('slider-edit-preview');
            if (previewContainer) {
                previewContainer.innerHTML = `
                    <div class="border rounded p-3">
                        <div class="text-center mb-3">
                            <img src="${brandLogo}" alt="ブランドロゴ" class="img-fluid" style="max-height: 40px;" onerror="this.style.display='none'">
                        </div>
                        <div class="mb-2">
                            <strong>${title || 'なし'}</strong>
                        </div>
                        <div class="mb-2">
                            <strong>${subtitle || 'なし'}</strong>
                        </div>
                        <div class="mb-2">
                            ${description ? description.substring(0, 50) + '...' : 'なし'}
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">順序: ${order}</small>
                        </div>
                        ${bannerImage ? `
                            <div class="mt-3">
                                <img src="${bannerImage}" alt="バナー画像" class="img-fluid rounded" style="max-height: 150px;" onerror="this.style.display='none'">
                            </div>
                        ` : ''}
                    </div>
                `;
            }
        }
        
        // スライダー編集保存
        window.saveSliderEdit = function() {
            const sliderId = document.getElementById('edit-slider-id').value;
            const order = document.getElementById('edit-slider-order').value;
            const title = document.getElementById('edit-slider-title').value;
            const subtitle = document.getElementById('edit-slider-subtitle').value;
            const description = document.getElementById('edit-slider-description').value;
            const link = document.getElementById('edit-slider-link').value;
            const brandLogo = document.getElementById('edit-slider-brand-logo').value;
            const bannerImage = document.getElementById('edit-slider-banner-image').value;
            
            if (!order) {
                showAlert('順序を入力してください。', 'danger');
                return;
            }
            
            // 現在のスライダーリスト更新
            const sliders = window.getCurrentSliders();
            const sliderIndex = sliders.findIndex(s => s.id === sliderId);
            
            if (sliderIndex !== -1) {
                sliders[sliderIndex] = {
                    ...sliders[sliderIndex],
                    order: parseInt(order),
                    title: title,
                    subtitle: subtitle,
                    description: description,
                    link: link,
                    brandLogo: brandLogo,
                    bannerImage: bannerImage
                };
                
                // 목록 다시 표시
                window.displaySlidersList(sliders);
                
                showAlert('スライダーが更新されました。', 'success');
                
                // 모달 닫기 및 정리
                const modalElement = document.getElementById('sliderEditModal');
                if (modalElement) {
                    // 모달 숨기기
                    modalElement.classList.remove('show');
                    
                    // 모달 요소 제거
                    setTimeout(() => {
                        if (modalElement && modalElement.parentNode) {
                            modalElement.parentNode.removeChild(modalElement);
                        }
                    }, 300);
                }
            } else {
                showAlert('スライダーが見つかりません。', 'danger');
            }
        }

        // スライダー削除
        window.deleteSlider = function(sliderId) {
            if (!confirm('このスライダーを削除しますか？')) {
                return;
            }
            
            const sliders = window.getCurrentSliders().filter(s => s.id !== sliderId);
            window.displaySlidersList(sliders);
            
            showAlert('スライダーが削除されました。', 'success');
        }

        // 전역 슬라이더 데이터 변수
        window.currentSliders = [];
        

        
        // 슬라이더 모달만을 위한 커스텀 스타일 추가
        function addSliderModalStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .slider-custom-modal {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    z-index: 1055;
                    display: none;
                    overflow-y: auto;
                }
                .slider-custom-modal.show {
                    display: block;
                }
                .slider-custom-modal .modal-dialog {
                    position: relative;
                    width: auto;
                    margin: 1rem;
                    pointer-events: none;
                    max-height: calc(100vh - 2rem);
                    display: flex;
                    align-items: flex-start;
                    padding-top: 2rem;
                }
                .slider-custom-modal .modal-content {
                    position: relative;
                    display: flex;
                    flex-direction: column;
                    width: 100%;
                    pointer-events: auto;
                    background-color: #fff;
                    background-clip: padding-box;
                    border: 1px solid rgba(0, 0, 0, 0.2);
                    border-radius: 0.3rem;
                    outline: 0;
                    max-height: calc(100vh - 4rem);
                    overflow: hidden;
                }
                .slider-custom-modal .modal-body {
                    overflow-y: auto;
                    flex: 1;
                    max-height: calc(100vh - 250px);
                    padding: 1rem;
                }
                .slider-custom-modal .modal-header,
                .slider-custom-modal .modal-footer {
                    flex-shrink: 0;
                }
                
                /* BEST ITEM 관리 모달 스크롤 문제 해결 */
                #bestItemModal .modal-body {
                    overflow-y: auto;
                    max-height: calc(100vh - 200px);
                }
                #bestItemModal .modal-content {
                    overflow: hidden;
                }
                #bestItemModal {
                    overflow: hidden !important;
                }
            `;
            document.head.appendChild(style);
        }
        
        // 페이지 로드 시 슬라이더 모달 스타일 추가
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', addSliderModalStyles);
        } else {
            addSliderModalStyles();
        }
        
        // 날짜 입력 필드 일본어 설정 (기존 요소 제거 후 새로 생성)
        function setJapaneseDatePlaceholders() {
            const dateInputs = document.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => {
                // 뱃지 날짜 필드는 건드리지 않음
                if (input.id === 'brand-badge-start' || input.id === 'brand-badge-end') {
                    return;
                }
                // 기존 커스텀 플레이스홀더 제거
                const existingPlaceholder = input.parentNode.querySelector('.custom-date-placeholder');
                if (existingPlaceholder) {
                    existingPlaceholder.remove();
                }
                
                // 기존 컨테이너가 있다면 제거
                if (input.parentNode.classList.contains('custom-date-input-container')) {
                    const parent = input.parentNode;
                    const grandParent = parent.parentNode;
                    grandParent.insertBefore(input, parent);
                    grandParent.removeChild(parent);
                }
                
                // 새로운 컨테이너 생성
                const container = document.createElement('div');
                container.className = 'custom-date-input-container';
                
                // 입력 필드 속성 설정
                input.setAttribute('lang', 'ja');
                input.setAttribute('locale', 'ja-JP');
                input.setAttribute('data-locale', 'ja-JP');
                input.removeAttribute('placeholder'); // 기본 플레이스홀더 제거
                
                // 원래 부모에 컨테이너 추가
                const originalParent = input.parentNode;
                originalParent.insertBefore(container, input);
                originalParent.removeChild(input);
                
                // 컨테이너에 입력 필드 추가
                container.appendChild(input);
                
                // 커스텀 플레이스홀더 생성 함수
                const createCustomPlaceholder = function() {
                    // 기존 플레이스홀더 제거
                    const existing = this.parentNode.querySelector('.custom-date-placeholder');
                    if (existing) {
                        existing.remove();
                    }
                    
                    // 빈 값일 때만 플레이스홀더 표시
                    if (!this.value) {
                        const placeholder = document.createElement('span');
                        placeholder.className = 'custom-date-placeholder';
                        placeholder.textContent = '年. 月. 日.';
                        this.parentNode.appendChild(placeholder);
                    }
                };
                
                // 이벤트 리스너 추가
                const handleEvents = function() {
                    createCustomPlaceholder.call(this);
                };
                
                input.addEventListener('focus', handleEvents);
                input.addEventListener('click', handleEvents);
                input.addEventListener('input', handleEvents);
                input.addEventListener('blur', handleEvents);
                input.addEventListener('change', handleEvents);
                
                // 즉시 실행
                createCustomPlaceholder.call(input);
            });
        }
        
        // 페이지 로드 시 실행
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setJapaneseDatePlaceholders);
        } else {
            setJapaneseDatePlaceholders();
        }
        
        // 모달이 열릴 때마다 실행
        document.addEventListener('shown.bs.modal', setJapaneseDatePlaceholders);
        

        
        // 슬라이더 모달만을 위한 커스텀 처리
        // 다른 Bootstrap 모달들은 그대로 사용
        
        // 現在のスライダーデータ取得
        window.getCurrentSliders = function() {
            return window.currentSliders || [];
        }
        
        // 슬라이더 데이터 설정
        window.setCurrentSliders = function(sliders) {
            window.currentSliders = sliders || [];
        }

        // 슬라이더 저장
        window.saveSliders = async function() {
            try {
                const sliders = window.getCurrentSliders();
                
                if (window.firebase && window.firebase.firestore) {
                    const batch = window.firebase.firestore().batch();
                    
                    // 기존 데이터 삭제
                    const existingSnapshot = await window.firebase.firestore().collection('homepage_sliders').get();
                    existingSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    // 새 데이터 추가
                    sliders.forEach(slider => {
                        const docRef = window.firebase.firestore().collection('homepage_sliders').doc();
                        batch.set(docRef, slider);
                    });
                    
                    await batch.commit();
                    console.log('✅ 슬라이더 데이터 저장 완료');
                }
                
                showAlert('スライダーが保存されました。', 'success');
                
                // 모달 닫기 및 정리
                const modalElement = document.getElementById('sliderModal');
                if (modalElement) {
                    // 모달 숨기기
                    modalElement.classList.remove('show');
                    
                    // 모달 요소 제거
                    setTimeout(() => {
                        if (modalElement && modalElement.parentNode) {
                            modalElement.parentNode.removeChild(modalElement);
                        }
                    }, 300);
                }
                
            } catch (error) {
                console.error('❌ 슬라이더 저장 오류:', error);
                showAlert('スライダー保存中にエラーが発生しました。', 'danger');
            }
        }

        // BEST ITEM 데이터 로드
        window.loadBestItemsData = async function() {
            try {
                console.log('⭐ BEST ITEM 데이터 로드 시작');
                
                let bestItems = [];
                
                // 전역 변수에 데이터가 있으면 우선 사용
                if (window.currentBestItems && window.currentBestItems.length > 0) {
                    bestItems = window.currentBestItems;
                    console.log('📊 전역 변수에서 BEST ITEM 데이터 로드:', bestItems.length, '개');
                } else {
                    // Firebase에서 데이터 로드 시도
                    if (window.firebase && window.firebase.firestore) {
                        const snapshot = await window.firebase.firestore().collection('homepage_best_items').orderBy('order').get();
                        bestItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        console.log('📊 Firebase에서 BEST ITEM 데이터 로드:', bestItems.length, '개');
                    }
                    
                    // 데이터가 없으면 빈 배열로 설정 (Firebase 전용)
                    if (bestItems.length === 0) {
                        bestItems = [];
                        console.log('📝 Firebase에 BEST ITEM 데이터 없음');
                    }
                    
                    // 전역 변수에 저장
                    window.currentBestItems = bestItems;
                }
                
                // BEST ITEM 목록 표시
                window.displayBestItemsList(bestItems);
                
                console.log('✅ BEST ITEM 데이터 로드 완료');
                
            } catch (error) {
                console.error('❌ BEST ITEM 데이터 로드 오류:', error);
                window.displayBestItemsList([]);
            }
        }

        // 기본 BEST ITEM 데이터 제거됨 - Firebase 전용 시스템

        // BEST ITEM 목록 표시
        window.displayBestItemsList = function(bestItems) {
            const container = document.getElementById('best-items-list');
            if (!container) return;
            
            container.innerHTML = bestItems.map((item, index) => `
                <div class="card mb-3 best-item" data-item-id="${item.id}">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <img src="${item.image}" alt="제품 이미지" class="img-fluid rounded">
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2">
                                    ${item.brandName}
                                </div>
                                <div class="mb-2">
                                    ${item.productName}
                                </div>
                                <div class="mb-2">
                                    ${item.link || 'なし'}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-2">
                                    ${item.order}
                                </div>
                                                                  <button class="btn btn-sm btn-outline-secondary" onclick="editBestItem('${item.id}')">
                                      <i class="fas fa-edit"></i> 編集
                                  </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Featured Product 데이터 로드
        window.loadFeaturedProductsData = async function() {
            try {
                console.log('🎁 Featured Product 데이터 로드 시작');
                
                let featuredProducts = [];
                
                // 전역 변수에 데이터가 있으면 우선 사용
                if (window.currentFeaturedProducts && window.currentFeaturedProducts.length > 0) {
                    featuredProducts = window.currentFeaturedProducts;
                    console.log('📝 현재 Featured Product 데이터 사용');
                } else {
                    // Firebase에서 데이터 로드 시도
                    if (window.firebase && window.firebase.firestore) {
                        const snapshot = await window.firebase.firestore().collection('homepage_featured_products').orderBy('order').get();
                        featuredProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        console.log('📊 Firebase에서 Featured Product 데이터 로드:', featuredProducts.length, '개');
                    }
                    
                    // 데이터가 없으면 빈 배열로 설정 (Firebase 전용)
                    if (featuredProducts.length === 0) {
                        featuredProducts = [];
                        console.log('📝 Firebase에 Featured Product 데이터 없음');
                    }
                }
                
                // 전역 변수에 저장
                window.currentFeaturedProducts = featuredProducts;
                
                console.log('📊 Featured Product 데이터 로드 결과:', {
                    loadedProducts: featuredProducts,
                    globalVariable: window.currentFeaturedProducts
                });
                
                // Featured Product 목록 표시
                window.displayFeaturedProductsList(featuredProducts);
                
                console.log('✅ Featured Product 데이터 로드 완료');
                
            } catch (error) {
                console.error('❌ Featured Product 데이터 로드 오류:', error);
                window.currentFeaturedProducts = [];
                window.displayFeaturedProductsList([]);
            }
        }

        // 기본 Featured Product 데이터 제거됨 - Firebase 전용 시스템

        // Featured Product 목록 표시
        window.displayFeaturedProductsList = function(featuredProducts) {
            const container = document.getElementById('featured-products-list');
            if (!container) return;
            
            container.innerHTML = featuredProducts.map((product, index) => `
                <div class="card mb-3 featured-product" data-product-id="${product.id}">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <img src="${product.image}" alt="商品画像" class="img-fluid rounded">
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <strong>ブランド:</strong> ${product.brandName}
                                </div>
                                <div class="mb-2">
                                    <strong>商品名:</strong> ${product.productName}
                                </div>
                                <div class="mb-2">
                                    <strong>価格:</strong> ¥${product.price.toLocaleString()}
                                </div>
                                <div class="mb-2">
                                    <strong>リンク:</strong> ${product.link || 'なし'}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-2">
                                    <strong>順序:</strong> ${product.order}
                                </div>
                                                                  <button class="btn btn-sm btn-outline-secondary" onclick="editFeaturedProduct('${product.id}')">
                                      <i class="fas fa-edit"></i> 編集
                                  </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // BEST ITEM 저장
        window.saveBestItems = async function() {
            try {
                const bestItems = window.getCurrentBestItems(); // 현재 수정된 데이터 사용
                
                if (window.firebase && window.firebase.firestore) {
                    const batch = window.firebase.firestore().batch();
                    
                    // 기존 데이터 삭제
                    const existingSnapshot = await window.firebase.firestore().collection('homepage_best_items').get();
                    existingSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    // 새 데이터 추가
                    bestItems.forEach(item => {
                        const docRef = window.firebase.firestore().collection('homepage_best_items').doc();
                        batch.set(docRef, item);
                    });
                    
                    await batch.commit();
                    console.log('✅ BEST ITEM 데이터 저장 완료');
                }
                
                showAlert('BEST ITEMが保存されました。', 'success');
                closeBestItemModal();
                
            } catch (error) {
                console.error('❌ BEST ITEM 저장 오류:', error);
                showAlert('BEST ITEM保存中にエラーが発生しました。', 'danger');
            }
        }

        // Featured Product 저장
        window.saveFeaturedProducts = async function() {
            try {
                const featuredProducts = window.getCurrentFeaturedProducts(); // 현재 수정된 데이터 사용
                
                if (window.firebase && window.firebase.firestore) {
                    const batch = window.firebase.firestore().batch();
                    
                    // 기존 데이터 삭제
                    const existingSnapshot = await window.firebase.firestore().collection('homepage_featured_products').get();
                    existingSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    // 새 데이터 추가
                    featuredProducts.forEach(product => {
                        const docRef = window.firebase.firestore().collection('homepage_featured_products').doc();
                        batch.set(docRef, product);
                    });
                    
                    await batch.commit();
                    console.log('✅ Featured Product 데이터 저장 완료');
                    
                    // 인덱스 페이지 Featured Product 업데이트
                    if (typeof window.updateFeaturedProductContent === 'function') {
                        try {
                            await window.updateFeaturedProductContent();
                            console.log('✅ 인덱스 페이지 Featured Product 업데이트 완료');
                        } catch (error) {
                            console.error('❌ 인덱스 페이지 Featured Product 업데이트 오류:', error);
                        }
                    }
                }
                
                showAlert('Featured Productが保存されました。', 'success');
                closeFeaturedProductModal();
                
            } catch (error) {
                console.error('❌ Featured Product 저장 오류:', error);
                showAlert('Featured Product保存中にエラーが発生しました。', 'danger');
            }
        }

        // ========== 푸터 관리 시스템 ==========
        
        // 푸터 데이터 로드
        window.loadFooterData = async function() {
            try {
                console.log('🦶 푸터 데이터 로드 시작');
                
                let footerData = {};
                
                // Firebase에서 데이터 로드 시도
                if (window.firebase && window.firebase.firestore) {
                    const snapshot = await window.firebase.firestore().collection('footer_content').limit(1).get();
                    if (!snapshot.empty) {
                        footerData = snapshot.docs[0].data();
                        console.log('📊 Firebase에서 푸터 데이터 로드 완료');
                    }
                }
                
                // 데이터가 없으면 빈 객체로 설정 (Firebase 전용)
                if (Object.keys(footerData).length === 0) {
                    footerData = { companyInfo: [], furtherInfoLinks: [], brandNames: [] };
                    console.log('📝 Firebase에 푸터 데이터 없음');
                }
                
                // 푸터 폼에 데이터 설정
                window.setFooterFormData(footerData);
                
                console.log('✅ 푸터 데이터 로드 완료');
                
            } catch (error) {
                console.error('❌ 푸터 데이터 로드 오류:', error);
                const emptyFooterData = { companyInfo: [], furtherInfoLinks: [], brandNames: [] };
                window.setFooterFormData(emptyFooterData);
            }
        }

        // 기본 푸터 데이터 생성 (Firebase 초기화용)
        window.createDefaultFooterData = async function() {
            try {
                console.log('🦶 기본 푸터 데이터 생성 시작');
                
                const defaultFooterData = {
                companyInfo: [
                        { type: 'address', name: '住所', value: '〒169-0072 東京都新宿区大久保2丁目21-10 ジュネス大久保 102号', order: 1 },
                        { type: 'email', name: 'メールアドレス', value: 'aether7info@gmail.com', order: 2 },
                        { type: 'phone', name: '電話番号', value: '03.3200.5547', order: 3 },
                        { type: 'fax', name: 'ファックス', value: '03.3200.5548', order: 4 },
                        { type: 'hours', name: '営業時間', value: '平日 9:00-18:00', order: 5 }
                ],
                furtherInfoLinks: [
                    { name: 'Home', link: 'index.html', order: 1 },
                    { name: 'About Us', link: 'about.html', order: 2 },
                    { name: 'Shop Locations', link: 'shop.html', order: 3 },
                    { name: 'FAQs', link: 'faqs.html', order: 4 },
                    { name: 'Contact', link: 'contact.html', order: 5 }
                ],
                brandNames: [
                    { name: 'LALARECIPE', link: 'brands/lalarecipe.html', order: 1 },
                    { name: 'LUCINDE', link: 'brands/lucinde.html', order: 2 },
                    { name: 'COSCELL', link: 'brands/coscell.html', order: 3 },
                    { name: 'Make heal', link: 'brands/makeheal.html', order: 4 },
                    { name: 'Monday Museum', link: 'brands/mondaymuseum.html', order: 5 },
                    { name: 'Plareceta', link: 'brands/plareceta.html', order: 6 },
                    { name: 'Catch By Sonyouna', link: 'brands/catchbysonyouna.html', order: 7 },
                    { name: 'Medipeel', link: 'brands/medipeel.html', order: 8 },
                    { name: 'Dancing Whale', link: 'brands/dancingwhale.html', order: 9 }
                    ],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                if (window.firebase && window.firebase.firestore) {
                    // 기존 데이터 삭제 후 새 데이터 추가
                    const existingSnapshot = await window.firebase.firestore().collection('footer_content').get();
                    const batch = window.firebase.firestore().batch();
                    
                    existingSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    const docRef = window.firebase.firestore().collection('footer_content').doc();
                    batch.set(docRef, defaultFooterData);
                    
                    await batch.commit();
                    console.log('✅ 기본 푸터 데이터 생성 완료');
                    showAlert('기본 푸터 데이터가 생성되었습니다.', 'success');
                } else {
                    console.error('Firebase가 초기화되지 않았습니다.');
                    showAlert('Firebase 연결을 확인해주세요.', 'error');
                }
                
            } catch (error) {
                console.error('❌ 기본 푸터 데이터 생성 오류:', error);
                showAlert('기본 푸터 데이터 생성에 실패했습니다.', 'error');
            }
        }

        // 푸터 폼에 데이터 설정
        window.setFooterFormData = function(data) {
            // 회사 정보 필드 설정
            window.setCompanyInfoFields(data.companyInfo || []);
            
            // 브랜드명 리스트 설정
            window.displayBrandNames(data.brandNames || []);
            
            // Further Info 링크 리스트 설정
            window.displayFurtherInfoLinks(data.furtherInfoLinks || []);
        }

        // 회사 정보 필드 설정
        window.setCompanyInfoFields = function(companyInfo) {
            // 필드 매핑
            const fieldMapping = {
                'address': 'company-address',
                'email': 'company-email', 
                'phone': 'company-phone',
                'fax': 'company-fax',
                'hours': 'company-hours'
            };

            // 각 필드 초기화
            Object.values(fieldMapping).forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.value = '';
            });

            // 데이터 설정
            companyInfo.forEach(info => {
                const fieldId = fieldMapping[info.type];
                if (fieldId) {
                    const field = document.getElementById(fieldId);
                    if (field) field.value = info.value;
                }
            });
        }

        // 회사 정보 필드에서 데이터 가져오기
        window.getCompanyInfoFromFields = function() {
            const companyInfo = [];
            
            // 필드 매핑과 순서
            const fieldMapping = [
                { type: 'address', id: 'company-address', name: '住所', order: 1 },
                { type: 'email', id: 'company-email', name: 'メールアドレス', order: 2 },
                { type: 'phone', id: 'company-phone', name: '電話番号', order: 3 },
                { type: 'fax', id: 'company-fax', name: 'ファックス', order: 4 },
                { type: 'hours', id: 'company-hours', name: '営業時間', order: 5 }
            ];

            fieldMapping.forEach(field => {
                const input = document.getElementById(field.id);
                if (input && input.value.trim()) {
                    companyInfo.push({
                        type: field.type,
                        name: field.name,
                        value: input.value.trim(),
                        order: field.order
                    });
                }
            });

            return companyInfo;
        }

        // 브랜드명 리스트 표시
        window.displayBrandNames = function(brandNames) {
            const brandListContainer = document.getElementById('brand-names-list');
            if (!brandListContainer) return;
            
            if (brandNames.length === 0) {
                brandListContainer.innerHTML = '<p class="text-muted">ブランドが登録されていません。</p>';
                return;
            }
            
            // 순서대로 정렬 (order 속성이 있는 경우)
            const sortedBrands = [...brandNames].sort((a, b) => {
                const orderA = typeof a === 'object' && a.order ? a.order : 999;
                const orderB = typeof b === 'object' && b.order ? b.order : 999;
                return orderA - orderB;
            });
            
            let html = '';
            sortedBrands.forEach((brand, index) => {
                // 기존 문자열 형태와 새로운 객체 형태 모두 지원
                const brandName = typeof brand === 'string' ? brand : brand.name;
                const brandLink = typeof brand === 'string' ? '#' : (brand.link || '#');
                const brandOrder = typeof brand === 'object' && brand.order ? brand.order : index + 1;
                
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-secondary me-2">${brandOrder}</span>
                            <a href="${brandLink}" class="brand-name-link me-2" target="_blank" style="text-decoration: none; color: #333;">
                                <i class="fas fa-external-link-alt me-1"></i>${brandName}
                            </a>
                            <small class="text-muted">${brandLink}</small>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-secondary" onclick="window.moveBrandName(${index}, -1)" ${index === 0 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="window.moveBrandName(${index}, 1)" ${index === sortedBrands.length - 1 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-down"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="window.removeBrandName(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            brandListContainer.innerHTML = html;
        }

        // 브랜드명 추가
        window.addBrandName = function() {
            const newBrandInput = document.getElementById('new-brand-name');
            const newBrandLinkInput = document.getElementById('new-brand-link');
            if (!newBrandInput || !newBrandLinkInput) return;
            
            const newBrandName = newBrandInput.value.trim();
            const newBrandLink = newBrandLinkInput.value.trim();
            
            if (!newBrandName) {
                showAlert('ブランド名を入力してください。', 'warning');
                return;
            }
            
            if (!newBrandLink) {
                showAlert('ブランドリンクを入力してください。', 'warning');
                return;
            }
            
            // 현재 브랜드명 리스트 가져오기
            const currentBrands = window.getCurrentBrands();
            
            // 중복 확인
            const existingBrand = currentBrands.find(brand => {
                const brandName = typeof brand === 'string' ? brand : brand.name;
                return brandName === newBrandName;
            });
            
            if (existingBrand) {
                showAlert('このブランド名は既に登録されています。', 'warning');
                return;
            }
            
            // 새 브랜드 추가 (객체 형태, 순서는 마지막 + 1)
            const newOrder = currentBrands.length > 0 ? Math.max(...currentBrands.map(b => b.order || 0)) + 1 : 1;
            currentBrands.push({ name: newBrandName, link: newBrandLink, order: newOrder });
            
            // 화면 업데이트
            window.displayBrandNames(currentBrands);
            
            // 입력 필드 초기화
            newBrandInput.value = '';
            newBrandLinkInput.value = '';
            
            showAlert('ブランドが追加されました。', 'success');
        }

        // 브랜드명 삭제
        window.removeBrandName = function(index) {
            if (confirm('このブランドを削除しますか？')) {
                const currentBrands = window.getCurrentBrands();
                currentBrands.splice(index, 1);
                
                // 순서 재정렬
                currentBrands.forEach((brand, idx) => {
                    if (typeof brand === 'object') {
                        brand.order = idx + 1;
                    }
                });
                
                window.displayBrandNames(currentBrands);
                showAlert('ブランドが削除されました。', 'success');
            }
        }

        // 브랜드명 순서 변경
        window.moveBrandName = function(index, direction) {
            const currentBrands = window.getCurrentBrands();
            const newIndex = index + direction;
            
            if (newIndex < 0 || newIndex >= currentBrands.length) return;
            
            // 순서 교환
            const temp = currentBrands[index].order;
            currentBrands[index].order = currentBrands[newIndex].order;
            currentBrands[newIndex].order = temp;
            
            // 화면 업데이트
            window.displayBrandNames(currentBrands);
        }

        // 현재 브랜드 리스트 가져오기 (객체 형태)
        window.getCurrentBrands = function() {
            const brandListContainer = document.getElementById('brand-names-list');
            if (!brandListContainer) return [];
            
            const brandLinks = brandListContainer.querySelectorAll('.brand-name-link');
            const brands = [];
            brandLinks.forEach((link, index) => {
                const brandName = link.textContent.trim().replace('🔗', '').trim();
                const brandLink = link.getAttribute('href');
                const orderElement = link.parentElement.querySelector('.badge');
                const order = orderElement ? parseInt(orderElement.textContent) : index + 1;
                
                brands.push({ name: brandName, link: brandLink, order: order });
            });
            
            return brands;
        }

        // 현재 브랜드명 리스트 가져오기 (하위 호환성)
        window.getCurrentBrandNames = function() {
            const brands = window.getCurrentBrands();
            return brands.map(brand => brand.name);
        }

        // 기존 동적 회사 정보 표시 함수 제거됨 - 고정 필드 방식으로 변경

        // 기존 동적 회사 정보 관리 함수들 제거됨 - 고정 필드 방식으로 변경

        // Further Info 링크 리스트 표시
        window.displayFurtherInfoLinks = function(furtherInfoLinks) {
            const linksListContainer = document.getElementById('further-info-links-list');
            if (!linksListContainer) return;
            
            if (furtherInfoLinks.length === 0) {
                linksListContainer.innerHTML = '<p class="text-muted">リンクが登録されていません。</p>';
                return;
            }
            
            // 순서대로 정렬
            const sortedLinks = [...furtherInfoLinks].sort((a, b) => a.order - b.order);
            
            let html = '';
            sortedLinks.forEach((link, index) => {
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-secondary me-2">${link.order}</span>
                            <span class="further-info-name me-2">${link.name}</span>
                            <small class="text-muted">${link.link}</small>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-secondary" onclick="window.moveFurtherInfoLink(${index}, -1)" ${index === 0 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="window.moveFurtherInfoLink(${index}, 1)" ${index === sortedLinks.length - 1 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-down"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="window.removeFurtherInfoLink(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            linksListContainer.innerHTML = html;
        }

        // Further Info 링크 추가
        window.addFurtherInfoLink = function() {
            const newLinkNameInput = document.getElementById('new-further-info-name');
            const newLinkUrlInput = document.getElementById('new-further-info-link');
            if (!newLinkNameInput || !newLinkUrlInput) return;
            
            const newLinkName = newLinkNameInput.value.trim();
            const newLinkUrl = newLinkUrlInput.value.trim();
            
            if (!newLinkName) {
                showAlert('リンク名を入力してください。', 'warning');
                return;
            }
            
            if (!newLinkUrl) {
                showAlert('リンク先を入力してください。', 'warning');
                return;
            }
            
            // 현재 Further Info 링크 리스트 가져오기
            const currentLinks = window.getCurrentFurtherInfoLinks();
            
            // 중복 확인
            const existingLink = currentLinks.find(link => link.name === newLinkName);
            if (existingLink) {
                showAlert('このリンク名は既に登録されています。', 'warning');
                return;
            }
            
            // 새 링크 추가 (순서는 마지막 + 1)
            const newOrder = currentLinks.length > 0 ? Math.max(...currentLinks.map(l => l.order)) + 1 : 1;
            currentLinks.push({ name: newLinkName, link: newLinkUrl, order: newOrder });
            
            // 화면 업데이트
            window.displayFurtherInfoLinks(currentLinks);
            
            // 입력 필드 초기화
            newLinkNameInput.value = '';
            newLinkUrlInput.value = '';
            
            showAlert('リンクが追加されました。', 'success');
        }

        // Further Info 링크 삭제
        window.removeFurtherInfoLink = function(index) {
            if (confirm('このリンクを削除しますか？')) {
                const currentLinks = window.getCurrentFurtherInfoLinks();
                currentLinks.splice(index, 1);
                
                // 순서 재정렬
                currentLinks.forEach((link, idx) => {
                    link.order = idx + 1;
                });
                
                window.displayFurtherInfoLinks(currentLinks);
                showAlert('リンクが削除されました。', 'success');
            }
        }

        // Further Info 링크 순서 변경
        window.moveFurtherInfoLink = function(index, direction) {
            const currentLinks = window.getCurrentFurtherInfoLinks();
            const newIndex = index + direction;
            
            if (newIndex < 0 || newIndex >= currentLinks.length) return;
            
            // 순서 교환
            const temp = currentLinks[index].order;
            currentLinks[index].order = currentLinks[newIndex].order;
            currentLinks[newIndex].order = temp;
            
            // 화면 업데이트
            window.displayFurtherInfoLinks(currentLinks);
        }

        // 현재 Further Info 링크 리스트 가져오기
        window.getCurrentFurtherInfoLinks = function() {
            const linksListContainer = document.getElementById('further-info-links-list');
            if (!linksListContainer) return [];
            
            const linkItems = linksListContainer.querySelectorAll('.further-info-name');
            const links = [];
            linkItems.forEach((item, index) => {
                const name = item.textContent.trim();
                const linkElement = item.parentElement.querySelector('small');
                const link = linkElement ? linkElement.textContent.trim() : '#';
                const orderElement = item.parentElement.querySelector('.badge');
                const order = orderElement ? parseInt(orderElement.textContent) : index + 1;
                
                links.push({ name, link, order });
            });
            
            return links;
        }

        // 푸터 내용 저장
        window.saveFooterContent = async function() {
            try {
                const footerData = {
                    companyInfo: window.getCompanyInfoFromFields(),
                    brandNames: window.getCurrentBrands(),
                    furtherInfoLinks: window.getCurrentFurtherInfoLinks(),
                    updatedAt: new Date().toISOString()
                };
                
                if (window.firebase && window.firebase.firestore) {
                    // 기존 데이터 삭제 후 새 데이터 추가
                    const existingSnapshot = await window.firebase.firestore().collection('footer_content').get();
                    const batch = window.firebase.firestore().batch();
                    
                    existingSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    const docRef = window.firebase.firestore().collection('footer_content').doc();
                    batch.set(docRef, footerData);
                    
                    await batch.commit();
                    console.log('✅ 푸터 데이터 저장 완료');
                }
                
                showAlert('フッター内容が保存されました。', 'success');
                
            } catch (error) {
                console.error('❌ 푸터 저장 오류:', error);
                showAlert('フッター保存中にエラーが発生しました。', 'danger');
            }
        }

        // 편집 함수들
        window.editBestItem = function(itemId) {
            const bestItems = window.getCurrentBestItems();
            const item = bestItems.find(i => i.id === itemId);
            
            if (!item) {
                showAlert('BEST ITEMが見つかりません。', 'danger');
                return;
            }
            
            window.openBestItemEditModal(item);
        }

        window.editFeaturedProduct = function(productId) {
            const featuredProducts = window.getCurrentFeaturedProducts();
            const product = featuredProducts.find(p => p.id === productId);
            
            console.log('🔍 Featured Product 편집 시작:', {
                productId: productId,
                foundProduct: product,
                allProducts: featuredProducts
            });
            
            if (!product) {
                showAlert('Featured Productが見つかりません。', 'danger');
                return;
            }
            
            window.openFeaturedProductEditModal(product);
        }
        
        // BEST ITEM編集モーダル開く
        window.openBestItemEditModal = function(item) {
            const modalHtml = `
                <div class="modal fade" id="bestItemEditModal" tabindex="-1" aria-labelledby="bestItemEditModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="bestItemEditModalLabel">
                                    <i class="fas fa-edit me-2"></i>BEST ITEM編集
                                </h5>
                            </div>
                            <div class="modal-body">
                                <form id="bestItemEditForm">
                                    <input type="hidden" id="edit-best-item-id" value="${item.id}">
                                    
                                    <div class="row">
                                        <div class="col-md-8">
                                            <div class="mb-3">
                                                <label class="form-label">順序 (1-3)</label>
                                                <input type="number" class="form-control" id="edit-best-item-order" value="${item.order}" min="1" max="3" placeholder="順序 (1-3)" required>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">ブランド名</label>
                                                <input type="text" class="form-control" id="edit-best-item-brand" value="${item.brandName}" placeholder="ブランド名を入力してください" required>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">商品名</label>
                                                <input type="text" class="form-control" id="edit-best-item-product" value="${item.productName}" placeholder="商品名を入力してください" required>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">リンク URL</label>
                                                <input type="text" class="form-control" id="edit-best-item-link" value="${item.link || ''}" placeholder="リンクURLを入力してください (例: product-detail.html?id=7bKMza6jhoRqf4s7lDsf または #)">
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">商品画像</label>
                                                <div class="drag-drop-area" id="best-item-image-drop-area" style="border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; background-color: #f8f9fa; cursor: pointer; transition: all 0.3s ease;">
                                                    <div id="best-item-image-preview" style="display: ${item.image ? 'block' : 'none'};">
                                                        <img id="best-item-image-preview-img" src="${item.image || ''}" alt="商品画像" class="img-fluid" style="max-height: 120px; margin-bottom: 10px;" onerror="this.style.display='none'">
                                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="removeBestItemImage()">削除</button>
                                                    </div>
                                                    <div id="best-item-image-upload-text" style="display: ${item.image ? 'none' : 'block'};">
                                                        <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                                        <p class="mb-0 text-muted">画像をドラッグ＆ドロップ<br>またはクリックして選択</p>
                                                    </div>
                                                </div>
                                                <input type="hidden" id="edit-best-item-image" value="${item.image || ''}">
                                                <div class="form-text text-muted">
                                                    <i class="fas fa-info-circle me-1"></i>推奨サイズ: 300x300px
                                                </div>
                                            </div>
                                            
                                            <div class="card">
                                                <div class="card-header">
                                                    <h6 class="japanese-heading mb-0">プレビュー</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div id="best-item-edit-preview">
                                                        <img id="preview-best-item-image" src="${item.image}" alt="商品画像" class="img-fluid rounded mb-2" onerror="this.style.display='none'">
                                                        <div class="mb-2">
                                                            <span id="preview-best-item-brand">${item.brandName}</span>
                                                        </div>
                                                        <div class="mb-2">
                                                            <span id="preview-best-item-product">${item.productName}</span>
                                                        </div>
                                                        <div class="mb-2">
                                                            <span id="preview-best-item-order">${item.order}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeBestItemEditModal()">
                                    <i class="fas fa-times me-2"></i>キャンセル
                                </button>
                                <button type="button" class="btn btn-dark" onclick="saveBestItemEdit()">
                                    <i class="fas fa-save me-2"></i>保存
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 기존 모달 제거
            const existingModal = document.getElementById('bestItemEditModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 새 모달 추가
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 모달 표시
            const modal = new bootstrap.Modal(document.getElementById('bestItemEditModal'));
            modal.show();
            
            // 실시간 미리보기 업데이트
            setupBestItemEditPreview();
            
            // 드래그 앤 드롭 설정
            setupBestItemImageDragAndDrop();
        }
        
        // BEST ITEM編集モーダル閉じる
        window.closeBestItemEditModal = function() {
            // 이벤트 리스너 정리
            cleanupBestItemEditEventListeners();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('bestItemEditModal'));
            if (modal) {
                modal.hide();
            }
            
            // 모달 요소 제거
            setTimeout(() => {
                const modalElement = document.getElementById('bestItemEditModal');
                if (modalElement && modalElement.parentNode) {
                    modalElement.parentNode.removeChild(modalElement);
                }
            }, 300);
        }
        
        // BEST ITEM 편집 모달 이벤트 리스너 정리
        function cleanupBestItemEditEventListeners() {
            const dropArea = document.getElementById('best-item-image-drop-area');
            if (dropArea) {
                dropArea.removeEventListener('dragover', handleBestItemDragOver);
                dropArea.removeEventListener('drop', handleBestItemDrop);
                dropArea.removeEventListener('dragleave', handleBestItemDragLeave);
                dropArea.removeEventListener('mouseenter', handleBestItemMouseEnter);
                dropArea.removeEventListener('mouseleave', handleBestItemMouseLeave);
                dropArea.removeEventListener('click', openBestItemFileDialog);
            }
            
            // 입력 필드 이벤트 리스너 정리
            const inputs = ['edit-best-item-brand', 'edit-best-item-product', 'edit-best-item-order', 'edit-best-item-image'];
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.removeEventListener('input', updateBestItemEditPreview);
                }
            });
        }
        
        // BEST ITEM編集プレビュー設定
        window.setupBestItemEditPreview = function() {
            const inputs = ['edit-best-item-brand', 'edit-best-item-product', 'edit-best-item-order', 'edit-best-item-image'];
            
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', updateBestItemEditPreview);
                }
            });
        }
        
        // BEST ITEM 이미지 드래그 앤 드롭 설정
        window.setupBestItemImageDragAndDrop = function() {
            const dropArea = document.getElementById('best-item-image-drop-area');
            if (!dropArea) return;
            
            // 드래그 이벤트
            dropArea.addEventListener('dragover', handleBestItemDragOver);
            dropArea.addEventListener('drop', handleBestItemDrop);
            dropArea.addEventListener('dragleave', handleBestItemDragLeave);
            
            // 마우스 이벤트
            dropArea.addEventListener('mouseenter', handleBestItemMouseEnter);
            dropArea.addEventListener('mouseleave', handleBestItemMouseLeave);
            
            // 클릭 이벤트
            dropArea.addEventListener('click', openBestItemFileDialog);
        }
        
        // BEST ITEM 드래그 오버
        function handleBestItemDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            const dropArea = document.getElementById('best-item-image-drop-area');
            if (dropArea) {
                dropArea.style.borderColor = '#007bff';
                dropArea.style.backgroundColor = '#e3f2fd';
            }
        }
        
        // BEST ITEM 드롭
        function handleBestItemDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const dropArea = document.getElementById('best-item-image-drop-area');
            if (dropArea) {
                dropArea.style.borderColor = '#ccc';
                dropArea.style.backgroundColor = '#f8f9fa';
            }
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    updateBestItemImagePreview(file);
                }
            }
        }
        
        // BEST ITEM 드래그 리브
        function handleBestItemDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            const dropArea = document.getElementById('best-item-image-drop-area');
            if (dropArea) {
                dropArea.style.borderColor = '#ccc';
                dropArea.style.backgroundColor = '#f8f9fa';
            }
        }
        
        // BEST ITEM 마우스 엔터
        function handleBestItemMouseEnter(e) {
            const dropArea = document.getElementById('best-item-image-drop-area');
            if (dropArea) {
                dropArea.style.borderColor = '#007bff';
                dropArea.style.backgroundColor = '#e3f2fd';
            }
        }
        
        // BEST ITEM 마우스 리브
        function handleBestItemMouseLeave(e) {
            const dropArea = document.getElementById('best-item-image-drop-area');
            if (dropArea) {
                dropArea.style.borderColor = '#ccc';
                dropArea.style.backgroundColor = '#f8f9fa';
            }
        }
        
        // BEST ITEM 파일 다이얼로그 열기
        function openBestItemFileDialog() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    updateBestItemImagePreview(file);
                }
            };
            input.click();
        }
        
        // BEST ITEM 이미지 미리보기 업데이트
        function updateBestItemImagePreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageUrl = e.target.result;
                
                // hidden input 업데이트
                const hiddenInput = document.getElementById('edit-best-item-image');
                if (hiddenInput) {
                    hiddenInput.value = imageUrl;
                }
                
                // 미리보기 이미지 업데이트
                const previewImg = document.getElementById('best-item-image-preview-img');
                if (previewImg) {
                    previewImg.src = imageUrl;
                    previewImg.style.display = 'block';
                }
                
                // 미리보기 영역 표시
                const previewDiv = document.getElementById('best-item-image-preview');
                const uploadTextDiv = document.getElementById('best-item-image-upload-text');
                
                if (previewDiv) previewDiv.style.display = 'block';
                if (uploadTextDiv) uploadTextDiv.style.display = 'none';
                
                // 전체 미리보기 업데이트
                updateBestItemEditPreview();
            };
            reader.readAsDataURL(file);
        }
        
        // BEST ITEM 이미지 제거
        window.removeBestItemImage = function() {
            const hiddenInput = document.getElementById('edit-best-item-image');
            const previewImg = document.getElementById('best-item-image-preview-img');
            const previewDiv = document.getElementById('best-item-image-preview');
            const uploadTextDiv = document.getElementById('best-item-image-upload-text');
            
            if (hiddenInput) hiddenInput.value = '';
            if (previewImg) previewImg.style.display = 'none';
            if (previewDiv) previewDiv.style.display = 'none';
            if (uploadTextDiv) uploadTextDiv.style.display = 'block';
            
            // 전체 미리보기 업데이트
            updateBestItemEditPreview();
        }
        
        // BEST ITEM編集プレビュー更新
        window.updateBestItemEditPreview = function() {
                    const editBestItemBrandElement = document.getElementById('edit-best-item-brand');
        const editBestItemProductElement = document.getElementById('edit-best-item-product');
        const editBestItemOrderElement = document.getElementById('edit-best-item-order');
        const editBestItemImageElement = document.getElementById('edit-best-item-image');
        
        const brand = editBestItemBrandElement ? editBestItemBrandElement.value : '';
        const product = editBestItemProductElement ? editBestItemProductElement.value : '';
        const order = editBestItemOrderElement ? editBestItemOrderElement.value : '';
        const image = editBestItemImageElement ? editBestItemImageElement.value : '';
            
            // 미리보기 업데이트
            document.getElementById('preview-best-item-brand').textContent = brand;
            document.getElementById('preview-best-item-product').textContent = product;
            document.getElementById('preview-best-item-order').textContent = order;
            
            // 이미지 업데이트
            const img = document.getElementById('preview-best-item-image');
            if (img) {
                img.src = image;
                img.style.display = image ? 'block' : 'none';
            }
        }
        
        // BEST ITEM編集保存
        window.saveBestItemEdit = async function() {
            const itemId = document.getElementById('edit-best-item-id').value;
            const order = document.getElementById('edit-best-item-order').value;
            const brandName = document.getElementById('edit-best-item-brand').value;
            const productName = document.getElementById('edit-best-item-product').value;
            let link = document.getElementById('edit-best-item-link').value;
            const image = document.getElementById('edit-best-item-image').value;
            
            // 절대 경로를 상대 경로로 변환
            if (link && link.includes('localhost:8000')) {
                link = link.replace('http://localhost:8000/', '');
            }
            
            // 링크가 비어있거나 '#'인 경우 기본값 설정
            if (!link || link === '#' || link.trim() === '') {
                link = '#';
            }
            
            console.log('🔗 BEST ITEM 링크 저장:', {
                originalLink: document.getElementById('edit-best-item-link').value,
                processedLink: link,
                itemId: itemId,
                brandName: brandName,
                productName: productName
            });
            
            if (!order || !brandName || !productName || !image) {
                showAlert('必須項目をすべて入力してください。', 'danger');
                return;
            }
            
            // 現在のBEST ITEMリスト更新
            const bestItems = window.getCurrentBestItems();
            const itemIndex = bestItems.findIndex(i => i.id === itemId);
            
            if (itemIndex !== -1) {
                bestItems[itemIndex] = {
                    ...bestItems[itemIndex],
                    order: parseInt(order),
                    brandName: brandName,
                    productName: productName,
                    link: link,
                    image: image
                };
                
                // 전역 변수에 업데이트된 데이터 저장
                window.currentBestItems = bestItems;
                
                // Firebase에 즉시 저장
                try {
                    if (window.firebase && window.firebase.firestore) {
                        const batch = window.firebase.firestore().batch();
                        
                        // 기존 데이터 삭제
                        const existingSnapshot = await window.firebase.firestore().collection('homepage_best_items').get();
                        existingSnapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        
                        // 새 데이터 추가
                        bestItems.forEach(item => {
                            const docRef = window.firebase.firestore().collection('homepage_best_items').doc();
                            batch.set(docRef, item);
                        });
                        
                        await batch.commit();
                        console.log('✅ BEST ITEM 편집 데이터 Firebase 저장 완료');
                    }
                } catch (error) {
                    console.error('❌ BEST ITEM 편집 데이터 Firebase 저장 오류:', error);
                }
                
                // 목록 다시 표시
                window.displayBestItemsList(bestItems);
                
                showAlert('BEST ITEMが更新されました。', 'success');
                
                // 이벤트 리스너 정리 후 모달 닫기
                cleanupBestItemEditEventListeners();
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('bestItemEditModal'));
                if (modal) {
                    modal.hide();
                }
                
                // 모달 요소 제거
                setTimeout(() => {
                    const modalElement = document.getElementById('bestItemEditModal');
                    if (modalElement && modalElement.parentNode) {
                        modalElement.parentNode.removeChild(modalElement);
                    }
                }, 300);
            } else {
                showAlert('BEST ITEMが見つかりません。', 'danger');
            }
        }
        
        // Featured Product 편집 모달 열기
        window.openFeaturedProductEditModal = function(product) {
            const modalHtml = `
                <div class="modal fade" id="featuredProductEditModal" tabindex="-1" aria-labelledby="featuredProductEditModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="featuredProductEditModalLabel">
                                    <i class="fas fa-edit me-2"></i>Featured Product編集
                                </h5>
                            </div>
                            <div class="modal-body">
                                <form id="featuredProductEditForm">
                                    <input type="hidden" id="edit-featured-product-id" value="${product.id}">
                                    
                                    <div class="row">
                                        <div class="col-md-8">
                                            <div class="mb-3">
                                                <label for="edit-featured-product-order" class="form-label">順序 <span class="text-danger">*</span></label>
                                                <input type="number" class="form-control" id="edit-featured-product-order" value="${product.order}" min="1" max="3" required>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="edit-featured-product-brand" class="form-label">ブランド名 <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="edit-featured-product-brand" value="${product.brandName}" required>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="edit-featured-product-name" class="form-label">商品名 <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="edit-featured-product-name" value="${product.productName}" required>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="edit-featured-product-price" class="form-label">価格 (円) <span class="text-danger">*</span></label>
                                                <input type="number" class="form-control" id="edit-featured-product-price" value="${product.price}" min="0" required>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="edit-featured-product-link" class="form-label">リンク URL</label>
                                                <input type="text" class="form-control" id="edit-featured-product-link" value="${product.link || ''}" placeholder="例: product-detail.html">
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="edit-featured-product-image" class="form-label">画像 URL <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="edit-featured-product-image" value="${product.image}" required>
                                                <div class="form-text">商品画像URLを入力してください</div>
                                            </div>
                                            
                                            <div class="card">
                                                <div class="card-header">
                                                    <h6 class="japanese-heading mb-0">プレビュー</h6>
                                                </div>
                                                <div class="card-body">
                                                    <div id="featured-product-edit-preview">
                                                        <img id="preview-featured-product-image" src="${product.image}" alt="商品画像" class="img-fluid rounded mb-2" onerror="this.style.display='none'">
                                                        <div class="mb-2">
                                                            <strong>ブランド:</strong> <span id="preview-featured-product-brand">${product.brandName}</span>
                                                        </div>
                                                        <div class="mb-2">
                                                            <strong>商品名:</strong> <span id="preview-featured-product-name">${product.productName}</span>
                                                        </div>
                                                        <div class="mb-2">
                                                            <strong>価格:</strong> <span id="preview-featured-product-price">¥${product.price.toLocaleString()}</span>
                                                        </div>
                                                        <div class="mb-2">
                                                            <strong>順序:</strong> <span id="preview-featured-product-order">${product.order}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeFeaturedProductEditModal()">
                                    <i class="fas fa-times me-2"></i>キャンセル
                                </button>
                                <button type="button" class="btn btn-dark" onclick="saveFeaturedProductEdit()">
                                    <i class="fas fa-save me-2"></i>保存
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 기존 모달 제거
            const existingModal = document.getElementById('featuredProductEditModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 새 모달 추가
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 모달 표시
            const modal = new bootstrap.Modal(document.getElementById('featuredProductEditModal'));
            modal.show();
            
            // 실시간 미리보기 업데이트
            setupFeaturedProductEditPreview();
        }
        
        // Featured Product 편집 모달 닫기
        window.closeFeaturedProductEditModal = function() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('featuredProductEditModal'));
            if (modal) {
                modal.hide();
            }
        }
        
        // Featured Product 편집 미리보기 설정
        window.setupFeaturedProductEditPreview = function() {
            const inputs = ['edit-featured-product-brand', 'edit-featured-product-name', 'edit-featured-product-price', 'edit-featured-product-order', 'edit-featured-product-image'];
            
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', updateFeaturedProductEditPreview);
                }
            });
        }
        
        // Featured Product 편집 미리보기 업데이트
        window.updateFeaturedProductEditPreview = function() {
                    const editFeaturedProductBrandElement = document.getElementById('edit-featured-product-brand');
        const editFeaturedProductNameElement = document.getElementById('edit-featured-product-name');
        const editFeaturedProductPriceElement = document.getElementById('edit-featured-product-price');
        const editFeaturedProductOrderElement = document.getElementById('edit-featured-product-order');
        const editFeaturedProductImageElement = document.getElementById('edit-featured-product-image');
        
        const brand = editFeaturedProductBrandElement ? editFeaturedProductBrandElement.value : '';
        const name = editFeaturedProductNameElement ? editFeaturedProductNameElement.value : '';
        const price = editFeaturedProductPriceElement ? editFeaturedProductPriceElement.value : 0;
        const order = editFeaturedProductOrderElement ? editFeaturedProductOrderElement.value : '';
        const image = editFeaturedProductImageElement ? editFeaturedProductImageElement.value : '';
            
            // 미리보기 업데이트
            document.getElementById('preview-featured-product-brand').textContent = brand;
            document.getElementById('preview-featured-product-name').textContent = name;
            document.getElementById('preview-featured-product-price').textContent = `¥${parseInt(price).toLocaleString()}`;
            document.getElementById('preview-featured-product-order').textContent = order;
            
            // 이미지 업데이트
            const img = document.getElementById('preview-featured-product-image');
            if (img) {
                img.src = image;
                img.style.display = image ? 'block' : 'none';
            }
        }
        
        // Featured Product 편집 저장
        window.saveFeaturedProductEdit = async function() {
            const productId = document.getElementById('edit-featured-product-id').value;
            const order = document.getElementById('edit-featured-product-order').value;
            const brandName = document.getElementById('edit-featured-product-brand').value;
            const productName = document.getElementById('edit-featured-product-name').value;
            const price = document.getElementById('edit-featured-product-price').value;
            const link = document.getElementById('edit-featured-product-link').value;
            const image = document.getElementById('edit-featured-product-image').value;
            
            if (!order || !brandName || !productName || !price || !image) {
                showAlert('必須項目をすべて入力してください。', 'danger');
                return;
            }
            
            // 현재 Featured Product 목록 업데이트
            const featuredProducts = window.getCurrentFeaturedProducts();
            const productIndex = featuredProducts.findIndex(p => p.id === productId);
            
            console.log('🔧 Featured Product 편집 저장:', {
                productId: productId,
                order: order,
                brandName: brandName,
                productName: productName,
                price: price,
                link: link,
                image: image,
                productIndex: productIndex,
                currentProducts: featuredProducts
            });
            
            if (productIndex !== -1) {
                featuredProducts[productIndex] = {
                    ...featuredProducts[productIndex],
                    order: parseInt(order),
                    brandName: brandName,
                    productName: productName,
                    price: parseInt(price),
                    link: link,
                    image: image
                };
                
                // 순서에 따라 배열 재정렬
                featuredProducts.sort((a, b) => a.order - b.order);
                
                // 전역 변수 업데이트
                window.currentFeaturedProducts = featuredProducts;
                
                console.log('✅ Featured Product 업데이트 완료:', {
                    updatedProducts: featuredProducts,
                    globalVariable: window.currentFeaturedProducts
                });
                
                // 목록 다시 표시
                window.displayFeaturedProductsList(featuredProducts);
                
                // Firebase에 직접 저장
                if (window.firebase && window.firebase.firestore) {
                    const batch = window.firebase.firestore().batch();
                    
                    // 기존 데이터 삭제
                    const existingSnapshot = await window.firebase.firestore().collection('homepage_featured_products').get();
                    existingSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    // 새 데이터 추가
                    featuredProducts.forEach(product => {
                        const docRef = window.firebase.firestore().collection('homepage_featured_products').doc();
                        batch.set(docRef, product);
                    });
                    
                    await batch.commit();
                    console.log('✅ Featured Product 데이터 Firebase 저장 완료');
                    
                    // 인덱스 페이지 Featured Product 업데이트
                    if (typeof window.updateFeaturedProductContent === 'function') {
                        try {
                            await window.updateFeaturedProductContent();
                            console.log('✅ 인덱스 페이지 Featured Product 업데이트 완료');
                        } catch (error) {
                            console.error('❌ 인덱스 페이지 Featured Product 업데이트 오류:', error);
                        }
                    }
                }
                
                showAlert('Featured Productが更新されました。', 'success');
                closeFeaturedProductEditModal();
                
                // Featured Product 관리 모달의 이벤트 리스너 정리
                const featuredProductModal = document.getElementById('featuredProductModal');
                if (featuredProductModal) {
                    const modalBody = featuredProductModal.querySelector('.modal-body');
                    if (modalBody) {
                        const newModalBody = modalBody.cloneNode(true);
                        modalBody.parentNode.replaceChild(newModalBody, modalBody);
                    }
                }
            } else {
                showAlert('Featured Productが見つかりません。', 'danger');
            }
        }
        
        // 現在のBEST ITEMデータ取得
        window.getCurrentBestItems = function() {
            // 전역 변수에 데이터가 있으면 우선 사용
            if (window.currentBestItems && window.currentBestItems.length > 0) {
                return window.currentBestItems;
            }
            
            const container = document.getElementById('best-items-list');
            if (!container) return [];
            
            const bestItemElements = container.querySelectorAll('.best-item');
            return Array.from(bestItemElements).map(item => {
                const itemId = item.dataset.itemId;
                
                // DOM에서 데이터 추출 (라벨이 제거된 상태)
                const imageImg = item.querySelector('img[alt="商品画像"]');
                const image = imageImg ? imageImg.src : '';
                
                const brandElement = item.querySelector('.mb-2:nth-child(1)');
                const brandName = brandElement ? brandElement.textContent.trim() : '';
                
                const productElement = item.querySelector('.mb-2:nth-child(2)');
                const productName = productElement ? productElement.textContent.trim() : '';
                
                const linkElement = item.querySelector('.mb-2:nth-child(3)');
                const link = linkElement ? linkElement.textContent.trim() : '';
                
                const orderElement = item.querySelector('.mb-2:nth-child(4)');
                const order = orderElement ? parseInt(orderElement.textContent.trim()) : 1;
                
                return {
                    id: itemId,
                    order: order,
                    image: image,
                    brandName: brandName,
                    productName: productName,
                    link: link
                };
            });
        }
        
        // 현재 Featured Product 데이터 가져오기
        window.getCurrentFeaturedProducts = function() {
            // 전역 변수에 데이터가 있으면 우선 사용
            if (window.currentFeaturedProducts && window.currentFeaturedProducts.length > 0) {
                return window.currentFeaturedProducts;
            }
            
            const container = document.getElementById('featured-products-list');
            if (!container) return [];
            
            const featuredProductElements = container.querySelectorAll('.featured-product');
            return Array.from(featuredProductElements).map(item => {
                const productId = item.dataset.productId;
                
                // DOM에서 데이터 추출
                const imageImg = item.querySelector('img[alt="商品画像"]');
                const image = imageImg ? imageImg.src : '';
                
                const brandElement = item.querySelector('.mb-2:nth-child(1)');
                const brandName = brandElement ? brandElement.textContent.replace('ブランド:', '').trim() : '';
                
                const productElement = item.querySelector('.mb-2:nth-child(2)');
                const productName = productElement ? productElement.textContent.replace('商品名:', '').trim() : '';
                
                const priceElement = item.querySelector('.mb-2:nth-child(3)');
                const price = priceElement ? parseInt(priceElement.textContent.replace('価格:', '').replace('¥', '').replace(',', '').trim()) : 0;
                
                const linkElement = item.querySelector('.mb-2:nth-child(4)');
                const link = linkElement ? linkElement.textContent.replace('リンク:', '').trim() : '';
                
                const orderElement = item.querySelector('.mb-2:nth-child(5)');
                const order = orderElement ? parseInt(orderElement.textContent.replace('順序:', '').trim()) : 1;
                
                return {
                    id: productId,
                    order: order,
                    image: image,
                    brandName: brandName,
                    productName: productName,
                    price: price,
                    link: link
                };
            });
        }
        
        // 전역 스코프에서 접근할 수 있도록 함수들을 window 객체에 할당
        window.showAddBrandModal = function() {
            try {
                console.log('🔄 브랜드 추가 모달 열기 시작...');
                
                // Bootstrap モーダルを開く (static backdrop設定)
                const modalElement = document.getElementById('brandModal');
                if (!modalElement) {
                    console.error('❌ brandModal 요소를 찾을 수 없습니다');
                    showAlert('브랜드 모달을 찾을 수 없습니다.', 'danger');
                    return;
                }
                
                const modal = new bootstrap.Modal(modalElement, {
                    backdrop: 'static',
                    keyboard: false
                });
                
                // フォームをクリア
                const brandForm = document.getElementById('brandForm');
                if (brandForm) brandForm.reset();
                
                const brandId = document.getElementById('brand-id');
                if (brandId) brandId.value = '';
                
                const brandModalLabel = document.getElementById('brandModalLabel');
                if (brandModalLabel) brandModalLabel.textContent = '新しいブランドを追加';
                
                // プレビュー画像をクリア
                if (typeof clearBrandImagePreviews === 'function') {
                    clearBrandImagePreviews();
                }
                
                modal.show();
                console.log('✅ 브랜드 추가 모달 열기 완료');
                
            } catch (error) {
                console.error('❌ 브랜드 추가 모달 열기 오류:', error);
                showAlert('브랜드 추가 모달을 열 수 없습니다.', 'danger');
            }
        };
        
        // 기존 함수들도 전역에서 접근할 수 있도록 설정
        if (typeof showAddProductModal !== 'undefined') {
            window.showAddProductModal = showAddProductModal;
        }
        
        // 함수 로드 확인
        console.log('=== 함수 로드 상태 확인 ===');
        console.log('showAddProductModal:', typeof window.showAddProductModal);
        console.log('loadProducts:', typeof window.loadProducts);
        console.log('displayProducts:', typeof window.displayProducts);
        console.log('========================');
        
        // 브라우저 로케일을 일본어로 설정하는 함수
        function setJapaneseLocale() {
            try {
                // Intl API를 사용하여 일본어 로케일 설정
                if (window.Intl && window.Intl.DateTimeFormat) {
                    const japaneseFormatter = new Intl.DateTimeFormat('ja-JP', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                    console.log('✅ 일본어 날짜 포맷터 설정 완료');
                }
                
                // 브라우저 언어 설정 (가능한 경우)
                if (navigator.language) {
                    console.log('현재 브라우저 언어:', navigator.language);
                }
                
                // HTML 문서 언어 설정
                document.documentElement.setAttribute('lang', 'ja-JP');
                console.log('✅ HTML 문서 언어를 ja-JP로 설정');
                
            } catch (error) {
                console.warn('일본어 로케일 설정 중 오류:', error);
            }
        }
        
        // 뱃지 날짜 필드 동적 생성 함수
        function createBadgeDateFields() {
            console.log('🔧 뱃지 날짜 필드 동적 생성 시작...');
            
            // 일본어 로케일 설정
            setJapaneseLocale();
            
            const container = document.getElementById('badge-date-fields-container');
            if (!container) {
                console.error('❌ 뱃지 날짜 필드 컨테이너를 찾을 수 없습니다');
                return;
            }
            
            // 기존 필드 제거
            container.innerHTML = '';
            
            // 새로운 필드 생성 (일본어 로케일)
            const dateFieldsHTML = `
                <div class="row" style="display: block !important; visibility: visible !important;">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="product-badge-start" class="form-label">バッジ開始日</label>
                            <input type="date" class="form-control" id="product-badge-start" lang="ja-JP" style="display: block !important; visibility: visible !important;" data-locale="ja-JP">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="product-badge-end" class="form-label">バッジ終了日</label>
                            <input type="date" class="form-control" id="product-badge-end" lang="ja-JP" style="display: block !important; visibility: visible !important;" data-locale="ja-JP">
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = dateFieldsHTML;
            
            // 생성된 필드 확인 및 일본어 로케일 설정
            const startField = document.getElementById('product-badge-start');
            const endField = document.getElementById('product-badge-end');
            
            // 일본어 로케일 설정
            if (startField) {
                startField.setAttribute('lang', 'ja-JP');
                startField.setAttribute('data-locale', 'ja-JP');
                startField.setAttribute('data-format', 'YYYY/MM/DD');
                // 브라우저별 일본어 로케일 설정
                if (startField.setLocale) {
                    startField.setLocale('ja-JP');
                }
                // 추가 속성 설정
                startField.setAttribute('aria-label', 'バッジ開始日を選択');
                startField.setAttribute('title', 'バッジ開始日を選択してください');
            }
            
            if (endField) {
                endField.setAttribute('lang', 'ja-JP');
                endField.setAttribute('data-locale', 'ja-JP');
                endField.setAttribute('data-format', 'YYYY/MM/DD');
                // 브라우저별 일본어 로케일 설정
                if (endField.setLocale) {
                    endField.setLocale('ja-JP');
                }
                // 추가 속성 설정
                endField.setAttribute('aria-label', 'バッジ終了日を選択');
                endField.setAttribute('title', 'バッジ終了日を選択してください');
            }
            
            console.log('✅ 뱃지 날짜 필드 생성 완료 (일본어 로케일):', {
                startField: startField,
                endField: endField,
                startFieldExists: !!startField,
                endFieldExists: !!endField,
                startFieldLang: startField ? startField.getAttribute('lang') : 'N/A',
                endFieldLang: endField ? endField.getAttribute('lang') : 'N/A'
            });
            
            return { startField, endField };
        }
        
        // 뱃지 날짜 필드 테스트 함수
        window.testBadgeDateFields = function() {
            console.log('🔍 뱃지 날짜 필드 테스트 시작...');
            
            const startField = document.getElementById('product-badge-start');
            const endField = document.getElementById('product-badge-end');
            const badgeSection = document.querySelector('.card.mt-4');
            
            console.log('뱃지 날짜 필드 상태:', {
                startField: startField,
                endField: endField,
                badgeSection: badgeSection,
                startFieldVisible: startField ? startField.offsetParent !== null : false,
                endFieldVisible: endField ? endField.offsetParent !== null : false,
                startFieldDisplay: startField ? startField.style.display : 'N/A',
                endFieldDisplay: endField ? endField.style.display : 'N/A'
            });
            
            if (startField && endField) {
                console.log('✅ 뱃지 날짜 필드가 DOM에 존재합니다');
            } else {
                console.log('❌ 뱃지 날짜 필드를 찾을 수 없습니다');
            }
        };
        
        // showAddProductModal 함수가 정의되지 않았다면 다시 정의
        if (typeof window.showAddProductModal !== 'function') {
            console.log('showAddProductModal 함수가 정의되지 않음 - 다시 정의 시도');
            window.showAddProductModal = async function() {
                try {
                    console.log('🔄 상품 추가 모달 열기 시작 (재정의된 함수)...');
                    
                    const modalElement = document.getElementById('productModal');
                    if (!modalElement) {
                        console.error('❌ 상품 모달 요소를 찾을 수 없습니다');
                        alert('상품 모달을 찾을 수 없습니다.');
                        return;
                    }
                    
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                    console.log('✅ 상품 추가 모달 열기 완료');
                    
                } catch (error) {
                    console.error('❌ 상품 추가 모달 열기 오류:', error);
                    alert('상품 추가 모달을 열 수 없습니다: ' + error.message);
                }
            };
        }
        
        // clearBrandImagePreviews 함수도 전역에서 접근할 수 있도록 설정
        if (typeof clearBrandImagePreviews !== 'undefined') {
            window.clearBrandImagePreviews = clearBrandImagePreviews;
        }
        
        console.log('✅ 전역 함수 설정 완료');

        // 고객 포인트 이력 로드
        async function loadCustomerPointHistory() {
            if (!currentCustomer || !currentCustomer.uid) {
                console.log('고객 정보가 없어서 포인트 이력을 로드할 수 없습니다.');
                return;
            }

            try {
                console.log('고객 포인트 이력 로드 시작:', currentCustomer.uid);
                
                if (FirebaseService.isFirebaseAvailable()) {
                    // 전체 포인트 이력을 가져와서 여러 조건으로 필터링
                    console.log('포인트 이력 검색 조건:', {
                        userId: currentCustomer.uid,
                        userEmail: currentCustomer.email
                    });
                    
                    const historySnapshot = await db.collection('pointHistory').get();
                    
                    const pointHistory = [];
                    historySnapshot.forEach(doc => {
                        const data = doc.data();
                        // userId 또는 userEmail로 매칭
                        if (data.userId === currentCustomer.uid || 
                            data.userEmail === currentCustomer.email ||
                            data.userId === currentCustomer.email) {
                            
                        pointHistory.push({
                            id: doc.id,
                            ...data
                        });
                        }
                    });
                    
                    // 클라이언트에서 정렬 및 제한
                    pointHistory.sort((a, b) => {
                        const getTimestamp = (item) => {
                            if (!item || !item.timestamp && !item.createdAt) return new Date(0);
                            if (item.timestamp && item.timestamp.toDate && typeof item.timestamp.toDate === 'function') {
                                return item.timestamp.toDate();
                            }
                            if (item.createdAt) {
                                return new Date(item.createdAt);
                            }
                            return new Date(item.timestamp);
                        };
                        return getTimestamp(b) - getTimestamp(a);
                    }).slice(0, 10);
                    
                    console.log('Firebase에서 포인트 이력 로드 완료:', pointHistory.length, '건');
                    displayCustomerPointHistory(pointHistory);
                } else {
                    // Firebase에서 포인트 이력 로드
                    console.log('🔥 Firebase에서 포인트 이력 로드:', currentCustomer.email);
                    displayCustomerPointHistory([]);
                }
            } catch (error) {
                console.error('포인트 이력 로드 실패:', error);
                showAdminAlert('ポイント履歴の読み込みに失敗しました', 'danger');
            }
        }

        // 고객 포인트 이력 표시
        function displayCustomerPointHistory(history) {
            const container = document.getElementById('customer-point-history');
            
            if (!history || history.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-history fa-2x mb-2"></i>
                        <p class="japanese-text">ポイント履歴がありません</p>
                    </div>
                `;
                return;
            }

            const historyHTML = history.map(item => {
                const getTimestamp = (item) => {
                    if (!item) return new Date(0);
                    
                    // createdAt이 Firestore Timestamp인 경우
                    if (item.createdAt && item.createdAt.toDate && typeof item.createdAt.toDate === 'function') {
                        return item.createdAt.toDate();
                    }
                    
                    // timestamp가 Firestore Timestamp인 경우
                    if (item.timestamp && item.timestamp.toDate && typeof item.timestamp.toDate === 'function') {
                        return item.timestamp.toDate();
                    }
                    
                    // createdAt이 일반 날짜 문자열이나 숫자인 경우
                    if (item.createdAt) {
                        const date = new Date(item.createdAt);
                        if (!isNaN(date.getTime())) {
                            return date;
                        }
                    }
                    
                    // timestamp가 일반 날짜 문자열이나 숫자인 경우
                    if (item.timestamp) {
                        const date = new Date(item.timestamp);
                        if (!isNaN(date.getTime())) {
                            return date;
                        }
                    }
                    
                    // 현재 시간을 기본값으로 사용
                    return new Date();
                };

                const date = getTimestamp(item);
                const dateStr = date.toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let pointsStr, pointsClass;
                if (item.type === 'use' || item.type === 'admin_subtract') {
                    pointsStr = `-${item.points}`;
                    pointsClass = 'text-danger';
                } else if (item.type === 'earn' || item.type === 'admin_add') {
                    pointsStr = `+${item.points}`;
                    pointsClass = 'text-success';
                } else {
                    pointsStr = item.points > 0 ? `+${item.points}` : item.points;
                    pointsClass = item.points > 0 ? 'text-success' : 'text-dark';
                }

                let description = 'ポイント取引';
                if (item.reason) {
                    // 한국어 reason을 일본어로 변환
                    if (item.reason.includes('신규 가입 웰컴 보너스') || item.reason.includes('신규 가입')) {
                        description = '新規登録ウェルカムボーナス';
                    } else if (item.reason.includes('웰컴 보너스')) {
                        description = 'ウェルカムボーナス';
                    } else if (item.reason.includes('포인트 적립')) {
                        description = 'ポイント還元';
                    } else if (item.reason.includes('포인트 사용')) {
                        description = 'ポイント使用';
                    } else if (item.reason.includes('관리자')) {
                        description = '管理者操作';
                    } else {
                    description = item.reason;
                    }
                } else if (item.type === 'earn') {
                    description = '商品購入';
                } else if (item.type === 'use') {
                    description = '商品購入時使用';
                } else if (item.type === 'admin_add') {
                    description = '管理者付与';
                } else if (item.type === 'admin_subtract') {
                    description = '管理者差引';
                } else if (item.type === 'welcome_bonus') {
                    description = '新規登録ウェルカムボーナス';
                } else if (item.description) {
                    description = item.description;
                }

                return `
                    <div class="point-history-item">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="point-description japanese-text">${description}</div>
                                <small class="text-muted japanese-text">${dateStr}</small>
                            </div>
                            <div class="col-md-6 text-end">
                                <div class="point-amount ${pointsClass} japanese-text">${pointsStr} pt</div>
                                ${item.balance ? `<small class="text-muted japanese-text">残高: ${item.balance} pt</small>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = historyHTML;
        }

        // 포인트 이력 새로고침
        function refreshCustomerPointHistory() {
            if (currentCustomer && currentCustomer.uid) {
                loadCustomerPointHistory();
                showAdminAlert('ポイント履歴を更新しました', 'success');
            }
        }
        
        
        
        // 기본 상품 데이터 수집 (간단한 버전)
        function collectBaseProductData() {
            // 안전하게 요소 가져오기
            const getElementValue = (id) => {
                const element = document.getElementById(id);
                return element ? element.value : '';
            };
            
            const getElementNumber = (id, defaultValue = 0) => {
                const element = document.getElementById(id);
                return element ? (parseInt(element.value) || defaultValue) : defaultValue;
            };
            
            return {
                code: getElementValue('product-code'),
                nameEn: getElementValue('product-name-en'),
                nameJp: getElementValue('product-name-jp'),
                brandCode: getElementValue('product-brand'),
                price: getElementNumber('product-price', 0),
                salePrice: getElementNumber('product-sale-price', 0),
                stock: getElementNumber('product-stock', 0),
                status: getElementValue('product-status') || 'active',
                priority: getElementNumber('product-priority', 50),
                description: getElementValue('product-description'),
                imageUrl: getElementValue('product-image-url'),
                ingredients: getElementValue('product-ingredients'),
                usage: getElementValue('product-usage'),
                capacity: getElementValue('product-capacity')
            };
        }
        
        // 변형 상품 미리보기 표시
        function displayVariantPreview(variants) {
            const container = document.getElementById('variant-preview-container');
            const countElement = document.getElementById('variant-count');
            
            countElement.textContent = variants.length;
            
            if (variants.length === 0) {
                container.innerHTML = '<div class="text-muted text-center">オプションを設定すると、ここに生成される商品が表示されます</div>';
                return;
            }
            
            const previewHTML = variants.map((variant, index) => `
                <div class="border rounded p-2 mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${variant.nameJp}</strong>
                            <br>
                            <small class="text-muted">${variant.nameKr}</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-secondary">¥${variant.price.toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = previewHTML;
        }
        
        // 변형 상품 미리보기 초기화
        function clearVariantPreview() {
            const container = document.getElementById('variant-preview-container');
            const countElement = document.getElementById('variant-count');
            
            container.innerHTML = '<div class="text-muted text-center">オプションを設定すると、ここに生成される商品が表示されます</div>';
            countElement.textContent = '0';
        }
        
        // 변형 상품 일괄 저장
        async function saveVariantProducts() {
            try {
                const enableVariants = document.getElementById('enable-variants');
                if (!enableVariants.checked) {
                    // 일반 상품 저장
                    await saveProduct();
                    return;
                }
                
                const options = collectVariantOptions();
                const totalOptions = options.colors.length + options.sizes.length + options.types.length;
                
                if (totalOptions === 0) {
                    showAlert('변형 옵션을 설정해주세요.', 'warning');
                    return;
                }
                
                // 기본 상품 정보 수집
                const baseProduct = collectBaseProductData();
                if (!baseProduct.nameJp || !baseProduct.brandCode) {
                    showAlert('商品名とブランドを入力してください。', 'warning');
                    return;
                }
                
                // 변형 상품 생성
                const variants = generateProductVariants(baseProduct, options);
                
                // Firebase에 일괄 저장
                const db = firebase.firestore();
                const batch = db.batch();
                
                variants.forEach((variant, index) => {
                    // 변형 상품 ID 생성 (기본 상품명 + 변형 옵션)
                    let baseId = '';
                    
                    // 1차 시도: 영어명 사용
                    if (baseProduct.nameEn && baseProduct.nameEn.trim()) {
                        baseId = baseProduct.nameEn.toLowerCase()
                            .replace(/\s+/g, '-')
                            .replace(/[^a-z0-9-]/g, '')
                            .substring(0, 30);
                    }
                    
                    // 2차 시도: 일본어명 사용
                    if (!baseId && baseProduct.nameJp && baseProduct.nameJp.trim()) {
                        baseId = baseProduct.nameJp.toLowerCase()
                            .replace(/\s+/g, '-')
                            .replace(/[^a-z0-9-]/g, '')
                            .substring(0, 30);
                    }
                    
                    // 4차 시도: 코드 사용
                    if (!baseId && baseProduct.code && baseProduct.code.trim()) {
                        baseId = baseProduct.code.toLowerCase()
                            .replace(/\s+/g, '-')
                            .replace(/[^a-z0-9-]/g, '')
                            .substring(0, 30);
                    }
                    
                    // 5차 시도: 타임스탬프 기반
                    if (!baseId) {
                        baseId = `product-${Date.now()}`;
                    }
                    
                    const variantId = `${baseId}-variant-${index + 1}`;
                    
                    variant.id = variantId;
                    variant.createdAt = new Date();
                    variant.updatedAt = new Date();
                    
                    const docRef = db.collection('products').doc(variantId);
                    batch.set(docRef, variant);
                });
                
                await batch.commit();
                
                showAlert(`${variants.length}개의 변형 상품이 성공적으로 등록되었습니다!`, 'success');
                
                // 모달 닫기 및 상품 목록 새로고침
                const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
                modal.hide();
                await loadProducts();
                
            } catch (error) {
                console.error('변형 상품 저장 실패:', error);
                showAlert(`상품 저장에 실패했습니다: ${error.message}`, 'danger');
            }
        }
        
        // 기본 상품 데이터 수집
        function collectBaseProductData() {
            // 안전하게 요소 가져오기
            const getElementValue = (id) => {
                const element = document.getElementById(id);
                return element ? element.value : '';
            };
            
            const getElementNumber = (id, defaultValue = 0) => {
                const element = document.getElementById(id);
                return element ? (parseFloat(element.value) || defaultValue) : defaultValue;
            };
            
            return {
                code: getElementValue('product-code'),
                nameEn: getElementValue('product-name-en'),
                nameJp: getElementValue('product-name-jp'),
                brandCode: getElementValue('product-brand'),
                price: getElementNumber('product-price', 0),
                salePrice: getElementNumber('product-sale-price', 0),
                stock: getElementNumber('product-stock', 0),
                status: getElementValue('product-status') || 'active',
                priority: getElementNumber('product-priority', 50),
                description: getElementValue('product-description'),
                imageUrl: getElementValue('product-image-url'),
                badgeType: getElementValue('product-badge-type'),
                badgeColor: getElementValue('product-badge-color'),
                badgeText: getElementValue('product-badge-text'),
                badgeStartDate: getElementValue('product-badge-start'),
                badgeEndDate: getElementValue('product-badge-end')
            };
        }

        // ==================== 분석 기능 ====================
        
        let revenueChart = null;
        let analyticsData = {
            orders: [],
            users: [],
            pointHistory: []
        };

        // 분석 데이터 로드
        async function loadAnalyticsData() {
            try {
                console.log('📊 분석 데이터 로드 시작');
                
                // 기간 선택 기능과 연동하여 모든 주문 데이터 로드
                // 필터링은 기간 선택 기능에서 처리
                const ordersSnapshot = await firebase.firestore().collection('orders').get();
                
                analyticsData.orders = [];
                ordersSnapshot.forEach(doc => {
                    const data = doc.data();
                    analyticsData.orders.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toDate() || new Date()
                    });
                });
                
                // window.allOrders 설정 (주문 통계용)
                window.allOrders = analyticsData.orders;
                console.log('📋 window.allOrders 설정 완료:', analyticsData.orders.length, '개 주문');
                
                // 사용자 데이터 로드 (모든 사용자 데이터 로드)
                const usersSnapshot = await firebase.firestore().collection('users').get();
                
                analyticsData.users = [];
                usersSnapshot.forEach(doc => {
                    const data = doc.data();
                    analyticsData.users.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toDate() || new Date()
                    });
                });
                
                // 포인트 이력 로드 (모든 포인트 이력 로드)
                const pointsSnapshot = await firebase.firestore().collection('pointHistory').get();
                
                analyticsData.pointHistory = [];
                pointsSnapshot.forEach(doc => {
                    const data = doc.data();
                    analyticsData.pointHistory.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toDate() || new Date()
                    });
                });
                
                console.log('📊 분석 데이터 로드 완료:', {
                    orders: analyticsData.orders.length,
                    users: analyticsData.users.length,
                    pointHistory: analyticsData.pointHistory.length
                });
                
                updateAnalyticsDisplay();
                
            } catch (error) {
                console.error('❌ 분석 데이터 로드 실패:', error);
            }
        }

        // 분석 표시 업데이트
        function updateAnalyticsDisplay() {
            updateSalesMetrics();
            updateCustomerMetrics();
            updatePointMetrics();
            updateTopProducts();
            updateOrderStatusChart();
            updateRevenueChart();
            
            // 하단 분석 데이터 업데이트 (기간별)
            updateBottomAnalytics();
        }

        // 매출 지표 업데이트
        function updateSalesMetrics() {
            if (!analyticsData || !analyticsData.orders) {
                console.warn('⚠️ analyticsData가 없습니다');
                return;
            }
            
            // 기간별 필터링된 주문
            const filteredOrders = filterOrdersByPeriod(analyticsData.orders);
            
            const totalRevenue = filteredOrders.reduce((sum, order) => {
                return sum + (order.totalAmount || 0);
            }, 0);
            
            const totalOrders = filteredOrders.length;
            const avgOrderValue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
            const totalCustomers = analyticsData.users.length;
            
            document.getElementById('total-revenue').textContent = `¥${totalRevenue.toLocaleString()}`;
            document.getElementById('total-orders').textContent = totalOrders.toLocaleString();
            document.getElementById('avg-order-value').textContent = `¥${Math.round(avgOrderValue).toLocaleString()}`;
            document.getElementById('total-customers-analytics').textContent = totalCustomers.toLocaleString();
            
            console.log(`📊 ${currentPeriod} 기간 매출 지표 업데이트:`, {
                revenue: totalRevenue,
                orders: totalOrders,
                avgOrderValue: avgOrderValue
            });
        }

        // 고객 지표 업데이트
        function updateCustomerMetrics() {
            if (!analyticsData || !analyticsData.users) {
                console.warn('⚠️ analyticsData가 없습니다');
                return;
            }
            
            // 기간별 필터링된 주문
            const filteredOrders = filterOrdersByPeriod(analyticsData.orders);
            
            // 고객 분석 업데이트
            const customerEmails = new Set();
            const newCustomerEmails = new Set();
            
            filteredOrders.forEach(order => {
                const email = order.customerEmail || order.email || '';
                if (email) {
                    customerEmails.add(email);
                    
                    // 신규 고객 판단 (첫 주문인지 확인)
                    const previousOrders = analyticsData.orders.filter(o => {
                        const orderDate = o.orderDate && o.orderDate.seconds ? 
                            new Date(o.orderDate.seconds * 1000) : new Date(o.orderDate || 0);
                        const currentOrderDate = order.orderDate && order.orderDate.seconds ? 
                            new Date(order.orderDate.seconds * 1000) : new Date(order.orderDate || 0);
                        return o.customerEmail === email && orderDate < currentOrderDate;
                    });
                    
                    if (previousOrders.length === 0) {
                        newCustomerEmails.add(email);
                    }
                }
            });
            
            const totalCustomers = customerEmails.size;
            const newCustomers = newCustomerEmails.size;
            const returningCustomers = totalCustomers - newCustomers;
            
            const repeatRate = totalCustomers > 0 ? Math.round((returningCustomers / totalCustomers) * 100) : 0;
            
            // DOM 업데이트
            const newCustomersEl = document.getElementById('new-customers');
            const returningCustomersEl = document.getElementById('returning-customers');
            const repeatRateEl = document.getElementById('repeat-rate');
            
            if (newCustomersEl) newCustomersEl.textContent = newCustomers.toLocaleString();
            if (returningCustomersEl) returningCustomersEl.textContent = returningCustomers.toLocaleString();
            if (repeatRateEl) repeatRateEl.textContent = repeatRate + '%';
        }

        // 포인트 지표 업데이트
        function updatePointMetrics() {
            if (!analyticsData || !analyticsData.orders) {
                console.warn('⚠️ analyticsData가 없습니다');
                return;
            }
            
            // 기간별 필터링된 주문
            const filteredOrders = filterOrdersByPeriod(analyticsData.orders);
            
            // 포인트 분석 업데이트
            let pointsEarned = 0;
            let pointsUsed = 0;
            
            filteredOrders.forEach(order => {
                pointsEarned += order.earnedPoints || 0;
                pointsUsed += order.usedPoints || 0;
            });
            
            const pointsUtilization = pointsEarned > 0 ? Math.round((pointsUsed / pointsEarned) * 100) : 0;
            
            // DOM 업데이트
            const pointsEarnedEl = document.getElementById('points-earned');
            const pointsUsedEl = document.getElementById('points-used');
            const pointsUtilizationEl = document.getElementById('points-utilization');
            
            if (pointsEarnedEl) pointsEarnedEl.textContent = pointsEarned.toLocaleString();
            if (pointsUsedEl) pointsUsedEl.textContent = pointsUsed.toLocaleString();
            if (pointsUtilizationEl) pointsUtilizationEl.textContent = pointsUtilization + '%';
        }

        // 인기 상품 TOP5 업데이트
        function updateTopProducts() {
            const productSales = {};
            
            analyticsData.orders.forEach(order => {
                if (order.items) {
                    order.items.forEach(item => {
                        const productName = item.name || item.productName || 'Unknown Product';
                        if (!productSales[productName]) {
                            productSales[productName] = {
                                name: productName,
                                quantity: 0,
                                revenue: 0
                            };
                        }
                        productSales[productName].quantity += item.quantity || 1;
                        productSales[productName].revenue += (item.price || 0) * (item.quantity || 1);
                    });
                }
            });
            
            const topProducts = Object.values(productSales)
                .sort((a, b) => b.revenue - a.revenue)
                .slice(0, 5);
            
            const container = document.getElementById('top-products-list');
            if (topProducts.length === 0) {
                container.innerHTML = '<div class="text-center text-muted">データがありません</div>';
                return;
            }
            
            container.innerHTML = topProducts.map((product, index) => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="d-flex align-items-center">
                        <span class="badge bg-secondary me-2">${index + 1}</span>
                        <span class="japanese-text">${product.name}</span>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold">¥${product.revenue.toLocaleString()}</div>
                        <small class="text-muted">${product.quantity}個</small>
                    </div>
                </div>
            `).join('');
        }

        // 주문 상태 차트 업데이트
        function updateOrderStatusChart() {
            const statusCounts = {};
            
            analyticsData.orders.forEach(order => {
                const status = order.status || 'pending';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });
            
            const container = document.getElementById('order-status-chart');
            if (Object.keys(statusCounts).length === 0) {
                container.innerHTML = '<div class="text-center text-muted">データがありません</div>';
                return;
            }
            
            const statusLabels = {
                'pending': '処理中',
                'processing': '処理中',
                'shipped': '配送中',
                'delivered': '配送完了',
                'cancelled': 'キャンセル'
            };
            
            container.innerHTML = Object.entries(statusCounts).map(([status, count]) => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="japanese-text">${statusLabels[status] || status}</span>
                    <span class="badge bg-secondary">${count}</span>
                </div>
            `).join('');
        }

        // 매출 추이 차트 업데이트
        function updateRevenueChart() {
            // 기간 선택 기능과 연동
            let days = 30; // 기본값
            
            if (currentPeriod === 'day') {
                days = 1;
            } else if (currentPeriod === 'week') {
                days = 7;
            } else if (currentPeriod === 'month') {
                days = 30;
            } else if (currentPeriod === 'year') {
                days = 365;
            }
            
            // 일별 매출 데이터 생성
            const dailyRevenue = {};
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                dailyRevenue[dateStr] = 0;
            }
            
            analyticsData.orders.forEach(order => {
                const orderDate = order.createdAt.toISOString().split('T')[0];
                if (dailyRevenue.hasOwnProperty(orderDate)) {
                    dailyRevenue[orderDate] += order.totalAmount || 0;
                }
            });
            
            const labels = Object.keys(dailyRevenue).map(date => {
                const d = new Date(date);
                return `${d.getMonth() + 1}/${d.getDate()}`;
            });
            const data = Object.values(dailyRevenue);
            
            const ctx = document.getElementById('revenueChart');
            if (!ctx) return;
            
            if (revenueChart) {
                revenueChart.destroy();
            }
            
            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '売上 (¥)',
                        data: data,
                        borderColor: '#6c757d',
                        backgroundColor: 'rgba(108, 117, 125, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // 분석 새로고침
        function refreshAnalytics() {
            console.log('🔄 분석 데이터 새로고침');
            loadAnalyticsData();
        }

        // 분석 탭 전환 시 데이터 로드
        window.switchToAnalytics = function() {
            console.log('📊 분석 탭으로 전환');
            hideAllTabs();
            showTab('analytics-section');
            updateTabButtons('analytics-tab');
            
            // 기간 선택 기능 초기화
            setTimeout(() => {
                if (typeof initializePeriodSelector === 'function') {
                    initializePeriodSelector();
                }
                // 분석 데이터 로드
                loadAnalyticsData();
            }, 100);
        };

        // ==================== 고객 관리 기능 ====================
        
        let customersData = [];
        let filteredCustomers = [];
        
        // 고객 등급 시스템
        const customerTiers = {
            '일반': { minAmount: 0, color: '#6c757d', icon: 'fas fa-user' },
            '실버': { minAmount: 500000, color: '#6c757d', icon: 'fas fa-medal' },
            '골드': { minAmount: 1000000, color: '#495057', icon: 'fas fa-crown' },
            'VIP': { minAmount: 2000000, color: '#212529', icon: 'fas fa-gem' }
        };
        
        // 고객 등급 계산 함수
        function calculateCustomerTier(totalSpent) {
            if (totalSpent >= customerTiers.VIP.minAmount) return 'VIP';
            if (totalSpent >= customerTiers.골드.minAmount) return '골드';
            if (totalSpent >= customerTiers.실버.minAmount) return '실버';
            return '일반';
        }
        
        // 등급별 배지 생성 함수
        function generateTierBadge(tier) {
            const tierInfo = customerTiers[tier];
            const tierNames = {
                '일반': '一般',
                '실버': 'シルバー',
                '골드': 'ゴールド',
                'VIP': 'VIP'
            };
            return `<span class="badge" style="background-color: ${tierInfo.color}; color: white;">
                <i class="${tierInfo.icon} me-1"></i>${tierNames[tier] || tier}
            </span>`;
        }

        // 고객 데이터 로드
        async function loadCustomers() {
            try {
                console.log('👥 고객 데이터 로드 시작');
                
                // Firebase에서 고객 데이터 로드
                const usersSnapshot = await firebase.firestore().collection('users').get();
                const rawCustomers = [];
                
                usersSnapshot.forEach(doc => {
                    const data = doc.data();
                    rawCustomers.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toDate() || new Date()
                    });
                });
                
                // 중복 제거 (이메일 기준으로 통합)
                const uniqueCustomers = {};
                rawCustomers.forEach(customer => {
                    const email = customer.email;
                    if (email) {
                        if (!uniqueCustomers[email]) {
                            uniqueCustomers[email] = customer;
                        } else {
                            // 중복된 경우 더 완전한 데이터를 유지
                            const existing = uniqueCustomers[email];
                            const merged = {
                                ...existing,
                                ...customer,
                                // 더 최근의 createdAt을 유지
                                createdAt: customer.createdAt > existing.createdAt ? 
                                    customer.createdAt : existing.createdAt,
                                // 더 높은 포인트를 유지
                                points: Math.max(existing.points || 0, customer.points || 0)
                            };
                            uniqueCustomers[email] = merged;
                        }
                    }
                });
                
                customersData = Object.values(uniqueCustomers);
                
                console.log('👥 중복 제거 결과:', {
                    원본: rawCustomers.length,
                    중복제거후: customersData.length,
                    제거된중복: rawCustomers.length - customersData.length
                });
                
                // 주문 데이터와 결합하여 고객 통계 계산
                await calculateCustomerStats();
                
                // 필터링된 고객 목록 업데이트
                filterCustomers();
                
                console.log('👥 고객 데이터 로드 완료:', customersData.length);
                
            } catch (error) {
                console.error('❌ 고객 데이터 로드 실패:', error);
            }
        }

        // 고객 통계 계산
        async function calculateCustomerStats() {
            try {
                // 주문 데이터 로드
                const ordersSnapshot = await firebase.firestore().collection('orders').get();
                const orders = [];
                ordersSnapshot.forEach(doc => {
                    const data = doc.data();
                    orders.push({
                        ...data,
                        createdAt: data.createdAt?.toDate() || new Date()
                    });
                });
                
                // 고객별 주문 통계 계산
                const customerStats = {};
                orders.forEach(order => {
                    const email = order.userEmail;
                    if (!customerStats[email]) {
                        customerStats[email] = {
                            orderCount: 0,
                            totalSpent: 0,
                            lastOrderDate: null
                        };
                    }
                    customerStats[email].orderCount++;
                    customerStats[email].totalSpent += order.totalAmount || 0;
                    if (!customerStats[email].lastOrderDate || order.createdAt > customerStats[email].lastOrderDate) {
                        customerStats[email].lastOrderDate = order.createdAt;
                    }
                });
                
                // 고객 데이터에 통계 추가
                customersData.forEach(customer => {
                    const stats = customerStats[customer.email] || {
                        orderCount: 0,
                        totalSpent: 0,
                        lastOrderDate: null
                    };
                    customer.orderCount = stats.orderCount;
                    customer.totalSpent = stats.totalSpent;
                    customer.lastOrderDate = stats.lastOrderDate;
                    
                    // VIP 고객 판정 (총 구매액 50,000엔 이상)
                    customer.isVip = stats.totalSpent >= 50000;
                    
                    // 비활성 고객 판정 (마지막 주문이 90일 이상 전)
                    const daysSinceLastOrder = customer.lastOrderDate ? 
                        Math.floor((new Date() - customer.lastOrderDate) / (1000 * 60 * 60 * 24)) : 999;
                    customer.isInactive = daysSinceLastOrder >= 90;
                });
                
                updateCustomerStats();
                
            } catch (error) {
                console.error('❌ 고객 통계 계산 실패:', error);
            }
        }

        // 고객 통계 업데이트
        function updateCustomerStats() {
            const totalCustomers = customersData.length;
            const newCustomers = customersData.filter(c => {
                const daysSinceJoin = Math.floor((new Date() - c.createdAt) / (1000 * 60 * 60 * 24));
                return daysSinceJoin <= 30;
            }).length;
            
            // 새로운 등급 시스템으로 VIP 고객 계산
            const vipCustomers = customersData.filter(c => {
                const tier = calculateCustomerTier(c.totalSpent || 0);
                return tier === 'VIP';
            }).length;
            
            const avgOrderValue = customersData.length > 0 ? 
                customersData.reduce((sum, c) => sum + (c.totalSpent || 0), 0) / customersData.length : 0;
            
            document.getElementById('total-customers-count').textContent = totalCustomers.toLocaleString();
            document.getElementById('new-customers-count').textContent = newCustomers.toLocaleString();
            document.getElementById('vip-customers-count').textContent = vipCustomers.toLocaleString();
            document.getElementById('avg-order-value-customers').textContent = `¥${Math.round(avgOrderValue).toLocaleString()}`;
        }

        // 고객 필터링
        function filterCustomers() {
            const searchTerm = document.getElementById('customer-search')?.value.toLowerCase() || '';
            const filterType = document.getElementById('customer-filter')?.value || 'all';
            
            filteredCustomers = customersData.filter(customer => {
                // 검색어 필터
                const matchesSearch = !searchTerm || 
                    customer.name?.toLowerCase().includes(searchTerm) ||
                    customer.email?.toLowerCase().includes(searchTerm);
                
                // 타입 필터
                let matchesFilter = true;
                switch (filterType) {
                    case 'new':
                        const daysSinceJoin = Math.floor((new Date() - customer.createdAt) / (1000 * 60 * 60 * 24));
                        matchesFilter = daysSinceJoin <= 30;
                        break;
                    case 'vip':
                        matchesFilter = customer.isVip;
                        break;
                    case 'inactive':
                        matchesFilter = customer.isInactive;
                        break;
                }
                
                return matchesSearch && matchesFilter;
            });
            
            displayCustomers();
        }

        // 고객 목록 표시
        function displayCustomers() {
            const tbody = document.getElementById('customers-table-body');
            if (!tbody) return;
            
            if (filteredCustomers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">該当する顧客が見つかりません</td></tr>';
                return;
            }
            
            // 최신 방문일 기준으로 정렬 (활성 고객이 상단에)
            const sortedCustomers = [...filteredCustomers].sort((a, b) => {
                const lastVisitA = a.lastVisit || a.createdAt;
                const lastVisitB = b.lastVisit || b.createdAt;
                return new Date(lastVisitB) - new Date(lastVisitA);
            });
            
            tbody.innerHTML = sortedCustomers.map(customer => {
                const joinDate = customer.createdAt.toLocaleDateString('ja-JP');
                const lastVisitDate = (customer.lastVisit || customer.createdAt).toLocaleDateString('ja-JP');
                const statusBadge = customer.isVip ? 
                    '<span class="badge bg-warning">VIP</span>' :
                    customer.isInactive ? 
                    '<span class="badge bg-secondary">非アクティブ</span>' :
                    '<span class="badge bg-success">アクティブ</span>';
                
                // 고객 등급 계산
                const tier = calculateCustomerTier(customer.totalSpent || 0);
                const tierBadge = generateTierBadge(tier);
                
                return `
                    <tr>
                        <td>
                            <div>
                                <strong class="japanese-text">${customer.name || 'Unknown'}</strong><br>
                                <small class="text-muted">${customer.email}</small>
                            </div>
                        </td>
                        <td>${tierBadge}</td>
                        <td class="japanese-text">${lastVisitDate}</td>
                        <td>${customer.orderCount || 0}</td>
                        <td>¥${(customer.totalSpent || 0).toLocaleString()}</td>
                        <td>${(customer.points || 0).toLocaleString()}pt</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-secondary" onclick="viewCustomerDetail('${customer.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="changeCustomerTier('${customer.id}', '${tier}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="sendEmailToCustomer('${customer.email}')">
                                <i class="fas fa-envelope"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 고객 검색
        function searchCustomers() {
            filterCustomers();
        }

        // 고객 새로고침
        function refreshCustomers() {
            console.log('🔄 고객 데이터 새로고침');
            loadCustomers();
        }

        // 고객 등급 변경 모달
        function changeCustomerTier(customerId, currentTier) {
            const customer = customersData.find(c => c.id === customerId);
            if (!customer) return;
            
            const modalHtml = `
                <div class="modal fade" id="changeTierModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">顧客等級変更</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">顧客情報</label>
                                    <div class="p-2 bg-light rounded">
                                        <strong>${customer.name || 'Unknown'}</strong><br>
                                        <small class="text-muted">${customer.email}</small><br>
                                        <small class="text-muted">総購入額: ¥${(customer.totalSpent || 0).toLocaleString()}</small><br>
                                        <small class="text-muted">登録日: ${customer.createdAt.toLocaleDateString('ja-JP')}</small><br>
                                        <small class="text-muted">最終訪問日: ${(customer.lastVisit || customer.createdAt).toLocaleDateString('ja-JP')}</small>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">現在の等級</label>
                                    <div class="p-2">${generateTierBadge(currentTier)}</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">新しい等級を選択</label>
                                    <select class="form-select" id="newTierSelect">
                                        <option value="일반" ${currentTier === '일반' ? 'selected' : ''}>一般</option>
                                        <option value="실버" ${currentTier === '실버' ? 'selected' : ''}>シルバー</option>
                                        <option value="골드" ${currentTier === '골드' ? 'selected' : ''}>ゴールド</option>
                                        <option value="VIP" ${currentTier === 'VIP' ? 'selected' : ''}>VIP</option>
                                    </select>
                                </div>
                                <div class="alert alert-info">
                                    <small>
                                        <strong>等級基準:</strong><br>
                                        • 一般: 購入額 0円以上<br>
                                        • シルバー: 購入額 50万円以上<br>
                                        • ゴールド: 購入額 100万円以上<br>
                                        • VIP: 購入額 200万円以上
                                    </small>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                                <button type="button" class="btn btn-dark" onclick="saveCustomerTier('${customerId}')">保存</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 기존 모달 제거
            const existingModal = document.getElementById('changeTierModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 새 모달 추가
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('changeTierModal'));
            modal.show();
        }
        
        // 고객 등급 저장
        async function saveCustomerTier(customerId) {
            try {
                const newTier = document.getElementById('newTierSelect').value;
                
                // Firebase에서 고객 데이터 업데이트
                await firebase.firestore().collection('users').doc(customerId).update({
                    tier: newTier,
                    tierUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 로컬 데이터 업데이트
                const customer = customersData.find(c => c.id === customerId);
                if (customer) {
                    customer.tier = newTier;
                }
                
                // 테이블 새로고침
                displayCustomers();
                
                // 모달 닫기
                const modal = bootstrap.Modal.getInstance(document.getElementById('changeTierModal'));
                modal.hide();
                
                showAdminAlert(`顧客等級を「${newTier}」に変更しました`, 'success');
                
            } catch (error) {
                console.error('고객 등급 변경 실패:', error);
                showAdminAlert('顧客等級の変更に失敗しました', 'danger');
            }
        }

        // 고객 상세 보기
        function viewCustomerDetail(customerId) {
            const customer = customersData.find(c => c.id === customerId);
            if (!customer) return;
            
            alert(`고객 상세 정보:\n\n이름: ${customer.name}\n이메일: ${customer.email}\n가입일: ${customer.createdAt.toLocaleDateString('ja-JP')}\n주문 수: ${customer.orderCount}\n총 구매액: ¥${(customer.totalSpent || 0).toLocaleString()}\n포인트: ${(customer.points || 0).toLocaleString()}pt`);
        }

        // 개별 고객에게 이메일 발송
        function sendEmailToCustomer(email) {
            document.getElementById('target-segment').value = 'custom';
            document.getElementById('email-subject').value = '';
            document.getElementById('email-content').value = '';
            showEmailCampaignModal();
        }

        // 이메일 캠페인 모달 표시
        function showEmailCampaignModal() {
            const modal = new bootstrap.Modal(document.getElementById('emailCampaignModal'));
            modal.show();
            updateTargetCount();
        }

        // 캠페인 템플릿 업데이트
        function updateCampaignTemplate() {
            const type = document.getElementById('campaign-type').value;
            const subjectField = document.getElementById('email-subject');
            const contentField = document.getElementById('email-content');
            
            const templates = {
                'birthday': {
                    subject: '🎉 お誕生日おめでとうございます！',
                    content: 'お誕生日おめでとうございます！\n\n特別な日をお祝いして、特別割引をご用意いたしました。\n\nこの機会にぜひご利用ください。\n\nAether チーム'
                },
                'welcome': {
                    subject: 'Aetherへようこそ！',
                    content: 'Aetherにご登録いただき、ありがとうございます！\n\n新規登録特典として300ポイントをプレゼントいたします。\n\nぜひお買い物をお楽しみください。\n\nAether チーム'
                },
                'promotion': {
                    subject: '🎁 特別セール開催中！',
                    content: '特別セールを開催いたします！\n\n期間限定で最大50%OFF！\n\nこの機会をお見逃しなく！\n\nAether チーム'
                },
                'abandoned-cart': {
                    subject: 'カートの商品をお忘れではありませんか？',
                    content: 'カートに商品が残っています。\n\n特別割引でお買い物を完了しませんか？\n\nAether チーム'
                },
                'order-confirmation': {
                    subject: 'ご注文ありがとうございます',
                    content: 'ご注文を承りました。\n\n注文内容を確認いたします。\n\nAether チーム'
                },
                'shipping-notification': {
                    subject: '商品を発送いたしました',
                    content: 'ご注文いただいた商品を発送いたしました。\n\nお届け予定日をお知らせいたします。\n\nAether チーム'
                }
            };
            
            if (templates[type]) {
                subjectField.value = templates[type].subject;
                contentField.value = templates[type].content;
            } else {
                subjectField.value = '';
                contentField.value = '';
            }
            
            updateTargetCount();
        }

        // 대상 고객 수 업데이트
        function updateTargetCount() {
            const segment = document.getElementById('target-segment').value;
            let count = 0;
            
            switch (segment) {
                case 'all':
                    count = customersData.length;
                    break;
                case 'new':
                    count = customersData.filter(c => {
                        const daysSinceJoin = Math.floor((new Date() - c.createdAt) / (1000 * 60 * 60 * 24));
                        return daysSinceJoin <= 30;
                    }).length;
                    break;
                case 'vip':
                    count = customersData.filter(c => c.isVip).length;
                    break;
                case 'inactive':
                    count = customersData.filter(c => c.isInactive).length;
                    break;
                case 'high-value':
                    count = customersData.filter(c => (c.totalSpent || 0) >= 100000).length;
                    break;
            }
            
            document.getElementById('target-count').textContent = count;
        }

        // 이메일 캠페인 발송
        function sendEmailCampaign() {
            const subject = document.getElementById('email-subject').value;
            const content = document.getElementById('email-content').value;
            const segment = document.getElementById('target-segment').value;
            const sendTime = document.getElementById('send-time').value;
            
            if (!subject || !content) {
                alert('件名と内容を入力してください。');
                return;
            }
            
            // 실제 이메일 발송은 백엔드 서비스가 필요하지만, 여기서는 시뮬레이션
            console.log('📧 이메일 캠페인 발송:', {
                subject,
                content,
                segment,
                sendTime,
                targetCount: document.getElementById('target-count').textContent
            });
            
            alert(`이메일 캠페인이 발송되었습니다!\n\n대상: ${document.getElementById('target-count').textContent}명\n제목: ${subject}`);
            
            // 모달 닫기
            const modal = bootstrap.Modal.getInstance(document.getElementById('emailCampaignModal'));
            modal.hide();
        }

        // 고객 관리 탭 전환 시 데이터 로드
        window.switchToCustomers = function() {
            console.log('👥 고객 관리 탭으로 전환');
            hideAllTabs();
            showTab('customers-section');
            updateTabButtons('customers-tab');
            
            // 고객 데이터 로드
            loadCustomers();
        };
        
    </script>
</body>
</html>
