<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상품 저장 테스트 - Aether</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-section {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-result {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .test-success {
            background-color: #d1edff;
            border: 1px solid #0dcaf0;
            color: #055160;
        }
        .test-error {
            background-color: #f8d7da;
            border: 1px solid #dc3545;
            color: #721c24;
        }
        .test-warning {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            color: #664d03;
        }
        .console-output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .image-preview {
            max-width: 100px;
            max-height: 100px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">
            <i class="fas fa-vial me-2"></i>상품 저장 테스트 페이지
        </h1>
        
        <!-- Firebase 연결 테스트 -->
        <div class="test-section">
            <h3><i class="fas fa-plug me-2"></i>1. Firebase 연결 테스트</h3>
            <button class="btn btn-primary" onclick="testFirebaseConnection()">Firebase 연결 테스트</button>
            <div id="firebase-test-result"></div>
        </div>

        <!-- 브랜드 데이터 테스트 -->
        <div class="test-section">
            <h3><i class="fas fa-tags me-2"></i>2. 브랜드 데이터 로드 테스트</h3>
            <button class="btn btn-secondary" onclick="testBrandData()">브랜드 데이터 로드</button>
            <div id="brand-test-result"></div>
        </div>

        <!-- 이미지 업로드 테스트 -->
        <div class="test-section">
            <h3><i class="fas fa-image me-2"></i>3. 이미지 업로드 테스트</h3>
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">메인 이미지</label>
                    <input type="file" class="form-control" id="test-main-image" accept="image/*" onchange="previewTestImage('main', this)">
                    <div id="test-main-preview" class="mt-2"></div>
                </div>
                <div class="col-md-6">
                    <label class="form-label">추가 이미지</label>
                    <input type="file" class="form-control" id="test-additional-image" accept="image/*" onchange="previewTestImage('additional', this)">
                    <div id="test-additional-preview" class="mt-2"></div>
                </div>
            </div>
            <button class="btn btn-info mt-3" onclick="testImageUpload()">이미지 업로드 테스트</button>
            <div id="image-test-result"></div>
        </div>

        <!-- 상품 데이터 저장 테스트 -->
        <div class="test-section">
            <h3><i class="fas fa-save me-2"></i>4. 상품 데이터 저장 테스트</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">상품 코드</label>
                        <input type="text" class="form-control" id="test-product-code" value="TEST-PRODUCT-001">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">상품명 (영어)</label>
                        <input type="text" class="form-control" id="test-product-name-en" value="Test Product">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">상품명 (일본어)</label>
                        <input type="text" class="form-control" id="test-product-name-jp" value="テスト商品">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">브랜드</label>
                        <select class="form-select" id="test-product-brand">
                            <option value="">브랜드 선택</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">가격</label>
                        <input type="number" class="form-control" id="test-product-price" value="10000">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">재고</label>
                        <input type="number" class="form-control" id="test-product-stock" value="100">
                    </div>
                </div>
            </div>
            <button class="btn btn-success" onclick="testProductSave()">상품 저장 테스트</button>
            <div id="save-test-result"></div>
        </div>

        <!-- 저장된 데이터 로드 테스트 -->
        <div class="test-section">
            <h3><i class="fas fa-download me-2"></i>5. 저장된 데이터 로드 테스트</h3>
            <button class="btn btn-warning" onclick="testProductLoad()">저장된 상품 로드</button>
            <div id="load-test-result"></div>
        </div>

        <!-- 콘솔 출력 -->
        <div class="test-section">
            <h3><i class="fas fa-terminal me-2"></i>테스트 로그</h3>
            <button class="btn btn-outline-secondary btn-sm" onclick="clearTestLog()">로그 지우기</button>
            <div id="test-console" class="console-output mt-2"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyBQJQJQJQJQJQJQJQJQJQJQJQJQJQJQJQ",
            authDomain: "aether-fixed.firebaseapp.com",
            projectId: "aether-fixed",
            storageBucket: "aether-fixed.firebasestorage.app",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdefghijklmnopqrstuv"
        };

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        // 전역 변수로 설정
        window.db = db;
        window.storage = storage;
        window.auth = auth;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.ref = ref;
        window.uploadBytes = uploadBytes;
        window.getDownloadURL = getDownloadURL;
        window.signInAnonymously = signInAnonymously;

        // 테스트 로그 함수
        window.testLog = function(message, type = 'info') {
            const console = document.getElementById('test-console');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            console.textContent += logEntry;
            console.scrollTop = console.scrollHeight;
            
            // 콘솔에도 출력
            if (type === 'error') {
                console.error(message);
            } else if (type === 'warning') {
                console.warn(message);
            } else {
                console.log(message);
            }
        };

        // 결과 표시 함수
        window.showTestResult = function(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="test-result test-${type}">${message}</div>`;
        };

        // Firebase 연결 테스트
        window.testFirebaseConnection = async function() {
            testLog('Firebase 연결 테스트 시작...');
            
            try {
                // 익명 인증
                const userCredential = await signInAnonymously(auth);
                testLog(`익명 인증 성공: ${userCredential.user.uid}`, 'success');
                
                // Firestore 연결 테스트
                const testCollection = collection(db, 'test');
                testLog('Firestore 연결 성공', 'success');
                
                // Storage 연결 테스트
                const testRef = ref(storage, 'test/test.txt');
                testLog('Storage 연결 성공', 'success');
                
                showTestResult('firebase-test-result', 
                    '<i class="fas fa-check-circle me-2"></i>Firebase 연결 성공!<br>' +
                    '• 인증: 성공<br>' +
                    '• Firestore: 연결됨<br>' +
                    '• Storage: 연결됨', 'success');
                
            } catch (error) {
                testLog(`Firebase 연결 실패: ${error.message}`, 'error');
                showTestResult('firebase-test-result', 
                    `<i class="fas fa-exclamation-triangle me-2"></i>Firebase 연결 실패<br>${error.message}`, 'error');
            }
        };

        // 브랜드 데이터 테스트
        window.testBrandData = async function() {
            testLog('브랜드 데이터 로드 테스트 시작...');
            
            try {
                const brandsSnapshot = await getDocs(collection(db, 'brands'));
                const brands = [];
                
                brandsSnapshot.forEach((doc) => {
                    brands.push({ id: doc.id, ...doc.data() });
                });
                
                testLog(`브랜드 ${brands.length}개 로드 성공`, 'success');
                
                // 브랜드 선택 옵션 업데이트
                const brandSelect = document.getElementById('test-product-brand');
                brandSelect.innerHTML = '<option value="">브랜드 선택</option>';
                brands.forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand.code;
                    option.textContent = brand.nameJp || brand.nameEn;
                    brandSelect.appendChild(option);
                });
                
                showTestResult('brand-test-result', 
                    `<i class="fas fa-check-circle me-2"></i>브랜드 데이터 로드 성공!<br>총 ${brands.length}개 브랜드`, 'success');
                
            } catch (error) {
                testLog(`브랜드 데이터 로드 실패: ${error.message}`, 'error');
                showTestResult('brand-test-result', 
                    `<i class="fas fa-exclamation-triangle me-2"></i>브랜드 데이터 로드 실패<br>${error.message}`, 'error');
            }
        };

        // 이미지 미리보기
        window.previewTestImage = function(type, input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewId = `test-${type}-preview`;
                const preview = document.getElementById(previewId);
                preview.innerHTML = `<img src="${e.target.result}" class="image-preview" alt="미리보기">`;
            };
            reader.readAsDataURL(file);
        };

        // 이미지 업로드 테스트
        window.testImageUpload = async function() {
            testLog('이미지 업로드 테스트 시작...');
            
            const mainFile = document.getElementById('test-main-image').files[0];
            const additionalFile = document.getElementById('test-additional-image').files[0];
            
            if (!mainFile && !additionalFile) {
                testLog('업로드할 이미지가 없습니다', 'warning');
                showTestResult('image-test-result', 
                    '<i class="fas fa-exclamation-triangle me-2"></i>업로드할 이미지가 없습니다', 'warning');
                return;
            }
            
            const results = [];
            
            try {
                // 메인 이미지 업로드
                if (mainFile) {
                    testLog(`메인 이미지 업로드 시작: ${mainFile.name}`);
                    const mainRef = ref(storage, `test-products/main-${Date.now()}-${mainFile.name}`);
                    const mainSnapshot = await uploadBytes(mainRef, mainFile);
                    const mainUrl = await getDownloadURL(mainSnapshot.ref);
                    testLog(`메인 이미지 업로드 성공: ${mainUrl}`, 'success');
                    results.push(`메인 이미지: 성공`);
                }
                
                // 추가 이미지 업로드
                if (additionalFile) {
                    testLog(`추가 이미지 업로드 시작: ${additionalFile.name}`);
                    const additionalRef = ref(storage, `test-products/additional-${Date.now()}-${additionalFile.name}`);
                    const additionalSnapshot = await uploadBytes(additionalRef, additionalFile);
                    const additionalUrl = await getDownloadURL(additionalSnapshot.ref);
                    testLog(`추가 이미지 업로드 성공: ${additionalUrl}`, 'success');
                    results.push(`추가 이미지: 성공`);
                }
                
                showTestResult('image-test-result', 
                    `<i class="fas fa-check-circle me-2"></i>이미지 업로드 성공!<br>${results.join('<br>')}`, 'success');
                
            } catch (error) {
                testLog(`이미지 업로드 실패: ${error.message}`, 'error');
                showTestResult('image-test-result', 
                    `<i class="fas fa-exclamation-triangle me-2"></i>이미지 업로드 실패<br>${error.message}`, 'error');
            }
        };

        // 상품 저장 테스트
        window.testProductSave = async function() {
            testLog('상품 저장 테스트 시작...');
            
            const productData = {
                code: document.getElementById('test-product-code').value,
                nameEn: document.getElementById('test-product-name-en').value,
                nameJp: document.getElementById('test-product-name-jp').value,
                brandCode: document.getElementById('test-product-brand').value,
                price: parseInt(document.getElementById('test-product-price').value),
                stock: parseInt(document.getElementById('test-product-stock').value),
                status: 'active',
                priority: 50,
                createdAt: new Date(),
                updatedAt: new Date()
            };
            
            testLog(`상품 데이터: ${JSON.stringify(productData, null, 2)}`);
            
            try {
                // 중복 체크
                const existingProducts = await getDocs(collection(db, 'products'));
                const duplicate = existingProducts.docs.find(doc => doc.data().code === productData.code);
                
                if (duplicate) {
                    testLog(`상품 코드 중복: ${productData.code}`, 'warning');
                    showTestResult('save-test-result', 
                        `<i class="fas fa-exclamation-triangle me-2"></i>상품 코드 중복<br>이미 존재하는 상품 코드입니다`, 'warning');
                    return;
                }
                
                // 상품 저장
                const docRef = await addDoc(collection(db, 'products'), productData);
                testLog(`상품 저장 성공: ${docRef.id}`, 'success');
                
                showTestResult('save-test-result', 
                    `<i class="fas fa-check-circle me-2"></i>상품 저장 성공!<br>문서 ID: ${docRef.id}`, 'success');
                
            } catch (error) {
                testLog(`상품 저장 실패: ${error.message}`, 'error');
                showTestResult('save-test-result', 
                    `<i class="fas fa-exclamation-triangle me-2"></i>상품 저장 실패<br>${error.message}`, 'error');
            }
        };

        // 저장된 데이터 로드 테스트
        window.testProductLoad = async function() {
            testLog('저장된 상품 로드 테스트 시작...');
            
            try {
                const productsSnapshot = await getDocs(collection(db, 'products'));
                const products = [];
                
                productsSnapshot.forEach((doc) => {
                    products.push({ id: doc.id, ...doc.data() });
                });
                
                testLog(`상품 ${products.length}개 로드 성공`, 'success');
                
                // 최근 5개 상품만 표시
                const recentProducts = products.slice(-5);
                let productListHtml = '<h6>최근 저장된 상품 (최대 5개):</h6>';
                
                recentProducts.forEach(product => {
                    productListHtml += `
                        <div class="border p-2 mb-2 rounded">
                            <strong>${product.nameJp || product.nameEn}</strong><br>
                            <small>코드: ${product.code} | 브랜드: ${product.brandCode} | 가격: ${product.price}원</small>
                        </div>
                    `;
                });
                
                showTestResult('load-test-result', 
                    `<i class="fas fa-check-circle me-2"></i>상품 로드 성공!<br>총 ${products.length}개 상품<br><br>${productListHtml}`, 'success');
                
            } catch (error) {
                testLog(`상품 로드 실패: ${error.message}`, 'error');
                showTestResult('load-test-result', 
                    `<i class="fas fa-exclamation-triangle me-2"></i>상품 로드 실패<br>${error.message}`, 'error');
            }
        };

        // 로그 지우기
        window.clearTestLog = function() {
            document.getElementById('test-console').textContent = '';
        };

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            testLog('테스트 페이지 로드 완료');
            testLog('Firebase 설정 완료');
        });
    </script>
</body>
</html>
