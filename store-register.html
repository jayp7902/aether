<!DOCTYPE html>
<html lang="ja">
<head>
    <title>店舗会員登録 - Aether</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="apple-touch-icon" href="assets/img/aether-icon.png">
    <link rel="shortcut icon" type="image/x-icon" href="assets/img/aether-icon.png">
    
    <!-- CSS -->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/templatemo.css">
    <link rel="stylesheet" href="assets/css/custom.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800;900&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100;200;300;400;500;600;700;800;900&display=swap">
    <link rel="stylesheet" href="assets/css/fontawesome.min.css">
    
    <!-- QR Code Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    
    <style>
        body {
            font-family: "Montserrat", sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }
        
        .japanese-text {
            font-family: "Noto Sans JP", sans-serif;
            font-weight: 400;
            line-height: 1.6;
        }
        
        .japanese-heading {
            font-family: "Noto Sans JP", sans-serif;
            font-weight: 600;
            line-height: 1.4;
        }
        
        .store-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .store-header {
            background: linear-gradient(135deg, #343a40 0%, #495057 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .register-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .success-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            display: none;
        }
        
        .form-control {
            font-size: 1.2rem;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #dee2e6;
            margin-bottom: 20px;
        }
        
        .form-control:focus {
            border-color: #343a40;
            box-shadow: 0 0 0 0.2rem rgba(52, 58, 64, 0.25);
        }
        
        .btn-large {
            padding: 15px 30px;
            font-size: 1.3rem;
            border-radius: 10px;
            font-weight: bold;
            min-width: 200px;
        }
        
        .qr-display {
            background: #f8f9fa;
            border: 3px solid #343a40;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
        }
        
        .qr-code-container {
            text-align: center;
            margin: 20px auto;
        }
        
        .qr-code-container canvas {
            margin: 0 auto;
            border: 2px solid #343a40;
            border-radius: 8px;
        }
        
        .customer-info-card {
            background: linear-gradient(135deg, #343a40 0%, #6c757d 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .mode-selector {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .mode-btn {
            padding: 15px 30px;
            margin: 10px;
            border: 3px solid #343a40;
            background: white;
            color: #343a40;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 200px;
        }
        
        .mode-btn:hover,
        .mode-btn.active {
            background: #343a40;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .tablet-optimized {
            touch-action: manipulation;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
        }
        
        .staff-helper {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .customer-helper {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .store-container {
                padding: 15px;
            }
            
            .register-section {
                padding: 25px;
            }
            
            .mode-btn {
                display: block;
                width: 100%;
                margin: 10px 0;
            }
        }
    </style>
</head>

<body class="tablet-optimized">
    <!-- 알림 컨테이너 -->
    <div id="alert-container" class="alert-container"></div>

    <div class="store-container">
        <!-- 매장 헤더 -->
        <div class="store-header">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <img src="assets/img/logo.png" alt="Aether Logo" class="img-fluid" style="max-height: 60px;">
                </div>
                <div class="col-md-6">
                    <h2 class="mb-0 japanese-heading">店舗会員登録</h2>
                    <p class="mb-0 japanese-text">新規お客様登録システム</p>
                </div>
                <div class="col-md-3 text-end">
                    <div class="japanese-text">
                        <div id="current-time" style="font-size: 1.2rem; font-weight: bold;"></div>
                        <small>店舗専用</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 모드 선택 -->
        <div class="mode-selector" id="mode-selector">
            <h3 class="japanese-heading mb-4">登録方法をお選びください</h3>
            <div class="row">
                <div class="col-md-6">
                    <button class="mode-btn" onclick="selectMode('customer')">
                        <i class="fas fa-mobile-alt me-2"></i>
                        <div class="japanese-text">お客様自身で登録</div>
                        <small class="d-block mt-1">お客様がご自身で入力</small>
                    </button>
                </div>
                <div class="col-md-6">
                    <button class="mode-btn" onclick="selectMode('staff')">
                        <i class="fas fa-user-tie me-2"></i>
                        <div class="japanese-text">スタッフが代行登録</div>
                        <small class="d-block mt-1">スタッフが入力をサポート</small>
                    </button>
                </div>
            </div>
        </div>

        <!-- 가입 섹션 -->
        <div class="register-section" id="register-section" style="display: none;">
            <!-- 모드별 안내 -->
            <div class="staff-helper" id="staff-helper" style="display: none;">
                <h5 class="japanese-heading">
                    <i class="fas fa-info-circle me-2"></i>スタッフ向けガイド
                </h5>
                <ul class="japanese-text mb-0">
                    <li>お客様のメールアドレスとパスワードを確認してください</li>
                    <li>登録完了後、QRコードをお客様にお見せください</li>
                    <li>お客様のスマートフォンでQRコードを保存いただけます</li>
                </ul>
            </div>

            <div class="customer-helper" id="customer-helper" style="display: none;">
                <h5 class="japanese-heading">
                    <i class="fas fa-info-circle me-2"></i>お客様へ
                </h5>
                <ul class="japanese-text mb-0">
                    <li>メールアドレスとパスワードをご入力ください</li>
                    <li>登録後、ポイント用QRコードが発行されます</li>
                    <li>QRコードをスマートフォンで保存してください</li>
                </ul>
            </div>

            <form id="store-register-form">
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label japanese-text fw-bold">メールアドレス *</label>
                        <input type="email" 
                               class="form-control" 
                               id="email" 
                               name="email"
                               placeholder="example@email.com" 
                               required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label japanese-text fw-bold">パスワード *</label>
                        <input type="password" 
                               class="form-control" 
                               id="password" 
                               name="password"
                               placeholder="6文字以上" 
                               minlength="6"
                               required>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label japanese-text fw-bold">お名前</label>
                        <input type="text" 
                               class="form-control" 
                               id="name" 
                               name="name"
                               placeholder="任意入力">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label japanese-text fw-bold">電話番号</label>
                        <input type="tel" 
                               class="form-control" 
                               id="phone" 
                               name="phone"
                               placeholder="任意入力">
                    </div>
                </div>

                <div class="text-center mt-4">
                    <button type="button" class="btn btn-outline-secondary btn-large me-3" onclick="backToModeSelector()">
                        <i class="fas fa-arrow-left me-2"></i>戻る
                    </button>
                    <button type="submit" class="btn btn-dark btn-large">
                        <i class="fas fa-user-plus me-2"></i>会員登録
                    </button>
                </div>
            </form>

            <!-- 로딩 -->
            <div class="loading-spinner" id="loading-spinner">
                <div class="spinner-border text-dark" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 japanese-text">登録処理中...</p>
            </div>
        </div>

        <!-- 성공 섹션 -->
        <div class="success-section" id="success-section">
            <h2 class="japanese-heading text-success mb-4">
                <i class="fas fa-check-circle me-2"></i>登録完了
            </h2>

            <!-- 고객 정보 카드 -->
            <div class="customer-info-card">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="mb-1" id="success-customer-name">お客様</h4>
                        <p class="mb-0" id="success-customer-email">email@example.com</p>
                        <small>初回ポイント: 0pt</small>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="japanese-text">会員番号</div>
                        <div style="font-size: 1.5rem; font-weight: bold;" id="success-member-id">-</div>
                    </div>
                </div>
            </div>

            <!-- QR코드 표시 -->
            <div class="qr-display">
                <h4 class="japanese-heading text-center mb-3">
                    <i class="fas fa-qrcode me-2"></i>お客様専用QRコード
                </h4>
                <p class="japanese-text text-center text-muted mb-3">
                    次回来店時にこのQRコードをご提示ください
                </p>
                
                <div id="success-qr-code" class="qr-code-container"></div>
                
                <div class="mt-3 text-center">
                    <small class="japanese-text text-muted">
                        QRトークン: <code id="success-qr-token">-</code>
                    </small>
                </div>
            </div>

            <!-- 안내 메시지 -->
            <div class="mt-4">
                <div class="row">
                    <div class="col-md-6">
                        <div class="japanese-text">
                            <h5><i class="fas fa-mobile-alt me-2"></i>お客様へ</h5>
                            <ul>
                                <li>QRコードをスマートフォンで撮影保存してください</li>
                                <li>オンラインでも同じアカウントでログイン可能です</li>
                                <li>ポイントは購入金額の3%が付与されます</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="japanese-text">
                            <h5><i class="fas fa-store me-2"></i>スタッフ向け</h5>
                            <ul>
                                <li>お客様にQRコード保存をご案内ください</li>
                                <li>次回来店時はQRコードでポイント付与可能です</li>
                                <li>管理者ダッシュボードで管理できます</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-4">
                <button class="btn btn-outline-secondary btn-large me-3" onclick="printQRCode()">
                    <i class="fas fa-print me-2"></i>QRコード印刷
                </button>
                <button class="btn btn-dark btn-large" onclick="registerNewCustomer()">
                    <i class="fas fa-plus me-2"></i>新規登録
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script src="assets/js/jquery-1.11.0.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/firebase-config.js"></script>

    <script>
        let currentMode = null;
        let registeredCustomer = null;

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // 폼 제출 이벤트
            document.getElementById('store-register-form').addEventListener('submit', handleRegistration);
        });

        // 시간 업데이트
        function updateDateTime() {
            const now = new Date();
            const timeOptions = { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit',
                hour12: false 
            };
            document.getElementById('current-time').textContent = now.toLocaleTimeString('ja-JP', timeOptions);
        }

        // 모드 선택
        function selectMode(mode) {
            currentMode = mode;
            
            // 모드 버튼 활성화
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // 섹션 표시
            document.getElementById('mode-selector').style.display = 'none';
            document.getElementById('register-section').style.display = 'block';
            
            // 모드별 도움말 표시
            if (mode === 'staff') {
                document.getElementById('staff-helper').style.display = 'block';
                document.getElementById('customer-helper').style.display = 'none';
            } else {
                document.getElementById('staff-helper').style.display = 'none';
                document.getElementById('customer-helper').style.display = 'block';
            }
            
            showAlert(`${mode === 'staff' ? 'スタッフ代行' : 'お客様自身'}登録モードに設定しました`, 'info');
        }

        // 모드 선택으로 돌아가기
        function backToModeSelector() {
            document.getElementById('register-section').style.display = 'none';
            document.getElementById('success-section').style.display = 'none';
            document.getElementById('mode-selector').style.display = 'block';
            
            // 폼 초기화
            document.getElementById('store-register-form').reset();
            document.getElementById('loading-spinner').style.display = 'none';
            
            currentMode = null;
        }

        // 가입 처리
        async function handleRegistration(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const userData = {
                email: formData.get('email').trim(),
                password: formData.get('password'),
                name: formData.get('name').trim(),
                phone: formData.get('phone').trim()
            };
            
            // 유효성 검사
            if (!userData.email || !userData.password) {
                showAlert('メールアドレスとパスワードは必須です', 'warning');
                return;
            }
            
            if (userData.password.length < 6) {
                showAlert('パスワードは6文字以上で入力してください', 'warning');
                return;
            }
            
            try {
                showLoading(true);
                
                // 중복 이메일 확인
                const existingUsers = JSON.parse(localStorage.getItem('aetherUsers') || '[]');
                if (existingUsers.some(u => u.email.toLowerCase() === userData.email.toLowerCase())) {
                    throw new Error('このメールアドレスは既に登録されています');
                }
                
                // 사용자 생성
                const newUser = {
                    uid: 'store_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    email: userData.email,
                    name: userData.name || userData.email.split('@')[0],
                    phone: userData.phone,
                    points: 0,
                    createdAt: new Date().toISOString(),
                    registrationMode: currentMode,
                    createdInStore: true
                };
                
                // QR token generation
                newUser.qrToken = `QR_${newUser.uid}_${Date.now()}`;
                newUser.qrTokenCreatedAt = new Date().toISOString();
                
                // Firebase 시도
                let firebaseSuccess = false;
                if (window.firebase && firebase.auth) {
                    try {
                        // Firebase 사용자 생성 시도
                        const firebaseResult = await firebase.auth().createUserWithEmailAndPassword(userData.email, userData.password);
                        if (firebaseResult.user) {
                            newUser.uid = firebaseResult.user.uid;
                            newUser.qrToken = `QR_${newUser.uid}_${Date.now()}`;
                            
                            // Firestore에 사용자 정보 저장
                            await firebase.firestore().collection('users').doc(newUser.uid).set({
                                email: newUser.email,
                                name: newUser.name,
                                phone: newUser.phone,
                                points: newUser.points,
                                qrToken: newUser.qrToken,
                                qrTokenCreatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                registrationMode: currentMode,
                                createdInStore: true
                            });
                            
                            firebaseSuccess = true;
                            console.log('Firebase 가입 성공:', firebaseResult.user.uid);
                        }
                    } catch (firebaseError) {
                        console.warn('Firebase 가입 실패, localStorage로 폴백:', firebaseError.message);
                    }
                }
                
                // localStorage에 저장 (Firebase 성공 여부와 관계없이)
                existingUsers.push(newUser);
                localStorage.setItem('aetherUsers', JSON.stringify(existingUsers));
                
                // 로그인 상태 저장
                localStorage.setItem('aetherLoginStatus', 'true');
                localStorage.setItem('aetherUser', JSON.stringify(newUser));
                
                registeredCustomer = newUser;
                
                showLoading(false);
                showSuccessPage();
                
                showAlert(
                    firebaseSuccess ? 
                    'Firebase会員登録が完了しました' : 
                    'ローカル会員登録が完了しました', 
                    'success'
                );
                
            } catch (error) {
                showLoading(false);
                console.error('가입 처리 실패:', error);
                showAlert(`登録に失敗しました: ${error.message}`, 'danger');
            }
        }

        // 성공 페이지 표시
        function showSuccessPage() {
            if (!registeredCustomer) return;
            
            document.getElementById('register-section').style.display = 'none';
            document.getElementById('success-section').style.display = 'block';
            
            // 고객 정보 표시
            document.getElementById('success-customer-name').textContent = registeredCustomer.name;
            document.getElementById('success-customer-email').textContent = registeredCustomer.email;
            document.getElementById('success-member-id').textContent = registeredCustomer.uid.substring(0, 8).toUpperCase();
            document.getElementById('success-qr-token').textContent = registeredCustomer.qrToken;
            
            // QR코드 생성
            generateQRCodeForCustomer(registeredCustomer.qrToken);
        }

        // QR코드 생성
        function generateQRCodeForCustomer(qrToken) {
            try {
                const container = document.getElementById('success-qr-code');
                container.innerHTML = '';
                
                // Canvas 요소 생성
                const canvas = document.createElement('canvas');
                canvas.width = 250;
                canvas.height = 250;
                canvas.style.border = '3px solid #343a40';
                canvas.style.borderRadius = '8px';
                container.appendChild(canvas);

                // QR 코드 생성
                if (typeof qrcode !== 'undefined') {
                    const qr = qrcode(0, 'H');
                    qr.addData(qrToken);
                    qr.make();

                    const ctx = canvas.getContext('2d');
                    const cellSize = 250 / qr.getModuleCount();
                    
                    // 배경색 (흰색)
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, 250, 250);
                    
                    // QR 코드 그리기 (검은색)
                    ctx.fillStyle = '#343a40';
                    for (let row = 0; row < qr.getModuleCount(); row++) {
                        for (let col = 0; col < qr.getModuleCount(); col++) {
                            if (qr.isDark(row, col)) {
                                ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                            }
                        }
                    }
                } else {
                    throw new Error('QR 코드 라이브러리가 로드되지 않았습니다');
                }
            } catch (error) {
                console.error('QR 코드 생성 실패:', error);
                const container = document.getElementById('success-qr-code');
                container.innerHTML = `
                    <div class="text-center p-4 border border-secondary" style="width: 250px; height: 250px; margin: 0 auto; display: flex; flex-direction: column; justify-content: center;">
                        <i class="fas fa-qrcode fa-3x text-secondary mb-2"></i>
                        <small class="japanese-text text-muted">QRコード<br>生成エラー</small>
                    </div>
                `;
            }
        }

        // QR코드 인쇄
        function printQRCode() {
            if (!registeredCustomer) return;
            
            const printWindow = window.open('', '_blank');
            const qrCanvas = document.querySelector('#success-qr-code canvas');
            const qrDataUrl = qrCanvas ? qrCanvas.toDataURL() : '';
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>Aether ポイントカード</title>
                    <style>
                        body { font-family: "Noto Sans JP", sans-serif; text-align: center; padding: 20px; }
                        .card { border: 2px solid #343a40; border-radius: 10px; padding: 20px; margin: 20px auto; max-width: 300px; }
                        .logo { font-size: 24px; font-weight: bold; color: #343a40; margin-bottom: 10px; }
                        .qr-code { margin: 15px 0; }
                        .customer-info { margin: 15px 0; }
                        .instructions { font-size: 12px; color: #666; margin-top: 15px; }
                    </style>
                </head>
                <body>
                    <div class="card">
                        <div class="logo">Aether</div>
                        <div class="customer-info">
                            <strong>${registeredCustomer.name}</strong><br>
                            <small>${registeredCustomer.email}</small>
                        </div>
                        <div class="qr-code">
                            <img src="${qrDataUrl}" style="width: 200px; height: 200px;">
                        </div>
                        <div class="instructions">
                            店舗でこのQRコードをご提示ください<br>
                            ポイント: 購入金額の3%付与
                        </div>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        // 새 고객 등록
        function registerNewCustomer() {
            registeredCustomer = null;
            backToModeSelector();
            showAlert('新しいお客様の登録を開始してください', 'info');
        }

        // 로딩 상태 관리
        function showLoading(show) {
            document.getElementById('loading-spinner').style.display = show ? 'block' : 'none';
            document.getElementById('store-register-form').style.display = show ? 'none' : 'block';
        }

        // 알림 표시
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alert-container');
            const alertId = 'alert-' + Date.now();
            
            let bgClass = 'alert-secondary';
            if (type === 'success') bgClass = 'alert-success';
            else if (type === 'warning') bgClass = 'alert-warning';
            else if (type === 'danger') bgClass = 'alert-danger';
            else if (type === 'info') bgClass = 'alert-info';
            
            const alertHtml = `
                <div class="alert ${bgClass} alert-dismissible fade show" id="${alertId}" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', alertHtml);
            
            // 5초 후 자동 제거
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
