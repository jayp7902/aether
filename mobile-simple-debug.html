<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>모바일 간단 디버깅</title>
    <style>
        body { 
            padding: 15px; 
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        .status-box { 
            background: white; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            margin: 5px; 
            border-radius: 5px; 
            cursor: pointer;
            font-size: 14px;
        }
        .btn:hover { background: #0056b3; }
        .log { 
            background: #000; 
            color: #0f0; 
            padding: 10px; 
            border-radius: 5px; 
            font-family: monospace; 
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .status-label { font-weight: bold; }
        .status-value { color: #666; }
        .good { color: #28a745; }
        .bad { color: #dc3545; }
        .warning { color: #ffc107; }
    </style>
</head>
<body>
    <h2>🔍 모바일 간단 디버깅</h2>
    
    <div class="status-box">
        <h3>현재 상태</h3>
        <div class="status-item">
            <span class="status-label">사용자:</span>
            <span id="user-status" class="status-value">확인 중...</span>
        </div>
        <div class="status-item">
            <span class="status-label">Firebase:</span>
            <span id="firebase-status" class="status-value">확인 중...</span>
        </div>
        <div class="status-item">
            <span class="status-label">카트 (로컬):</span>
            <span id="cart-status" class="status-value">확인 중...</span>
        </div>
        <div class="status-item">
            <span class="status-label">동기화:</span>
            <span id="sync-status" class="status-value">확인 중...</span>
        </div>
    </div>
    
    <div class="status-box">
        <h3>테스트</h3>
        <button class="btn" onclick="checkStatus()">상태 확인</button>
        <button class="btn" onclick="testSync()">동기화 테스트</button>
        <button class="btn" onclick="setupRealtimeListener()">실시간 리스너 설정</button>
        <button class="btn" onclick="testLoadFirebaseData()">Firebase 데이터 로드 테스트</button>
        <button class="btn" onclick="goToCart()">카트 페이지</button>
    </div>
    
    <div class="status-box">
        <h3>로그</h3>
        <div id="log" class="log"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <!-- 애플리케이션 스크립트 -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/auth-utils.js"></script>
    
    <script>
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('log');
            logContainer.textContent += `[${timestamp}] ${message}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(message);
        }
        
        function updateStatus() {
            log('상태 업데이트 시작');
            
            // 사용자 상태
            let user = firebase?.auth?.currentUser;
            if (!user && typeof getCurrentUser === 'function') {
                user = getCurrentUser();
            }
            
            const userStatus = document.getElementById('user-status');
            if (user) {
                userStatus.textContent = user.email;
                userStatus.className = 'status-value good';
                log('사용자: ' + user.email);
            } else {
                userStatus.textContent = '로그인 안됨';
                userStatus.className = 'status-value bad';
                log('사용자: 로그인 안됨');
            }
            
            // Firebase 상태
            const firebaseAvailable = window.FirebaseService?.isFirebaseAvailable();
            const firebaseStatus = document.getElementById('firebase-status');
            if (firebaseAvailable) {
                firebaseStatus.textContent = '사용 가능';
                firebaseStatus.className = 'status-value good';
                log('Firebase: 사용 가능');
            } else {
                firebaseStatus.textContent = '사용 불가';
                firebaseStatus.className = 'status-value bad';
                log('Firebase: 사용 불가');
            }
            
            // 카트 상태
            const cart = JSON.parse(localStorage.getItem('aetherCart') || '[]');
            const cartStatus = document.getElementById('cart-status');
            cartStatus.textContent = cart.length + '개 상품';
            cartStatus.className = cart.length > 0 ? 'status-value good' : 'status-value warning';
            log('카트: ' + cart.length + '개 상품');
            
            // 동기화 상태
            const canSync = user && firebaseAvailable && window.CartSyncService;
            const syncStatus = document.getElementById('sync-status');
            if (canSync) {
                syncStatus.textContent = '가능';
                syncStatus.className = 'status-value good';
                log('동기화: 가능');
            } else {
                syncStatus.textContent = '불가능';
                syncStatus.className = 'status-value bad';
                log('동기화: 불가능');
            }
        }
        
        async function checkStatus() {
            log('상태 확인 시작');
            updateStatus();
        }
        
        async function testSync() {
            log('동기화 테스트 시작');
            
            // CartSyncService 로드 상태 확인
            log('CartSyncService 상태: ' + (window.CartSyncService ? '존재' : '없음'));
            if (!window.CartSyncService) {
                log('CartSyncService 로드 대기 중...');
                let attempts = 0;
                while (attempts < 50 && !window.CartSyncService) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                    log('CartSyncService 로드 대기 중... (' + attempts + '/50)');
                }
                
                if (!window.CartSyncService) {
                    log('CartSyncService 로드 실패 - firebase-config.js 확인 필요');
                    return;
                } else {
                    log('CartSyncService 로드 성공');
                }
            }
            
            if (!firebase?.auth?.currentUser && typeof getCurrentUser === 'function') {
                const user = getCurrentUser();
                if (user) {
                    log('auth-utils.js에서 사용자 정보 사용: ' + user.email);
                    
                    // Firebase Auth 상태 확인
                    if (firebase?.auth) {
                        try {
                            log('Firebase Auth 상태 확인 중...');
                            const currentUser = firebase.auth.currentUser;
                            log('firebase.auth.currentUser: ' + (currentUser ? currentUser.email : 'null'));
                            
                            // Firebase Auth 상태가 null인 경우 잠시 대기
                            if (!currentUser) {
                                log('Firebase Auth 상태 대기 중...');
                                await new Promise(resolve => setTimeout(resolve, 1000));
                                const refreshedUser = firebase.auth.currentUser;
                                log('대기 후 firebase.auth.currentUser: ' + (refreshedUser ? refreshedUser.email : '여전히 null'));
                            }
                        } catch (error) {
                            log('Firebase Auth 상태 확인 실패: ' + error.message);
                        }
                    }
                }
            }
            
            // Firebase Auth currentUser가 여전히 null인 경우 auth-utils.js 사용자로 동기화 시도
            let syncUser = firebase?.auth?.currentUser;
            if (!syncUser && typeof getCurrentUser === 'function') {
                const authUtilsUser = getCurrentUser();
                if (authUtilsUser) {
                    log('Firebase Auth currentUser가 null - auth-utils.js 사용자로 동기화 시도');
                    log('동기화 사용자: ' + authUtilsUser.email);
                    
                    try {
                        const syncedCart = await window.CartSyncService.syncCart(authUtilsUser.email);
                        log('동기화 완료: ' + syncedCart.length + '개 상품');
                        updateStatus();
                        return;
                    } catch (error) {
                        log('auth-utils 사용자로 동기화 실패: ' + error.message);
                    }
                }
            }
            
            if (firebase?.auth?.currentUser && window.CartSyncService) {
                try {
                    const userEmail = firebase.auth.currentUser.email;
                    log('동기화 사용자: ' + userEmail);
                    
                    const syncedCart = await window.CartSyncService.syncCart(userEmail);
                    log('동기화 완료: ' + syncedCart.length + '개 상품');
                    
                    updateStatus();
                } catch (error) {
                    log('동기화 실패: ' + error.message);
                }
            } else {
                log('동기화 불가: 사용자 또는 서비스 없음');
                log('사용자: ' + (firebase?.auth?.currentUser ? firebase.auth.currentUser.email : '없음'));
                log('CartSyncService: ' + (window.CartSyncService ? '존재' : '없음'));
            }
        }
        
                function setupRealtimeListener() {
                    log('실시간 리스너 설정 시작');
                    
                    // CartSyncService가 없으면 직접 생성
                    if (!window.CartSyncService && firebase?.firestore && window.FirebaseService) {
                        log('CartSyncService 없음 - 직접 생성 시도');
                        window.CartSyncService = {
                            async saveCartToFirebase(cartData, userEmail) {
                                try {
                                    log('🛒 Firebase 카트 저장 시도: ' + userEmail);
                                    const db = firebase.firestore();
                                    await db.collection('userCarts').doc(userEmail).set({
                                        cart: cartData,
                                        lastUpdated: new Date(),
                                        userEmail: userEmail
                                    });
                                    log('✅ Firebase 카트 저장 완료');
                                    return true;
                                } catch (error) {
                                    log('❌ Firebase 카트 저장 실패: ' + error.message);
                                    return false;
                                }
                            },
                            
                            async loadCartFromFirebase(userEmail) {
                                try {
                                    log('🛒 Firebase 카트 로드 시도: ' + userEmail);
                                    const db = firebase.firestore();
                                    const cartDoc = await db.collection('userCarts').doc(userEmail).get();
                                    
                                    if (cartDoc.exists) {
                                        const cartData = cartDoc.data().cart || [];
                                        log('✅ Firebase 카트 로드 완료: ' + cartData.length + '개 상품');
                                        return cartData;
                                    } else {
                                        log('Firebase 카트 없음');
                                        return [];
                                    }
                                } catch (error) {
                                    log('❌ Firebase 카트 로드 실패: ' + error.message);
                                    return [];
                                }
                            },
                            
                            async syncCart(userEmail, cartData = null) {
                                try {
                                    log('🔄 카트 동기화 시작: ' + userEmail);
                                    
                                    // 현재 카트 데이터 가져오기
                                    if (!cartData) {
                                        cartData = JSON.parse(localStorage.getItem('aetherCart') || '[]');
                                    }
                                    
                                    log('📦 로컬 카트 데이터: ' + cartData.length + '개 상품');
                                    
                                    // Firebase에서 기존 카트 데이터 로드
                                    const firebaseCart = await this.loadCartFromFirebase(userEmail);
                                    log('📦 Firebase 카트 데이터: ' + firebaseCart.length + '개 상품');
                                    
                                    // 더 최신 데이터가 있는 쪽을 선택 (웹과 동일한 로직)
                                    let finalCart = cartData;
                                    
                                    if (firebaseCart.length > 0 && cartData.length > 0) {
                                        // 두 카트 모두 데이터가 있는 경우, 더 많은 상품이 있는 쪽을 선택
                                        if (firebaseCart.length > cartData.length) {
                                            log('🔄 Firebase 카트가 더 많음 - Firebase 카트 사용');
                                            finalCart = firebaseCart;
                                        } else if (cartData.length > firebaseCart.length) {
                                            log('🔄 로컬 카트가 더 많음 - 로컬 카트 사용');
                                            finalCart = cartData;
                                        } else {
                                            log('🔄 카트 개수 동일 - 로컬 카트 사용');
                                            finalCart = cartData;
                                        }
                                    } else if (firebaseCart.length > 0) {
                                        log('🔄 Firebase에만 데이터 있음 - Firebase 카트 사용');
                                        finalCart = firebaseCart;
                                    } else {
                                        log('🔄 로컬에만 데이터 있음 - 로컬 카트 사용');
                                        finalCart = cartData;
                                    }
                                    
                                    // 최종 선택된 카트를 Firebase에 저장
                                    await this.saveCartToFirebase(finalCart, userEmail);
                                    
                                    // localStorage 업데이트
                                    localStorage.setItem('aetherCart', JSON.stringify(finalCart));
                                    
                                    log('✅ 카트 동기화 완료: ' + finalCart.length + '개 상품');
                                    return finalCart;
                                } catch (error) {
                                    log('❌ 카트 동기화 실패: ' + error.message);
                                    return JSON.parse(localStorage.getItem('aetherCart') || '[]');
                                }
                            },
                            
                            setupCartListener(userEmail) {
                                try {
                                    log('🛒 카트 리스너 설정 시도: ' + userEmail);
                                    
                                    if (!firebase?.firestore || !userEmail) {
                                        log('Firebase 미사용 또는 사용자 없음 - 카트 리스너 설정 안함');
                                        return;
                                    }
                                    
                                    const db = firebase.firestore();
                                    db.collection('userCarts').doc(userEmail).onSnapshot((doc) => {
                                        log('🔄 Firebase 카트 변경 감지: ' + (doc.exists ? '문서 존재' : '문서 없음'));
                                        
                                        if (doc.exists) {
                                            const cartData = doc.data().cart || [];
                                            const currentCart = JSON.parse(localStorage.getItem('aetherCart') || '[]');
                                            
                                            log('🛒 카트 비교: Firebase=' + cartData.length + '개, 로컬=' + currentCart.length + '개');
                                            
                                            // 현재 카트와 다르면 업데이트
                                            if (JSON.stringify(cartData) !== JSON.stringify(currentCart)) {
                                                log('🔄 카트 데이터 변경 감지 - 업데이트 중...');
                                                log('🔄 변경 전 로컬 카트: ' + currentCart.length + '개 상품');
                                                log('🔄 변경 후 Firebase 카트: ' + cartData.length + '개 상품');
                                                localStorage.setItem('aetherCart', JSON.stringify(cartData));
                                                log('✅ 카트 실시간 업데이트 완료: ' + cartData.length + '개 상품');
                                                
                                                // 상태 업데이트
                                                updateStatus();
                                            } else {
                                                log('🔄 카트 데이터 동일 - 업데이트 건너뜀');
                                            }
                                        } else {
                                            log('Firebase 카트 문서 없음 - 로컬 카트 비우기');
                                            localStorage.removeItem('aetherCart');
                                            updateStatus();
                                        }
                                    }, (error) => {
                                        log('❌ Firebase 카트 리스너 오류: ' + error.message);
                                    });
                                    
                                    log('✅ 카트 실시간 리스너 설정 완료');
                                } catch (error) {
                                    log('❌ 카트 리스너 설정 실패: ' + error.message);
                                }
                            }
                        };
                        log('✅ CartSyncService 직접 생성 완료');
                    }
                    
                    // 사용자 정보 확인
                    let user = firebase?.auth?.currentUser;
                    if (!user && typeof getCurrentUser === 'function') {
                        user = getCurrentUser();
                    }
                    
                    if (user && window.CartSyncService) {
                        log('실시간 리스너 설정: ' + user.email);
                        window.CartSyncService.setupCartListener(user.email);
                    } else {
                        log('❌ 실시간 리스너 설정 실패 - 사용자: ' + (user ? user.email : '없음') + ', CartSyncService: ' + (window.CartSyncService ? '존재' : '없음'));
                    }
                }
                
                function testLoadFirebaseData() {
                    log('=== Firebase userCarts 데이터 로드 테스트 시작 ===');
                    
                    // 사용자 정보 확인
                    let user = firebase?.auth?.currentUser;
                    if (!user && typeof getCurrentUser === 'function') {
                        user = getCurrentUser();
                    }
                    
                    if (!user) {
                        log('❌ 사용자 정보 없음 - 테스트 불가');
                        return;
                    }
                    
                    log('✅ 사용자 확인: ' + user.email);
                    log('🔍 Firebase 상태: ' + (firebase ? '사용 가능' : '사용 불가'));
                    log('🔍 Firestore 상태: ' + (firebase?.firestore ? '사용 가능' : '사용 불가'));
                    
                    if (!firebase?.firestore) {
                        log('❌ Firestore 사용 불가 - 테스트 중단');
                        return;
                    }
                    
                    const db = firebase.firestore();
                    const userEmail = user.email;
                    
                    log('🛒 Firebase userCarts 컬렉션에서 데이터 로드 시도: ' + userEmail);
                    
                    // 1. 직접 Firestore에서 데이터 로드
                    db.collection('userCarts').doc(userEmail).get()
                        .then((doc) => {
                            log('📄 Firebase 문서 조회 결과:');
                            log('- 문서 존재: ' + doc.exists);
                            log('- 문서 ID: ' + doc.id);
                            
                            if (doc.exists) {
                                const data = doc.data();
                                log('- 문서 데이터: ' + JSON.stringify(data, null, 2));
                                log('- 카트 상품 수: ' + (data.cart ? data.cart.length : 0));
                                log('- 마지막 업데이트: ' + (data.lastUpdated ? data.lastUpdated.toDate() : '없음'));
                                log('- 사용자 이메일: ' + (data.userEmail || '없음'));
                                
                                // localStorage와 비교
                                const localCart = JSON.parse(localStorage.getItem('aetherCart') || '[]');
                                log('📦 로컬 카트와 비교:');
                                log('- 로컬 카트 상품 수: ' + localCart.length);
                                log('- Firebase 카트 상품 수: ' + (data.cart ? data.cart.length : 0));
                                log('- 데이터 동일 여부: ' + (JSON.stringify(localCart) === JSON.stringify(data.cart || [])));
                                
                                if (data.cart && data.cart.length > 0) {
                                    log('🔄 Firebase 카트 데이터를 localStorage에 저장');
                                    localStorage.setItem('aetherCart', JSON.stringify(data.cart));
                                    log('✅ localStorage 업데이트 완료');
                                    updateStatus();
                                }
                            } else {
                                log('❌ Firebase 문서가 존재하지 않음');
                                log('📦 현재 로컬 카트: ' + JSON.parse(localStorage.getItem('aetherCart') || '[]').length + '개 상품');
                            }
                        })
                        .catch((error) => {
                            log('❌ Firebase 데이터 로드 실패: ' + error.message);
                            log('❌ 에러 상세: ' + JSON.stringify(error));
                        });
                    
                    // 2. 실시간 리스너 테스트
                    log('🔄 실시간 리스너 테스트 시작');
                    const unsubscribe = db.collection('userCarts').doc(userEmail).onSnapshot(
                        (doc) => {
                            log('🔄 실시간 리스너 트리거됨');
                            log('- 문서 존재: ' + doc.exists);
                            if (doc.exists) {
                                const data = doc.data();
                                log('- 실시간 카트 상품 수: ' + (data.cart ? data.cart.length : 0));
                            }
                        },
                        (error) => {
                            log('❌ 실시간 리스너 에러: ' + error.message);
                        }
                    );
                    
                    // 5초 후 리스너 해제
                    setTimeout(() => {
                        unsubscribe();
                        log('🔄 실시간 리스너 해제');
                    }, 5000);
                }
                
                function goToCart() {
                    log('카트 페이지로 이동');
                    window.location.href = 'cart.html';
                }
        
        // CartSyncService 직접 생성 (임시 해결책)
        function createCartSyncService() {
            if (window.CartSyncService) {
                log('CartSyncService 이미 존재');
                return true;
            }
            
            if (!firebase?.firestore || !window.FirebaseService) {
                log('CartSyncService 생성 불가: Firebase 또는 FirebaseService 없음');
                return false;
            }
            
            log('CartSyncService 직접 생성 중...');
            
            window.CartSyncService = {
                async saveCartToFirebase(cartData, userEmail) {
                    try {
                        log('🛒 Firebase 카트 저장 시도: ' + userEmail);
                        const db = firebase.firestore();
                        await db.collection('userCarts').doc(userEmail).set({
                            cart: cartData,
                            lastUpdated: new Date(),
                            userEmail: userEmail
                        });
                        log('✅ Firebase 카트 저장 완료');
                        return true;
                    } catch (error) {
                        log('❌ Firebase 카트 저장 실패: ' + error.message);
                        return false;
                    }
                },
                
                async loadCartFromFirebase(userEmail) {
                    try {
                        log('🛒 Firebase 카트 로드 시도: ' + userEmail);
                        const db = firebase.firestore();
                        const cartDoc = await db.collection('userCarts').doc(userEmail).get();
                        
                        if (cartDoc.exists) {
                            const cartData = cartDoc.data().cart || [];
                            log('✅ Firebase 카트 로드 완료: ' + cartData.length + '개 상품');
                            return cartData;
                        } else {
                            log('Firebase 카트 없음');
                            return [];
                        }
                    } catch (error) {
                        log('❌ Firebase 카트 로드 실패: ' + error.message);
                        return [];
                    }
                },
                
                async syncCart(userEmail) {
                    try {
                        log('🔄 카트 동기화 시작: ' + userEmail);
                        
                        // 현재 카트 데이터 가져오기
                        const cartData = JSON.parse(localStorage.getItem('aetherCart') || '[]');
                        
                        // Firebase에 저장
                        await this.saveCartToFirebase(cartData, userEmail);
                        
                        // Firebase에서 최신 데이터 로드
                        const latestCart = await this.loadCartFromFirebase(userEmail);
                        
                        // localStorage 업데이트
                        localStorage.setItem('aetherCart', JSON.stringify(latestCart));
                        
                        log('✅ 카트 동기화 완료: ' + latestCart.length + '개 상품');
                        return latestCart;
                    } catch (error) {
                        log('❌ 카트 동기화 실패: ' + error.message);
                        return JSON.parse(localStorage.getItem('aetherCart') || '[]');
                    }
                }
            };
            
            log('✅ CartSyncService 직접 생성 완료');
            return true;
        }
        
        // 스크립트 로드 확인 함수
        async function waitForScripts() {
            log('스크립트 로드 확인 중...');
            
            let attempts = 0;
            const maxAttempts = 100; // 10초 대기
            
            while (attempts < maxAttempts) {
                const scriptsLoaded = {
                    firebase: typeof firebase !== 'undefined',
                    FirebaseService: typeof window.FirebaseService !== 'undefined',
                    CartSyncService: typeof window.CartSyncService !== 'undefined',
                    authUtils: typeof getCurrentUser !== 'undefined'
                };
                
                log('스크립트 상태: firebase=' + scriptsLoaded.firebase + 
                    ', FirebaseService=' + scriptsLoaded.FirebaseService + 
                    ', CartSyncService=' + scriptsLoaded.CartSyncService + 
                    ', authUtils=' + scriptsLoaded.authUtils);
                
                if (scriptsLoaded.firebase && scriptsLoaded.FirebaseService) {
                    // CartSyncService가 없으면 직접 생성
                    if (!scriptsLoaded.CartSyncService) {
                        log('CartSyncService 없음 - 직접 생성 시도');
                        if (createCartSyncService()) {
                            log('모든 필수 스크립트 준비 완료');
                            return true;
                        }
                    } else {
                        log('모든 필수 스크립트 로드 완료');
                        return true;
                    }
                }
                
                attempts++;
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            log('스크립트 로드 타임아웃 - CartSyncService 직접 생성 시도');
            return createCartSyncService();
        }
        
        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', async function() {
            log('페이지 로드 시작');
            
            // 스크립트 로드 대기
            const scriptsReady = await waitForScripts();
            
                    if (scriptsReady) {
                        log('Firebase 초기화 대기 완료');
                        updateStatus();
                        
                        // 자동으로 Firebase 데이터 로드 및 실시간 리스너 설정
                        setTimeout(() => {
                            log('자동 Firebase 데이터 로드 시작');
                            testLoadFirebaseData();
                            
                            setTimeout(() => {
                                log('자동 실시간 리스너 설정 시작');
                                setupRealtimeListener();
                            }, 1000);
                        }, 2000);
                    } else {
                        log('스크립트 로드 실패 - 수동 새로고침 필요');
                        updateStatus();
                    }
        });
    </script>
</body>
</html>
