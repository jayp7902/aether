<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>모바일 간단 디버깅</title>
    <style>
        body { 
            padding: 15px; 
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        .status-box { 
            background: white; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            margin: 5px; 
            border-radius: 5px; 
            cursor: pointer;
            font-size: 14px;
        }
        .btn:hover { background: #0056b3; }
        .log { 
            background: #000; 
            color: #0f0; 
            padding: 10px; 
            border-radius: 5px; 
            font-family: monospace; 
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .status-label { font-weight: bold; }
        .status-value { color: #666; }
        .good { color: #28a745; }
        .bad { color: #dc3545; }
        .warning { color: #ffc107; }
    </style>
</head>
<body>
    <h2>🔍 모바일 간단 디버깅</h2>
    
    <div class="status-box">
        <h3>현재 상태</h3>
        <div class="status-item">
            <span class="status-label">사용자:</span>
            <span id="user-status" class="status-value">확인 중...</span>
        </div>
        <div class="status-item">
            <span class="status-label">Firebase:</span>
            <span id="firebase-status" class="status-value">확인 중...</span>
        </div>
        <div class="status-item">
            <span class="status-label">카트 (로컬):</span>
            <span id="cart-status" class="status-value">확인 중...</span>
        </div>
        <div class="status-item">
            <span class="status-label">동기화:</span>
            <span id="sync-status" class="status-value">확인 중...</span>
        </div>
    </div>
    
    <div class="status-box">
        <h3>테스트</h3>
        <button class="btn" onclick="checkStatus()">상태 확인</button>
        <button class="btn" onclick="testSync()">동기화 테스트</button>
        <button class="btn" onclick="goToCart()">카트 페이지</button>
    </div>
    
    <div class="status-box">
        <h3>로그</h3>
        <div id="log" class="log"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <!-- 애플리케이션 스크립트 -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/auth-utils.js"></script>
    
    <script>
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('log');
            logContainer.textContent += `[${timestamp}] ${message}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(message);
        }
        
        function updateStatus() {
            log('상태 업데이트 시작');
            
            // 사용자 상태
            let user = firebase?.auth?.currentUser;
            if (!user && typeof getCurrentUser === 'function') {
                user = getCurrentUser();
            }
            
            const userStatus = document.getElementById('user-status');
            if (user) {
                userStatus.textContent = user.email;
                userStatus.className = 'status-value good';
                log('사용자: ' + user.email);
            } else {
                userStatus.textContent = '로그인 안됨';
                userStatus.className = 'status-value bad';
                log('사용자: 로그인 안됨');
            }
            
            // Firebase 상태
            const firebaseAvailable = window.FirebaseService?.isFirebaseAvailable();
            const firebaseStatus = document.getElementById('firebase-status');
            if (firebaseAvailable) {
                firebaseStatus.textContent = '사용 가능';
                firebaseStatus.className = 'status-value good';
                log('Firebase: 사용 가능');
            } else {
                firebaseStatus.textContent = '사용 불가';
                firebaseStatus.className = 'status-value bad';
                log('Firebase: 사용 불가');
            }
            
            // 카트 상태
            const cart = JSON.parse(localStorage.getItem('aetherCart') || '[]');
            const cartStatus = document.getElementById('cart-status');
            cartStatus.textContent = cart.length + '개 상품';
            cartStatus.className = cart.length > 0 ? 'status-value good' : 'status-value warning';
            log('카트: ' + cart.length + '개 상품');
            
            // 동기화 상태
            const canSync = user && firebaseAvailable && window.CartSyncService;
            const syncStatus = document.getElementById('sync-status');
            if (canSync) {
                syncStatus.textContent = '가능';
                syncStatus.className = 'status-value good';
                log('동기화: 가능');
            } else {
                syncStatus.textContent = '불가능';
                syncStatus.className = 'status-value bad';
                log('동기화: 불가능');
            }
        }
        
        async function checkStatus() {
            log('상태 확인 시작');
            updateStatus();
        }
        
        async function testSync() {
            log('동기화 테스트 시작');
            
            if (!firebase?.auth?.currentUser && typeof getCurrentUser === 'function') {
                const user = getCurrentUser();
                if (user) {
                    log('auth-utils.js에서 사용자 정보 사용: ' + user.email);
                    
                    // Firebase Auth 상태 새로고침
                    if (firebase?.auth) {
                        try {
                            await firebase.auth.authStateReady();
                            log('Firebase Auth 상태 새로고침 완료');
                        } catch (error) {
                            log('Firebase Auth 새로고침 실패: ' + error.message);
                        }
                    }
                }
            }
            
            if (firebase?.auth?.currentUser && window.CartSyncService) {
                try {
                    const userEmail = firebase.auth.currentUser.email;
                    log('동기화 사용자: ' + userEmail);
                    
                    const syncedCart = await window.CartSyncService.syncCart(userEmail);
                    log('동기화 완료: ' + syncedCart.length + '개 상품');
                    
                    updateStatus();
                } catch (error) {
                    log('동기화 실패: ' + error.message);
                }
            } else {
                log('동기화 불가: 사용자 또는 서비스 없음');
                log('사용자: ' + (firebase?.auth?.currentUser ? firebase.auth.currentUser.email : '없음'));
                log('CartSyncService: ' + (window.CartSyncService ? '존재' : '없음'));
            }
        }
        
        function goToCart() {
            log('카트 페이지로 이동');
            window.location.href = 'cart.html';
        }
        
        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            log('페이지 로드 시작');
            
            // 3초 후 상태 확인
            setTimeout(() => {
                log('Firebase 초기화 대기 완료');
                updateStatus();
            }, 3000);
        });
    </script>
</body>
</html>
