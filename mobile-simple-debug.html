<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª¨ë°”ì¼ ê°„ë‹¨ ë””ë²„ê¹…</title>
    <style>
        body { 
            padding: 15px; 
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        .status-box { 
            background: white; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 15px; 
            margin: 5px; 
            border-radius: 5px; 
            cursor: pointer;
            font-size: 14px;
        }
        .btn:hover { background: #0056b3; }
        .log { 
            background: #000; 
            color: #0f0; 
            padding: 10px; 
            border-radius: 5px; 
            font-family: monospace; 
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .status-label { font-weight: bold; }
        .status-value { color: #666; }
        .good { color: #28a745; }
        .bad { color: #dc3545; }
        .warning { color: #ffc107; }
    </style>
</head>
<body>
    <h2>ğŸ” ëª¨ë°”ì¼ ê°„ë‹¨ ë””ë²„ê¹…</h2>
    
    <div class="status-box">
        <h3>í˜„ì¬ ìƒíƒœ</h3>
        <div class="status-item">
            <span class="status-label">ì‚¬ìš©ì:</span>
            <span id="user-status" class="status-value">í™•ì¸ ì¤‘...</span>
        </div>
        <div class="status-item">
            <span class="status-label">Firebase:</span>
            <span id="firebase-status" class="status-value">í™•ì¸ ì¤‘...</span>
        </div>
        <div class="status-item">
            <span class="status-label">ì¹´íŠ¸ (ë¡œì»¬):</span>
            <span id="cart-status" class="status-value">í™•ì¸ ì¤‘...</span>
        </div>
        <div class="status-item">
            <span class="status-label">ë™ê¸°í™”:</span>
            <span id="sync-status" class="status-value">í™•ì¸ ì¤‘...</span>
        </div>
    </div>
    
    <div class="status-box">
        <h3>í…ŒìŠ¤íŠ¸</h3>
        <button class="btn" onclick="checkStatus()">ìƒíƒœ í™•ì¸</button>
        <button class="btn" onclick="testSync()">ë™ê¸°í™” í…ŒìŠ¤íŠ¸</button>
        <button class="btn" onclick="setupRealtimeListener()">ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •</button>
        <button class="btn" onclick="testLoadFirebaseData()">Firebase ë°ì´í„° ë¡œë“œ í…ŒìŠ¤íŠ¸</button>
        <button class="btn" onclick="testWebSync()">ì›¹ ë™ê¸°í™” í…ŒìŠ¤íŠ¸</button>
        <button class="btn" onclick="goToCart()">ì¹´íŠ¸ í˜ì´ì§€</button>
    </div>
    
    <div class="status-box">
        <h3>ë¡œê·¸</h3>
        <div id="log" class="log"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <!-- ì• í”Œë¦¬ì¼€ì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/auth-utils.js"></script>
    
    <script>
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('log');
            logContainer.textContent += `[${timestamp}] ${message}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(message);
        }
        
        function updateStatus() {
            log('ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹œì‘');
            
            // ì‚¬ìš©ì ìƒíƒœ
            let user = firebase?.auth?.currentUser;
            if (!user && typeof getCurrentUser === 'function') {
                user = getCurrentUser();
            }
            
            const userStatus = document.getElementById('user-status');
            if (user) {
                userStatus.textContent = user.email;
                userStatus.className = 'status-value good';
                log('ì‚¬ìš©ì: ' + user.email);
            } else {
                userStatus.textContent = 'ë¡œê·¸ì¸ ì•ˆë¨';
                userStatus.className = 'status-value bad';
                log('ì‚¬ìš©ì: ë¡œê·¸ì¸ ì•ˆë¨');
            }
            
            // Firebase ìƒíƒœ
            const firebaseAvailable = window.FirebaseService?.isFirebaseAvailable();
            const firebaseStatus = document.getElementById('firebase-status');
            if (firebaseAvailable) {
                firebaseStatus.textContent = 'ì‚¬ìš© ê°€ëŠ¥';
                firebaseStatus.className = 'status-value good';
                log('Firebase: ì‚¬ìš© ê°€ëŠ¥');
            } else {
                firebaseStatus.textContent = 'ì‚¬ìš© ë¶ˆê°€';
                firebaseStatus.className = 'status-value bad';
                log('Firebase: ì‚¬ìš© ë¶ˆê°€');
            }
            
            // ì¹´íŠ¸ ìƒíƒœ
            const cart = JSON.parse(localStorage.getItem('aetherCart') || '[]');
            const cartStatus = document.getElementById('cart-status');
            cartStatus.textContent = cart.length + 'ê°œ ìƒí’ˆ';
            cartStatus.className = cart.length > 0 ? 'status-value good' : 'status-value warning';
            log('ì¹´íŠ¸: ' + cart.length + 'ê°œ ìƒí’ˆ');
            
            // ë™ê¸°í™” ìƒíƒœ
            const canSync = user && firebaseAvailable && window.CartSyncService;
            const syncStatus = document.getElementById('sync-status');
            if (canSync) {
                syncStatus.textContent = 'ê°€ëŠ¥';
                syncStatus.className = 'status-value good';
                log('ë™ê¸°í™”: ê°€ëŠ¥');
            } else {
                syncStatus.textContent = 'ë¶ˆê°€ëŠ¥';
                syncStatus.className = 'status-value bad';
                log('ë™ê¸°í™”: ë¶ˆê°€ëŠ¥');
            }
        }
        
        async function checkStatus() {
            log('ìƒíƒœ í™•ì¸ ì‹œì‘');
            updateStatus();
        }
        
        async function testSync() {
            log('ë™ê¸°í™” í…ŒìŠ¤íŠ¸ ì‹œì‘');
            
            // CartSyncService ë¡œë“œ ìƒíƒœ í™•ì¸
            log('CartSyncService ìƒíƒœ: ' + (window.CartSyncService ? 'ì¡´ì¬' : 'ì—†ìŒ'));
            if (!window.CartSyncService) {
                log('CartSyncService ë¡œë“œ ëŒ€ê¸° ì¤‘...');
                let attempts = 0;
                while (attempts < 50 && !window.CartSyncService) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                    log('CartSyncService ë¡œë“œ ëŒ€ê¸° ì¤‘... (' + attempts + '/50)');
                }
                
                if (!window.CartSyncService) {
                    log('CartSyncService ë¡œë“œ ì‹¤íŒ¨ - firebase-config.js í™•ì¸ í•„ìš”');
                    return;
                } else {
                    log('CartSyncService ë¡œë“œ ì„±ê³µ');
                }
            }
            
            if (!firebase?.auth?.currentUser && typeof getCurrentUser === 'function') {
                const user = getCurrentUser();
                if (user) {
                    log('auth-utils.jsì—ì„œ ì‚¬ìš©ì ì •ë³´ ì‚¬ìš©: ' + user.email);
                    
                    // Firebase Auth ìƒíƒœ í™•ì¸
                    if (firebase?.auth) {
                        try {
                            log('Firebase Auth ìƒíƒœ í™•ì¸ ì¤‘...');
                            const currentUser = firebase.auth.currentUser;
                            log('firebase.auth.currentUser: ' + (currentUser ? currentUser.email : 'null'));
                            
                            // Firebase Auth ìƒíƒœê°€ nullì¸ ê²½ìš° ì ì‹œ ëŒ€ê¸°
                            if (!currentUser) {
                                log('Firebase Auth ìƒíƒœ ëŒ€ê¸° ì¤‘...');
                                await new Promise(resolve => setTimeout(resolve, 1000));
                                const refreshedUser = firebase.auth.currentUser;
                                log('ëŒ€ê¸° í›„ firebase.auth.currentUser: ' + (refreshedUser ? refreshedUser.email : 'ì—¬ì „íˆ null'));
                            }
                        } catch (error) {
                            log('Firebase Auth ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ' + error.message);
                        }
                    }
                }
            }
            
            // Firebase Auth currentUserê°€ ì—¬ì „íˆ nullì¸ ê²½ìš° auth-utils.js ì‚¬ìš©ìë¡œ ë™ê¸°í™” ì‹œë„
            let syncUser = firebase?.auth?.currentUser;
            if (!syncUser && typeof getCurrentUser === 'function') {
                const authUtilsUser = getCurrentUser();
                if (authUtilsUser) {
                    log('Firebase Auth currentUserê°€ null - auth-utils.js ì‚¬ìš©ìë¡œ ë™ê¸°í™” ì‹œë„');
                    log('ë™ê¸°í™” ì‚¬ìš©ì: ' + authUtilsUser.email);
                    
                    try {
                        const syncedCart = await window.CartSyncService.syncCart(authUtilsUser.email);
                        log('ë™ê¸°í™” ì™„ë£Œ: ' + syncedCart.length + 'ê°œ ìƒí’ˆ');
                        updateStatus();
                        return;
                    } catch (error) {
                        log('auth-utils ì‚¬ìš©ìë¡œ ë™ê¸°í™” ì‹¤íŒ¨: ' + error.message);
                    }
                }
            }
            
            if (firebase?.auth?.currentUser && window.CartSyncService) {
                try {
                    const userEmail = firebase.auth.currentUser.email;
                    log('ë™ê¸°í™” ì‚¬ìš©ì: ' + userEmail);
                    
                    const syncedCart = await window.CartSyncService.syncCart(userEmail);
                    log('ë™ê¸°í™” ì™„ë£Œ: ' + syncedCart.length + 'ê°œ ìƒí’ˆ');
                    
                    updateStatus();
                } catch (error) {
                    log('ë™ê¸°í™” ì‹¤íŒ¨: ' + error.message);
                }
            } else {
                log('ë™ê¸°í™” ë¶ˆê°€: ì‚¬ìš©ì ë˜ëŠ” ì„œë¹„ìŠ¤ ì—†ìŒ');
                log('ì‚¬ìš©ì: ' + (firebase?.auth?.currentUser ? firebase.auth.currentUser.email : 'ì—†ìŒ'));
                log('CartSyncService: ' + (window.CartSyncService ? 'ì¡´ì¬' : 'ì—†ìŒ'));
            }
        }
        
                function setupRealtimeListener() {
                    log('=== ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì‹œì‘ ===');
                    
                    // ì‚¬ìš©ì ì •ë³´ í™•ì¸
                    let user = firebase?.auth?.currentUser;
                    if (!user && typeof getCurrentUser === 'function') {
                        user = getCurrentUser();
                    }
                    
                    if (!user) {
                        log('âŒ ì‚¬ìš©ì ì •ë³´ ì—†ìŒ - ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ë¶ˆê°€');
                        return;
                    }
                    
                    log('âœ… ì‚¬ìš©ì í™•ì¸: ' + user.email);
                    
                    // ê°•ë ¥í•œ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì§ì ‘ ì„¤ì •
                    log('ğŸš€ ê°•ë ¥í•œ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì§ì ‘ ì„¤ì • ì‹œì‘');
                    const db = firebase.firestore();
                    const userEmail = user.email;
                    
                    // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ í•´ì œ (ì¤‘ë³µ ë°©ì§€)
                    if (window.mobileCartListener) {
                        window.mobileCartListener();
                        log('ğŸ”„ ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ í•´ì œ');
                    }
                    
                    // ìƒˆë¡œìš´ ê°•ë ¥í•œ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                    window.mobileCartListener = db.collection('userCarts').doc(userEmail).onSnapshot(
                        (doc) => {
                            log('ğŸš€ ê°•ë ¥í•œ ë¦¬ìŠ¤ë„ˆ íŠ¸ë¦¬ê±°ë¨!');
                            log('- ë¬¸ì„œ ì¡´ì¬: ' + doc.exists);
                            log('- íŠ¸ë¦¬ê±° ì‹œê°„: ' + new Date().toLocaleTimeString());
                            
                            if (doc.exists) {
                                const data = doc.data();
                                const cartData = data.cart || [];
                                const currentCart = JSON.parse(localStorage.getItem('aetherCart') || '[]');
                                
                                log('ğŸ›’ ê°•ë ¥í•œ ë¦¬ìŠ¤ë„ˆ ì¹´íŠ¸ ë¹„êµ:');
                                log('- Firebase ì¹´íŠ¸: ' + cartData.length + 'ê°œ ìƒí’ˆ');
                                log('- ë¡œì»¬ ì¹´íŠ¸: ' + currentCart.length + 'ê°œ ìƒí’ˆ');
                                log('- ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ' + (data.lastUpdated ? data.lastUpdated.toDate() : 'ì—†ìŒ'));
                                
                                if (JSON.stringify(cartData) !== JSON.stringify(currentCart)) {
                                    log('ğŸ”„ ê°•ë ¥í•œ ë¦¬ìŠ¤ë„ˆ: ì¹´íŠ¸ ë°ì´í„° ë³€ê²½ ê°ì§€!');
                                    log('ğŸ”„ ë³€ê²½ ì „ ë¡œì»¬: ' + currentCart.length + 'ê°œ');
                                    log('ğŸ”„ ë³€ê²½ í›„ Firebase: ' + cartData.length + 'ê°œ');
                                    
                                    localStorage.setItem('aetherCart', JSON.stringify(cartData));
                                    log('âœ… ê°•ë ¥í•œ ë¦¬ìŠ¤ë„ˆ: localStorage ì—…ë°ì´íŠ¸ ì™„ë£Œ!');
                                    log('âœ… ì›¹ì—ì„œ ì¹´íŠ¸ ë³€ê²½ì‚¬í•­ ê°ì§€ë¨ - ëª¨ë°”ì¼ ë™ê¸°í™” ì™„ë£Œ!');
                                    
                                    updateStatus();
                                } else {
                                    log('ğŸ”„ ê°•ë ¥í•œ ë¦¬ìŠ¤ë„ˆ: ì¹´íŠ¸ ë°ì´í„° ë™ì¼ - ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€');
                                }
                            } else {
                                log('âŒ ê°•ë ¥í•œ ë¦¬ìŠ¤ë„ˆ: Firebase ì¹´íŠ¸ ë¬¸ì„œ ì—†ìŒ');
                                localStorage.removeItem('aetherCart');
                                updateStatus();
                            }
                        },
                        (error) => {
                            log('âŒ ê°•ë ¥í•œ ë¦¬ìŠ¤ë„ˆ ì—ëŸ¬: ' + error.message);
                        }
                    );
                    
                    log('âœ… ê°•ë ¥í•œ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
                    
                    // CartSyncServiceê°€ ì—†ìœ¼ë©´ ì§ì ‘ ìƒì„±
                    if (!window.CartSyncService && firebase?.firestore && window.FirebaseService) {
                        log('CartSyncService ì—†ìŒ - ì§ì ‘ ìƒì„± ì‹œë„');
                        window.CartSyncService = {
                            async saveCartToFirebase(cartData, userEmail) {
                                try {
                                    log('ğŸ›’ Firebase ì¹´íŠ¸ ì €ì¥ ì‹œë„: ' + userEmail);
                                    const db = firebase.firestore();
                                    await db.collection('userCarts').doc(userEmail).set({
                                        cart: cartData,
                                        lastUpdated: new Date(),
                                        userEmail: userEmail
                                    });
                                    log('âœ… Firebase ì¹´íŠ¸ ì €ì¥ ì™„ë£Œ');
                                    return true;
                                } catch (error) {
                                    log('âŒ Firebase ì¹´íŠ¸ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
                                    return false;
                                }
                            },
                            
                            async loadCartFromFirebase(userEmail) {
                                try {
                                    log('ğŸ›’ Firebase ì¹´íŠ¸ ë¡œë“œ ì‹œë„: ' + userEmail);
                                    const db = firebase.firestore();
                                    const cartDoc = await db.collection('userCarts').doc(userEmail).get();
                                    
                                    if (cartDoc.exists) {
                                        const cartData = cartDoc.data().cart || [];
                                        log('âœ… Firebase ì¹´íŠ¸ ë¡œë“œ ì™„ë£Œ: ' + cartData.length + 'ê°œ ìƒí’ˆ');
                                        return cartData;
                                    } else {
                                        log('Firebase ì¹´íŠ¸ ì—†ìŒ');
                                        return [];
                                    }
                                } catch (error) {
                                    log('âŒ Firebase ì¹´íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
                                    return [];
                                }
                            },
                            
                            async syncCart(userEmail, cartData = null) {
                                try {
                                    log('ğŸ”„ ì¹´íŠ¸ ë™ê¸°í™” ì‹œì‘: ' + userEmail);
                                    
                                    // í˜„ì¬ ì¹´íŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                                    if (!cartData) {
                                        cartData = JSON.parse(localStorage.getItem('aetherCart') || '[]');
                                    }
                                    
                                    log('ğŸ“¦ ë¡œì»¬ ì¹´íŠ¸ ë°ì´í„°: ' + cartData.length + 'ê°œ ìƒí’ˆ');
                                    
                                    // Firebaseì—ì„œ ê¸°ì¡´ ì¹´íŠ¸ ë°ì´í„° ë¡œë“œ
                                    const firebaseCart = await this.loadCartFromFirebase(userEmail);
                                    log('ğŸ“¦ Firebase ì¹´íŠ¸ ë°ì´í„°: ' + firebaseCart.length + 'ê°œ ìƒí’ˆ');
                                    
                                    // ë” ìµœì‹  ë°ì´í„°ê°€ ìˆëŠ” ìª½ì„ ì„ íƒ (ì›¹ê³¼ ë™ì¼í•œ ë¡œì§)
                                    let finalCart = cartData;
                                    
                                    if (firebaseCart.length > 0 && cartData.length > 0) {
                                        // ë‘ ì¹´íŠ¸ ëª¨ë‘ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°, ë” ë§ì€ ìƒí’ˆì´ ìˆëŠ” ìª½ì„ ì„ íƒ
                                        if (firebaseCart.length > cartData.length) {
                                            log('ğŸ”„ Firebase ì¹´íŠ¸ê°€ ë” ë§ìŒ - Firebase ì¹´íŠ¸ ì‚¬ìš©');
                                            finalCart = firebaseCart;
                                        } else if (cartData.length > firebaseCart.length) {
                                            log('ğŸ”„ ë¡œì»¬ ì¹´íŠ¸ê°€ ë” ë§ìŒ - ë¡œì»¬ ì¹´íŠ¸ ì‚¬ìš©');
                                            finalCart = cartData;
                                        } else {
                                            log('ğŸ”„ ì¹´íŠ¸ ê°œìˆ˜ ë™ì¼ - ë¡œì»¬ ì¹´íŠ¸ ì‚¬ìš©');
                                            finalCart = cartData;
                                        }
                                    } else if (firebaseCart.length > 0) {
                                        log('ğŸ”„ Firebaseì—ë§Œ ë°ì´í„° ìˆìŒ - Firebase ì¹´íŠ¸ ì‚¬ìš©');
                                        finalCart = firebaseCart;
                                    } else {
                                        log('ğŸ”„ ë¡œì»¬ì—ë§Œ ë°ì´í„° ìˆìŒ - ë¡œì»¬ ì¹´íŠ¸ ì‚¬ìš©');
                                        finalCart = cartData;
                                    }
                                    
                                    // ìµœì¢… ì„ íƒëœ ì¹´íŠ¸ë¥¼ Firebaseì— ì €ì¥
                                    await this.saveCartToFirebase(finalCart, userEmail);
                                    
                                    // localStorage ì—…ë°ì´íŠ¸
                                    localStorage.setItem('aetherCart', JSON.stringify(finalCart));
                                    
                                    log('âœ… ì¹´íŠ¸ ë™ê¸°í™” ì™„ë£Œ: ' + finalCart.length + 'ê°œ ìƒí’ˆ');
                                    return finalCart;
                                } catch (error) {
                                    log('âŒ ì¹´íŠ¸ ë™ê¸°í™” ì‹¤íŒ¨: ' + error.message);
                                    return JSON.parse(localStorage.getItem('aetherCart') || '[]');
                                }
                            },
                            
                            setupCartListener(userEmail) {
                                try {
                                    log('ğŸ›’ ì¹´íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì‹œë„: ' + userEmail);
                                    
                                    if (!firebase?.firestore || !userEmail) {
                                        log('Firebase ë¯¸ì‚¬ìš© ë˜ëŠ” ì‚¬ìš©ì ì—†ìŒ - ì¹´íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì•ˆí•¨');
                                        return;
                                    }
                                    
                                    const db = firebase.firestore();
                                    db.collection('userCarts').doc(userEmail).onSnapshot((doc) => {
                                        log('ğŸ”„ Firebase ì¹´íŠ¸ ë³€ê²½ ê°ì§€: ' + (doc.exists ? 'ë¬¸ì„œ ì¡´ì¬' : 'ë¬¸ì„œ ì—†ìŒ'));
                                        
                                        if (doc.exists) {
                                            const data = doc.data();
                                            const cartData = data.cart || [];
                                            const currentCart = JSON.parse(localStorage.getItem('aetherCart') || '[]');
                                            
                                            log('ğŸ›’ ì¹´íŠ¸ ë¹„êµ: Firebase=' + cartData.length + 'ê°œ, ë¡œì»¬=' + currentCart.length + 'ê°œ');
                                            log('ğŸ• ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ' + (data.lastUpdated ? data.lastUpdated.toDate() : 'ì—†ìŒ'));
                                            
                                            // í˜„ì¬ ì¹´íŠ¸ì™€ ë‹¤ë¥´ë©´ ì—…ë°ì´íŠ¸
                                            if (JSON.stringify(cartData) !== JSON.stringify(currentCart)) {
                                                log('ğŸ”„ ì¹´íŠ¸ ë°ì´í„° ë³€ê²½ ê°ì§€ - ì—…ë°ì´íŠ¸ ì¤‘...');
                                                log('ğŸ”„ ë³€ê²½ ì „ ë¡œì»¬ ì¹´íŠ¸: ' + currentCart.length + 'ê°œ ìƒí’ˆ');
                                                log('ğŸ”„ ë³€ê²½ í›„ Firebase ì¹´íŠ¸: ' + cartData.length + 'ê°œ ìƒí’ˆ');
                                                localStorage.setItem('aetherCart', JSON.stringify(cartData));
                                                log('âœ… ì¹´íŠ¸ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ' + cartData.length + 'ê°œ ìƒí’ˆ');
                                                log('âœ… ì›¹ì—ì„œ ì¹´íŠ¸ ë³€ê²½ì‚¬í•­ ê°ì§€ë¨ - ëª¨ë°”ì¼ ë™ê¸°í™” ì™„ë£Œ');
                                                
                                                // ìƒíƒœ ì—…ë°ì´íŠ¸
                                                updateStatus();
                                            } else {
                                                log('ğŸ”„ ì¹´íŠ¸ ë°ì´í„° ë™ì¼ - ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€');
                                            }
                                        } else {
                                            log('Firebase ì¹´íŠ¸ ë¬¸ì„œ ì—†ìŒ - ë¡œì»¬ ì¹´íŠ¸ ë¹„ìš°ê¸°');
                                            localStorage.removeItem('aetherCart');
                                            updateStatus();
                                        }
                                    }, (error) => {
                                        log('âŒ Firebase ì¹´íŠ¸ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜: ' + error.message);
                                    });
                                    
                                    log('âœ… ì¹´íŠ¸ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
                                } catch (error) {
                                    log('âŒ ì¹´íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì‹¤íŒ¨: ' + error.message);
                                }
                            }
                        };
                        log('âœ… CartSyncService ì§ì ‘ ìƒì„± ì™„ë£Œ');
                    }
                    
                    // ì‚¬ìš©ì ì •ë³´ í™•ì¸
                    let user = firebase?.auth?.currentUser;
                    if (!user && typeof getCurrentUser === 'function') {
                        user = getCurrentUser();
                    }
                    
                    if (user && window.CartSyncService) {
                        log('ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •: ' + user.email);
                        window.CartSyncService.setupCartListener(user.email);
                    } else {
                        log('âŒ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì‹¤íŒ¨ - ì‚¬ìš©ì: ' + (user ? user.email : 'ì—†ìŒ') + ', CartSyncService: ' + (window.CartSyncService ? 'ì¡´ì¬' : 'ì—†ìŒ'));
                    }
                }
                
                function testLoadFirebaseData() {
                    log('=== Firebase userCarts ë°ì´í„° ë¡œë“œ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
                    
                    // ì‚¬ìš©ì ì •ë³´ í™•ì¸
                    let user = firebase?.auth?.currentUser;
                    if (!user && typeof getCurrentUser === 'function') {
                        user = getCurrentUser();
                    }
                    
                    if (!user) {
                        log('âŒ ì‚¬ìš©ì ì •ë³´ ì—†ìŒ - í…ŒìŠ¤íŠ¸ ë¶ˆê°€');
                        return;
                    }
                    
                    log('âœ… ì‚¬ìš©ì í™•ì¸: ' + user.email);
                    log('ğŸ” Firebase ìƒíƒœ: ' + (firebase ? 'ì‚¬ìš© ê°€ëŠ¥' : 'ì‚¬ìš© ë¶ˆê°€'));
                    log('ğŸ” Firestore ìƒíƒœ: ' + (firebase?.firestore ? 'ì‚¬ìš© ê°€ëŠ¥' : 'ì‚¬ìš© ë¶ˆê°€'));
                    
                    if (!firebase?.firestore) {
                        log('âŒ Firestore ì‚¬ìš© ë¶ˆê°€ - í…ŒìŠ¤íŠ¸ ì¤‘ë‹¨');
                        return;
                    }
                    
                    const db = firebase.firestore();
                    const userEmail = user.email;
                    
                    log('ğŸ›’ Firebase userCarts ì»¬ë ‰ì…˜ì—ì„œ ë°ì´í„° ë¡œë“œ ì‹œë„: ' + userEmail);
                    
                    // 1. ì§ì ‘ Firestoreì—ì„œ ë°ì´í„° ë¡œë“œ
                    db.collection('userCarts').doc(userEmail).get()
                        .then((doc) => {
                            log('ğŸ“„ Firebase ë¬¸ì„œ ì¡°íšŒ ê²°ê³¼:');
                            log('- ë¬¸ì„œ ì¡´ì¬: ' + doc.exists);
                            log('- ë¬¸ì„œ ID: ' + doc.id);
                            
                            if (doc.exists) {
                                const data = doc.data();
                                log('- ë¬¸ì„œ ë°ì´í„°: ' + JSON.stringify(data, null, 2));
                                log('- ì¹´íŠ¸ ìƒí’ˆ ìˆ˜: ' + (data.cart ? data.cart.length : 0));
                                log('- ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ' + (data.lastUpdated ? data.lastUpdated.toDate() : 'ì—†ìŒ'));
                                log('- ì‚¬ìš©ì ì´ë©”ì¼: ' + (data.userEmail || 'ì—†ìŒ'));
                                
                                // localStorageì™€ ë¹„êµ
                                const localCart = JSON.parse(localStorage.getItem('aetherCart') || '[]');
                                log('ğŸ“¦ ë¡œì»¬ ì¹´íŠ¸ì™€ ë¹„êµ:');
                                log('- ë¡œì»¬ ì¹´íŠ¸ ìƒí’ˆ ìˆ˜: ' + localCart.length);
                                log('- Firebase ì¹´íŠ¸ ìƒí’ˆ ìˆ˜: ' + (data.cart ? data.cart.length : 0));
                                log('- ë°ì´í„° ë™ì¼ ì—¬ë¶€: ' + (JSON.stringify(localCart) === JSON.stringify(data.cart || [])));
                                
                                if (data.cart && data.cart.length > 0) {
                                    log('ğŸ”„ Firebase ì¹´íŠ¸ ë°ì´í„°ë¥¼ localStorageì— ì €ì¥');
                                    localStorage.setItem('aetherCart', JSON.stringify(data.cart));
                                    log('âœ… localStorage ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                                    updateStatus();
                                }
                            } else {
                                log('âŒ Firebase ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ');
                                log('ğŸ“¦ í˜„ì¬ ë¡œì»¬ ì¹´íŠ¸: ' + JSON.parse(localStorage.getItem('aetherCart') || '[]').length + 'ê°œ ìƒí’ˆ');
                            }
                        })
                        .catch((error) => {
                            log('âŒ Firebase ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
                            log('âŒ ì—ëŸ¬ ìƒì„¸: ' + JSON.stringify(error));
                        });
                    
                    // 2. ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ í…ŒìŠ¤íŠ¸
                    log('ğŸ”„ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ í…ŒìŠ¤íŠ¸ ì‹œì‘');
                    const unsubscribe = db.collection('userCarts').doc(userEmail).onSnapshot(
                        (doc) => {
                            log('ğŸ”„ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ íŠ¸ë¦¬ê±°ë¨');
                            log('- ë¬¸ì„œ ì¡´ì¬: ' + doc.exists);
                            if (doc.exists) {
                                const data = doc.data();
                                log('- ì‹¤ì‹œê°„ ì¹´íŠ¸ ìƒí’ˆ ìˆ˜: ' + (data.cart ? data.cart.length : 0));
                                log('- ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ' + (data.lastUpdated ? data.lastUpdated.toDate() : 'ì—†ìŒ'));
                                
                                // ì‹¤ì‹œê°„ìœ¼ë¡œ localStorage ì—…ë°ì´íŠ¸
                                if (data.cart && data.cart.length > 0) {
                                    log('ğŸ”„ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ: localStorage ì—…ë°ì´íŠ¸');
                                    localStorage.setItem('aetherCart', JSON.stringify(data.cart));
                                    updateStatus();
                                }
                            }
                        },
                        (error) => {
                            log('âŒ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì—ëŸ¬: ' + error.message);
                        }
                    );
                    
                    // 5ì´ˆ í›„ ë¦¬ìŠ¤ë„ˆ í•´ì œ
                    setTimeout(() => {
                        unsubscribe();
                        log('ğŸ”„ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ í•´ì œ');
                    }, 5000);
                }
                
                function testWebSync() {
                    log('=== ì›¹ ë™ê¸°í™” í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
                    
                    // ì‚¬ìš©ì ì •ë³´ í™•ì¸
                    let user = firebase?.auth?.currentUser;
                    if (!user && typeof getCurrentUser === 'function') {
                        user = getCurrentUser();
                    }
                    
                    if (!user) {
                        log('âŒ ì‚¬ìš©ì ì •ë³´ ì—†ìŒ - ì›¹ ë™ê¸°í™” í…ŒìŠ¤íŠ¸ ë¶ˆê°€');
                        return;
                    }
                    
                    log('âœ… ì‚¬ìš©ì í™•ì¸: ' + user.email);
                    
                    // Firebaseì—ì„œ ìµœì‹  ë°ì´í„° í™•ì¸
                    const db = firebase.firestore();
                    const userEmail = user.email;
                    
                    log('ğŸ” Firebaseì—ì„œ ìµœì‹  ë°ì´í„° í™•ì¸ ì¤‘...');
                    db.collection('userCarts').doc(userEmail).get()
                        .then((doc) => {
                            if (doc.exists) {
                                const data = doc.data();
                                const firebaseCart = data.cart || [];
                                const localCart = JSON.parse(localStorage.getItem('aetherCart') || '[]');
                                
                                log('ğŸ“¦ ì›¹ ë™ê¸°í™” í…ŒìŠ¤íŠ¸ ê²°ê³¼:');
                                log('- Firebase ì¹´íŠ¸: ' + firebaseCart.length + 'ê°œ ìƒí’ˆ');
                                log('- ë¡œì»¬ ì¹´íŠ¸: ' + localCart.length + 'ê°œ ìƒí’ˆ');
                                log('- ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ' + (data.lastUpdated ? data.lastUpdated.toDate() : 'ì—†ìŒ'));
                                log('- ë°ì´í„° ë™ì¼ ì—¬ë¶€: ' + (JSON.stringify(firebaseCart) === JSON.stringify(localCart)));
                                
                                if (firebaseCart.length > localCart.length) {
                                    log('ğŸ”„ Firebaseì— ë” ë§ì€ ë°ì´í„° ìˆìŒ - ë¡œì»¬ ì—…ë°ì´íŠ¸');
                                    localStorage.setItem('aetherCart', JSON.stringify(firebaseCart));
                                    log('âœ… ë¡œì»¬ ì¹´íŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ' + firebaseCart.length + 'ê°œ ìƒí’ˆ');
                                    updateStatus();
                                } else if (localCart.length > firebaseCart.length) {
                                    log('ğŸ”„ ë¡œì»¬ì— ë” ë§ì€ ë°ì´í„° ìˆìŒ - Firebase ì—…ë°ì´íŠ¸');
                                    // Firebaseì— ë¡œì»¬ ë°ì´í„° ì €ì¥
                                    db.collection('userCarts').doc(userEmail).set({
                                        cart: localCart,
                                        lastUpdated: new Date(),
                                        userEmail: userEmail
                                    }).then(() => {
                                        log('âœ… Firebase ì¹´íŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ' + localCart.length + 'ê°œ ìƒí’ˆ');
                                    }).catch(error => {
                                        log('âŒ Firebase ì¹´íŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + error.message);
                                    });
                                } else {
                                    log('âœ… ì›¹ê³¼ ëª¨ë°”ì¼ ì¹´íŠ¸ ë™ê¸°í™” ì™„ë£Œ');
                                }
                            } else {
                                log('âŒ Firebase ë¬¸ì„œ ì—†ìŒ - ì›¹ ë™ê¸°í™” ë¶ˆê°€');
                            }
                        })
                        .catch((error) => {
                            log('âŒ ì›¹ ë™ê¸°í™” í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + error.message);
                        });
                }
                
                function goToCart() {
                    log('ì¹´íŠ¸ í˜ì´ì§€ë¡œ ì´ë™');
                    window.location.href = 'cart.html';
                }
        
        // CartSyncService ì§ì ‘ ìƒì„± (ì„ì‹œ í•´ê²°ì±…)
        function createCartSyncService() {
            if (window.CartSyncService) {
                log('CartSyncService ì´ë¯¸ ì¡´ì¬');
                return true;
            }
            
            if (!firebase?.firestore || !window.FirebaseService) {
                log('CartSyncService ìƒì„± ë¶ˆê°€: Firebase ë˜ëŠ” FirebaseService ì—†ìŒ');
                return false;
            }
            
            log('CartSyncService ì§ì ‘ ìƒì„± ì¤‘...');
            
            window.CartSyncService = {
                async saveCartToFirebase(cartData, userEmail) {
                    try {
                        log('ğŸ›’ Firebase ì¹´íŠ¸ ì €ì¥ ì‹œë„: ' + userEmail);
                        const db = firebase.firestore();
                        await db.collection('userCarts').doc(userEmail).set({
                            cart: cartData,
                            lastUpdated: new Date(),
                            userEmail: userEmail
                        });
                        log('âœ… Firebase ì¹´íŠ¸ ì €ì¥ ì™„ë£Œ');
                        return true;
                    } catch (error) {
                        log('âŒ Firebase ì¹´íŠ¸ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
                        return false;
                    }
                },
                
                async loadCartFromFirebase(userEmail) {
                    try {
                        log('ğŸ›’ Firebase ì¹´íŠ¸ ë¡œë“œ ì‹œë„: ' + userEmail);
                        const db = firebase.firestore();
                        const cartDoc = await db.collection('userCarts').doc(userEmail).get();
                        
                        if (cartDoc.exists) {
                            const cartData = cartDoc.data().cart || [];
                            log('âœ… Firebase ì¹´íŠ¸ ë¡œë“œ ì™„ë£Œ: ' + cartData.length + 'ê°œ ìƒí’ˆ');
                            return cartData;
                        } else {
                            log('Firebase ì¹´íŠ¸ ì—†ìŒ');
                            return [];
                        }
                    } catch (error) {
                        log('âŒ Firebase ì¹´íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
                        return [];
                    }
                },
                
                async syncCart(userEmail) {
                    try {
                        log('ğŸ”„ ì¹´íŠ¸ ë™ê¸°í™” ì‹œì‘: ' + userEmail);
                        
                        // í˜„ì¬ ì¹´íŠ¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                        const cartData = JSON.parse(localStorage.getItem('aetherCart') || '[]');
                        
                        // Firebaseì— ì €ì¥
                        await this.saveCartToFirebase(cartData, userEmail);
                        
                        // Firebaseì—ì„œ ìµœì‹  ë°ì´í„° ë¡œë“œ
                        const latestCart = await this.loadCartFromFirebase(userEmail);
                        
                        // localStorage ì—…ë°ì´íŠ¸
                        localStorage.setItem('aetherCart', JSON.stringify(latestCart));
                        
                        log('âœ… ì¹´íŠ¸ ë™ê¸°í™” ì™„ë£Œ: ' + latestCart.length + 'ê°œ ìƒí’ˆ');
                        return latestCart;
                    } catch (error) {
                        log('âŒ ì¹´íŠ¸ ë™ê¸°í™” ì‹¤íŒ¨: ' + error.message);
                        return JSON.parse(localStorage.getItem('aetherCart') || '[]');
                    }
                }
            };
            
            log('âœ… CartSyncService ì§ì ‘ ìƒì„± ì™„ë£Œ');
            return true;
        }
        
        // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ í™•ì¸ í•¨ìˆ˜
        async function waitForScripts() {
            log('ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ í™•ì¸ ì¤‘...');
            
            let attempts = 0;
            const maxAttempts = 100; // 10ì´ˆ ëŒ€ê¸°
            
            while (attempts < maxAttempts) {
                const scriptsLoaded = {
                    firebase: typeof firebase !== 'undefined',
                    FirebaseService: typeof window.FirebaseService !== 'undefined',
                    CartSyncService: typeof window.CartSyncService !== 'undefined',
                    authUtils: typeof getCurrentUser !== 'undefined'
                };
                
                log('ìŠ¤í¬ë¦½íŠ¸ ìƒíƒœ: firebase=' + scriptsLoaded.firebase + 
                    ', FirebaseService=' + scriptsLoaded.FirebaseService + 
                    ', CartSyncService=' + scriptsLoaded.CartSyncService + 
                    ', authUtils=' + scriptsLoaded.authUtils);
                
                if (scriptsLoaded.firebase && scriptsLoaded.FirebaseService) {
                    // CartSyncServiceê°€ ì—†ìœ¼ë©´ ì§ì ‘ ìƒì„±
                    if (!scriptsLoaded.CartSyncService) {
                        log('CartSyncService ì—†ìŒ - ì§ì ‘ ìƒì„± ì‹œë„');
                        if (createCartSyncService()) {
                            log('ëª¨ë“  í•„ìˆ˜ ìŠ¤í¬ë¦½íŠ¸ ì¤€ë¹„ ì™„ë£Œ');
                            return true;
                        }
                    } else {
                        log('ëª¨ë“  í•„ìˆ˜ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');
                        return true;
                    }
                }
                
                attempts++;
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            log('ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ íƒ€ì„ì•„ì›ƒ - CartSyncService ì§ì ‘ ìƒì„± ì‹œë„');
            return createCartSyncService();
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async function() {
            log('í˜ì´ì§€ ë¡œë“œ ì‹œì‘');
            
            // ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ëŒ€ê¸°
            const scriptsReady = await waitForScripts();
            
                    if (scriptsReady) {
                        log('Firebase ì´ˆê¸°í™” ëŒ€ê¸° ì™„ë£Œ');
                        updateStatus();
                        
                        // ìë™ìœ¼ë¡œ Firebase ë°ì´í„° ë¡œë“œ ë° ê°•ë ¥í•œ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                        setTimeout(() => {
                            log('ìë™ Firebase ë°ì´í„° ë¡œë“œ ì‹œì‘');
                            testLoadFirebaseData();
                            
                            setTimeout(() => {
                                log('ìë™ ê°•ë ¥í•œ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì‹œì‘');
                                setupRealtimeListener();
                                
                                setTimeout(() => {
                                    log('ìë™ ì›¹ ë™ê¸°í™” í…ŒìŠ¤íŠ¸ ì‹œì‘');
                                    testWebSync();
                                }, 2000);
                            }, 1000);
                        }, 2000);
                    } else {
                        log('ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨ - ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ í•„ìš”');
                        updateStatus();
                    }
        });
    </script>
</body>
</html>
