<!DOCTYPE html>
<html lang="ja">
<head>
    <title>ご注文手続き - Aether</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="assets/img/aether-icon.png?t=1750992166">
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/templatemo.css">
    <link rel="stylesheet" href="assets/css/custom.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800;900&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100;200;300;400;500;600;700;800;900&display=swap">
    <link rel="stylesheet" href="assets/css/fontawesome.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    
    <!-- QR Code Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body {
            font-family: "Montserrat", sans-serif;
            background-color: #f8f9fa;
        }
        .japanese-text {
            font-family: "Noto Sans JP", sans-serif;
            font-weight: 400;
            line-height: 1.6;
        }
        
        /* 모달 내 일본어 텍스트 크기 조정 */
        .modal-body.japanese-text,
        .modal-body.japanese-text p,
        .modal-body.japanese-text h6,
        .modal-body.japanese-text li,
        .modal-body.japanese-text ul {
            font-size: 0.8em !important;
        }
        .japanese-heading {
            font-family: "Noto Sans JP", sans-serif;
            font-weight: 600;
            line-height: 1.4;
        }
        .checkout-container {
            min-height: 100vh;
            padding: 2rem 0;
        }
        .checkout-card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        .checkout-header {
            background-color: #343a40;
            color: white;
            border-radius: 10px 10px 0 0;
            padding: 1.5rem;
        }
        .form-control:focus {
            border-color: #6c757d;
            box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.25);
        }
        .btn-checkout {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        .btn-checkout:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        .step {
            display: flex;
            align-items: center;
            margin: 0.5rem;
            min-width: 120px;
        }
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #6c757d;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.5rem;
        }
        .step.active .step-number {
            background-color: #343a40;
        }
                 .step.completed .step-number {
             background-color: #343a40;
         }
         
         /* 모바일에서 2열 레이아웃 - 순서대로 정렬 */
         @media (max-width: 768px) and (min-width: 481px) {
             .step-indicator {
                 display: grid;
                 grid-template-columns: 1fr 1fr;
                 grid-template-rows: 1fr 1fr;
                 gap: 1rem;
                 justify-items: center;
                 align-items: center;
             }
             
             .step {
                 width: 100%;
                 max-width: 160px;
                 justify-content: center;
                 margin: 0;
             }
             
             /* 각 단계별 순서 지정 */
             .step:nth-child(1) { order: 1; } /* 1 カート */
             .step:nth-child(2) { order: 2; } /* 2 配送情報 */
             .step:nth-child(3) { order: 3; } /* 3 お支払い */
             .step:nth-child(4) { order: 4; } /* 4 完了 */
             
             .step span {
                 font-size: 0.9rem;
             }
         }
         
         /* 매우 작은 화면에서 - 순서대로 정렬 */
         @media (max-width: 480px) {
             .step-indicator {
                 display: grid;
                 grid-template-columns: 1fr 1fr;
                 grid-template-rows: 1fr 1fr;
                 gap: 0.5rem;
                 justify-items: center;
                 align-items: center;
             }
             
             .step {
                 width: 100%;
                 max-width: 140px;
                 margin: 0;
                 justify-content: center;
                 order: 0; /* 기본 순서 */
             }
             
             /* 각 단계별 순서 지정 */
             .step:nth-child(1) { order: 1; } /* 1 カート */
             .step:nth-child(2) { order: 2; } /* 2 配送情報 */
             .step:nth-child(3) { order: 3; } /* 3 お支払い */
             .step:nth-child(4) { order: 4; } /* 4 完了 */
             
             .step span {
                 font-size: 0.75rem;
             }
         }
        .order-summary {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 1rem 0;
            border-bottom: 1px solid #dee2e6;
            flex-wrap: wrap;
        }
        .order-item:last-child {
            border-bottom: none;
        }
        .order-item-info {
            flex: 1;
            min-width: 200px;
        }
        .order-item-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        /* 태블릿 반응형 */
        @media (max-width: 992px) {
            .order-item-controls {
                gap: 0.5rem;
            }
        }
        
        /* 모바일 반응형 */
        @media (max-width: 768px) {
            .order-item {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }
            .order-item-controls {
                justify-content: space-between;
                width: 100%;
                flex-wrap: nowrap;
            }
            .order-item-price {
                order: 1;
                font-size: 1.1rem;
                font-weight: bold;
                text-align: right;
                flex: 1;
            }
            .order-item-actions {
                order: 2;
                display: flex;
                gap: 0.5rem;
                align-items: center;
            }
        }

        /* 작은 모바일 */
        @media (max-width: 480px) {
            .order-item-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }
            .order-item-price {
                order: 1;
                text-align: center;
                padding: 0.5rem;
                background: #f8f9fa;
                border-radius: 4px;
            }
            .order-item-actions {
                order: 2;
                justify-content: center;
            }
            .quantity-controls {
                justify-content: center;
            }
        }
        .quantity-controls {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 0.15rem;
            align-items: center;
        }
        .quantity-controls .btn {
            width: 28px;
            height: 28px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #6c757d;
            font-size: 0.75rem;
            padding: 0;
        }
        .quantity-controls .btn:hover {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }
        .quantity-display {
            min-width: 35px;
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
        }
        /* 삭제 버튼도 모노톤으로 */
        .btn-delete-item {
            width: 28px;
            height: 28px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #6c757d;
            background-color: #ffffff;
            color: #6c757d;
            font-size: 0.75rem;
            padding: 0;
        }
        .btn-delete-item:hover {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }
        .payment-methods {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .payment-method {
            flex: 1;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .payment-method.selected {
            border-color: #6c757d;
            background-color: #f8f9fa;
        }
        .payment-method:hover {
            border-color: #6c757d;
        }
        .card-icons {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .card-icon {
            width: 30px;
            height: 20px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        .security-info {
            background-color: #e9ecef;
            border-radius: 8px;
        }
        
        /* 네비게이션바 텍스트 thin 서체 통일 */
        .navbar-nav .nav-link {
            font-family: "Montserrat", sans-serif !important;
            font-weight: 300 !important;
            font-size: 1rem !important;
        }
        
        .navbar-brand {
            font-family: "Montserrat", sans-serif !important;
            font-weight: 300 !important;
        }
        
        #user-name {
            font-family: "Montserrat", sans-serif !important;
            font-weight: 300 !important;
        }
        .progress-bar {
            height: 4px;
            background-color: #dee2e6;
            border-radius: 2px;
            margin-bottom: 2rem;
        }
                 .progress-fill {
             height: 100%;
             background-color: #6c757d;
             border-radius: 2px;
             width: 75%;
             transition: width 0.3s ease;
         }
         /* User dropdown hover fix */
         .dropdown-toggle:hover,
         .dropdown-toggle:focus,
         #user-name:hover {
             color: #343a40 !important;
             text-decoration: none !important;
         }
         .nav-link:hover {
             color: #343a40 !important;
         }
     </style>
</head>

<body>
    <!-- Start Top Nav -->
    <nav class="navbar navbar-expand-lg navbar-light" id="templatemo_nav_top" style="min-height: 20px; background-color: #000000 !important;">
        <div class="container text-light">
            <div class="w-100 d-flex justify-content-between">
                <div>
                    <!-- 빈 공간으로 블랙 바 유지 -->
                </div>
            </div>
        </div>
    </nav>
    <!-- Close Top Nav -->

    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-light shadow">
        <div class="container d-flex justify-content-between align-items-center">

            <a class="navbar-brand text-success logo align-self-center" href="index.html">
                <img src="assets/img/logo.png" alt="Logo" class="img-fluid" style="max-height: 50px;">
            </a>

            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#templatemo_main_nav" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="align-self-center collapse navbar-collapse flex-fill  d-lg-flex justify-content-lg-between" id="templatemo_main_nav">
                <!-- 모바일 메뉴 레이아웃 -->
                <div class="d-lg-none w-100">
                    <!-- 영문 메뉴 - 가로 정렬 -->
                    <div class="d-flex justify-content-center mb-4">
                        <ul class="nav navbar-nav d-flex flex-row gap-4">
                            <li class="nav-item">
                                <a class="nav-link" href="index.html">Home</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="shop.html">Brand</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="info.html">Info</a>
                            </li>
                        </ul>
                    </div>
                    
                    <!-- 아이콘들 - 가로 정렬, 좌우 여백 추가 -->
                    <div class="d-flex justify-content-center align-items-center gap-4 px-4">
                        <a href="cart.html" class="nav-link text-decoration-none">
                            <i class="fas fa-shopping-cart text-dark" style="font-size: 1.5rem;"></i>
                            <span class="badge bg-secondary ms-1" id="cart-count-mobile">0</span>
                        </a>
                        <div class="dropdown">
                            <a href="#" class="nav-link dropdown-toggle text-decoration-none" id="userDropdownMobile" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user text-dark" style="font-size: 1.5rem;"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-center" aria-labelledby="userDropdownMobile">
                                <li id="login-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="login.html">
                                        <i class="fas fa-sign-in-alt me-2"></i>Login
                                    </a>
                                </li>
                                <li id="register-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="register.html">
                                        <i class="fas fa-user-plus me-2"></i>Register
                                    </a>
                                </li>
                                <li id="profile-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="profile.html">
                                        <i class="fas fa-user-circle me-2"></i>Profile
                                    </a>
                                </li>
                                <li id="points-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="points.html">
                                        <i class="fas fa-coins me-2"></i>Points
                                    </a>
                                </li>
                                <li id="admin-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="admin-dashboard.html">
                                        <i class="fas fa-cog me-2"></i>管理ダッシュボード
                                    </a>
                                </li>
                                <li id="logout-menu-mobile" style="display: none;">
                                    <hr class="dropdown-divider">
                                </li>
                                <li id="logout-menu-item-mobile" style="display: none;">
                                    <a class="dropdown-item" href="#" onclick="logout()">
                                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- 데스크톱 메뉴 레이아웃 -->
                <div class="flex-fill d-none d-lg-block">
                    <ul class="nav navbar-nav d-flex justify-content-between mx-lg-auto" style="max-width: 400px; margin: 0 auto;">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="shop.html">Brand</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="info.html">Info</a>
                        </li>
                    </ul>
                </div>
                <div class="navbar align-self-center d-flex d-none d-lg-flex">
                    <a href="cart.html" class="nav-link text-decoration-none me-3">
                        <i class="fas fa-shopping-cart text-dark"></i>
                        <span class="badge bg-secondary" id="cart-count">0</span>
                    </a>
                    <div class="dropdown">
                        <a href="#" class="nav-link dropdown-toggle text-decoration-none" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user text-dark"></i>
                            <span id="user-name" class="d-none d-lg-inline ms-1"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li id="login-menu" style="display: none;">
                                <a class="dropdown-item" href="login.html">
                                    <i class="fas fa-sign-in-alt me-2"></i>Login
                                </a>
                            </li>
                            <li id="register-menu" style="display: none;">
                                <a class="dropdown-item" href="register.html">
                                    <i class="fas fa-user-plus me-2"></i>Register
                                </a>
                            </li>
                            <li id="profile-menu" style="display: none;">
                                <a class="dropdown-item" href="profile.html">
                                    <i class="fas fa-user-circle me-2"></i>Profile
                                </a>
                            </li>
                            <li id="points-menu" style="display: none;">
                                <a class="dropdown-item" href="points.html">
                                    <i class="fas fa-coins me-2"></i>Points
                                </a>
                            </li>
                            <li id="admin-menu" style="display: none;">
                                <a class="dropdown-item" href="admin-dashboard.html">
                                    <i class="fas fa-cog me-2"></i>管理ダッシュボード
                                </a>
                            </li>
                            <li id="logout-menu" style="display: none;">
                                <hr class="dropdown-divider">
                            </li>
                            <li id="logout-menu-item" style="display: none;">
                                <a class="dropdown-item" href="#" onclick="logout()">
                                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    <!-- Close Header -->

    <!-- QR Code Modal -->
    <div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="qrModalLabel">QR Code</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="qrCodeContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Checkout Container -->
    <div class="checkout-container">
        <div class="container">
            <!-- Progress Bar -->
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>

            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step completed">
                    <div class="step-number">1</div>
                    <span class="japanese-text">カート</span>
                </div>
                <div class="step active">
                    <div class="step-number">2</div>
                    <span class="japanese-text">配送情報</span>
                </div>
                <div class="step">
                    <div class="step-number">3</div>
                    <span class="japanese-text">お支払い</span>
                </div>
                <div class="step">
                    <div class="step-number">4</div>
                    <span class="japanese-text">完了</span>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <!-- Shipping Information -->
                    <div class="card checkout-card">
                        <div class="checkout-header">
                            <h5 class="japanese-heading mb-0">
                                <i class="fas fa-shipping-fast me-2"></i>配送先情報
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info japanese-text d-none" id="shipping-alert"></div>
                            <form id="shipping-form" class="needs-validation" novalidate>
                                <div class="row g-3">
                                    <!-- Name -->
                                    <div class="col-12">
                                        <label for="shipping-name" class="form-label japanese-text">お名前 <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="shipping-name" required>
                                        <div class="invalid-feedback">お名前を入力してください</div>
                                    </div>

                                    <!-- Phone -->
                                    <div class="col-12">
                                        <label for="shipping-phone" class="form-label japanese-text">電話番号 <span class="text-danger">*</span></label>
                                        <input type="tel" class="form-control" id="shipping-phone" required>
                                        <div class="invalid-feedback">電話番号を入力してください</div>
                                    </div>

                                    <!-- Postal Code -->
                                    <div class="col-md-4">
                                        <label for="shipping-postal" class="form-label japanese-text">郵便番号 <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="shipping-postal" placeholder="例：123-4567" maxlength="8" required>
                                            <button class="btn btn-outline-secondary" type="button" id="search-address-btn" onclick="searchAddress()">
                                                <i class="fas fa-search"></i>
                                            </button>
                                    </div>
                                        <div class="form-text japanese-text" id="postal-feedback"></div>
                                        <div class="invalid-feedback">郵便番号を入力してください</div>
                                    </div>

                                    <!-- Prefecture -->
                                    <div class="col-md-4">
                                        <label for="shipping-prefecture" class="form-label japanese-text">都道府県 <span class="text-danger">*</span></label>
                                        <select class="form-select" id="shipping-prefecture" required>
                                            <option value="">選択してください</option>
                                            <option value="北海道">北海道</option>
                                            <option value="青森県">青森県</option>
                                            <option value="岩手県">岩手県</option>
                                            <option value="宮城県">宮城県</option>
                                            <option value="秋田県">秋田県</option>
                                            <option value="山形県">山形県</option>
                                            <option value="福島県">福島県</option>
                                            <option value="茨城県">茨城県</option>
                                            <option value="栃木県">栃木県</option>
                                            <option value="群馬県">群馬県</option>
                                            <option value="埼玉県">埼玉県</option>
                                            <option value="千葉県">千葉県</option>
                                            <option value="東京都">東京都</option>
                                            <option value="神奈川県">神奈川県</option>
                                            <option value="新潟県">新潟県</option>
                                            <option value="富山県">富山県</option>
                                            <option value="石川県">石川県</option>
                                            <option value="福井県">福井県</option>
                                            <option value="山梨県">山梨県</option>
                                            <option value="長野県">長野県</option>
                                            <option value="岐阜県">岐阜県</option>
                                            <option value="静岡県">静岡県</option>
                                            <option value="愛知県">愛知県</option>
                                            <option value="三重県">三重県</option>
                                            <option value="滋賀県">滋賀県</option>
                                            <option value="京都府">京都府</option>
                                            <option value="大阪府">大阪府</option>
                                            <option value="兵庫県">兵庫県</option>
                                            <option value="奈良県">奈良県</option>
                                            <option value="和歌山県">和歌山県</option>
                                            <option value="鳥取県">鳥取県</option>
                                            <option value="島根県">島根県</option>
                                            <option value="岡山県">岡山県</option>
                                            <option value="広島県">広島県</option>
                                            <option value="山口県">山口県</option>
                                            <option value="徳島県">徳島県</option>
                                            <option value="香川県">香川県</option>
                                            <option value="愛媛県">愛媛県</option>
                                            <option value="高知県">高知県</option>
                                            <option value="福岡県">福岡県</option>
                                            <option value="佐賀県">佐賀県</option>
                                            <option value="長崎県">長崎県</option>
                                            <option value="熊本県">熊本県</option>
                                            <option value="大分県">大分県</option>
                                            <option value="宮崎県">宮崎県</option>
                                            <option value="鹿児島県">鹿児島県</option>
                                            <option value="沖縄県">沖縄県</option>
                                        </select>
                                        <div class="invalid-feedback">都道府県を選択してください</div>
                                    </div>

                                    <!-- City -->
                                    <div class="col-md-4">
                                    <label for="shipping-city" class="form-label japanese-text">市区町村 <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="shipping-city" required>
                                        <div class="invalid-feedback">市区町村を入力してください</div>
                                </div>

                                    <!-- Address Line 1 -->
                                    <div class="col-12">
                                        <label for="shipping-address1" class="form-label japanese-text">住所1 <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="shipping-address1" required>
                                        <div class="invalid-feedback">住所を入力してください</div>
                                </div>

                                    <!-- Address Line 2 -->
                                    <div class="col-12">
                                        <label for="shipping-address2" class="form-label japanese-text">住所2 (建物名・部屋番号など)</label>
                                        <input type="text" class="form-control" id="shipping-address2">
                                </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Payment Information -->
                    <div class="card checkout-card">
                        <div class="checkout-header">
                            <h5 class="japanese-heading mb-0">
                                <i class="fas fa-credit-card me-2"></i>お支払い方法
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info japanese-text d-none" id="payment-alert"></div>
                            
                            <!-- Payment Methods -->
                            <div class="payment-methods">
                                <div class="payment-method selected" data-method="credit">
                                    <i class="fas fa-credit-card fa-2x text-muted mb-2"></i>
                                    <div class="japanese-text">クレジットカード</div>
                                    <div class="card-icons">
                                        <div class="card-icon" style="background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAzMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMwIiBoZWlnaHQ9IjIwIiByeD0iNCIgZmlsbD0iIzAwNTFBNSIvPgo8dGV4dCB4PSI1IiB5PSIxNCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjgiIGZpbGw9IndoaXRlIj5WSVNBPC90ZXh0Pgo8L3N2Zz4K')"></div>
                                        <div class="card-icon" style="background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAzMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMwIiBoZWlnaHQ9IjIwIiByeD0iNCIgZmlsbD0iI0VCMDAxQiIvPgo8Y2lyY2xlIGN4PSIxMCIgY3k9IjEwIiByPSI2IiBmaWxsPSIjRkY1RjAwIi8+CjxjaXJjbGUgY3g9IjIwIiBjeT0iMTAiIHI9IjYiIGZpbGw9IiNGRkY1RjAiLz4KPC9zdmc+')"></div>
                                        <div class="card-icon" style="background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAiIGhlaWdodD0iMjAiIHZpZXdCb3g9IjAgMCAzMCAyMCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMwIiBoZWlnaHQ9IjIwIiByeD0iNCIgZmlsbD0iIzAwNkZDRiIvPgo8dGV4dCB4PSI0IiB5PSIxNCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjciIGZpbGw9IndoaXRlIj5BTUVYPC90ZXh0Pgo8L3N2Zz4K')"></div>
                                    </div>
                                </div>
                                <div class="payment-method" data-method="bank-transfer">
                                    <i class="fas fa-university fa-2x text-muted mb-2"></i>
                                    <div class="japanese-text">銀行振込</div>
                                    <div class="small text-muted mt-1">入金確認後に発送</div>
                                </div>
                            </div>

                            <!-- Credit Card Form -->
                            <div id="credit-card-form">
                                <form id="payment-form">
                                    <!-- Stripe Card Element -->
                                    <div class="mb-3">
                                        <label class="form-label japanese-text">カード情報 <span class="text-danger">*</span></label>
                                        <div id="card-element" class="form-control" style="height: auto; padding: 12px;">
                                            <!-- Stripe Element が挿入されます -->
                                        </div>
                                        <div id="card-errors" class="text-danger small mt-2" role="alert"></div>
                                        <div class="form-text japanese-text mt-2">
                                            <i class="fas fa-lock me-1"></i>安全な決済処理 (Stripe)
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="card-name" class="form-label japanese-text">カード名義人 <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="card-name" required>
                                        <div class="form-text japanese-text">カードに記載されている名前をローマ字で入力</div>
                                    </div>
                                </form>
                            </div>

                            <!-- Bank Transfer Info -->
                            <div id="bank-transfer-info" style="display: none;">
                                <div class="alert japanese-text" style="background-color: #f8f9fa; border: 1px solid #dee2e6;">
                                    <h6 class="japanese-heading mb-3" style="color: #495057; font-weight: 600;">
                                        <i class="fas fa-info-circle me-2"></i>振込先情報
                                    </h6>
                                    <div class="bank-info-box p-3 rounded" style="background-color: #ffffff; border: 1px solid #ced4da;">
                                        <div class="mb-2">
                                            <strong style="color: #495057;">銀行名：</strong><span id="bank-name-display" style="color: #6c757d;">未設定</span>
                                        </div>
                                        <div class="mb-2">
                                            <strong style="color: #495057;">支店名：</strong><span id="bank-branch-display" style="color: #6c757d;">未設定</span>
                                        </div>
                                        <div class="mb-2">
                                            <strong style="color: #495057;">口座種別：</strong><span id="bank-type-display" style="color: #6c757d;">未設定</span>
                                        </div>
                                        <div class="mb-2">
                                            <strong style="color: #495057;">口座番号：</strong><span id="bank-account-display" style="color: #6c757d;">未設定</span>
                                        </div>
                                        <div class="mb-0">
                                            <strong style="color: #495057;">口座名義：</strong><span id="bank-holder-display" style="color: #6c757d;">未設定</span>
                                        </div>
                                    </div>
                                    <div class="mt-3 small" style="color: #6c757d;">
                                        <p class="mb-2"><i class="fas fa-exclamation-triangle me-2"></i>振込手数料はお客様負担となります。</p>
                                        <p class="mb-2"><i class="fas fa-clock me-2"></i>入金確認後、商品を発送いたします。</p>
                                        <p class="mb-0"><i class="fas fa-calendar-alt me-2"></i>ご注文から3日以内にお振込みください。</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Security Info -->
                            <div class="security-info">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-shield-alt text-dark me-2"></i>
                                    <strong class="japanese-text">安全な決済</strong>
                                </div>
                                <small class="japanese-text text-muted">
                                    お客様のクレジットカード情報は、SSL暗号化技術により安全に保護されています。
                                    カード情報は当社サーバーに保存されることはありません。
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <!-- Order Summary -->
                    <div class="card checkout-card">
                        <div class="checkout-header">
                            <h5 class="japanese-heading mb-0">
                                <i class="fas fa-receipt me-2"></i>ご注文内容
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="order-items"></div>
                            
                            <hr>
                            
                            <div class="order-summary">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="japanese-text">商品合計:</span>
                                    <span id="subtotal">¥0</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="japanese-text">配送料:</span>
                                    <span id="shipping-fee">¥500</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="japanese-text">消費税:</span>
                                    <span id="tax">¥0</span>
                                </div>
                                
                                <!-- 포인트 사용 섹션 - 간단 버전 -->
                                <div class="point-use-section" id="point-use-section" style="display: block;">
                                    <hr>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <span class="japanese-text">保有ポイント:</span>
                                            <span id="available-points" class="fw-bold">0pt</span>
                                        </div>
                                        
                                        <div class="input-group mb-3">
                                            <input type="number" class="form-control" id="points-to-use" placeholder="使用ポイント数を入力" min="0" max="0">
                                            <span class="input-group-text">pt</span>
                                            <button class="btn btn-outline-secondary" type="button" onclick="useMaxPoints()" title="全ポイント使用">
                                                <i class="fas fa-coins"></i>
                                            </button>
                                        </div>
                                        
                                        <div class="small text-muted mb-2">
                                            1ポイント = 1円 (最大 <span id="max-points-display">0</span>pt まで使用可能)
                                        </div>
                                        
                                        <div id="point-feedback" class="small"></div>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="japanese-text">ポイント割引:</span>
                                        <span id="point-discount" class="fw-bold">-¥0</span>
                                    </div>
                                </div>
                                
                                <hr>
                                <div class="d-flex justify-content-between mb-3">
                                    <strong class="japanese-text">合計:</strong>
                                    <strong id="total">¥0</strong>
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <button class="btn btn-checkout btn-dark btn-lg japanese-text" id="place-order-btn">
                                    <i class="fas fa-lock me-2"></i>注文を確定する
                                </button>
                                <a href="cart.html" class="btn btn-outline-secondary japanese-text">
                                    <i class="fas fa-arrow-left me-2"></i>カートに戻る
                                </a>
                            </div>

                            <div class="text-center mt-3">
                                <small class="japanese-text text-muted">
                                    注文確定により、<a href="#" class="text-decoration-none text-dark fw-bold" onclick="showTermsModal()">利用規約</a>および<a href="#" class="text-decoration-none text-dark fw-bold" onclick="showPrivacyModal()">プライバシーポリシー</a>に同意したものとします。
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 利用規約 Modal -->
    <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title japanese-heading" id="termsModalLabel">利用規約</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body japanese-text">
                    <h6>第1条（適用）</h6>
                    <p>本規約は、株式会社Aether（以下「当社」）が運営するオンラインショップ「Aether」（以下「本サービス」）の利用に関して、当社とお客様との間の権利義務関係を定めるものです。</p>
                    
                    <h6>第2条（利用登録）</h6>
                    <p>1. 本サービスの利用を希望する方は、本規約に同意の上、所定の方法によって利用登録を申請し、当社がこれを承認することによって利用登録が完了します。</p>
                    <p>2. 当社は、利用登録の申請者に以下の事由があると判断した場合、利用登録の申請を承認しないことがあります。</p>
                    <ul>
                        <li>利用登録の申請に際して虚偽の事項を届け出た場合</li>
                        <li>本規約に違反したことがある者からの申請である場合</li>
                        <li>その他、当社が利用登録を相当でないと判断した場合</li>
                    </ul>
                    
                    <h6>第3条（商品の注文・購入）</h6>
                    <p>1. お客様は、本サービスにおいて当社が販売する商品を注文し、購入することができます。</p>
                    <p>2. 商品の注文は、お客様が本サービス上で所定の手続きを完了し、当社がこれを承諾した時点で確定します。</p>
                    <p>3. 商品の価格は、本サービス上に表示された価格とします。ただし、システムエラー等により明らかに不適切な価格が表示された場合、当社は注文を取り消すことができます。</p>
                    
                    <h6>第4条（支払い）</h6>
                    <p>1. 商品代金の支払いは、クレジットカード、銀行振込、代金引換等、当社が指定する方法によって行うものとします。</p>
                    <p>2. 支払期限は、注文確定日から7日以内とします。期限内にお支払いが確認できない場合、注文をキャンセルすることがあります。</p>
                    
                    <h6>第5条（配送）</h6>
                    <p>1. 商品の配送は、お客様が指定した配送先住所に対して行います。</p>
                    <p>2. 配送料は、配送地域および商品の種類・数量に応じて決定し、注文時に表示します。</p>
                    <p>3. 配送期間は、ご注文確定後3～7営業日を目安としますが、商品の在庫状況等により遅延する場合があります。</p>
                    
                    <h6>第6条（返品・交換）</h6>
                    <p>1. 商品に不具合がある場合、商品到着後7日以内にご連絡いただければ、返品・交換に応じます。</p>
                    <p>2. お客様都合による返品・交換は、未開封・未使用の商品に限り、商品到着後7日以内であれば承ります。この場合の送料はお客様負担となります。</p>
                    
                    <h6>第7条（禁止事項）</h6>
                    <p>お客様は、本サービスの利用にあたり、以下の行為をしてはなりません。</p>
                    <ul>
                        <li>法令または公序良俗に違反する行為</li>
                        <li>犯罪行為に関連する行為</li>
                        <li>当社のサーバーまたはネットワークの機能を破壊したり、妨害したりする行為</li>
                        <li>当社のサービスの運営を妨害するおそれのある行為</li>
                        <li>他のお客様に関する個人情報等を収集または蓄積する行為</li>
                        <li>その他、当社が不適切と判断する行為</li>
                    </ul>
                    
                    <h6>第8条（利用制限・登録抹消）</h6>
                    <p>当社は、お客様が以下のいずれかに該当する場合、事前の通知なく、お客様に対して本サービスの全部または一部の利用を制限し、または利用登録を抹消することができます。</p>
                    <ul>
                        <li>本規約のいずれかの条項に違反した場合</li>
                        <li>登録事項に虚偽の事実があることが判明した場合</li>
                        <li>その他、当社が本サービスの利用を適当でないと判断した場合</li>
                    </ul>
                    
                    <h6>第9条（免責事項）</h6>
                    <p>1. 当社は、本サービスに事実上または法律上の瑕疵がないことを明示的にも黙示的にも保証しておりません。</p>
                    <p>2. 当社は、本サービスに起因してお客様に生じたあらゆる損害について一切の責任を負いません。</p>
                    
                    <h6>第10条（アカウント削除および再登録制限）</h6>
                    <p>1. お客様がアカウントを削除した場合、当社は当該お客様の個人情報および関連データを削除します。</p>
                    <p>2. アカウント削除後、同一のメールアドレスによる再登録は6ヶ月間制限されます。この制限は、ウェルカムボーナスポイントの濫用防止およびサービスの健全な運営を目的とします。</p>
                    <p>3. 再登録制限期間中に同一メールアドレスで登録を試行した場合、当社は登録を拒否することができます。</p>
                    <p>4. 6ヶ月経過後、同一メールアドレスによる再登録が可能となります。</p>
                    <p>5. 当社は、システムの記録により削除されたアカウントの履歴を追跡し、不正な再登録を防止するための措置を講じることができます。</p>
                    
                    <h6>第11条（規約の変更）</h6>
                    <p>当社は、必要と判断した場合には、お客様に通知することなく本規約を変更することができます。変更後の規約は、本サービス上に表示した時点から効力を生じるものとします。</p>
                    
                    <h6>第12条（準拠法・裁判管轄）</h6>
                    <p>本規約の解釈にあたっては、日本法を準拠法とします。本サービスに関して紛争が生じた場合には、東京地方裁判所を専属的合意管轄とします。</p>
                    
                    <p class="mt-4"><small>制定日：2025年9月</small></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary japanese-text" data-bs-dismiss="modal">閉じる</button>
                </div>
            </div>
        </div>
    </div>

    <!-- プライバシーポリシー Modal -->
    <div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title japanese-heading" id="privacyModalLabel">プライバシーポリシー</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body japanese-text">
                    <h6>1. 個人情報の収集について</h6>
                    <p>当社は、お客様から以下の個人情報を収集する場合があります。</p>
                    <ul>
                        <li>氏名、住所、電話番号、メールアドレス</li>
                        <li>クレジットカード情報等の決済に関する情報</li>
                        <li>商品の購入履歴、閲覧履歴</li>
                        <li>お問い合わせ内容</li>
                        <li>その他、サービス提供に必要な情報</li>
                    </ul>
                    
                    <h6>2. 個人情報の利用目的</h6>
                    <p>当社は、収集した個人情報を以下の目的で利用します。</p>
                    <ul>
                        <li>商品の販売、配送、代金決済</li>
                        <li>お客様からのお問い合わせへの対応</li>
                        <li>新商品やキャンペーン等の情報提供</li>
                        <li>商品やサービスの改善・開発</li>
                        <li>利用規約違反の調査</li>
                        <li>その他、上記に付随する目的</li>
                    </ul>
                    
                    <h6>3. 個人情報の第三者提供</h6>
                    <p>当社は、以下の場合を除き、お客様の同意なく個人情報を第三者に提供することはありません。</p>
                    <ul>
                        <li>法令に基づく場合</li>
                        <li>人の生命、身体または財産の保護のために必要がある場合</li>
                        <li>公衆衛生の向上または児童の健全な育成の推進のために特に必要がある場合</li>
                        <li>国の機関もしくは地方公共団体またはその委託を受けた者が法令の定める事務を遂行することに対して協力する必要がある場合</li>
                    </ul>
                    
                    <h6>4. 個人情報の委託</h6>
                    <p>当社は、個人情報の取扱いの全部または一部を第三者に委託する場合があります。この場合、委託先に対して適切な監督を行います。</p>
                    
                    <h6>5. 個人情報の保存期間</h6>
                    <p>当社は、個人情報を利用目的の達成に必要な期間のみ保存し、不要になった個人情報は適切に廃棄します。</p>
                    
                    <h6>6. 個人情報の開示・訂正・削除</h6>
                    <p>お客様は、当社が保有する個人情報について、開示、訂正、削除を求めることができます。ご希望の場合は、当社までお問い合わせください。</p>
                    
                    <h6>7. Cookie（クッキー）について</h6>
                    <p>当社のウェブサイトでは、より良いサービス提供のためにCookieを使用する場合があります。Cookieの使用を希望されない場合は、ブラウザの設定で無効にすることができます。</p>
                    
                    <h6>8. SSL（暗号化通信）について</h6>
                    <p>当社では、お客様の個人情報を安全に送信するため、SSL（Secure Socket Layer）による暗号化通信を採用しています。</p>
                    
                    <h6>9. アクセス解析ツールについて</h6>
                    <p>当社のウェブサイトでは、Googleアナリティクス等のアクセス解析ツールを使用する場合があります。これらのツールはCookieを使用してお客様の行動データを収集しますが、個人を特定する情報は含まれません。</p>
                    
                    <h6>10. お問い合わせ窓口</h6>
                    <p>個人情報の取扱いに関するお問い合わせは、以下までご連絡ください。</p>
                    <p>
                        株式会社Aether<br>
                        〒169-0072 東京都新宿区大久保2丁目21-10 ジュネス大久保 102号<br>
                        メール：aether7info@gmail.com
                    </p>
                    
                    <h6>11. プライバシーポリシーの変更</h6>
                    <p>当社は、必要に応じて本プライバシーポリシーを変更することがあります。変更後のプライバシーポリシーは、当社ウェブサイトに掲載した時点から効力を生じるものとします。</p>
                    
                    <p class="mt-4"><small>制定日：2025年9月</small></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary japanese-text" data-bs-dismiss="modal">閉じる</button>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/js/jquery-1.11.0.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/templatemo.js"></script>
    <script src="assets/js/custom.js"></script>
    
    <!-- Firebase SDK -->
    <!-- Firebase SDK - 중복 로드 방지 -->
    <script>
        if (typeof firebase === 'undefined') {
            // Firebase가 로드되지 않은 경우에만 로드
            document.write('<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"><\/script>');
            document.write('<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"><\/script>');
            document.write('<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"><\/script>');
        }
    </script>
    <script src="assets/js/firebase-config-v3.js?v=1759597551"></script>
    <script src="assets/js/auth-utils-v3.js?v=1759597551"></script>

    <!-- Checkout Management Script -->
    <script>
        // 전역 변수
        let currentUserPoints = 0;
        let pointsToUse = 0;
        let maxUsablePoints = 0;
        let currentUser = null;
        
        // Firebase 초기화 대기 함수
        async function waitForFirebaseInit() {
            let attempts = 0;
            const maxAttempts = 50; // 5초 대기
            
            while (attempts < maxAttempts) {
                if (typeof firebase !== 'undefined' && 
                    firebase.auth && 
                    firebase.firestore && 
                    firebase.apps && 
                    firebase.apps.length > 0) {
                    console.log('✅ Firebase 초기화 완료 확인');
                    return true;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            console.warn('⚠️ Firebase 초기화 시간 초과');
            return false;
        }
        
        // 페이지 로드 시 초기화
        // Stripe 초기화
        let stripe = null;
        let cardElement = null;
        
        // Stripe 공개 키 (라이브 모드)
        const STRIPE_PUBLISHABLE_KEY = 'pk_live_51SD63wC16n05emqhEPI9nOj7Rv2YUhNknbtTpwNZLmOv6dEfvEm9p0B0BBZnRR5wDn7IDaU3FVMJTRCV4uRcPKG100fCaDsIiv';
        
        document.addEventListener('DOMContentLoaded', async function() {
            // 모바일 감지
            const isMobile = window.innerWidth <= 768;
            console.log('🚀 체크아웃 페이지 초기화 시작');
            console.log('📱 모바일 여부:', isMobile);
            console.log('📱 화면 크기:', window.innerWidth + 'x' + window.innerHeight);
            
            // Stripe 초기화
            initializeStripe();
            
            // Firebase 전용 초기화
            console.log('🔄 Firebase 전용 체크아웃 초기화 시작');
            
            try {
                // 1단계: Firebase 초기화 대기 (가장 먼저)
                console.log('1️⃣ Firebase 초기화 대기 시작');
                const firebaseReady = await waitForFirebaseInit();
                
                if (!firebaseReady) {
                    console.log('❌ Firebase 초기화 실패 - 페이지 새로고침 필요');
                    alert('Firebase 초기화에 실패했습니다. 페이지를 새로고침해주세요.');
                    return;
                }
                
                // 2단계: Firebase Auth 완전 로드 대기 후 사용자 정보 확인
                console.log('2️⃣ Firebase Auth 사용자 확인 시작');
                let user = null;
                await new Promise((resolve) => {
                    const unsubscribe = firebase.auth().onAuthStateChanged((authUser) => {
                        unsubscribe(); // 한 번만 실행되도록 구독 해제
                        user = authUser;
                        resolve(authUser);
                    });
                });
                
                if (!user) {
                    console.log('❌ 로그인되지 않음 - 로그인 페이지로 이동');
                    window.location.href = 'login.html?redirect=checkout.html';
                    return;
                }
                
                console.log('✅ 로그인된 사용자 확인:', user.email);
                currentUser = user;

                // 3단계: Firebase에서 카트 로드
                console.log('3️⃣ Firebase에서 카트 로드 시작');
                currentCart = await loadCartFromFirebase();
                console.log('✅ Firebase 카트 로드 완료:', currentCart.length, '개 상품');
                
                if (!currentCart || currentCart.length === 0) {
                    console.log('⚠️ 카트가 비어있습니다. cart.html로 리디렉션합니다.');
                    console.log('🔍 디버깅 정보:');
                    console.log('- currentCart:', currentCart);
                    console.log('- currentCart.length:', currentCart ? currentCart.length : 'undefined');
                    console.log('- currentUser:', currentUser ? currentUser.email : 'undefined');
                    window.location.href = 'cart.html';
                    return;
                }

                // 4단계: 기본 UI 업데이트
                console.log('4️⃣ 기본 UI 업데이트 시작');
                updateUserMenu();
                updateCartCount();

                // 5단계: 카트 상품 렌더링
                console.log('5️⃣ 카트 상품 렌더링 시작');
                renderOrderItems();

                // 6단계: 사용자 정보 및 포인트 로드
                console.log('6️⃣ 사용자 정보 및 포인트 로드 시작');
                
                try {
                    // 사용자 정보 설정 (포인트 페이지와 동일)
                    const checkoutPageUser = {
                        uid: currentUser.uid,
                        email: currentUser.email,
                        name: currentUser.displayName || currentUser.email.split('@')[0],
                        points: 0
                    };
                    
                    console.log('✅ 체크아웃 페이지 사용자 설정:', checkoutPageUser);
                    
                    console.log('🏠 배송정보 로드 시작');
                            await loadProfileAddress();
                    console.log('🏠 배송정보 로드 완료');
                    
                    // 모바일에서 정보 로드 실패 시 재시도
                    if (isMobile) {
                        console.log('📱 모바일에서 배송정보 재시도 (1초 후)');
                        setTimeout(async () => {
                            await loadProfileAddress();
                            console.log('📱 모바일 배송정보 재시도 완료');
                        }, 1000);
                    }
                    
                    // 포인트 정보 로드 (포인트 페이지와 동일한 방식)
                    await loadPointsLikePointsPageWithUser(checkoutPageUser);
                    
                } catch (error) {
                    console.error('❌ 사용자 정보 로드 오류:', error);
                }

                // 7단계: 기타 UI 설정
                console.log('7️⃣ 기타 UI 설정');
                
                // 페이지 로드 완료 후 포인트 섹션 확실히 표시
                setTimeout(() => {
                    console.log('🔧 페이지 로드 후 포인트 섹션 강제 표시');
                    if (typeof currentUserPoints === 'undefined') {
                        currentUserPoints = 0;
                    }
                    showPointSection();
                }, 500);
                
                // 카드 번호 입력 필드 이벤트 리스너
                const cardNumberInput = document.getElementById('card-number');
                if (cardNumberInput) {
                    cardNumberInput.addEventListener('input', function(e) {
                        this.value = formatCardNumber(this.value);
                    });
                }

                // 주문 폼 제출 이벤트 처리
                const orderForm = document.getElementById('shipping-form');
                if (orderForm) {
                    orderForm.addEventListener('submit', processOrder);
                }
                
                console.log('🎉 체크아웃 페이지 초기화 완료!');
                
                // 최종 보장: 모든 초기화 완료 후 포인트 섹션 표시
                setTimeout(() => {
                    console.log('🛡️ 최종 포인트 섹션 보장 표시');
                    
                    // Firebase 전용 시스템 디버깅
                    console.log('=== Firebase 전용 포인트 시스템 ===');
                    console.log('currentUserPoints:', currentUserPoints);
                    console.log('Firebase 사용자:', firebase.auth().currentUser?.email || '없음');
                    
                    const pointSection = document.getElementById('point-use-section');
                    if (pointSection) {
                        pointSection.style.display = 'block';
                        console.log('✅ 포인트 섹션 최종 확인 완료');
                        
                        // 포인트 재로드 시도 (사용자 객체와 함께)
                        const user = firebase.auth().currentUser;
                        if (user) {
                            const checkoutPageUser = {
                                uid: user.uid,
                                email: user.email,
                                name: user.displayName || user.email.split('@')[0],
                                points: 0
                            };
                            loadPointsLikePointsPageWithUser(checkoutPageUser);
                        }
                        
                        // 추가 시도 (2초 후)
                        setTimeout(() => {
                            console.log('🔄 포인트 추가 로딩 시도 (포인트 페이지 방식)');
                            const user = firebase.auth().currentUser;
                            if (user) {
                                const checkoutPageUser = {
                                    uid: user.uid,
                                    email: user.email,
                                    name: user.displayName || user.email.split('@')[0],
                                    points: 0
                                };
                                loadPointsLikePointsPageWithUser(checkoutPageUser);
                            }
                        }, 2000);
                        
                        // 최종 시도 (5초 후)
                        setTimeout(() => {
                            console.log('🔄 포인트 최종 로딩 시도 (포인트 페이지 방식)');
                            const user = firebase.auth().currentUser;
                            if (user) {
                                const checkoutPageUser = {
                                    uid: user.uid,
                                    email: user.email,
                                    name: user.displayName || user.email.split('@')[0],
                                    points: 0
                                };
                                loadPointsLikePointsPageWithUser(checkoutPageUser);
                            }
                        }, 5000);
                    }
                }, 1000);

                // 유효기한 입력 필드 이벤트 리스너
                const cardExpiryInput = document.getElementById('card-expiry');
                if (cardExpiryInput) {
                    cardExpiryInput.addEventListener('input', function(e) {
                        this.value = formatExpiry(this.value);
                    });
                }

                // CVV 숫자만 입력 및 마스킹 처리
                const cardCvvInput = document.getElementById('card-cvv');
                if (cardCvvInput) {
                    // 첫 번째 클릭 시 별표 지우기
                    cardCvvInput.addEventListener('focus', function(e) {
                        if (this.value.includes('*')) {
                            console.log('CVC 필드 포커스: 별표 지움');
                            this.value = '';
                        }
                    });
                    
                    // 입력 시 숫자만 허용
                    cardCvvInput.addEventListener('input', function(e) {
                        let value = this.value.replace(/\D/g, '');
                        
                        // 최대 4자리로 제한
                        if (value.length > 4) {
                            value = value.substring(0, 4);
                        }
                        
                        this.value = value;
                        
                        // 원본 값 저장 (사용자가 입력한 경우)
                        if (value && !this.dataset.originalCvc) {
                            this.dataset.originalCvc = value;
                        }
                    });
                    
                    // 포커스 아웃 시 별표로 마스킹
                    cardCvvInput.addEventListener('blur', function(e) {
                        if (this.value && this.value.length >= 3) {
                            const originalValue = this.value;
                            this.dataset.originalCvc = originalValue;
                            
                            // 1초 후 별표로 변경
                            setTimeout(() => {
                                if (this.value === originalValue) {
                                    this.value = '*'.repeat(originalValue.length);
                                    console.log('CVC 별표 마스킹 적용');
                                }
                            }, 1000);
                        }
                    });
                }

                // 결제 방법 선택
                const paymentMethods = document.querySelectorAll('.payment-method');
                paymentMethods.forEach(method => {
                    method.addEventListener('click', function() {
                        selectPaymentMethod(this.dataset.method);
                    });
                });

                // 주문 확정 버튼
                const orderButton = document.getElementById('place-order-btn');
                if (orderButton) {
                    orderButton.addEventListener('click', async function(e) {
                        e.preventDefault(); // 기본 이벤트 방지
                        
                        // 이미 처리 중인 경우 중복 클릭 방지
                        if (this.disabled) {
                            return;
                        }
                        
                        try {
                            // 버튼 비활성화 및 로딩 상태 표시
                            this.disabled = true;
                            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>処理中...';
                            
                            await processOrder();
                            
                        } catch (error) {
                            console.error('주문 처리 중 오류:', error);
                            
                            // 사용자에게 오류가 표시되지 않은 경우에만 일반 오류 메시지 표시
                            if (!error.message || error.message.includes('Error')) {
                                showAlert('payment-alert', '注文処理中にエラーが発生しました。入力内容を確認してください。', 'danger');
                            }
                            
                        } finally {
                            // 버튼 상태 복구 (성공/실패 관계없이)
                            this.disabled = false;
                            this.innerHTML = '<i class="fas fa-lock me-2"></i>注文を確定する';
                        }
                    });
                }
                
                // Bootstrap 툴팁 초기화
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });

                // 우편번호 입력 필드 자동 포맷팅 및 자동 검색
                const postalInput = document.getElementById('shipping-postal');
                if (postalInput) {
                    postalInput.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/[^\d]/g, '');
                        if (value.length > 3) {
                            value = value.slice(0, 3) + '-' + value.slice(3);
                        }
                        e.target.value = value;
                        
                        // 7자리가 되면 자동으로 주소 검색
                        const cleanValue = value.replace(/[^\d]/g, '');
                        if (cleanValue.length === 7) {
                            setTimeout(() => searchAddress(), 500); // 약간의 딜레이 후 검색
                        }
                    });

                    // Enter 키로 검색 실행
                    postalInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            searchAddress();
                        }
                    });
                }
                
                // 6단계: Firebase 전용 로그인 상태 확인 완료
                console.log('6️⃣ Firebase 전용 로그인 상태 확인 완료');

            } catch (error) {
                console.error('체크아웃 페이지 초기화 실패:', error);
                showAlert('payment-alert', 'ページの読み込みに失敗しました。', 'danger');
            }
        });

        // 알림 표시 함수 - 모노톤 색상 사용
        function showAlert(elementId, message, type = 'info') {
            const alertElement = document.getElementById(elementId);
            if (alertElement) {
                // 모든 알림을 모노톤 색상으로 통일
                let alertClass = 'alert japanese-text';
                if (type === 'danger' || type === 'error') {
                    alertClass += ' alert-warning border border-secondary'; // 경고용으로 회색 테두리 사용
                } else {
                    alertClass += ' alert-light border border-secondary'; // 일반 정보용
                }
                
                alertElement.className = alertClass;
                alertElement.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i>${message}`;
            alertElement.classList.remove('d-none');
            
                // 5초 후 알림 숨기기 (에러의 경우 더 오래 표시)
                const hideDelay = (type === 'danger' || type === 'error') ? 5000 : 3000;
            setTimeout(() => {
                alertElement.classList.add('d-none');
                }, hideDelay);
            } else {
                console.error('알림 요소를 찾을 수 없음:', elementId);
            }
        }

        // 에러 표시 함수
        function showError(message) {
            showAlert('payment-alert', message, 'danger');
        }

        // 로딩 상태 표시
        function showLoading(show) {
            const loadingEl = document.getElementById('loading');
            const mainContent = document.getElementById('main-content');
            
            if (show) {
                if (loadingEl) loadingEl.style.display = 'block';
                if (mainContent) mainContent.style.display = 'none';
            } else {
                if (loadingEl) loadingEl.style.display = 'none';
                if (mainContent) mainContent.style.display = 'block';
            }
        }

        // 메인 콘텐츠 표시
        function showMainContent() {
            const mainContent = document.getElementById('main-content');
            const loadingEl = document.getElementById('loading');
            
            if (loadingEl) loadingEl.style.display = 'none';
            if (mainContent) mainContent.style.display = 'block';
        }

        // 카트 아이템 로드
        async function loadCartItems() {
            console.log('loadCartItems 함수 호출됨');
            
            // Firebase 카트 동기화 (로그인된 사용자인 경우)
            if (firebase?.auth?.currentUser && window.CartSyncService) {
                try {
                    console.log('🛒 checkout.html Firebase 카트 동기화 시작');
                    const syncedCart = await window.CartSyncService.syncCart(firebase.auth.currentUser.email);
                    console.log('✅ checkout.html 카트 동기화 완료:', syncedCart.length, '개 상품');
                } catch (error) {
                    console.warn('checkout.html 카트 동기화 실패:', error);
                }
            }
            
            const cart = getCart();
            console.log('로드된 카트 데이터:', cart);
            
            if (!cart || cart.length === 0) {
                console.log('⚠️ 카트가 비어있습니다. cart.html로 리디렉션합니다.');
                window.location.href = 'cart.html';
                return;
            }
            
            // 카트 아이템 렌더링
            renderOrderItems();
        }

        // Firebase 전용 카트 관리
        let currentCart = [];
        // currentUser는 이미 위에서 선언됨
        
        // Firebase에서 카트 로드
        async function loadCartFromFirebase() {
            console.log('🔍 loadCartFromFirebase 함수 시작');
            console.log('🔍 Firebase 상태 체크:');
            console.log('- firebase 객체:', typeof firebase !== 'undefined' ? '존재' : '없음');
            console.log('- firebase.firestore:', firebase?.firestore ? '존재' : '없음');
            console.log('- currentUser:', currentUser ? `${currentUser.email} (${currentUser.uid})` : '없음');
            
            if (!firebase?.firestore) {
                console.warn('⚠️ Firebase 카트 로드 불가 - Firebase 없음');
                return [];
            }
            
            if (!currentUser) {
                console.warn('⚠️ Firebase 카트 로드 불가 - 사용자 없음');
                return [];
            }
            
            try {
                console.log('🛒 Firebase 카트 로드 시작:', currentUser.email);
                const db = firebase.firestore();
                const cartDoc = await db.collection('userCarts').doc(currentUser.email).get();
                
                console.log('🔍 Firebase 카트 문서 조회 결과:');
                console.log('- cartDoc.exists:', cartDoc.exists);
                console.log('- cartDoc.id:', cartDoc.id);
                
                if (cartDoc.exists) {
                    const cartData = cartDoc.data();
                    const firebaseCart = cartData.cart || [];
                    console.log('✅ Firebase 카트 로드 완료:', firebaseCart.length, '개 상품');
                    console.log('🔍 카트 데이터:', firebaseCart);
                    return firebaseCart;
                } else {
                    console.log('📭 Firebase에 카트 문서 없음 - 빈 카트 반환');
                    return [];
                }
            } catch (error) {
                console.error('❌ Firebase 카트 로드 실패:', error);
                console.error('❌ 오류 상세:', error.message);
                return [];
            }
        }
        
        // Firebase에 카트 저장
        async function saveCartToFirebase(cart) {
            if (!currentUser || !firebase?.firestore) {
                console.warn('⚠️ Firebase 카트 저장 불가 - 사용자 또는 Firebase 없음');
                return false;
            }
            
            try {
                console.log('💾 Firebase 카트 저장 시작:', cart.length, '개 상품');
                const db = firebase.firestore();
                await db.collection('userCarts').doc(currentUser.email).set({
                    cart: cart,
                    lastUpdated: new Date(),
                    userEmail: currentUser.email
                });
                console.log('✅ Firebase 카트 저장 완료:', cart.length, '개 상품');
                return true;
            } catch (error) {
                console.error('❌ Firebase 카트 저장 실패:', error);
                return false;
            }
        }
        
        function getCart() {
            console.log('🛒 getCart 호출 - Firebase 카트 반환:', currentCart.length, '개 상품');
            return currentCart;
        }

        async function clearCart() {
            console.log('🗑️ Firebase 카트 초기화 시작');
            currentCart = [];
            await saveCartToFirebase(currentCart);
            console.log('✅ Firebase 카트 초기화 완료');
        }

        // 수량 업데이트 함수 (Firebase 전용)
        async function updateQuantity(index, change) {
            if (index < 0 || index >= currentCart.length) return;
            
            const newQuantity = (currentCart[index].quantity || 1) + change;
            
            if (newQuantity <= 0) {
                // 수량이 0 이하가 되면 상품 제거
                await removeItem(index);
                return;
            }
            
            if (newQuantity > 99) {
                // 최대 수량 제한
                alert('最大99個まで注文可能です。');
                return;
            }
            
            currentCart[index].quantity = newQuantity;
            console.log('수량 업데이트:', currentCart[index].name, '→', newQuantity);
            
            // Firebase에 저장
            await saveCartToFirebase(currentCart);
            
            // UI 업데이트
            renderOrderItems();
            updateCartCount();
        }

        // 상품 제거 함수 (Firebase 전용)
        async function removeItem(index) {
            if (index < 0 || index >= currentCart.length) return;
            
            const removedItem = currentCart[index];
            if (confirm(`${removedItem.name}を注文から削除しますか？`)) {
                currentCart.splice(index, 1);
                console.log('상품 제거:', removedItem.name);
                
                // Firebase에 저장
                await saveCartToFirebase(currentCart);
                
                // UI 업데이트
                renderOrderItems();
                updateCartCount();
                
                // 카트가 비어있으면 홈페이지로 이동
                if (currentCart.length === 0) {
                    alert('カートが空です。商品を追加してください。');
                    window.location.href = 'index.html';
                }
            }
        }

        // 전역 함수로 노출
        window.updateQuantity = updateQuantity;
        window.removeItem = removeItem;

        // getCurrentUser는 auth-utils.js에서 제공됩니다

        // 주문 내용 렌더링
        function renderOrderItems() {
            const cart = getCart();
            const container = document.getElementById('order-items');
            
            console.log('renderOrderItems 호출됨');
            console.log('카트 데이터:', cart);
            console.log('컨테이너 요소:', container);
            
            if (!container) {
                console.error('order-items 컨테이너를 찾을 수 없습니다');
                return;
            }
            
            if (cart.length === 0) {
                console.log('⚠️ renderOrderItems: 카트가 비어있음');
                
                // 모달이 표시된 상태가 아닐 때만 리디렉션
                const bankTransferModal = document.getElementById('bankTransferCompleteModal');
                const isModalVisible = bankTransferModal && bankTransferModal.classList.contains('show');
                
                if (!isModalVisible) {
                    console.log('⚠️ 모달이 표시되지 않음 - index.html로 리디렉션');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 100);
                } else {
                    console.log('✅ 모달이 표시됨 - 리디렉션 건너뜀');
                }
                return;
            }

            const itemsHtml = cart.map((item, index) => {
                // 옵션 정보 표시
                let optionInfo = '';
                if (item.isOptionProduct && item.selectedColors && item.selectedColors.length > 0) {
                    // 새로운 옵션 시스템
                    optionInfo = '<div class="option-info mt-1">' +
                        '<small class="text-muted japanese-text">' + 
                        item.selectedColors.map(option => `${option.type}: ${option.name} x${option.quantity}`).join(', ') +
                        '</small>' +
                        '</div>';
                } else if (item.colorSummary && item.colorSummary.trim() !== '') {
                    // 기존 색상 옵션 시스템
                    optionInfo = '<div class="option-info mt-1">' +
                        '<small class="text-muted japanese-text">' + item.colorSummary + '</small>' +
                        '</div>';
                }
                
                return '<div class="order-item">' +
                    '<div class="order-item-info">' +
                    '<div class="japanese-heading">' + (item.name || '상품명 없음') + '</div>' +
                    '<small class="text-muted japanese-text">' + (item.brand || '브랜드 없음') + '</small>' +
                    optionInfo +
                    '</div>' +
                    '<div class="order-item-controls">' +
                    '<div class="order-item-price japanese-text fw-bold">¥' + ((item.price || 0) * (item.quantity || 1)).toLocaleString() + '</div>' +
                    '<div class="order-item-actions">' +
                    '<div class="quantity-controls d-flex align-items-center gap-1">' +
                    '<button type="button" class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(' + index + ', -1)">' +
                    '<i class="fas fa-minus"></i>' +
                    '</button>' +
                    '<span class="quantity-display fw-bold mx-1">' + (item.quantity || 1) + '</span>' +
                    '<button type="button" class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(' + index + ', 1)">' +
                    '<i class="fas fa-plus"></i>' +
                    '</button>' +
                    '<button type="button" class="btn-delete-item ms-1" onclick="removeItem(' + index + ')" title="削除">' +
                    '<i class="fas fa-trash"></i>' +
                    '</button>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>';
            }).join('');
            
            console.log('생성된 HTML:', itemsHtml);
            container.innerHTML = itemsHtml;

            updateOrderSummary();
        }

        // 주문 요약 업데이트 (포인트 할인 포함)
        function updateOrderSummary() {
            const cart = getCart();
            console.log('updateOrderSummary 호출됨, 카트:', cart);
            
            // 상품 가격은 이미 소비세 포함 가격
            const totalWithTax = cart.reduce((total, item) => total + ((item.price || 0) * (item.quantity || 1)), 0);
            const subtotal = Math.floor(totalWithTax / 1.1); // 세전 가격
            const tax = totalWithTax - subtotal; // 소비세
            const shippingFee = totalWithTax >= 3000 ? 0 : 500; // 3000엔 이상 무료배송
            
            // 포인트 할인 적용
            const pointDiscount = pointsToUse || 0;
            const finalTotal = Math.max(0, totalWithTax + shippingFee - pointDiscount);

            console.log('계산된 금액 - 소계:', subtotal, '배송비:', shippingFee, '세금:', tax, '포인트할인:', pointDiscount, '총액:', finalTotal);
            
            // 포인트 정보 업데이트 (사용자가 로그인한 경우)
            if (currentUserPoints > 0) {
                updateMaxUsablePoints();
            }

            const subtotalEl = document.getElementById('subtotal');
            const shippingEl = document.getElementById('shipping-fee');
            const taxEl = document.getElementById('tax');
            const totalEl = document.getElementById('total');
            
            if (subtotalEl) subtotalEl.textContent = '¥' + subtotal.toLocaleString();
            if (shippingEl) shippingEl.textContent = shippingFee === 0 ? '無料' : '¥' + shippingFee.toLocaleString();
            if (taxEl) taxEl.textContent = '¥' + tax.toLocaleString();
            if (totalEl) totalEl.textContent = '¥' + finalTotal.toLocaleString();
        }

        // 우편번호 검색 기능
        async function searchAddress() {
            const postalInput = document.getElementById('shipping-postal');
            const feedback = document.getElementById('postal-feedback');
            const postalCode = postalInput.value.replace(/[^\d]/g, '');
            
            if (postalCode.length !== 7) {
                feedback.innerHTML = '<span class="text-danger">7桁の郵便番号を入力してください</span>';
                return;
            }
            
            // 로딩 표시
            feedback.innerHTML = '<div class="spinner-border spinner-border-sm text-secondary" role="status"><span class="visually-hidden">Loading...</span></div> <span class="text-muted">住所を検索中...</span>';
            
            try {
                const response = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${postalCode}`);
                const data = await response.json();
                
                if (data.status === 200 && data.results && data.results.length > 0) {
                    const result = data.results[0];
                    
                    // 주소 자동 입력
                    document.getElementById('shipping-prefecture').value = result.address1;
                    document.getElementById('shipping-city').value = result.address2;
                    document.getElementById('shipping-address1').value = result.address3;
                    
                    // 피드백 메시지 숨김
                    feedback.innerHTML = '';
                    
                    // 주소1로 포커스 이동
                    document.getElementById('shipping-address1').focus();
                } else {
                    feedback.innerHTML = '<span class="text-danger">該当する郵便番号의住所が見つかりませんでした</span>';
                }
            } catch (error) {
                console.error('우편번호 검색 실패:', error);
                feedback.innerHTML = '<span class="text-danger">住所の検索中にエラーが発生しました</span>';
            }
        }



        // 우편번호 포맷팅 (000-0000 형태)
        function formatPostalCode(value) {
            const cleaned = value.replace(/\D/g, '');
            if (cleaned.length >= 4) {
                return cleaned.substring(0, 3) + '-' + cleaned.substring(3, 7);
            }
            return cleaned;
        }

        // 프로필 주소 로드 (Firebase 전용)
        async function loadProfileAddress() {
            try {
                // 모바일 감지
                const isMobile = window.innerWidth <= 768;
                console.log('=== Firebase 주소 자동 입력 시작 ===');
                console.log('📱 모바일 여부:', isMobile);
                console.log('📱 화면 크기:', window.innerWidth + 'x' + window.innerHeight);
                
                // currentUser 확인 (체크아웃 페이지 초기화에서 설정됨)
                if (!currentUser) {
                    console.log('❌ currentUser가 설정되지 않음');
                    showAlert('shipping-alert', 'ユーザー情報を読み込み中です...', 'info');
                    return;
                }
                
                console.log('✅ Firebase 사용자 확인:', currentUser.email);
                
                // Firebase에서 사용자 문서 조회 (이메일 기반)
                const db = firebase.firestore();
                const userDoc = await db.collection('users').doc(currentUser.email).get();
                
                if (!userDoc.exists) {
                    console.log('❌ Firebase에 사용자 문서가 없음');
                    showAlert('shipping-alert', 'ユーザー情報が見つかりません。', 'warning');
                    return;
                }
                
                const userData = userDoc.data();
                console.log('✅ Firebase 사용자 데이터 로드 완료:', userData);
                
                // Firebase 사용자 데이터 구조 상세 분석
                console.log('🔍 Firebase 사용자 데이터 구조 분석:');
                console.log('- userData 키들:', Object.keys(userData));
                console.log('- userData.shippingAddress:', userData.shippingAddress);
                console.log('- userData.lastUsedAddress:', userData.lastUsedAddress);
                console.log('- userData.address:', userData.address);
                console.log('- userData.name:', userData.name);
                console.log('- userData.phone:', userData.phone);
                
                // 배송 주소 정보 확인 (여러 필드명 지원 - 우선순위 순)
                const addressData = userData.shippingAddress || 
                                   userData.lastUsedAddress || 
                                   userData.address || 
                                   userData;
                
                console.log('✅ 배송 주소 데이터:', addressData);
                console.log('🔍 배송 주소 데이터 구조 분석:');
                console.log('- addressData 키들:', Object.keys(addressData));
                console.log('- addressData.phone:', addressData.phone);
                console.log('- addressData.postal:', addressData.postal);
                console.log('- addressData.prefecture:', addressData.prefecture);
                console.log('- addressData.city:', addressData.city);
                console.log('- addressData.address1:', addressData.address1);
                console.log('- addressData.address2:', addressData.address2);
                
                // 배송 정보 필드 자동 입력 (다양한 필드명 및 중첩 구조 지원)
                    const fields = {
                    'shipping-name': userData.name || userData.displayName || userData.fullName || currentUser.email.split('@')[0],
                    'shipping-phone': addressData.phone || addressData.phoneNumber || userData.phone || userData.phoneNumber || '',
                    'shipping-postal': addressData.postal || addressData.postalCode || addressData.zip || addressData.zipCode || '',
                    'shipping-prefecture': addressData.prefecture || addressData.state || addressData.province || addressData.region || '',
                    'shipping-city': addressData.city || addressData.municipality || '',
                    'shipping-address1': addressData.address1 || addressData.address || addressData.street || addressData.streetAddress || '',
                    'shipping-address2': addressData.address2 || addressData.addressDetail || addressData.detail || addressData.extraAddress || ''
                };
                
                console.log('🔍 배송 정보 필드 매핑 전 분석:');
                console.log('- userData.name:', userData.name);
                console.log('- userData.phone:', userData.phone);
                console.log('- addressData.postal:', addressData.postal);
                console.log('- addressData.postalCode:', addressData.postalCode);
                console.log('- addressData.prefecture:', addressData.prefecture);
                console.log('- addressData.city:', addressData.city);
                console.log('- addressData.address1:', addressData.address1);
                
                // 중첩된 address 객체가 있는 경우 추가로 확인
                if (userData.address && typeof userData.address === 'object') {
                    console.log('🔍 중첩된 address 객체 발견:', userData.address);
                    const nestedAddress = userData.address;
                    
                    // 중첩된 address에서 정보가 없으면 여기서 가져오기
                    if (!fields['shipping-phone'] && nestedAddress.phone) {
                        fields['shipping-phone'] = nestedAddress.phone;
                        console.log('📞 중첩된 address에서 전화번호 가져옴:', nestedAddress.phone);
                    }
                    if (!fields['shipping-postal'] && nestedAddress.postal) {
                        fields['shipping-postal'] = nestedAddress.postal;
                        console.log('📮 중첩된 address에서 우편번호 가져옴 (postal):', nestedAddress.postal);
                    }
                    if (!fields['shipping-postal'] && nestedAddress.postalCode) {
                        fields['shipping-postal'] = nestedAddress.postalCode;
                        console.log('📮 중첩된 address에서 우편번호 가져옴 (postalCode):', nestedAddress.postalCode);
                    }
                    if (!fields['shipping-prefecture'] && nestedAddress.prefecture) {
                        fields['shipping-prefecture'] = nestedAddress.prefecture;
                        console.log('🏛️ 중첩된 address에서 도도부현 가져옴:', nestedAddress.prefecture);
                    }
                    if (!fields['shipping-city'] && nestedAddress.city) {
                        fields['shipping-city'] = nestedAddress.city;
                        console.log('🏙️ 중첩된 address에서 시 가져옴:', nestedAddress.city);
                    }
                    if (!fields['shipping-address1'] && nestedAddress.address1) {
                        fields['shipping-address1'] = nestedAddress.address1;
                        console.log('🏠 중첩된 address에서 주소1 가져옴:', nestedAddress.address1);
                    }
                    if (!fields['shipping-address2'] && nestedAddress.address2) {
                        fields['shipping-address2'] = nestedAddress.address2;
                        console.log('🏠 중첩된 address에서 주소2 가져옴:', nestedAddress.address2);
                    }
                }
                
                console.log('🔧 배송 정보 필드 매핑:', fields);
                
                // 배송 정보 필드 자동 입력 (저장된 정보 우선 사용)
                let filledCount = 0;
                let updatedCount = 0;
                
                    Object.entries(fields).forEach(([fieldId, value]) => {
                        const field = document.getElementById(fieldId);
                    if (field && value) {
                        // 저장된 정보가 있으면 항상 업데이트 (기존 값이 있어도 덮어쓰기)
                            field.value = value;
                        filledCount++;
                        updatedCount++;
                        console.log(`✅ ${fieldId} 자동 입력/업데이트:`, value);
                        console.log(`📱 ${fieldId} DOM 요소 확인:`, field);
                    } else if (field && !value) {
                        console.log(`⚠️ ${fieldId} - 저장된 정보 없음`);
                        console.log(`📱 ${fieldId} DOM 요소 확인:`, field);
                    } else if (!field) {
                        console.log(`❌ ${fieldId} - DOM 요소를 찾을 수 없음`);
                        console.log(`📱 ${fieldId} 전체 DOM 검색:`, document.querySelectorAll(`#${fieldId}`));
                    }
                });
                    
                    // 카드 정보도 로드 (다양한 필드명 지원)
                if (userData.savedCardInfo || userData.cardInfo || userData.paymentInfo) {
                    await loadSavedCardInfo(userData);
                } else {
                    console.log('📝 저장된 카드 정보가 없음 - 수동 입력 필요');
                }
                    
                if (filledCount > 0) {
                    console.log(`✅ ${filledCount}개 배송정보 필드 자동 입력/업데이트 완료`);
                } else {
                    console.log('📝 저장된 배송정보가 없음 - 수동 입력 필요');
                }
                
            } catch (error) {
                console.error('❌ Firebase 주소 자동 입력 오류:', error);
                console.error('❌ 오류 상세:', error.message);
                showAlert('shipping-alert', '住所情報の読み込みに失敗しました。', 'danger');
            }
        }
        
        // 저장된 카드 정보 로드
        async function loadSavedCardInfo(userData) {
            try {
                // 모바일 감지
                const isMobile = window.innerWidth <= 768;
                console.log('=== 카드 정보 로드 시작 ===');
                console.log('📱 모바일 여부:', isMobile);
                console.log('📱 화면 크기:', window.innerWidth + 'x' + window.innerHeight);
                console.log('🔍 사용자 데이터 키들:', Object.keys(userData));
                
                let cardInfo = null;
                
                // 사용자 데이터에서 카드 정보 찾기 (우선순위 순)
                if (userData.savedCardInfo) {
                    cardInfo = userData.savedCardInfo;
                    console.log('✅ savedCardInfo에서 카드 정보 발견:', cardInfo);
                } else if (userData.paymentInfo) {
                    cardInfo = userData.paymentInfo;
                    console.log('✅ paymentInfo에서 카드 정보 발견:', cardInfo);
                } else if (userData.cardInfo) {
                    cardInfo = userData.cardInfo;
                    console.log('✅ cardInfo에서 카드 정보 발견:', cardInfo);
                } else {
                    console.log('📝 저장된 카드 정보가 없음');
                }
                
                if (cardInfo) {
                    console.log('🔍 카드 정보 상세 분석:');
                    console.log('- cardInfo 키들:', Object.keys(cardInfo));
                    console.log('- cardNumber 존재:', !!cardInfo.cardNumber);
                    console.log('- cardExpiry 존재:', !!cardInfo.cardExpiry);
                    console.log('- cardName 존재:', !!cardInfo.cardName);
                    console.log('- cardCvc 존재:', !!cardInfo.cardCvc);
                    
                    let filledCount = 0;
                    
                    // 카드 정보 자동 입력
                    const cardFields = {
                        'card-number': cardInfo.cardNumber || '',
                        'card-expiry': cardInfo.cardExpiry || '',
                        'card-name': cardInfo.cardName || userData.name || ''
                    };
                    
                    Object.entries(cardFields).forEach(([fieldId, value]) => {
                        const field = document.getElementById(fieldId);
                        if (field && value) {
                            // 카드 번호는 마스킹 처리
                            if (fieldId === 'card-number' && value.length >= 4) {
                                // 카드 번호 마스킹 (앞 4자리와 뒤 4자리만 표시)
                                const maskedNumber = value.substring(0, 4) + ' **** **** ' + value.substring(value.length - 4);
                                field.value = maskedNumber;
                                field.dataset.originalNumber = value; // 원본 값 저장
                                console.log(`✅ ${fieldId} 마스킹 처리:`, maskedNumber);
                            } else {
                            field.value = value;
                                console.log(`✅ ${fieldId} 자동 입력:`, value);
                            }
                            filledCount++;
                        } else if (field && !value) {
                            console.log(`⚠️ ${fieldId} - 저장된 정보 없음`);
                        } else if (!field) {
                            console.log(`❌ ${fieldId} - DOM 요소를 찾을 수 없음`);
                        }
                    });
                    
                    // CVC는 보안상 별표로 표시
                    const cvcField = document.getElementById('card-cvv');
                    if (cvcField && cardInfo.cardCvc) {
                        const maskedCvc = '*'.repeat(cardInfo.cardCvc.length);
                        cvcField.value = maskedCvc;
                        cvcField.dataset.originalCvc = cardInfo.cardCvc; // 원본 값 저장
                        filledCount++;
                        console.log('✅ CVC 별표 마스킹 적용:', maskedCvc);
                    }
                    
                    if (filledCount > 0) {
                        console.log(`✅ ${filledCount}개 카드 정보 필드 자동 입력 완료`);
                        showAlert('payment-alert', `保存されたカード情報を${filledCount}件自動入力しました。`, 'success');
                } else {
                        console.log('📝 저장된 카드 정보가 있지만 필드에 입력할 수 없음');
                    }
                } else {
                    console.log('📝 저장된 카드 정보가 없음 - 수동 입력 필요');
                }
            } catch (error) {
                console.error('❌ 카드 정보 로드 오류:', error);
                showAlert('payment-alert', 'カード情報の読み込みに失敗しました。', 'danger');
            }
        }
        
        // 카드 정보 저장
        async function saveCardInfo(cardData) {
            try {
                console.log('=== 카드 정보 저장 시작 ===');
                console.log('🔍 저장할 카드 데이터:', {
                    cardNumber: cardData.cardNumber ? cardData.cardNumber.substring(0, 4) + '****' : '없음',
                    cardExpiry: cardData.cardExpiry || '없음',
                    cardName: cardData.cardName || '없음',
                    cardCvc: cardData.cardCvc ? '***' : '없음'
                });
                
                // Firebase에서 현재 로그인된 사용자 확인
                if (typeof firebase !== 'undefined' && 
                    firebase.auth && 
                    firebase.apps && 
                    firebase.apps.length > 0 &&
                    firebase.apps[0].name === '[DEFAULT]') {
                    
                    const user = firebase.auth().currentUser;
                    if (user && user.email) {
                        try {
                            // 카드 정보를 안전하게 저장 (CVC는 별도 처리)
                            const safeCardData = {
                                cardNumber: cardData.cardNumber,
                                cardExpiry: cardData.cardExpiry,
                                cardName: cardData.cardName,
                                cardCvc: cardData.cardCvc, // 실제 환경에서는 암호화 필요
                                paymentMethod: cardData.paymentMethod || 'credit',
                                savedAt: new Date().toISOString()
                            };
                            
                            await firebase.firestore().collection('users').doc(user.email).update({
                                savedCardInfo: safeCardData,
                                cardInfoUpdatedAt: new Date().toISOString()
                            });
                            
                            console.log('✅ Firebase에 카드 정보 저장 성공:', user.email);
                            console.log('🔍 저장된 카드 정보 구조:', Object.keys(safeCardData));
                            
                        } catch (firebaseError) {
                            console.error('❌ Firebase 카드 정보 저장 실패:', firebaseError);
                            throw firebaseError;
                        }
                    } else {
                        console.log('⚠️ 로그인되지 않은 사용자는 카드 정보를 저장하지 않음');
                    }
                } else {
                    console.log('❌ Firebase가 초기화되지 않음');
                }
                
            } catch (error) {
                console.error('❌ 카드 정보 저장 오류:', error);
                throw error;
            }
        }

        // 유효기한 포맷팅
        function formatExpiry(value) {
            // 숫자만 추출
            let numbers = value.replace(/\D/g, '');
            
            // 최대 4자리까지만 유지
            numbers = numbers.substring(0, 4);
            
            // MM/YY 형식으로 포맷팅
            if (numbers.length >= 2) {
                return numbers.substring(0, 2) + '/' + numbers.substring(2);
            }
            
            return numbers;
        }

        // 카드 번호 유효성 검사 (Luhn 알고리즘)
        function validateCardNumber(number) {
            const cleanNumber = number.replace(/\s+/g, '');
            if (cleanNumber.length < 13 || cleanNumber.length > 19) return false;
            
            let sum = 0;
            let isEven = false;
            
            for (let i = cleanNumber.length - 1; i >= 0; i--) {
                let digit = parseInt(cleanNumber[i]);
                
                if (isEven) {
                    digit *= 2;
                    if (digit > 9) digit -= 9;
                }
                
                sum += digit;
                isEven = !isEven;
            }
            
            return sum % 10 === 0;
        }

        // 결제 방법 선택
        function selectPaymentMethod(method) {
            document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
            document.querySelector('[data-method="' + method + '"]').classList.add('selected');
            
            if (method === 'credit') {
                document.getElementById('credit-card-form').style.display = 'block';
                document.getElementById('bank-transfer-info').style.display = 'none';
            } else if (method === 'bank-transfer') {
                document.getElementById('credit-card-form').style.display = 'none';
                document.getElementById('bank-transfer-info').style.display = 'block';
                // Firebase에서 계좌 정보 로드
                loadBankAccountInfo();
            }
        }
        
        // 계좌 정보 로드 (Firebase에서)
        async function loadBankAccountInfo() {
            try {
                if (!firebase.firestore) {
                    console.error('Firestore를 사용할 수 없습니다');
                    return;
                }
                
                const db = firebase.firestore();
                const doc = await db.collection('settings').doc('bankAccount').get();
                
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('bank-name-display').textContent = data.bankName || '未設定';
                    document.getElementById('bank-branch-display').textContent = data.branchName || '未設定';
                    document.getElementById('bank-type-display').textContent = data.accountType || '未設定';
                    document.getElementById('bank-account-display').textContent = data.accountNumber || '未設定';
                    document.getElementById('bank-holder-display').textContent = data.accountHolder || '未設定';
                    console.log('✅ 계좌 정보 로드 완료');
                } else {
                    console.warn('⚠️ 계좌 정보가 설정되지 않았습니다');
                }
            } catch (error) {
                console.error('❌ 계좌 정보 로드 실패:', error);
            }
        }

        // 주문 처리
        async function processOrder() {
            try {
                // 결제 방법 선택 확인
                const selectedMethodElement = document.querySelector('.payment-method.selected');
                if (!selectedMethodElement) {
                    showAlert('payment-alert', '決済方法を選択してください。', 'danger');
                    throw new Error('결제 방법이 선택되지 않음');
                }
                
                const selectedMethod = selectedMethodElement.dataset.method;
                console.log('선택된 결제 방법:', selectedMethod);
                
                // 배송 정보 세부 검증
                const requiredFields = [
                    { id: 'shipping-name', name: 'お名前' },
                    { id: 'shipping-phone', name: '電話番号' },
                    { id: 'shipping-postal', name: '郵便番号' },
                    { id: 'shipping-prefecture', name: '都道府県' },
                    { id: 'shipping-city', name: '市区町村' },
                    { id: 'shipping-address1', name: '番地・建物名' }
                ];
                
                let missingFields = [];
                for (let field of requiredFields) {
                    const element = document.getElementById(field.id);
                    if (!element || !element.value.trim()) {
                        missingFields.push(field.name);
                    }
                }
                
                if (missingFields.length > 0) {
                    showAlert('shipping-alert', `以下の項目を入力してください：${missingFields.join('、')}`, 'danger');
                    throw new Error('필수 배송 정보가 누락됨: ' + missingFields.join(', '));
                }
                
                // 전화번호 형식 검증
                const phone = document.getElementById('shipping-phone').value;
                if (!/^[\d\-\+\(\)\s]+$/.test(phone) || phone.length < 10) {
                    showAlert('shipping-alert', '正しい電話番号を入力してください。', 'danger');
                    throw new Error('전화번호 형식이 잘못됨');
                }
                
                // 우편번호 형식 검증 (일본 우편번호: 123-4567 또는 1234567)
                const postal = document.getElementById('shipping-postal').value;
                if (!/^\d{3}-?\d{4}$/.test(postal)) {
                    showAlert('shipping-alert', '正しい郵便番号を入力してください（例：123-4567）。', 'danger');
                    throw new Error('우편번호 형식이 잘못됨');
            }

            // 결제 정보 검증
                let paymentData = null;
            if (selectedMethod === 'credit') {
                    // Stripe Elements 사용 - 카드 정보는 Stripe가 직접 처리
                    const cardName = document.getElementById('card-name')?.value;
                    
                    if (!cardName) {
                        showAlert('payment-alert', 'カード名義人を入力してください。', 'danger');
                        throw new Error('카드 명의인이 누락됨');
                    }
                    
                    // Stripe Elements가 유효한지 확인
                    if (!cardElement) {
                        showAlert('payment-alert', 'カード情報を入力してください。', 'danger');
                        throw new Error('Stripe Elements가 초기화되지 않음');
                    }
                    
                    console.log('✅ Stripe 카드 정보 확인 완료');
                }

                // 주문 데이터 준비
                const shippingInfo = {
                    name: document.getElementById('shipping-name').value,
                    phone: document.getElementById('shipping-phone').value,
                    postal: document.getElementById('shipping-postal').value,
                    prefecture: document.getElementById('shipping-prefecture').value,
                    city: document.getElementById('shipping-city').value,
                    address1: document.getElementById('shipping-address1').value,
                    address2: document.getElementById('shipping-address2').value
                };

                const cart = getCart();
                console.log('🛒 카트 상품 정보:', cart);
                if (!cart || cart.length === 0) {
                    showAlert('payment-alert', 'カートが空です。商品を追加してから注文してください。', 'danger');
                    throw new Error('카트가 비어있음');
                }
                
                // 카트 아이템 구조 확인 및 정규화
                const normalizedCart = cart.map(item => {
                    // 상품 이름이 여러 필드에 있을 수 있으므로 정규화
                    const itemName = item.name || item.title || item.productName || item.productTitle || 'Unknown Product';
                    console.log('📦 상품 정보:', {
                        original: item,
                        normalized: itemName
                    });
                    return {
                        ...item,
                        name: itemName, // 상품 이름 명시적으로 설정
                        productName: itemName // 백업 필드
                    };
                });

                // 현재 사용자 정보 가져오기
                let currentUser = null;
                try {
                    // Firebase 전용 사용자 확인
                    if (firebase.auth && firebase.auth().currentUser) {
                        currentUser = firebase.auth().currentUser;
                        console.log('✅ Firebase 사용자 확인됨:', currentUser.email);
                    } else {
                        console.log('❌ Firebase에 로그인된 사용자 없음');
                        currentUser = null;
                    }
                } catch (error) {
                    console.log('사용자 정보 가져오기 실패:', error);
                }

                // 주문 처리 (Firebase 또는 로컬 저장)
                const subtotal = normalizedCart.reduce((total, item) => total + (item.price * item.quantity), 0);
                const shippingFee = subtotal >= 3000 ? 0 : 500; // 배송비 계산
                const earnedPoints = Math.floor(subtotal * 0.03);
                
                // 포인트 사용량 재확인 (주문 처리 직전)
                const pointsInput = document.getElementById('points-to-use');
                const inputValue = pointsInput ? parseInt(pointsInput.value) || 0 : 0;
                const usedPoints = Math.max(inputValue, pointsToUse || 0);
                
                // 최종 금액 계산 (배송비 포함, 포인트 할인 적용)
                const totalBeforeDiscount = subtotal + shippingFee;
                const finalTotal = Math.max(0, totalBeforeDiscount - usedPoints);
                const pointDiscount = usedPoints;
                
                console.log('📊 주문 금액 계산:', {
                    subtotal: subtotal,
                    shippingFee: shippingFee,
                    totalBeforeDiscount: totalBeforeDiscount,
                    usedPoints: usedPoints,
                    finalTotal: finalTotal
                });
                
                const orderData = {
                    id: 'ORDER-' + Date.now(),
                    items: normalizedCart, // 정규화된 카트 사용
                    shipping: shippingInfo,
                    payment: {
                        method: selectedMethod,
                        total: '¥' + finalTotal.toLocaleString()
                    },
                    orderDate: firebase.firestore.Timestamp.now(),
                    status: selectedMethod === 'bank-transfer' ? 'pending_payment' : 'processing',
                    // 금액 정보 추가
                    earnedPoints: earnedPoints,
                    subtotal: subtotal,
                    shippingFee: shippingFee,
                    totalAmount: finalTotal, // 배송비 포함, 포인트 할인 적용된 최종 금액
                    pointDiscount: pointDiscount, // 사용한 포인트
                    usedPoints: usedPoints, // 사용한 포인트 (호환성)
                    originalAmount: subtotal, // 포인트 할인 전 원래 금액
                    // 사용자 정보 추가
                    userId: currentUser ? currentUser.uid : null,
                    userEmail: currentUser ? currentUser.email : null,
                    userName: currentUser ? currentUser.displayName : shippingInfo.name,
                    customerEmail: currentUser ? currentUser.email : null,
                    customer: {
                        name: currentUser ? currentUser.displayName : shippingInfo.name,
                        email: currentUser ? currentUser.email : null,
                        phone: shippingInfo.phone
                    }
                };

                console.log('주문 데이터:', orderData);
                
                // 포인트 관련 변수 초기화 (Firebase 전용)
                let newPoints = null; // Firebase에서 계산될 포인트
                
                console.log('주문 처리 시 포인트 확인:', {
                    pointsToUse: pointsToUse,
                    inputValue: inputValue,
                    usedPoints: usedPoints,
                    currentUserPoints: currentUserPoints
                });
                
                // 포인트 사용 검증
                if (usedPoints > 0) {
                    if (usedPoints > currentUserPoints) {
                        showAlert('payment-alert', '保有ポイントが不足です。ページを更新して再度お試しください。', 'danger');
                        throw new Error('포인트가 부족함');
                    }
                    
                    const totalAmount = subtotal + (subtotal >= 3000 ? 0 : 500);
                    if (usedPoints > totalAmount) {
                        showAlert('payment-alert', '使用ポイントが注文金額を超えています。', 'danger');
                        throw new Error('포인트 사용량이 주문 금액을 초과함');
                    }
                    
                    console.log('포인트 사용 검증 통과:', usedPoints, '포인트');
                }
                
                console.log('포인트 사용:', usedPoints, '포인트 적립:', earnedPoints);
                let orderId = null;
                
                // 결제 방법별 처리
                if (selectedMethod === 'credit') {
                    // Stripe 결제 처리 (크레딧카드인 경우)
                    console.log('💳 Stripe 결제 시작');
                    try {
                        const paymentResult = await processStripePayment(finalTotal, orderData);
                        if (!paymentResult.success) {
                            throw new Error('決済に失敗しました');
                        }
                        console.log('✅ Stripe 결제 성공:', paymentResult.paymentIntentId);
                        
                        // 결제 성공한 PaymentIntent ID를 주문 데이터에 추가
                        orderData.paymentIntentId = paymentResult.paymentIntentId;
                        orderData.paymentStatus = 'paid';
                        orderData.orderStatus = 'confirmed';
                    } catch (paymentError) {
                        console.error('❌ Stripe 결제 실패:', paymentError);
                        showAlert('payment-alert', paymentError.message || '決済処理に失敗しました。', 'danger');
                        throw paymentError;
                    }
                } else if (selectedMethod === 'bank-transfer') {
                    // 계좌이체인 경우
                    console.log('🏦 계좌이체 주문 처리');
                    orderData.paymentStatus = 'pending'; // 입금 대기
                    orderData.orderStatus = 'pending_payment'; // 입금 확인 대기
                    orderData.paymentMethod = 'bank-transfer';
                    console.log('✅ 계좌이체 주문 생성 (입금 대기)');
                }
                
                try {
                    // Firebase 사용자가 있으면 Firebase에 저장
                    const user = firebase.auth && firebase.auth().currentUser;
                    if (user) {
                        console.log('🚀 Firebase 주문 처리 시작 - 사용자:', user.uid);
                        console.log('Firebase 사용자로 주문 처리:', user.uid);
                        console.log('🔍 Firebase 상태 확인:', {
                            firebase: !!firebase,
                            firestore: !!firebase.firestore,
                            auth: !!firebase.auth,
                            currentUser: !!user
                        });
                        
                        // 주문 정보를 Firestore에 저장
                        console.log('📝 Firebase 주문 저장 시작...');
                        try {
                            const timestamp = Date.now();
                            // 주문 ID를 간단하고 읽기 쉽게 생성 (ORDER-타임스탬프)
                            const orderDocId = `ORDER-${timestamp}`;
                            
                            const orderRef = firebase.firestore().collection('orders').doc(orderDocId);
                            await orderRef.set({
                                ...orderData,
                                orderId: orderDocId,
                                userId: user.uid,
                                userEmail: user.email, // 이메일 명시적으로 저장
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            orderId = orderDocId;
                            console.log('✅ Firebase 주문 저장 완료:', orderId);
                        } catch (orderError) {
                            console.error('❌ Firebase 주문 저장 실패:', orderError);
                            throw orderError;
                        }

                        // 현재 사용자의 포인트 정보 가져오기 (이메일을 문서 ID로 사용)
                        console.log('👤 사용자 포인트 정보 조회 중...');
                        try {
                            const userDoc = await firebase.firestore().collection('users').doc(user.email).get();
                            const currentPoints = userDoc.exists ? (userDoc.data().points || 0) : 0;
                            console.log('📊 현재 포인트:', currentPoints);
                            
                            // 포인트 사용 및 적립 계산 (finalUsedPoints 사용)
                            const finalUsedPoints = Math.max(usedPoints, pointsToUse || 0);
                            newPoints = currentPoints - finalUsedPoints + earnedPoints;
                            console.log(`💰 포인트 변화: ${currentPoints} - ${finalUsedPoints} + ${earnedPoints} = ${newPoints}`);
                            
                            // Firestore에 포인트 업데이트 (이메일을 문서 ID로 사용)
                            console.log('💾 Firebase 포인트 업데이트 시작...');
                            await firebase.firestore().collection('users').doc(user.email).update({
                                points: newPoints,
                                pointsUpdatedAt: new Date()
                            });
                            console.log('✅ Firebase 포인트 업데이트 완료:', newPoints);
                        } catch (pointError) {
                            console.error('❌ Firebase 포인트 업데이트 실패:', pointError);
                            throw pointError;
                        }
                        
                        // 포인트 사용 이력 저장 (사용한 경우)
                        // usedPoints 재확인 및 강제 설정
                        const finalUsedPoints = Math.max(usedPoints, pointsToUse || 0);
                        console.log('🔍 최종 포인트 사용량 확인:', {
                            usedPoints: usedPoints,
                            pointsToUse: pointsToUse,
                            finalUsedPoints: finalUsedPoints,
                            subtotal: subtotal
                        });
                        
                        if (finalUsedPoints > 0) {
                            console.log('🔥 포인트 사용 이력 저장 시작:', finalUsedPoints, 'pt');
                            console.log('📝 저장할 포인트 사용 이력 데이터:', {
                                userId: user.uid,
                                orderId: orderId,
                                points: finalUsedPoints,
                                type: 'use',
                                reason: '商品購入に使用',
                                orderAmount: subtotal || 0
                            });
                            try {
                                const pointHistoryRef = await firebase.firestore().collection('pointHistory').add({
                                    userId: user.uid,
                                    userEmail: user.email,
                                    orderId: orderId,
                                    points: finalUsedPoints,
                                    type: 'use',
                                    reason: '商品購入に使用',
                                    timestamp: new Date(),
                                    orderAmount: subtotal || 0, // subtotal이 undefined인 경우 0으로 설정
                                    createdAt: new Date()
                                });
                                console.log('✅ Firebase 포인트 사용 이력 저장 완료:', finalUsedPoints, 'pt, 문서ID:', pointHistoryRef.id);
                            } catch (useHistoryError) {
                                console.error('❌ Firebase 포인트 사용 이력 저장 실패:', useHistoryError);
                                console.error('❌ 에러 상세 정보:', {
                                    name: useHistoryError.name,
                                    message: useHistoryError.message,
                                    code: useHistoryError.code
                                });
                                throw useHistoryError;
                            }
                        } else {
                            console.log('ℹ️ 포인트 사용 없음 - 사용 이력 저장 건너뜀');
                        }
                        
                        // 포인트 적립 이력 저장
                        if (earnedPoints > 0) {
                            console.log('🔥 포인트 적립 이력 저장 시작:', earnedPoints, 'pt');
                            console.log('📝 저장할 포인트 적립 이력 데이터:', {
                                userId: user.uid,
                                orderId: orderId,
                                points: earnedPoints,
                                type: 'earn',
                                reason: '商品購入',
                                orderAmount: subtotal || 0
                            });
                            try {
                                const earnHistoryRef = await firebase.firestore().collection('pointHistory').add({
                                    userId: user.uid,
                                    userEmail: user.email,
                                    orderId: orderId,
                                    points: earnedPoints,
                                    type: 'earn',
                                    reason: '商品購入',
                                    timestamp: new Date(),
                                    orderAmount: subtotal || 0,
                                    createdAt: new Date()
                                });
                                console.log('✅ Firebase 포인트 적립 이력 저장 완료:', earnedPoints, 'pt, 문서ID:', earnHistoryRef.id);
                            } catch (earnHistoryError) {
                                console.error('❌ Firebase 포인트 적립 이력 저장 실패:', earnHistoryError);
                                console.error('❌ 에러 상세 정보:', {
                                    name: earnHistoryError.name,
                                    message: earnHistoryError.message,
                                    code: earnHistoryError.code
                                });
                                throw earnHistoryError;
                            }
                        } else {
                            console.log('ℹ️ 포인트 적립 없음 - 적립 이력 저장 건너뜀');
                        }

                        // Firebase 전용 주문 처리 완료
                        console.log('✅ Firebase 전용 주문 처리 완료:', {
                            orderId: orderId,
                            userId: user.uid,
                            userEmail: user.email
                        });

                        // 사용자 프로필 정보 업데이트 (자동 저장)
                        const profileUpdateData = {
                            // 기본 프로필 정보 (비어있을 때만 업데이트)
                            name: shippingInfo.name,
                            phone: shippingInfo.phone,
                            
                            // 주소 정보
                            address: {
                                postal: shippingInfo.postal,
                                prefecture: shippingInfo.prefecture,
                                city: shippingInfo.city,
                                address1: shippingInfo.address1,
                                address2: shippingInfo.address2,
                                updatedAt: new Date().toISOString()
                            },
                            
                            // 최근 사용 주소 (호환성)
                            lastUsedAddress: {
                                ...shippingInfo,
                                updatedAt: new Date().toISOString()
                            },
                            
                            // 마지막 주문 날짜
                            lastOrderDate: new Date().toISOString(),
                            
                            // 전체 주문 횟수 증가
                            totalOrders: firebase.firestore.FieldValue.increment(1)
                        };
                        
                        // Firebase 프로필 업데이트 (이메일을 문서 ID로 사용)
                        await firebase.firestore().collection('users').doc(user.email).update(profileUpdateData);
                        console.log('프로필 정보 자동 업데이트 완료:', profileUpdateData);
                    } else {
                        // Firebase 전용 사용 - 로그인이 필요함
                        throw new Error('로그인이 필요합니다. Firebase 사용자만 주문할 수 있습니다.');
                    }
                } catch (firebaseError) {
                    console.error('❌ Firebase 저장 실패 - 포인트는 Firebase 전용으로만 관리됩니다:', firebaseError);
                    showAlert('payment-alert', '주문 처리 중 오류가 발생했습니다. 다시 시도해주세요.', 'danger');
                    throw firebaseError; // 에러를 다시 던져서 처리 중단
                }
                
                // 카드 정보 저장 (로그인된 사용자에게만)
                if (paymentData && paymentData.paymentMethod === 'credit') {
                    try {
                        console.log('💳 카드 정보 저장 시작...');
                        await saveCardInfo(paymentData);
                        console.log('✅ 카드 정보 저장 완료 - 다음 주문 시 자동 입력됩니다');
                        
                        // 사용자에게 카드 정보 저장 완료 알림
                        if (typeof showToast === 'function') {
                            showToast('カード情報が保存されました。次回の注文時に自動入力されます。', 'success', 3000);
                        }
                        
                    } catch (cardSaveError) {
                        console.warn('⚠️ 카드 정보 저장 실패:', cardSaveError);
                        // 주문은 성공했으므로 카드 저장 실패로 인해 전체 실패하지 않음
                        if (typeof showToast === 'function') {
                            showToast('カード情報の保存に失敗しましたが、注文は正常に処理されました。', 'warning', 3000);
                    }
                    }
                } else {
                    console.log('📝 카드 결제가 아니므로 카드 정보 저장 건너뜀');
                }
                
                // 포인트 사용 이력 저장 완료 확인을 위한 대기
                console.log('✅ 주문 처리 완료');
                console.log('📊 최종 포인트 상태:', {
                    orderId: orderId,
                    usedPoints: usedPoints,
                    earnedPoints: earnedPoints,
                    newPoints: newPoints !== null ? newPoints : 'Firebase에서 계산됨'
                });
                
                // 주문 완료 방문 기록 저장
                try {
                    await window.recordUserVisit(user.email, 'purchase', {
                        orderId: orderId,
                        totalAmount: totalAmount,
                        usedPoints: usedPoints,
                        earnedPoints: earnedPoints
                    });
                } catch (error) {
                    console.warn('주문 완료 방문 기록 저장 실패:', error);
                }
                
                // 결제 방법에 따라 다른 처리
                if (selectedMethod === 'bank-transfer') {
                    // 계좌이체: 입금 안내 모달 표시 (카트는 모달에서 처리)
                    showBankTransferCompleteModal(orderId, finalTotal);
                } else {
                    // 카드 결제: 카트 비우고 홈페이지로 이동
                    await clearCart();
                    setTimeout(() => {
                        window.location.href = `index.html?newOrder=${orderId}&earnedPoints=${earnedPoints}`;
                    }, 1000);
                }
                
            } catch (error) {
                console.error('❌ 주문 처리 중 오류 발생:', error);
                console.error('오류 상세 정보:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                showAlert('payment-alert', '注文処理中にエラーが発生しました。', 'danger');
                throw error; // 에러를 상위로 전파하여 버튼 상태 복구
            }
        }

        // 카트 개수 업데이트 (Firebase 전용)
        function updateCartCount() {
            const totalItems = currentCart.reduce((total, item) => total + (item.quantity || 1), 0);
            console.log('🔢 Firebase 카트 개수 업데이트:', totalItems);
            
            const cartCountElement = document.getElementById('cart-count');
            if (cartCountElement) {
                cartCountElement.textContent = totalItems;
            }
            
            const cartCountMobileElement = document.getElementById('cart-count-mobile');
            if (cartCountMobileElement) {
                cartCountMobileElement.textContent = totalItems;
            }
        }

        // 팝업 모달 함수들
        function showTermsModal() {
            const termsModal = new bootstrap.Modal(document.getElementById('termsModal'));
            termsModal.show();
        }

        function showPrivacyModal() {
            const privacyModal = new bootstrap.Modal(document.getElementById('privacyModal'));
            privacyModal.show();
        }

        // 사용자 프로필 정보 로드 (Firebase 전용, 이메일 기반)
        async function loadUserProfile() {
            try {
                if (!currentUser) {
                    console.warn('❌ currentUser가 설정되지 않음');
                    return;
                }

                console.log('🔍 loadUserProfile 시작:', currentUser.email);

                const db = firebase.firestore();
                const userDoc = await db.collection('users').doc(currentUser.email).get();
                
                if (!userDoc.exists) {
                    console.log('❌ Firebase에 사용자 프로필이 없음');
                    return;
                }

                const userData = userDoc.data();
                console.log('✅ 사용자 프로필 데이터 로드:', userData);
                
                // 배송 정보 필드에 프로필 정보 설정 (여러 필드명 지원)
                const addressData = userData.address || userData.shippingAddress || userData.lastUsedAddress || userData;
                
                if (addressData) {
                    const fields = {
                        'shipping-name': userData.name || userData.displayName || currentUser.email.split('@')[0],
                        'shipping-phone': addressData.phone || userData.phone || '',
                        'shipping-postal': addressData.postal || addressData.postalCode || '',
                        'shipping-prefecture': addressData.prefecture || addressData.state || '',
                        'shipping-city': addressData.city || '',
                        'shipping-address1': addressData.address1 || addressData.address || '',
                        'shipping-address2': addressData.address2 || addressData.addressDetail || ''
                    };
                    
                    // 필드 업데이트
                    Object.entries(fields).forEach(([fieldId, value]) => {
                        const field = document.getElementById(fieldId);
                        if (field && value) {
                            field.value = value;
                        }
                    });
                }

                console.log('✅ 프로필 정보 로드 완료');
            } catch (error) {
                console.error('프로필 정보 로드 실패:', error);
            }
        }

        // 이 함수는 메인 DOMContentLoaded 내부로 통합됨

        // 배송 정보 유효성 검사
        function validateShippingInfo(info) {
            return (
                info.name.trim() !== '' &&
                info.postalCode.trim() !== '' &&
                info.address.trim() !== '' &&
                info.phone.trim() !== '' &&
                info.email.trim() !== ''
            );
        }

        // 이 DOMContentLoaded는 위의 메인 DOMContentLoaded와 통합됨 (중복 제거)

        // 카드 번호 포맷팅
        function formatCardNumber(value) {
            // 숫자만 추출
            const numbers = value.replace(/\D/g, '');
            
            // 4자리씩 그룹화하여 공백 추가
            const formatted = numbers.replace(/(\d{4})(?=\d)/g, '$1 ');
            
            return formatted;
        }

        // =============
        // 포인트 관리 함수들
        // =============
        
        // 사용자 포인트 로드 (Firebase) - 이메일 기반 개선 버전
        async function loadUserPoints() {
            try {
                const user = firebase.auth().currentUser;
                if (!user) {
                    console.log('Firebase 사용자 없음, 오프라인 포인트 확인');
                    await loadUserPointsOffline();
                    return;
                }
                
                currentUser = user;
                console.log('🔥 Firebase 포인트 정보 로드 시작:', user.email);
                console.log('🔥 사용자 UID:', user.uid);
                
                // 1. UID 기반으로 사용자 문서 확인 (서버에서 직접 가져오기)
                let userDoc = await firebase.firestore().collection('users').doc(user.uid).get({ source: 'server' });
                let userData = null;
                
                if (userDoc.exists) {
                    userData = userDoc.data();
                    console.log('✅ UID 기반 사용자 문서 발견:', userData);
                    console.log('✅ UID 기반 포인트:', userData.points);
                } else {
                    console.log('⚠️ UID 기반 문서 없음, 이메일 기반 검색 시도');
                    
                    // 2. 이메일 기반으로 사용자 검색
                    const emailQuery = await firebase.firestore().collection('users')
                        .where('email', '==', user.email)
                        .limit(1)
                        .get({ source: 'server' });
                    
                    if (!emailQuery.empty) {
                        const emailDoc = emailQuery.docs[0];
                        userData = emailDoc.data();
                        console.log('✅ 이메일 기반 사용자 데이터 발견:', userData);
                        
                        // 이메일 기반으로 찾은 데이터를 UID 기반으로 복사
                        await firebase.firestore().collection('users').doc(user.uid).set({
                            ...userData,
                            uid: user.uid,
                            lastSync: firebase.firestore.Timestamp.now()
                        });
                        console.log('✅ UID 기반 문서로 동기화 완료');
                    }
                }
                
                if (userData) {
                    const newPoints = userData.points || 0;
                    console.log(`포인트 로딩: ${currentUserPoints} → ${newPoints}`);
                    currentUserPoints = newPoints;
                    console.log('Firebase에서 포인트 정보 로드 (최신):', currentUserPoints);
                    console.log('사용자 데이터:', userData);
                    console.log('✅ Firebase 포인트 로드 완료 (포인트 페이지 방식)');
                    showPointSection();
                    
                } else {
                    console.log('⚠️ 사용자 데이터가 전혀 없습니다. 새 사용자 생성');
                    currentUserPoints = 0;
                    
                    // 새 사용자 데이터 생성
                    const newUserData = {
                        email: user.email,
                        points: 0,
                        createdAt: firebase.firestore.Timestamp.now(),
                        uid: user.uid
                    };
                    
                    await firebase.firestore().collection('users').doc(user.uid).set(newUserData);
                    console.log('✅ 새 사용자 문서 생성 완료');
                    
                    showPointSection();
                }
            } catch (error) {
                console.error('❌ Firebase 포인트 정보 로드 실패:', error);
                console.log('⚠️ Firebase 전용 시스템 - 포인트 로드 실패');
                currentUserPoints = 0;
                showPointSection();
            }
        }
        
        // 포인트 페이지와 동일한 포인트 로딩 함수 (사용자 객체 전달)
        async function loadPointsLikePointsPageWithUser(checkoutPageUser) {
            try {
                console.log('🔄 포인트 페이지 방식 포인트 로딩 시작 (사용자 전달)');
                console.log('🔄 포인트 페이지 방식 - 사용자:', checkoutPageUser);
                
                if (!checkoutPageUser) {
                    console.log('❌ 사용자 객체 없음');
                    currentUserPoints = 0;
                    showPointSection();
                    return;
                }
                
                // Firebase에서 포인트 정보 가져오기 (포인트 페이지와 동일)
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    const db = firebase.firestore();
                    
                    // Firebase 연결 상태 먼저 확인
                    console.log('🔍 Firebase 연결 상태 확인 중...');
                    try {
                        await db.collection('test').limit(1).get();
                        console.log('✅ Firebase 연결 정상');
                    } catch (connectionError) {
                        console.error('❌ Firebase 연결 실패:', connectionError);
                        console.log('Firebase 콘솔에서 "문서를 로드하는 중에 오류가 발생했습니다" 메시지와 연관될 수 있습니다.');
                        currentUserPoints = 0;
                        showPointSection();
                        return;
                    }
                    
                    // 먼저 이메일을 문서 ID로 검색 (포인트 페이지와 동일한 방식)
                    let userDoc = null;
                    try {
                        userDoc = await db.collection('users').doc(checkoutPageUser.email).get({ source: 'server' });
                        console.log('이메일을 문서 ID로 검색 결과 (서버에서):', userDoc.exists);
                        console.log('이메일을 문서 ID로 검색한 문서 ID:', checkoutPageUser.email);
                    } catch (emailDocError) {
                        console.error('❌ 이메일을 문서 ID로 검색 실패:', emailDocError);
                    }
                    
                    if (!userDoc || !userDoc.exists) {
                        // 이메일 문서 ID로 찾지 못한 경우 UID로 검색
                        console.log('이메일 문서 ID로 찾지 못함, UID로 검색 시도');
                        try {
                            userDoc = await db.collection('users').doc(checkoutPageUser.uid).get({ source: 'server' });
                            console.log('UID로 검색 결과:', userDoc.exists);
                            if (userDoc.exists) {
                                console.log('UID로 사용자 찾음:', checkoutPageUser.uid);
                            }
                        } catch (uidError) {
                            console.error('❌ UID로 검색 실패:', uidError);
                        }
                        
                        // UID로도 찾지 못한 경우 이메일 쿼리로 검색
                        if (!userDoc || !userDoc.exists) {
                            console.log('UID로도 찾지 못함, 이메일 쿼리로 검색 시도');
                            try {
                                const emailQuery = await db.collection('users')
                                    .where('email', '==', checkoutPageUser.email)
                                    .limit(1)
                                    .get({ source: 'server' });
                                
                                if (!emailQuery.empty) {
                                    userDoc = emailQuery.docs[0];
                                    console.log('이메일 쿼리로 사용자 찾음:', userDoc.id);
                                } else {
                                    console.log('❌ 모든 방법으로도 사용자를 찾을 수 없음');
                                }
                            } catch (emailQueryError) {
                                console.error('❌ 이메일 쿼리로 검색 실패:', emailQueryError);
                            }
                        }
                    }
                    
                    if (userDoc && userDoc.exists) {
                        const userData = userDoc.data();
                        console.log('🔍 사용자 데이터 상세 분석:');
                        console.log('  - userData 전체:', userData);
                        console.log('  - userData.points 값:', userData.points);
                        console.log('  - userData.points 타입:', typeof userData.points);
                        console.log('  - userData.points === undefined:', userData.points === undefined);
                        console.log('  - userData.points === null:', userData.points === null);
                        console.log('  - userData.points === 0:', userData.points === 0);
                        console.log('  - userData 전체 키들:', Object.keys(userData));
                        
                        const newPoints = userData.points || 0;
                        
                        // 포인트가 변경되었는지 확인 (포인트 페이지와 동일)
                        if (currentUserPoints !== newPoints) {
                            console.log(`포인트 변경 감지: ${currentUserPoints} → ${newPoints}`);
                            currentUserPoints = newPoints;
                            checkoutPageUser.points = currentUserPoints; // 사용자 정보도 업데이트
                            
                            // UI 업데이트 (포인트 페이지와 동일)
                            showPointSection();
                        } else {
                            console.log('포인트 변경 없음:', currentUserPoints);
                        }
                        
                        console.log('Firebase에서 포인트 정보 로드 (최신):', currentUserPoints);
                        console.log('사용자 데이터:', userData);
                    } else {
                        console.log('❌ 사용자 문서가 존재하지 않습니다');
                        console.log('  - userDoc 존재 여부:', !!userDoc);
                        console.log('  - userDoc.exists:', userDoc ? userDoc.exists : 'userDoc가 null');
                        currentUserPoints = 0;
                        showPointSection();
                    }
                } else {
                    console.log('Firebase 사용 불가');
                    currentUserPoints = 0;
                    showPointSection();
                }
                
            } catch (error) {
                console.error('❌ 포인트 페이지 방식 로딩 오류:', error);
                currentUserPoints = 0;
                showPointSection();
            }
        }

        // 강제 포인트 로딩 함수 (체크아웃 페이지 전용)
        async function forceLoadUserPoints() {
            try {
                console.log('🔄 강제 포인트 로딩 시작');
                const user = firebase.auth().currentUser;
                if (!user) {
                    console.log('❌ 사용자 없음');
                    currentUserPoints = 0;
                    showPointSection();
                    return;
                }
                
                console.log('🔄 강제 로딩 - 사용자:', user.email, 'UID:', user.uid);
                
                // 서버에서 직접 가져오기
                const db = firebase.firestore();
                let userData = null;
                
                // 1. UID로 먼저 시도
                try {
                    let userDoc = await db.collection('users').doc(user.uid).get({ source: 'server' });
                    if (userDoc.exists) {
                        userData = userDoc.data();
                        console.log('✅ 강제 로딩 - UID 문서 발견:', userData);
                        console.log('✅ UID 기반 포인트:', userData.points);
                    }
                } catch (uidError) {
                    console.log('⚠️ UID 기반 로딩 실패:', uidError);
                }
                
                // 2. UID로 실패했으면 이메일로 검색
                if (!userData) {
                    try {
                        const emailQuery = await db.collection('users')
                            .where('email', '==', user.email)
                            .limit(1)
                            .get({ source: 'server' });
                        
                        if (!emailQuery.empty) {
                            userData = emailQuery.docs[0].data();
                            console.log('✅ 강제 로딩 - 이메일 문서 발견:', userData);
                            console.log('✅ 이메일 기반 포인트:', userData.points);
                        }
                    } catch (emailError) {
                        console.log('⚠️ 이메일 기반 로딩 실패:', emailError);
                    }
                }
                
                // 3. 포인트 설정 및 표시 (포인트 페이지와 동일한 방식)
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    const newPoints = userData.points || 0;
                    
                    console.log(`강제 포인트 로딩: ${currentUserPoints} → ${newPoints}`);
                    currentUserPoints = newPoints;
                    
                    console.log('Firebase에서 포인트 정보 로드 (강제 최신):', currentUserPoints);
                    console.log('사용자 데이터:', userData);
                    showPointSection();
                } else {
                    console.log('❌ 강제 로딩 실패 - 사용자 문서 없음');
                    currentUserPoints = 0;
                    showPointSection();
                }
                
            } catch (error) {
                console.error('❌ 강제 포인트 로딩 오류:', error);
                currentUserPoints = 0;
                showPointSection();
            }
        }
        
        // 사용자 포인트 로드 (Firebase 전용)
        async function loadUserPointsOffline() {
            try {
                console.log('🔍 Firebase 전용 포인트 시스템');
                console.log('ℹ️ 포인트는 Firebase에서만 로드됩니다');
                
                // Firebase에서 이미 로드된 포인트 사용
                if (window.currentUserPoints && window.currentUserPoints > 0) {
                    console.log('✅ Firebase 포인트 사용:', window.currentUserPoints);
                    return window.currentUserPoints;
                }
                
                console.log('⚠️ Firebase 포인트가 로드되지 않았습니다');
                return 0;
            } catch (error) {
                console.error('❌ 포인트 로드 실패:', error);
                return 0;
            }
        }
        
        // 포인트 섹션 표시 - 간단하고 확실한 버전
        function showPointSection() {
            console.log('🔍 showPointSection 호출됨 - currentUserPoints:', currentUserPoints);
            
            const pointSection = document.getElementById('point-use-section');
            if (!pointSection) {
                console.error('❌ point-use-section 요소를 찾을 수 없음');
                return;
            }
            
            // 무조건 포인트 섹션 표시 (간단하게)
            pointSection.style.display = 'block';
            console.log('✅ 포인트 섹션 강제 표시');
            
            // currentUserPoints가 undefined나 null이면 0으로 설정
            if (typeof currentUserPoints !== 'number' || isNaN(currentUserPoints)) {
                currentUserPoints = 0;
            }
            
            // 포인트 표시
            const availablePointsEl = document.getElementById('available-points');
            if (availablePointsEl) {
                availablePointsEl.textContent = currentUserPoints.toLocaleString() + 'pt';
            }
            
            // 포인트 입력 필드 설정
            const pointsInput = document.getElementById('points-to-use');
            if (pointsInput) {
                pointsInput.max = Math.max(0, currentUserPoints);
                pointsInput.removeEventListener('input', calculatePointDiscount);
                pointsInput.addEventListener('input', calculatePointDiscount);
            }
            
            // 최대 사용 가능 포인트 표시
            updateMaxUsablePoints();
            
            console.log('✅ 포인트 섹션 설정 완료 - 표시 포인트:', currentUserPoints);
        }
        
        // 최대 사용 가능 포인트 업데이트 - 안전한 버전
        function updateMaxUsablePoints() {
            try {
                const cart = getCart();
                if (!cart || cart.length === 0) {
                    const maxPointsDisplay = document.getElementById('max-points-display');
                    if (maxPointsDisplay) {
                        maxPointsDisplay.textContent = '0';
                    }
                    return;
                }
                
                const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
                const totalWithTax = Math.floor(subtotal / 1.1) + Math.floor(subtotal / 1.1 * 0.1);
                const shippingFee = subtotal >= 3000 ? 0 : 500;
                const maxUsable = Math.min(currentUserPoints || 0, totalWithTax + shippingFee);
                
                const maxPointsDisplay = document.getElementById('max-points-display');
                if (maxPointsDisplay) {
                    maxPointsDisplay.textContent = maxUsable.toLocaleString();
                }
                
                // 입력 필드 최대값 업데이트
                const pointsInput = document.getElementById('points-to-use');
                if (pointsInput) {
                    pointsInput.max = Math.max(0, maxUsable);
                }
                
                console.log('최대 사용 가능 포인트 업데이트:', maxUsable);
            } catch (error) {
                console.error('최대 포인트 업데이트 오류:', error);
            }
        }
        

        
        // 포인트 할인 계산 (향상된 에러 처리)
        function calculatePointDiscount() {
            try {
                const pointsInput = document.getElementById('points-to-use');
                if (!pointsInput) return;
                
                const inputValue = parseInt(pointsInput.value) || 0;
                
                // 가용성 검사 - 포인트가 0일 때는 에러 메시지만 표시
                if (currentUserPoints <= 0 && inputValue > 0) {
                    pointsToUse = 0;
                    pointsInput.value = 0;
                    showPointError('使用可能なポイントがありません（現在: 0pt）');
                    return;
                }
                
                // 최대 사용 가능 포인트 계산
                const cart = getCart();
                if (!cart || cart.length === 0) {
                    pointsToUse = 0;
                    pointsInput.value = 0;
                    return;
                }
                
                const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
                const totalWithTax = Math.floor(subtotal / 1.1) + Math.floor(subtotal / 1.1 * 0.1);
                const shippingFee = subtotal >= 3000 ? 0 : 500;
                const maxUsable = Math.min(currentUserPoints, totalWithTax + shippingFee);
                
                // 입력값 검증 및 제한
                if (inputValue > maxUsable) {
                    pointsToUse = maxUsable;
                    pointsInput.value = pointsToUse;
                    
                    if (inputValue > currentUserPoints) {
                        showPointError(`保有ポイントは${currentUserPoints.toLocaleString()}ポイントです`);
                    } else {
                        showPointError(`最大${maxUsable.toLocaleString()}ポイントまで使用可能です`);
                    }
                } else if (inputValue < 0) {
                    pointsToUse = 0;
                    pointsInput.value = 0;
                } else {
                    pointsToUse = inputValue;
                    clearPointError();
                    
                    // 간단한 피드백
                    if (pointsToUse > 0) {
                        showPointSuccess(`${pointsToUse.toLocaleString()}ポイント使用中`);
                    } else {
                        clearPointError();
                    }
                }
                
                // UI 업데이트
                document.getElementById('point-discount').textContent = `-¥${pointsToUse.toLocaleString()}`;
                
                // 주문 요약 업데이트
                updateOrderSummary();
                
                // 사용자에게 하이라이트 효과
                if (pointsToUse > 0) {
                    pointsInput.classList.add('border-success');
                    pointsInput.classList.remove('border-danger');
                } else {
                    pointsInput.classList.remove('border-success', 'border-danger');
                }
                
            } catch (error) {
                console.error('포인트 할인 계산 오류:', error);
                showPointError('ポイント 計算中にエラーが発生しました');
            }
        }
        
        // 전체 포인트 사용 - 간단 버전
        function useMaxPoints() {
            try {
                if (currentUserPoints <= 0) {
                    showPointError('使用可能なポイントがありません（現在: 0pt）');
                    return;
                }
                
                const cart = getCart();
                if (!cart || cart.length === 0) {
                    showPointError('カートが空です');
                    return;
                }
                
                const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
                const totalWithTax = Math.floor(subtotal / 1.1) + Math.floor(subtotal / 1.1 * 0.1);
                const shippingFee = subtotal >= 3000 ? 0 : 500;
                const maxUsable = Math.min(currentUserPoints, totalWithTax + shippingFee);
                
                if (maxUsable <= 0) {
                    showPointError('使用可能なポイントがありません（現在: ' + currentUserPoints + 'pt）');
                    return;
                }
                
                document.getElementById('points-to-use').value = maxUsable;
                calculatePointDiscount();
                
                showPointSuccess(`${maxUsable.toLocaleString()}ポイント使用`);
                
            } catch (error) {
                console.error('전체 포인트 사용 오류:', error);
                showPointError('エラーが発生しました');
            }
        }
        
        // 포인트 에러 메시지 표시
        function showPointError(message) {
            const feedbackElement = document.getElementById('point-feedback');
            if (feedbackElement) {
                feedbackElement.innerHTML = `<div class="alert alert-warning alert-sm py-2">
                    <i class="fas fa-exclamation-triangle me-1"></i>${message}
                </div>`;
            }
            
            // 5초 후 자동 제거
            setTimeout(clearPointError, 5000);
        }
        
        // 포인트 성공 메시지 표시
        function showPointSuccess(message) {
            const feedbackElement = document.getElementById('point-feedback');
            if (feedbackElement) {
                feedbackElement.innerHTML = `<div class="alert alert-light border py-2">
                    <i class="fas fa-check-circle me-1"></i>${message}
                </div>`;
            }
            
            // 3초 후 자동 제거
            setTimeout(clearPointError, 3000);
        }
        
        // 포인트 피드백 지우기
        function clearPointError() {
            const feedbackElement = document.getElementById('point-feedback');
            if (feedbackElement) {
                feedbackElement.innerHTML = '';
            }
        }
        
        // 포인트 강제 새로고침 함수 (디버깅용)
        window.refreshPoints = async function() {
            console.log('🔄 포인트 강제 새로고침 시작');
            
            try {
                // Firebase에서 최신 포인트 로드 시도
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    const user = firebase.auth().currentUser;
                    if (user) {
                        console.log('Firebase 사용자 확인됨, 최신 포인트 로드');
                        // 포인트 로딩은 이미 onAuthStateChanged에서 처리됨
                        return;
                    }
                }
                
                // Firebase 전용 시스템
                console.log('⚠️ Firebase 전용 시스템 - 포인트 로드 실패');
                console.log('포인트 로드 실패 - Firebase 연결을 확인하세요');
                
            } catch (error) {
                console.error('포인트 새로고침 실패:', error);
            }
        };
        
        // 전역에서 사용할 수 있는 디버깅 함수
        window.debugPoints = function() {
            console.log('=== 포인트 디버깅 정보 ===');
            console.log('currentUserPoints:', currentUserPoints);
            console.log('Firebase 사용자:', firebase?.auth?.()?.currentUser?.email || '없음');
            
            const pointSection = document.getElementById('point-use-section');
            console.log('포인트 섹션 표시 상태:', pointSection ? pointSection.style.display : 'element not found');
            
            const availablePoints = document.getElementById('available-points');
            console.log('표시된 포인트:', availablePoints ? availablePoints.textContent : 'element not found');
        };
        
        // 현재 로그인된 사용자의 포인트 로드 함수 (Firebase 전용)
        window.loadCurrentUserPoints = async function() {
            console.log('🎯 현재 사용자 포인트 로드');
            
            try {
                // Firebase에서 현재 로그인된 사용자 확인
                if (typeof firebase !== 'undefined' && firebase.auth && firebase.firestore) {
                    const currentUser = firebase.auth().currentUser;
                    if (currentUser && currentUser.email) {
                        const userDoc = await firebase.firestore().collection('users').doc(currentUser.email).get();
                        
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            const points = userData.points || 0;
                            
                            console.log('✅ Firebase에서 사용자 포인트 발견:', points);
                            
                            // 포인트 설정
                            currentUserPoints = points;
                            
                            // UI 업데이트
                            showPointSection();
                            
                            console.log('✅ 사용자 포인트 로드 완료:', points);
                            return points;
                        } else {
                            console.log('❌ Firebase에서 사용자 문서를 찾을 수 없음');
                        }
                    } else {
                        console.log('❌ 로그인된 사용자가 없음');
                    }
                } else {
                    console.log('❌ Firebase 사용 불가');
                }
            } catch (error) {
                console.error('❌ 사용자 포인트 로드 실패:', error);
            }
            
            return 0;
        };
        
        window.loadProfileAddress = loadProfileAddress;
        window.loadSavedCardInfo = loadSavedCardInfo;


        // 인증 상태 확인
        function checkAuthState() {
            if (window.auth) {
                window.auth.onAuthStateChanged(function(user) {
                    // auth-utils.js의 updateUserMenu 함수 호출
                    if (typeof window.updateUserMenu === 'function') {
                        window.updateUserMenu();
                    }
                });
            }
        }

        // 사용자 메뉴 업데이트는 auth-utils.js의 함수를 사용
        // 이 함수는 auth-utils.js에서 정의됨

        // 로그아웃 함수
        async function logout() {
            try {
                console.log('=== checkout.html 로그아웃 시작 ===');
                
                // auth-utils.js의 로그아웃 함수 사용 (우선)
                if (typeof window.logout === 'function' && window.logout.toString().includes('=== 로그아웃 시작 ===')) {
                    console.log('auth-utils.js logout 함수 사용');
                    await window.logout();
                    return;
                }
                
                // 직접 로그아웃 처리 (폴백)
                console.log('checkout.html 직접 로그아웃 처리 시작');
                
                // Firebase 로그아웃
            if (typeof firebase !== 'undefined' && firebase.auth) {
                    await firebase.auth().signOut();
                    console.log('Firebase 로그아웃 완료');
                }
                
                // Firebase 카트 초기화 완료
                console.log('Firebase 카트 초기화 완료');
                
                // 실시간 리스너도 중단
                if (window.cartRealtimeListener) {
                    window.cartRealtimeListener();
                    window.cartRealtimeListener = null;
                    console.log('카트 실시간 리스너 중단 완료');
                }
                
                // 카트 업데이트 진행 중 플래그도 초기화
                window.cartUpdateInProgress = false;
                
                console.log('checkout.html 로그아웃 성공');
                
                // 사용자 메뉴 업데이트
                if (typeof window.updateUserMenu === 'function') {
                    await window.updateUserMenu();
                }
                
                // 카트 개수 업데이트 (0으로 표시)
                if (typeof updateCartCount === 'function') {
                    updateCartCount();
                    console.log('카트 개수 업데이트 완료');
                }
                
                // Firebase 카트 초기화
                currentCart = [];
                currentUser = null;
                
                // 토스트 메시지 표시
                if (typeof window.showToast === 'function') {
                    window.showToast('ログアウトしました。', 'success', 2000);
                } else {
                    alert('ログアウトしました。');
                }
                
                // 홈페이지로 리다이렉트
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
                
            } catch (error) {
                console.error('checkout.html 로그아웃 중 오류:', error);
                
                // 오류가 발생해도 강제로 Firebase 카트 초기화
                currentCart = [];
                currentUser = null;
                if (window.cartRealtimeListener) {
                    window.cartRealtimeListener();
                    window.cartRealtimeListener = null;
                }
                window.cartUpdateInProgress = false;
                
                if (typeof updateCartCount === 'function') {
            updateCartCount();
                }
                
                if (typeof window.showToast === 'function') {
                    window.showToast('ログアウトしました。', 'success', 2000);
                } else {
                    alert('ログアウトしました。');
                }
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            }
        }

        // 중복된 updateCartCount 함수 제거됨 - Firebase 전용 버전 사용

        // 중복된 DOMContentLoaded 리스너 제거됨 - 첫 번째 리스너에서 모든 초기화 처리

        // ========== Stripe 결제 연동 ==========
        
        // Stripe 초기화 함수
        function initializeStripe() {
            console.log('💳 Stripe 초기화 시작');
            
            // Stripe 공개 키 확인
            if (STRIPE_PUBLISHABLE_KEY === 'YOUR_STRIPE_PUBLISHABLE_KEY_HERE') {
                console.warn('⚠️ Stripe 공개 키가 설정되지 않았습니다');
                return;
            }
            
            try {
                // Stripe 인스턴스 생성
                stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
                
                // Stripe Elements 생성
                const elements = stripe.elements({
                    locale: 'ja' // 일본어 UI
                });
                
                // Card Element 생성
                cardElement = elements.create('card', {
                    style: {
                        base: {
                            fontSize: '16px',
                            color: '#495057',
                            fontFamily: '"Noto Sans JP", "Hiragino Sans", "Yu Gothic", "Meiryo", sans-serif',
                            '::placeholder': {
                                color: '#6c757d'
                            }
                        },
                        invalid: {
                            color: '#dc3545',
                            iconColor: '#dc3545'
                        }
                    },
                    hidePostalCode: true // 우편번호 숨김 (배송지에서 입력)
                });
                
                // Card Element를 DOM에 마운트
                cardElement.mount('#card-element');
                
                // 실시간 에러 표시
                cardElement.on('change', function(event) {
                    const displayError = document.getElementById('card-errors');
                    if (event.error) {
                        displayError.textContent = event.error.message;
                    } else {
                        displayError.textContent = '';
                    }
                });
                
                console.log('✅ Stripe 초기화 완료');
                
            } catch (error) {
                console.error('❌ Stripe 초기화 실패:', error);
            }
        }
        
        // Stripe 결제 처리 함수
        async function processStripePayment(amount, orderData) {
            console.log('💳 Stripe 결제 처리 시작');
            console.log('💰 결제 금액:', amount, '円');
            
            if (!stripe || !cardElement) {
                throw new Error('Stripeが初期化されていません');
            }
            
            try {
                // 1. Netlify Function을 통해 PaymentIntent 생성
                console.log('📡 Netlify Function 호출 시작');
                
                // Stripe metadata 제한(500자)을 위해 최소 정보만 전달
                const minimalOrderData = {
                    id: orderData.id,
                    userEmail: orderData.userEmail || orderData.customerEmail,
                    items: orderData.items ? orderData.items.map(item => ({
                        id: item.id,
                        name: item.name,
                        quantity: item.quantity,
                        price: item.price
                    })) : [],
                    subtotal: orderData.subtotal,
                    totalAmount: orderData.totalAmount
                };
                
                const response = await fetch('/.netlify/functions/create-payment-intent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: amount,
                        currency: 'jpy',
                        orderData: minimalOrderData
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '決済処理に失敗しました');
                }
                
                const { clientSecret, paymentIntentId } = await response.json();
                console.log('✅ PaymentIntent 생성 완료:', paymentIntentId);
                
                // 2. Stripe로 결제 확인
                const { error: confirmError, paymentIntent } = await stripe.confirmCardPayment(
                    clientSecret,
                    {
                        payment_method: {
                            card: cardElement,
                            billing_details: {
                                name: document.getElementById('card-name').value,
                            }
                        }
                    }
                );
                
                if (confirmError) {
                    throw new Error(confirmError.message);
                }
                
                if (paymentIntent.status === 'succeeded') {
                    console.log('✅ 결제 성공:', paymentIntent.id);
                    
                    // 주문 정보는 processOrder에서 저장하므로 여기서는 결과만 반환
                    return {
                        success: true,
                        paymentIntentId: paymentIntent.id
                    };
                } else {
                    throw new Error('決済が完了しませんでした');
                }
                
            } catch (error) {
                console.error('❌ Stripe 결제 처리 실패:', error);
                throw error;
            }
        }
        
        // 계좌이체 완료 모달 표시
        async function showBankTransferCompleteModal(orderId, totalAmount) {
            try {
                // 주문 번호와 금액 표시
                document.getElementById('modal-order-id').textContent = orderId;
                document.getElementById('modal-total-amount').textContent = '¥' + totalAmount.toLocaleString();
                
                // Firebase에서 계좌 정보 로드
                const db = firebase.firestore();
                const doc = await db.collection('settings').doc('bankAccount').get();
                
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('modal-bank-name').textContent = data.bankName || '未設定';
                    document.getElementById('modal-bank-branch').textContent = data.branchName || '未設定';
                    document.getElementById('modal-account-type').textContent = data.accountType || '未設定';
                    document.getElementById('modal-account-number').textContent = data.accountNumber || '未設定';
                    document.getElementById('modal-account-holder').textContent = data.accountHolder || '未設定';
                } else {
                    console.warn('계좌 정보가 설정되지 않았습니다');
                }
                
                // 모달 표시
                const modal = new bootstrap.Modal(document.getElementById('bankTransferCompleteModal'));
                modal.show();
                
                console.log('✅ 계좌이체 완료 모달 표시');
            } catch (error) {
                console.error('❌ 모달 표시 실패:', error);
                // 모달 표시 실패 시 바로 메인 페이지로 이동
                window.location.href = 'index.html';
            }
        }
        
        // 계좌이체 완료 모달 닫기 및 메인 페이지로 이동
        async function closeBankTransferModal() {
            console.log('🗑️ 모달 닫기 및 메인 페이지로 이동');
            
            try {
                // 모달 먼저 닫기
                const modal = bootstrap.Modal.getInstance(document.getElementById('bankTransferCompleteModal'));
                if (modal) {
                    modal.hide();
                    console.log('✅ 모달 닫기 완료');
                }
                
                // 즉시 홈페이지로 이동 (카트 비우기는 백그라운드에서 처리)
                console.log('🏠 메인 페이지로 이동');
                window.location.href = 'index.html';
                
                // 백그라운드에서 카트 비우기
                setTimeout(async () => {
                    try {
                        await clearCart();
                        console.log('✅ 카트 비우기 완료');
                    } catch (error) {
                        console.error('❌ 카트 비우기 실패:', error);
                    }
                }, 100);
                
            } catch (error) {
                console.error('❌ 모달 닫기 실패:', error);
                // 에러가 발생해도 홈페이지로 이동
                window.location.href = 'index.html';
            }
        }

    </script>
    
    <!-- Firebase Configuration - 이미 위에서 로드됨 -->
    
    <!-- 계좌이체 완료 모달 -->
    <div class="modal fade" id="bankTransferCompleteModal" tabindex="-1" aria-labelledby="bankTransferCompleteModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 15px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.15);">
                <div class="modal-header" style="background: #000000; border-bottom: none; border-radius: 15px 15px 0 0; padding: 20px 30px;">
                    <h5 class="modal-title japanese-heading w-100 text-center" id="bankTransferCompleteModalLabel" style="color: #ffffff; font-weight: 600; font-size: 1.3rem;">
                        <i class="fas fa-check-circle me-2"></i>ご注文ありがとうございます
                    </h5>
                </div>
                <div class="modal-body" style="padding: 30px;">
                    <div class="text-center mb-4">
                        <div style="font-size: 4rem; color: #343a40;">
                            <i class="fas fa-university"></i>
                        </div>
                        <h6 class="japanese-heading mt-3 mb-2" style="color: #495057; font-size: 1.2rem;">
                            ご注文を承りました
                        </h6>
                        <p class="japanese-text text-muted mb-0" style="font-size: 0.9rem;">
                            注文番号: <strong id="modal-order-id" style="color: #495057;"></strong>
                        </p>
                    </div>
                    
                    <div class="alert" style="background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 10px;">
                        <h6 class="japanese-heading mb-3" style="color: #495057; font-weight: 600;">
                            <i class="fas fa-info-circle me-2"></i>お振込みのご案内
                        </h6>
                        
                        <div class="mb-3 p-3" style="background-color: #ffffff; border: 1px solid #ced4da; border-radius: 8px;">
                            <div class="mb-2">
                                <small style="color: #6c757d;">お振込金額</small>
                                <div style="font-size: 1.5rem; font-weight: bold; color: #495057;" id="modal-total-amount">¥0</div>
                            </div>
                        </div>
                        
                        <div class="bank-account-info p-3" style="background-color: #ffffff; border: 1px solid #ced4da; border-radius: 8px;">
                            <div class="mb-2">
                                <strong style="color: #495057;">銀行名：</strong><span id="modal-bank-name" style="color: #6c757d;">-</span>
                            </div>
                            <div class="mb-2">
                                <strong style="color: #495057;">支店名：</strong><span id="modal-bank-branch" style="color: #6c757d;">-</span>
                            </div>
                            <div class="mb-2">
                                <strong style="color: #495057;">口座種別：</strong><span id="modal-account-type" style="color: #6c757d;">-</span>
                            </div>
                            <div class="mb-2">
                                <strong style="color: #495057;">口座番号：</strong><span id="modal-account-number" style="color: #6c757d;">-</span>
                            </div>
                            <div class="mb-0">
                                <strong style="color: #495057;">口座名義：</strong><span id="modal-account-holder" style="color: #6c757d;">-</span>
                            </div>
                        </div>
                        
                        <div class="mt-3 japanese-text" style="font-size: 0.85rem; color: #6c757d;">
                            <p class="mb-2"><i class="fas fa-exclamation-triangle me-2"></i>振込手数料はお客様負担となります。</p>
                            <p class="mb-2"><i class="fas fa-clock me-2"></i>入金確認後、商品を発送いたします。</p>
                            <p class="mb-0"><i class="fas fa-calendar-alt me-2"></i>ご注文から3日以内にお振込みください。</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #dee2e6; padding: 20px;">
                    <button type="button" class="btn btn-dark btn-lg w-100" onclick="closeBankTransferModal()" style="border-radius: 10px; padding: 12px;">
                        <i class="fas fa-check me-2"></i>確認
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>
</html> 