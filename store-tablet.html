<!DOCTYPE html>
<html lang="en">
<head>
    <title>Aether Store - Tablet Interface</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="apple-touch-icon" href="assets/img/aether-icon.png">
    <link rel="shortcut icon" type="image/x-icon" href="assets/img/aether-icon.png">
    
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/templatemo.css">
    <link rel="stylesheet" href="assets/css/custom.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800;900&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100;200;300;400;500;600;700;800;900&display=swap">
    <link rel="stylesheet" href="assets/css/fontawesome.min.css">
    
    <style>
        body {
            font-family: "Montserrat", sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }
        
        .japanese-text {
            font-family: "Noto Sans JP", sans-serif;
            font-weight: 400;
            line-height: 1.6;
        }
        
        .japanese-heading {
            font-family: "Noto Sans JP", sans-serif;
            font-weight: 600;
            line-height: 1.4;
        }
        
        .tablet-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .store-header {
            background: linear-gradient(135deg, #343a40 0%, #495057 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .scanner-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .customer-info {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: none;
        }
        
        .point-actions {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }
        
        .point-history-overview-main {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .point-management {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }
        
        #scanner-video {
            width: 100%;
            max-width: 400px;
            height: 300px;
            border-radius: 10px;
            border: 3px solid #343a40;
            background: #000;
        }
        
        .scan-overlay {
            position: relative;
            display: inline-block;
        }
        
        .scan-line {
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 2px;
            background: #28a745;
            animation: scan 2s infinite;
        }
        
        @keyframes scan {
            0% { transform: translateY(-150px); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(150px); opacity: 0; }
        }
        
        .btn-large {
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 10px;
            margin: 10px;
            min-width: 200px;
        }
        
        .customer-card {
            background: linear-gradient(135deg, #343a40 0%, #6c757d 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .points-display {
            font-size: 5rem;
            font-weight: 900;
            margin: 10px 0;
            line-height: 1.2;
        }
        
        .transaction-history {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .transaction-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #6c757d;
        }
        
        .amount-input {
            font-size: 1.5rem;
            text-align: center;
            border-radius: 10px;
            border: 2px solid #dee2e6;
            padding: 15px;
        }
        
        .quick-amounts {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .quick-amount-btn {
            padding: 10px 20px;
            border: 2px solid #343a40;
            background: white;
            color: #343a40;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .quick-amount-btn:hover,
        .quick-amount-btn.active {
            background: #343a40;
            color: white;
        }
        
        .success-animation {
            animation: bounce 0.6s;
        }
        
        @keyframes bounce {
            0%, 20%, 60%, 100% { transform: translateY(0); }
            40% { transform: translateY(-20px); }
            80% { transform: translateY(-10px); }
        }
        
        
        .manual-input-section {
            margin-top: 20px;
            padding: 20px;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            background: #f8f9fa;
        }

        /* í¬ì¸íŠ¸ ì´ë ¥ ìŠ¤íƒ€ì¼ */
        .point-history-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .point-history-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .point-history-list {
            padding: 0;
        }

        .point-history-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .point-history-item {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 15px 20px;
            transition: background-color 0.2s ease;
            margin-bottom: 8px;
            border-radius: 6px;
        }

        .point-history-item:last-child {
            border-bottom: none;
        }

        .point-history-item:hover {
            background-color: #f8f9fa;
        }

        .point-history-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 8px;
        }

        .point-history-date {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .point-history-description {
            font-size: 0.9rem;
            color: #495057;
            margin-bottom: 4px;
        }

        .point-history-amount {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .point-history-amount.positive {
            color: #495057;
        }

        .point-history-amount.negative {
            color: #6c757d;
        }

        /* ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ìŠ¤íƒ€ì¼ (ZXing ê°œì„ ) */
        .barcode-scanner-container {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            min-height: 400px;
            border: 2px solid #343a40;
        }

        .scanner-viewport {
            position: relative;
            width: 100%;
            height: 400px;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #barcode-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .scanner-frame {
            width: 250px;
            height: 150px;
            position: relative;
        }

        .scanner-corners {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid #fff;
        }

        .corner.top-left {
            top: 0;
            left: 0;
            border-right: none;
            border-bottom: none;
            border-top-left-radius: 8px;
        }

        .corner.top-right {
            top: 0;
            right: 0;
            border-left: none;
            border-bottom: none;
            border-top-right-radius: 8px;
        }

        .corner.bottom-left {
            bottom: 0;
            left: 0;
            border-right: none;
            border-top: none;
            border-bottom-left-radius: 8px;
        }

        .corner.bottom-right {
            bottom: 0;
            right: 0;
            border-left: none;
            border-top: none;
            border-bottom-right-radius: 8px;
        }

        .scanner-status {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 15;
        }

        .status-text {
            color: #fff;
            font-weight: 500;
            margin-bottom: 10px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .scanner-loading {
            display: flex;
            justify-content: center;
        }

        #barcode-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .manual-input-section {
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        /* ìŠ¤ìº” ì„±ê³µ ì• ë‹ˆë©”ì´ì…˜ */
        .scan-success {
            animation: scanSuccess 0.5s ease-in-out;
        }

        @keyframes scanSuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); background: rgba(40, 167, 69, 0.3); }
            100% { transform: scale(1); }
        }

        /* ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ ìŠ¤íƒ€ì¼ */
        .camera-permission {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .camera-permission i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #adb5bd;
        }

        /* CSV ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-csv-download {
            transition: all 0.2s ease;
            border-color: #6c757d;
            color: #6c757d;
        }
        .btn-csv-download:hover {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-csv-download:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .btn-csv-download i {
            transition: transform 0.2s ease;
        }
        .btn-csv-download:hover i {
            transform: translateY(-1px);
        }

        .point-history-item:hover {
            background-color: #f8f9fa;
        }

        .point-description {
            font-weight: 600;
            color: #343a40;
            margin-bottom: 5px;
        }

        /* í¬ì¸íŠ¸ ì´ìš©í˜„í™© ìŠ¤íƒ€ì¼ */
        .point-history-overview {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .stats-summary {
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 900;
            color: #343a40;
            margin-bottom: 5px;
        }

        .stat-number.positive {
            color: #343a40 !important;
        }

        .stat-number.negative {
            color: #6c757d !important;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 500;
        }

        .history-list-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }

        .history-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .history-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #6c757d;
        }

        .history-item.earn {
            border-left-color: #343a40;
        }

        .history-item.use {
            border-left-color: #6c757d;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .history-customer {
            font-weight: 600;
            color: #343a40;
            font-size: 0.9rem;
        }

        .history-date {
            color: #6c757d;
            font-size: 0.8rem;
        }

        .history-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-description {
            flex: 1;
            color: #495057;
            font-size: 0.9rem;
        }

        .history-points {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .history-points.earn {
            color: #343a40 !important;
        }

        .history-points.use {
            color: #6c757d !important;
        }
        
        /* ì•Œë¦¼ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes slideInRight {
            0% {
                transform: translateX(100%) scale(0.8);
                opacity: 0;
            }
            60% {
                transform: translateX(-10px) scale(1.05);
                opacity: 0.8;
            }
            100% {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            0% {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateX(100%) scale(0.8);
                opacity: 0;
            }
        }
        
        /* ëª¨ë‹¬ ë°±ë“œë¡­ ê°œì„  */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        .point-amount {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .point-amount.positive {
            color: #343a40 !important;
            font-weight: bold !important;
        }

        .point-amount.negative {
            color: #6c757d !important;
            font-weight: bold !important;
        }
    </style>
</head>

<body>

    <div class="tablet-container">
        <!-- Store Header -->
        <div class="store-header">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <img src="assets/img/logo.png" alt="Aether Logo" class="img-fluid" style="max-height: 60px;">
                </div>
                <div class="col-md-6">
                    <h2 class="mb-0 japanese-heading">åº—èˆ—ç”¨ãƒã‚¤ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ </h2>
                    <p class="mb-0 japanese-text">QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ & ãƒã‚¤ãƒ³ãƒˆç®¡ç†</p>
                </div>
                <div class="col-md-3 text-end">
                    <div class="japanese-text">
                        <div id="current-date"></div>
                        <div id="current-time" style="font-size: 1.2rem; font-weight: bold;"></div>
                        <div class="mt-2">
                            <button class="btn btn-outline-light btn-sm" onclick="logoutStore()">
                                <i class="fas fa-sign-out-alt me-1"></i>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- QR Scanner Section -->
        <div class="scanner-section" id="scanner-section">
            <h3 class="japanese-heading mb-4">
                <i class="fas fa-qrcode me-2"></i>QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³
            </h3>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="scan-overlay">
                        <video id="scanner-video" autoplay muted playsinline></video>
                        <div class="scan-line"></div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-dark btn-large" onclick="startScanner()">
                            <i class="fas fa-camera me-2"></i>ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹
                        </button>
                        <button class="btn btn-secondary btn-large" onclick="stopScanner()">
                            <i class="fas fa-stop me-2"></i>åœæ­¢
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="manual-input-section">
                        <h5 class="japanese-heading">ãƒ¡ãƒ¼ãƒ«æ¤œç´¢</h5>
                        <p class="japanese-text text-muted">QRã‚³ãƒ¼ãƒ‰ãŒèª­ã¿å–ã‚Œãªã„å ´åˆ</p>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="manual-qr-input" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                            <button class="btn btn-outline-secondary" onclick="processManualQR()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>

        <!-- Customer Information -->
        <div class="customer-info" id="customer-info">
            <h3 class="japanese-heading mb-4">
                <i class="fas fa-user me-2"></i>ãŠå®¢æ§˜æƒ…å ±
            </h3>
            
            <div class="customer-card">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="mb-1" id="customer-name">ãŠå®¢æ§˜å</h4>
                        <p class="mb-0" id="customer-email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</p>
                        <small id="customer-phone">é›»è©±ç•ªå·</small>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="japanese-text">ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆ</div>
                        <div class="points-display" id="customer-points">0</div>
                        <div class="japanese-text">Point</div>
                    </div>
                </div>
            </div>

            <!-- í¬ì¸íŠ¸ ì´ë ¥ ì„¹ì…˜ -->
            <div class="point-history-section mt-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="japanese-heading mb-0">
                        <i class="fas fa-history me-2"></i>ãƒã‚¤ãƒ³ãƒˆå±¥æ­´
                    </h5>
                    <button class="btn btn-outline-secondary btn-sm" onclick="refreshCustomerPointHistory()">
                        <i class="fas fa-sync-alt me-1"></i>æ›´æ–°
                    </button>
                </div>
                
                <div class="point-history-container">
                    <div id="customer-point-history" class="point-history-list">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-history fa-2x mb-2"></i>
                            <p class="japanese-text">ãƒã‚¤ãƒ³ãƒˆå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center">
                <button class="btn btn-outline-secondary btn-large" onclick="resetScanner()">
                    <i class="fas fa-arrow-left me-2"></i>æˆ»ã‚‹
                </button>
            </div>
        </div>

        <!-- í¬ì¸íŠ¸ ì´ìš©í˜„í™© ì„¹ì…˜ (í•­ìƒ í‘œì‹œ) -->
        <div class="point-history-overview-main" id="point-history-overview-main">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="japanese-heading mb-0">
                    <i class="fas fa-chart-line me-2"></i>ãƒã‚¤ãƒ³ãƒˆåˆ©ç”¨çŠ¶æ³
            </h3>
                <div>
                    <button class="btn btn-secondary btn-sm me-2" onclick="refreshPointHistory()">
                        <i class="fas fa-sync-alt me-1"></i>ãƒ‡ãƒ¼ã‚¿æ›´æ–°
                    </button>
                    <button class="btn btn-dark btn-sm" onclick="initializePointHistory()">
                        <i class="fas fa-play me-1"></i>æ‰‹å‹•åˆæœŸåŒ–
                    </button>
                </div>
            </div>

            <!-- ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ ë° í•„í„° ì„¹ì…˜ -->
            <div class="filter-section mb-4">
                <div class="row">
                    <div class="col-md-4">
                        <div class="d-flex align-items-center">
                            <button class="btn btn-outline-secondary btn-sm me-2" onclick="navigateDate(-1)">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="date-display text-center flex-grow-1">
                                <h5 class="japanese-heading mb-0" id="current-date-display">ä»Šæ—¥</h5>
                                <small class="text-muted japanese-text" id="date-range-display"></small>
                            </div>
                            <button class="btn btn-outline-secondary btn-sm ms-2" onclick="navigateDate(1)">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label japanese-text">æœŸé–“ã‚¿ã‚¤ãƒ—</label>
                        <select class="form-select" id="period-type-filter" onchange="changePeriodType()">
                            <option value="day" selected>æ—¥åˆ¥</option>
                            <option value="week">é€±åˆ¥</option>
                            <option value="month">æœˆåˆ¥</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label japanese-text">å–å¼•ã‚¿ã‚¤ãƒ—</label>
                        <select class="form-select" id="type-filter" onchange="filterPointHistory()">
                            <option value="all">å…¨ã¦</option>
                            <option value="earn">ä»˜ä¸ã®ã¿</option>
                            <option value="use">ä½¿ç”¨ã®ã¿</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-outline-secondary btn-sm" onclick="goToToday()">
                            <i class="fas fa-calendar-day me-1"></i>ä»Šæ—¥
                        </button>
                    </div>
                </div>
            </div>

            <!-- í†µê³„ ìš”ì•½ -->
            <div class="stats-summary mb-4">
                <div class="row">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number" id="total-transactions">0</div>
                            <div class="stat-label japanese-text">ä»˜ä¸å›æ•°</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number positive" id="total-earned">0</div>
                            <div class="stat-label japanese-text">ä»˜ä¸ãƒã‚¤ãƒ³ãƒˆ</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number negative" id="total-used">0</div>
                            <div class="stat-label japanese-text">ä½¿ç”¨ãƒã‚¤ãƒ³ãƒˆ</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number" id="total-customers">0</div>
                            <div class="stat-label japanese-text">å–å¼•é¡§å®¢æ•°</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- í¬ì¸íŠ¸ ì´ë ¥ ë¦¬ìŠ¤íŠ¸ -->
            <div class="history-list-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="japanese-heading mb-0">å–å¼•å±¥æ­´</h5>
                    <button class="btn btn-outline-secondary btn-sm btn-csv-download" onclick="downloadPointHistoryCSV()" title="CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
                        <i class="fas fa-download me-1"></i>CSV
                    </button>
                </div>
                <div class="history-list" id="point-history-list">
                    <div class="text-center py-4">
                        <div class="spinner-border text-secondary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="japanese-text mt-2">å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Point Actions (QR ìŠ¤ìº” í›„ì—ë§Œ í‘œì‹œ) -->
        <div class="point-actions" id="point-actions" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="japanese-heading mb-0">
                    <i class="fas fa-coins me-2"></i>ãƒã‚¤ãƒ³ãƒˆç®¡ç†
                </h3>
                <button class="btn btn-outline-secondary btn-sm" onclick="resetScanner()">
                    <i class="fas fa-arrow-left me-1"></i>æˆ»ã‚‹
                </button>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="japanese-heading mb-0">è³¼å…¥ãƒã‚¤ãƒ³ãƒˆä»˜ä¸</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label japanese-text">è³¼å…¥é‡‘é¡ï¼ˆå††ï¼‰</label>
                                <input type="number" class="form-control amount-input" id="purchase-amount" placeholder="0" min="0">
                            </div>
                            
                            <div class="quick-amounts">
                                <div class="quick-amount-btn" onclick="setPurchaseAmount(1000)">Â¥1,000</div>
                                <div class="quick-amount-btn" onclick="setPurchaseAmount(2000)">Â¥2,000</div>
                                <div class="quick-amount-btn" onclick="setPurchaseAmount(3000)">Â¥3,000</div>
                                <div class="quick-amount-btn" onclick="setPurchaseAmount(5000)">Â¥5,000</div>
                                <div class="quick-amount-btn" onclick="setPurchaseAmount(10000)">Â¥10,000</div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label japanese-text">ä»˜ä¸ãƒã‚¤ãƒ³ãƒˆï¼ˆ3%ï¼‰</label>
                                <div class="input-group">
                                    <input type="number" class="form-control amount-input" id="points-to-add" readonly>
                                    <span class="input-group-text">P</span>
                                </div>
                            </div>
                            
                            <button class="btn btn-dark btn-large w-100" onclick="addPurchasePoints()">
                                <i class="fas fa-plus me-2"></i>ãƒã‚¤ãƒ³ãƒˆä»˜ä¸
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="japanese-heading mb-0">æ‰‹å‹•ãƒã‚¤ãƒ³ãƒˆæ“ä½œ</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label japanese-text">ãƒã‚¤ãƒ³ãƒˆæ•°</label>
                                <input type="number" class="form-control amount-input" id="manual-points" placeholder="0" min="0">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label japanese-text">ç†ç”±</label>
                                <select class="form-control" id="point-reason" onchange="toggleProductInfoField()">
                                    <option value="åº—èˆ—è³¼å…¥">åº—èˆ—è³¼å…¥</option>
                                    <option value="ç‰¹åˆ¥ä»˜ä¸">ç‰¹åˆ¥ä»˜ä¸</option>
                                    <option value="ã‚¤ãƒ™ãƒ³ãƒˆç‰¹å…¸">ã‚¤ãƒ™ãƒ³ãƒˆç‰¹å…¸</option>
                                    <option value="èª•ç”Ÿæ—¥ç‰¹å…¸">èª•ç”Ÿæ—¥ç‰¹å…¸</option>
                                    <option value="ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³">ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³</option>
                                    <option value="ãƒã‚¤ãƒ³ãƒˆä½¿ç”¨">ãƒã‚¤ãƒ³ãƒˆä½¿ç”¨</option>
                                    <option value="ä¿®æ­£">ä¿®æ­£</option>
                                    <option value="ãã®ä»–">ãã®ä»–</option>
                                </select>
                            </div>
                            
                            <!-- ìƒí’ˆ ì •ë³´ ì…ë ¥ í•„ë“œ (í¬ì¸íŠ¸ ì‚¬ìš© ì‹œì—ë§Œ í‘œì‹œ) -->
                            <div class="mb-3" id="product-info-field" style="display: none;">
                                <label for="product-barcode" class="form-label japanese-text">å•†å“æƒ…å ±</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="product-barcode" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã¾ãŸã¯å•†å“åã‚’å…¥åŠ›">
                                    <button class="btn btn-outline-secondary" type="button" onclick="scanProductBarcode()">
                                        <i class="fas fa-barcode"></i>
                                    </button>
                                </div>
                                <small class="form-text text-muted japanese-text">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ã‹ã€å•†å“åã‚’ç›´æ¥å…¥åŠ›ã—ã¦ãã ã•ã„</small>
                            </div>
                            
                            <div class="row">
                                <div class="col-6">
                                    <button class="btn btn-secondary w-100" onclick="addManualPoints()">
                                        <i class="fas fa-plus me-2"></i>è¿½åŠ 
                                    </button>
                                </div>
                                <div class="col-6">
                                    <button class="btn btn-outline-secondary w-100" onclick="subtractManualPoints()">
                                        <i class="fas fa-minus me-2"></i>å·®å¼•
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <button class="btn btn-outline-secondary btn-large" onclick="backToCustomerInfo()">
                    <i class="fas fa-arrow-left me-2"></i>ãŠå®¢æ§˜æƒ…å ±ã«æˆ»ã‚‹
                </button>
                <button class="btn btn-dark btn-large" onclick="resetScanner()">
                    <i class="fas fa-home me-2"></i>æœ€åˆã«æˆ»ã‚‹
                </button>
            </div>
        </div>

        <!-- Today's Transactions -->
        <div class="card" style="display: none;" id="transactions-section">
            <div class="card-header">
                <h5 class="japanese-heading mb-0">
                    <i class="fas fa-history me-2"></i>æœ¬æ—¥ã®å–å¼•å±¥æ­´
                </h5>
            </div>
            <div class="card-body">
                <div class="transaction-history" id="transaction-history">
                    <!-- ì·¨å¼• ë‚´ì—­ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script src="assets/js/jquery-1.11.0.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/firebase-config.js"></script>
    
    <!-- QR Code Scanner Library -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <!-- ZXing Barcode Scanner Library -->
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest/umd/index.min.js"></script>


    <script>
        let scanner = null;
        let currentCustomer = null;
        let todayStats = {
            customers: 0,
            points: 0,
            transactions: []
        };
        let realTimeListener = null; // ì‹¤ì‹œê°„ ë™ê¸°í™” ë¦¬ìŠ¤ë„ˆ

        // ìŠ¤í† ì–´ ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
        async function logoutStore() {
            try {
                console.log('=== ìŠ¤í† ì–´ ë¡œê·¸ì•„ì›ƒ ì‹œì‘ ===');
                
                // í™•ì¸ ëª¨ë‹¬ í‘œì‹œ
                createCustomConfirmModal(
                    'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆç¢ºèª',
                    'åº—èˆ—ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ',
                    'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
                    'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
                    async () => {
                        console.log('ë¡œê·¸ì•„ì›ƒ í™•ì¸ë¨');
                        
                        // Firebase Auth ë¡œê·¸ì•„ì›ƒ
                        if (firebase && firebase.auth) {
                            await firebase.auth().signOut();
                            console.log('Firebase Auth ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
                        }
                        
                        // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
                        window.currentStoreUser = null;
                        currentCustomer = null;
                        
                        // ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
                        if (realTimeListener) {
                            realTimeListener();
                            realTimeListener = null;
                        }
                        
                        // ìŠ¤ìºë„ˆ ì •ë¦¬
                        if (scanner) {
                            scanner.stop();
                            scanner = null;
                        }
                        
                        showStoreAlert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚', 'success');
                        
                        // ìŠ¤í† ì–´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                        setTimeout(() => {
                            console.log('ğŸš€ ìŠ¤í† ì–´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
                            window.location.href = 'store-register.html';
                        }, 1500);
                        
                    },
                    () => {
                        console.log('ë¡œê·¸ì•„ì›ƒ ì·¨ì†Œë¨');
                    }
                );
                
            } catch (error) {
                console.error('ìŠ¤í† ì–´ ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                showStoreAlert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'danger');
            }
        }
        
        // ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ ìƒì„± (ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì™€ ë™ì¼)
        function createCustomConfirmModal(title, message, confirmText, cancelText, onConfirm, onCancel) {
            const modalId = 'customConfirmModal';
            
            // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
            const existingModal = document.getElementById(modalId);
            if (existingModal) {
                existingModal.remove();
            }
            
            const modalHtml = `
                <div class="modal fade" id="${modalId}" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px; background: #ffffff; overflow: hidden;">
                            <div class="modal-body p-5">
                                <div class="text-center">
                                    <div class="mb-4">
                                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; border: 3px solid #dee2e6;">
                                            <i class="fas fa-question-circle" style="font-size: 2.5rem; color: #495057;"></i>
                                        </div>
                                    </div>
                                    <h4 class="modal-title mb-3" style="color: #212529; font-weight: 700; font-size: 1.5rem;">${title}</h4>
                                    <div class="mb-4" style="background: #f8f9fa; border-radius: 12px; padding: 20px; border-left: 4px solid #6c757d;">
                                        <p class="mb-0" style="color: #495057; font-size: 1.1rem; line-height: 1.6;">${message}</p>
                                    </div>
                                </div>
                                <div class="d-flex gap-3 justify-content-center">
                                    <button type="button" class="btn btn-outline-secondary px-5 py-3" style="border-radius: 12px; font-weight: 600; font-size: 1rem; min-width: 160px; border-width: 2px; white-space: nowrap;" onclick="closeCustomConfirmModal(false)">
                                        <i class="fas fa-times me-2"></i>${cancelText || 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'}
                                    </button>
                                    <button type="button" class="btn btn-dark px-5 py-3" style="border-radius: 12px; font-weight: 600; font-size: 1rem; min-width: 160px; background: linear-gradient(135deg, #343a40 0%, #212529 100%); border: none; white-space: nowrap;" onclick="closeCustomConfirmModal(true)">
                                        <i class="fas fa-check me-2"></i>${confirmText || 'ç¢ºèª'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById(modalId));
            
            // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì €ì¥
            window.currentConfirmModal = {
                modal: modal,
                onConfirm: onConfirm,
                onCancel: onCancel
            };
            
            modal.show();
        }
        
        // ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ ë‹«ê¸°
        function closeCustomConfirmModal(confirmed) {
            const modalElement = document.getElementById('customConfirmModal');
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                modal.hide();
                
                if (confirmed && window.currentConfirmModal && window.currentConfirmModal.onConfirm) {
                    window.currentConfirmModal.onConfirm();
                } else if (!confirmed && window.currentConfirmModal && window.currentConfirmModal.onCancel) {
                    window.currentConfirmModal.onCancel();
                }
                
                // ì •ë¦¬
                window.currentConfirmModal = null;
                setTimeout(() => {
                    if (modalElement && modalElement.parentNode) {
                        modalElement.remove();
                    }
                }, 300);
            }
        }
        
        // ìŠ¤í† ì–´ ì•Œë¦¼ í‘œì‹œ (ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì™€ ë™ì¼í•œ ìŠ¤íƒ€ì¼)
        function showStoreAlert(message, type = 'info') {
            console.log('showStoreAlert í˜¸ì¶œë¨:', message, type);
            
            // ëª¨ë…¸í†¤ ìƒ‰ìƒ ë§¤í•‘
            const colorMap = {
                'success': { bg: '#f8f9fa', border: '#343a40', text: '#343a40' },
                'danger': { bg: '#f8f9fa', border: '#6c757d', text: '#343a40' },
                'warning': { bg: '#f8f9fa', border: '#495057', text: '#343a40' },
                'info': { bg: '#f8f9fa', border: '#6c757d', text: '#343a40' }
            };
            
            const colors = colorMap[type] || colorMap['info'];
            
            // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
            const existingAlert = document.querySelector('.store-custom-alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // ìƒˆ ì•Œë¦¼ ìƒì„±
            const alertDiv = document.createElement('div');
            alertDiv.className = 'store-custom-alert';
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 350px;
                max-width: 450px;
                background: ${colors.bg};
                border: 2px solid ${colors.border};
                border-radius: 16px;
                padding: 20px 24px;
                color: ${colors.text};
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                font-size: 15px;
                font-weight: 500;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
                display: flex;
                align-items: center;
                justify-content: space-between;
                animation: slideInRight 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
                backdrop-filter: blur(10px);
                border-left: 4px solid ${colors.border};
            `;
            
            // ì•„ì´ì½˜ ì„¤ì •
            const iconMap = {
                'success': 'fas fa-check-circle',
                'danger': 'fas fa-exclamation-triangle',
                'warning': 'fas fa-exclamation-circle',
                'info': 'fas fa-info-circle'
            };
            
            const icon = iconMap[type] || iconMap['info'];
            
            alertDiv.innerHTML = `
                <div style="display: flex; align-items: center; flex: 1;">
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, ${colors.bg} 0%, #e9ecef 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 16px; border: 2px solid ${colors.border};">
                        <i class="${icon}" style="font-size: 18px; color: ${colors.text};"></i>
                    </div>
                    <span style="flex: 1; line-height: 1.4;">${message}</span>
                </div>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; color: ${colors.text}; cursor: pointer; font-size: 20px; margin-left: 12px; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='none'">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // 5ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.style.animation = 'slideOutRight 0.4s cubic-bezier(0.55, 0.085, 0.68, 0.53)';
                    alertDiv.style.transform = 'translateX(100%)';
                    alertDiv.style.opacity = '0';
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.remove();
                        }
                    }, 400);
                }
            }, 5000);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('=== ìŠ¤í† ì–´ íƒœë¸”ë¦¿ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘ ===');
            
            // Firebase ì´ˆê¸°í™” ëŒ€ê¸°
            await waitForFirebaseInit();
            console.log('âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ');
                
            // ì¦‰ì‹œ í™•ì¸ ë¡œì§ ì œê±°ë¨ - onAuthStateChangedì—ì„œ ì²˜ë¦¬
            
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            setupPurchaseAmountListener();
            
            // ì¤‘ë³µëœ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¨
            
            // ê¸°ì¡´ ì½”ë“œ ì œê±°
            // ê¸°ì¡´ ì½”ë“œ ì œê±°ë¨
            /*
                if (!userDoc.exists) {
                    console.log('âŒ ì‚¬ìš©ì ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ - ì¦‰ì‹œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
                    showStoreAlert('åº—èˆ—ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'warning');
                    setTimeout(() => {
                        window.location.href = 'store-register.html';
                    }, 2000);
                    return;
                }
                
                const userData = userDoc.data();
                const storeRole = userData.storeRole;
                const isStoreActive = userData.isStoreActive;
                
                if (!storeRole || !isStoreActive) {
                    console.log('âŒ ìŠ¤í† ì–´ ê¶Œí•œ ì—†ìŒ ë˜ëŠ” ë¹„í™œì„±í™”ë¨ - ì¦‰ì‹œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
                    showStoreAlert('åº—èˆ—ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'warning');
                    setTimeout(() => {
                        window.location.href = 'store-register.html';
                    }, 2000);
                    return;
                }
                
                console.log('âœ… ì¦‰ì‹œ ìŠ¤í† ì–´ ê¶Œí•œ í™•ì¸ ì™„ë£Œ:', storeRole);
                
            } catch (error) {
                console.error('âŒ ì¦‰ì‹œ ìŠ¤í† ì–´ ê¶Œí•œ í™•ì¸ ì˜¤ë¥˜:', error);
                showStoreAlert('åº—èˆ—ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'warning');
                setTimeout(() => {
                    window.location.href = 'store-register.html';
                }, 2000);
                return;
            }
            */
            
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            setupPurchaseAmountListener();
            
            // Firebase Auth ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆë¡œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
            let authStateChecked = false;
            
            const unsubscribe = firebase.auth().onAuthStateChanged(async (user) => {
                if (authStateChecked) return; // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
                authStateChecked = true;
                
                console.log('ğŸ” Firebase Auth ìƒíƒœ ë³€ê²½ ê°ì§€:', user ? user.email : 'null');
                
                if (!user) {
                    console.log('âŒ Firebase Auth ìƒíƒœ í™•ì¸ - ë¯¸ë¡œê·¸ì¸');
                    showStoreAlert('åº—èˆ—ã‚·ã‚¹ãƒ†ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚', 'warning');
                    setTimeout(() => {
                        console.log('ğŸš€ ë¯¸ë¡œê·¸ì¸ ì§ì ‘ ì ‘ì† ì°¨ë‹¨ - ìŠ¤í† ì–´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
                        window.location.href = 'store-register.html';
                    }, 2000);
                    unsubscribe(); // ë¦¬ìŠ¤ë„ˆ í•´ì œ
                    return;
                }
                
                console.log('âœ… Firebase Auth ìƒíƒœ í™•ì¸ ì™„ë£Œ - ë¡œê·¸ì¸ë¨:', user.email);
                
                // ìŠ¤í† ì–´ ì‚¬ìš©ì ì •ë³´ ì„¤ì •
                await setupStoreUser();
                
                // ì„±ê³µ ì‹œì—ë„ ë¦¬ìŠ¤ë„ˆ í•´ì œ
                unsubscribe();
            });
            
            // 5ì´ˆ í›„ì—ë„ Auth ìƒíƒœê°€ í™•ì¸ë˜ì§€ ì•Šìœ¼ë©´ ë¦¬ë‹¤ì´ë ‰íŠ¸
            setTimeout(() => {
                if (!authStateChecked) {
                    console.log('âŒ Firebase Auth ìƒíƒœ í™•ì¸ íƒ€ì„ì•„ì›ƒ');
                    showStoreAlert('èªè¨¼çŠ¶æ…‹ã®ç¢ºèªã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã€‚', 'warning');
                    unsubscribe();
                    setTimeout(() => {
                        window.location.href = 'store-register.html';
                    }, 2000);
                }
            }, 5000);
            
            // Firebase ì™„ì „ ì´ˆê¸°í™” í›„ í¬ì¸íŠ¸ ì´ìš©í˜„í™© ì´ˆê¸°í™”
            const initPointHistory = (retryCount = 0) => {
                try {
                    console.log(`=== í¬ì¸íŠ¸ ì´ìš©í˜„í™© ì´ˆê¸°í™” ì‹œë„ ${retryCount + 1}íšŒ ===`);
                    
                    // Firebaseê°€ ì™„ì „íˆ ì´ˆê¸°í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸
                    const firebaseStatus = {
                        firebase: !!firebase,
                        firestore: !!(firebase && firebase.firestore),
                        auth: !!(firebase && firebase.auth)
                    };
                    
                    console.log('Firebase ìƒíƒœ:', firebaseStatus);
                    
                    if (firebase && firebase.firestore && firebase.auth) {
                        console.log('âœ… Firebase ì™„ì „ ì´ˆê¸°í™” í™•ì¸ë¨, í¬ì¸íŠ¸ ì´ìš©í˜„í™© ì´ˆê¸°í™” ì‹œì‘');
                        initializePointHistory();
                    } else {
                        console.log('â³ Firebase ì•„ì§ ì´ˆê¸°í™” ì¤‘, 1ì´ˆ í›„ ì¬ì‹œë„...');
                        if (retryCount < 10) {
                            setTimeout(() => initPointHistory(retryCount + 1), 1000);
                        } else {
                            console.error('âŒ í¬ì¸íŠ¸ ì´ìš©í˜„í™© ì´ˆê¸°í™” ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼');
                        }
                    }
                } catch (error) {
                    console.error('âŒ í¬ì¸íŠ¸ ì´ìš©í˜„í™© ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                    if (retryCount < 5) {
                        setTimeout(() => initPointHistory(retryCount + 1), 2000);
                    }
                }
            };
            
            // 3ì´ˆ í›„ í¬ì¸íŠ¸ ì´ìš©í˜„í™© ì´ˆê¸°í™” ì‹œì‘
            console.log('í¬ì¸íŠ¸ ì´ìš©í˜„í™© ì´ˆê¸°í™” íƒ€ì´ë¨¸ ì„¤ì • (3ì´ˆ í›„)');
            setTimeout(() => {
                console.log('íƒ€ì´ë¨¸ ì‹¤í–‰: í¬ì¸íŠ¸ ì´ìš©í˜„í™© ì´ˆê¸°í™” ì‹œë„');
                initPointHistory();
            }, 3000);
            
            // Firebaseê°€ ì™„ì „íˆ ì´ˆê¸°í™”ëœ í›„ í†µê³„ ë¡œë“œ
            setTimeout(async () => {
                try {
                    await loadTodayStats();
                } catch (error) {
                    console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨ (ì¬ì‹œë„):', error);
                    // 1ì´ˆ í›„ ì¬ì‹œë„
                    setTimeout(async () => {
                        try {
                            await loadTodayStats();
                        } catch (retryError) {
                            console.error('í†µê³„ ë¡œë“œ ì¬ì‹œë„ ì‹¤íŒ¨:', retryError);
                        }
                    }, 1000);
                }
            }, 500);
            
            // URLì—ì„œ QRì½”ë“œ í™•ì¸
            checkUrlForQRCode();
            
            console.log('=== ìŠ¤í† ì–´ íƒœë¸”ë¦¿ í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ ===');
        });

        // Firebase ì´ˆê¸°í™” ëŒ€ê¸° í•¨ìˆ˜ (ë” ì•ˆì „í•œ ë²„ì „)
        async function waitForFirebaseInit() {
            return new Promise((resolve) => {
                console.log('Firebase ì´ˆê¸°í™” ëŒ€ê¸° ì‹œì‘...');
                let attempts = 0;
                const maxAttempts = 100; // 10ì´ˆ ëŒ€ê¸°
                
                const checkFirebase = setInterval(() => {
                    attempts++;
                    
                    // Firebaseê°€ ì™„ì „íˆ ì´ˆê¸°í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸
                    if (window.firebase && 
                        firebase.auth && 
                        firebase.firestore && 
                        typeof firebase.auth().currentUser !== 'undefined') {
                        
                        clearInterval(checkFirebase);
                        console.log('âœ… Firebase ì™„ì „ ì´ˆê¸°í™” ì™„ë£Œ');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkFirebase);
                        console.error('âŒ Firebase ì´ˆê¸°í™” íƒ€ì„ì•„ì›ƒ');
                        // íƒ€ì„ì•„ì›ƒ ì‹œì—ë„ ë¦¬ë‹¤ì´ë ‰íŠ¸
                        showStoreAlert('Firebase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã€‚', 'danger');
                        setTimeout(() => {
                            window.location.href = 'store-register.html';
                        }, 2000);
                        resolve();
                    } else if (attempts % 10 === 0) {
                        console.log(`Firebase ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘... (${attempts}/100)`);
                    }
                }, 100);
            });
        }

        // ìŠ¤í† ì–´ ì‚¬ìš©ì ì •ë³´ ì„¤ì • (ì‹¤ì œ ìŠ¤í† ì–´ ê¶Œí•œ í™•ì¸ í¬í•¨)
        async function setupStoreUser() {
            try {
                console.log('=== ìŠ¤í† ì–´ ì‚¬ìš©ì ì •ë³´ ì„¤ì • ì‹œì‘ ===');
                
                // Firebase Authê°€ ì™„ì „íˆ ì´ˆê¸°í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸
                if (!firebase || !firebase.auth || !firebase.firestore) {
                    console.log('âŒ Firebaseê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
                    showStoreAlert('Firebase ì´ˆê¸°í™” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”ã€‚', 'warning');
                    setTimeout(() => {
                        window.location.href = 'store-register.html';
                    }, 2000);
                    return;
                }
                
                const currentUser = firebase.auth().currentUser;
                
                if (!currentUser) {
                    console.log('âŒ ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ì‚¬ìš©ì - ìŠ¤í† ì–´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
                    showStoreAlert('åº—èˆ—ã‚·ã‚¹ãƒ†ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚', 'warning');
                    setTimeout(() => {
                        console.log('ğŸš€ ì§ì ‘ ì ‘ì† ì°¨ë‹¨ - ìŠ¤í† ì–´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
                        window.location.href = 'store-register.html';
                    }, 2000);
                    return;
                }
                
                console.log('âœ… ë¡œê·¸ì¸ëœ ì‚¬ìš©ì í™•ì¸ë¨:', currentUser.email);
                
                // Firestoreì—ì„œ ì‹¤ì œ ìŠ¤í† ì–´ ê¶Œí•œ í™•ì¸
                console.log('ğŸ” Firestoreì—ì„œ ìŠ¤í† ì–´ ê¶Œí•œ í™•ì¸ ì¤‘...');
                const db = firebase.firestore();
                console.log('ğŸ” Firestore DB ê°ì²´:', typeof db);
                console.log('ğŸ” ì‚¬ìš©ì ì´ë©”ì¼:', currentUser.email);
                
                const storeUserDoc = await db.collection('storeuser').doc(currentUser.email).get();
                console.log('ğŸ” Firestore ë¬¸ì„œ ì¡°íšŒ ì™„ë£Œ:', storeUserDoc.exists);
                
                if (!storeUserDoc.exists) {
                    console.log('âŒ ìŠ¤í† ì–´ ì‚¬ìš©ì ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ');
                    showStoreAlert('åº—èˆ—ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'warning');
                    setTimeout(() => {
                        window.location.href = 'store-register.html';
                    }, 2000);
                    return;
                }
                
                const storeUserData = storeUserDoc.data();
                console.log('ğŸ“‹ ìŠ¤í† ì–´ ì‚¬ìš©ì ë°ì´í„°:', storeUserData);
                
                // ìŠ¤í† ì–´ ê¶Œí•œ í™•ì¸
                const storeRole = storeUserData.storeRole || storeUserData.role;
                const isStoreActive = storeUserData.isStoreActive || storeUserData.isActive;
                const storeId = storeUserData.storeId;
                const storePermissions = storeUserData.permissions || [];
                
                console.log('ğŸ” ìŠ¤í† ì–´ ê¶Œí•œ ì •ë³´:', {
                    storeRole,
                    isStoreActive,
                    storeId,
                    storePermissions
                });
                
                // ìŠ¤í† ì–´ ê¶Œí•œì´ ì—†ê±°ë‚˜ ë¹„í™œì„±í™”ëœ ê²½ìš°
                if (!storeRole || !isStoreActive) {
                    console.log('âŒ ìŠ¤í† ì–´ ê¶Œí•œ ì—†ìŒ ë˜ëŠ” ë¹„í™œì„±í™”ë¨');
                    console.log('ğŸ” ê¶Œí•œ í™•ì¸ ê²°ê³¼:');
                    console.log('  - storeRole:', storeRole, '(íƒ€ì…:', typeof storeRole, ')');
                    console.log('  - isStoreActive:', isStoreActive, '(íƒ€ì…:', typeof isStoreActive, ')');
                    console.log('  - ì¡°ê±´: !storeRole =', !storeRole, ', !isStoreActive =', !isStoreActive);
                    
                    showStoreAlert('åº—èˆ—ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'warning');
                    setTimeout(() => {
                        window.location.href = 'store-register.html';
                    }, 2000);
                    return;
                }
                
                console.log('âœ… ìŠ¤í† ì–´ ê¶Œí•œ í™•ì¸ ì™„ë£Œ - ì ‘ê·¼ í—ˆìš©');
                
                console.log('âœ… ìŠ¤í† ì–´ ê¶Œí•œ í™•ì¸ ì™„ë£Œ:', storeRole);
                
                // ìŠ¤í† ì–´ ì‚¬ìš©ì ì •ë³´ ì„¤ì •
                const storeUserInfo = {
                    email: currentUser.email,
                    name: storeUserData.name || currentUser.displayName || currentUser.email.split('@')[0],
                    role: storeRole,
                    storeId: storeId || 'main_store',
                    permissions: storePermissions.length > 0 ? storePermissions : ['point_management'],
                    isStoreActive: isStoreActive
                };
                
                console.log('âœ… ìŠ¤í† ì–´ ì‚¬ìš©ì ì •ë³´ ì„¤ì • ì™„ë£Œ:', storeUserInfo);
                
                // ìŠ¤í† ì–´ ì‚¬ìš©ì ì •ë³´ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                window.currentStoreUser = storeUserInfo;
                
                // í—¤ë”ì— ìŠ¤í† ì–´ ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
                updateStoreUserDisplay(storeUserInfo);
                
            } catch (error) {
                console.error('âŒ ìŠ¤í† ì–´ ì‚¬ìš©ì ì •ë³´ ì„¤ì • ì˜¤ë¥˜:', error);
                showStoreAlert('åº—èˆ—ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'warning');
                setTimeout(() => {
                    window.location.href = 'store-register.html';
                }, 2000);
            }
        }

        // ê¸°ì¡´ ê°„ë‹¨í•œ ìŠ¤í† ì–´ ì¸ì¦ í™•ì¸ (ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
        async function checkSimpleStoreAuth() {
            try {
                console.log('=== ê°„ë‹¨í•œ ìŠ¤í† ì–´ ì¸ì¦ í™•ì¸ ì‹œì‘ ===');
                
                const currentUser = firebase.auth().currentUser;
                
                if (!currentUser) {
                    console.log('ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ì‚¬ìš©ì, ìŠ¤í† ì–´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
                    showStoreAlert('åº—èˆ—ã‚·ã‚¹ãƒ†ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚', 'warning');
                    setTimeout(() => {
                        window.location.href = 'store-register.html';
                    }, 2000);
                    return false;
                }
                
                console.log('âœ… ë¡œê·¸ì¸ëœ ì‚¬ìš©ì í™•ì¸ë¨:', currentUser.email);
                
                // ê°„ë‹¨í•œ ì‚¬ìš©ì ì •ë³´ ì„¤ì • (ê¶Œí•œ ì¬í™•ì¸ ì—†ìŒ)
                const storeUserInfo = {
                    email: currentUser.email,
                    name: currentUser.displayName || currentUser.email.split('@')[0],
                    role: 'store_admin', // ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
                    storeId: 'main_store',
                    permissions: ['point_management', 'customer_management', 'transaction_history', 'user_management', 'store_settings']
                };
                
                console.log('âœ… ìŠ¤í† ì–´ ì‚¬ìš©ì ì •ë³´ ì„¤ì • ì™„ë£Œ:', storeUserInfo);
                
                // ìŠ¤í† ì–´ ì‚¬ìš©ì ì •ë³´ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                window.currentStoreUser = storeUserInfo;
                
                // í—¤ë”ì— ìŠ¤í† ì–´ ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
                updateStoreUserDisplay(storeUserInfo);
                
                return true;
                
            } catch (error) {
                console.error('ê°„ë‹¨í•œ ìŠ¤í† ì–´ ì¸ì¦ í™•ì¸ ì˜¤ë¥˜:', error);
                showStoreAlert(`åº—èˆ—èªè¨¼ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'danger');
                setTimeout(() => {
                    window.location.href = 'store-register.html';
                }, 3000);
                return false;
            }
        }

        // ê¸°ì¡´ ë³µì¡í•œ ìŠ¤í† ì–´ ì „ìš© ì¸ì¦ í™•ì¸ (ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
        async function checkStoreAuthentication() {
            try {
                console.log('=== ìŠ¤í† ì–´ ì¸ì¦ í™•ì¸ ì‹œì‘ ===');
                
                const currentUser = firebase.auth().currentUser;
                
                if (!currentUser) {
                    console.log('ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ì‚¬ìš©ì, ìŠ¤í† ì–´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
                    showStoreAlert('åº—èˆ—ã‚·ã‚¹ãƒ†ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚', 'warning');
                    setTimeout(() => {
                        window.location.href = 'store-register.html';
                    }, 2000);
                    return false;
                }
                
                console.log('í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì:', currentUser.email);
                
                // ìŠ¤í† ì–´ ì‚¬ìš©ì ê¶Œí•œ í™•ì¸
                const storeUserDoc = await firebase.firestore()
                    .collection('storeUsers')
                    .doc(currentUser.email)
                    .get();
                
                let hasStoreAccess = false;
                let storeUserInfo = null;
                
                if (storeUserDoc.exists) {
                    const storeUserData = storeUserDoc.data();
                    console.log('ìŠ¤í† ì–´ ì‚¬ìš©ì ë°ì´í„°:', storeUserData);
                    
                    if (storeUserData.isActive && storeUserData.role) {
                        hasStoreAccess = true;
                        storeUserInfo = {
                            email: currentUser.email,
                            name: storeUserData.name || currentUser.email.split('@')[0],
                            role: storeUserData.role,
                            storeId: storeUserData.storeId || 'main_store',
                            permissions: storeUserData.permissions || []
                        };
                    }
                } else {
                    // ì¼ë°˜ ì‚¬ìš©ìì—ì„œ ìŠ¤í† ì–´ ê¶Œí•œ í™•ì¸
                    const userDoc = await firebase.firestore()
                        .collection('users')
                        .doc(currentUser.email)
                        .get();
                    
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        console.log('âœ… users ì»¬ë ‰ì…˜ì—ì„œ ì‚¬ìš©ì ë°ì´í„° í™•ì¸:', userData);
                        console.log('ğŸ” storeRole:', userData.storeRole);
                        console.log('ğŸ” isStoreActive:', userData.isStoreActive);
                        
                        // ìŠ¤í† ì–´ ê¶Œí•œì´ ì—†ìœ¼ë©´ ì ‘ê·¼ ê±°ë¶€
                        if (!userData.storeRole || !userData.isStoreActive) {
                            console.log('âŒ ìŠ¤í† ì–´ ê¶Œí•œ ì—†ìŒ - ì ‘ê·¼ ê±°ë¶€');
                            hasStoreAccess = false;
                        } else if (userData.storeRole && userData.isStoreActive) {
                            hasStoreAccess = true;
                            storeUserInfo = {
                                email: currentUser.email,
                                name: userData.name || currentUser.email.split('@')[0],
                                role: userData.storeRole,
                                storeId: userData.storeId || 'main_store',
                                permissions: userData.storePermissions || []
                            };
                        }
                    }
                }
                
                if (!hasStoreAccess) {
                    console.log('ìŠ¤í† ì–´ ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ');
                    showStoreAlert('åº—èˆ—ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚', 'danger');
                    setTimeout(() => {
                        window.location.href = 'store-register.html';
                    }, 3000);
                    return false;
                }
                
                console.log('âœ… ìŠ¤í† ì–´ ì¸ì¦ ì„±ê³µ:', storeUserInfo);
                
                // ìŠ¤í† ì–´ ì‚¬ìš©ì ì •ë³´ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                window.currentStoreUser = storeUserInfo;
                
                // í—¤ë”ì— ìŠ¤í† ì–´ ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
                updateStoreUserDisplay(storeUserInfo);
                
                return true;
                
            } catch (error) {
                console.error('=== ìŠ¤í† ì–´ ì¸ì¦ í™•ì¸ ì¤‘ ì—ëŸ¬ ë°œìƒ ===');
                console.error('ì—ëŸ¬ ê°ì²´:', error);
                console.error('ì—ëŸ¬ ë©”ì‹œì§€:', error.message);
                console.error('ì—ëŸ¬ ìŠ¤íƒ:', error.stack);
                console.error('í˜„ì¬ ì‚¬ìš©ì:', firebase.auth().currentUser);
                console.error('Firebase ìƒíƒœ:', {
                    firebase: typeof firebase,
                    auth: typeof firebase?.auth,
                    firestore: typeof firebase?.firestore
                });
                
                showStoreAlert(`åº—èˆ—èªè¨¼ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'danger');
                setTimeout(() => {
                    window.location.href = 'store-register.html';
                }, 3000);
                return false;
            }
        }

        // ìŠ¤í† ì–´ ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateStoreUserDisplay(storeUserInfo) {
            try {
                // í—¤ë”ì— ì‚¬ìš©ì ì •ë³´ ì¶”ê°€
                const storeHeader = document.querySelector('.store-header .col-md-3.text-end');
                if (storeHeader) {
                    const userInfoDiv = document.createElement('div');
                    userInfoDiv.className = 'store-user-info mt-2';
                    userInfoDiv.innerHTML = `
                        <div class="japanese-text">
                            <small>ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${storeUserInfo.name}</small><br>
                            <small>å½¹å‰²: ${getRoleDisplayName(storeUserInfo.role)}</small>
                        </div>
                    `;
                    storeHeader.appendChild(userInfoDiv);
                }
                
                console.log('ìŠ¤í† ì–´ ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                
            } catch (error) {
                console.error('ìŠ¤í† ì–´ ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }

        // ì—­í•  í‘œì‹œ ì´ë¦„ ë³€í™˜
        function getRoleDisplayName(role) {
            const roleNames = {
                'store_admin': 'åº—èˆ—ç®¡ç†è€…',
                'store_manager': 'åº—èˆ—ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼',
                'store_staff': 'åº—èˆ—ã‚¹ã‚¿ãƒƒãƒ•'
            };
            return roleNames[role] || role;
        }

        // URLì—ì„œ QRì½”ë“œ í™•ì¸
        function checkUrlForQRCode() {
            const urlParams = new URLSearchParams(window.location.search);
            const hashParams = window.location.hash.substring(1);
            
            // URL íŒŒë¼ë¯¸í„°ì—ì„œ QRì½”ë“œ í™•ì¸
            let qrCode = urlParams.get('qr');
            
            // Hashì—ì„œ QRì½”ë“œ í™•ì¸
            if (!qrCode && hashParams) {
                const hashQR = hashParams.match(/qr=([^&]+)/);
                if (hashQR) {
                    qrCode = decodeURIComponent(hashQR[1]);
                }
            }
            
            if (qrCode) {
                console.log('URLì—ì„œ QRì½”ë“œ ë°œê²¬:', qrCode);
                // ìë™ìœ¼ë¡œ QRì½”ë“œ ì²˜ë¦¬
                setTimeout(() => {
                    processQRCode(qrCode);
                }, 1000);
            }
        }

        // ë‚ ì§œ/ì‹œê°„ ì—…ë°ì´íŠ¸
        function updateDateTime() {
            const now = new Date();
            const dateOptions = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long' 
            };
            const timeOptions = { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            };
            
            document.getElementById('current-date').textContent = now.toLocaleDateString('ja-JP', dateOptions);
            document.getElementById('current-time').textContent = now.toLocaleTimeString('ja-JP', timeOptions);
        }

        // QR ìŠ¤ìºë„ˆ ì‹œì‘
        async function startScanner() {
            try {
                const video = document.getElementById('scanner-video');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 400 },
                        height: { ideal: 300 }
                    } 
                });
                
                video.srcObject = stream;
                video.play();
                
                // QR ì½”ë“œ ìŠ¤ìº” ì‹œì‘
                scanQRCode();
                
            } catch (error) {
                console.error('ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:', error);
                alert('ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }

        // QR ìŠ¤ìºë„ˆ ì¤‘ì§€
        function stopScanner() {
            const video = document.getElementById('scanner-video');
            if (video.srcObject) {
                const tracks = video.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                video.srcObject = null;
            }
            if (scanner) {
                clearInterval(scanner);
                scanner = null;
            }
        }

        // QR ì½”ë“œ ìŠ¤ìº”
        function scanQRCode() {
            const video = document.getElementById('scanner-video');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            scanner = setInterval(() => {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code) {
                        console.log('QR ì½”ë“œ ê°ì§€:', code.data);
                        processQRCode(code.data);
                        stopScanner();
                    }
                }
            }, 100);
        }

        // ìˆ˜ë™ QR ì…ë ¥ ì²˜ë¦¬
        function processManualQR() {
            const emailInput = document.getElementById('manual-qr-input');
            const email = emailInput.value.trim();
            
            if (email) {
                // ì´ë©”ì¼ í˜•ì‹ ê²€ì¦
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (emailRegex.test(email)) {
                    searchUserByEmail(email);
                    emailInput.value = '';
            } else {
                    alert('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                }
            } else {
                alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            }
        }

        // ì´ë©”ì¼ë¡œ ì‚¬ìš©ì ê²€ìƒ‰
        async function searchUserByEmail(email) {
            console.log('=== ì´ë©”ì¼ ê²€ìƒ‰ ì‹œì‘ ===');
            console.log('ê²€ìƒ‰ ì´ë©”ì¼:', email);
            
            try {
                // ë¡œë”© í‘œì‹œ
                showLoading();

                // Firebaseì—ì„œ ì´ë©”ì¼ë¡œ ì‚¬ìš©ì ê²€ìƒ‰
                const userDoc = await firebase.firestore().collection('users').doc(email).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    console.log('ì‚¬ìš©ì ì°¾ìŒ:', userData);
                    
                    // ì‚¬ìš©ì ì •ë³´ë¥¼ currentCustomer í˜•íƒœë¡œ ë³€í™˜
                    const customer = {
                        uid: userData.email || userDoc.id,
                        name: userData.name || 'ãŠå®¢æ§˜',
                        email: userData.email || email,
                        phone: userData.phone || '',
                        points: userData.points || 0,
                        documentId: userDoc.id
                    };
                    
                    currentCustomer = customer;
                    showCustomerInfo();
                    
                } else {
                    console.log('ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', email);
                    alert('è©²å½“ã™ã‚‹é¡§å®¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                }
                
            } catch (error) {
                console.error('ì´ë©”ì¼ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                alert('é¡§å®¢æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            } finally {
                hideLoading();
            }
        }

        // QR ì½”ë“œ ì²˜ë¦¬
        async function processQRCode(qrData) {
            console.log('=== QRì½”ë“œ ì²˜ë¦¬ ì‹œì‘ ===');
            console.log('ì…ë ¥ëœ QRë°ì´í„°:', qrData);
            
            try {
                // ë¡œë”© í‘œì‹œ
                showLoading();
                
                // QRë°ì´í„° ì •ë¦¬ (ì•ë’¤ ê³µë°± ì œê±°)
                const cleanQRData = qrData.trim();
                console.log('ì •ë¦¬ëœ QRë°ì´í„°:', cleanQRData);
                
                // Firebase ê¸°ë°˜ ì‚¬ìš©ì ì¡°íšŒë¡œ ë³€ê²½ë¨
                
                // Firebaseì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
                console.log('FirebaseService.getUserByQRToken í˜¸ì¶œ');
                const result = await FirebaseService.getUserByQRToken(cleanQRData);
                console.log('FirebaseService.getUserByQRToken ê²°ê³¼:', result);
                
                hideLoading();
                
                if (result.success) {
                    console.log('QRì½”ë“œ ì²˜ë¦¬ ì„±ê³µ, ì‚¬ìš©ì ì •ë³´:', result.user);
                    currentCustomer = result.user;
                    showCustomerInfo();
                } else {
                    console.error('QRì½”ë“œ ì²˜ë¦¬ ì‹¤íŒ¨:', result.error);
                    alert('æœ‰åŠ¹ãªQRã‚³ãƒ¼ãƒ‰ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\n' + result.error + '\n\nQRã‚³ãƒ¼ãƒ‰: ' + cleanQRData);
                    resetScanner();
                }
                
            } catch (error) {
                hideLoading();
                console.error('QR ì½”ë“œ ì²˜ë¦¬ ì˜ˆì™¸:', error);
                alert('QRã‚³ãƒ¼ãƒ‰ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n' + error.message);
                resetScanner();
            }
        }

        // ê³ ê° ì •ë³´ í‘œì‹œ (ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì™€ ë™ì¼)
        function showCustomerInfo() {
            document.getElementById('scanner-section').style.display = 'none';
            document.getElementById('customer-info').style.display = 'block';
            document.getElementById('point-actions').style.display = 'block';
            
            // ì „ì²´ í¬ì¸íŠ¸ ì´ìš©í˜„í™© ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('point-history-overview-main').style.display = 'none';
            
            console.log('showCustomerInfo í˜¸ì¶œë¨, currentCustomer:', currentCustomer);
            console.log('í¬ì¸íŠ¸ ê°’:', currentCustomer.points, 'íƒ€ì…:', typeof currentCustomer.points);
            
            // ê³ ê° ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('customer-name').textContent = currentCustomer.name || 'ãŠå®¢æ§˜';
            document.getElementById('customer-email').textContent = currentCustomer.email || '';
            document.getElementById('customer-phone').textContent = currentCustomer.phone || '';
            
            const pointsValue = currentCustomer.points || 0;
            console.log('í‘œì‹œí•  í¬ì¸íŠ¸ ê°’:', pointsValue);
            document.getElementById('customer-points').textContent = pointsValue.toLocaleString();
            
            // ì‹¤ì‹œê°„ í¬ì¸íŠ¸ ë™ê¸°í™” ì‹œì‘
            startRealTimePointSync();
            
            // í¬ì¸íŠ¸ ì´ë ¥ ë¡œë“œ
            loadCustomerPointHistory();
            
            // ì„±ê³µ ì• ë‹ˆë©”ì´ì…˜
            document.getElementById('customer-info').classList.add('success-animation');
            setTimeout(() => {
                document.getElementById('customer-info').classList.remove('success-animation');
            }, 600);
        }

        // êµ¬ë§¤ ê¸ˆì•¡ ì„¤ì •
        function setPurchaseAmount(amount) {
            document.getElementById('purchase-amount').value = amount;
            calculatePoints();
            
            // í™œì„± ë²„íŠ¼ í‘œì‹œ
            document.querySelectorAll('.quick-amount-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // êµ¬ë§¤ ê¸ˆì•¡ ì…ë ¥ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupPurchaseAmountListener() {
            document.getElementById('purchase-amount').addEventListener('input', calculatePoints);
        }

        // í¬ì¸íŠ¸ ê³„ì‚° (3% ì ë¦½ë¥ )
        function calculatePoints() {
            const amount = parseInt(document.getElementById('purchase-amount').value) || 0;
            const points = Math.floor(amount * 0.03);
            document.getElementById('points-to-add').value = points;
        }

        // í¬ì¸íŠ¸ ì ë¦½
        async function addPurchasePoints() {
            const amount = parseInt(document.getElementById('purchase-amount').value);
            const points = parseInt(document.getElementById('points-to-add').value);
            
            if (!amount || points <= 0) {
                showStoreAlert('è³¼å…¥é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
                return;
            }
            
            createCustomConfirmModal(
                'ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ç¢ºèª',
                `${points}ãƒã‚¤ãƒ³ãƒˆã‚’ä»˜ä¸ã—ã¾ã™ã‹ï¼Ÿ<br><small class="text-muted">è³¼å…¥é‡‘é¡: Â¥${amount.toLocaleString()}</small>`,
                'ãƒã‚¤ãƒ³ãƒˆä»˜ä¸',
                'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
                () => executeAddPurchasePoints(amount, points),
                () => {}
            );
            
        }
        
        // í¬ì¸íŠ¸ ì ë¦½ ì‹¤í–‰ í•¨ìˆ˜
        async function executeAddPurchasePoints(amount, points) {
            try {
                console.log('=== í¬ì¸íŠ¸ ë¶€ì—¬ ì‹œì‘ ===');
                console.log('ë¶€ì—¬ ì •ë³´:', {
                    ê³ ê°UID: currentCustomer.uid,
                    ê³ ê°ì´ë©”ì¼: currentCustomer.email,
                    ë¶€ì—¬í¬ì¸íŠ¸: points,
                    êµ¬ë§¤ê¸ˆì•¡: amount,
                    ì„¤ëª…: `åº—èˆ—è³¼å…¥ Â¥${amount.toLocaleString()}`
                });
                
                showStoreAlert('ãƒã‚¤ãƒ³ãƒˆã‚’ä»˜ä¸ä¸­...', 'info');
                
                const result = await FirebaseService.addPoints(
                    currentCustomer.uid,
                    points,
                    `åº—èˆ—è³¼å…¥ Â¥${amount.toLocaleString()}`
                );
                
                console.log('FirebaseService.addPoints ê²°ê³¼:', result);
                
                if (result.success) {
                    console.log('í¬ì¸íŠ¸ ë¶€ì—¬ ì„±ê³µ!');
                    
                    // ê³ ê° í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸
                    currentCustomer.points += points;
                    document.getElementById('customer-points').textContent = currentCustomer.points.toLocaleString();
                    console.log('ê³ ê° í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸:', currentCustomer.points);
                    
                    // í†µê³„ ì—…ë°ì´íŠ¸
                    console.log('í†µê³„ ì—…ë°ì´íŠ¸ ì‹œì‘...');
                    await updateTodayStats(points, `åº—èˆ—è³¼å…¥ Â¥${amount.toLocaleString()}`, currentCustomer.email);
                    console.log('í†µê³„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                    
                    // ì„±ê³µ ë©”ì‹œì§€
                    showStoreAlert(`${points}ãƒã‚¤ãƒ³ãƒˆã‚’ä»˜ä¸ã—ã¾ã—ãŸï¼`, 'success');
                    
                    // í¬ì¸íŠ¸ ì´ë ¥ ìƒˆë¡œê³ ì¹¨
                    console.log('ê³ ê° í¬ì¸íŠ¸ ì´ë ¥ ìƒˆë¡œê³ ì¹¨...');
                    // loadCustomerPointHistory(); // ì œê±°ë¨ - ì „ì²´ í¬ì¸íŠ¸ ì´ìš©í˜„í™©ì—ì„œ í™•ì¸ ê°€ëŠ¥
                    
                    // í¼ ì´ˆê¸°í™”
                    document.getElementById('purchase-amount').value = '';
                    document.getElementById('points-to-add').value = '';
                    document.querySelectorAll('.quick-amount-btn').forEach(btn => btn.classList.remove('active'));
                    
                    // ê³ ê° ì •ë³´ ì„¹ì…˜ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    setTimeout(() => {
                        backToCustomerInfo();
                    }, 1500);
                    
                } else {
                    console.error('í¬ì¸íŠ¸ ë¶€ì—¬ ì‹¤íŒ¨:', result.error);
                    showStoreAlert('ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'danger');
                }
                
            } catch (error) {
                console.error('í¬ì¸íŠ¸ ì ë¦½ ì‹¤íŒ¨:', error);
                showStoreAlert('ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'danger');
            }
        }

        // ìƒí’ˆ ì •ë³´ í•„ë“œ í† ê¸€
        function toggleProductInfoField() {
            const reason = document.getElementById('point-reason').value;
            const productField = document.getElementById('product-info-field');
            
            if (reason === 'ãƒã‚¤ãƒ³ãƒˆä½¿ç”¨') {
                productField.style.display = 'block';
                document.getElementById('product-barcode').required = true;
            } else {
                productField.style.display = 'none';
                document.getElementById('product-barcode').required = false;
                document.getElementById('product-barcode').value = '';
            }
        }

        // ë°”ì½”ë“œ ìŠ¤ìº” ëª¨ë‹¬ ì—´ê¸°
        function scanProductBarcode() {
            const modal = new bootstrap.Modal(document.getElementById('barcodeScannerModal'));
            modal.show();
            startBarcodeScanner();
        }

        // ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ë³€ìˆ˜ë“¤ (ZXing ì‚¬ìš©)
        let barcodeStream = null;
        let barcodeScanning = false;
        let barcodeScanInterval = null;
        let zxingReader = null;
        let barcodeVideo = null;
        let barcodeCanvas = null;
        let barcodeContext = null;

        // ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì‹œì‘ (ZXing ì‚¬ìš©)
        async function startBarcodeScanner() {
            try {
                console.log('=== ZXing ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì‹œì‘ ===');
                updateScannerStatus('ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...', true);
                
                // ZXing ë¦¬ë” ì´ˆê¸°í™”
                if (!zxingReader) {
                    zxingReader = new ZXing.BrowserMultiFormatReader();
                    console.log('âœ… ZXing ë¦¬ë” ì´ˆê¸°í™” ì™„ë£Œ');
                }
                
                // ì‚¬ìš© ê°€ëŠ¥í•œ ì¹´ë©”ë¼ ë””ë°”ì´ìŠ¤ í™•ì¸
                const videoInputDevices = await zxingReader.listVideoInputDevices();
                console.log('ì‚¬ìš© ê°€ëŠ¥í•œ ì¹´ë©”ë¼:', videoInputDevices);
                
                if (videoInputDevices.length === 0) {
                    throw new Error('ì‚¬ìš© ê°€ëŠ¥í•œ ì¹´ë©”ë¼ê°€ ì—†ìŠµë‹ˆë‹¤');
                }
                
                // í›„ë©´ ì¹´ë©”ë¼ ìš°ì„  ì„ íƒ
                let selectedDeviceId = null;
                const backCamera = videoInputDevices.find(device => 
                    device.label.toLowerCase().includes('back') || 
                    device.label.toLowerCase().includes('rear') ||
                    device.label.toLowerCase().includes('environment')
                );
                
                if (backCamera) {
                    selectedDeviceId = backCamera.deviceId;
                    console.log('âœ… í›„ë©´ ì¹´ë©”ë¼ ì„ íƒ:', backCamera.label);
                } else {
                    selectedDeviceId = videoInputDevices[0].deviceId;
                    console.log('âœ… ê¸°ë³¸ ì¹´ë©”ë¼ ì„ íƒ:', videoInputDevices[0].label);
                }
                
                // ë¹„ë””ì˜¤ ìš”ì†Œ ì°¸ì¡°
                barcodeVideo = document.getElementById('barcode-video');
                barcodeCanvas = document.getElementById('barcode-canvas');
                
                if (!barcodeVideo) {
                    throw new Error('ë¹„ë””ì˜¤ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
                // ZXingìœ¼ë¡œ ìŠ¤ìº” ì‹œì‘
                console.log('ZXing ìŠ¤ìº” ì‹œì‘...');
                await zxingReader.decodeFromVideoDevice(selectedDeviceId, barcodeVideo, (result, err) => {
                    if (result) {
                        console.log('ğŸ¯ ë°”ì½”ë“œ ìŠ¤ìº” ì„±ê³µ:', result.getText());
                        handleBarcodeDetected(result.getText());
                    }
                    if (err && !(err instanceof ZXing.NotFoundException)) {
                        console.warn('ë°”ì½”ë“œ ìŠ¤ìº” ê²½ê³ :', err);
                    }
                });
                
                barcodeVideo.style.display = 'block';
                barcodeScanning = true;
                updateScannerStatus('ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­...', false);
                
                // ì¹´ë©”ë¼ ì „í™˜ ë²„íŠ¼ í‘œì‹œ
                document.getElementById('switch-camera-btn').style.display = 'inline-block';
                
                console.log('âœ… ZXing ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì‹œì‘ ì™„ë£Œ');
                
            } catch (error) {
                console.error('âŒ ZXing ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì‹œì‘ ì˜¤ë¥˜:', error);
                updateScannerStatus('ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ', false);
                showCameraPermissionMessage();
            }
        }

        // ì¹´ë©”ë¼ ì „í™˜ (ZXing ì‚¬ìš©)
        async function switchCamera() {
            try {
                console.log('=== ì¹´ë©”ë¼ ì „í™˜ ì‹œì‘ ===');
                
                // í˜„ì¬ ìŠ¤ìº” ì¤‘ì§€
                if (zxingReader && barcodeScanning) {
                    await zxingReader.reset();
                    barcodeScanning = false;
                }
                
                updateScannerStatus('ã‚«ãƒ¡ãƒ©ã‚’åˆ‡æ›¿ä¸­...', true);
                
                // ì‚¬ìš© ê°€ëŠ¥í•œ ì¹´ë©”ë¼ ëª©ë¡ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°
                const videoInputDevices = await zxingReader.listVideoInputDevices();
                console.log('ì‚¬ìš© ê°€ëŠ¥í•œ ì¹´ë©”ë¼:', videoInputDevices);
                
                if (videoInputDevices.length < 2) {
                    updateScannerStatus('åˆ‡æ›¿å¯èƒ½ãªã‚«ãƒ¡ãƒ©ãŒã‚ã‚Šã¾ã›ã‚“', false);
                    return;
                }
                
                // í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ì¹´ë©”ë¼ ì°¾ê¸°
                const currentDevice = videoInputDevices.find(device => 
                    device.label.toLowerCase().includes('back') || 
                    device.label.toLowerCase().includes('rear') ||
                    device.label.toLowerCase().includes('environment')
                );
                
                // ë‹¤ë¥¸ ì¹´ë©”ë¼ ì„ íƒ (ì „ë©´/í›„ë©´ ì „í™˜)
                let selectedDeviceId;
                if (currentDevice) {
                    // í˜„ì¬ í›„ë©´ ì¹´ë©”ë¼ë©´ ì „ë©´ ì¹´ë©”ë¼ ì„ íƒ
                    const frontCamera = videoInputDevices.find(device => 
                        device.deviceId !== currentDevice.deviceId &&
                        (device.label.toLowerCase().includes('front') || 
                         device.label.toLowerCase().includes('user') ||
                         device.label.toLowerCase().includes('facing'))
                    );
                    selectedDeviceId = frontCamera ? frontCamera.deviceId : videoInputDevices[0].deviceId;
                } else {
                    // í˜„ì¬ ì „ë©´ ì¹´ë©”ë¼ë©´ í›„ë©´ ì¹´ë©”ë¼ ì„ íƒ
                    const backCamera = videoInputDevices.find(device => 
                        device.label.toLowerCase().includes('back') || 
                        device.label.toLowerCase().includes('rear') ||
                        device.label.toLowerCase().includes('environment')
                    );
                    selectedDeviceId = backCamera ? backCamera.deviceId : videoInputDevices[0].deviceId;
                }
                
                console.log('ìƒˆ ì¹´ë©”ë¼ ì„ íƒ:', selectedDeviceId);
                
                // ìƒˆ ì¹´ë©”ë¼ë¡œ ìŠ¤ìº” ì‹œì‘
                await zxingReader.decodeFromVideoDevice(selectedDeviceId, barcodeVideo, (result, err) => {
                    if (result) {
                        console.log('ğŸ¯ ë°”ì½”ë“œ ìŠ¤ìº” ì„±ê³µ:', result.getText());
                        handleBarcodeDetected(result.getText());
                    }
                    if (err && !(err instanceof ZXing.NotFoundException)) {
                        console.warn('ë°”ì½”ë“œ ìŠ¤ìº” ê²½ê³ :', err);
                    }
                });
                
                barcodeScanning = true;
                updateScannerStatus('ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­...', false);
                
                console.log('âœ… ì¹´ë©”ë¼ ì „í™˜ ì™„ë£Œ');
                
            } catch (error) {
                console.error('âŒ ì¹´ë©”ë¼ ì „í™˜ ì˜¤ë¥˜:', error);
                updateScannerStatus('ã‚«ãƒ¡ãƒ©åˆ‡æ›¿ã«å¤±æ•—ã—ã¾ã—ãŸ', false);
            }
        }

        // ë°”ì½”ë“œ ê°ì§€ ì‹œ ì²˜ë¦¬ (ZXing ì‚¬ìš©)
        function handleBarcodeDetected(barcodeData) {
            console.log('=== ZXing ë°”ì½”ë“œ ê°ì§€ ì„±ê³µ ===');
            console.log('ê°ì§€ëœ ë°”ì½”ë“œ:', barcodeData);
            console.log('ë°”ì½”ë“œ ê¸¸ì´:', barcodeData ? barcodeData.length : 0);
            console.log('ë°”ì½”ë“œ íƒ€ì…:', typeof barcodeData);
            
            // ë°”ì½”ë“œ ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
            if (!barcodeData || typeof barcodeData !== 'string' || barcodeData.trim() === '') {
                console.warn('ìœ íš¨í•˜ì§€ ì•Šì€ ë°”ì½”ë“œ ë°ì´í„°:', barcodeData);
                return;
            }
            
            // ìµœì†Œ ê¸¸ì´ ê²€ì‚¬ (ì¼ë°˜ì ìœ¼ë¡œ ë°”ì½”ë“œëŠ” 3ìë¦¬ ì´ìƒ)
            if (barcodeData.length < 3) {
                console.warn('ë°”ì½”ë“œê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤:', barcodeData);
                return;
            }
            
            // ìŠ¤ìº” ì¤‘ì§€ (ì¤‘ë³µ ê°ì§€ ë°©ì§€)
            barcodeScanning = false;
            
            // ZXing ë¦¬ë” ì •ì§€
            if (zxingReader) {
                zxingReader.reset();
                console.log('ZXing ë¦¬ë” ì •ì§€');
            }
            
            // ìŠ¤ìº” ì„±ê³µ ì• ë‹ˆë©”ì´ì…˜
            const scannerFrame = document.querySelector('.scanner-frame');
            if (scannerFrame) {
                scannerFrame.classList.add('scan-success');
            }
            
            // ì„±ê³µ ìƒíƒœ í‘œì‹œ
            updateScannerStatus('ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’æ¤œå‡ºã—ã¾ã—ãŸï¼', false);
            
            // ì¦‰ì‹œ ê²°ê³¼ ì²˜ë¦¬ (ì§€ì—° ì‹œê°„ ë‹¨ì¶•)
            setTimeout(() => {
                processBarcodeResult(barcodeData.trim());
            }, 200);
        }

        // ë°”ì½”ë“œ ê²°ê³¼ ì²˜ë¦¬
        function processBarcodeResult(barcodeData) {
            console.log('=== ë°”ì½”ë“œ ê²°ê³¼ ì²˜ë¦¬ ì‹œì‘ ===');
            console.log('ì²˜ë¦¬í•  ë°”ì½”ë“œ:', barcodeData);
            console.log('ë°”ì½”ë“œ ë°ì´í„° ìœ íš¨ì„±:', {
                exists: !!barcodeData,
                type: typeof barcodeData,
                length: barcodeData ? barcodeData.length : 0,
                trimmed: barcodeData ? barcodeData.trim() : ''
            });
            
            // ë°”ì½”ë“œ ë°ì´í„° ì¬ê²€ì¦
            if (!barcodeData || typeof barcodeData !== 'string' || barcodeData.trim() === '') {
                console.error('âŒ ì²˜ë¦¬í•  ë°”ì½”ë“œ ë°ì´í„°ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:', barcodeData);
                showStoreAlert('ìœ íš¨í•˜ì§€ ì•Šì€ ë°”ì½”ë“œì…ë‹ˆë‹¤', 'danger');
                return;
            }
            
            const trimmedBarcode = barcodeData.trim();
            
            // ìƒí’ˆ ì •ë³´ í•„ë“œ ì°¾ê¸° ë° ê°’ ì…ë ¥
            const productBarcodeField = document.getElementById('product-barcode');
            if (productBarcodeField) {
                // ê¸°ì¡´ ê°’ ì§€ìš°ê³  ìƒˆ ê°’ ì…ë ¥
                productBarcodeField.value = '';
                
                // ì•½ê°„ì˜ ì§€ì—° í›„ ê°’ ì„¤ì • (DOM ì—…ë°ì´íŠ¸ ë³´ì¥)
                setTimeout(() => {
                    productBarcodeField.value = trimmedBarcode;
                    
                    // í•„ë“œ í¬ì»¤ìŠ¤ ë° í•˜ì´ë¼ì´íŠ¸
                    productBarcodeField.focus();
                    productBarcodeField.style.backgroundColor = '#d4edda';
                    setTimeout(() => {
                        productBarcodeField.style.backgroundColor = '';
                    }, 1000);
                    
                    console.log('âœ… ìƒí’ˆ ì •ë³´ í•„ë“œì— ë°”ì½”ë“œ ì…ë ¥ ì™„ë£Œ:', trimmedBarcode);
                    console.log('âœ… í•„ë“œ ê°’ í™•ì¸:', productBarcodeField.value);
                    
                    // ì…ë ¥ ì´ë²¤íŠ¸ ë°œìƒ (í•„ë“œ ë³€ê²½ ê°ì§€)
                    productBarcodeField.dispatchEvent(new Event('input', { bubbles: true }));
                    productBarcodeField.dispatchEvent(new Event('change', { bubbles: true }));
                    
                    // ìƒí’ˆ ì •ë³´ í•„ë“œê°€ í‘œì‹œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                    const productInfoField = document.getElementById('product-info-field');
                    if (productInfoField && productInfoField.style.display === 'none') {
                        console.log('âš ï¸ ìƒí’ˆ ì •ë³´ í•„ë“œê°€ ìˆ¨ê²¨ì ¸ ìˆìŠµë‹ˆë‹¤. í‘œì‹œí•©ë‹ˆë‹¤.');
                        productInfoField.style.display = 'block';
                    }
                    
                    // ëª¨ë‹¬ ë‹«ê¸°
                    closeBarcodeScanner();
                    
                    // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                    showStoreAlert(`ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸ: ${trimmedBarcode}`, 'success');
                    
                    console.log('=== ë°”ì½”ë“œ ê²°ê³¼ ì²˜ë¦¬ ì™„ë£Œ ===');
                }, 100);
                
            } else {
                console.error('âŒ ìƒí’ˆ ì •ë³´ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                showStoreAlert('ìƒí’ˆ ì •ë³´ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'danger');
                return;
            }
        }

        // ìˆ˜ë™ ë°”ì½”ë“œ ì…ë ¥ í™•ì¸
        function confirmManualBarcode() {
            const manualInput = document.getElementById('manual-barcode-input');
            const barcodeValue = manualInput.value.trim();
            
            console.log('ìˆ˜ë™ ë°”ì½”ë“œ ì…ë ¥:', barcodeValue);
            
            if (barcodeValue) {
                processBarcodeResult(barcodeValue);
            } else {
                showStoreAlert('ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
            }
        }

        // ì¹´ë©”ë¼ ì „í™˜
        async function switchCamera() {
            try {
                // í˜„ì¬ ìŠ¤íŠ¸ë¦¼ ì •ì§€
                if (barcodeStream) {
                    barcodeStream.getTracks().forEach(track => track.stop());
                }
                
                updateScannerStatus('ã‚«ãƒ¡ãƒ©ã‚’åˆ‡æ›¿ä¸­...', true);
                
                // ë‹¤ë¥¸ ì¹´ë©”ë¼ë¡œ ì „í™˜ (ì „ë©´/í›„ë©´)
                const currentConstraints = barcodeStream.getVideoTracks()[0].getConstraints();
                const newConstraints = {
                    video: {
                        facingMode: currentConstraints.facingMode === 'environment' ? 'user' : 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                barcodeStream = await navigator.mediaDevices.getUserMedia(newConstraints);
                
                const video = document.getElementById('barcode-video');
                video.srcObject = barcodeStream;
                
                video.onloadedmetadata = () => {
                    video.play();
                    updateScannerStatus('ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­...', false);
                    startBarcodeDetection();
                };
                
            } catch (error) {
                console.error('ì¹´ë©”ë¼ ì „í™˜ ì˜¤ë¥˜:', error);
                updateScannerStatus('ã‚«ãƒ¡ãƒ©åˆ‡æ›¿ã«å¤±æ•—ã—ã¾ã—ãŸ', false);
            }
        }

        // ìŠ¤ìºë„ˆ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateScannerStatus(message, showLoading) {
            const statusText = document.getElementById('scanner-status-text');
            const loading = document.getElementById('scanner-loading');
            
            statusText.textContent = message;
            loading.style.display = showLoading ? 'block' : 'none';
        }

        // ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ ë©”ì‹œì§€ í‘œì‹œ
        function showCameraPermissionMessage() {
            const viewport = document.getElementById('barcode-scanner-viewport');
            viewport.innerHTML = `
                <div class="camera-permission">
                    <i class="fas fa-camera"></i>
                    <h5 class="japanese-heading">ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã™</h5>
                    <p class="japanese-text">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ã«ã¯ã€ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚</p>
                    <button class="btn btn-primary" onclick="startBarcodeScanner()">
                        <i class="fas fa-camera me-2"></i>å†è©¦è¡Œ
                    </button>
                </div>
            `;
        }

        // ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì¢…ë£Œ (ZXing ì‚¬ìš©)
        async function closeBarcodeScanner() {
            console.log('=== ZXing ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì¢…ë£Œ ===');
            
            try {
                // ìŠ¤ìº” ì¤‘ì§€
                barcodeScanning = false;
                
                // ZXing ë¦¬ë” ì •ì§€
                if (zxingReader) {
                    await zxingReader.reset();
                    console.log('âœ… ZXing ë¦¬ë” ì •ì§€ ì™„ë£Œ');
                }
                
                // ë¹„ë””ì˜¤ ìš”ì†Œ ì´ˆê¸°í™”
                if (barcodeVideo) {
                    barcodeVideo.style.display = 'none';
                    barcodeVideo.srcObject = null;
                }
                
                // ëª¨ë‹¬ ë‹«ê¸°
                const modal = bootstrap.Modal.getInstance(document.getElementById('barcodeScannerModal'));
                if (modal) {
                    modal.hide();
                }
                
                // ìƒíƒœ ì´ˆê¸°í™”
                updateScannerStatus('ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...', true);
                document.getElementById('manual-barcode-input').value = '';
                document.getElementById('switch-camera-btn').style.display = 'none';
                
                // ìŠ¤ìºë„ˆ ë·°í¬íŠ¸ ì´ˆê¸°í™”
                const viewport = document.getElementById('barcode-scanner-viewport');
                viewport.innerHTML = `
                    <div class="scanner-overlay">
                        <div class="scanner-frame">
                            <div class="scanner-corners">
                                <div class="corner top-left"></div>
                                <div class="corner top-right"></div>
                                <div class="corner bottom-left"></div>
                                <div class="corner bottom-right"></div>
                            </div>
                        </div>
                    </div>
                    <video id="barcode-video" autoplay playsinline style="display: none;"></video>
                    <canvas id="barcode-canvas" style="display: none;"></canvas>
                `;
                
                // ë³€ìˆ˜ ì´ˆê¸°í™”
                barcodeVideo = null;
                barcodeCanvas = null;
                barcodeContext = null;
                
                console.log('âœ… ZXing ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì¢…ë£Œ ì™„ë£Œ');
                
            } catch (error) {
                console.error('âŒ ZXing ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ì¢…ë£Œ ì˜¤ë¥˜:', error);
            }
        }

        // ìˆ˜ë™ í¬ì¸íŠ¸ ì¶”ê°€
        async function addManualPoints() {
            const points = parseInt(document.getElementById('manual-points').value);
            const reason = document.getElementById('point-reason').value;
            
            if (!points || points <= 0) {
                showStoreAlert('ãƒã‚¤ãƒ³ãƒˆæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
                return;
            }
            
            createCustomConfirmModal(
                'ãƒã‚¤ãƒ³ãƒˆè¿½åŠ ç¢ºèª',
                `${points}ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ<br><small class="text-muted">ç†ç”±: ${reason}</small>`,
                'ãƒã‚¤ãƒ³ãƒˆè¿½åŠ ',
                'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
                () => executeAddManualPoints(points, reason),
                () => {}
            );
            
        }
        
        // ìˆ˜ë™ í¬ì¸íŠ¸ ì¶”ê°€ ì‹¤í–‰ í•¨ìˆ˜
        async function executeAddManualPoints(points, reason) {
            try {
                showStoreAlert('ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ä¸­...', 'info');
                
                const result = await FirebaseService.addPoints(
                    currentCustomer.uid,
                    points,
                    reason
                );
                
                if (result.success) {
                    currentCustomer.points += points;
                    document.getElementById('customer-points').textContent = currentCustomer.points.toLocaleString();
                    await updateTodayStats(points, reason, currentCustomer.email);
                    showStoreAlert(`${points}ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸï¼`, 'success');
                    document.getElementById('manual-points').value = '';
                    
                    // í¬ì¸íŠ¸ ì´ë ¥ ìƒˆë¡œê³ ì¹¨
                    // loadCustomerPointHistory(); // ì œê±°ë¨ - ì „ì²´ í¬ì¸íŠ¸ ì´ìš©í˜„í™©ì—ì„œ í™•ì¸ ê°€ëŠ¥
                    
                    // ê³ ê° ì •ë³´ ì„¹ì…˜ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    setTimeout(() => {
                        backToCustomerInfo();
                    }, 1500);
                } else {
                    showStoreAlert('ãƒã‚¤ãƒ³ãƒˆè¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'danger');
                }
                
            } catch (error) {
                console.error('ìˆ˜ë™ í¬ì¸íŠ¸ ì¶”ê°€ ì‹¤íŒ¨:', error);
                showStoreAlert('ãƒã‚¤ãƒ³ãƒˆè¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'danger');
            }
        }

        // ìˆ˜ë™ í¬ì¸íŠ¸ ì°¨ê°
        async function subtractManualPoints() {
            const points = parseInt(document.getElementById('manual-points').value);
            const reason = document.getElementById('point-reason').value;
            
            if (!points || points <= 0) {
                showStoreAlert('ãƒã‚¤ãƒ³ãƒˆæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
                return;
            }
            
            if (currentCustomer.points < points) {
                showStoreAlert('ãŠå®¢æ§˜ã®ãƒã‚¤ãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚', 'warning');
                return;
            }
            
            // í¬ì¸íŠ¸ ì‚¬ìš© ì‹œ ìƒí’ˆ ì •ë³´ í•„ìˆ˜ ì…ë ¥
            if (reason === 'ãƒã‚¤ãƒ³ãƒˆä½¿ç”¨') {
                const productInfo = document.getElementById('product-barcode').value;
                if (!productInfo || productInfo.trim() === '') {
                    showStoreAlert('å•†å“æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
                return;
                }
            }
            
            let confirmMessage = `${points}ãƒã‚¤ãƒ³ãƒˆã‚’å·®ã—å¼•ãã¾ã™ã‹ï¼Ÿ<br><small class="text-muted">ç†ç”±: ${reason}</small>`;
            if (reason === 'ãƒã‚¤ãƒ³ãƒˆä½¿ç”¨') {
                const productInfo = document.getElementById('product-barcode').value;
                confirmMessage += `<br><small class="text-muted">å•†å“: ${productInfo}</small>`;
            }
            
            createCustomConfirmModal(
                'ãƒã‚¤ãƒ³ãƒˆå·®å¼•ç¢ºèª',
                confirmMessage,
                'ãƒã‚¤ãƒ³ãƒˆå·®å¼•',
                'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
                () => executeSubtractManualPoints(points, reason),
                () => {}
            );
            
        }
        
        // ìˆ˜ë™ í¬ì¸íŠ¸ ì°¨ê° ì‹¤í–‰ í•¨ìˆ˜
        async function executeSubtractManualPoints(points, reason) {
            try {
                showStoreAlert('ãƒã‚¤ãƒ³ãƒˆã‚’å·®ã—å¼•ãä¸­...', 'info');
                
                // í¬ì¸íŠ¸ ì‚¬ìš© ì‹œ ìƒí’ˆ ì •ë³´ í¬í•¨
                let finalReason = reason;
                if (reason === 'ãƒã‚¤ãƒ³ãƒˆä½¿ç”¨') {
                    const productInfo = document.getElementById('product-barcode').value;
                    finalReason = `${reason} - ${productInfo}`;
                }
                
                const result = await FirebaseService.usePoints(
                    currentCustomer.uid,
                    points,
                    finalReason
                );
                
                if (result.success) {
                    // ì„œë²„ì—ì„œ ë°˜í™˜ëœ ì •í™•í•œ í¬ì¸íŠ¸ ê°’ ì‚¬ìš©
                    currentCustomer.points = result.points;
                    document.getElementById('customer-points').textContent = currentCustomer.points.toLocaleString();
                    
                    await updateTodayStats(-points, reason, currentCustomer.email);
                    showStoreAlert(`${points}ãƒã‚¤ãƒ³ãƒˆã‚’å·®ã—å¼•ãã¾ã—ãŸã€‚`, 'success');
                    
                    // í•„ë“œ ì´ˆê¸°í™”
                    document.getElementById('manual-points').value = '';
                    document.getElementById('point-reason').value = 'åº—èˆ—è³¼å…¥';
                    document.getElementById('product-barcode').value = '';
                    
                    // í¬ì¸íŠ¸ ì‚¬ìš©ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ìƒí’ˆ ì •ë³´ í•„ë“œ ìˆ¨ê¸°ê¸°
                    if (reason !== 'ãƒã‚¤ãƒ³ãƒˆä½¿ç”¨') {
                        document.getElementById('product-info-field').style.display = 'none';
                    }
                    
                    // í¬ì¸íŠ¸ ì´ë ¥ ìƒˆë¡œê³ ì¹¨
                    // loadCustomerPointHistory(); // ì œê±°ë¨ - ì „ì²´ í¬ì¸íŠ¸ ì´ìš©í˜„í™©ì—ì„œ í™•ì¸ ê°€ëŠ¥
                    
                    // ê³ ê° ì •ë³´ ì„¹ì…˜ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    setTimeout(() => {
                        backToCustomerInfo();
                    }, 1500);
                } else {
                    showStoreAlert(`ãƒã‚¤ãƒ³ãƒˆå·®å¼•ã«å¤±æ•—ã—ã¾ã—ãŸ: ${result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`, 'danger');
                }
                
            } catch (error) {
                console.error('ìˆ˜ë™ í¬ì¸íŠ¸ ì°¨ê° ì‹¤íŒ¨:', error);
                showStoreAlert('ãƒã‚¤ãƒ³ãƒˆå·®å¼•ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'danger');
            }
        }

        // ê³ ê° ì •ë³´ë¡œ ëŒì•„ê°€ê¸°
        function backToCustomerInfo() {
            document.getElementById('point-actions').style.display = 'none';
            document.getElementById('customer-info').style.display = 'block';
        }

        // ìŠ¤ìºë„ˆ ì´ˆê¸°í™”
        function resetScanner() {
            stopScanner();
            
            // ì‹¤ì‹œê°„ ë™ê¸°í™” ì¤‘ì§€
            stopRealTimePointSync();
            
            currentCustomer = null;
            
            document.getElementById('scanner-section').style.display = 'block';
            document.getElementById('customer-info').style.display = 'none';
            document.getElementById('point-actions').style.display = 'none';
            
            // ì „ì²´ í¬ì¸íŠ¸ ì´ìš©í˜„í™© ì„¹ì…˜ ë‹¤ì‹œ í‘œì‹œ
            document.getElementById('point-history-overview-main').style.display = 'block';
            
            // í¼ ì´ˆê¸°í™”
            document.getElementById('purchase-amount').value = '';
            document.getElementById('points-to-add').value = '';
            document.getElementById('manual-points').value = '';
            document.getElementById('manual-qr-input').value = '';
            document.querySelectorAll('.quick-amount-btn').forEach(btn => btn.classList.remove('active'));
        }

        // ì˜¤ëŠ˜ í†µê³„ ë¡œë“œ (Firebase Firestore ê¸°ë°˜)
        async function loadTodayStats() {
            try {
                const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD í˜•ì‹
                const storeId = 'main_store'; // ë§¤ì¥ ì‹ë³„ì
                const statsDoc = await firebase.firestore().collection('storeStats').doc(`${today}_${storeId}`).get();
                
                if (statsDoc.exists) {
                    const data = statsDoc.data();
                    todayStats.customers = data.customers || 0;
                    todayStats.points = data.points || 0;
                    todayStats.transactions = data.transactions || [];
                    console.log('Firebaseì—ì„œ í†µê³„ ë¡œë“œ ì™„ë£Œ:', todayStats);
                    console.log('ë§¤ì¥ ì •ë³´:', { storeName: data.storeName, storeLocation: data.storeLocation });
                } else {
                    console.log('ì˜¤ëŠ˜ í†µê³„ ë°ì´í„° ì—†ìŒ, ìƒˆë¡œ ì‹œì‘');
                    todayStats = { customers: 0, points: 0, transactions: [] };
            }
            
            updateStatsDisplay();
            } catch (error) {
                console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
                todayStats = { customers: 0, points: 0, transactions: [] };
            updateStatsDisplay();
            }
        }

        // ì˜¤ëŠ˜ í†µê³„ ì—…ë°ì´íŠ¸ (Firebase Firestore ê¸°ë°˜)
        async function updateTodayStats(pointsChange, reason = '', customerEmail = '') {
            try {
                // í¬ì¸íŠ¸ê°€ ì–‘ìˆ˜ì¸ ê²½ìš°ì—ë§Œ ê³ ê° ìˆ˜ ì¦ê°€ (ìƒˆë¡œìš´ í¬ì¸íŠ¸ ì ë¦½)
                if (pointsChange > 0) {
            todayStats.customers++;
                }
                todayStats.points += pointsChange;
                
                // ê±°ë˜ ë‚´ì—­ ì¶”ê°€
                const transaction = {
                    timestamp: new Date().toISOString(),
                    points: pointsChange,
                    reason: reason,
                    customerEmail: customerEmail,
                    type: pointsChange > 0 ? 'ì ë¦½' : 'ì°¨ê°'
                };
                todayStats.transactions.push(transaction);
                
                // Firebase Firestoreì— í†µê³„ ë°ì´í„° ì €ì¥
                const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD í˜•ì‹
                const storeId = 'main_store'; // ë§¤ì¥ ì‹ë³„ì
                
                await firebase.firestore().collection('storeStats').doc(`${today}_${storeId}`).set({
                    date: today,
                    storeId: storeId,
                    customers: todayStats.customers,
                    points: todayStats.points,
                    transactions: todayStats.transactions,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    storeName: 'ë©”ì¸ ë§¤ì¥', // ë§¤ì¥ ì´ë¦„
                    storeLocation: 'ì„œìš¸', // ë§¤ì¥ ìœ„ì¹˜
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                console.log('Firebase í†µê³„ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', { 
                    customers: todayStats.customers, 
                    points: todayStats.points,
                    transaction: transaction
                });
                updateStatsDisplay();
            } catch (error) {
                console.error('í†µê³„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                // ë¡œì»¬ ì—…ë°ì´íŠ¸ëŠ” ìœ ì§€
            updateStatsDisplay();
            }
        }

        // í†µê³„ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateStatsDisplay() {
            try {
                const customersEl = document.getElementById('today-customers');
                const pointsEl = document.getElementById('today-points');
                
                if (customersEl) {
                    customersEl.textContent = todayStats.customers.toLocaleString();
                } else {
                    console.warn('today-customers ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
                if (pointsEl) {
                    pointsEl.textContent = todayStats.points.toLocaleString();
                } else {
                    console.warn('today-points ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('í†µê³„ í‘œì‹œ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }

        // ì‹¤ì‹œê°„ í¬ì¸íŠ¸ ë™ê¸°í™” ì‹œì‘
        function startRealTimePointSync() {
            if (!currentCustomer || !currentCustomer.uid) {
                console.warn('í˜„ì¬ ê³ ê° ì •ë³´ê°€ ì—†ì–´ì„œ ì‹¤ì‹œê°„ ë™ê¸°í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            console.log('ì‹¤ì‹œê°„ í¬ì¸íŠ¸ ë™ê¸°í™” ì‹œì‘:', currentCustomer.email);
            
            // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆê°€ ìˆìœ¼ë©´ ì œê±°
            if (realTimeListener) {
                realTimeListener();
                realTimeListener = null;
            }
            
            // í¬ì¸íŠ¸ ì´ë ¥ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (ì „ì²´ í¬ì¸íŠ¸ ì´ë ¥ì—ì„œ í•„í„°ë§)
            realTimeListener = firebase.firestore()
                .collection('pointHistory')
                .onSnapshot(async (snapshot) => {
                    console.log('ì‹¤ì‹œê°„ í¬ì¸íŠ¸ ì´ë ¥ ë³€ê²½ ê°ì§€');
                    
                    // í¬ì¸íŠ¸ ì´ë ¥ì—ì„œ ì‹¤ì œ í¬ì¸íŠ¸ ì¬ê³„ì‚° (ê´€ë¦¬ì í˜ì´ì§€ì™€ ë™ì¼í•œ ë¡œì§)
                    let calculatedPoints = 0;
                    let earnedPoints = 0;
                    let usedPoints = 0;
                    let latestBalanceAfter = 0;
                    
                    // ìµœì‹  í¬ì¸íŠ¸ ì´ë ¥ ì°¾ê¸° (balanceAfter í•„ë“œ ì‚¬ìš©)
                    const customerHistories = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        
                        // í˜„ì¬ ê³ ê°ê³¼ ê´€ë ¨ëœ í¬ì¸íŠ¸ ì´ë ¥ë§Œ ì²˜ë¦¬
                        if (data.userId === currentCustomer.uid || 
                            data.userEmail === currentCustomer.email ||
                            data.userId === currentCustomer.email ||
                            data.userId === currentCustomer.documentId ||
                            data.userEmail === currentCustomer.uid) {
                            
                            customerHistories.push({
                                ...data,
                                createdAt: data.createdAt || data.timestamp,
                                docId: doc.id
                            });
                            
                            if (data.type === 'earn' || data.type === 'admin_add' || data.type === 'welcome_bonus') {
                                earnedPoints += data.points || 0;
                            } else if (data.type === 'use' || data.type === 'admin_subtract') {
                                usedPoints += data.points || 0;
                            }
                        }
                    });
                    
                    // createdAt ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ìµœì‹  balanceAfter ê°’ ì°¾ê¸°
                    if (customerHistories.length > 0) {
                        customerHistories.sort((a, b) => {
                            const aTime = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt);
                            const bTime = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt);
                            return bTime - aTime; // ìµœì‹ ìˆœ
                        });
                        
                        // ê°€ì¥ ìµœê·¼ì˜ balanceAfter ê°’ ì‚¬ìš©
                        latestBalanceAfter = customerHistories[0].balanceAfter || customerHistories[0].balance || 0;
                        
                        // balanceAfterê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ì‚¬ìš©, ì—†ìœ¼ë©´ ì ë¦½-ì‚¬ìš© ê³„ì‚°
                        if (latestBalanceAfter > 0) {
                            calculatedPoints = latestBalanceAfter;
                } else {
                            calculatedPoints = earnedPoints - usedPoints;
                        }
                    } else {
                        calculatedPoints = earnedPoints - usedPoints;
                    }
                    
                    console.log('ì‹¤ì‹œê°„ í¬ì¸íŠ¸ ì¬ê³„ì‚°:', {
                        ì´ì „: currentCustomer.points,
                        í˜„ì¬: calculatedPoints,
                        ì ë¦½: earnedPoints,
                        ì‚¬ìš©: usedPoints,
                        ìµœì‹ balanceAfter: latestBalanceAfter,
                        ë³€ê²½ëŸ‰: calculatedPoints - currentCustomer.points
                    });
                    
                    // í¬ì¸íŠ¸ê°€ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
                    if (currentCustomer.points !== calculatedPoints) {
                        // í˜„ì¬ ê³ ê° ì •ë³´ ì—…ë°ì´íŠ¸
                        currentCustomer.points = calculatedPoints;
                        
                        // UI ì—…ë°ì´íŠ¸
                        document.getElementById('customer-points').textContent = calculatedPoints.toLocaleString();
                        
                        // í¬ì¸íŠ¸ ì´ë ¥ ë‹¤ì‹œ ë¡œë“œ
                        loadCustomerPointHistory();
                        
                        // í¬ì¸íŠ¸ ë³€ê²½ ì•Œë¦¼
                        const changeAmount = calculatedPoints - (currentCustomer.points || 0);
                        if (changeAmount > 0) {
                            showPointChangeNotification(`+${changeAmount}ãƒã‚¤ãƒ³ãƒˆ`);
                        }
                    }
                }, (error) => {
                    console.error('ì‹¤ì‹œê°„ í¬ì¸íŠ¸ ë™ê¸°í™” ì˜¤ë¥˜:', error);
                });
        }
        
        // ì‹¤ì‹œê°„ ë™ê¸°í™” ì¤‘ì§€
        function stopRealTimePointSync() {
            if (realTimeListener) {
                console.log('ì‹¤ì‹œê°„ í¬ì¸íŠ¸ ë™ê¸°í™” ì¤‘ì§€');
                realTimeListener();
                realTimeListener = null;
            }
        }
        
        // í¬ì¸íŠ¸ ë³€ê²½ ì•Œë¦¼ í‘œì‹œ
        function showPointChangeNotification(message) {
            // ê°„ë‹¨í•œ ì•Œë¦¼ í‘œì‹œ (ì„ íƒì‚¬í•­)
            console.log('í¬ì¸íŠ¸ ë³€ê²½ ì•Œë¦¼:', message);
            
            // ë” ì‹œê°ì ì¸ ì•Œë¦¼ì´ í•„ìš”í•˜ë©´ ì—¬ê¸°ì— êµ¬í˜„
            // ì˜ˆ: í† ìŠ¤íŠ¸ ë©”ì‹œì§€, ì• ë‹ˆë©”ì´ì…˜ ë“±
        }

        // ê³ ê° í¬ì¸íŠ¸ ì´ë ¥ ë¡œë“œ (ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì™€ ë™ì¼)
        // ê°œë³„ ê³ ê° í¬ì¸íŠ¸ ì´ë ¥ í•¨ìˆ˜ ì œê±°ë¨ - ì „ì²´ í¬ì¸íŠ¸ ì´ìš©í˜„í™©ì—ì„œ í™•ì¸ ê°€ëŠ¥
        async function loadCustomerPointHistory() {
            if (!currentCustomer || !currentCustomer.uid) {
                console.log('ê³ ê° ì •ë³´ê°€ ì—†ì–´ì„œ í¬ì¸íŠ¸ ì´ë ¥ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                console.log('ê³ ê° í¬ì¸íŠ¸ ì´ë ¥ ë¡œë“œ ì‹œì‘:', currentCustomer.uid);
                
                if (FirebaseService.isFirebaseAvailable()) {
                    // ì „ì²´ í¬ì¸íŠ¸ ì´ë ¥ì„ ê°€ì ¸ì™€ì„œ ì—¬ëŸ¬ ì¡°ê±´ìœ¼ë¡œ í•„í„°ë§
                    console.log('í¬ì¸íŠ¸ ì´ë ¥ ê²€ìƒ‰ ì¡°ê±´:', {
                        userId: currentCustomer.uid,
                        userEmail: currentCustomer.email
                    });
                    
                    const historySnapshot = await firebase.firestore().collection('pointHistory').get();
                    
                    const pointHistory = [];
                    historySnapshot.forEach(doc => {
                        const data = doc.data();
                        // userId ë˜ëŠ” userEmailë¡œ ë§¤ì¹­ (ëª¨ë“  ê°€ëŠ¥í•œ ì‹ë³„ì í™•ì¸)
                        if (data.userId === currentCustomer.uid || 
                            data.userEmail === currentCustomer.email ||
                            data.userId === currentCustomer.email ||
                            data.userId === currentCustomer.documentId ||
                            data.userEmail === currentCustomer.uid) {
                            
                        pointHistory.push({
                            id: doc.id,
                            ...data
                        });
                        }
                    });
                    
                    // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬ ë° ì œí•œ (ìµœì‹ ìˆœ)
                    pointHistory.sort((a, b) => {
                        const getTimestamp = (item) => {
                            if (!item) return new Date(0);
                            
                            // createdAtì´ Firestore Timestampì¸ ê²½ìš°
                            if (item.createdAt && item.createdAt.toDate && typeof item.createdAt.toDate === 'function') {
                                return item.createdAt.toDate();
                            }
                            
                            // timestampê°€ Firestore Timestampì¸ ê²½ìš°
                            if (item.timestamp && item.timestamp.toDate && typeof item.timestamp.toDate === 'function') {
                                return item.timestamp.toDate();
                            }
                            
                            // createdAtì´ ì¼ë°˜ ë‚ ì§œ ë¬¸ìì—´ì´ë‚˜ ìˆ«ìì¸ ê²½ìš°
                            if (item.createdAt) {
                                const date = new Date(item.createdAt);
                                if (!isNaN(date.getTime())) {
                                    return date;
                                }
                            }
                            
                            // timestampê°€ ì¼ë°˜ ë‚ ì§œ ë¬¸ìì—´ì´ë‚˜ ìˆ«ìì¸ ê²½ìš°
                            if (item.timestamp) {
                                const date = new Date(item.timestamp);
                                if (!isNaN(date.getTime())) {
                                    return date;
                                }
                            }
                            
                            // ê¸°ë³¸ê°’ìœ¼ë¡œ í˜„ì¬ ì‹œê°„ ì‚¬ìš©
                            return new Date();
                        };
                        
                        // ìµœì‹ ìˆœ ì •ë ¬ (b - a)
                        return getTimestamp(b) - getTimestamp(a);
                    }).slice(0, 10);
                    
                    console.log('Firebaseì—ì„œ í¬ì¸íŠ¸ ì´ë ¥ ë¡œë“œ ì™„ë£Œ:', pointHistory.length, 'ê±´');
                    
                    // ì •ë ¬ ê²°ê³¼ í™•ì¸ì„ ìœ„í•œ ë¡œê·¸
                    if (pointHistory.length > 0) {
                        console.log('í¬ì¸íŠ¸ ì´ë ¥ ì •ë ¬ ê²°ê³¼ (ìµœì‹ ìˆœ):');
                        pointHistory.forEach((item, index) => {
                            const timestamp = item.createdAt || item.timestamp;
                            console.log(`${index + 1}. ${item.reason || item.description} - ${timestamp}`);
                        });
                        
                        // ìµœì‹  í¬ì¸íŠ¸ ê³„ì‚° (balanceAfter ì‚¬ìš©)
                        const latestItem = pointHistory[0];
                        const calculatedPoints = latestItem.balanceAfter || latestItem.balance || currentCustomer.points;
                        
                        // í¬ì¸íŠ¸ê°€ ë‹¤ë¥´ë©´ ì—…ë°ì´íŠ¸
                        if (currentCustomer.points !== calculatedPoints) {
                            console.log('í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸:', {
                                ì´ì „: currentCustomer.points,
                                í˜„ì¬: calculatedPoints,
                                balanceAfter: latestItem.balanceAfter,
                                balance: latestItem.balance
                            });
                            
                            currentCustomer.points = calculatedPoints;
                            document.getElementById('customer-points').textContent = calculatedPoints.toLocaleString();
                        }
                    }
                    
                    displayCustomerPointHistory(pointHistory);
                } else {
                    // Firebaseì—ì„œ í¬ì¸íŠ¸ ì´ë ¥ ë¡œë“œ
                    console.log('ğŸ”¥ Firebaseì—ì„œ í¬ì¸íŠ¸ ì´ë ¥ ë¡œë“œ:', currentCustomer.email);
                    displayCustomerPointHistory([]);
                }
            } catch (error) {
                console.error('í¬ì¸íŠ¸ ì´ë ¥ ë¡œë“œ ì‹¤íŒ¨:', error);
                showStoreAlert('ãƒã‚¤ãƒ³ãƒˆå±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
            }
        }

        // ê³ ê° í¬ì¸íŠ¸ ì´ë ¥ í‘œì‹œ
        function displayCustomerPointHistory(history) {
            const container = document.getElementById('customer-point-history');
            
            if (!container) {
                console.error('í¬ì¸íŠ¸ ì´ë ¥ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            if (!history || history.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-history fa-2x mb-2"></i>
                        <p class="japanese-text">ãƒã‚¤ãƒ³ãƒˆå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                `;
                return;
            }

            const historyHTML = history.map(item => {
                const getTimestamp = (item) => {
                    if (!item) return new Date(0);
                    
                    // createdAtì´ Firestore Timestampì¸ ê²½ìš°
                    if (item.createdAt && item.createdAt.toDate && typeof item.createdAt.toDate === 'function') {
                        return item.createdAt.toDate();
                    }
                    
                    // timestampê°€ Firestore Timestampì¸ ê²½ìš°
                    if (item.timestamp && item.timestamp.toDate && typeof item.timestamp.toDate === 'function') {
                        return item.timestamp.toDate();
                    }
                    
                    // createdAtì´ ì¼ë°˜ ë‚ ì§œ ë¬¸ìì—´ì´ë‚˜ ìˆ«ìì¸ ê²½ìš°
                    if (item.createdAt) {
                        const date = new Date(item.createdAt);
                        if (!isNaN(date.getTime())) {
                            return date;
                        }
                    }
                    
                    // timestampê°€ ì¼ë°˜ ë‚ ì§œ ë¬¸ìì—´ì´ë‚˜ ìˆ«ìì¸ ê²½ìš°
                    if (item.timestamp) {
                        const date = new Date(item.timestamp);
                        if (!isNaN(date.getTime())) {
                            return date;
                        }
                    }
                    
                    // í˜„ì¬ ì‹œê°„ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©
                    return new Date();
                };

                const date = getTimestamp(item);
                const dateStr = date.toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const points = item.points || 0;
                const isEarn = item.type === 'earn' || item.type === 'admin_add' || item.type === 'welcome_bonus' || item.type === 'purchase_points';
                const isUse = item.type === 'use' || item.type === 'admin_subtract';
                const pointsStr = isEarn ? `+${points}` : `-${Math.abs(points)}`;
                const pointsClass = isEarn ? 'positive' : 'negative';

                let description = '';
                if (item.reason) {
                    description = item.reason;
                } else if (item.description) {
                    description = item.description;
                }
                
                // í•œê¸€ í…ìŠ¤íŠ¸ë¥¼ ì¼ë³¸ì–´ë¡œ ë³€ê²½
                if (description.includes('ì‹ ê·œ ê°€ì… ì›°ì»´ ë³´ë„ˆìŠ¤')) {
                    description = description.replace('ì‹ ê·œ ê°€ì… ì›°ì»´ ë³´ë„ˆìŠ¤', 'æ–°è¦ç™»éŒ²ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒœãƒ¼ãƒŠã‚¹');
                }
                if (description.includes('ì›°ì»´ ë³´ë„ˆìŠ¤')) {
                    description = description.replace('ì›°ì»´ ë³´ë„ˆìŠ¤', 'ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒœãƒ¼ãƒŠã‚¹');
                }
                if (description.includes('ì‹ ê·œ ê°€ì…')) {
                    description = description.replace('ì‹ ê·œ ê°€ì…', 'æ–°è¦ç™»éŒ²');
                }

                return `
                    <div class="point-history-item">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="point-description japanese-text">${description}</div>
                                <small class="text-muted japanese-text">${dateStr}</small>
                            </div>
                            <div class="col-md-6 text-end">
                                <div class="point-amount ${pointsClass} japanese-text">${pointsStr} pt</div>
                                ${item.balance ? `<small class="text-muted japanese-text">æ®‹é«˜: ${item.balance} pt</small>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = historyHTML;
        }

        // í¬ì¸íŠ¸ ì´ë ¥ ìƒˆë¡œê³ ì¹¨ (ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì™€ ë™ì¼)
        // ê³ ê° í¬ì¸íŠ¸ ì´ë ¥ ìƒˆë¡œê³ ì¹¨
        function refreshCustomerPointHistory() {
            if (currentCustomer && currentCustomer.uid) {
                loadCustomerPointHistory();
                showStoreAlert('ãƒã‚¤ãƒ³ãƒˆå±¥æ­´ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            } else {
                showStoreAlert('é¡§å®¢æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
            }
        }

        // CSV ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        function downloadPointHistoryCSV() {
            console.log('=== CSV ë‹¤ìš´ë¡œë“œ ì‹œì‘ ===');
            
            // í˜„ì¬ í‘œì‹œëœ í¬ì¸íŠ¸ ì´ë ¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const pointHistoryData = getCurrentDisplayedPointHistory();
            
            if (!pointHistoryData || pointHistoryData.length === 0) {
                showStoreAlert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
                return;
            }
            
            // CSV ë°ì´í„° ìƒì„±
            const csvContent = generateCSVContent(pointHistoryData);
            
            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            downloadCSVFile(csvContent, 'å–å¼•å±¥æ­´.csv');
            
            console.log('=== CSV ë‹¤ìš´ë¡œë“œ ì™„ë£Œ ===');
        }

        // í˜„ì¬ í‘œì‹œëœ í¬ì¸íŠ¸ ì´ë ¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function getCurrentDisplayedPointHistory() {
            console.log('í˜„ì¬ í‘œì‹œëœ í¬ì¸íŠ¸ ì´ë ¥ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...');
            
            // ì „ì²´ í¬ì¸íŠ¸ ì´ë ¥ì—ì„œ í˜„ì¬ í•„í„°ë§ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            if (allPointHistory && allPointHistory.length > 0) {
                // í˜„ì¬ í•„í„° ì„¤ì •ì— ë”°ë¼ ë°ì´í„° í•„í„°ë§
                const filteredData = filterPointHistoryForCSV();
                console.log('í•„í„°ë§ëœ ë°ì´í„°:', filteredData.length, 'ê±´');
                return filteredData;
            }
            
            console.log('í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
            return [];
        }

        // CSVìš© í¬ì¸íŠ¸ ì´ë ¥ í•„í„°ë§
        function filterPointHistoryForCSV() {
            if (!allPointHistory || allPointHistory.length === 0) {
                return [];
            }

            // í˜„ì¬ í•„í„° ì„¤ì • ê°€ì ¸ì˜¤ê¸°
            const currentPeriodType = document.querySelector('input[name="period"]:checked')?.value || 'day';
            const currentViewDate = new Date();
            
            // ë‚ ì§œ ë²”ìœ„ ê³„ì‚°
            let start, end;
            switch (currentPeriodType) {
                case 'day':
                    start = new Date(currentViewDate);
                    start.setHours(0, 0, 0, 0);
                    end = new Date(currentViewDate);
                    end.setHours(23, 59, 59, 999);
                    break;
                case 'week':
                    start = new Date(currentViewDate);
                    start.setDate(currentViewDate.getDate() - currentViewDate.getDay());
                    start.setHours(0, 0, 0, 0);
                    end = new Date(start);
                    end.setDate(start.getDate() + 6);
                    end.setHours(23, 59, 59, 999);
                    break;
                case 'month':
                    start = new Date(currentViewDate.getFullYear(), currentViewDate.getMonth(), 1);
                    end = new Date(currentViewDate.getFullYear(), currentViewDate.getMonth() + 1, 0);
                    end.setHours(23, 59, 59, 999);
                    break;
                default:
                    start = new Date(0);
                    end = new Date();
            }

            // ë°ì´í„° í•„í„°ë§
            return allPointHistory.filter(item => {
                try {
                    let itemDate;
                    if (item.createdAt && item.createdAt.toDate) {
                        itemDate = item.createdAt.toDate();
                    } else if (item.createdAt && item.createdAt.seconds) {
                        itemDate = new Date(item.createdAt.seconds * 1000);
                    } else if (item.timestamp && item.timestamp.toDate) {
                        itemDate = item.timestamp.toDate();
                    } else if (item.timestamp && item.timestamp.seconds) {
                        itemDate = new Date(item.timestamp.seconds * 1000);
                    } else {
                        itemDate = new Date(item.createdAt || item.timestamp);
                    }
                    
                    if (isNaN(itemDate.getTime())) {
                        return false;
                    }
                    
                    return itemDate >= start && itemDate <= end;
            } catch (error) {
                    console.error('ë‚ ì§œ ë³€í™˜ ì˜¤ë¥˜:', error, item);
                    return false;
                }
            }).sort((a, b) => {
                // ìµœì‹ ìˆœ ì •ë ¬
                const dateA = a.createdAt?.toDate?.() || new Date(a.createdAt?.seconds * 1000) || new Date(a.createdAt);
                const dateB = b.createdAt?.toDate?.() || new Date(b.createdAt?.seconds * 1000) || new Date(b.createdAt);
                return dateB - dateA;
            });
        }

        // CSV ë‚´ìš© ìƒì„±
        function generateCSVContent(data) {
            console.log('CSV ë‚´ìš© ìƒì„± ì¤‘...');
            
            // CSV í—¤ë”
            const headers = [
                'æ—¥ä»˜',
                'æ™‚é–“', 
                'é¡§å®¢ãƒ¡ãƒ¼ãƒ«',
                'å–å¼•ã‚¿ã‚¤ãƒ—',
                'èª¬æ˜',
                'ãƒã‚¤ãƒ³ãƒˆæ•°',
                'æ®‹é«˜'
            ];
            
            // CSV ë°ì´í„° í–‰ ìƒì„±
            const rows = data.map(item => {
                const isEarn = item.type === 'earn' || item.type === 'admin_add' || item.type === 'welcome_bonus' || item.type === 'purchase_points';
                const isUse = item.type === 'use' || item.type === 'admin_subtract';
                
                // ë‚ ì§œ/ì‹œê°„ ì²˜ë¦¬
                let itemDate, dateStr, timeStr;
                try {
                    if (item.createdAt && item.createdAt.toDate) {
                        itemDate = item.createdAt.toDate();
                    } else if (item.createdAt && item.createdAt.seconds) {
                        itemDate = new Date(item.createdAt.seconds * 1000);
                    } else if (item.timestamp && item.timestamp.toDate) {
                        itemDate = item.timestamp.toDate();
                    } else if (item.timestamp && item.timestamp.seconds) {
                        itemDate = new Date(item.timestamp.seconds * 1000);
                    } else {
                        itemDate = new Date(item.createdAt || item.timestamp);
                    }
                    
                    dateStr = itemDate.toLocaleDateString('ja-JP');
                    timeStr = itemDate.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                } catch (error) {
                    console.error('ë‚ ì§œ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    dateStr = 'ä¸æ˜';
                    timeStr = 'ä¸æ˜';
                }
                
                // ê³ ê° ì´ë©”ì¼
                const customerEmail = item.userEmail || item.customerEmail || item.userId || 'ä¸æ˜';
                
                // ê±°ë˜ íƒ€ì…
                const transactionType = isEarn ? 'ãƒã‚¤ãƒ³ãƒˆä»˜ä¸' : isUse ? 'ãƒã‚¤ãƒ³ãƒˆä½¿ç”¨' : 'ãã®ä»–';
                
                // ì„¤ëª…
                let description = getPointDescription(item);
                
                // í¬ì¸íŠ¸ ìˆ˜ (ë¶€í˜¸ í¬í•¨)
                const points = item.points || 0;
                const pointsStr = isEarn ? `+${points}` : `-${Math.abs(points)}`;
                
                // ì”ì•¡
                const balance = item.balanceAfter || item.balance || 'ä¸æ˜';
                
                return [
                    dateStr,
                    timeStr,
                    customerEmail,
                    transactionType,
                    description,
                    pointsStr,
                    balance
                ];
            });
            
            // CSV ë¬¸ìì—´ ìƒì„±
            const csvRows = [headers, ...rows];
            const csvContent = csvRows.map(row => 
                row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
            ).join('\n');
            
            console.log('CSV ë‚´ìš© ìƒì„± ì™„ë£Œ:', csvRows.length, 'í–‰');
            return csvContent;
        }

        // CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        function downloadCSVFile(content, filename) {
            console.log('CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹œì‘:', filename);
            
            // BOM ì¶”ê°€ (Excelì—ì„œ í•œê¸€ ê¹¨ì§ ë°©ì§€)
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + content], { type: 'text/csv;charset=utf-8;' });
            
            // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
            
            console.log('CSV íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
            showStoreAlert(`${filename}ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`, 'success');
        }

        // ë¡œë”© í‘œì‹œ
        function showLoading() {
            // ê°„ë‹¨í•œ ë¡œë”© í‘œì‹œ (í•„ìš”ì‹œ êµ¬í˜„)
            console.log('Loading...');
        }

        // ë¡œë”© ìˆ¨ê¹€
        function hideLoading() {
            console.log('Loading complete');
        }

        // QRì½”ë“œ ë””ë²„ê¹… í•¨ìˆ˜ (Firebase ê¸°ë°˜)
        async function debugQRTokens() {
            console.log('=== QRí† í° ë””ë²„ê¹… (Firebase ê¸°ë°˜) ===');
            
            try {
                // Firebaseì—ì„œ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ (ìµœê·¼ 10ëª…)
                const usersSnapshot = await firebase.firestore()
                    .collection('users')
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .get();
                
                console.log('Firebase ì‚¬ìš©ì ìˆ˜:', usersSnapshot.size);
                
                usersSnapshot.forEach((doc, index) => {
                    const user = doc.data();
                console.log(`${index + 1}. ${user.email}`);
                    console.log(`   uid: ${doc.id}`);
                console.log(`   qrToken: ${user.qrToken || 'ì—†ìŒ'}`);
                console.log(`   points: ${user.points || 0}`);
            });
            
                // í˜„ì¬ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
                const currentUser = firebase.auth().currentUser;
                if (currentUser) {
                    console.log('í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì:', currentUser.email);
                } else {
                    console.log('ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì—†ìŒ');
                }
                
            } catch (error) {
                console.error('Firebase ì‚¬ìš©ì ì¡°íšŒ ì‹¤íŒ¨:', error);
            }
        }
        
        // í…ŒìŠ¤íŠ¸ QRì½”ë“œ ìƒì„± (Firebase ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½ë¨)
        async function generateTestQRToken() {
            try {
                // TODO: Firebase Authë¥¼ í†µí•œ í˜„ì¬ ì‚¬ìš©ì í™•ì¸
                console.log('Testing QR token generation...');
                
                // í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì í™•ì¸
                const currentUser = firebase.auth().currentUser;
                if (!currentUser) {
                    console.error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
                    return;
                }
                
                const result = await FirebaseService.generateUserQRToken(currentUser.uid);
                console.log('QR token generation result:', result);
                
                if (result.success) {
                    alert('QR Token Generated Successfully: ' + result.qrToken);
                } else {
                    alert('QR Token Generation Failed: ' + result.error);
                }
            } catch (error) {
                console.error('QR token generation error:', error);
                alert('QR Token Generation Error');
            }
        }
        
        // QRì½”ë“œ ê°•ì œ í…ŒìŠ¤íŠ¸
        function testQRCode(qrToken) {
            if (!qrToken) {
                qrToken = prompt('QRí† í°ì„ ì…ë ¥í•˜ì„¸ìš”:');
            }
            if (qrToken) {
                console.log('ê°•ì œ QRí† í° í…ŒìŠ¤íŠ¸:', qrToken);
                processQRCode(qrToken);
            }
        }
        
        // ì „ì—­ í•¨ìˆ˜ë“¤ì„ ë…¸ì¶œ
        window.debugQRTokens = debugQRTokens;
        window.generateTestQRToken = generateTestQRToken;
        window.testQRCode = testQRCode;
        
        // í¬ì¸íŠ¸ ì´ìš©í˜„í™© ê´€ë ¨ ë³€ìˆ˜
        let allPointHistory = [];
        let filteredPointHistory = [];
        let historyListener = null;
        let currentViewDate = new Date();
        let currentPeriodType = 'day'; // ê¸°ë³¸ì ìœ¼ë¡œ ì¼ë³„ë¡œ í‘œì‹œ // day, week, month

        // í˜ì´ì§€ ë¡œë“œ ì‹œ í¬ì¸íŠ¸ ì´ìš©í˜„í™© ìë™ ë¡œë“œ
        function initializePointHistory() {
            console.log('í¬ì¸íŠ¸ ì´ìš©í˜„í™© ì´ˆê¸°í™”');
            updateDateDisplay();
            
            // ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
            if (allPointHistory.length === 0) {
                loadAllPointHistory();
            } else {
                console.log('í¬ì¸íŠ¸ ì´ë ¥ì´ ì´ë¯¸ ë¡œë“œë¨, í•„í„°ë§Œ ì ìš©');
                filterPointHistory();
            }
        }

        // ì „ì²´ í¬ì¸íŠ¸ ì´ë ¥ ë¡œë“œ
        async function loadAllPointHistory() {
            try {
                console.log('=== í¬ì¸íŠ¸ ì´ë ¥ ë¡œë“œ ì‹œì‘ ===');
                
                // Firebase ìƒíƒœ ì¬í™•ì¸
                if (!firebase || !firebase.firestore || !firebase.auth) {
                    throw new Error('Firebaseê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                }
                
                console.log('Firebase ìƒíƒœ í™•ì¸:', {
                    firebase: typeof firebase,
                    firestore: typeof firebase?.firestore,
                    auth: typeof firebase?.auth
                });
                
                // ë¡œë”© í‘œì‹œ
                const historyList = document.getElementById('point-history-list');
                historyList.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-secondary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="japanese-text mt-2">å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                `;

                // Firebaseì—ì„œ í¬ì¸íŠ¸ ì´ë ¥ ê°€ì ¸ì˜¤ê¸°
                console.log('pointHistory ì»¬ë ‰ì…˜ ì¿¼ë¦¬ ì‹œì‘...');
                const snapshot = await firebase.firestore().collection('pointHistory').get();
                console.log('ì¿¼ë¦¬ ì™„ë£Œ, ë¬¸ì„œ ìˆ˜:', snapshot.size);
                
                allPointHistory = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    console.log('ë¬¸ì„œ ë°ì´í„°:', doc.id, data);
                    allPointHistory.push({
                        id: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt || data.timestamp)
                    });
                });

                // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
                allPointHistory.sort((a, b) => b.createdAt - a.createdAt);
                
                console.log('í¬ì¸íŠ¸ ì´ë ¥ ë¡œë“œ ì™„ë£Œ:', allPointHistory.length, 'ê°œ');
                console.log('ì´ë ¥ ë°ì´í„°:', allPointHistory);
                
                // ì´ˆê¸° í•„í„° ì ìš©
                console.log('ì´ˆê¸° í•„í„° ì ìš© ì‹œì‘...');
                filterPointHistory();
                console.log('ì´ˆê¸° í•„í„° ì ìš© ì™„ë£Œ');
                
                // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì‹œì‘ (í•œ ë²ˆë§Œ)
                if (!historyListener) {
                    startHistoryListener();
                }
                
            } catch (error) {
                console.error('í¬ì¸íŠ¸ ì´ë ¥ ë¡œë“œ ì˜¤ë¥˜:', error);
                console.error('ì˜¤ë¥˜ ìƒì„¸:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                document.getElementById('point-history-list').innerHTML = `
                    <div class="text-center py-4">
                        <p class="japanese-text text-danger">å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
                        <p class="japanese-text text-muted small">${error.message}</p>
                        <button class="btn btn-outline-secondary btn-sm" onclick="loadAllPointHistory()">å†è©¦è¡Œ</button>
                    </div>
                `;
            }
        }

        // ì‹¤ì‹œê°„ ì´ë ¥ ë¦¬ìŠ¤ë„ˆ ì‹œì‘
        function startHistoryListener() {
            if (historyListener) {
                console.log('ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬');
                historyListener();
                historyListener = null;
            }
            
            console.log('ì‹¤ì‹œê°„ í¬ì¸íŠ¸ ì´ë ¥ ë¦¬ìŠ¤ë„ˆ ì‹œì‘...');
            historyListener = firebase.firestore()
                .collection('pointHistory')
                .onSnapshot((snapshot) => {
                    console.log('ì‹¤ì‹œê°„ í¬ì¸íŠ¸ ì´ë ¥ ë³€ê²½ ê°ì§€:', {
                        ë³€ê²½ì‚¬í•­: snapshot.docChanges().length,
                        ì „ì²´ë¬¸ì„œìˆ˜: snapshot.size
                    });
                    
                    // ë¬´í•œ ë£¨í”„ ë°©ì§€: ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸í•˜ê³  ë¦¬ìŠ¤ë„ˆëŠ” ì¬ì‹œì‘í•˜ì§€ ì•ŠìŒ
                    updatePointHistoryFromSnapshot(snapshot);
                }, (error) => {
                    console.error('ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:', error);
                });
        }

        // ìŠ¤ëƒ…ìƒ·ì—ì„œ í¬ì¸íŠ¸ ì´ë ¥ ì—…ë°ì´íŠ¸ (ë¬´í•œ ë£¨í”„ ë°©ì§€)
        function updatePointHistoryFromSnapshot(snapshot) {
            console.log('ìŠ¤ëƒ…ìƒ·ì—ì„œ í¬ì¸íŠ¸ ì´ë ¥ ì—…ë°ì´íŠ¸...');
            
            allPointHistory = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                allPointHistory.push({
                    id: doc.id,
                    ...data,
                    createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(data.createdAt || data.timestamp)
                });
            });

            // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
            allPointHistory.sort((a, b) => b.createdAt - a.createdAt);
            
            console.log('í¬ì¸íŠ¸ ì´ë ¥ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', allPointHistory.length, 'ê°œ');
            
            // í•„í„°ë§Œ ë‹¤ì‹œ ì ìš© (ë¦¬ìŠ¤ë„ˆ ì¬ì‹œì‘í•˜ì§€ ì•ŠìŒ)
            filterPointHistory();
        }

        // ì‹¤ì‹œê°„ ì´ë ¥ ë¦¬ìŠ¤ë„ˆ ì •ì§€
        function stopHistoryListener() {
            if (historyListener) {
                historyListener();
                historyListener = null;
            }
        }

        // ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ë“¤
        function navigateDate(direction) {
            if (currentPeriodType === 'day') {
                currentViewDate.setDate(currentViewDate.getDate() + direction);
            } else if (currentPeriodType === 'week') {
                currentViewDate.setDate(currentViewDate.getDate() + (direction * 7));
            } else if (currentPeriodType === 'month') {
                currentViewDate.setMonth(currentViewDate.getMonth() + direction);
            }
            
            updateDateDisplay();
            filterPointHistory();
        }

        function changePeriodType() {
            currentPeriodType = document.getElementById('period-type-filter').value;
            updateDateDisplay();
            filterPointHistory();
        }

        function goToToday() {
            currentViewDate = new Date();
            updateDateDisplay();
            filterPointHistory();
        }

        function updateDateDisplay() {
            const dateDisplay = document.getElementById('current-date-display');
            const rangeDisplay = document.getElementById('date-range-display');
            
            if (currentPeriodType === 'day') {
                const isToday = isSameDay(currentViewDate, new Date());
                dateDisplay.textContent = isToday ? 'ä»Šæ—¥' : formatDate(currentViewDate);
                rangeDisplay.textContent = '';
            } else if (currentPeriodType === 'week') {
                const weekStart = getWeekStart(currentViewDate);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                
                const isThisWeek = isSameWeek(currentViewDate, new Date());
                dateDisplay.textContent = isThisWeek ? 'ä»Šé€±' : `é€± (${formatDate(weekStart)} - ${formatDate(weekEnd)})`;
                rangeDisplay.textContent = '';
            } else if (currentPeriodType === 'month') {
                const isThisMonth = isSameMonth(currentViewDate, new Date());
                dateDisplay.textContent = isThisMonth ? 'ä»Šæœˆ' : formatMonth(currentViewDate);
                rangeDisplay.textContent = '';
            }
        }

        function formatDate(date) {
            return date.toLocaleDateString('ja-JP', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function formatMonth(date) {
            return date.toLocaleDateString('ja-JP', { 
                year: 'numeric', 
                month: 'long' 
            });
        }

        function isSameDay(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }

        function isSameWeek(date1, date2) {
            const week1 = getWeekStart(date1);
            const week2 = getWeekStart(date2);
            return isSameDay(week1, week2);
        }

        function isSameMonth(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth();
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // ì›”ìš”ì¼ ì‹œì‘
            d.setDate(diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function getDateRange() {
            const start = new Date(currentViewDate);
            const end = new Date(currentViewDate);
            
            if (currentPeriodType === 'day') {
                start.setHours(0, 0, 0, 0);
                end.setHours(23, 59, 59, 999);
            } else if (currentPeriodType === 'week') {
                start = getWeekStart(currentViewDate);
                end = new Date(start);
                end.setDate(start.getDate() + 6);
                end.setHours(23, 59, 59, 999);
            } else if (currentPeriodType === 'month') {
                start.setDate(1);
                start.setHours(0, 0, 0, 0);
                end.setMonth(end.getMonth() + 1);
                end.setDate(0);
                end.setHours(23, 59, 59, 999);
            }
            
            return { start, end };
        }

        // í¬ì¸íŠ¸ ì´ë ¥ í•„í„°ë§
        function filterPointHistory() {
            const typeFilter = document.getElementById('type-filter').value;

            console.log('í•„í„° ì ìš©:', { currentPeriodType, typeFilter, currentViewDate });

            let filtered = [...allPointHistory];
            
            // ë‚ ì§œ ë²”ìœ„ í•„í„°
            const { start, end } = getDateRange();
            console.log('ë‚ ì§œ ë²”ìœ„:', { start: start.toISOString(), end: end.toISOString() });
            
            filtered = filtered.filter(item => {
                // Firestore Timestampë¥¼ Dateë¡œ ë³€í™˜
                let itemDate;
                try {
                    if (item.createdAt && item.createdAt.toDate) {
                        itemDate = item.createdAt.toDate();
                    } else if (item.createdAt && item.createdAt.seconds) {
                        itemDate = new Date(item.createdAt.seconds * 1000);
                    } else if (item.createdAt instanceof Date) {
                        itemDate = item.createdAt;
                    } else {
                        console.log('ë‚ ì§œ ë³€í™˜ ì‹¤íŒ¨:', item.createdAt);
                        return false;
                    }
                    
                    // ìœ íš¨í•œ ë‚ ì§œì¸ì§€ í™•ì¸
                    if (isNaN(itemDate.getTime())) {
                        console.warn('ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œ:', itemDate, item);
                        return false;
                    }
                    
                    const isInRange = itemDate >= start && itemDate <= end;
                    console.log('ë‚ ì§œ ë¹„êµ:', {
                        itemDate: itemDate.toISOString(),
                        isInRange,
                        userId: item.userId || item.userEmail
                    });
                    
                    return isInRange;
                } catch (error) {
                    console.error('ë‚ ì§œ í•„í„°ë§ ì˜¤ë¥˜:', error, item);
                    return false;
                }
            });

            // íƒ€ì… í•„í„°
            if (typeFilter !== 'all') {
                if (typeFilter === 'earn') {
                    filtered = filtered.filter(item => 
                        item.type === 'earn' || 
                        item.type === 'admin_add' || 
                        item.type === 'welcome_bonus' ||
                        item.type === 'purchase_points'
                    );
                } else if (typeFilter === 'use') {
                    filtered = filtered.filter(item => 
                        item.type === 'use' || 
                        item.type === 'admin_subtract'
                    );
                }
            }

            filteredPointHistory = filtered;
            displayFilteredHistory();
            updateStatsSummary();
        }

        // í•„í„°ë§ëœ ì´ë ¥ í‘œì‹œ
        function displayFilteredHistory() {
            console.log('=== ì´ë ¥ í‘œì‹œ ì‹œì‘ ===');
            console.log('í•„í„°ë§ëœ ì´ë ¥ ê°œìˆ˜:', filteredPointHistory.length);
            
            const historyList = document.getElementById('point-history-list');
            console.log('historyList ìš”ì†Œ:', historyList);
            
            if (filteredPointHistory.length === 0) {
                console.log('í‘œì‹œí•  ì´ë ¥ì´ ì—†ìŒ');
                historyList.innerHTML = `
                    <div class="text-center py-4">
                        <p class="japanese-text text-muted">è©²å½“ã™ã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                `;
                return;
            }

            let html = '';
            console.log('HTML ìƒì„± ì‹œì‘...');
            
            filteredPointHistory.forEach((item, index) => {
                const isEarn = item.type === 'earn' || item.type === 'admin_add' || item.type === 'welcome_bonus' || item.type === 'purchase_points';
                const isUse = item.type === 'use' || item.type === 'admin_subtract';
                
                const customerEmail = item.userEmail || item.customerEmail || item.userId || 'ä¸æ˜';
                const dateStr = item.createdAt.toLocaleDateString('ja-JP') + ' ' + item.createdAt.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                const points = item.points || 0;
                const description = getPointDescription(item);
                
                console.log(`ì´ë ¥ ${index + 1}:`, {
                    customerEmail,
                    dateStr,
                    points,
                    description,
                    isEarn,
                    isUse
                });
                
                html += `
                    <div class="history-item ${isEarn ? 'earn' : 'use'}">
                        <div class="history-header">
                            <span class="history-customer">${customerEmail}</span>
                            <span class="history-date">${dateStr}</span>
                        </div>
                        <div class="history-details">
                            <span class="history-description">${description}</span>
                            <span class="history-points ${isEarn ? 'earn' : 'use'}">
                                ${isEarn ? '+' : '-'}${points.toLocaleString()}P
                            </span>
                        </div>
                    </div>
                `;
            });

            console.log('ìƒì„±ëœ HTML ê¸¸ì´:', html.length);
            console.log('HTML ë‚´ìš©:', html.substring(0, 200) + '...');
            
            historyList.innerHTML = html;
            console.log('ì´ë ¥ í‘œì‹œ ì™„ë£Œ');
        }

        // í¬ì¸íŠ¸ ì„¤ëª… ìƒì„±
        function getPointDescription(item) {
            const type = item.type;
            const reason = item.reason || '';
            const description = item.description || '';
            
            switch (type) {
                case 'earn':
                    return reason || 'ãƒã‚¤ãƒ³ãƒˆä»˜ä¸';
                case 'use':
                    // í¬ì¸íŠ¸ ì‚¬ìš© ì‹œ ìƒí’ˆ ì •ë³´ê°€ í¬í•¨ëœ ê²½ìš° íŒŒì‹±
                    if (reason && reason.includes('ãƒã‚¤ãƒ³ãƒˆä½¿ç”¨ - ')) {
                        const productInfo = reason.replace('ãƒã‚¤ãƒ³ãƒˆä½¿ç”¨ - ', '');
                        return `ãƒã‚¤ãƒ³ãƒˆä½¿ç”¨ - ${productInfo}`;
                    }
                    return reason || 'ãƒã‚¤ãƒ³ãƒˆä½¿ç”¨';
                case 'admin_add':
                    return reason || 'ç®¡ç†è€…ã«ã‚ˆã‚‹ãƒã‚¤ãƒ³ãƒˆä»˜ä¸';
                case 'admin_subtract':
                    return reason || 'ç®¡ç†è€…ã«ã‚ˆã‚‹ãƒã‚¤ãƒ³ãƒˆæ¸›ç®—';
                case 'welcome_bonus':
                    return 'æ–°è¦ç™»éŒ²ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒœãƒ¼ãƒŠã‚¹';
                case 'purchase_points':
                    return `è³¼å…¥ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ï¼ˆ3%ï¼‰${reason ? ' - ' + reason : ''}`;
                default:
                    return description || reason || 'ãƒã‚¤ãƒ³ãƒˆå–å¼•';
            }
        }

        // í†µê³„ ìš”ì•½ ì—…ë°ì´íŠ¸
        function updateStatsSummary() {
            console.log('=== í†µê³„ ìš”ì•½ ì—…ë°ì´íŠ¸ ì‹œì‘ ===');
            console.log('í•„í„°ë§ëœ ì´ë ¥ ê°œìˆ˜:', filteredPointHistory.length);
            
            let totalTransactions = filteredPointHistory.length;
            let totalEarned = 0;
            let totalUsed = 0;
            let customers = new Set();

            filteredPointHistory.forEach(item => {
                const customerEmail = item.userEmail || item.customerEmail || item.userId;
                if (customerEmail) {
                    customers.add(customerEmail);
                }

                const points = item.points || 0;
                const isEarn = item.type === 'earn' || item.type === 'admin_add' || item.type === 'welcome_bonus' || item.type === 'purchase_points';
                
                if (isEarn) {
                    totalEarned += points;
                } else {
                    totalUsed += points;
                }
            });

            console.log('ê³„ì‚°ëœ í†µê³„:', {
                totalTransactions,
                totalEarned,
                totalUsed,
                customers: customers.size
            });

            // DOM ìš”ì†Œ ì—…ë°ì´íŠ¸
            const transactionsEl = document.getElementById('total-transactions');
            const earnedEl = document.getElementById('total-earned');
            const usedEl = document.getElementById('total-used');
            const customersEl = document.getElementById('total-customers');

            console.log('DOM ìš”ì†Œ í™•ì¸:', {
                transactionsEl,
                earnedEl,
                usedEl,
                customersEl
            });

            if (transactionsEl) transactionsEl.textContent = totalTransactions.toLocaleString();
            if (earnedEl) earnedEl.textContent = totalEarned.toLocaleString();
            if (usedEl) usedEl.textContent = totalUsed.toLocaleString();
            if (customersEl) customersEl.textContent = customers.size.toLocaleString();

            console.log('í†µê³„ ìš”ì•½ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        }


        // ì´ë ¥ ìƒˆë¡œê³ ì¹¨
        function refreshPointHistory() {
            console.log('í¬ì¸íŠ¸ ì´ë ¥ ìƒˆë¡œê³ ì¹¨');
            loadAllPointHistory();
        }

        // ì „ì—­ í•¨ìˆ˜ ë…¸ì¶œ
        window.filterPointHistory = filterPointHistory;
        window.refreshPointHistory = refreshPointHistory;
        window.navigateDate = navigateDate;
        window.changePeriodType = changePeriodType;
        window.goToToday = goToToday;
        window.scanProductBarcode = scanProductBarcode;
        window.closeBarcodeScanner = closeBarcodeScanner;
        window.switchCamera = switchCamera;
        window.confirmManualBarcode = confirmManualBarcode;

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì¹´ë©”ë¼ ë° ì‹¤ì‹œê°„ ë™ê¸°í™” ì •ë¦¬
        window.addEventListener('beforeunload', async function() {
            stopScanner();
            stopRealTimePointSync();
            stopHistoryListener();
            await closeBarcodeScanner();
        });
    </script>

    <!-- Barcode Scanner Modal -->
    <div class="modal fade" id="barcodeScannerModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title japanese-heading">
                        <i class="fas fa-barcode me-2"></i>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ (ZXing)
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeBarcodeScanner()"></button>
                </div>
                <div class="modal-body p-0">
                    <!-- ì¹´ë©”ë¼ ì˜ì—­ -->
                    <div class="barcode-scanner-container">
                        <div id="barcode-scanner-viewport" class="scanner-viewport">
                            <div class="scanner-overlay">
                                <div class="scanner-frame">
                                    <div class="scanner-corners">
                                        <div class="corner top-left"></div>
                                        <div class="corner top-right"></div>
                                        <div class="corner bottom-left"></div>
                                        <div class="corner bottom-right"></div>
                                    </div>
                                </div>
                            </div>
                            <video id="barcode-video" autoplay playsinline style="display: none;"></video>
                            <canvas id="barcode-canvas" style="display: none;"></canvas>
                        </div>
                        
                        <!-- ìŠ¤ìº” ìƒíƒœ í‘œì‹œ -->
                        <div class="scanner-status">
                            <div id="scanner-status-text" class="status-text japanese-text">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...</div>
                            <div class="scanner-loading" id="scanner-loading">
                                <div class="spinner-border text-light" role="status">
                                    <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ìˆ˜ë™ ì…ë ¥ ì˜ì—­ -->
                    <div class="manual-input-section p-3">
                        <div class="text-center mb-3">
                            <small class="text-muted japanese-text">ã¾ãŸã¯æ‰‹å‹•ã§å…¥åŠ›</small>
                        </div>
                        <div class="input-group">
                            <input type="text" class="form-control" id="manual-barcode-input" 
                                   placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’æ‰‹å‹•ã§å…¥åŠ›">
                            <button class="btn btn-outline-secondary" type="button" onclick="confirmManualBarcode()">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" onclick="closeBarcodeScanner()">
                        <i class="fas fa-times me-2"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="switch-camera-btn" onclick="switchCamera()" style="display: none;">
                        <i class="fas fa-sync-alt me-2"></i>ã‚«ãƒ¡ãƒ©åˆ‡æ›¿
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 