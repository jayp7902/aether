<!DOCTYPE html>
<html lang="en">

<head>
    <title>Aether - Points</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="msapplication-config" content="none">
    <meta name="theme-color" content="#ffffff">

    <link rel="icon" type="image/png" sizes="192x192" href="assets/img/aether-icon.png?t=1750992166">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/img/aether-icon.png?t=1750992166">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/img/aether-icon.png?t=1750992166">
    <link rel="apple-touch-icon" sizes="192x192" href="assets/img/aether-icon.png?t=1750992166">
    <link rel="apple-touch-icon-precomposed" href="assets/img/aether-icon.png?t=1750992166">
    
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/templatemo.css">
    <link rel="stylesheet" href="assets/css/custom.css">

    <!-- Load fonts style after rendering the layout styles -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800;900&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100;200;300;400;500;600;700;800;900&display=swap">
    <style>
        body {
            font-family: "Montserrat", sans-serif;
        }
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
            font-family: "Montserrat", sans-serif;
            font-weight: 600;
        }
        .japanese-text {
            font-family: "Noto Sans JP", "Hiragino Sans", "Yu Gothic", "Meiryo", sans-serif !important;
            font-weight: 400;
            line-height: 1.6;
        }
        .japanese-heading {
            font-family: "Noto Sans JP", "Hiragino Sans", "Yu Gothic", "Meiryo", sans-serif !important;
            font-weight: 600;
            line-height: 1.4;
        }
    </style>
    <link rel="stylesheet" href="assets/css/fontawesome.min.css">
    <style>
        /* User dropdown hover fix */
        .dropdown-toggle:hover,
        .dropdown-toggle:focus,
        #user-name:hover {
            color: #343a40 !important;
            text-decoration: none !important;
        }
        .nav-link:hover {
            color: #343a40 !important;
        }
        
        /* 네비게이션바 텍스트 thin 서체 통일 */
        .navbar-nav .nav-link {
            font-family: "Montserrat", sans-serif !important;
            font-weight: 300 !important;
            font-size: 1rem !important;
        }
        
        .navbar-brand {
            font-family: "Montserrat", sans-serif !important;
            font-weight: 300 !important;
        }
        
        #user-name {
            font-family: "Montserrat", sans-serif !important;
            font-weight: 300 !important;
        }
        
        /* 포인트 페이지 전용 스타일 */
        .point-card {
            background: #fff;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .point-number {
            font-size: 4rem;
            font-weight: 700;
            color: #343a40;
            text-align: center;
            line-height: 1.2;
        }
        
        .point-number strong {
            font-size: 4rem;
            font-weight: 700;
        }
        
        .point-number span {
            font-size: 2rem;
            font-weight: normal;
            color: #6c757d;
        }
        
        .qr-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .qr-code-container {
            text-align: center;
            margin: 20px auto;
            width: 200px;
            height: 200px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .qr-code-container canvas {
            margin: 0 auto;
            border-radius: 4px;
        }
        
        .history-section {
            background: #fff;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>

<body>
    <!-- Start Top Nav -->
    <nav class="navbar navbar-expand-lg bg-black navbar-light d-none d-lg-block" id="templatemo_nav_top" style="min-height: 20px;">
        <div class="container text-light">
            <div class="w-100 d-flex justify-content-between">
                <div>
                    <!-- 빈 공간으로 블랙 바 유지 -->
                </div>
            </div>
        </div>
    </nav>
    <!-- Close Top Nav -->

    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-light shadow">
        <div class="container d-flex justify-content-between align-items-center">
            <!-- QR 코드 아이콘 - 중간 섹션에서만 사용 -->

            <a class="navbar-brand text-success logo align-self-center" href="index.html">
                <img src="assets/img/logo.png" alt="Logo" class="img-fluid" style="max-height: 50px;">
            </a>

            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#templatemo_main_nav" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="align-self-center collapse navbar-collapse flex-fill  d-lg-flex justify-content-lg-between" id="templatemo_main_nav">
                <!-- 모바일 메뉴 레이아웃 -->
                <div class="d-lg-none w-100">
                    <!-- 영문 메뉴 - 가로 정렬 -->
                    <div class="d-flex justify-content-center mb-4">
                        <ul class="nav navbar-nav d-flex flex-row gap-4">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="shop.html">Brand</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="info.html">Info</a>
                        </li>
                    </ul>
                </div>
                    
                    <!-- 아이콘들 - 가로 정렬, 좌우 여백 추가 -->
                    <div class="d-flex justify-content-center align-items-center gap-4 px-4">
                        <a href="cart.html" class="nav-link text-decoration-none">
                            <i class="fas fa-shopping-cart text-dark" style="font-size: 1.5rem;"></i>
                            <span class="badge bg-secondary ms-1" id="cart-count-mobile">0</span>
                        </a>
                        <div class="dropdown">
                            <a href="#" class="nav-link dropdown-toggle text-decoration-none" id="userDropdownMobile" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user text-dark" style="font-size: 1.5rem;"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-center" aria-labelledby="userDropdownMobile">
                                <li id="login-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="login.html">
                                        <i class="fas fa-sign-in-alt me-2"></i>Login
                                    </a>
                                </li>
                                <li id="register-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="register.html">
                                        <i class="fas fa-user-plus me-2"></i>Register
                                    </a>
                                </li>
                                <li id="profile-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="profile.html">
                                        <i class="fas fa-user-circle me-2"></i>Profile
                                    </a>
                                </li>
                                <li id="points-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="points.html">
                                        <i class="fas fa-coins me-2"></i>Points
                                    </a>
                                </li>
                                <li id="admin-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="admin-dashboard.html">
                                        <i class="fas fa-cog me-2"></i>管理ダッシュボード
                                    </a>
                                </li>
                                <li id="logout-menu-mobile" style="display: none;">
                                    <hr class="dropdown-divider">
                                </li>
                                <li id="logout-menu-item-mobile" style="display: none;">
                                    <a class="dropdown-item" href="#" onclick="logout()">
                                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                                    </a>
                                </li>
                            </ul>
                            </div>
                        </div>
                    </div>
                
                <!-- 데스크톱 메뉴 레이아웃 -->
                <div class="flex-fill d-none d-lg-block">
                    <ul class="nav navbar-nav d-flex justify-content-between mx-lg-auto" style="max-width: 400px; margin: 0 auto;">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="shop.html">Brand</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="info.html">Info</a>
                        </li>
                    </ul>
                </div>
                <div class="navbar align-self-center d-flex d-none d-lg-flex">
                    <!-- QR 코드 아이콘 - 중간 섹션에서만 사용 -->
                    <a href="cart.html" class="nav-link text-decoration-none me-3">
                        <i class="fas fa-shopping-cart text-dark"></i>
                        <span class="badge bg-secondary" id="cart-count">0</span>
                    </a>
                    <div class="dropdown">
                        <a href="#" class="nav-link dropdown-toggle text-decoration-none" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user text-dark"></i>
                            <span id="user-name" class="d-none d-lg-inline ms-1"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li id="login-menu" style="display: none;">
                                <a class="dropdown-item" href="login.html">
                                    <i class="fas fa-sign-in-alt me-2"></i>Login
                                </a>
                            </li>
                            <li id="register-menu" style="display: none;">
                                <a class="dropdown-item" href="register.html">
                                    <i class="fas fa-user-plus me-2"></i>Register
                                </a>
                            </li>
                            <li id="profile-menu" style="display: none;">
                                <a class="dropdown-item" href="profile.html">
                                    <i class="fas fa-user-circle me-2"></i>Profile
                                </a>
                            </li>
                            <li id="points-menu" style="display: none;">
                                <a class="dropdown-item" href="points.html">
                                    <i class="fas fa-coins me-2"></i>Points
                                </a>
                            </li>
                            <li id="admin-menu" style="display: none;">
                                <a class="dropdown-item" href="admin-dashboard.html">
                                    <i class="fas fa-cog me-2"></i>管理ダッシュボード
                                </a>
                            </li>
                            <li id="logout-menu" style="display: none;">
                                <hr class="dropdown-divider">
                            </li>
                            <li id="logout-menu-item" style="display: none;">
                                <a class="dropdown-item" href="#" onclick="logout()">
                                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

        </div>
    </nav>
    <!-- Close Header -->

    <!-- Modal -->
    <div class="modal fade bg-white" id="templatemo_search" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="w-100 pt-1 mb-5 text-right">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            <form action="" method="get" class="modal-content modal-body border-0 p-0">
                <div class="input-group mb-2">
                    <input type="text" class="form-control" id="inputModalSearch" name="q" placeholder="Search ...">
                    <button type="submit" class="input-group-text bg-success text-light">
                        <i class="fa fa-fw fa-search text-white"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Start Banner Hero -->
    <div class="py-5" style="background-color: #000000;">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <h1 class="h2 text-center mb-0" style="color: #ffffff; padding-top: 0.5rem;">
                <i class="fas fa-coins me-2" style="color: #ffffff;"></i>MY POINT PAGE
            </h1>
                </div>
            </div>
        </div>
    </div>
    <!-- End Banner Hero -->

    <!-- Points Usage Info Section -->
    <div class="container py-3">
        <div class="row">
            <div class="col-lg-12">
                <div class="alert border-0 shadow-sm" style="background-color: #ffffff; border: 1px solid #e9ecef !important;">
                    <h6 class="japanese-heading mb-3 text-center" style="font-weight: 600; color: #343a40; font-family: 'Noto Sans JP', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif !important;">
                        <i class="fas fa-info-circle me-2" style="color: #6c757d;"></i>ポイントご利用方法
                    </h6>
                    <div class="japanese-text text-center" style="color: #495057; font-size: 0.7rem !important; font-family: 'Noto Sans JP', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif !important;">
                        <p class="mb-2" style="font-size: 0.7rem !important; font-family: 'Noto Sans JP', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif !important;">
                            <strong style="font-size: 0.7rem !important; color: #343a40; font-family: 'Noto Sans JP', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif !important;">*ポイント付与方法：</strong>aether-store.jp 公式ウェブサイト、または店頭にて、購入金額に対し、3%のポイントが付与されます。
                        </p>
                        <p class="mb-0" style="font-size: 0.7rem !important; font-family: 'Noto Sans JP', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif !important;">
                            <strong style="font-size: 0.7rem !important; color: #343a40; font-family: 'Noto Sans JP', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif !important;">**獲得されたポイント：</strong>aether-store.jp 公式ウェブサイト、または店頭にて、ポイント金額に応じた商品と交換いただけます。
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End Points Usage Info Section -->

    <!-- Start Points Section -->
    <div class="container py-5">
        <div class="row">
            <!-- 포인트 카드 -->
            <div class="col-lg-4 mb-4">
                <div class="point-card">
                    <h3 class="text-center mb-4">
                        <i class="fas fa-coins me-2"></i>MY POINTS
                    </h3>
                    <div class="point-number">
                        <strong id="current-points">-</strong>
                        <span>pt</span>
                    </div>
                </div>
            </div>

            <!-- QR 코드 섹션 -->
            <div class="col-lg-8 mb-4">
                <div class="qr-section">
                    <h3 class="mb-4">
                        <i class="fas fa-qrcode me-2"></i>MY QRCODE
                    </h3>
                    <div class="qr-code-container" id="qr-code-container">
                        <div class="spinner-border text-secondary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>

        <!-- 포인트 이력 섹션 -->
        <div class="row">
            <div class="col-12">
                <div class="history-section">
                <h3 class="japanese-heading mb-4">
                    <i class="fas fa-history me-2"></i>ポイント履歴
                </h3>
                    <div id="point-history-container">
                        <div class="text-center text-muted">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <p class="japanese-text">ポイント履歴がありません</p>
                </div>
            </div>
            </div>
            </div>
        </div>
    </div>
    <!-- End Points Section -->

    <!-- QR Code Modal - 페이지에 직접 표시 -->

    <!-- 포인트 이력 테이블 스타일 -->
    <style>
        /* 포인트 이력 테이블 스타일 개선 */
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .table thead th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            padding: 12px 8px;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .table tbody td {
            padding: 12px 8px;
            vertical-align: middle;
        }
        
        /* 주문 정보 스타일 */
        .table tbody td small {
            font-size: 0.85rem;
            line-height: 1.4;
            display: block;
            margin-top: 4px;
        }
        
        .table tbody td .text-muted {
            color: #6c757d !important;
        }
        
        .table tbody td .text-info {
            color: #6c757d !important;
            font-weight: 500;
        }
        
        /* 포인트 표시 스타일 - 모노톤 색상 */
        .table tbody td .text-success {
            color: #212529 !important;
            font-weight: 600;
        }
        
        .table tbody td .text-danger {
            color: #495057 !important;
            font-weight: 600;
        }
        
        /* 반응형 테이블 */
        @media (max-width: 768px) {
            .table thead th,
            .table tbody td {
                padding: 8px 4px;
                font-size: 0.9rem;
            }
            
            .table tbody td small {
                font-size: 0.8rem;
            }
        }
    </style>

    <!-- Start Script -->
    <script src="assets/js/jquery-1.11.0.min.js"></script>
    <script src="assets/js/jquery-migrate-1.2.1.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/templatemo.js"></script>
    
    <!-- QR Code Generator Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <!-- 애플리케이션 스크립트 -->
    <script src="assets/js/logging-utils.js"></script>
    <script src="assets/js/firebase-config-new.js?v=2.2"></script>
    <script src="assets/js/auth-utils-new.js?v=2.2"></script>
    <script src="assets/js/common-qr-code.js?v=2.1"></script>
    <script src="assets/js/custom.js"></script>
    
    <!-- 포인트 페이지 전용 스크립트 -->
    <script>
        // 포인트 페이지 전용 변수들
        let pointsPageUser = null;
        let currentPoints = null; // Firebase에서 로드
        let pointHistory = [];
        let qrToken = null;
        let qrCodeGenerated = false;
        
        // Firebase 전용 QR 토큰 관리

        // QR 코드 관련 함수들은 모두 common-qr-code.js에서 처리


        // 포인트 표시 업데이트 함수
        function updatePointsDisplay() {
            const pointsElement = document.getElementById('current-points');
            console.log('🔍 updatePointsDisplay 호출:', {
                currentPoints: currentPoints,
                pointsElement: pointsElement,
                elementExists: !!pointsElement
            });
            
            if (pointsElement) {
                pointsElement.textContent = currentPoints.toLocaleString();
                console.log('✅ 포인트 표시 업데이트 완료:', currentPoints);
            } else {
                console.error('❌ 포인트 표시 요소를 찾을 수 없습니다');
            }
        }

        // 포인트 정보 로드
        async function loadPointInfo() {
            try {
                console.log('=== 포인트 정보 로드 시작 ===');
            
            if (!pointsPageUser) {
                    console.log('❌ 사용자 정보가 없어 포인트 정보를 로드할 수 없습니다');
                return;
            }

                console.log('포인트 정보 로드 - 사용자:', pointsPageUser);
                console.log('Firebase 상태 확인:', {
                    firebase: typeof firebase !== 'undefined',
                    firestore: typeof firebase !== 'undefined' && firebase.firestore,
                    apps: typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length
                });

                // Firebase에서 포인트 정보 가져오기
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    const db = firebase.firestore();
                    
                    // 이메일을 문서 ID로 직접 검색 (포인트 반환과 동일한 방식)
                    let userDoc = await db.collection('users').doc(pointsPageUser.email).get({ source: 'server' });
                    console.log('이메일을 문서 ID로 검색 결과 (서버에서):', userDoc.exists);
                    
                    if (!userDoc.exists) {
                        // 이메일로 찾지 못한 경우 사용자 ID로 검색 (호환성)
                        console.log('이메일로 찾지 못함, 사용자 ID로 검색 시도');
                        userDoc = await db.collection('users').doc(pointsPageUser.uid).get({ source: 'server' });
                        console.log('사용자 ID로 검색 결과:', userDoc.exists);
                    }
                    
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        const newPoints = userData.points || 0;
                        
                        // 포인트가 변경되었는지 확인
                        if (currentPoints !== newPoints) {
                            console.log(`포인트 변경 감지: ${currentPoints} → ${newPoints}`);
                            currentPoints = newPoints;
                            pointsPageUser.points = currentPoints; // 사용자 정보도 업데이트
                            
                            // UI 업데이트
                            updatePointsDisplay();
                } else {
                            console.log('포인트 변경 없음:', currentPoints);
                        }
                        
                        console.log('Firebase에서 포인트 정보 로드 (최신):', currentPoints);
                        console.log('사용자 데이터:', userData);
                        console.log('🔍 포인트 페이지 포인트 상세 분석:');
                        console.log('  - userData.points:', userData.points);
                        console.log('  - typeof userData.points:', typeof userData.points);
                        console.log('  - userData.points === undefined:', userData.points === undefined);
                        console.log('  - userData.points === null:', userData.points === null);
                        console.log('  - userData.points === 0:', userData.points === 0);
                        console.log('  - userData 전체 키:', Object.keys(userData));
                        
                        // 포인트 표시 강제 업데이트
                        updatePointsDisplay();
                        } else {
                        console.log('사용자 문서가 존재하지 않습니다, 새로 생성');
                        // 사용자 문서가 없으면 새로 생성
                        await db.collection('users').doc(pointsPageUser.uid).set({
                            name: pointsPageUser.name,
                            email: pointsPageUser.email,
                            points: 0,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        // currentPoints는 Firebase에서 로드된 값 사용
                        }
                } else {
                    console.log('Firebase가 사용 불가능합니다');
                    // currentPoints는 Firebase에서 로드된 값 사용
                }

                // 포인트 표시 업데이트 (currentPoints가 null이 아닐 때만)
                if (currentPoints !== null) {
                    updatePointsDisplay();
                }
                        
                        // 포인트 이력 로드가 완료되면 자동으로 포인트가 계산되고 업데이트됩니다

            } catch (error) {
                console.error('포인트 정보 로드 오류:', error);
                // currentPoints는 Firebase에서 로드된 값 사용
                const pointsElement = document.getElementById('current-points');
                if (pointsElement) {
                    pointsElement.textContent = '-';
                }
            }
        }

        // 포인트 이력 로드
        async function loadPointHistory() {
            try {
                console.log('=== 포인트 이력 로드 시작 ===');
                
                if (!pointsPageUser) {
                    console.log('❌ 사용자 정보가 없어 포인트 이력을 로드할 수 없습니다');
                    return;
                }
                
                console.log('포인트 이력 검색 대상:', {
                    uid: pointsPageUser.uid,
                    email: pointsPageUser.email
                });
                
                console.log('Firebase 상태 확인:', {
                    firebase: typeof firebase !== 'undefined',
                    firestore: typeof firebase !== 'undefined' && firebase.firestore,
                    apps: typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length
                });
                
                // Firebase에서 포인트 이력 가져오기
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    const db = firebase.firestore();
                    
                    // 사용자별 포인트 이력 검색
                    let historySnapshot = null;
                    let earnedPoints = 0;
                    let usedPoints = 0;
                    let filteredDocs = [];
                    
                    try {
                        // 서버에서 필터링된 쿼리 사용 (권한 문제 해결)
                        console.log('서버 필터링 쿼리로 포인트 이력 검색 시작');
                        
                        const userEmail = pointsPageUser.email;
                        let allHistory = [];
                        
                        // userEmail로 필터링된 포인트 이력 조회 (인덱스 없이도 작동)
                        console.log('userEmail로 포인트 이력 조회:', userEmail);
                        const pointHistorySnapshot = await db.collection('pointHistory')
                            .where('userEmail', '==', userEmail)
                            .get();
                        
                        console.log('userEmail 조회 결과:', pointHistorySnapshot.size, '건');
                        pointHistorySnapshot.forEach(doc => {
                            const data = doc.data();
                            data.id = doc.id;
                            allHistory.push(data);
                            console.log('userEmail 이력 추가:', data.type, data.points, data.reason);
                        });
                        
                        // customerEmail로도 조회 (중복 제거)
                        console.log('customerEmail로 포인트 이력 조회:', userEmail);
                        const customerPointHistorySnapshot = await db.collection('pointHistory')
                            .where('customerEmail', '==', userEmail)
                            .get();
                        
                        console.log('customerEmail 조회 결과:', customerPointHistorySnapshot.size, '건');
                        
                        customerPointHistorySnapshot.forEach(doc => {
                            const data = doc.data();
                            data.id = doc.id;
                            
                            // 중복 확인
                            const exists = allHistory.some(history => history.id === data.id);
                            if (!exists) {
                                allHistory.push(data);
                                console.log('customerEmail 이력 추가:', data.type, data.points, data.reason);
                            }
                        });
                        
                        // 시간순 정렬 (최신순)
                        allHistory.sort((a, b) => {
                            const timeA = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                            const timeB = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                            return timeB - timeA;
                        });
                        
                        filteredDocs = allHistory;
                        console.log('서버 필터링된 포인트 이력:', filteredDocs.length, '건');
                        console.log('전체 이력 상세:', filteredDocs.map(item => ({
                            id: item.id,
                            type: item.type,
                            points: item.points,
                            reason: item.reason,
                            userEmail: item.userEmail,
                            customerEmail: item.customerEmail
                        })));
                        
                        // 포인트 계산
                        filteredDocs.forEach(item => {
                            const points = item.points || 0;
                            if (item.type === 'earn' || item.type === 'admin_add' || item.type === 'welcome_bonus' || item.type === 'refund') {
                                earnedPoints += points;
                                console.log('적립/환불 포인트 추가:', item.type, points, '총 적립:', earnedPoints);
                            } else if (item.type === 'use' || item.type === 'admin_subtract' || item.type === 'deduction') {
                                usedPoints += Math.abs(points);
                                console.log('사용/차감 포인트 추가:', item.type, Math.abs(points), '총 사용:', usedPoints);
                            }
                        });
                        
                    } catch (queryError) {
                        console.warn('포인트 이력 쿼리 실패:', queryError);
                        historySnapshot = null;
                    }
                    
                    // pointHistory 배열을 filteredDocs로 설정
                    pointHistory = filteredDocs;
                    console.log('포인트 이력 배열 설정 완료:', pointHistory.length, '건');
                    
                    // 포인트 계산 및 업데이트
                    if (pointHistory.length > 0) {
                        pointHistory.forEach(item => {
                            console.log('✅ 사용자 이력 확인:', item.type, item.points, item.reason);
                        });
                        
                        // 포인트 히스토리 기반 계산 (참고용만, Firebase 실제 값 우선)
                        const calculatedPoints = earnedPoints - usedPoints;
                        console.log('🔍 포인트 이력 기반 계산 (참고용):', {
                            earnedPoints,
                            usedPoints,
                            calculatedPoints,
                            firebaseActualPoints: currentPoints, // Firebase 실제 포인트
                            pointHistoryCount: pointHistory.length,
                            pointHistoryDetails: pointHistory.map(item => ({
                                type: item.type,
                                points: item.points,
                                reason: item.reason
                            }))
                        });
                        
                        // Firebase의 실제 포인트 값을 그대로 사용 (히스토리 기반 재계산 제거)
                        console.log('✅ Firebase 실제 포인트 값 사용:', currentPoints);
                        
                        // 포인트 표시만 업데이트 (Firebase 값 변경하지 않음)
                        updatePointsDisplay();
                        
                        // pointHistory 배열을 전역 변수에 저장 (정렬은 표시할 때 수행)
                        window.pointHistory = pointHistory;
                        console.log('✅ pointHistory 전역 저장 완료:', pointHistory.length, '건');
                    }

                    console.log('Firebase에서 포인트 이력 로드 완료:', pointHistory.length, '건');
                } else {
                    console.log('Firebase가 사용 불가능합니다');
                    pointHistory = [];
                }

                // 이력 표시 업데이트
                updatePointHistoryDisplay();
                
                // 포인트 표시도 업데이트 (이력 로드 후)
                if (currentPoints !== null) {
                    updatePointsDisplay();
                }
                
            } catch (error) {
                console.error('포인트 이력 로드 오류:', error);
                pointHistory = [];
                updatePointHistoryDisplay();
            }
        }

        // 페이지 포커스 시 데이터 새로고침 설정
        function setupPageRefresh() {
            console.log('🔄 페이지 포커스 새로고침 설정');
            
            // 페이지 포커스 시 포인트 데이터 새로고침
            window.addEventListener('focus', async () => {
                console.log('📱 페이지 포커스 감지 - 포인트 데이터 새로고침');
                try {
                    await loadPointInfo();
                    await loadPointHistory();
                } catch (error) {
                    console.error('포커스 새로고침 오류:', error);
                }
            });
            
            // 페이지 가시성 변경 시 새로고침
            document.addEventListener('visibilitychange', async () => {
                if (!document.hidden) {
                    console.log('👁️ 페이지 가시성 변경 - 포인트 데이터 새로고침');
                    try {
                        await loadPointInfo();
                        await loadPointHistory();
                    } catch (error) {
                        console.error('가시성 새로고침 오류:', error);
                    }
                }
            });
        }

        // 포인트 이력 표시 업데이트
        function updatePointHistoryDisplay() {
            const container = document.getElementById('point-history-container');
            
            console.log('포인트 이력 표시 업데이트 시작:', pointHistory.length, '건');
            console.log('pointHistory 배열 상세:', pointHistory);
            console.log('container 요소:', container);
            
            if (pointHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p class="japanese-text">ポイント履歴がありません</p>
                        <small class="text-muted japanese-text">商品購入時にポイント履歴が表示されます</small>
                            </div>
                `;
                return;
            }

            // 포인트 이력을 최신 순으로 정렬 (최신이 맨 위에 오도록)
            const sortedHistory = [...pointHistory].sort((a, b) => {
                // 강력한 타임스탬프 처리
                const getTimestamp = (item, index) => {
                    // 1. timestamp 필드 확인
                    if (item && item.timestamp) {
                        try {
                            // Firestore Timestamp 객체인 경우
                            if (item.timestamp.toDate && typeof item.timestamp.toDate === 'function') {
                                const date = item.timestamp.toDate();
                                console.log(`항목 ${index + 1} - Firestore Timestamp:`, date);
                                return date.getTime();
                            }
                            
                            // Date 객체인 경우
                            if (item.timestamp instanceof Date) {
                                console.log(`항목 ${index + 1} - Date 객체:`, item.timestamp);
                                return item.timestamp.getTime();
                            }
                            
                            // 숫자나 문자열인 경우
                            const date = new Date(item.timestamp);
                            if (!isNaN(date.getTime())) {
                                console.log(`항목 ${index + 1} - 문자열/숫자:`, item.timestamp, '→ Date:', date);
                                return date.getTime();
                            }
                        } catch (error) {
                            console.warn(`항목 ${index + 1} - 타임스탬프 파싱 오류:`, error, item.timestamp);
                        }
                    }
                    
                    // 2. createdAt 필드 확인
                    if (item && item.createdAt) {
                        try {
                            if (item.createdAt.toDate && typeof item.createdAt.toDate === 'function') {
                                const date = item.createdAt.toDate();
                                console.log(`항목 ${index + 1} - createdAt Firestore:`, date);
                                return date.getTime();
                            }
                            if (item.createdAt instanceof Date) {
                                console.log(`항목 ${index + 1} - createdAt Date:`, item.createdAt);
                                return item.createdAt.getTime();
                            }
                            const date = new Date(item.createdAt);
                            if (!isNaN(date.getTime())) {
                                console.log(`항목 ${index + 1} - createdAt 문자열:`, item.createdAt, '→ Date:', date);
                                return date.getTime();
                            }
                        } catch (error) {
                            console.warn(`항목 ${index + 1} - createdAt 파싱 오류:`, error);
                        }
                    }
                    
                    // 3. orderDate 필드 확인
                    if (item && item.orderDate) {
                        try {
                            if (item.orderDate.toDate && typeof item.orderDate.toDate === 'function') {
                                const date = item.orderDate.toDate();
                                console.log(`항목 ${index + 1} - orderDate Firestore:`, date);
                                return date.getTime();
                            }
                            if (item.orderDate instanceof Date) {
                                console.log(`항목 ${index + 1} - orderDate Date:`, item.orderDate);
                                return item.orderDate.getTime();
                            }
                            const date = new Date(item.orderDate);
                            if (!isNaN(date.getTime())) {
                                console.log(`항목 ${index + 1} - orderDate 문자열:`, item.orderDate, '→ Date:', date);
                                return date.getTime();
                            }
                        } catch (error) {
                            console.warn(`항목 ${index + 1} - orderDate 파싱 오류:`, error);
                        }
                    }
                    
                    // 4. 문서 ID에서 시간 추출 시도 (문서 ID가 타임스탬프를 포함하는 경우)
                    if (item && item.id) {
                        const timestampMatch = item.id.match(/(\d{13})/); // 13자리 타임스탬프
                        if (timestampMatch) {
                            const timestamp = parseInt(timestampMatch[1]);
                            const date = new Date(timestamp);
                            console.log(`항목 ${index + 1} - ID에서 타임스탬프 추출:`, date);
                            return timestamp;
                        }
                    }
                    
                    // 5. 모든 방법이 실패한 경우 - 배열 인덱스를 기반으로 한 가상 시간 생성
                    // (최신 항목이 배열의 끝에 있다고 가정)
                    const virtualTime = Date.now() - (pointHistory.length - index) * 1000;
                    console.warn(`항목 ${index + 1} - 타임스탬프 없음, 가상 시간 사용:`, new Date(virtualTime));
                    return virtualTime;
                };
                
                const timeA = getTimestamp(a, pointHistory.indexOf(a));
                const timeB = getTimestamp(b, pointHistory.indexOf(b));
                
                // 최신 순으로 정렬 (큰 값이 먼저)
                const diff = timeB - timeA;
                console.log('정렬 비교:', {
                    a: { index: pointHistory.indexOf(a), time: timeA, date: new Date(timeA) },
                    b: { index: pointHistory.indexOf(b), time: timeB, date: new Date(timeB) },
                    diff: diff
                });
                
                return diff;
            });
            
            console.log('포인트 이력 정렬 완료 (최신 순):', sortedHistory.length, '건');
            console.log('정렬된 모든 항목:', sortedHistory.map((item, index) => ({
                index: index + 1,
                timestamp: item.timestamp,
                type: item.type,
                reason: item.reason,
                points: item.points
            })));

            let historyHTML = '<div class="table-responsive"><table class="table table-hover">';
            historyHTML += '<thead><tr><th class="japanese-text">日付</th><th class="japanese-text">内容・注文詳細</th><th class="japanese-text">ポイント</th></tr></thead><tbody>';
            
            sortedHistory.forEach((item, index) => {
                console.log(`이력 ${index + 1}:`, item);
                
                let date;
                try {
                    if (item.timestamp && item.timestamp.toDate) {
                        date = item.timestamp.toDate();
                    } else if (item.timestamp) {
                        date = new Date(item.timestamp);
                    } else {
                        date = new Date();
                    }
                } catch (dateError) {
                    console.warn('날짜 파싱 오류:', dateError, item.timestamp);
                    date = new Date();
                }
                
                const dateStr = date.toLocaleDateString('ja-JP');
                
                // 포인트 표시 로직 개선 (type에 따라 표시)
                const points = item.points || 0; // undefined 처리
                let pointsStr, pointsClass;
                if (item.type === 'use' || item.type === 'admin_subtract') {
                    // 포인트 사용/차감인 경우 음수로 표시
                    pointsStr = `-${points}`;
                    pointsClass = 'text-danger';
                } else if (item.type === 'earn' || item.type === 'admin_add' || item.type === 'refund') {
                    // 포인트 적립/환불인 경우 양수로 표시
                    pointsStr = `+${points}`;
                    pointsClass = 'text-success';
                } else {
                    // 기존 로직 (호환성)
                    pointsStr = points > 0 ? `+${points}` : points;
                    pointsClass = points > 0 ? 'text-success' : 'text-danger';
                }
                
                // 이력 내용 결정 (주문 정보 포함)
                let description = 'ポイント取引';
                let orderInfo = ''; // 주문 정보 추가
                
                if (item.reason) {
                    // 한국어 reason을 일본어로 변환
                    if (item.reason.includes('신규 가입 웰컴 보너스') || item.reason.includes('신규 가입')) {
                        description = '新規登録ウェルカムボーナス';
                    } else if (item.reason.includes('웰컴 보너스')) {
                        description = 'ウェルカムボーナス';
                    } else if (item.reason.includes('포인트 적립')) {
                        description = '商品購入';
                    } else if (item.reason.includes('포인트 사용')) {
                        description = 'ポイント使用';
                    } else if (item.reason.includes('관리자')) {
                        description = '管理者操作';
                    } else {
                        description = item.reason;
                    }
                } else if (item.type === 'earn') {
                    description = '商品購入';
                } else if (item.type === 'use') {
                    description = '商品購入時使用';
                } else if (item.type === 'admin_add') {
                    description = '管理者付与';
                } else if (item.type === 'admin_subtract') {
                    description = '管理者差引';
                } else if (item.type === 'welcome_bonus') {
                    description = '新規登録ウェルカムボーナス';
                } else if (item.type === 'refund') {
                    description = '注文キャンセル返還';
                } else if (item.description) {
                    description = item.description;
                }
                
                // 금액 정보 제거 (¥3,500 등)
                if (description && description.includes('¥')) {
                    description = description.replace(/\s*¥[\d,]+/g, '');
                }
                
                // 간단한 설명만 표시 (상세 정보 제거)
                historyHTML += `
                    <tr>
                        <td class="japanese-text">${dateStr}</td>
                        <td class="japanese-text">${description}</td>
                        <td class="${pointsClass} japanese-text">${pointsStr}</td>
                    </tr>
                `;
            });
            
            historyHTML += '</tbody></table></div>';
            container.innerHTML = historyHTML;
            
            console.log('포인트 이력 표시 업데이트 완료');
        }

        // Firebase Auth 상태를 기다리는 함수
        async function waitForFirebaseAuth() {
            return new Promise((resolve) => {
                if (typeof firebase === 'undefined' || !firebase.auth) {
                    console.log('Firebase가 아직 로드되지 않음, 대기 중...');
                    const checkFirebase = setInterval(() => {
                        if (typeof firebase !== 'undefined' && firebase.auth) {
                            clearInterval(checkFirebase);
                            waitForAuthState();
                        }
                    }, 100);
                    return;
                }
                
                waitForAuthState();
                
                function waitForAuthState() {
                    // 이미 로그인된 사용자가 있는지 확인
                    const currentUser = firebase.auth().currentUser;
                    if (currentUser) {
                        console.log('이미 로그인된 사용자 발견:', currentUser.email);
                        resolve(currentUser);
                        return;
                    }
                    
                    // Auth 상태 변화를 기다림 (최대 5초)
                    let timeoutId = setTimeout(() => {
                        console.log('Firebase Auth 상태 확인 시간 초과');
                        resolve(null);
                    }, 5000);
                    
                    const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
                        clearTimeout(timeoutId);
                        unsubscribe();
                        if (user) {
                            console.log('Firebase Auth 상태 확인 완료:', user.email);
                            resolve(user);
                        } else {
                            console.log('Firebase Auth에서 사용자를 찾을 수 없음');
                            resolve(null);
                        }
                    });
                }
            });
        }

        // 현재 사용자 정보 가져오기 (Firebase Auth 전용)
        function getCurrentUser() {
            console.log('🔍 points.html getCurrentUser 호출');
            
            // Firebase 사용자만 확인
            try {
                if (typeof firebase !== 'undefined' && firebase.auth && firebase.apps && firebase.apps.length > 0) {
                    const firebaseUser = firebase.auth().currentUser;
                    console.log('🔍 points.html Firebase currentUser:', firebaseUser ? firebaseUser.email : 'null');
                    
                    if (firebaseUser) {
                        console.log('✅ points.html Firebase 사용자 확인됨:', firebaseUser.email);
                        return firebaseUser;
                    } else {
                        console.log('❌ points.html Firebase 사용자 없음 (로그아웃 상태)');
                    }
                } else {
                    console.log('❌ points.html Firebase 초기화되지 않음');
                }
            } catch (error) {
                console.warn('points.html Firebase 사용자 확인 중 오류:', error);
            }
            
            console.log('❌ points.html 로그인된 사용자 없음');
            return null;
        }

        // 로그인 상태 확인 함수 (프로필 페이지와 동일)
        function getLoginStatus() {
            try {
                // Firebase Auth에서 현재 사용자 정보 가져오기
                const user = firebase.auth().currentUser;
                if (user) {
                    return {
                        uid: user.uid,
                        email: user.email,
                        name: user.displayName || user.email.split('@')[0]
                    };
                }
                
                // Firebase 사용자가 없으면 null 반환
                return null;
            } catch (error) {
                console.error('로그인 상태 확인 중 오류:', error);
                return null;
            }
        }

        // 페이지 초기화
        async function initializePointsPage() {
            console.log('=== 포인트 페이지 초기화 시작 ===');
            
            // 현재 사용자 정보 가져오기
            let userData = null;
            let userPoints = 0;
            
            try {
                // Firebase Auth 사용자 확인 (더 안전한 방식)
                console.log('Firebase 상태 확인:', {
                    firebase: typeof firebase !== 'undefined',
                    auth: typeof firebase !== 'undefined' && firebase.auth,
                    currentUser: typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser
                });
                
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    const user = firebase.auth().currentUser;
                    console.log('Firebase Auth currentUser:', user);
                    
                    if (user) {
                        console.log('Firebase Auth 사용자 발견:', user.email);
                        
                        // Firestore에서 사용자 정보 가져오기
                        if (firebase.firestore) {
                    const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
                    
                    if (userDoc.exists) {
                        userData = {
                            name: userDoc.data().name || user.displayName || user.email.split('@')[0],
                            email: user.email,
                            uid: user.uid,
                            points: userDoc.data().points || 0
                        };
                        userPoints = userData.points;
                        console.log('Firebase에서 사용자 정보 로드 성공:', userData);
                            } else {
                                console.log('사용자 문서가 존재하지 않음, 기본 사용자 데이터 생성');
                                // 사용자 문서가 없으면 기본 사용자 데이터 생성
                                userData = {
                                    name: user.displayName || user.email.split('@')[0],
                                    email: user.email,
                                    uid: user.uid,
                                    points: 0
                                };
                                userPoints = 0;
                                console.log('기본 사용자 데이터 생성됨:', userData);
                                
                                // Firestore에 사용자 문서 생성 (선택사항)
                                try {
                                    await firebase.firestore().collection('users').doc(user.uid).set({
                                        name: user.displayName || user.email.split('@')[0],
                                        email: user.email,
                                        points: 0,
                                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                    console.log('Firestore에 사용자 문서 생성 완료');
                                } catch (docError) {
                                    console.warn('Firestore 사용자 문서 생성 실패:', docError);
                                }
                            }
                        } else {
                            console.log('Firestore가 사용 불가능, 기본 사용자 데이터 생성');
                            // Firestore가 사용 불가능해도 Firebase Auth 사용자 정보로 기본 데이터 생성
                            userData = {
                                name: user.displayName || user.email.split('@')[0],
                                email: user.email,
                                uid: user.uid,
                                points: 0
                            };
                            userPoints = 0;
                            console.log('Firestore 불가능 시 기본 사용자 데이터 생성됨:', userData);
                        }
                    } else {
                        console.log('Firebase Auth에서 사용자를 찾을 수 없음');
                        // Firebase Auth 사용자가 없으면 userData를 null로 설정하여 로그인 페이지로 리다이렉트
                        userData = null;
                    }
                } else {
                    console.log('Firebase 또는 Auth가 사용 불가능');
                    // Firebase가 사용 불가능하면 userData를 null로 설정하여 로그인 페이지로 리다이렉트
                    userData = null;
                }
            } catch (firebaseError) {
                console.warn('Firebase 사용자 정보 로드 실패:', firebaseError);
                // 오류 발생 시 userData를 null로 설정하여 로그인 페이지로 리다이렉트
                userData = null;
            }
            
            // Firebase Auth 사용자가 없으면 로그인 페이지로 리다이렉트
            if (!userData) {
                console.log('Firebase Auth 사용자가 없음, 로그인 페이지로 이동');
                window.location.href = 'login.html?redirect=points.html';
                return;
            }
            
            // 3. 사용자 정보 설정
            pointsPageUser = userData;
            currentPoints = userPoints;
            console.log('최종 사용자 정보 설정:', pointsPageUser);
            console.log('현재 포인트:', currentPoints);
                
            // 포인트 정보 및 이력 로드
            await loadPointInfo();
            await loadPointHistory();
            
            // Firebase 전용 QR 코드 시스템 - Firebase 초기화 완료 후 자동 생성
            console.log('QR 코드는 Firebase 초기화 완료 후 자동 생성됩니다');
            
            // QR 코드 생성 강제 실행 (더 긴 지연 시간)
            setTimeout(() => {
                if (typeof window.unifiedQRCodeManager !== 'undefined' && window.unifiedQRCodeManager) {
                    console.log('QR 코드 매니저가 존재함, 강제 QR 코드 생성 시도');
                    window.unifiedQRCodeManager.autoGenerateQRCode();
                } else {
                    console.log('QR 코드 매니저가 아직 초기화되지 않음');
                }
            }, 3000);

            // 페이지 새로고침 기능 설정
            setupPageRefresh();

            console.log('포인트 페이지 초기화 완료');
        }

        // 네비게이션 바 사용자 상태 업데이트 - 제거됨, updateUserMenuDirectly 사용

        // 로그아웃 함수 (카트 정보 유지) - 모바일/웹 호환
        async function logout() {
            try {
                console.log('=== points.html 로그아웃 시작 (카트 정보 유지) - 모바일/웹 호환 ===');
                
                // Firebase Auth 상태 변경 리스너 일시 중단 (모바일에서 중요)
                if (window.pointsAuthStateUnsubscribe) {
                    window.pointsAuthStateUnsubscribe();
                    window.pointsAuthStateUnsubscribe = null;
                    console.log('✅ Firebase Auth 상태 변경 리스너 중단');
                }
                
                // Firebase 로그아웃
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    await firebase.auth().signOut();
                    console.log('✅ Firebase 로그아웃 완료');
                }
                
                // pointsPageUser 초기화 (카트 정보는 유지)
                pointsPageUser = null;
                console.log('✅ pointsPageUser 초기화 완료');
                
                // 로그인 관련 localStorage 완전 정리 (모바일 호환)
                const loginKeys = [
                    'aetherLoginStatus', 'aetherLogin', 'aetherUser', 'aetherUserInfo',
                    'aetherAuthToken', 'aetherSession', 'aetherRemember'
                ];
                
                loginKeys.forEach(key => {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key);
                });
                
                // 모든 aether 관련 키 중 로그인 관련만 제거 (카트는 유지)
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('aether') && 
                        (key.includes('Login') || key.includes('Auth') || key.includes('User') || key.includes('Session'))) {
                        localStorage.removeItem(key);
                    }
                });
                
                Object.keys(sessionStorage).forEach(key => {
                    if (key.startsWith('aether') && 
                        (key.includes('Login') || key.includes('Auth') || key.includes('User') || key.includes('Session'))) {
                        sessionStorage.removeItem(key);
                    }
                });
                
                console.log('✅ 로그인 관련 localStorage/sessionStorage 완전 정리 완료');
                
                // 모바일 브라우저 캐시 정리 (가능한 경우)
                if ('caches' in window) {
                    try {
                        const cacheNames = await caches.keys();
                        for (const cacheName of cacheNames) {
                            if (cacheName.includes('aether') || cacheName.includes('auth')) {
                                await caches.delete(cacheName);
                                console.log(`✅ 캐시 삭제: ${cacheName}`);
                            }
                        }
                    } catch (cacheError) {
                        console.log('⚠️ 캐시 정리 중 오류 (무시 가능):', cacheError);
                    }
                }
                
                // 사용자 메뉴 직접 업데이트 (auth-utils.js 호출 방지)
                updateUserMenuDirectly();
                console.log('✅ 사용자 메뉴 직접 업데이트 완료');
                
                // 카트 개수 업데이트 (로그아웃 상태이므로 0으로 표시)
                updateCartCount();
                console.log('✅ 카트 개수 업데이트 완료');
                
                // 토스트 메시지 표시
                if (typeof window.showToast === 'function') {
                    window.showToast('ログアウトしました。', 'success', 2000);
                } else {
                    alert('ログアウトしました。');
                }
                
                console.log('✅ points.html 로그아웃 성공 (카트 정보 유지) - 모바일/웹 호환');
                
                // 강제 페이지 새로고침과 함께 홈페이지로 리다이렉트 (모바일에서 확실한 로그아웃)
                setTimeout(() => {
                    // 모바일에서 확실한 로그아웃을 위해 강제 새로고침
                    window.location.replace('index.html');
                }, 1000);
                
            } catch (error) {
                console.error('❌ points.html 로그아웃 중 오류:', error);
                
                // 오류가 발생해도 기본 정리 작업 수행
                pointsPageUser = null;
                
                // Firebase Auth 상태 변경 리스너 중단
                if (window.pointsAuthStateUnsubscribe) {
                    window.pointsAuthStateUnsubscribe();
                    window.pointsAuthStateUnsubscribe = null;
                }
                
                // 로그인 관련 localStorage 정리
                const loginKeys = [
                    'aetherLoginStatus', 'aetherLogin', 'aetherUser', 'aetherUserInfo',
                    'aetherAuthToken', 'aetherSession', 'aetherRemember'
                ];
                
                loginKeys.forEach(key => {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key);
                });
                
                // 사용자 메뉴 직접 업데이트
                updateUserMenuDirectly();
                
                updateCartCount();
                
                if (typeof window.showToast === 'function') {
                    window.showToast('ログアウトしました。', 'success', 2000);
                } else {
                    alert('ログアウトしました。');
                }
                
                // 강제 페이지 새로고침과 함께 홈페이지로 리다이렉트
                setTimeout(() => {
                    window.location.replace('index.html');
                }, 1000);
            }
        }
        
        // 사용자 메뉴 직접 업데이트 함수 (auth-utils.js 호출 방지) - 모바일/웹 호환
        function updateUserMenuDirectly() {
            try {
                console.log('🔧 points.html 사용자 메뉴 직접 업데이트 시작 - 모바일/웹 호환');
                
                // 현재 로그인 상태 확인
                const currentUser = getCurrentUser();
                const isLoggedIn = currentUser !== null;
                
                console.log('🔍 현재 로그인 상태:', isLoggedIn ? '로그인됨' : '로그아웃됨');
                
                // 메뉴 요소들 정의
                const logoutMenus = ['logout-menu', 'logout-menu-item', 'logout-menu-mobile', 'logout-menu-item-mobile'];
                const profileMenus = ['profile-menu', 'profile-menu-mobile', 'points-menu', 'points-menu-mobile'];
                const loginMenus = ['login-menu', 'login-menu-mobile', 'register-menu', 'register-menu-mobile'];
                
                if (isLoggedIn) {
                    // 로그인 상태: 로그인 메뉴 숨기기, 로그아웃/프로필 메뉴 표시
                    console.log('🔧 로그인 상태 - 메뉴 업데이트');
                    
                    // 로그인 메뉴 숨기기
                    loginMenus.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'none';
                            console.log(`✅ ${id} 숨기기 완료`);
                        }
                    });
                    
                    // 로그아웃 메뉴 표시
                    logoutMenus.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'block';
                            console.log(`✅ ${id} 표시 완료`);
                        }
                    });
                    
                    // 프로필 메뉴 표시
                    profileMenus.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'block';
                            console.log(`✅ ${id} 표시 완료`);
                        }
                    });
                    
                    // 사용자 이름 표시
                    const userNameElement = document.getElementById('user-name');
                    if (userNameElement && currentUser.email) {
                        userNameElement.textContent = currentUser.displayName || currentUser.email.split('@')[0];
                        userNameElement.classList.remove('d-none');
                        console.log('✅ 사용자 이름 표시 완료:', userNameElement.textContent);
                    }
                    
                } else {
                    // 로그아웃 상태: 로그아웃/프로필 메뉴 숨기기, 로그인 메뉴 표시
                    console.log('🔧 로그아웃 상태 - 메뉴 업데이트');
                    
                    // 로그아웃 메뉴 숨기기
                    logoutMenus.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'none';
                            console.log(`✅ ${id} 숨기기 완료`);
                        }
                    });
                    
                    // 프로필 메뉴 숨기기
                    profileMenus.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'none';
                            console.log(`✅ ${id} 숨기기 완료`);
                        }
                    });
                    
                    // 로그인 메뉴 표시
                    loginMenus.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'block';
                            console.log(`✅ ${id} 표시 완료`);
                        }
                    });
                    
                    // 사용자 이름 요소 초기화
                    const userNameElement = document.getElementById('user-name');
                    if (userNameElement) {
                        userNameElement.textContent = '';
                        userNameElement.classList.add('d-none');
                        console.log('✅ 사용자 이름 요소 초기화 완료');
                    }
                }
                
                console.log('✅ points.html 사용자 메뉴 직접 업데이트 완료 - 모바일/웹 호환');
                
            } catch (error) {
                console.error('❌ points.html 사용자 메뉴 직접 업데이트 실패:', error);
            }
        }

        // 페이지 포커스 시 포인트 정보 새로고침
        function setupPageRefresh() {
            // 페이지가 포커스를 받을 때마다 포인트 정보 새로고침
            window.addEventListener('focus', async () => {
                console.log('페이지 포커스 감지 - 포인트 정보 새로고침');
                if (pointsPageUser) {
                    await loadPointInfo();
                    await loadPointHistory();
                }
            });
            
            // 페이지 가시성 변경 시에도 새로고침
            document.addEventListener('visibilitychange', async () => {
                if (!document.hidden && pointsPageUser) {
                    console.log('페이지 가시성 변경 감지 - 포인트 정보 새로고침');
                    await loadPointInfo();
                    await loadPointHistory();
                }
            });
        }

        // Firebase 초기화 완료 후 포인트 이력 및 QR 코드 다시 로드
        async function reloadPointHistoryAfterFirebase() {
            console.log('Firebase 초기화 완료 후 포인트 이력 및 QR 코드 다시 로드');
            if (pointsPageUser) {
                try {
                    // 포인트 이력 다시 로드
                    setTimeout(() => {
                        loadPointHistory();
                    }, 500);
                    
                    // QR 코드는 common-qr-code.js에서 자동으로 처리
                } catch (error) {
                    console.error('Firebase 초기화 후 데이터 로드 실패:', error);
                }
            }
        }
        
                // QR 코드 생성은 common-qr-code.js에서 자동으로 처리

        // 카트 개수 업데이트 (Firebase 전용)
        async function updateCartCount() {
            console.log('🔢 points.html updateCartCount 호출');
            
            try {
                // 현재 로그인된 사용자 확인
                const currentUser = getCurrentUser();
                if (!currentUser) {
                    console.log('📝 로그인되지 않은 사용자 - 카트 수량 0');
                    updateCartCountDisplay(0);
                    return;
                }
                
                // Firebase에서 카트 수량 가져오기
                if (typeof firebase !== 'undefined' && firebase.firestore && firebase.apps && firebase.apps.length > 0) {
                    const db = firebase.firestore();
                    const cartDoc = await db.collection('userCarts').doc(currentUser.email).get();
                    
                    if (cartDoc.exists) {
                        const cartData = cartDoc.data().cart || [];
                        const totalItems = cartData.reduce((total, item) => total + (item.quantity || 1), 0);
                        console.log('✅ points.html Firebase 카트 수량:', totalItems, '개');
                        updateCartCountDisplay(totalItems);
                    } else {
                        console.log('📝 points.html Firebase 카트 없음 - 수량 0');
                        updateCartCountDisplay(0);
                    }
                } else {
                    console.log('📝 points.html Firebase 사용 불가 - 수량 0');
                    updateCartCountDisplay(0);
                }
            } catch (error) {
                console.warn('⚠️ points.html 카트 수량 업데이트 실패:', error);
                updateCartCountDisplay(0);
            }
        }

        // 카트 수량 표시 업데이트
        function updateCartCountDisplay(count) {
            // 데스크톱용 장바구니 카운트 업데이트
            const cartCountElement = document.getElementById('cart-count');
            if (cartCountElement) {
                cartCountElement.textContent = count;
            }
            
            // 모바일용 장바구니 카운트 업데이트
            const cartCountMobileElement = document.getElementById('cart-count-mobile');
            if (cartCountMobileElement) {
                cartCountMobileElement.textContent = count;
            }
            
            console.log('✅ points.html 카트 수량 표시 업데이트:', count, '개');
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== points.html DOMContentLoaded 시작 ===');
            
            // Firebase 전용 초기화
            console.log('🔄 Firebase 전용 포인트 페이지 초기화 시작');
            
            // 간단하고 직접적인 초기화 방식
            const initializePointsPageSimple = async () => {
                console.log('포인트 페이지 간단 초기화 시작');
                
                // 1. 기본 포인트 페이지 표시
                const pointsElement = document.getElementById('current-points');
                if (pointsElement) {
                    pointsElement.textContent = '-';
                }
                
                const historyContainer = document.getElementById('point-history-container');
                if (historyContainer) {
                    historyContainer.innerHTML = '<p class="text-muted japanese-text">ポイント履歴を読み込み中...</p>';
                }
                
                // QR 코드 컨테이너는 스피너만 표시
                
                // 2. Firebase 초기화 대기
                let attempts = 0;
                while (attempts < 100) { // 10초 대기
                    if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
                        console.log('✅ Firebase 준비 완료');
                        break;
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (attempts >= 100) {
                    console.warn('Firebase 초기화 시간 초과');
                    return;
                }
                
                // 3. Firebase Auth 완전 로드 대기 후 사용자 정보 확인
                try {
                    // Firebase Auth가 완전히 로드될 때까지 대기
                    let user = null;
                    await new Promise((resolve) => {
                        window.pointsAuthStateUnsubscribe = firebase.auth().onAuthStateChanged((authUser) => {
                            // 첫 번째 호출에서만 resolve하고 구독 해제하지 않음 (지속적인 상태 감지를 위해)
                            if (user === null) {
                            user = authUser;
                            resolve(authUser);
                            }
                            
                            // 지속적인 상태 변경 감지
                            console.log('points.html - Firebase 인증 상태 변경:', authUser ? authUser.email : '로그아웃');
                            
                            if (authUser) {
                                console.log('✅ points.html - Firebase 인증 상태 변경: 로그인됨', authUser.email);
                                
                                // 사용자 정보 설정
                                pointsPageUser = {
                                    uid: authUser.uid,
                                    email: authUser.email,
                                    name: authUser.displayName || authUser.email.split('@')[0],
                                    points: 0
                                };
                                
                                // 사용자 메뉴 직접 업데이트 (auth-utils.js 호출 방지)
                                updateUserMenuDirectly();
                                console.log('✅ points.html - 사용자 메뉴 직접 업데이트 완료');
                                
                                // 카트 수량 업데이트
                                setTimeout(() => {
                                    updateCartCount();
                                }, 500);
                            } else {
                                console.log('❌ points.html - Firebase 인증 상태 변경: 로그아웃됨');
                                
                                // pointsPageUser 초기화
                                pointsPageUser = null;
                                
                                // 사용자 메뉴 직접 업데이트 (auth-utils.js 호출 방지)
                                updateUserMenuDirectly();
                                console.log('✅ points.html - 로그아웃 후 사용자 메뉴 직접 업데이트 완료');
                                
                                // 카트 수량 업데이트
                                setTimeout(() => {
                                    updateCartCount();
                                }, 500);
                            }
                        });
                    });
                    
                    // 사용자 정보 확인
                    console.log('Firebase Auth 사용자:', user);
                    
                    // currentUser도 확인 (백업)
                    if (!user) {
                        user = firebase.auth().currentUser;
                        console.log('currentUser 백업 확인:', user);
                    }
                    
                    if (user) {
                        console.log('✅ 로그인된 사용자 확인:', user.email);
                        
                        // 사용자 정보는 이미 onAuthStateChanged에서 설정됨
                        // 카트 수량 업데이트
                        setTimeout(() => {
                            updateCartCount();
                        }, 1000);
                        
                        // 데이터 로드 (비동기 처리)
                        loadPointInfo().then(() => {
                            console.log('포인트 정보 로드 완료');
                            return loadPointHistory();
                        }).then(() => {
                            console.log('포인트 이력 로드 완료');
                            // QR코드는 common-qr-code.js에서 자동으로 처리
                            console.log('페이지 로드 완료');
                            
                            // 페이지 포커스 시 데이터 새로고침 설정
                            setupPageRefresh();
                        }).catch(error => {
                            console.error('데이터 로드 오류:', error);
                            // 오류가 있어도 QR코드는 표시
                            console.log('데이터 로드 오류 무시하고 QR코드 표시');
                            // common-qr-code.js가 자동으로 처리
                        });
                        
                        console.log('포인트 페이지 초기화 완료');
                    } else {
                        console.log('❌ 로그인된 사용자가 없음');
                        // Firebase 전용
                    }
                } catch (error) {
                    console.error('포인트 페이지 초기화 오류:', error);
                }
            };
            
            // 초기화 실행
            initializePointsPageSimple();
        });
        
        // QR 코드 버튼 이벤트 리스너는 common-qr-code.js에서 자동으로 처리
        
        // 모달 관련 함수들은 common-qr-code.js에서 처리

        // QR 코드 관련 함수들은 common-qr-code.js에서 처리
        
        // 테스트 함수들 - common-qr-code.js에서 자동 처리
        
        // 전역 함수는 common-qr-code.js에서 처리
    </script>
    
    <!-- End Script -->
</body>

</html>
 
 