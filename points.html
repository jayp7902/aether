<!DOCTYPE html>
<html lang="en">

<head>
    <title>Aether - Points</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="msapplication-config" content="none">
    <meta name="theme-color" content="#ffffff">

    <link rel="icon" type="image/png" sizes="192x192" href="assets/img/aether-icon.png?t=1750992166">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/img/aether-icon.png?t=1750992166">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/img/aether-icon.png?t=1750992166">
    <link rel="apple-touch-icon" sizes="192x192" href="assets/img/aether-icon.png?t=1750992166">
    <link rel="apple-touch-icon-precomposed" href="assets/img/aether-icon.png?t=1750992166">
    
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/templatemo.css">
    <link rel="stylesheet" href="assets/css/custom.css">

    <!-- Load fonts style after rendering the layout styles -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800;900&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100;200;300;400;500;600;700;800;900&display=swap">
    <style>
        body {
            font-family: "Montserrat", sans-serif;
        }
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
            font-family: "Montserrat", sans-serif;
            font-weight: 600;
        }
        .japanese-text {
            font-family: "Noto Sans JP", sans-serif;
            font-weight: 400;
            line-height: 1.6;
        }
        .japanese-heading {
            font-family: "Noto Sans JP", sans-serif;
            font-weight: 600;
            line-height: 1.4;
        }
    </style>
    <link rel="stylesheet" href="assets/css/fontawesome.min.css">
    <style>
        /* User dropdown hover fix */
        .dropdown-toggle:hover,
        .dropdown-toggle:focus,
        #user-name:hover {
            color: #343a40 !important;
            text-decoration: none !important;
        }
        .nav-link:hover {
            color: #343a40 !important;
        }
        
        /* ë„¤ë¹„ê²Œì´ì…˜ë°” í…ìŠ¤íŠ¸ thin ì„œì²´ í†µì¼ */
        .navbar-nav .nav-link {
            font-family: "Montserrat", sans-serif !important;
            font-weight: 300 !important;
            font-size: 1rem !important;
        }
        
        .navbar-brand {
            font-family: "Montserrat", sans-serif !important;
            font-weight: 300 !important;
        }
        
        #user-name {
            font-family: "Montserrat", sans-serif !important;
            font-weight: 300 !important;
        }
        
        /* í¬ì¸íŠ¸ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
        .point-card {
            background: #fff;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .point-number {
            font-size: 4rem;
            font-weight: 700;
            color: #343a40;
            text-align: center;
            line-height: 1.2;
        }
        
        .point-number strong {
            font-size: 4rem;
            font-weight: 700;
        }
        
        .point-number span {
            font-size: 2rem;
            font-weight: normal;
            color: #6c757d;
        }
        
        .qr-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .qr-code-container {
            text-align: center;
            margin: 20px auto;
            width: 200px;
            height: 200px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .qr-code-container canvas {
            margin: 0 auto;
            border-radius: 4px;
        }
        
        .history-section {
            background: #fff;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>

<body>
    <!-- Start Top Nav -->
    <nav class="navbar navbar-expand-lg bg-black navbar-light d-none d-lg-block" id="templatemo_nav_top" style="min-height: 20px;">
        <div class="container text-light">
            <div class="w-100 d-flex justify-content-between">
                <div>
                    <!-- ë¹ˆ ê³µê°„ìœ¼ë¡œ ë¸”ë™ ë°” ìœ ì§€ -->
                </div>
            </div>
        </div>
    </nav>
    <!-- Close Top Nav -->

    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-light shadow">
        <div class="container d-flex justify-content-between align-items-center">
            <!-- QR ì½”ë“œ ì•„ì´ì½˜ ì œê±°ë¨ - ì¤‘ê°„ ì„¹ì…˜ì—ì„œë§Œ ì‚¬ìš© -->

            <a class="navbar-brand text-success logo align-self-center" href="index.html">
                <img src="assets/img/logo.png" alt="Logo" class="img-fluid" style="max-height: 50px;">
            </a>

            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#templatemo_main_nav" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="align-self-center collapse navbar-collapse flex-fill  d-lg-flex justify-content-lg-between" id="templatemo_main_nav">
                <!-- ëª¨ë°”ì¼ ë©”ë‰´ ë ˆì´ì•„ì›ƒ -->
                <div class="d-lg-none w-100">
                    <!-- ì˜ë¬¸ ë©”ë‰´ - ê°€ë¡œ ì •ë ¬ -->
                    <div class="d-flex justify-content-center mb-4">
                        <ul class="nav navbar-nav d-flex flex-row gap-4">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="shop.html">Brand</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="info.html">Info</a>
                        </li>
                    </ul>
                </div>
                    
                    <!-- ì•„ì´ì½˜ë“¤ - ê°€ë¡œ ì •ë ¬, ì¢Œìš° ì—¬ë°± ì¶”ê°€ -->
                    <div class="d-flex justify-content-center align-items-center gap-4 px-4">
                        <a href="cart.html" class="nav-link text-decoration-none">
                            <i class="fas fa-shopping-cart text-dark" style="font-size: 1.5rem;"></i>
                            <span class="badge bg-secondary ms-1" id="cart-count-mobile">0</span>
                        </a>
                        <div class="dropdown">
                            <a href="#" class="nav-link dropdown-toggle text-decoration-none" id="userDropdownMobile" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user text-dark" style="font-size: 1.5rem;"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-center" aria-labelledby="userDropdownMobile">
                                <li id="login-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="login.html">
                                        <i class="fas fa-sign-in-alt me-2"></i>Login
                                    </a>
                                </li>
                                <li id="register-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="register.html">
                                        <i class="fas fa-user-plus me-2"></i>Register
                                    </a>
                                </li>
                                <li id="profile-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="profile.html">
                                        <i class="fas fa-user-circle me-2"></i>Profile
                                    </a>
                                </li>
                                <li id="points-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="points.html">
                                        <i class="fas fa-coins me-2"></i>Points
                                    </a>
                                </li>
                                <li id="admin-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="admin-dashboard.html">
                                        <i class="fas fa-cog me-2"></i>ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                                    </a>
                                </li>
                                <li id="logout-menu-mobile" style="display: none;">
                                    <hr class="dropdown-divider">
                                </li>
                                <li id="logout-menu-item-mobile" style="display: none;">
                                    <a class="dropdown-item" href="#" onclick="logout()">
                                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                                    </a>
                                </li>
                            </ul>
                            </div>
                        </div>
                    </div>
                
                <!-- ë°ìŠ¤í¬í†± ë©”ë‰´ ë ˆì´ì•„ì›ƒ -->
                <div class="flex-fill d-none d-lg-block">
                    <ul class="nav navbar-nav d-flex justify-content-between mx-lg-auto" style="max-width: 400px; margin: 0 auto;">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="shop.html">Brand</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="info.html">Info</a>
                        </li>
                    </ul>
                </div>
                <div class="navbar align-self-center d-flex d-none d-lg-flex">
                    <!-- QR ì½”ë“œ ì•„ì´ì½˜ ì œê±°ë¨ - ì¤‘ê°„ ì„¹ì…˜ì—ì„œë§Œ ì‚¬ìš© -->
                    <a href="cart.html" class="nav-link text-decoration-none me-3">
                        <i class="fas fa-shopping-cart text-dark"></i>
                        <span class="badge bg-secondary" id="cart-count">0</span>
                    </a>
                    <div class="dropdown">
                        <a href="#" class="nav-link dropdown-toggle text-decoration-none" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user text-dark"></i>
                            <span id="user-name" class="d-none d-lg-inline ms-1"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li id="login-menu" style="display: none;">
                                <a class="dropdown-item" href="login.html">
                                    <i class="fas fa-sign-in-alt me-2"></i>Login
                                </a>
                            </li>
                            <li id="register-menu" style="display: none;">
                                <a class="dropdown-item" href="register.html">
                                    <i class="fas fa-user-plus me-2"></i>Register
                                </a>
                            </li>
                            <li id="profile-menu" style="display: none;">
                                <a class="dropdown-item" href="profile.html">
                                    <i class="fas fa-user-circle me-2"></i>Profile
                                </a>
                            </li>
                            <li id="points-menu" style="display: none;">
                                <a class="dropdown-item" href="points.html">
                                    <i class="fas fa-coins me-2"></i>Points
                                </a>
                            </li>
                            <li id="admin-menu" style="display: none;">
                                <a class="dropdown-item" href="admin-dashboard.html">
                                    <i class="fas fa-cog me-2"></i>ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                                </a>
                            </li>
                            <li id="logout-menu" style="display: none;">
                                <hr class="dropdown-divider">
                            </li>
                            <li id="logout-menu-item" style="display: none;">
                                <a class="dropdown-item" href="#" onclick="logout()">
                                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

        </div>
    </nav>
    <!-- Close Header -->

    <!-- Modal -->
    <div class="modal fade bg-white" id="templatemo_search" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="w-100 pt-1 mb-5 text-right">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            <form action="" method="get" class="modal-content modal-body border-0 p-0">
                <div class="input-group mb-2">
                    <input type="text" class="form-control" id="inputModalSearch" name="q" placeholder="Search ...">
                    <button type="submit" class="input-group-text bg-success text-light">
                        <i class="fa fa-fw fa-search text-white"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Start Banner Hero -->
    <div class="py-5" style="background-color: #000000;">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <h1 class="h2 text-center mb-0" style="color: #ffffff; padding-top: 0.5rem;">
                <i class="fas fa-coins me-2" style="color: #ffffff;"></i>MY POINT PAGE
            </h1>
                </div>
            </div>
        </div>
    </div>
    <!-- End Banner Hero -->

    <!-- Start Points Section -->
    <div class="container py-5">
        <div class="row">
            <!-- í¬ì¸íŠ¸ ì¹´ë“œ -->
            <div class="col-lg-4 mb-4">
                <div class="point-card">
                    <h3 class="text-center mb-4">
                        <i class="fas fa-coins me-2"></i>MY POINTS
                    </h3>
                    <div class="point-number">
                        <strong id="current-points">-</strong>
                        <span>pt</span>
                    </div>
                </div>
            </div>

            <!-- QR ì½”ë“œ ì„¹ì…˜ -->
            <div class="col-lg-8 mb-4">
                <div class="qr-section">
                    <h3 class="mb-4">
                        <i class="fas fa-qrcode me-2"></i>MY QRCODE
                    </h3>
                    <div class="qr-code-container" id="qr-code-container">
                        <div class="spinner-border text-secondary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>

        <!-- í¬ì¸íŠ¸ ì´ë ¥ ì„¹ì…˜ -->
        <div class="row">
            <div class="col-12">
                <div class="history-section">
                <h3 class="japanese-heading mb-4">
                    <i class="fas fa-history me-2"></i>ãƒã‚¤ãƒ³ãƒˆå±¥æ­´
                </h3>
                    <div id="point-history-container">
                        <div class="text-center text-muted">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <p class="japanese-text">ãƒã‚¤ãƒ³ãƒˆå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
                </div>
            </div>
            </div>
            </div>
        </div>
    </div>
    <!-- End Points Section -->

    <!-- QR Code Modal ì œê±°ë¨ - í˜ì´ì§€ì— ì§ì ‘ í‘œì‹œ -->

    <!-- í¬ì¸íŠ¸ ì´ë ¥ í…Œì´ë¸” ìŠ¤íƒ€ì¼ -->
    <style>
        /* í¬ì¸íŠ¸ ì´ë ¥ í…Œì´ë¸” ìŠ¤íƒ€ì¼ ê°œì„  */
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .table thead th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            padding: 12px 8px;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .table tbody td {
            padding: 12px 8px;
            vertical-align: middle;
        }
        
        /* ì£¼ë¬¸ ì •ë³´ ìŠ¤íƒ€ì¼ */
        .table tbody td small {
            font-size: 0.85rem;
            line-height: 1.4;
            display: block;
            margin-top: 4px;
        }
        
        .table tbody td .text-muted {
            color: #6c757d !important;
        }
        
        .table tbody td .text-info {
            color: #6c757d !important;
            font-weight: 500;
        }
        
        /* í¬ì¸íŠ¸ í‘œì‹œ ìŠ¤íƒ€ì¼ - ëª¨ë…¸í†¤ ìƒ‰ìƒ */
        .table tbody td .text-success {
            color: #212529 !important;
            font-weight: 600;
        }
        
        .table tbody td .text-danger {
            color: #495057 !important;
            font-weight: 600;
        }
        
        /* ë°˜ì‘í˜• í…Œì´ë¸” */
        @media (max-width: 768px) {
            .table thead th,
            .table tbody td {
                padding: 8px 4px;
                font-size: 0.9rem;
            }
            
            .table tbody td small {
                font-size: 0.8rem;
            }
        }
    </style>

    <!-- Start Script -->
    <script src="assets/js/jquery-1.11.0.min.js"></script>
    <script src="assets/js/jquery-migrate-1.2.1.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/templatemo.js"></script>
    
    <!-- QR Code Generator Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <!-- ì• í”Œë¦¬ì¼€ì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/auth-utils.js"></script>
    <script src="assets/js/common-qr-code.js?v=2.1"></script>
    <script src="assets/js/custom.js"></script>
    
    <!-- í¬ì¸íŠ¸ í˜ì´ì§€ ì „ìš© ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        // í¬ì¸íŠ¸ í˜ì´ì§€ ì „ìš© ë³€ìˆ˜ë“¤
        let pointsPageUser = null;
        let currentPoints = null; // í•˜ë“œì½”ë”© ì œê±°, Firebaseì—ì„œ ë¡œë“œ
        let pointHistory = [];
        let qrToken = null;
        let qrCodeGenerated = false;
        
        // Firebase ì „ìš© QR í† í° ê´€ë¦¬ - localStorage ì‚¬ìš© ì•ˆí•¨

        // QR ì½”ë“œ ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ ëª¨ë‘ common-qr-code.jsì—ì„œ ì²˜ë¦¬


        // í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updatePointsDisplay() {
            const pointsElement = document.getElementById('current-points');
            if (pointsElement) {
                pointsElement.textContent = currentPoints.toLocaleString();
                console.log('í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', currentPoints);
            } else {
                console.error('í¬ì¸íŠ¸ í‘œì‹œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }
        }

        // í¬ì¸íŠ¸ ì •ë³´ ë¡œë“œ
        async function loadPointInfo() {
            try {
                console.log('=== í¬ì¸íŠ¸ ì •ë³´ ë¡œë“œ ì‹œì‘ ===');
            
            if (!pointsPageUser) {
                    console.log('âŒ ì‚¬ìš©ì ì •ë³´ê°€ ì—†ì–´ í¬ì¸íŠ¸ ì •ë³´ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }

                console.log('í¬ì¸íŠ¸ ì •ë³´ ë¡œë“œ - ì‚¬ìš©ì:', pointsPageUser);
                console.log('Firebase ìƒíƒœ í™•ì¸:', {
                    firebase: typeof firebase !== 'undefined',
                    firestore: typeof firebase !== 'undefined' && firebase.firestore,
                    apps: typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length
                });

                // Firebaseì—ì„œ í¬ì¸íŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    const db = firebase.firestore();
                    
                    // ë¨¼ì € ì‚¬ìš©ì IDë¡œ ê²€ìƒ‰ (ìºì‹œ ë¬´ì‹œí•˜ê³  ì„œë²„ì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ê¸°)
                    let userDoc = await db.collection('users').doc(pointsPageUser.uid).get({ source: 'server' });
                    console.log('ì‚¬ìš©ì IDë¡œ ê²€ìƒ‰ ê²°ê³¼ (ì„œë²„ì—ì„œ):', userDoc.exists);
                    
                    if (!userDoc.exists) {
                        // ì‚¬ìš©ì IDë¡œ ì°¾ì§€ ëª»í•œ ê²½ìš° ì´ë©”ì¼ë¡œ ê²€ìƒ‰
                        console.log('ì‚¬ìš©ì IDë¡œ ì°¾ì§€ ëª»í•¨, ì´ë©”ì¼ë¡œ ê²€ìƒ‰ ì‹œë„');
                        const emailQuery = await db.collection('users')
                            .where('email', '==', pointsPageUser.email)
                            .limit(1)
                            .get({ source: 'server' });
                        
                        if (!emailQuery.empty) {
                            userDoc = emailQuery.docs[0];
                            console.log('ì´ë©”ì¼ë¡œ ì‚¬ìš©ì ì°¾ìŒ:', userDoc.id);
                        }
                    }
                    
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        const newPoints = userData.points || 0;
                        
                        // í¬ì¸íŠ¸ê°€ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
                        if (currentPoints !== newPoints) {
                            console.log(`í¬ì¸íŠ¸ ë³€ê²½ ê°ì§€: ${currentPoints} â†’ ${newPoints}`);
                            currentPoints = newPoints;
                            pointsPageUser.points = currentPoints; // ì‚¬ìš©ì ì •ë³´ë„ ì—…ë°ì´íŠ¸
                            
                            // UI ì—…ë°ì´íŠ¸
                            updatePointsDisplay();
                } else {
                            console.log('í¬ì¸íŠ¸ ë³€ê²½ ì—†ìŒ:', currentPoints);
                        }
                        
                        console.log('Firebaseì—ì„œ í¬ì¸íŠ¸ ì •ë³´ ë¡œë“œ (ìµœì‹ ):', currentPoints);
                        console.log('ì‚¬ìš©ì ë°ì´í„°:', userData);
                        console.log('ğŸ” í¬ì¸íŠ¸ í˜ì´ì§€ í¬ì¸íŠ¸ ìƒì„¸ ë¶„ì„:');
                        console.log('  - userData.points:', userData.points);
                        console.log('  - typeof userData.points:', typeof userData.points);
                        console.log('  - userData.points === undefined:', userData.points === undefined);
                        console.log('  - userData.points === null:', userData.points === null);
                        console.log('  - userData.points === 0:', userData.points === 0);
                        console.log('  - userData ì „ì²´ í‚¤:', Object.keys(userData));
                        } else {
                        console.log('ì‚¬ìš©ì ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤, ìƒˆë¡œ ìƒì„±');
                        // ì‚¬ìš©ì ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                        await db.collection('users').doc(pointsPageUser.uid).set({
                            name: pointsPageUser.name,
                            email: pointsPageUser.email,
                            points: 0,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        // currentPointsëŠ” Firebaseì—ì„œ ë¡œë“œëœ ê°’ ì‚¬ìš©
                        }
                } else {
                    console.log('Firebaseê°€ ì‚¬ìš© ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤');
                    // currentPointsëŠ” Firebaseì—ì„œ ë¡œë“œëœ ê°’ ì‚¬ìš©
                }

                // í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸ (currentPointsê°€ nullì´ ì•„ë‹ ë•Œë§Œ)
                if (currentPoints !== null) {
                    const pointsElement = document.getElementById('current-points');
                    if (pointsElement) {
                        pointsElement.textContent = currentPoints.toLocaleString();
                        console.log('í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', currentPoints);
                    } else {
                        console.error('í¬ì¸íŠ¸ í‘œì‹œ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    }
                }
                        
                        // í¬ì¸íŠ¸ ì´ë ¥ ë¡œë“œê°€ ì™„ë£Œë˜ë©´ ìë™ìœ¼ë¡œ í¬ì¸íŠ¸ê°€ ê³„ì‚°ë˜ê³  ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤

            } catch (error) {
                console.error('í¬ì¸íŠ¸ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                // currentPointsëŠ” Firebaseì—ì„œ ë¡œë“œëœ ê°’ ì‚¬ìš©
                const pointsElement = document.getElementById('current-points');
                if (pointsElement) {
                    pointsElement.textContent = '-';
                }
            }
        }

        // í¬ì¸íŠ¸ ì´ë ¥ ë¡œë“œ
        async function loadPointHistory() {
            try {
                console.log('=== í¬ì¸íŠ¸ ì´ë ¥ ë¡œë“œ ì‹œì‘ ===');
                
                if (!pointsPageUser) {
                    console.log('âŒ ì‚¬ìš©ì ì •ë³´ê°€ ì—†ì–´ í¬ì¸íŠ¸ ì´ë ¥ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                console.log('í¬ì¸íŠ¸ ì´ë ¥ ê²€ìƒ‰ ëŒ€ìƒ:', {
                    uid: pointsPageUser.uid,
                    email: pointsPageUser.email
                });
                
                console.log('Firebase ìƒíƒœ í™•ì¸:', {
                    firebase: typeof firebase !== 'undefined',
                    firestore: typeof firebase !== 'undefined' && firebase.firestore,
                    apps: typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length
                });
                
                // Firebaseì—ì„œ í¬ì¸íŠ¸ ì´ë ¥ ê°€ì ¸ì˜¤ê¸°
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    const db = firebase.firestore();
                    
                    // ì‚¬ìš©ìë³„ í¬ì¸íŠ¸ ì´ë ¥ ê²€ìƒ‰
                    let historySnapshot = null;
                    let earnedPoints = 0;
                    let usedPoints = 0;
                    let filteredDocs = [];
                    
                    try {
                        // ì¸ë±ìŠ¤ ì—†ì´ë„ ì‘ë™í•˜ë„ë¡ ë‹¨ìˆœ ì¿¼ë¦¬ ì‚¬ìš© (ì„œë²„ì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ê¸°)
                        console.log('ë‹¨ìˆœ ì¿¼ë¦¬ë¡œ í¬ì¸íŠ¸ ì´ë ¥ ê²€ìƒ‰ ì‹œì‘ (ì„œë²„ì—ì„œ)');
                        // ìºì‹œ ë¬´íš¨í™”ë¥¼ ìœ„í•´ ê°•ì œë¡œ ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ê¸°
                        historySnapshot = await db.collection('pointHistory').get({ 
                            source: 'server',
                            cache: false 
                        });
                        console.log('ì „ì²´ í¬ì¸íŠ¸ ì´ë ¥ ë¬¸ì„œ ìˆ˜:', historySnapshot.size, 'ê±´');
                        
                        historySnapshot.forEach(doc => {
                            const data = doc.data();
                            console.log('ì´ë ¥ ë¬¸ì„œ í™•ì¸:', {
                                docId: doc.id,
                                userId: data.userId,
                                userEmail: data.userEmail,
                                type: data.type,
                                points: data.points,
                                reason: data.reason,
                                currentUserUid: pointsPageUser.uid,
                                currentUserEmail: pointsPageUser.email
                            });
                            
                            if (data.userId === pointsPageUser.uid || 
                                data.userEmail === pointsPageUser.email ||
                                data.userId === pointsPageUser.email) {
                                filteredDocs.push({ id: doc.id, ...data });
                                
                                // í¬ì¸íŠ¸ ê³„ì‚°
                                if (data.type === 'earn' || data.type === 'admin_add' || data.type === 'welcome_bonus') {
                                    earnedPoints += data.points || 0;
                                    console.log('ì ë¦½ í¬ì¸íŠ¸ ì¶”ê°€:', data.points, 'ì´ ì ë¦½:', earnedPoints);
                                } else if (data.type === 'use' || data.type === 'admin_subtract') {
                                    usedPoints += data.points || 0;
                                    console.log('ì‚¬ìš© í¬ì¸íŠ¸ ì¶”ê°€:', data.points, 'ì´ ì‚¬ìš©:', usedPoints);
                                }
                            }
                        });
                        
                        // ì‹œê°„ìˆœ ì •ë ¬ (ìµœì‹ ìˆœ)
                        filteredDocs.sort((a, b) => {
                            const timeA = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                            const timeB = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                            return timeB - timeA;
                        });
                        
                        // ìµœëŒ€ 10ê°œë§Œ ì„ íƒ
                        const limitedDocs = filteredDocs.slice(0, 10);
                        console.log('í•„í„°ë§ëœ í¬ì¸íŠ¸ ì´ë ¥:', limitedDocs.length, 'ê±´');
                        
                        // Firestore ìŠ¤ëƒ…ìƒ· í˜•íƒœë¡œ ë³€í™˜
                        historySnapshot = {
                            empty: limitedDocs.length === 0,
                            size: limitedDocs.length,
                            forEach: (callback) => {
                                limitedDocs.forEach((doc, index) => {
                                    callback({
                                        id: doc.id,
                                        data: () => doc
                                    });
                                });
                            }
                        };
                        
                    } catch (queryError) {
                        console.warn('í¬ì¸íŠ¸ ì´ë ¥ ì¿¼ë¦¬ ì‹¤íŒ¨:', queryError);
                        historySnapshot = null;
                    }
                    
                    // pointHistory ë°°ì—´ì„ filteredDocsë¡œ ì„¤ì •
                    pointHistory = filteredDocs;
                    console.log('í¬ì¸íŠ¸ ì´ë ¥ ë°°ì—´ ì„¤ì • ì™„ë£Œ:', pointHistory.length, 'ê±´');
                    
                    // í¬ì¸íŠ¸ ê³„ì‚° ë° ì—…ë°ì´íŠ¸
                    if (pointHistory.length > 0) {
                        pointHistory.forEach(item => {
                            console.log('âœ… ì‚¬ìš©ì ì´ë ¥ í™•ì¸:', item.type, item.points, item.reason);
                        });
                        
                        // í¬ì¸íŠ¸ ê³„ì‚° ë° ì—…ë°ì´íŠ¸
                        const calculatedPoints = earnedPoints - usedPoints;
                        console.log('í¬ì¸íŠ¸ ì´ë ¥ ê¸°ë°˜ ê³„ì‚°:', {
                            earnedPoints,
                            usedPoints,
                            calculatedPoints,
                            currentDisplayPoints: pointsPageUser.points
                        });
                        
                        // ê³„ì‚°ëœ í¬ì¸íŠ¸ê°€ ë‹¤ë¥´ë©´ ì—…ë°ì´íŠ¸ (ë‹¨, 0ë³´ë‹¤ ì‘ìœ¼ë©´ ì•ˆë¨)
                        if (calculatedPoints !== pointsPageUser.points && calculatedPoints >= 0) {
                            console.log('í¬ì¸íŠ¸ ë¶ˆì¼ì¹˜ ê°ì§€, ì—…ë°ì´íŠ¸ ì¤‘...');
                            pointsPageUser.points = calculatedPoints;
                            currentPoints = calculatedPoints;
                            
                            // í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸
                            const pointsElement = document.getElementById('current-points');
                            if (pointsElement) {
                                pointsElement.textContent = calculatedPoints.toLocaleString();
                                console.log('âœ… í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', calculatedPoints);
                            }
                            
                            // Firebaseì— í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸ (ì´ë©”ì¼ì„ ë¬¸ì„œ IDë¡œ ì‚¬ìš©)
                            if (typeof firebase !== 'undefined' && firebase.firestore) {
                                const db = firebase.firestore();
                                db.collection('users').doc(pointsPageUser.email).update({
                                    points: calculatedPoints
                                }).then(() => {
                                    console.log('âœ… Firebase í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', calculatedPoints);
                                }).catch(error => {
                                    console.error('Firebase í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                                });
                            }
                        } else if (calculatedPoints < 0) {
                            console.log('âš ï¸ ê³„ì‚°ëœ í¬ì¸íŠ¸ê°€ ìŒìˆ˜ì…ë‹ˆë‹¤. ì›ë³¸ í¬ì¸íŠ¸ ìœ ì§€:', pointsPageUser.points);
                        }
                        
                        // pointHistory ë°°ì—´ì„ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ì •ë ¬ì€ í‘œì‹œí•  ë•Œ ìˆ˜í–‰)
                        window.pointHistory = pointHistory;
                        console.log('âœ… pointHistory ì „ì—­ ì €ì¥ ì™„ë£Œ:', pointHistory.length, 'ê±´');
                    }

                    console.log('Firebaseì—ì„œ í¬ì¸íŠ¸ ì´ë ¥ ë¡œë“œ ì™„ë£Œ:', pointHistory.length, 'ê±´');
                } else {
                    console.log('Firebaseê°€ ì‚¬ìš© ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤');
                    pointHistory = [];
                }

                // ì´ë ¥ í‘œì‹œ ì—…ë°ì´íŠ¸
                updatePointHistoryDisplay();
                
            } catch (error) {
                console.error('í¬ì¸íŠ¸ ì´ë ¥ ë¡œë“œ ì˜¤ë¥˜:', error);
                pointHistory = [];
                updatePointHistoryDisplay();
            }
        }

        // í˜ì´ì§€ í¬ì»¤ìŠ¤ ì‹œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì„¤ì •
        function setupPageRefresh() {
            console.log('ğŸ”„ í˜ì´ì§€ í¬ì»¤ìŠ¤ ìƒˆë¡œê³ ì¹¨ ì„¤ì •');
            
            // í˜ì´ì§€ í¬ì»¤ìŠ¤ ì‹œ í¬ì¸íŠ¸ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
            window.addEventListener('focus', async () => {
                console.log('ğŸ“± í˜ì´ì§€ í¬ì»¤ìŠ¤ ê°ì§€ - í¬ì¸íŠ¸ ë°ì´í„° ìƒˆë¡œê³ ì¹¨');
                try {
                    await loadPointInfo();
                    await loadPointHistory();
                } catch (error) {
                    console.error('í¬ì»¤ìŠ¤ ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:', error);
                }
            });
            
            // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì‹œ ìƒˆë¡œê³ ì¹¨
            document.addEventListener('visibilitychange', async () => {
                if (!document.hidden) {
                    console.log('ğŸ‘ï¸ í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ - í¬ì¸íŠ¸ ë°ì´í„° ìƒˆë¡œê³ ì¹¨');
                    try {
                        await loadPointInfo();
                        await loadPointHistory();
                    } catch (error) {
                        console.error('ê°€ì‹œì„± ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:', error);
                    }
                }
            });
        }

        // í¬ì¸íŠ¸ ì´ë ¥ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updatePointHistoryDisplay() {
            const container = document.getElementById('point-history-container');
            
            console.log('í¬ì¸íŠ¸ ì´ë ¥ í‘œì‹œ ì—…ë°ì´íŠ¸ ì‹œì‘:', pointHistory.length, 'ê±´');
            
            if (pointHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p class="japanese-text">ãƒã‚¤ãƒ³ãƒˆå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        <small class="text-muted japanese-text">å•†å“è³¼å…¥æ™‚ã«ãƒã‚¤ãƒ³ãƒˆå±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</small>
                            </div>
                `;
                return;
            }

            // í¬ì¸íŠ¸ ì´ë ¥ì„ ìµœì‹  ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ì´ ë§¨ ìœ„ì— ì˜¤ë„ë¡)
            const sortedHistory = [...pointHistory].sort((a, b) => {
                // ì•ˆì „í•œ íƒ€ì„ìŠ¤íƒ¬í”„ ì²˜ë¦¬
                const getTimestamp = (item) => {
                    if (!item || !item.timestamp) {
                        console.warn('íƒ€ì„ìŠ¤íƒ¬í”„ê°€ ì—†ëŠ” í•­ëª©:', item);
                        return new Date(0);
                    }
                    
                    try {
                        // Firestore Timestamp ê°ì²´ì¸ ê²½ìš°
                        if (item.timestamp.toDate && typeof item.timestamp.toDate === 'function') {
                            const date = item.timestamp.toDate();
                            console.log('Firestore Timestamp:', item.timestamp, 'â†’ Date:', date);
                            return date;
                        }
                        
                        // Date ê°ì²´ì¸ ê²½ìš°
                        if (item.timestamp instanceof Date) {
                            console.log('Date ê°ì²´:', item.timestamp);
                            return item.timestamp;
                        }
                        
                        // ìˆ«ìë‚˜ ë¬¸ìì—´ì¸ ê²½ìš°
                        const date = new Date(item.timestamp);
                        console.log('ë¬¸ìì—´/ìˆ«ì:', item.timestamp, 'â†’ Date:', date);
                        return date;
                    } catch (error) {
                        console.error('íƒ€ì„ìŠ¤íƒ¬í”„ íŒŒì‹± ì˜¤ë¥˜:', error, item.timestamp);
                        return new Date(0);
                    }
                };
                
                const timeA = getTimestamp(a);
                const timeB = getTimestamp(b);
                
                console.log('ì •ë ¬ ë¹„êµ:', {
                    a: { timestamp: a.timestamp, parsed: timeA },
                    b: { timestamp: b.timestamp, parsed: timeB },
                    diff: timeB - timeA
                });
                
                // ìµœì‹  ìˆœìœ¼ë¡œ ì •ë ¬ (í° ê°’ì´ ë¨¼ì €)
                return timeB - timeA;
            });
            
            console.log('í¬ì¸íŠ¸ ì´ë ¥ ì •ë ¬ ì™„ë£Œ (ìµœì‹  ìˆœ):', sortedHistory.length, 'ê±´');
            console.log('ì •ë ¬ëœ ì²« 3ê°œ í•­ëª©:', sortedHistory.slice(0, 3).map(item => ({
                timestamp: item.timestamp,
                type: item.type,
                reason: item.reason
            })));

            let historyHTML = '<div class="table-responsive"><table class="table table-hover">';
            historyHTML += '<thead><tr><th class="japanese-text">æ—¥ä»˜</th><th class="japanese-text">å†…å®¹ãƒ»æ³¨æ–‡è©³ç´°</th><th class="japanese-text">ãƒã‚¤ãƒ³ãƒˆ</th></tr></thead><tbody>';
            
            sortedHistory.forEach((item, index) => {
                console.log(`ì´ë ¥ ${index + 1}:`, item);
                
                let date;
                try {
                    if (item.timestamp && item.timestamp.toDate) {
                        date = item.timestamp.toDate();
                    } else if (item.timestamp) {
                        date = new Date(item.timestamp);
                    } else {
                        date = new Date();
                    }
                } catch (dateError) {
                    console.warn('ë‚ ì§œ íŒŒì‹± ì˜¤ë¥˜:', dateError, item.timestamp);
                    date = new Date();
                }
                
                const dateStr = date.toLocaleDateString('ja-JP');
                
                // í¬ì¸íŠ¸ í‘œì‹œ ë¡œì§ ê°œì„  (typeì— ë”°ë¼ í‘œì‹œ)
                let pointsStr, pointsClass;
                if (item.type === 'use' || item.type === 'admin_subtract') {
                    // í¬ì¸íŠ¸ ì‚¬ìš©/ì°¨ê°ì¸ ê²½ìš° ìŒìˆ˜ë¡œ í‘œì‹œ
                    pointsStr = `-${item.points}`;
                    pointsClass = 'text-danger';
                } else if (item.type === 'earn' || item.type === 'admin_add') {
                    // í¬ì¸íŠ¸ ì ë¦½ì¸ ê²½ìš° ì–‘ìˆ˜ë¡œ í‘œì‹œ
                    pointsStr = `+${item.points}`;
                    pointsClass = 'text-success';
                } else {
                    // ê¸°ì¡´ ë¡œì§ (í˜¸í™˜ì„±)
                    pointsStr = item.points > 0 ? `+${item.points}` : item.points;
                    pointsClass = item.points > 0 ? 'text-success' : 'text-danger';
                }
                
                // ì´ë ¥ ë‚´ìš© ê²°ì • (ì£¼ë¬¸ ì •ë³´ í¬í•¨)
                let description = 'ãƒã‚¤ãƒ³ãƒˆå–å¼•';
                let orderInfo = ''; // ì£¼ë¬¸ ì •ë³´ ì¶”ê°€
                
                if (item.reason) {
                    // í•œêµ­ì–´ reasonì„ ì¼ë³¸ì–´ë¡œ ë³€í™˜
                    if (item.reason.includes('ì‹ ê·œ ê°€ì… ì›°ì»´ ë³´ë„ˆìŠ¤') || item.reason.includes('ì‹ ê·œ ê°€ì…')) {
                        description = 'æ–°è¦ç™»éŒ²ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒœãƒ¼ãƒŠã‚¹';
                    } else if (item.reason.includes('ì›°ì»´ ë³´ë„ˆìŠ¤')) {
                        description = 'ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒœãƒ¼ãƒŠã‚¹';
                    } else if (item.reason.includes('í¬ì¸íŠ¸ ì ë¦½')) {
                        description = 'ãƒã‚¤ãƒ³ãƒˆé‚„å…ƒ';
                    } else if (item.reason.includes('í¬ì¸íŠ¸ ì‚¬ìš©')) {
                        description = 'ãƒã‚¤ãƒ³ãƒˆä½¿ç”¨';
                    } else if (item.reason.includes('ê´€ë¦¬ì')) {
                        description = 'ç®¡ç†è€…æ“ä½œ';
                    } else {
                        description = item.reason;
                    }
                } else if (item.type === 'earn') {
                    description = 'å•†å“è³¼å…¥';
                } else if (item.type === 'use') {
                    description = 'å•†å“è³¼å…¥æ™‚ä½¿ç”¨';
                } else if (item.type === 'admin_add') {
                    description = 'ç®¡ç†è€…ä»˜ä¸';
                } else if (item.type === 'admin_subtract') {
                    description = 'ç®¡ç†è€…å·®å¼•';
                } else if (item.type === 'welcome_bonus') {
                    description = 'æ–°è¦ç™»éŒ²ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒœãƒ¼ãƒŠã‚¹';
                } else if (item.description) {
                    description = item.description;
                }
                
                // ê°„ë‹¨í•œ ì„¤ëª…ë§Œ í‘œì‹œ (ìƒì„¸ ì •ë³´ ì œê±°)
                historyHTML += `
                    <tr>
                        <td class="japanese-text">${dateStr}</td>
                        <td class="japanese-text">${description}</td>
                        <td class="${pointsClass} japanese-text">${pointsStr}</td>
                    </tr>
                `;
            });
            
            historyHTML += '</tbody></table></div>';
            container.innerHTML = historyHTML;
            
            console.log('í¬ì¸íŠ¸ ì´ë ¥ í‘œì‹œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        }

        // Firebase Auth ìƒíƒœë¥¼ ê¸°ë‹¤ë¦¬ëŠ” í•¨ìˆ˜
        async function waitForFirebaseAuth() {
            return new Promise((resolve) => {
                if (typeof firebase === 'undefined' || !firebase.auth) {
                    console.log('Firebaseê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•ŠìŒ, ëŒ€ê¸° ì¤‘...');
                    const checkFirebase = setInterval(() => {
                        if (typeof firebase !== 'undefined' && firebase.auth) {
                            clearInterval(checkFirebase);
                            waitForAuthState();
                        }
                    }, 100);
                    return;
                }
                
                waitForAuthState();
                
                function waitForAuthState() {
                    // ì´ë¯¸ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ìˆëŠ”ì§€ í™•ì¸
                    const currentUser = firebase.auth().currentUser;
                    if (currentUser) {
                        console.log('ì´ë¯¸ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ë°œê²¬:', currentUser.email);
                        resolve(currentUser);
                        return;
                    }
                    
                    // Auth ìƒíƒœ ë³€í™”ë¥¼ ê¸°ë‹¤ë¦¼ (ìµœëŒ€ 5ì´ˆ)
                    let timeoutId = setTimeout(() => {
                        console.log('Firebase Auth ìƒíƒœ í™•ì¸ ì‹œê°„ ì´ˆê³¼');
                        resolve(null);
                    }, 5000);
                    
                    const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
                        clearTimeout(timeoutId);
                        unsubscribe();
                        if (user) {
                            console.log('Firebase Auth ìƒíƒœ í™•ì¸ ì™„ë£Œ:', user.email);
                            resolve(user);
                        } else {
                            console.log('Firebase Authì—ì„œ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                            resolve(null);
                        }
                    });
                }
            });
        }

        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ í•¨ìˆ˜ (í”„ë¡œí•„ í˜ì´ì§€ì™€ ë™ì¼)
        function getLoginStatus() {
            try {
                // Firebase Authì—ì„œ í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const user = firebase.auth().currentUser;
                if (user) {
                    return {
                        uid: user.uid,
                        email: user.email,
                        name: user.displayName || user.email.split('@')[0]
                    };
                }
                
                // Firebase ì‚¬ìš©ìê°€ ì—†ìœ¼ë©´ null ë°˜í™˜
                return null;
            } catch (error) {
                console.error('ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
                return null;
            }
        }

        // í˜ì´ì§€ ì´ˆê¸°í™”
        async function initializePointsPage() {
            console.log('=== í¬ì¸íŠ¸ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘ ===');
            
            // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            let userData = null;
            let userPoints = 0;
            
            try {
                // Firebase Auth ì‚¬ìš©ì í™•ì¸ (ë” ì•ˆì „í•œ ë°©ì‹)
                console.log('Firebase ìƒíƒœ í™•ì¸:', {
                    firebase: typeof firebase !== 'undefined',
                    auth: typeof firebase !== 'undefined' && firebase.auth,
                    currentUser: typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser
                });
                
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    const user = firebase.auth().currentUser;
                    console.log('Firebase Auth currentUser:', user);
                    
                    if (user) {
                        console.log('Firebase Auth ì‚¬ìš©ì ë°œê²¬:', user.email);
                        
                        // Firestoreì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                        if (firebase.firestore) {
                    const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
                    
                    if (userDoc.exists) {
                        userData = {
                            name: userDoc.data().name || user.displayName || user.email.split('@')[0],
                            email: user.email,
                            uid: user.uid,
                            points: userDoc.data().points || 0
                        };
                        userPoints = userData.points;
                        console.log('Firebaseì—ì„œ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì„±ê³µ:', userData);
                            } else {
                                console.log('ì‚¬ìš©ì ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ, ìƒˆë¡œ ìƒì„±');
                                // ì‚¬ìš©ì ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                                await firebase.firestore().collection('users').doc(user.uid).set({
                                    name: user.displayName || user.email.split('@')[0],
                                    email: user.email,
                                    points: 0,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                
                            userData = {
                                    name: user.displayName || user.email.split('@')[0],
                                    email: user.email,
                                    uid: user.uid,
                                points: 0
                            };
                                userPoints = 0;
                            }
                        } else {
                            console.log('Firestoreê°€ ì‚¬ìš© ë¶ˆê°€ëŠ¥');
                        }
                    } else {
                        console.log('Firebase Authì—ì„œ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                    }
                } else {
                    console.log('Firebase ë˜ëŠ” Authê°€ ì‚¬ìš© ë¶ˆê°€ëŠ¥');
                }
            } catch (firebaseError) {
                console.warn('Firebase ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', firebaseError);
            }
            
            // Firebase ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
            if (!userData) {
                console.log('Firebaseì—ì„œ ì‚¬ìš©ì ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ, ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™');
                window.location.href = 'login.html?redirect=points.html';
                return;
            }
            
            // 3. ì‚¬ìš©ì ì •ë³´ ì„¤ì •
            if (userData) {
                pointsPageUser = userData;
                currentPoints = userPoints;
                console.log('ìµœì¢… ì‚¬ìš©ì ì •ë³´ ì„¤ì •:', pointsPageUser);
                console.log('í˜„ì¬ í¬ì¸íŠ¸:', currentPoints);
            } else {
                console.log('ì‚¬ìš©ì ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                window.location.href = 'login.html?redirect=points.html';
                    return;
                }
                
            // í¬ì¸íŠ¸ ì •ë³´ ë° ì´ë ¥ ë¡œë“œ
            await loadPointInfo();
            await loadPointHistory();
            
            // Firebase ì „ìš© QR ì½”ë“œ ì‹œìŠ¤í…œ - Firebase ì´ˆê¸°í™” ì™„ë£Œ í›„ ìë™ ìƒì„±
            console.log('QR ì½”ë“œëŠ” Firebase ì´ˆê¸°í™” ì™„ë£Œ í›„ ìë™ ìƒì„±ë©ë‹ˆë‹¤');
            
            // QR ì½”ë“œ ìƒì„± ê°•ì œ ì‹¤í–‰ (ë” ê¸´ ì§€ì—° ì‹œê°„)
            setTimeout(() => {
                if (typeof window.unifiedQRCodeManager !== 'undefined' && window.unifiedQRCodeManager) {
                    console.log('QR ì½”ë“œ ë§¤ë‹ˆì €ê°€ ì¡´ì¬í•¨, ê°•ì œ QR ì½”ë“œ ìƒì„± ì‹œë„');
                    window.unifiedQRCodeManager.autoGenerateQRCode();
                } else {
                    console.log('QR ì½”ë“œ ë§¤ë‹ˆì €ê°€ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ');
                }
            }, 3000);

            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ê¸°ëŠ¥ ì„¤ì •
            setupPageRefresh();

            console.log('í¬ì¸íŠ¸ í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
        }

        // ë„¤ë¹„ê²Œì´ì…˜ ë°” ì‚¬ìš©ì ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateNavigationUserState(user) {
            try {
                console.log('ë„¤ë¹„ê²Œì´ì…˜ ë°” ì‚¬ìš©ì ìƒíƒœ ì—…ë°ì´íŠ¸:', user.email);
                
                // ë°ìŠ¤í¬í†± ì‚¬ìš©ì ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
                const userDropdown = document.getElementById('userDropdown');
                const userName = document.getElementById('user-name');
                
                if (userDropdown && userName) {
                    // ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ
                    userName.textContent = user.displayName || user.email.split('@')[0];
                    
                    // ë¡œê·¸ì¸/íšŒì›ê°€ì… ë©”ë‰´ ìˆ¨ê¸°ê¸°
                    const loginMenu = document.getElementById('login-menu');
                    const registerMenu = document.getElementById('register-menu');
                    if (loginMenu) loginMenu.style.display = 'none';
                    if (registerMenu) registerMenu.style.display = 'none';
                    
                    // í”„ë¡œí•„/í¬ì¸íŠ¸ ë©”ë‰´ í‘œì‹œ
                    const profileMenu = document.getElementById('profile-menu');
                    const pointsMenu = document.getElementById('points-menu');
                    if (profileMenu) profileMenu.style.display = 'block';
                    if (pointsMenu) pointsMenu.style.display = 'block';
                    
                    // ë¡œê·¸ì•„ì›ƒ ë©”ë‰´ í‘œì‹œ
                    const logoutMenu = document.getElementById('logout-menu');
                    const logoutMenuItem = document.getElementById('logout-menu-item');
                    if (logoutMenu) logoutMenu.style.display = 'block';
                    if (logoutMenuItem) logoutMenuItem.style.display = 'block';
                }
                
                // ëª¨ë°”ì¼ ì‚¬ìš©ì ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
                const userDropdownMobile = document.getElementById('userDropdownMobile');
                if (userDropdownMobile) {
                    // ë¡œê·¸ì¸/íšŒì›ê°€ì… ë©”ë‰´ ìˆ¨ê¸°ê¸°
                    const loginMenuMobile = document.getElementById('login-menu-mobile');
                    const registerMenuMobile = document.getElementById('register-menu-mobile');
                    if (loginMenuMobile) loginMenuMobile.style.display = 'none';
                    if (registerMenuMobile) registerMenuMobile.style.display = 'none';
                    
                    // í”„ë¡œí•„/í¬ì¸íŠ¸ ë©”ë‰´ í‘œì‹œ
                    const profileMenuMobile = document.getElementById('profile-menu-mobile');
                    const pointsMenuMobile = document.getElementById('points-menu-mobile');
                    if (profileMenuMobile) profileMenuMobile.style.display = 'block';
                    if (pointsMenuMobile) pointsMenuMobile.style.display = 'block';
                    
                    // ë¡œê·¸ì•„ì›ƒ ë©”ë‰´ í‘œì‹œ
                    const logoutMenuMobile = document.getElementById('logout-menu-mobile');
                    const logoutMenuItemMobile = document.getElementById('logout-menu-item-mobile');
                    if (logoutMenuMobile) logoutMenuMobile.style.display = 'block';
                    if (logoutMenuItemMobile) logoutMenuItemMobile.style.display = 'block';
                }
                
                console.log('âœ… ë„¤ë¹„ê²Œì´ì…˜ ë°” ì‚¬ìš©ì ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
            } catch (error) {
                console.error('ë„¤ë¹„ê²Œì´ì…˜ ë°” ì‚¬ìš©ì ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }

        // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
        function logout() {
            try {
                console.log('ë¡œê·¸ì•„ì›ƒ ì‹œì‘');
                
                // Firebase ë¡œê·¸ì•„ì›ƒ
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    firebase.auth().signOut().then(() => {
                        console.log('Firebase ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
                        
                        // Firebase ì „ìš© ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ
                        
                        // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                        window.location.href = 'login.html';
                    }).catch((error) => {
                        console.error('Firebase ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                        // ì˜¤ë¥˜ê°€ ìˆì–´ë„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                        window.location.href = 'login.html';
                    });
                } else {
                    // Firebaseê°€ ì—†ëŠ” ê²½ìš° ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                window.location.href = 'login.html';
            }
        }

        // í˜ì´ì§€ í¬ì»¤ìŠ¤ ì‹œ í¬ì¸íŠ¸ ì •ë³´ ìƒˆë¡œê³ ì¹¨
        function setupPageRefresh() {
            // í˜ì´ì§€ê°€ í¬ì»¤ìŠ¤ë¥¼ ë°›ì„ ë•Œë§ˆë‹¤ í¬ì¸íŠ¸ ì •ë³´ ìƒˆë¡œê³ ì¹¨
            window.addEventListener('focus', async () => {
                console.log('í˜ì´ì§€ í¬ì»¤ìŠ¤ ê°ì§€ - í¬ì¸íŠ¸ ì •ë³´ ìƒˆë¡œê³ ì¹¨');
                if (pointsPageUser) {
                    await loadPointInfo();
                    await loadPointHistory();
                }
            });
            
            // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì‹œì—ë„ ìƒˆë¡œê³ ì¹¨
            document.addEventListener('visibilitychange', async () => {
                if (!document.hidden && pointsPageUser) {
                    console.log('í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ê°ì§€ - í¬ì¸íŠ¸ ì •ë³´ ìƒˆë¡œê³ ì¹¨');
                    await loadPointInfo();
                    await loadPointHistory();
                }
            });
        }

        // Firebase ì´ˆê¸°í™” ì™„ë£Œ í›„ í¬ì¸íŠ¸ ì´ë ¥ ë° QR ì½”ë“œ ë‹¤ì‹œ ë¡œë“œ
        async function reloadPointHistoryAfterFirebase() {
            console.log('Firebase ì´ˆê¸°í™” ì™„ë£Œ í›„ í¬ì¸íŠ¸ ì´ë ¥ ë° QR ì½”ë“œ ë‹¤ì‹œ ë¡œë“œ');
            if (pointsPageUser) {
                try {
                    // í¬ì¸íŠ¸ ì´ë ¥ ë‹¤ì‹œ ë¡œë“œ
                    setTimeout(() => {
                        loadPointHistory();
                    }, 500);
                    
                    // QR ì½”ë“œëŠ” common-qr-code.jsì—ì„œ ìë™ìœ¼ë¡œ ì²˜ë¦¬
                } catch (error) {
                    console.error('Firebase ì´ˆê¸°í™” í›„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                }
            }
        }
        
                // QR ì½”ë“œ ìƒì„±ì€ common-qr-code.jsì—ì„œ ìë™ìœ¼ë¡œ ì²˜ë¦¬

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== points.html DOMContentLoaded ì‹œì‘ ===');
            
            // Firebase ì „ìš© ì´ˆê¸°í™” - localStorage ì •ë¦¬ ì œê±°ë¨
            console.log('ğŸ”„ Firebase ì „ìš© í¬ì¸íŠ¸ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');
            
            // ê°„ë‹¨í•˜ê³  ì§ì ‘ì ì¸ ì´ˆê¸°í™” ë°©ì‹
            const initializePointsPageSimple = async () => {
                console.log('í¬ì¸íŠ¸ í˜ì´ì§€ ê°„ë‹¨ ì´ˆê¸°í™” ì‹œì‘');
                
                // 1. ê¸°ë³¸ í¬ì¸íŠ¸ í˜ì´ì§€ í‘œì‹œ
                const pointsElement = document.getElementById('current-points');
                if (pointsElement) {
                    pointsElement.textContent = '-';
                }
                
                const historyContainer = document.getElementById('point-history-container');
                if (historyContainer) {
                    historyContainer.innerHTML = '<p class="text-muted japanese-text">ãƒã‚¤ãƒ³ãƒˆå±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
                }
                
                // QR ì½”ë“œ ì»¨í…Œì´ë„ˆëŠ” ìŠ¤í”¼ë„ˆë§Œ í‘œì‹œ (ë¬¸êµ¬ ì œê±°ë¨)
                
                // 2. Firebase ì´ˆê¸°í™” ëŒ€ê¸°
                let attempts = 0;
                while (attempts < 100) { // 10ì´ˆ ëŒ€ê¸°
                    if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
                        console.log('âœ… Firebase ì¤€ë¹„ ì™„ë£Œ');
                        break;
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (attempts >= 100) {
                    console.warn('Firebase ì´ˆê¸°í™” ì‹œê°„ ì´ˆê³¼');
                    return;
                }
                
                // 3. Firebase Auth ì™„ì „ ë¡œë“œ ëŒ€ê¸° í›„ ì‚¬ìš©ì ì •ë³´ í™•ì¸
                try {
                    // Firebase Authê°€ ì™„ì „íˆ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
                    let user = null;
                    await new Promise((resolve) => {
                        const unsubscribe = firebase.auth().onAuthStateChanged((authUser) => {
                            unsubscribe(); // í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ë„ë¡ êµ¬ë… í•´ì œ
                            user = authUser;
                            resolve(authUser);
                        });
                    });
                    
                    // ì‚¬ìš©ì ì •ë³´ í™•ì¸
                    console.log('Firebase Auth ì‚¬ìš©ì:', user);
                    
                    // currentUserë„ í™•ì¸ (ë°±ì—…)
                    if (!user) {
                        user = firebase.auth().currentUser;
                        console.log('currentUser ë°±ì—… í™•ì¸:', user);
                    }
                    
                    if (user) {
                        console.log('âœ… ë¡œê·¸ì¸ëœ ì‚¬ìš©ì í™•ì¸:', user.email);
                        
                        // ì‚¬ìš©ì ì •ë³´ ì„¤ì •
                        pointsPageUser = {
                            uid: user.uid,
                            email: user.email,
                            name: user.displayName || user.email.split('@')[0],
                            points: 0
                        };
                        
                        // ë„¤ë¹„ê²Œì´ì…˜ ë°” ì‚¬ìš©ì ìƒíƒœ ì—…ë°ì´íŠ¸
                        updateNavigationUserState(user);
                        
                        // ë°ì´í„° ë¡œë“œ (ë¹„ë™ê¸° ì²˜ë¦¬)
                        loadPointInfo().then(() => {
                            console.log('í¬ì¸íŠ¸ ì •ë³´ ë¡œë“œ ì™„ë£Œ');
                            return loadPointHistory();
                        }).then(() => {
                            console.log('í¬ì¸íŠ¸ ì´ë ¥ ë¡œë“œ ì™„ë£Œ');
                            // QRì½”ë“œëŠ” common-qr-code.jsì—ì„œ ìë™ìœ¼ë¡œ ì²˜ë¦¬
                            console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
                            
                            // í˜ì´ì§€ í¬ì»¤ìŠ¤ ì‹œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì„¤ì •
                            setupPageRefresh();
                        }).catch(error => {
                            console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                            // ì˜¤ë¥˜ê°€ ìˆì–´ë„ QRì½”ë“œëŠ” í‘œì‹œ
                            console.log('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜ ë¬´ì‹œí•˜ê³  QRì½”ë“œ í‘œì‹œ');
                            // common-qr-code.jsê°€ ìë™ìœ¼ë¡œ ì²˜ë¦¬
                        });
                        
                        console.log('í¬ì¸íŠ¸ í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
                    } else {
                        console.log('âŒ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì—†ìŒ');
                        // Firebase ì „ìš© - localStorage í´ë°± ì œê±°ë¨
                    }
                } catch (error) {
                    console.error('í¬ì¸íŠ¸ í˜ì´ì§€ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                }
            };
            
            // ì´ˆê¸°í™” ì‹¤í–‰
            initializePointsPageSimple();
        });
        
        // QR ì½”ë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” common-qr-code.jsì—ì„œ ìë™ìœ¼ë¡œ ì²˜ë¦¬
        
        // ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ common-qr-code.jsì—ì„œ ì²˜ë¦¬

        // QR ì½”ë“œ ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ common-qr-code.jsì—ì„œ ì²˜ë¦¬
        
        // í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤ ì œê±°ë¨ - common-qr-code.jsì—ì„œ ìë™ ì²˜ë¦¬
        
        // ì „ì—­ í•¨ìˆ˜ëŠ” common-qr-code.jsì—ì„œ ì²˜ë¦¬
    </script>
    
    <!-- End Script -->
</body>

</html>
 
 