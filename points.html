<!DOCTYPE html>
<html lang="en">

<head>
    <title>Aether - Points</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="msapplication-config" content="none">
    <meta name="theme-color" content="#ffffff">

    <link rel="icon" type="image/png" sizes="192x192" href="assets/img/aether-icon.png?t=1750992166">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/img/aether-icon.png?t=1750992166">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/img/aether-icon.png?t=1750992166">
    <link rel="apple-touch-icon" sizes="192x192" href="assets/img/aether-icon.png?t=1750992166">
    <link rel="apple-touch-icon-precomposed" href="assets/img/aether-icon.png?t=1750992166">
    
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/templatemo.css">
    <link rel="stylesheet" href="assets/css/custom.css">

    <!-- Load fonts style after rendering the layout styles -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800;900&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100;200;300;400;500;600;700;800;900&display=swap">
    <style>
        body {
            font-family: "Montserrat", sans-serif;
        }
        h1, h2, h3, h4, h5, h6, .h1, .h2, .h3, .h4, .h5, .h6 {
            font-family: "Montserrat", sans-serif;
            font-weight: 600;
        }
        .japanese-text {
            font-family: "Noto Sans JP", "Hiragino Sans", "Yu Gothic", "Meiryo", sans-serif !important;
            font-weight: 400;
            line-height: 1.6;
        }
        .japanese-heading {
            font-family: "Noto Sans JP", "Hiragino Sans", "Yu Gothic", "Meiryo", sans-serif !important;
            font-weight: 600;
            line-height: 1.4;
        }
    </style>
    <link rel="stylesheet" href="assets/css/fontawesome.min.css">
    <style>
        /* User dropdown hover fix */
        .dropdown-toggle:hover,
        .dropdown-toggle:focus,
        #user-name:hover {
            color: #343a40 !important;
            text-decoration: none !important;
        }
        .nav-link:hover {
            color: #343a40 !important;
        }
        
        /* λ„¤λΉ„κ²μ΄μ…λ°” ν…μ¤νΈ thin μ„μ²΄ ν†µμΌ */
        .navbar-nav .nav-link {
            font-family: "Montserrat", sans-serif !important;
            font-weight: 300 !important;
            font-size: 1rem !important;
        }
        
        .navbar-brand {
            font-family: "Montserrat", sans-serif !important;
            font-weight: 300 !important;
        }
        
        #user-name {
            font-family: "Montserrat", sans-serif !important;
            font-weight: 300 !important;
        }
        
        /* ν¬μΈνΈ νμ΄μ§€ μ „μ© μ¤νƒ€μΌ */
        .point-card {
            background: #fff;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .point-number {
            font-size: 4rem;
            font-weight: 700;
            color: #343a40;
            text-align: center;
            line-height: 1.2;
        }
        
        .point-number strong {
            font-size: 4rem;
            font-weight: 700;
        }
        
        .point-number span {
            font-size: 2rem;
            font-weight: normal;
            color: #6c757d;
        }
        
        .qr-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .qr-code-container {
            text-align: center;
            margin: 20px auto;
            width: 200px;
            height: 200px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .qr-code-container canvas {
            margin: 0 auto;
            border-radius: 4px;
        }
        
        .history-section {
            background: #fff;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>

<body>
    <!-- Start Top Nav -->
    <nav class="navbar navbar-expand-lg bg-black navbar-light d-none d-lg-block" id="templatemo_nav_top" style="min-height: 20px;">
        <div class="container text-light">
            <div class="w-100 d-flex justify-content-between">
                <div>
                    <!-- λΉ κ³µκ°„μΌλ΅ λΈ”λ™ λ°” μ μ§€ -->
                </div>
            </div>
        </div>
    </nav>
    <!-- Close Top Nav -->

    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-light shadow">
        <div class="container d-flex justify-content-between align-items-center">
            <!-- QR μ½”λ“ μ•„μ΄μ½ - μ¤‘κ°„ μ„Ήμ…μ—μ„λ§ μ‚¬μ© -->

            <a class="navbar-brand text-success logo align-self-center" href="index.html">
                <img src="assets/img/logo.png" alt="Logo" class="img-fluid" style="max-height: 50px;">
            </a>

            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#templatemo_main_nav" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="align-self-center collapse navbar-collapse flex-fill  d-lg-flex justify-content-lg-between" id="templatemo_main_nav">
                <!-- λ¨λ°”μΌ λ©”λ‰΄ λ μ΄μ•„μ›ƒ -->
                <div class="d-lg-none w-100">
                    <!-- μλ¬Έ λ©”λ‰΄ - κ°€λ΅ μ •λ ¬ -->
                    <div class="d-flex justify-content-center mb-4">
                        <ul class="nav navbar-nav d-flex flex-row gap-4">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="shop.html">Brand</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="info.html">Info</a>
                        </li>
                    </ul>
                </div>
                    
                    <!-- μ•„μ΄μ½λ“¤ - κ°€λ΅ μ •λ ¬, μΆμ° μ—¬λ°± μ¶”κ°€ -->
                    <div class="d-flex justify-content-center align-items-center gap-4 px-4">
                        <a href="cart.html" class="nav-link text-decoration-none">
                            <i class="fas fa-shopping-cart text-dark" style="font-size: 1.5rem;"></i>
                            <span class="badge bg-secondary ms-1" id="cart-count-mobile">0</span>
                        </a>
                        <div class="dropdown">
                            <a href="#" class="nav-link dropdown-toggle text-decoration-none" id="userDropdownMobile" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user text-dark" style="font-size: 1.5rem;"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-center" aria-labelledby="userDropdownMobile">
                                <li id="login-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="login.html">
                                        <i class="fas fa-sign-in-alt me-2"></i>Login
                                    </a>
                                </li>
                                <li id="register-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="register.html">
                                        <i class="fas fa-user-plus me-2"></i>Register
                                    </a>
                                </li>
                                <li id="profile-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="profile.html">
                                        <i class="fas fa-user-circle me-2"></i>Profile
                                    </a>
                                </li>
                                <li id="points-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="points.html">
                                        <i class="fas fa-coins me-2"></i>Points
                                    </a>
                                </li>
                                <li id="admin-menu-mobile" style="display: none;">
                                    <a class="dropdown-item" href="admin-dashboard.html">
                                        <i class="fas fa-cog me-2"></i>η®΅η†γƒ€γƒƒγ‚·γƒ¥γƒγƒΌγƒ‰
                                    </a>
                                </li>
                                <li id="logout-menu-mobile" style="display: none;">
                                    <hr class="dropdown-divider">
                                </li>
                                <li id="logout-menu-item-mobile" style="display: none;">
                                    <a class="dropdown-item" href="#" onclick="logout()">
                                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                                    </a>
                                </li>
                            </ul>
                            </div>
                        </div>
                    </div>
                
                <!-- λ°μ¤ν¬ν†± λ©”λ‰΄ λ μ΄μ•„μ›ƒ -->
                <div class="flex-fill d-none d-lg-block">
                    <ul class="nav navbar-nav d-flex justify-content-between mx-lg-auto" style="max-width: 400px; margin: 0 auto;">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="shop.html">Brand</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="info.html">Info</a>
                        </li>
                    </ul>
                </div>
                <div class="navbar align-self-center d-flex d-none d-lg-flex">
                    <!-- QR μ½”λ“ μ•„μ΄μ½ - μ¤‘κ°„ μ„Ήμ…μ—μ„λ§ μ‚¬μ© -->
                    <a href="cart.html" class="nav-link text-decoration-none me-3">
                        <i class="fas fa-shopping-cart text-dark"></i>
                        <span class="badge bg-secondary" id="cart-count">0</span>
                    </a>
                    <div class="dropdown">
                        <a href="#" class="nav-link dropdown-toggle text-decoration-none" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user text-dark"></i>
                            <span id="user-name" class="d-none d-lg-inline ms-1"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li id="login-menu" style="display: none;">
                                <a class="dropdown-item" href="login.html">
                                    <i class="fas fa-sign-in-alt me-2"></i>Login
                                </a>
                            </li>
                            <li id="register-menu" style="display: none;">
                                <a class="dropdown-item" href="register.html">
                                    <i class="fas fa-user-plus me-2"></i>Register
                                </a>
                            </li>
                            <li id="profile-menu" style="display: none;">
                                <a class="dropdown-item" href="profile.html">
                                    <i class="fas fa-user-circle me-2"></i>Profile
                                </a>
                            </li>
                            <li id="points-menu" style="display: none;">
                                <a class="dropdown-item" href="points.html">
                                    <i class="fas fa-coins me-2"></i>Points
                                </a>
                            </li>
                            <li id="admin-menu" style="display: none;">
                                <a class="dropdown-item" href="admin-dashboard.html">
                                    <i class="fas fa-cog me-2"></i>η®΅η†γƒ€γƒƒγ‚·γƒ¥γƒγƒΌγƒ‰
                                </a>
                            </li>
                            <li id="logout-menu" style="display: none;">
                                <hr class="dropdown-divider">
                            </li>
                            <li id="logout-menu-item" style="display: none;">
                                <a class="dropdown-item" href="#" onclick="logout()">
                                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

        </div>
    </nav>
    <!-- Close Header -->

    <!-- Modal -->
    <div class="modal fade bg-white" id="templatemo_search" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="w-100 pt-1 mb-5 text-right">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            <form action="" method="get" class="modal-content modal-body border-0 p-0">
                <div class="input-group mb-2">
                    <input type="text" class="form-control" id="inputModalSearch" name="q" placeholder="Search ...">
                    <button type="submit" class="input-group-text bg-success text-light">
                        <i class="fa fa-fw fa-search text-white"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Start Banner Hero -->
    <div class="py-5" style="background-color: #000000;">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <h1 class="h2 text-center mb-0" style="color: #ffffff; padding-top: 0.5rem;">
                <i class="fas fa-coins me-2" style="color: #ffffff;"></i>MY POINT PAGE
            </h1>
                </div>
            </div>
        </div>
    </div>
    <!-- End Banner Hero -->

    <!-- Points Usage Info Section -->
    <div class="container py-3">
        <div class="row">
            <div class="col-lg-12">
                <div class="alert border-0 shadow-sm" style="background-color: #ffffff; border: 1px solid #e9ecef !important;">
                    <h6 class="japanese-heading mb-3 text-center" style="font-weight: 600; color: #343a40; font-family: 'Noto Sans JP', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif !important;">
                        <i class="fas fa-info-circle me-2" style="color: #6c757d;"></i>γƒγ‚¤γƒ³γƒγ”ε©η”¨ζ–Ήζ³•
                    </h6>
                    <div class="japanese-text text-center" style="color: #495057; font-size: 0.7rem !important; font-family: 'Noto Sans JP', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif !important;">
                        <p class="mb-2" style="font-size: 0.7rem !important; font-family: 'Noto Sans JP', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif !important;">
                            <strong style="font-size: 0.7rem !important; color: #343a40; font-family: 'Noto Sans JP', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif !important;">*γƒγ‚¤γƒ³γƒδ»δΈζ–Ήζ³•οΌ</strong>aether-store.jp ε…¬εΌγ‚¦γ‚§γƒ–γ‚µγ‚¤γƒγ€γΎγγ―εΊ—ι ­γ«γ¦γ€θ³Όε…¥ι‡‘ι΅γ«ε―Ύγ—γ€3%γ®γƒγ‚¤γƒ³γƒγδ»δΈγ•γ‚γΎγ™γ€‚
                        </p>
                        <p class="mb-0" style="font-size: 0.7rem !important; font-family: 'Noto Sans JP', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif !important;">
                            <strong style="font-size: 0.7rem !important; color: #343a40; font-family: 'Noto Sans JP', 'Hiragino Sans', 'Yu Gothic', 'Meiryo', sans-serif !important;">**η²εΎ—γ•γ‚γγƒγ‚¤γƒ³γƒοΌ</strong>aether-store.jp ε…¬εΌγ‚¦γ‚§γƒ–γ‚µγ‚¤γƒγ€γΎγγ―εΊ—ι ­γ«γ¦γ€γƒγ‚¤γƒ³γƒι‡‘ι΅γ«εΏγγε•†ε“γ¨δΊ¤ζ›γ„γγ γ‘γΎγ™γ€‚
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End Points Usage Info Section -->

    <!-- Start Points Section -->
    <div class="container py-5">
        <div class="row">
            <!-- ν¬μΈνΈ μΉ΄λ“ -->
            <div class="col-lg-4 mb-4">
                <div class="point-card">
                    <h3 class="text-center mb-4">
                        <i class="fas fa-coins me-2"></i>MY POINTS
                    </h3>
                    <div class="point-number">
                        <strong id="current-points">-</strong>
                        <span>pt</span>
                    </div>
                </div>
            </div>

            <!-- QR μ½”λ“ μ„Ήμ… -->
            <div class="col-lg-8 mb-4">
                <div class="qr-section">
                    <h3 class="mb-4">
                        <i class="fas fa-qrcode me-2"></i>MY QRCODE
                    </h3>
                    <div class="qr-code-container" id="qr-code-container">
                        <div class="spinner-border text-secondary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>

        <!-- ν¬μΈνΈ μ΄λ ¥ μ„Ήμ… -->
        <div class="row">
            <div class="col-12">
                <div class="history-section">
                <h3 class="japanese-heading mb-4">
                    <i class="fas fa-history me-2"></i>γƒγ‚¤γƒ³γƒε±¥ζ­΄
                </h3>
                    <div id="point-history-container">
                        <div class="text-center text-muted">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <p class="japanese-text">γƒγ‚¤γƒ³γƒε±¥ζ­΄γγ‚γ‚γΎγ›γ‚“</p>
                </div>
            </div>
            </div>
            </div>
        </div>
    </div>
    <!-- End Points Section -->

    <!-- QR Code Modal - νμ΄μ§€μ— μ§μ ‘ ν‘μ‹ -->

    <!-- ν¬μΈνΈ μ΄λ ¥ ν…μ΄λΈ” μ¤νƒ€μΌ -->
    <style>
        /* ν¬μΈνΈ μ΄λ ¥ ν…μ΄λΈ” μ¤νƒ€μΌ κ°μ„  */
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .table thead th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            padding: 12px 8px;
        }
        
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .table tbody td {
            padding: 12px 8px;
            vertical-align: middle;
        }
        
        /* μ£Όλ¬Έ μ •λ³΄ μ¤νƒ€μΌ */
        .table tbody td small {
            font-size: 0.85rem;
            line-height: 1.4;
            display: block;
            margin-top: 4px;
        }
        
        .table tbody td .text-muted {
            color: #6c757d !important;
        }
        
        .table tbody td .text-info {
            color: #6c757d !important;
            font-weight: 500;
        }
        
        /* ν¬μΈνΈ ν‘μ‹ μ¤νƒ€μΌ - λ¨λ…Έν†¤ μƒ‰μƒ */
        .table tbody td .text-success {
            color: #212529 !important;
            font-weight: 600;
        }
        
        .table tbody td .text-danger {
            color: #495057 !important;
            font-weight: 600;
        }
        
        /* λ°μ‘ν• ν…μ΄λΈ” */
        @media (max-width: 768px) {
            .table thead th,
            .table tbody td {
                padding: 8px 4px;
                font-size: 0.9rem;
            }
            
            .table tbody td small {
                font-size: 0.8rem;
            }
        }
    </style>

    <!-- Start Script -->
    <script src="assets/js/jquery-1.11.0.min.js"></script>
    <script src="assets/js/jquery-migrate-1.2.1.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/templatemo.js"></script>
    
    <!-- QR Code Generator Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <!-- μ• ν”λ¦¬μΌ€μ΄μ… μ¤ν¬λ¦½νΈ -->
    <script src="assets/js/firebase-config-v3.js"></script>
    <script src="assets/js/auth-utils-v3.js"></script>
    <script src="assets/js/common-qr-code.js?v=2.1"></script>
    <script src="assets/js/custom.js"></script>
    
    <!-- ν¬μΈνΈ νμ΄μ§€ μ „μ© μ¤ν¬λ¦½νΈ -->
    <script>
        // ν¬μΈνΈ νμ΄μ§€ μ „μ© λ³€μλ“¤
        let pointsPageUser = null;
        let currentPoints = null; // Firebaseμ—μ„ λ΅λ“
        let pointHistory = [];
        let qrToken = null;
        let qrCodeGenerated = false;
        
        // Firebase μ „μ© QR ν† ν° κ΄€λ¦¬

        // QR μ½”λ“ κ΄€λ ¨ ν•¨μλ“¤μ€ λ¨λ‘ common-qr-code.jsμ—μ„ μ²λ¦¬


        // ν¬μΈνΈ ν‘μ‹ μ—…λ°μ΄νΈ ν•¨μ
        function updatePointsDisplay() {
            const pointsElement = document.getElementById('current-points');
            if (pointsElement) {
                pointsElement.textContent = currentPoints.toLocaleString();
                console.log('ν¬μΈνΈ ν‘μ‹ μ—…λ°μ΄νΈ μ™„λ£:', currentPoints);
            } else {
                console.error('ν¬μΈνΈ ν‘μ‹ μ”μ†λ¥Ό μ°Ύμ„ μ μ—†μµλ‹λ‹¤');
            }
        }

        // ν¬μΈνΈ μ •λ³΄ λ΅λ“
        async function loadPointInfo() {
            try {
                console.log('=== ν¬μΈνΈ μ •λ³΄ λ΅λ“ μ‹μ‘ ===');
            
            if (!pointsPageUser) {
                    console.log('β μ‚¬μ©μ μ •λ³΄κ°€ μ—†μ–΄ ν¬μΈνΈ μ •λ³΄λ¥Ό λ΅λ“ν•  μ μ—†μµλ‹λ‹¤');
                return;
            }

                console.log('ν¬μΈνΈ μ •λ³΄ λ΅λ“ - μ‚¬μ©μ:', pointsPageUser);
                console.log('Firebase μƒνƒ ν™•μΈ:', {
                    firebase: typeof firebase !== 'undefined',
                    firestore: typeof firebase !== 'undefined' && firebase.firestore,
                    apps: typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length
                });

                // Firebaseμ—μ„ ν¬μΈνΈ μ •λ³΄ κ°€μ Έμ¤κΈ°
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    const db = firebase.firestore();
                    
                    // λ¨Όμ € μ‚¬μ©μ IDλ΅ κ²€μƒ‰ (μΊμ‹ λ¬΄μ‹ν•κ³  μ„λ²„μ—μ„ μ§μ ‘ κ°€μ Έμ¤κΈ°)
                    let userDoc = await db.collection('users').doc(pointsPageUser.uid).get({ source: 'server' });
                    console.log('μ‚¬μ©μ IDλ΅ κ²€μƒ‰ κ²°κ³Ό (μ„λ²„μ—μ„):', userDoc.exists);
                    
                    if (!userDoc.exists) {
                        // μ‚¬μ©μ IDλ΅ μ°Ύμ§€ λ»ν• κ²½μ° μ΄λ©”μΌλ΅ κ²€μƒ‰
                        console.log('μ‚¬μ©μ IDλ΅ μ°Ύμ§€ λ»ν•¨, μ΄λ©”μΌλ΅ κ²€μƒ‰ μ‹λ„');
                        const emailQuery = await db.collection('users')
                            .where('email', '==', pointsPageUser.email)
                            .limit(1)
                            .get({ source: 'server' });
                        
                        if (!emailQuery.empty) {
                            userDoc = emailQuery.docs[0];
                            console.log('μ΄λ©”μΌλ΅ μ‚¬μ©μ μ°Ύμ:', userDoc.id);
                        }
                    }
                    
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        const newPoints = userData.points || 0;
                        
                        // ν¬μΈνΈκ°€ λ³€κ²½λμ—λ”μ§€ ν™•μΈ
                        if (currentPoints !== newPoints) {
                            console.log(`ν¬μΈνΈ λ³€κ²½ κ°μ§€: ${currentPoints} β†’ ${newPoints}`);
                            currentPoints = newPoints;
                            pointsPageUser.points = currentPoints; // μ‚¬μ©μ μ •λ³΄λ„ μ—…λ°μ΄νΈ
                            
                            // UI μ—…λ°μ΄νΈ
                            updatePointsDisplay();
                } else {
                            console.log('ν¬μΈνΈ λ³€κ²½ μ—†μ:', currentPoints);
                        }
                        
                        console.log('Firebaseμ—μ„ ν¬μΈνΈ μ •λ³΄ λ΅λ“ (μµμ‹ ):', currentPoints);
                        console.log('μ‚¬μ©μ λ°μ΄ν„°:', userData);
                        console.log('π” ν¬μΈνΈ νμ΄μ§€ ν¬μΈνΈ μƒμ„Έ λ¶„μ„:');
                        console.log('  - userData.points:', userData.points);
                        console.log('  - typeof userData.points:', typeof userData.points);
                        console.log('  - userData.points === undefined:', userData.points === undefined);
                        console.log('  - userData.points === null:', userData.points === null);
                        console.log('  - userData.points === 0:', userData.points === 0);
                        console.log('  - userData μ „μ²΄ ν‚¤:', Object.keys(userData));
                        } else {
                        console.log('μ‚¬μ©μ λ¬Έμ„κ°€ μ΅΄μ¬ν•μ§€ μ•μµλ‹λ‹¤, μƒλ΅ μƒμ„±');
                        // μ‚¬μ©μ λ¬Έμ„κ°€ μ—†μΌλ©΄ μƒλ΅ μƒμ„±
                        await db.collection('users').doc(pointsPageUser.uid).set({
                            name: pointsPageUser.name,
                            email: pointsPageUser.email,
                            points: 0,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        // currentPointsλ” Firebaseμ—μ„ λ΅λ“λ κ°’ μ‚¬μ©
                        }
                } else {
                    console.log('Firebaseκ°€ μ‚¬μ© λ¶κ°€λ¥ν•©λ‹λ‹¤');
                    // currentPointsλ” Firebaseμ—μ„ λ΅λ“λ κ°’ μ‚¬μ©
                }

                // ν¬μΈνΈ ν‘μ‹ μ—…λ°μ΄νΈ (currentPointsκ°€ nullμ΄ μ•„λ‹ λ•λ§)
                if (currentPoints !== null) {
                    const pointsElement = document.getElementById('current-points');
                    if (pointsElement) {
                        pointsElement.textContent = currentPoints.toLocaleString();
                        console.log('ν¬μΈνΈ ν‘μ‹ μ—…λ°μ΄νΈ μ™„λ£:', currentPoints);
                    } else {
                        console.error('ν¬μΈνΈ ν‘μ‹ μ”μ†λ¥Ό μ°Ύμ„ μ μ—†μµλ‹λ‹¤');
                    }
                }
                        
                        // ν¬μΈνΈ μ΄λ ¥ λ΅λ“κ°€ μ™„λ£λλ©΄ μλ™μΌλ΅ ν¬μΈνΈκ°€ κ³„μ‚°λκ³  μ—…λ°μ΄νΈλ©λ‹λ‹¤

            } catch (error) {
                console.error('ν¬μΈνΈ μ •λ³΄ λ΅λ“ μ¤λ¥:', error);
                // currentPointsλ” Firebaseμ—μ„ λ΅λ“λ κ°’ μ‚¬μ©
                const pointsElement = document.getElementById('current-points');
                if (pointsElement) {
                    pointsElement.textContent = '-';
                }
            }
        }

        // ν¬μΈνΈ μ΄λ ¥ λ΅λ“
        async function loadPointHistory() {
            try {
                console.log('=== ν¬μΈνΈ μ΄λ ¥ λ΅λ“ μ‹μ‘ ===');
                
                if (!pointsPageUser) {
                    console.log('β μ‚¬μ©μ μ •λ³΄κ°€ μ—†μ–΄ ν¬μΈνΈ μ΄λ ¥μ„ λ΅λ“ν•  μ μ—†μµλ‹λ‹¤');
                    return;
                }
                
                console.log('ν¬μΈνΈ μ΄λ ¥ κ²€μƒ‰ λ€μƒ:', {
                    uid: pointsPageUser.uid,
                    email: pointsPageUser.email
                });
                
                console.log('Firebase μƒνƒ ν™•μΈ:', {
                    firebase: typeof firebase !== 'undefined',
                    firestore: typeof firebase !== 'undefined' && firebase.firestore,
                    apps: typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length
                });
                
                // Firebaseμ—μ„ ν¬μΈνΈ μ΄λ ¥ κ°€μ Έμ¤κΈ°
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    const db = firebase.firestore();
                    
                    // μ‚¬μ©μλ³„ ν¬μΈνΈ μ΄λ ¥ κ²€μƒ‰
                    let historySnapshot = null;
                    let earnedPoints = 0;
                    let usedPoints = 0;
                    let filteredDocs = [];
                    
                    try {
                        // μΈλ±μ¤ μ—†μ΄λ„ μ‘λ™ν•λ„λ΅ λ‹¨μ μΏΌλ¦¬ μ‚¬μ© (μ„λ²„μ—μ„ μ§μ ‘ κ°€μ Έμ¤κΈ°)
                        console.log('λ‹¨μ μΏΌλ¦¬λ΅ ν¬μΈνΈ μ΄λ ¥ κ²€μƒ‰ μ‹μ‘ (μ„λ²„μ—μ„)');
                        // μΊμ‹ λ¬΄ν¨ν™”λ¥Ό μ„ν•΄ κ°•μ λ΅ μ„λ²„μ—μ„ κ°€μ Έμ¤κΈ°
                        historySnapshot = await db.collection('pointHistory').get({ 
                            source: 'server',
                            cache: false 
                        });
                        console.log('μ „μ²΄ ν¬μΈνΈ μ΄λ ¥ λ¬Έμ„ μ:', historySnapshot.size, 'κ±΄');
                        
                        historySnapshot.forEach(doc => {
                            const data = doc.data();
                            console.log('μ΄λ ¥ λ¬Έμ„ ν™•μΈ:', {
                                docId: doc.id,
                                userId: data.userId,
                                userEmail: data.userEmail,
                                type: data.type,
                                points: data.points,
                                reason: data.reason,
                                currentUserUid: pointsPageUser.uid,
                                currentUserEmail: pointsPageUser.email
                            });
                            
                            if (data.userId === pointsPageUser.uid || 
                                data.userEmail === pointsPageUser.email ||
                                data.userId === pointsPageUser.email) {
                                filteredDocs.push({ id: doc.id, ...data });
                                
                                // ν¬μΈνΈ κ³„μ‚°
                                if (data.type === 'earn' || data.type === 'admin_add' || data.type === 'welcome_bonus') {
                                    earnedPoints += data.points || 0;
                                    console.log('μ λ¦½ ν¬μΈνΈ μ¶”κ°€:', data.points, 'μ΄ μ λ¦½:', earnedPoints);
                                } else if (data.type === 'use' || data.type === 'admin_subtract') {
                                    usedPoints += data.points || 0;
                                    console.log('μ‚¬μ© ν¬μΈνΈ μ¶”κ°€:', data.points, 'μ΄ μ‚¬μ©:', usedPoints);
                                }
                            }
                        });
                        
                        // μ‹κ°„μ μ •λ ¬ (μµμ‹ μ)
                        filteredDocs.sort((a, b) => {
                            const timeA = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                            const timeB = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                            return timeB - timeA;
                        });
                        
                        // μµλ€ 10κ°λ§ μ„ νƒ
                        const limitedDocs = filteredDocs.slice(0, 10);
                        console.log('ν•„ν„°λ§λ ν¬μΈνΈ μ΄λ ¥:', limitedDocs.length, 'κ±΄');
                        
                        // Firestore μ¤λƒ…μƒ· ν•νƒλ΅ λ³€ν™
                        historySnapshot = {
                            empty: limitedDocs.length === 0,
                            size: limitedDocs.length,
                            forEach: (callback) => {
                                limitedDocs.forEach((doc, index) => {
                                    callback({
                                        id: doc.id,
                                        data: () => doc
                                    });
                                });
                            }
                        };
                        
                    } catch (queryError) {
                        console.warn('ν¬μΈνΈ μ΄λ ¥ μΏΌλ¦¬ μ‹¤ν¨:', queryError);
                        historySnapshot = null;
                    }
                    
                    // pointHistory λ°°μ—΄μ„ filteredDocsλ΅ μ„¤μ •
                    pointHistory = filteredDocs;
                    console.log('ν¬μΈνΈ μ΄λ ¥ λ°°μ—΄ μ„¤μ • μ™„λ£:', pointHistory.length, 'κ±΄');
                    
                    // ν¬μΈνΈ κ³„μ‚° λ° μ—…λ°μ΄νΈ
                    if (pointHistory.length > 0) {
                        pointHistory.forEach(item => {
                            console.log('β… μ‚¬μ©μ μ΄λ ¥ ν™•μΈ:', item.type, item.points, item.reason);
                        });
                        
                        // ν¬μΈνΈ κ³„μ‚° λ° μ—…λ°μ΄νΈ
                        const calculatedPoints = earnedPoints - usedPoints;
                        console.log('ν¬μΈνΈ μ΄λ ¥ κΈ°λ° κ³„μ‚°:', {
                            earnedPoints,
                            usedPoints,
                            calculatedPoints,
                            currentDisplayPoints: pointsPageUser.points
                        });
                        
                        // κ³„μ‚°λ ν¬μΈνΈκ°€ λ‹¤λ¥΄λ©΄ μ—…λ°μ΄νΈ (λ‹¨, 0λ³΄λ‹¤ μ‘μΌλ©΄ μ•λ¨)
                        if (calculatedPoints !== pointsPageUser.points && calculatedPoints >= 0) {
                            console.log('ν¬μΈνΈ λ¶μΌμΉ κ°μ§€, μ—…λ°μ΄νΈ μ¤‘...');
                            pointsPageUser.points = calculatedPoints;
                            currentPoints = calculatedPoints;
                            
                            // ν¬μΈνΈ ν‘μ‹ μ—…λ°μ΄νΈ
                            const pointsElement = document.getElementById('current-points');
                            if (pointsElement) {
                                pointsElement.textContent = calculatedPoints.toLocaleString();
                                console.log('β… ν¬μΈνΈ ν‘μ‹ μ—…λ°μ΄νΈ μ™„λ£:', calculatedPoints);
                            }
                            
                            // Firebaseμ— ν¬μΈνΈ μ—…λ°μ΄νΈ (μ΄λ©”μΌμ„ λ¬Έμ„ IDλ΅ μ‚¬μ©)
                            if (typeof firebase !== 'undefined' && firebase.firestore) {
                                const db = firebase.firestore();
                                db.collection('users').doc(pointsPageUser.email).update({
                                    points: calculatedPoints
                                }).then(() => {
                                    console.log('β… Firebase ν¬μΈνΈ μ—…λ°μ΄νΈ μ™„λ£:', calculatedPoints);
                                }).catch(error => {
                                    console.error('Firebase ν¬μΈνΈ μ—…λ°μ΄νΈ μ‹¤ν¨:', error);
                                });
                            }
                        } else if (calculatedPoints < 0) {
                            console.log('β οΈ κ³„μ‚°λ ν¬μΈνΈκ°€ μμμ…λ‹λ‹¤. μ›λ³Έ ν¬μΈνΈ μ μ§€:', pointsPageUser.points);
                        }
                        
                        // pointHistory λ°°μ—΄μ„ μ „μ—­ λ³€μμ— μ €μ¥ (μ •λ ¬μ€ ν‘μ‹ν•  λ• μν–‰)
                        window.pointHistory = pointHistory;
                        console.log('β… pointHistory μ „μ—­ μ €μ¥ μ™„λ£:', pointHistory.length, 'κ±΄');
                    }

                    console.log('Firebaseμ—μ„ ν¬μΈνΈ μ΄λ ¥ λ΅λ“ μ™„λ£:', pointHistory.length, 'κ±΄');
                } else {
                    console.log('Firebaseκ°€ μ‚¬μ© λ¶κ°€λ¥ν•©λ‹λ‹¤');
                    pointHistory = [];
                }

                // μ΄λ ¥ ν‘μ‹ μ—…λ°μ΄νΈ
                updatePointHistoryDisplay();
                
            } catch (error) {
                console.error('ν¬μΈνΈ μ΄λ ¥ λ΅λ“ μ¤λ¥:', error);
                pointHistory = [];
                updatePointHistoryDisplay();
            }
        }

        // νμ΄μ§€ ν¬μ»¤μ¤ μ‹ λ°μ΄ν„° μƒλ΅κ³ μΉ¨ μ„¤μ •
        function setupPageRefresh() {
            console.log('π”„ νμ΄μ§€ ν¬μ»¤μ¤ μƒλ΅κ³ μΉ¨ μ„¤μ •');
            
            // νμ΄μ§€ ν¬μ»¤μ¤ μ‹ ν¬μΈνΈ λ°μ΄ν„° μƒλ΅κ³ μΉ¨
            window.addEventListener('focus', async () => {
                console.log('π“± νμ΄μ§€ ν¬μ»¤μ¤ κ°μ§€ - ν¬μΈνΈ λ°μ΄ν„° μƒλ΅κ³ μΉ¨');
                try {
                    await loadPointInfo();
                    await loadPointHistory();
                } catch (error) {
                    console.error('ν¬μ»¤μ¤ μƒλ΅κ³ μΉ¨ μ¤λ¥:', error);
                }
            });
            
            // νμ΄μ§€ κ°€μ‹μ„± λ³€κ²½ μ‹ μƒλ΅κ³ μΉ¨
            document.addEventListener('visibilitychange', async () => {
                if (!document.hidden) {
                    console.log('π‘οΈ νμ΄μ§€ κ°€μ‹μ„± λ³€κ²½ - ν¬μΈνΈ λ°μ΄ν„° μƒλ΅κ³ μΉ¨');
                    try {
                        await loadPointInfo();
                        await loadPointHistory();
                    } catch (error) {
                        console.error('κ°€μ‹μ„± μƒλ΅κ³ μΉ¨ μ¤λ¥:', error);
                    }
                }
            });
        }

        // ν¬μΈνΈ μ΄λ ¥ ν‘μ‹ μ—…λ°μ΄νΈ
        function updatePointHistoryDisplay() {
            const container = document.getElementById('point-history-container');
            
            console.log('ν¬μΈνΈ μ΄λ ¥ ν‘μ‹ μ—…λ°μ΄νΈ μ‹μ‘:', pointHistory.length, 'κ±΄');
            
            if (pointHistory.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p class="japanese-text">γƒγ‚¤γƒ³γƒε±¥ζ­΄γγ‚γ‚γΎγ›γ‚“</p>
                        <small class="text-muted japanese-text">ε•†ε“θ³Όε…¥ζ™‚γ«γƒγ‚¤γƒ³γƒε±¥ζ­΄γθ΅¨η¤Ίγ•γ‚γΎγ™</small>
                            </div>
                `;
                return;
            }

            // ν¬μΈνΈ μ΄λ ¥μ„ μµμ‹  μμΌλ΅ μ •λ ¬ (μµμ‹ μ΄ λ§¨ μ„μ— μ¤λ„λ΅)
            const sortedHistory = [...pointHistory].sort((a, b) => {
                // κ°•λ ¥ν• νƒ€μ„μ¤νƒ¬ν”„ μ²λ¦¬
                const getTimestamp = (item, index) => {
                    // 1. timestamp ν•„λ“ ν™•μΈ
                    if (item && item.timestamp) {
                        try {
                            // Firestore Timestamp κ°μ²΄μΈ κ²½μ°
                            if (item.timestamp.toDate && typeof item.timestamp.toDate === 'function') {
                                const date = item.timestamp.toDate();
                                console.log(`ν•­λ© ${index + 1} - Firestore Timestamp:`, date);
                                return date.getTime();
                            }
                            
                            // Date κ°μ²΄μΈ κ²½μ°
                            if (item.timestamp instanceof Date) {
                                console.log(`ν•­λ© ${index + 1} - Date κ°μ²΄:`, item.timestamp);
                                return item.timestamp.getTime();
                            }
                            
                            // μ«μλ‚ λ¬Έμμ—΄μΈ κ²½μ°
                            const date = new Date(item.timestamp);
                            if (!isNaN(date.getTime())) {
                                console.log(`ν•­λ© ${index + 1} - λ¬Έμμ—΄/μ«μ:`, item.timestamp, 'β†’ Date:', date);
                                return date.getTime();
                            }
                        } catch (error) {
                            console.warn(`ν•­λ© ${index + 1} - νƒ€μ„μ¤νƒ¬ν”„ νμ‹± μ¤λ¥:`, error, item.timestamp);
                        }
                    }
                    
                    // 2. createdAt ν•„λ“ ν™•μΈ
                    if (item && item.createdAt) {
                        try {
                            if (item.createdAt.toDate && typeof item.createdAt.toDate === 'function') {
                                const date = item.createdAt.toDate();
                                console.log(`ν•­λ© ${index + 1} - createdAt Firestore:`, date);
                                return date.getTime();
                            }
                            if (item.createdAt instanceof Date) {
                                console.log(`ν•­λ© ${index + 1} - createdAt Date:`, item.createdAt);
                                return item.createdAt.getTime();
                            }
                            const date = new Date(item.createdAt);
                            if (!isNaN(date.getTime())) {
                                console.log(`ν•­λ© ${index + 1} - createdAt λ¬Έμμ—΄:`, item.createdAt, 'β†’ Date:', date);
                                return date.getTime();
                            }
                        } catch (error) {
                            console.warn(`ν•­λ© ${index + 1} - createdAt νμ‹± μ¤λ¥:`, error);
                        }
                    }
                    
                    // 3. orderDate ν•„λ“ ν™•μΈ
                    if (item && item.orderDate) {
                        try {
                            if (item.orderDate.toDate && typeof item.orderDate.toDate === 'function') {
                                const date = item.orderDate.toDate();
                                console.log(`ν•­λ© ${index + 1} - orderDate Firestore:`, date);
                                return date.getTime();
                            }
                            if (item.orderDate instanceof Date) {
                                console.log(`ν•­λ© ${index + 1} - orderDate Date:`, item.orderDate);
                                return item.orderDate.getTime();
                            }
                            const date = new Date(item.orderDate);
                            if (!isNaN(date.getTime())) {
                                console.log(`ν•­λ© ${index + 1} - orderDate λ¬Έμμ—΄:`, item.orderDate, 'β†’ Date:', date);
                                return date.getTime();
                            }
                        } catch (error) {
                            console.warn(`ν•­λ© ${index + 1} - orderDate νμ‹± μ¤λ¥:`, error);
                        }
                    }
                    
                    // 4. λ¬Έμ„ IDμ—μ„ μ‹κ°„ μ¶”μ¶ μ‹λ„ (λ¬Έμ„ IDκ°€ νƒ€μ„μ¤νƒ¬ν”„λ¥Ό ν¬ν•¨ν•λ” κ²½μ°)
                    if (item && item.id) {
                        const timestampMatch = item.id.match(/(\d{13})/); // 13μλ¦¬ νƒ€μ„μ¤νƒ¬ν”„
                        if (timestampMatch) {
                            const timestamp = parseInt(timestampMatch[1]);
                            const date = new Date(timestamp);
                            console.log(`ν•­λ© ${index + 1} - IDμ—μ„ νƒ€μ„μ¤νƒ¬ν”„ μ¶”μ¶:`, date);
                            return timestamp;
                        }
                    }
                    
                    // 5. λ¨λ“  λ°©λ²•μ΄ μ‹¤ν¨ν• κ²½μ° - λ°°μ—΄ μΈλ±μ¤λ¥Ό κΈ°λ°μΌλ΅ ν• κ°€μƒ μ‹κ°„ μƒμ„±
                    // (μµμ‹  ν•­λ©μ΄ λ°°μ—΄μ λμ— μλ‹¤κ³  κ°€μ •)
                    const virtualTime = Date.now() - (pointHistory.length - index) * 1000;
                    console.warn(`ν•­λ© ${index + 1} - νƒ€μ„μ¤νƒ¬ν”„ μ—†μ, κ°€μƒ μ‹κ°„ μ‚¬μ©:`, new Date(virtualTime));
                    return virtualTime;
                };
                
                const timeA = getTimestamp(a, pointHistory.indexOf(a));
                const timeB = getTimestamp(b, pointHistory.indexOf(b));
                
                // μµμ‹  μμΌλ΅ μ •λ ¬ (ν° κ°’μ΄ λ¨Όμ €)
                const diff = timeB - timeA;
                console.log('μ •λ ¬ λΉ„κµ:', {
                    a: { index: pointHistory.indexOf(a), time: timeA, date: new Date(timeA) },
                    b: { index: pointHistory.indexOf(b), time: timeB, date: new Date(timeB) },
                    diff: diff
                });
                
                return diff;
            });
            
            console.log('ν¬μΈνΈ μ΄λ ¥ μ •λ ¬ μ™„λ£ (μµμ‹  μ):', sortedHistory.length, 'κ±΄');
            console.log('μ •λ ¬λ λ¨λ“  ν•­λ©:', sortedHistory.map((item, index) => ({
                index: index + 1,
                timestamp: item.timestamp,
                type: item.type,
                reason: item.reason,
                points: item.points
            })));

            let historyHTML = '<div class="table-responsive"><table class="table table-hover">';
            historyHTML += '<thead><tr><th class="japanese-text">ζ—¥δ»</th><th class="japanese-text">ε†…ε®Ήγƒ»ζ³¨ζ–‡θ©³η΄°</th><th class="japanese-text">γƒγ‚¤γƒ³γƒ</th></tr></thead><tbody>';
            
            sortedHistory.forEach((item, index) => {
                console.log(`μ΄λ ¥ ${index + 1}:`, item);
                
                let date;
                try {
                    if (item.timestamp && item.timestamp.toDate) {
                        date = item.timestamp.toDate();
                    } else if (item.timestamp) {
                        date = new Date(item.timestamp);
                    } else {
                        date = new Date();
                    }
                } catch (dateError) {
                    console.warn('λ‚ μ§ νμ‹± μ¤λ¥:', dateError, item.timestamp);
                    date = new Date();
                }
                
                const dateStr = date.toLocaleDateString('ja-JP');
                
                // ν¬μΈνΈ ν‘μ‹ λ΅μ§ κ°μ„  (typeμ— λ”°λΌ ν‘μ‹)
                let pointsStr, pointsClass;
                if (item.type === 'use' || item.type === 'admin_subtract') {
                    // ν¬μΈνΈ μ‚¬μ©/μ°¨κ°μΈ κ²½μ° μμλ΅ ν‘μ‹
                    pointsStr = `-${item.points}`;
                    pointsClass = 'text-danger';
                } else if (item.type === 'earn' || item.type === 'admin_add') {
                    // ν¬μΈνΈ μ λ¦½μΈ κ²½μ° μ–‘μλ΅ ν‘μ‹
                    pointsStr = `+${item.points}`;
                    pointsClass = 'text-success';
                } else {
                    // κΈ°μ΅΄ λ΅μ§ (νΈν™μ„±)
                    pointsStr = item.points > 0 ? `+${item.points}` : item.points;
                    pointsClass = item.points > 0 ? 'text-success' : 'text-danger';
                }
                
                // μ΄λ ¥ λ‚΄μ© κ²°μ • (μ£Όλ¬Έ μ •λ³΄ ν¬ν•¨)
                let description = 'γƒγ‚¤γƒ³γƒε–εΌ•';
                let orderInfo = ''; // μ£Όλ¬Έ μ •λ³΄ μ¶”κ°€
                
                if (item.reason) {
                    // ν•κµ­μ–΄ reasonμ„ μΌλ³Έμ–΄λ΅ λ³€ν™
                    if (item.reason.includes('μ‹ κ· κ°€μ… μ›°μ»΄ λ³΄λ„μ¤') || item.reason.includes('μ‹ κ· κ°€μ…')) {
                        description = 'ζ–°θ¦η™»ι²γ‚¦γ‚§γƒ«γ‚«γƒ γƒγƒΌγƒγ‚Ή';
                    } else if (item.reason.includes('μ›°μ»΄ λ³΄λ„μ¤')) {
                        description = 'γ‚¦γ‚§γƒ«γ‚«γƒ γƒγƒΌγƒγ‚Ή';
                    } else if (item.reason.includes('ν¬μΈνΈ μ λ¦½')) {
                        description = 'γƒγ‚¤γƒ³γƒι‚„ε…ƒ';
                    } else if (item.reason.includes('ν¬μΈνΈ μ‚¬μ©')) {
                        description = 'γƒγ‚¤γƒ³γƒδ½Ώη”¨';
                    } else if (item.reason.includes('κ΄€λ¦¬μ')) {
                        description = 'η®΅η†θ€…ζ“δ½';
                    } else {
                        description = item.reason;
                    }
                } else if (item.type === 'earn') {
                    description = 'ε•†ε“θ³Όε…¥';
                } else if (item.type === 'use') {
                    description = 'ε•†ε“θ³Όε…¥ζ™‚δ½Ώη”¨';
                } else if (item.type === 'admin_add') {
                    description = 'η®΅η†θ€…δ»δΈ';
                } else if (item.type === 'admin_subtract') {
                    description = 'η®΅η†θ€…ε·®εΌ•';
                } else if (item.type === 'welcome_bonus') {
                    description = 'ζ–°θ¦η™»ι²γ‚¦γ‚§γƒ«γ‚«γƒ γƒγƒΌγƒγ‚Ή';
                } else if (item.description) {
                    description = item.description;
                }
                
                // κΈμ•΅ μ •λ³΄ μ κ±° (Β¥3,500 λ“±)
                if (description && description.includes('Β¥')) {
                    description = description.replace(/\s*Β¥[\d,]+/g, '');
                }
                
                // κ°„λ‹¨ν• μ„¤λ…λ§ ν‘μ‹ (μƒμ„Έ μ •λ³΄ μ κ±°)
                historyHTML += `
                    <tr>
                        <td class="japanese-text">${dateStr}</td>
                        <td class="japanese-text">${description}</td>
                        <td class="${pointsClass} japanese-text">${pointsStr}</td>
                    </tr>
                `;
            });
            
            historyHTML += '</tbody></table></div>';
            container.innerHTML = historyHTML;
            
            console.log('ν¬μΈνΈ μ΄λ ¥ ν‘μ‹ μ—…λ°μ΄νΈ μ™„λ£');
        }

        // Firebase Auth μƒνƒλ¥Ό κΈ°λ‹¤λ¦¬λ” ν•¨μ
        async function waitForFirebaseAuth() {
            return new Promise((resolve) => {
                if (typeof firebase === 'undefined' || !firebase.auth) {
                    console.log('Firebaseκ°€ μ•„μ§ λ΅λ“λμ§€ μ•μ, λ€κΈ° μ¤‘...');
                    const checkFirebase = setInterval(() => {
                        if (typeof firebase !== 'undefined' && firebase.auth) {
                            clearInterval(checkFirebase);
                            waitForAuthState();
                        }
                    }, 100);
                    return;
                }
                
                waitForAuthState();
                
                function waitForAuthState() {
                    // μ΄λ―Έ λ΅κ·ΈμΈλ μ‚¬μ©μκ°€ μλ”μ§€ ν™•μΈ
                    const currentUser = firebase.auth().currentUser;
                    if (currentUser) {
                        console.log('μ΄λ―Έ λ΅κ·ΈμΈλ μ‚¬μ©μ λ°κ²¬:', currentUser.email);
                        resolve(currentUser);
                        return;
                    }
                    
                    // Auth μƒνƒ λ³€ν™”λ¥Ό κΈ°λ‹¤λ¦Ό (μµλ€ 5μ΄)
                    let timeoutId = setTimeout(() => {
                        console.log('Firebase Auth μƒνƒ ν™•μΈ μ‹κ°„ μ΄κ³Ό');
                        resolve(null);
                    }, 5000);
                    
                    const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
                        clearTimeout(timeoutId);
                        unsubscribe();
                        if (user) {
                            console.log('Firebase Auth μƒνƒ ν™•μΈ μ™„λ£:', user.email);
                            resolve(user);
                        } else {
                            console.log('Firebase Authμ—μ„ μ‚¬μ©μλ¥Ό μ°Ύμ„ μ μ—†μ');
                            resolve(null);
                        }
                    });
                }
            });
        }

        // ν„μ¬ μ‚¬μ©μ μ •λ³΄ κ°€μ Έμ¤κΈ° (Firebase Auth μ „μ©)
        function getCurrentUser() {
            console.log('π” points.html getCurrentUser νΈμ¶');
            
            // Firebase μ‚¬μ©μλ§ ν™•μΈ
            try {
                if (typeof firebase !== 'undefined' && firebase.auth && firebase.apps && firebase.apps.length > 0) {
                    const firebaseUser = firebase.auth().currentUser;
                    console.log('π” points.html Firebase currentUser:', firebaseUser ? firebaseUser.email : 'null');
                    
                    if (firebaseUser) {
                        console.log('β… points.html Firebase μ‚¬μ©μ ν™•μΈλ¨:', firebaseUser.email);
                        return firebaseUser;
                    } else {
                        console.log('β points.html Firebase μ‚¬μ©μ μ—†μ (λ΅κ·Έμ•„μ›ƒ μƒνƒ)');
                    }
                } else {
                    console.log('β points.html Firebase μ΄κΈ°ν™”λμ§€ μ•μ');
                }
            } catch (error) {
                console.warn('points.html Firebase μ‚¬μ©μ ν™•μΈ μ¤‘ μ¤λ¥:', error);
            }
            
            console.log('β points.html λ΅κ·ΈμΈλ μ‚¬μ©μ μ—†μ');
            return null;
        }

        // λ΅κ·ΈμΈ μƒνƒ ν™•μΈ ν•¨μ (ν”„λ΅ν•„ νμ΄μ§€μ™€ λ™μΌ)
        function getLoginStatus() {
            try {
                // Firebase Authμ—μ„ ν„μ¬ μ‚¬μ©μ μ •λ³΄ κ°€μ Έμ¤κΈ°
                const user = firebase.auth().currentUser;
                if (user) {
                    return {
                        uid: user.uid,
                        email: user.email,
                        name: user.displayName || user.email.split('@')[0]
                    };
                }
                
                // Firebase μ‚¬μ©μκ°€ μ—†μΌλ©΄ null λ°ν™
                return null;
            } catch (error) {
                console.error('λ΅κ·ΈμΈ μƒνƒ ν™•μΈ μ¤‘ μ¤λ¥:', error);
                return null;
            }
        }

        // νμ΄μ§€ μ΄κΈ°ν™”
        async function initializePointsPage() {
            console.log('=== ν¬μΈνΈ νμ΄μ§€ μ΄κΈ°ν™” μ‹μ‘ ===');
            
            // ν„μ¬ μ‚¬μ©μ μ •λ³΄ κ°€μ Έμ¤κΈ°
            let userData = null;
            let userPoints = 0;
            
            try {
                // Firebase Auth μ‚¬μ©μ ν™•μΈ (λ” μ•μ „ν• λ°©μ‹)
                console.log('Firebase μƒνƒ ν™•μΈ:', {
                    firebase: typeof firebase !== 'undefined',
                    auth: typeof firebase !== 'undefined' && firebase.auth,
                    currentUser: typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser
                });
                
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    const user = firebase.auth().currentUser;
                    console.log('Firebase Auth currentUser:', user);
                    
                    if (user) {
                        console.log('Firebase Auth μ‚¬μ©μ λ°κ²¬:', user.email);
                        
                        // Firestoreμ—μ„ μ‚¬μ©μ μ •λ³΄ κ°€μ Έμ¤κΈ°
                        if (firebase.firestore) {
                    const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
                    
                    if (userDoc.exists) {
                        userData = {
                            name: userDoc.data().name || user.displayName || user.email.split('@')[0],
                            email: user.email,
                            uid: user.uid,
                            points: userDoc.data().points || 0
                        };
                        userPoints = userData.points;
                        console.log('Firebaseμ—μ„ μ‚¬μ©μ μ •λ³΄ λ΅λ“ μ„±κ³µ:', userData);
                            } else {
                                console.log('μ‚¬μ©μ λ¬Έμ„κ°€ μ΅΄μ¬ν•μ§€ μ•μ, κΈ°λ³Έ μ‚¬μ©μ λ°μ΄ν„° μƒμ„±');
                                // μ‚¬μ©μ λ¬Έμ„κ°€ μ—†μΌλ©΄ κΈ°λ³Έ μ‚¬μ©μ λ°μ΄ν„° μƒμ„±
                                userData = {
                                    name: user.displayName || user.email.split('@')[0],
                                    email: user.email,
                                    uid: user.uid,
                                    points: 0
                                };
                                userPoints = 0;
                                console.log('κΈ°λ³Έ μ‚¬μ©μ λ°μ΄ν„° μƒμ„±λ¨:', userData);
                                
                                // Firestoreμ— μ‚¬μ©μ λ¬Έμ„ μƒμ„± (μ„ νƒμ‚¬ν•­)
                                try {
                                    await firebase.firestore().collection('users').doc(user.uid).set({
                                        name: user.displayName || user.email.split('@')[0],
                                        email: user.email,
                                        points: 0,
                                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                    console.log('Firestoreμ— μ‚¬μ©μ λ¬Έμ„ μƒμ„± μ™„λ£');
                                } catch (docError) {
                                    console.warn('Firestore μ‚¬μ©μ λ¬Έμ„ μƒμ„± μ‹¤ν¨:', docError);
                                }
                            }
                        } else {
                            console.log('Firestoreκ°€ μ‚¬μ© λ¶κ°€λ¥, κΈ°λ³Έ μ‚¬μ©μ λ°μ΄ν„° μƒμ„±');
                            // Firestoreκ°€ μ‚¬μ© λ¶κ°€λ¥ν•΄λ„ Firebase Auth μ‚¬μ©μ μ •λ³΄λ΅ κΈ°λ³Έ λ°μ΄ν„° μƒμ„±
                            userData = {
                                name: user.displayName || user.email.split('@')[0],
                                email: user.email,
                                uid: user.uid,
                                points: 0
                            };
                            userPoints = 0;
                            console.log('Firestore λ¶κ°€λ¥ μ‹ κΈ°λ³Έ μ‚¬μ©μ λ°μ΄ν„° μƒμ„±λ¨:', userData);
                        }
                    } else {
                        console.log('Firebase Authμ—μ„ μ‚¬μ©μλ¥Ό μ°Ύμ„ μ μ—†μ');
                        // Firebase Auth μ‚¬μ©μκ°€ μ—†μΌλ©΄ userDataλ¥Ό nullλ΅ μ„¤μ •ν•μ—¬ λ΅κ·ΈμΈ νμ΄μ§€λ΅ λ¦¬λ‹¤μ΄λ ‰νΈ
                        userData = null;
                    }
                } else {
                    console.log('Firebase λλ” Authκ°€ μ‚¬μ© λ¶κ°€λ¥');
                    // Firebaseκ°€ μ‚¬μ© λ¶κ°€λ¥ν•λ©΄ userDataλ¥Ό nullλ΅ μ„¤μ •ν•μ—¬ λ΅κ·ΈμΈ νμ΄μ§€λ΅ λ¦¬λ‹¤μ΄λ ‰νΈ
                    userData = null;
                }
            } catch (firebaseError) {
                console.warn('Firebase μ‚¬μ©μ μ •λ³΄ λ΅λ“ μ‹¤ν¨:', firebaseError);
                // μ¤λ¥ λ°μƒ μ‹ userDataλ¥Ό nullλ΅ μ„¤μ •ν•μ—¬ λ΅κ·ΈμΈ νμ΄μ§€λ΅ λ¦¬λ‹¤μ΄λ ‰νΈ
                userData = null;
            }
            
            // Firebase Auth μ‚¬μ©μκ°€ μ—†μΌλ©΄ λ΅κ·ΈμΈ νμ΄μ§€λ΅ λ¦¬λ‹¤μ΄λ ‰νΈ
            if (!userData) {
                console.log('Firebase Auth μ‚¬μ©μκ°€ μ—†μ, λ΅κ·ΈμΈ νμ΄μ§€λ΅ μ΄λ™');
                window.location.href = 'login.html?redirect=points.html';
                return;
            }
            
            // 3. μ‚¬μ©μ μ •λ³΄ μ„¤μ •
            pointsPageUser = userData;
            currentPoints = userPoints;
            console.log('μµμΆ… μ‚¬μ©μ μ •λ³΄ μ„¤μ •:', pointsPageUser);
            console.log('ν„μ¬ ν¬μΈνΈ:', currentPoints);
                
            // ν¬μΈνΈ μ •λ³΄ λ° μ΄λ ¥ λ΅λ“
            await loadPointInfo();
            await loadPointHistory();
            
            // Firebase μ „μ© QR μ½”λ“ μ‹μ¤ν… - Firebase μ΄κΈ°ν™” μ™„λ£ ν›„ μλ™ μƒμ„±
            console.log('QR μ½”λ“λ” Firebase μ΄κΈ°ν™” μ™„λ£ ν›„ μλ™ μƒμ„±λ©λ‹λ‹¤');
            
            // QR μ½”λ“ μƒμ„± κ°•μ  μ‹¤ν–‰ (λ” κΈ΄ μ§€μ—° μ‹κ°„)
            setTimeout(() => {
                if (typeof window.unifiedQRCodeManager !== 'undefined' && window.unifiedQRCodeManager) {
                    console.log('QR μ½”λ“ λ§¤λ‹μ €κ°€ μ΅΄μ¬ν•¨, κ°•μ  QR μ½”λ“ μƒμ„± μ‹λ„');
                    window.unifiedQRCodeManager.autoGenerateQRCode();
                } else {
                    console.log('QR μ½”λ“ λ§¤λ‹μ €κ°€ μ•„μ§ μ΄κΈ°ν™”λμ§€ μ•μ');
                }
            }, 3000);

            // νμ΄μ§€ μƒλ΅κ³ μΉ¨ κΈ°λ¥ μ„¤μ •
            setupPageRefresh();

            console.log('ν¬μΈνΈ νμ΄μ§€ μ΄κΈ°ν™” μ™„λ£');
        }

        // λ„¤λΉ„κ²μ΄μ… λ°” μ‚¬μ©μ μƒνƒ μ—…λ°μ΄νΈ - μ κ±°λ¨, updateUserMenuDirectly μ‚¬μ©

        // λ΅κ·Έμ•„μ›ƒ ν•¨μ (μΉ΄νΈ μ •λ³΄ μ μ§€) - λ¨λ°”μΌ/μ›Ή νΈν™
        async function logout() {
            try {
                console.log('=== points.html λ΅κ·Έμ•„μ›ƒ μ‹μ‘ (μΉ΄νΈ μ •λ³΄ μ μ§€) - λ¨λ°”μΌ/μ›Ή νΈν™ ===');
                
                // Firebase Auth μƒνƒ λ³€κ²½ λ¦¬μ¤λ„ μΌμ‹ μ¤‘λ‹¨ (λ¨λ°”μΌμ—μ„ μ¤‘μ”)
                if (window.pointsAuthStateUnsubscribe) {
                    window.pointsAuthStateUnsubscribe();
                    window.pointsAuthStateUnsubscribe = null;
                    console.log('β… Firebase Auth μƒνƒ λ³€κ²½ λ¦¬μ¤λ„ μ¤‘λ‹¨');
                }
                
                // Firebase λ΅κ·Έμ•„μ›ƒ
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    await firebase.auth().signOut();
                    console.log('β… Firebase λ΅κ·Έμ•„μ›ƒ μ™„λ£');
                }
                
                // pointsPageUser μ΄κΈ°ν™” (μΉ΄νΈ μ •λ³΄λ” μ μ§€)
                pointsPageUser = null;
                console.log('β… pointsPageUser μ΄κΈ°ν™” μ™„λ£');
                
                // λ΅κ·ΈμΈ κ΄€λ ¨ localStorage μ™„μ „ μ •λ¦¬ (λ¨λ°”μΌ νΈν™)
                const loginKeys = [
                    'aetherLoginStatus', 'aetherLogin', 'aetherUser', 'aetherUserInfo',
                    'aetherAuthToken', 'aetherSession', 'aetherRemember'
                ];
                
                loginKeys.forEach(key => {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key);
                });
                
                // λ¨λ“  aether κ΄€λ ¨ ν‚¤ μ¤‘ λ΅κ·ΈμΈ κ΄€λ ¨λ§ μ κ±° (μΉ΄νΈλ” μ μ§€)
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('aether') && 
                        (key.includes('Login') || key.includes('Auth') || key.includes('User') || key.includes('Session'))) {
                        localStorage.removeItem(key);
                    }
                });
                
                Object.keys(sessionStorage).forEach(key => {
                    if (key.startsWith('aether') && 
                        (key.includes('Login') || key.includes('Auth') || key.includes('User') || key.includes('Session'))) {
                        sessionStorage.removeItem(key);
                    }
                });
                
                console.log('β… λ΅κ·ΈμΈ κ΄€λ ¨ localStorage/sessionStorage μ™„μ „ μ •λ¦¬ μ™„λ£');
                
                // λ¨λ°”μΌ λΈλΌμ°μ € μΊμ‹ μ •λ¦¬ (κ°€λ¥ν• κ²½μ°)
                if ('caches' in window) {
                    try {
                        const cacheNames = await caches.keys();
                        for (const cacheName of cacheNames) {
                            if (cacheName.includes('aether') || cacheName.includes('auth')) {
                                await caches.delete(cacheName);
                                console.log(`β… μΊμ‹ μ‚­μ : ${cacheName}`);
                            }
                        }
                    } catch (cacheError) {
                        console.log('β οΈ μΊμ‹ μ •λ¦¬ μ¤‘ μ¤λ¥ (λ¬΄μ‹ κ°€λ¥):', cacheError);
                    }
                }
                
                // μ‚¬μ©μ λ©”λ‰΄ μ§μ ‘ μ—…λ°μ΄νΈ (auth-utils.js νΈμ¶ λ°©μ§€)
                updateUserMenuDirectly();
                console.log('β… μ‚¬μ©μ λ©”λ‰΄ μ§μ ‘ μ—…λ°μ΄νΈ μ™„λ£');
                
                // μΉ΄νΈ κ°μ μ—…λ°μ΄νΈ (λ΅κ·Έμ•„μ›ƒ μƒνƒμ΄λ―€λ΅ 0μΌλ΅ ν‘μ‹)
                updateCartCount();
                console.log('β… μΉ΄νΈ κ°μ μ—…λ°μ΄νΈ μ™„λ£');
                
                // ν† μ¤νΈ λ©”μ‹μ§€ ν‘μ‹
                if (typeof window.showToast === 'function') {
                    window.showToast('γƒ­γ‚°γ‚Άγ‚¦γƒγ—γΎγ—γγ€‚', 'success', 2000);
                } else {
                    alert('γƒ­γ‚°γ‚Άγ‚¦γƒγ—γΎγ—γγ€‚');
                }
                
                console.log('β… points.html λ΅κ·Έμ•„μ›ƒ μ„±κ³µ (μΉ΄νΈ μ •λ³΄ μ μ§€) - λ¨λ°”μΌ/μ›Ή νΈν™');
                
                // κ°•μ  νμ΄μ§€ μƒλ΅κ³ μΉ¨κ³Ό ν•¨κ» ν™νμ΄μ§€λ΅ λ¦¬λ‹¤μ΄λ ‰νΈ (λ¨λ°”μΌμ—μ„ ν™•μ‹¤ν• λ΅κ·Έμ•„μ›ƒ)
                setTimeout(() => {
                    // λ¨λ°”μΌμ—μ„ ν™•μ‹¤ν• λ΅κ·Έμ•„μ›ƒμ„ μ„ν•΄ κ°•μ  μƒλ΅κ³ μΉ¨
                    window.location.replace('index.html');
                }, 1000);
                
            } catch (error) {
                console.error('β points.html λ΅κ·Έμ•„μ›ƒ μ¤‘ μ¤λ¥:', error);
                
                // μ¤λ¥κ°€ λ°μƒν•΄λ„ κΈ°λ³Έ μ •λ¦¬ μ‘μ—… μν–‰
                pointsPageUser = null;
                
                // Firebase Auth μƒνƒ λ³€κ²½ λ¦¬μ¤λ„ μ¤‘λ‹¨
                if (window.pointsAuthStateUnsubscribe) {
                    window.pointsAuthStateUnsubscribe();
                    window.pointsAuthStateUnsubscribe = null;
                }
                
                // λ΅κ·ΈμΈ κ΄€λ ¨ localStorage μ •λ¦¬
                const loginKeys = [
                    'aetherLoginStatus', 'aetherLogin', 'aetherUser', 'aetherUserInfo',
                    'aetherAuthToken', 'aetherSession', 'aetherRemember'
                ];
                
                loginKeys.forEach(key => {
                    localStorage.removeItem(key);
                    sessionStorage.removeItem(key);
                });
                
                // μ‚¬μ©μ λ©”λ‰΄ μ§μ ‘ μ—…λ°μ΄νΈ
                updateUserMenuDirectly();
                
                updateCartCount();
                
                if (typeof window.showToast === 'function') {
                    window.showToast('γƒ­γ‚°γ‚Άγ‚¦γƒγ—γΎγ—γγ€‚', 'success', 2000);
                } else {
                    alert('γƒ­γ‚°γ‚Άγ‚¦γƒγ—γΎγ—γγ€‚');
                }
                
                // κ°•μ  νμ΄μ§€ μƒλ΅κ³ μΉ¨κ³Ό ν•¨κ» ν™νμ΄μ§€λ΅ λ¦¬λ‹¤μ΄λ ‰νΈ
                setTimeout(() => {
                    window.location.replace('index.html');
                }, 1000);
            }
        }
        
        // μ‚¬μ©μ λ©”λ‰΄ μ§μ ‘ μ—…λ°μ΄νΈ ν•¨μ (auth-utils.js νΈμ¶ λ°©μ§€) - λ¨λ°”μΌ/μ›Ή νΈν™
        function updateUserMenuDirectly() {
            try {
                console.log('π”§ points.html μ‚¬μ©μ λ©”λ‰΄ μ§μ ‘ μ—…λ°μ΄νΈ μ‹μ‘ - λ¨λ°”μΌ/μ›Ή νΈν™');
                
                // ν„μ¬ λ΅κ·ΈμΈ μƒνƒ ν™•μΈ
                const currentUser = getCurrentUser();
                const isLoggedIn = currentUser !== null;
                
                console.log('π” ν„μ¬ λ΅κ·ΈμΈ μƒνƒ:', isLoggedIn ? 'λ΅κ·ΈμΈλ¨' : 'λ΅κ·Έμ•„μ›ƒλ¨');
                
                // λ©”λ‰΄ μ”μ†λ“¤ μ •μ
                const logoutMenus = ['logout-menu', 'logout-menu-item', 'logout-menu-mobile', 'logout-menu-item-mobile'];
                const profileMenus = ['profile-menu', 'profile-menu-mobile', 'points-menu', 'points-menu-mobile'];
                const loginMenus = ['login-menu', 'login-menu-mobile', 'register-menu', 'register-menu-mobile'];
                
                if (isLoggedIn) {
                    // λ΅κ·ΈμΈ μƒνƒ: λ΅κ·ΈμΈ λ©”λ‰΄ μ¨κΈ°κΈ°, λ΅κ·Έμ•„μ›ƒ/ν”„λ΅ν•„ λ©”λ‰΄ ν‘μ‹
                    console.log('π”§ λ΅κ·ΈμΈ μƒνƒ - λ©”λ‰΄ μ—…λ°μ΄νΈ');
                    
                    // λ΅κ·ΈμΈ λ©”λ‰΄ μ¨κΈ°κΈ°
                    loginMenus.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'none';
                            console.log(`β… ${id} μ¨κΈ°κΈ° μ™„λ£`);
                        }
                    });
                    
                    // λ΅κ·Έμ•„μ›ƒ λ©”λ‰΄ ν‘μ‹
                    logoutMenus.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'block';
                            console.log(`β… ${id} ν‘μ‹ μ™„λ£`);
                        }
                    });
                    
                    // ν”„λ΅ν•„ λ©”λ‰΄ ν‘μ‹
                    profileMenus.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'block';
                            console.log(`β… ${id} ν‘μ‹ μ™„λ£`);
                        }
                    });
                    
                    // μ‚¬μ©μ μ΄λ¦„ ν‘μ‹
                    const userNameElement = document.getElementById('user-name');
                    if (userNameElement && currentUser.email) {
                        userNameElement.textContent = currentUser.displayName || currentUser.email.split('@')[0];
                        userNameElement.classList.remove('d-none');
                        console.log('β… μ‚¬μ©μ μ΄λ¦„ ν‘μ‹ μ™„λ£:', userNameElement.textContent);
                    }
                    
                } else {
                    // λ΅κ·Έμ•„μ›ƒ μƒνƒ: λ΅κ·Έμ•„μ›ƒ/ν”„λ΅ν•„ λ©”λ‰΄ μ¨κΈ°κΈ°, λ΅κ·ΈμΈ λ©”λ‰΄ ν‘μ‹
                    console.log('π”§ λ΅κ·Έμ•„μ›ƒ μƒνƒ - λ©”λ‰΄ μ—…λ°μ΄νΈ');
                    
                    // λ΅κ·Έμ•„μ›ƒ λ©”λ‰΄ μ¨κΈ°κΈ°
                    logoutMenus.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'none';
                            console.log(`β… ${id} μ¨κΈ°κΈ° μ™„λ£`);
                        }
                    });
                    
                    // ν”„λ΅ν•„ λ©”λ‰΄ μ¨κΈ°κΈ°
                    profileMenus.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'none';
                            console.log(`β… ${id} μ¨κΈ°κΈ° μ™„λ£`);
                        }
                    });
                    
                    // λ΅κ·ΈμΈ λ©”λ‰΄ ν‘μ‹
                    loginMenus.forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'block';
                            console.log(`β… ${id} ν‘μ‹ μ™„λ£`);
                        }
                    });
                    
                    // μ‚¬μ©μ μ΄λ¦„ μ”μ† μ΄κΈ°ν™”
                    const userNameElement = document.getElementById('user-name');
                    if (userNameElement) {
                        userNameElement.textContent = '';
                        userNameElement.classList.add('d-none');
                        console.log('β… μ‚¬μ©μ μ΄λ¦„ μ”μ† μ΄κΈ°ν™” μ™„λ£');
                    }
                }
                
                console.log('β… points.html μ‚¬μ©μ λ©”λ‰΄ μ§μ ‘ μ—…λ°μ΄νΈ μ™„λ£ - λ¨λ°”μΌ/μ›Ή νΈν™');
                
            } catch (error) {
                console.error('β points.html μ‚¬μ©μ λ©”λ‰΄ μ§μ ‘ μ—…λ°μ΄νΈ μ‹¤ν¨:', error);
            }
        }

        // νμ΄μ§€ ν¬μ»¤μ¤ μ‹ ν¬μΈνΈ μ •λ³΄ μƒλ΅κ³ μΉ¨
        function setupPageRefresh() {
            // νμ΄μ§€κ°€ ν¬μ»¤μ¤λ¥Ό λ°›μ„ λ•λ§λ‹¤ ν¬μΈνΈ μ •λ³΄ μƒλ΅κ³ μΉ¨
            window.addEventListener('focus', async () => {
                console.log('νμ΄μ§€ ν¬μ»¤μ¤ κ°μ§€ - ν¬μΈνΈ μ •λ³΄ μƒλ΅κ³ μΉ¨');
                if (pointsPageUser) {
                    await loadPointInfo();
                    await loadPointHistory();
                }
            });
            
            // νμ΄μ§€ κ°€μ‹μ„± λ³€κ²½ μ‹μ—λ„ μƒλ΅κ³ μΉ¨
            document.addEventListener('visibilitychange', async () => {
                if (!document.hidden && pointsPageUser) {
                    console.log('νμ΄μ§€ κ°€μ‹μ„± λ³€κ²½ κ°μ§€ - ν¬μΈνΈ μ •λ³΄ μƒλ΅κ³ μΉ¨');
                    await loadPointInfo();
                    await loadPointHistory();
                }
            });
        }

        // Firebase μ΄κΈ°ν™” μ™„λ£ ν›„ ν¬μΈνΈ μ΄λ ¥ λ° QR μ½”λ“ λ‹¤μ‹ λ΅λ“
        async function reloadPointHistoryAfterFirebase() {
            console.log('Firebase μ΄κΈ°ν™” μ™„λ£ ν›„ ν¬μΈνΈ μ΄λ ¥ λ° QR μ½”λ“ λ‹¤μ‹ λ΅λ“');
            if (pointsPageUser) {
                try {
                    // ν¬μΈνΈ μ΄λ ¥ λ‹¤μ‹ λ΅λ“
                    setTimeout(() => {
                        loadPointHistory();
                    }, 500);
                    
                    // QR μ½”λ“λ” common-qr-code.jsμ—μ„ μλ™μΌλ΅ μ²λ¦¬
                } catch (error) {
                    console.error('Firebase μ΄κΈ°ν™” ν›„ λ°μ΄ν„° λ΅λ“ μ‹¤ν¨:', error);
                }
            }
        }
        
                // QR μ½”λ“ μƒμ„±μ€ common-qr-code.jsμ—μ„ μλ™μΌλ΅ μ²λ¦¬

        // μΉ΄νΈ κ°μ μ—…λ°μ΄νΈ (Firebase μ „μ©)
        async function updateCartCount() {
            console.log('π”Ά points.html updateCartCount νΈμ¶');
            
            try {
                // ν„μ¬ λ΅κ·ΈμΈλ μ‚¬μ©μ ν™•μΈ
                const currentUser = getCurrentUser();
                if (!currentUser) {
                    console.log('π“ λ΅κ·ΈμΈλμ§€ μ•μ€ μ‚¬μ©μ - μΉ΄νΈ μλ‰ 0');
                    updateCartCountDisplay(0);
                    return;
                }
                
                // Firebaseμ—μ„ μΉ΄νΈ μλ‰ κ°€μ Έμ¤κΈ°
                if (typeof firebase !== 'undefined' && firebase.firestore && firebase.apps && firebase.apps.length > 0) {
                    const db = firebase.firestore();
                    const cartDoc = await db.collection('userCarts').doc(currentUser.email).get();
                    
                    if (cartDoc.exists) {
                        const cartData = cartDoc.data().cart || [];
                        const totalItems = cartData.reduce((total, item) => total + (item.quantity || 1), 0);
                        console.log('β… points.html Firebase μΉ΄νΈ μλ‰:', totalItems, 'κ°');
                        updateCartCountDisplay(totalItems);
                    } else {
                        console.log('π“ points.html Firebase μΉ΄νΈ μ—†μ - μλ‰ 0');
                        updateCartCountDisplay(0);
                    }
                } else {
                    console.log('π“ points.html Firebase μ‚¬μ© λ¶κ°€ - μλ‰ 0');
                    updateCartCountDisplay(0);
                }
            } catch (error) {
                console.warn('β οΈ points.html μΉ΄νΈ μλ‰ μ—…λ°μ΄νΈ μ‹¤ν¨:', error);
                updateCartCountDisplay(0);
            }
        }

        // μΉ΄νΈ μλ‰ ν‘μ‹ μ—…λ°μ΄νΈ
        function updateCartCountDisplay(count) {
            // λ°μ¤ν¬ν†±μ© μ¥λ°”κµ¬λ‹ μΉ΄μ΄νΈ μ—…λ°μ΄νΈ
            const cartCountElement = document.getElementById('cart-count');
            if (cartCountElement) {
                cartCountElement.textContent = count;
            }
            
            // λ¨λ°”μΌμ© μ¥λ°”κµ¬λ‹ μΉ΄μ΄νΈ μ—…λ°μ΄νΈ
            const cartCountMobileElement = document.getElementById('cart-count-mobile');
            if (cartCountMobileElement) {
                cartCountMobileElement.textContent = count;
            }
            
            console.log('β… points.html μΉ΄νΈ μλ‰ ν‘μ‹ μ—…λ°μ΄νΈ:', count, 'κ°');
        }

        // νμ΄μ§€ λ΅λ“ μ‹ μ΄κΈ°ν™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== points.html DOMContentLoaded μ‹μ‘ ===');
            
            // Firebase μ „μ© μ΄κΈ°ν™”
            console.log('π”„ Firebase μ „μ© ν¬μΈνΈ νμ΄μ§€ μ΄κΈ°ν™” μ‹μ‘');
            
            // κ°„λ‹¨ν•κ³  μ§μ ‘μ μΈ μ΄κΈ°ν™” λ°©μ‹
            const initializePointsPageSimple = async () => {
                console.log('ν¬μΈνΈ νμ΄μ§€ κ°„λ‹¨ μ΄κΈ°ν™” μ‹μ‘');
                
                // 1. κΈ°λ³Έ ν¬μΈνΈ νμ΄μ§€ ν‘μ‹
                const pointsElement = document.getElementById('current-points');
                if (pointsElement) {
                    pointsElement.textContent = '-';
                }
                
                const historyContainer = document.getElementById('point-history-container');
                if (historyContainer) {
                    historyContainer.innerHTML = '<p class="text-muted japanese-text">γƒγ‚¤γƒ³γƒε±¥ζ­΄γ‚’θ­γΏθΎΌγΏδΈ­...</p>';
                }
                
                // QR μ½”λ“ μ»¨ν…μ΄λ„λ” μ¤ν”Όλ„λ§ ν‘μ‹
                
                // 2. Firebase μ΄κΈ°ν™” λ€κΈ°
                let attempts = 0;
                while (attempts < 100) { // 10μ΄ λ€κΈ°
                    if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
                        console.log('β… Firebase μ¤€λΉ„ μ™„λ£');
                        break;
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (attempts >= 100) {
                    console.warn('Firebase μ΄κΈ°ν™” μ‹κ°„ μ΄κ³Ό');
                    return;
                }
                
                // 3. Firebase Auth μ™„μ „ λ΅λ“ λ€κΈ° ν›„ μ‚¬μ©μ μ •λ³΄ ν™•μΈ
                try {
                    // Firebase Authκ°€ μ™„μ „ν λ΅λ“λ  λ•κΉμ§€ λ€κΈ°
                    let user = null;
                    await new Promise((resolve) => {
                        window.pointsAuthStateUnsubscribe = firebase.auth().onAuthStateChanged((authUser) => {
                            // μ²« λ²μ§Έ νΈμ¶μ—μ„λ§ resolveν•κ³  κµ¬λ… ν•΄μ ν•μ§€ μ•μ (μ§€μ†μ μΈ μƒνƒ κ°μ§€λ¥Ό μ„ν•΄)
                            if (user === null) {
                            user = authUser;
                            resolve(authUser);
                            }
                            
                            // μ§€μ†μ μΈ μƒνƒ λ³€κ²½ κ°μ§€
                            console.log('points.html - Firebase μΈμ¦ μƒνƒ λ³€κ²½:', authUser ? authUser.email : 'λ΅κ·Έμ•„μ›ƒ');
                            
                            if (authUser) {
                                console.log('β… points.html - Firebase μΈμ¦ μƒνƒ λ³€κ²½: λ΅κ·ΈμΈλ¨', authUser.email);
                                
                                // μ‚¬μ©μ μ •λ³΄ μ„¤μ •
                                pointsPageUser = {
                                    uid: authUser.uid,
                                    email: authUser.email,
                                    name: authUser.displayName || authUser.email.split('@')[0],
                                    points: 0
                                };
                                
                                // μ‚¬μ©μ λ©”λ‰΄ μ§μ ‘ μ—…λ°μ΄νΈ (auth-utils.js νΈμ¶ λ°©μ§€)
                                updateUserMenuDirectly();
                                console.log('β… points.html - μ‚¬μ©μ λ©”λ‰΄ μ§μ ‘ μ—…λ°μ΄νΈ μ™„λ£');
                                
                                // μΉ΄νΈ μλ‰ μ—…λ°μ΄νΈ
                                setTimeout(() => {
                                    updateCartCount();
                                }, 500);
                            } else {
                                console.log('β points.html - Firebase μΈμ¦ μƒνƒ λ³€κ²½: λ΅κ·Έμ•„μ›ƒλ¨');
                                
                                // pointsPageUser μ΄κΈ°ν™”
                                pointsPageUser = null;
                                
                                // μ‚¬μ©μ λ©”λ‰΄ μ§μ ‘ μ—…λ°μ΄νΈ (auth-utils.js νΈμ¶ λ°©μ§€)
                                updateUserMenuDirectly();
                                console.log('β… points.html - λ΅κ·Έμ•„μ›ƒ ν›„ μ‚¬μ©μ λ©”λ‰΄ μ§μ ‘ μ—…λ°μ΄νΈ μ™„λ£');
                                
                                // μΉ΄νΈ μλ‰ μ—…λ°μ΄νΈ
                                setTimeout(() => {
                                    updateCartCount();
                                }, 500);
                            }
                        });
                    });
                    
                    // μ‚¬μ©μ μ •λ³΄ ν™•μΈ
                    console.log('Firebase Auth μ‚¬μ©μ:', user);
                    
                    // currentUserλ„ ν™•μΈ (λ°±μ—…)
                    if (!user) {
                        user = firebase.auth().currentUser;
                        console.log('currentUser λ°±μ—… ν™•μΈ:', user);
                    }
                    
                    if (user) {
                        console.log('β… λ΅κ·ΈμΈλ μ‚¬μ©μ ν™•μΈ:', user.email);
                        
                        // μ‚¬μ©μ μ •λ³΄λ” μ΄λ―Έ onAuthStateChangedμ—μ„ μ„¤μ •λ¨
                        // μΉ΄νΈ μλ‰ μ—…λ°μ΄νΈ
                        setTimeout(() => {
                            updateCartCount();
                        }, 1000);
                        
                        // λ°μ΄ν„° λ΅λ“ (λΉ„λ™κΈ° μ²λ¦¬)
                        loadPointInfo().then(() => {
                            console.log('ν¬μΈνΈ μ •λ³΄ λ΅λ“ μ™„λ£');
                            return loadPointHistory();
                        }).then(() => {
                            console.log('ν¬μΈνΈ μ΄λ ¥ λ΅λ“ μ™„λ£');
                            // QRμ½”λ“λ” common-qr-code.jsμ—μ„ μλ™μΌλ΅ μ²λ¦¬
                            console.log('νμ΄μ§€ λ΅λ“ μ™„λ£');
                            
                            // νμ΄μ§€ ν¬μ»¤μ¤ μ‹ λ°μ΄ν„° μƒλ΅κ³ μΉ¨ μ„¤μ •
                            setupPageRefresh();
                        }).catch(error => {
                            console.error('λ°μ΄ν„° λ΅λ“ μ¤λ¥:', error);
                            // μ¤λ¥κ°€ μμ–΄λ„ QRμ½”λ“λ” ν‘μ‹
                            console.log('λ°μ΄ν„° λ΅λ“ μ¤λ¥ λ¬΄μ‹ν•κ³  QRμ½”λ“ ν‘μ‹');
                            // common-qr-code.jsκ°€ μλ™μΌλ΅ μ²λ¦¬
                        });
                        
                        console.log('ν¬μΈνΈ νμ΄μ§€ μ΄κΈ°ν™” μ™„λ£');
                    } else {
                        console.log('β λ΅κ·ΈμΈλ μ‚¬μ©μκ°€ μ—†μ');
                        // Firebase μ „μ©
                    }
                } catch (error) {
                    console.error('ν¬μΈνΈ νμ΄μ§€ μ΄κΈ°ν™” μ¤λ¥:', error);
                }
            };
            
            // μ΄κΈ°ν™” μ‹¤ν–‰
            initializePointsPageSimple();
        });
        
        // QR μ½”λ“ λ²„νΌ μ΄λ²¤νΈ λ¦¬μ¤λ„λ” common-qr-code.jsμ—μ„ μλ™μΌλ΅ μ²λ¦¬
        
        // λ¨λ‹¬ κ΄€λ ¨ ν•¨μλ“¤μ€ common-qr-code.jsμ—μ„ μ²λ¦¬

        // QR μ½”λ“ κ΄€λ ¨ ν•¨μλ“¤μ€ common-qr-code.jsμ—μ„ μ²λ¦¬
        
        // ν…μ¤νΈ ν•¨μλ“¤ - common-qr-code.jsμ—μ„ μλ™ μ²λ¦¬
        
        // μ „μ—­ ν•¨μλ” common-qr-code.jsμ—μ„ μ²λ¦¬
    </script>
    
    <!-- End Script -->
</body>

</html>
 
 