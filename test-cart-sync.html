<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´íŠ¸ ë™ê¸°í™” í…ŒìŠ¤íŠ¸</title>
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <style>
        body { padding: 20px; }
        .log-container { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 5px; 
            max-height: 400px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 12px; 
        }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ›’ ì¹´íŠ¸ ë™ê¸°í™” í…ŒìŠ¤íŠ¸</h1>
        
        <div class="test-section">
            <h3>í˜„ì¬ ìƒíƒœ</h3>
            <p><strong>ì‚¬ìš©ì:</strong> <span id="current-user">í™•ì¸ ì¤‘...</span></p>
            <p><strong>Firebase ìƒíƒœ:</strong> <span id="firebase-status">í™•ì¸ ì¤‘...</span></p>
            <p><strong>í˜„ì¬ ì¹´íŠ¸:</strong> <span id="current-cart">í™•ì¸ ì¤‘...</span></p>
            <p><strong>ë™ê¸°í™” ê°€ëŠ¥:</strong> <span id="sync-available">í™•ì¸ ì¤‘...</span></p>
        </div>
        
        <div class="test-section">
            <h3>í…ŒìŠ¤íŠ¸ ì‘ì—…</h3>
            <button class="btn btn-primary" onclick="testAddToCart()">í…ŒìŠ¤íŠ¸ ìƒí’ˆ ì¶”ê°€</button>
            <button class="btn btn-secondary" onclick="testSyncCart()">ì¹´íŠ¸ ë™ê¸°í™”</button>
            <button class="btn btn-info" onclick="testLoadCart()">Firebaseì—ì„œ ì¹´íŠ¸ ë¡œë“œ</button>
            <button class="btn btn-warning" onclick="clearLocalCart()">ë¡œì»¬ ì¹´íŠ¸ ë¹„ìš°ê¸°</button>
            <button class="btn btn-success" onclick="checkAuthStatus()">ë¡œê·¸ì¸ ìƒíƒœ ê°•ì œ í™•ì¸</button>
            <button class="btn btn-warning" onclick="createUserCartDocument()">Firebase ë¬¸ì„œ ê°•ì œ ìƒì„±</button>
            <button class="btn btn-danger" onclick="deleteWrongDocuments()">ì˜ëª»ëœ ë¬¸ì„œ ì‚­ì œ</button>
        </div>
        
        <div class="test-section">
            <h3>ë¡œê·¸</h3>
            <div id="log-container" class="log-container"></div>
            <button class="btn btn-sm btn-outline-secondary" onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <!-- ì• í”Œë¦¬ì¼€ì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="assets/js/firebase-config.js"></script>
    <script src="assets/js/auth-utils.js"></script>
    
    <script>
        let testCounter = 1;
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('log-container');
            logContainer.innerHTML += `[${timestamp}] ${message}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('log-container').innerHTML = '';
        }
        
        function updateStatus() {
            log('ğŸ“Š ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘...');
            
            // í˜„ì¬ ì‚¬ìš©ì (ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ í™•ì¸)
            let user = firebase?.auth?.currentUser;
            
            // auth-utils.jsì˜ ì‚¬ìš©ì ì •ë³´ë„ í™•ì¸
            if (!user && typeof getCurrentUser === 'function') {
                const authUtilsUser = getCurrentUser();
                if (authUtilsUser) {
                    log('auth-utils.jsì—ì„œ ì‚¬ìš©ì ì •ë³´ ë°œê²¬: ' + authUtilsUser.email);
                    user = authUtilsUser;
                }
            }
            
            // ë””ë°”ì´ìŠ¤ ì •ë³´ ì¶”ê°€
            const deviceInfo = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
            };
            
            log('ğŸ“± ë””ë°”ì´ìŠ¤ ì •ë³´: ' + (deviceInfo.isMobile ? 'ëª¨ë°”ì¼' : 'ë°ìŠ¤í¬í†±'));
            
            const userElement = document.getElementById('current-user');
            log('ì‚¬ìš©ì í™•ì¸: ' + (user ? user.email : 'ì—†ìŒ'));
            
            if (user) {
                userElement.textContent = user.email;
                userElement.style.color = 'green';
                log('âœ… ë¡œê·¸ì¸ëœ ì‚¬ìš©ì í™•ì¸ë¨');
            } else {
                userElement.textContent = 'ë¡œê·¸ì¸ ì•ˆë¨';
                userElement.style.color = 'red';
                log('âŒ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì—†ìŒ');
            }
            
            // Firebase ìƒíƒœ
            const firebaseAvailable = window.FirebaseService?.isFirebaseAvailable();
            const firebaseElement = document.getElementById('firebase-status');
            log('Firebase ìƒíƒœ: ' + (firebaseAvailable ? 'ì‚¬ìš© ê°€ëŠ¥' : 'ì‚¬ìš© ë¶ˆê°€'));
            
            if (firebaseAvailable) {
                firebaseElement.textContent = 'ì‚¬ìš© ê°€ëŠ¥';
                firebaseElement.style.color = 'green';
            } else {
                firebaseElement.textContent = 'ì‚¬ìš© ë¶ˆê°€';
                firebaseElement.style.color = 'red';
            }
            
            // í˜„ì¬ ì¹´íŠ¸
            const cart = JSON.parse(localStorage.getItem('aetherCart') || '[]');
            document.getElementById('current-cart').textContent = `${cart.length}ê°œ ìƒí’ˆ`;
            log('í˜„ì¬ ì¹´íŠ¸: ' + cart.length + 'ê°œ ìƒí’ˆ');
            
            // ë™ê¸°í™” ê°€ëŠ¥ ì—¬ë¶€
            const syncElement = document.getElementById('sync-available');
            const canSync = user && firebaseAvailable && window.CartSyncService;
            log('ë™ê¸°í™” ê°€ëŠ¥ ì—¬ë¶€: ' + (canSync ? 'ê°€ëŠ¥' : 'ë¶ˆê°€ëŠ¥'));
            log('ì¡°ê±´ í™•ì¸: user=' + !!user + ', firebase=' + !!firebaseAvailable + ', service=' + !!window.CartSyncService);
            
            if (canSync) {
                syncElement.textContent = 'ê°€ëŠ¥ (ëª¨ë°”ì¼-ì›¹ ë™ê¸°í™”)';
                syncElement.style.color = 'green';
            } else {
                syncElement.textContent = 'ë¶ˆê°€ëŠ¥ (localStorageë§Œ ì‚¬ìš©)';
                syncElement.style.color = 'orange';
            }
        }
        
        function testAddToCart() {
            const testProduct = {
                id: `test-product-${testCounter++}`,
                name: `í…ŒìŠ¤íŠ¸ ìƒí’ˆ ${testCounter - 1}`,
                price: 1000 * testCounter,
                quantity: 1,
                addedAt: new Date().toISOString()
            };
            
            log(`ğŸ›’ í…ŒìŠ¤íŠ¸ ìƒí’ˆ ì¶”ê°€: ${testProduct.name}`);
            
            // localStorageì— ì¶”ê°€
            const cart = JSON.parse(localStorage.getItem('aetherCart') || '[]');
            cart.push(testProduct);
            localStorage.setItem('aetherCart', JSON.stringify(cart));
            
            // Firebaseì— ì €ì¥ (ë¡œê·¸ì¸ëœ ê²½ìš°ì—ë§Œ)
            let user = firebase?.auth?.currentUser;
            
            // auth-utils.jsì˜ ì‚¬ìš©ì ì •ë³´ë„ í™•ì¸
            if (!user && typeof getCurrentUser === 'function') {
                const authUtilsUser = getCurrentUser();
                if (authUtilsUser) {
                    user = authUtilsUser;
                    log('ğŸ” auth-utils.jsì—ì„œ ì‚¬ìš©ì ì •ë³´ ì‚¬ìš©: ' + user.email);
                }
            }
            
            if (user && window.CartSyncService) {
                log('ğŸ” ë¡œê·¸ì¸ëœ ì‚¬ìš©ì - Firebase ì €ì¥ ì‹œë„');
                window.CartSyncService.saveCartToFirebase(cart, user.email)
                    .then(() => log('âœ… Firebase ì €ì¥ ì™„ë£Œ'))
                    .catch(error => log('âŒ Firebase ì €ì¥ ì‹¤íŒ¨: ' + error.message));
            } else {
                log('âš ï¸ ë¡œê·¸ì¸ í•„ìš” - localStorageì—ë§Œ ì €ì¥ë¨');
                log('ğŸ’¡ ë¡œê·¸ì¸ í›„ í…ŒìŠ¤íŠ¸í•˜ë©´ ëª¨ë°”ì¼-ì›¹ ê°„ ë™ê¸°í™” ê°€ëŠ¥');
            }
            
            updateStatus();
        }
        
        function testSyncCart() {
            log('ğŸ”„ ì¹´íŠ¸ ë™ê¸°í™” í…ŒìŠ¤íŠ¸ ì‹œì‘');
            
            let user = firebase?.auth?.currentUser;
            
            // auth-utils.jsì˜ ì‚¬ìš©ì ì •ë³´ë„ í™•ì¸
            if (!user && typeof getCurrentUser === 'function') {
                const authUtilsUser = getCurrentUser();
                if (authUtilsUser) {
                    user = authUtilsUser;
                    log('ğŸ” auth-utils.jsì—ì„œ ì‚¬ìš©ì ì •ë³´ ì‚¬ìš©: ' + user.email);
                }
            }
            
            if (user && window.CartSyncService) {
                window.CartSyncService.syncCart(user.email)
                    .then(cart => {
                        log(`âœ… ì¹´íŠ¸ ë™ê¸°í™” ì™„ë£Œ: ${cart.length}ê°œ ìƒí’ˆ`);
                        log('ğŸ›’ ë™ê¸°í™”ëœ ì¹´íŠ¸: ' + JSON.stringify(cart, null, 2));
                    })
                    .catch(error => log('âŒ ì¹´íŠ¸ ë™ê¸°í™” ì‹¤íŒ¨: ' + error.message));
            } else {
                log('âš ï¸ ì‚¬ìš©ì ì—†ìŒ ë˜ëŠ” CartSyncService ì—†ìŒ');
            }
            
            updateStatus();
        }
        
        function testLoadCart() {
            log('ğŸ“¥ Firebaseì—ì„œ ì¹´íŠ¸ ë¡œë“œ í…ŒìŠ¤íŠ¸');
            
            let user = firebase?.auth?.currentUser;
            
            // auth-utils.jsì˜ ì‚¬ìš©ì ì •ë³´ë„ í™•ì¸
            if (!user && typeof getCurrentUser === 'function') {
                const authUtilsUser = getCurrentUser();
                if (authUtilsUser) {
                    user = authUtilsUser;
                    log('ğŸ” auth-utils.jsì—ì„œ ì‚¬ìš©ì ì •ë³´ ì‚¬ìš©: ' + user.email);
                }
            }
            
            if (user && window.CartSyncService) {
                window.CartSyncService.loadCartFromFirebase(user.email)
                    .then(cart => {
                        log(`âœ… Firebase ì¹´íŠ¸ ë¡œë“œ ì™„ë£Œ: ${cart.length}ê°œ ìƒí’ˆ`);
                        log('ğŸ›’ ë¡œë“œëœ ì¹´íŠ¸: ' + JSON.stringify(cart, null, 2));
                    })
                    .catch(error => log('âŒ Firebase ì¹´íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ' + error.message));
            } else {
                log('âš ï¸ ì‚¬ìš©ì ì—†ìŒ ë˜ëŠ” CartSyncService ì—†ìŒ');
            }
            
            updateStatus();
        }
        
        function clearLocalCart() {
            log('ğŸ—‘ï¸ ë¡œì»¬ ì¹´íŠ¸ ë¹„ìš°ê¸°');
            localStorage.removeItem('aetherCart');
            updateStatus();
        }
        
        function createUserCartDocument() {
            log('ğŸ”§ Firebase userCarts ë¬¸ì„œ ê°•ì œ ìƒì„± ì‹œì‘');
            
            let user = firebase?.auth?.currentUser;
            
            // auth-utils.jsì˜ ì‚¬ìš©ì ì •ë³´ë„ í™•ì¸
            if (!user && typeof getCurrentUser === 'function') {
                const authUtilsUser = getCurrentUser();
                if (authUtilsUser) {
                    user = authUtilsUser;
                    log('ğŸ” auth-utils.jsì—ì„œ ì‚¬ìš©ì ì •ë³´ ì‚¬ìš©: ' + user.email);
                }
            }
            
            if (!user) {
                log('âŒ ì‚¬ìš©ì ì •ë³´ ì—†ìŒ - ë¡œê·¸ì¸ í•„ìš”');
                return;
            }
            
            log('ğŸ“‹ ì‚¬ìš©ì ì •ë³´ í™•ì¸:');
            log('- UID: ' + user.uid);
            log('- Email: ' + user.email);
            log('- Display Name: ' + (user.displayName || 'ì—†ìŒ'));
            log('- UID ê¸¸ì´: ' + user.uid?.length);
            log('- UID íƒ€ì…: ' + typeof user.uid);
            log('ğŸ” Firebase Auth currentUserì™€ ë¹„êµ:');
            log('- firebase.auth.currentUser: ' + (firebase?.auth?.currentUser ? 'ì¡´ì¬' : 'ì—†ìŒ'));
            if (firebase?.auth?.currentUser) {
                log('- firebase.auth.currentUser.uid: ' + firebase.auth.currentUser.uid);
                log('- firebase.auth.currentUser.email: ' + firebase.auth.currentUser.email);
            }
            
            // ì§ì ‘ Firestoreì— ë¬¸ì„œ ìƒì„± (ì´ë©”ì¼ ì£¼ì†Œë¥¼ ë¬¸ì„œ IDë¡œ ì‚¬ìš©)
            const db = firebase.firestore();
            const userCartRef = db.collection('userCarts').doc(user.email);
            
            log('ğŸ›’ Firebase ë¬¸ì„œ ì§ì ‘ ìƒì„± ì‹œë„ (ì´ë©”ì¼: ' + user.email + ')');
            log('ğŸ” ë¬¸ì„œ ìƒì„± ì „ Firebase userCarts ì»¬ë ‰ì…˜ í™•ì¸');
            
            // ê¸°ì¡´ ë¬¸ì„œ í™•ì¸
            try {
                const existingDoc = await userCartRef.get();
                if (existingDoc.exists) {
                    log('âš ï¸ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë¬¸ì„œ ë°œê²¬, ë®ì–´ì“°ê¸° ì§„í–‰');
                    log('ê¸°ì¡´ ë¬¸ì„œ ë°ì´í„°: ' + JSON.stringify(existingDoc.data()));
                } else {
                    log('âœ… ìƒˆ ë¬¸ì„œ ìƒì„±');
                }
            } catch (checkError) {
                log('âŒ ê¸°ì¡´ ë¬¸ì„œ í™•ì¸ ì‹¤íŒ¨: ' + checkError.message);
            }
            
            userCartRef.set({
                cart: [],
                lastUpdated: new Date(),
                userEmail: user.email,
                deviceInfo: {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    createdBy: 'test-cart-sync'
                }
            })
            .then(() => {
                log('âœ… Firebase userCarts ë¬¸ì„œ ì§ì ‘ ìƒì„± ì™„ë£Œ');
                log('ğŸ“‹ ë¬¸ì„œ ID (ì‚¬ìš©ì ì´ë©”ì¼): ' + user.email);
                log('ğŸ“‹ ì‚¬ìš©ì UID: ' + user.uid);
                
                // ìƒì„± í›„ ë¬¸ì„œ í™•ì¸
                return userCartRef.get();
            })
            .then(doc => {
                if (doc.exists) {
                    log('âœ… ìƒì„±ëœ ë¬¸ì„œ í™•ì¸ ì„±ê³µ');
                    log('ğŸ“‹ ë¬¸ì„œ ë°ì´í„°: ' + JSON.stringify(doc.data()));
                    updateStatus();
                } else {
                    log('âŒ ìƒì„±ëœ ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ');
                }
            })
            .catch(error => {
                log('âŒ Firebase ë¬¸ì„œ ì§ì ‘ ìƒì„± ì‹¤íŒ¨: ' + error.message);
                log('âŒ ìƒì„¸ ì˜¤ë¥˜: ' + JSON.stringify(error));
            });
        }
        
        function deleteWrongDocuments() {
            log('ğŸ—‘ï¸ ì˜ëª»ëœ Firebase ë¬¸ì„œ ì‚­ì œ ì‹œì‘');
            
            if (!firebase?.firestore) {
                log('âŒ Firebase Firestore ì—†ìŒ');
                return;
            }
            
            const db = firebase.firestore();
            
            // ëª¨ë“  userCarts ë¬¸ì„œ ì¡°íšŒ
            db.collection('userCarts').get()
                .then(snapshot => {
                    log('ğŸ“‹ userCarts ì»¬ë ‰ì…˜ ë¬¸ì„œ ê°œìˆ˜: ' + snapshot.size);
                    
                    let user = firebase?.auth?.currentUser;
                    if (!user && typeof getCurrentUser === 'function') {
                        const authUtilsUser = getCurrentUser();
                        if (authUtilsUser) {
                            user = authUtilsUser;
                        }
                    }
                    
                    if (!user) {
                        log('âŒ í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ì—†ìŒ - ëª¨ë“  ë¬¸ì„œ ì‚­ì œ ê±´ë„ˆëœ€');
                        return;
                    }
                    
                    log('âœ… í˜„ì¬ ì‚¬ìš©ì ì´ë©”ì¼: ' + user.email);
                    
                    const deletePromises = [];
                    
                    snapshot.forEach(doc => {
                        const docId = doc.id;
                        const docData = doc.data();
                        
                        log('ğŸ“„ ë¬¸ì„œ í™•ì¸: ' + docId);
                        log('   - ì‚¬ìš©ì ì´ë©”ì¼: ' + (docData.userEmail || 'ì—†ìŒ'));
                        log('   - ì¹´íŠ¸ ìƒí’ˆ ìˆ˜: ' + (docData.cart?.length || 0));
                        
                        // í˜„ì¬ ì‚¬ìš©ìì˜ ì´ë©”ì¼ê³¼ ë‹¤ë¥¸ ë¬¸ì„œ ID ì‚­ì œ
                        // UID í˜•ì‹ì˜ ë¬¸ì„œë“¤ë„ ëª¨ë‘ ì‚­ì œ (ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹Œ ê²½ìš°)
                        const isEmailFormat = docId.includes('@');
                        const isCurrentUser = docId === user.email;
                        
                        if (!isEmailFormat || !isCurrentUser) {
                            log('ğŸ—‘ï¸ ì˜ëª»ëœ ë¬¸ì„œ ì‚­ì œ ëŒ€ìƒ: ' + docId);
                            log('   - ì´ë©”ì¼ í˜•ì‹: ' + isEmailFormat);
                            log('   - í˜„ì¬ ì‚¬ìš©ì: ' + isCurrentUser);
                            deletePromises.push(doc.ref.delete());
                        } else {
                            log('âœ… ì˜¬ë°”ë¥¸ ë¬¸ì„œ ìœ ì§€: ' + docId);
                        }
                    });
                    
                    if (deletePromises.length > 0) {
                        log('ğŸ—‘ï¸ ' + deletePromises.length + 'ê°œ ì˜ëª»ëœ ë¬¸ì„œ ì‚­ì œ ì¤‘...');
                        return Promise.all(deletePromises);
                    } else {
                        log('âœ… ì‚­ì œí•  ì˜ëª»ëœ ë¬¸ì„œ ì—†ìŒ');
                        return Promise.resolve();
                    }
                })
                .then(() => {
                    log('âœ… ì˜ëª»ëœ ë¬¸ì„œ ì‚­ì œ ì™„ë£Œ');
                    updateStatus();
                })
                .catch(error => {
                    log('âŒ ë¬¸ì„œ ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
                });
        }
        
        function checkAuthStatus() {
            log('ğŸ” ë¡œê·¸ì¸ ìƒíƒœ ê°•ì œ í™•ì¸ ì‹œì‘');
            
            // Firebase ê°ì²´ í™•ì¸
            log('Firebase ê°ì²´: ' + (typeof firebase !== 'undefined' ? 'ì¡´ì¬' : 'ì—†ìŒ'));
            log('Firebase Auth: ' + (firebase?.auth ? 'ì¡´ì¬' : 'ì—†ìŒ'));
            
            if (firebase?.auth) {
                // í˜„ì¬ ì‚¬ìš©ì í™•ì¸ (ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ)
                let currentUser = firebase.auth.currentUser;
                
                if (!currentUser && typeof getCurrentUser === 'function') {
                    const authUtilsUser = getCurrentUser();
                    if (authUtilsUser) {
                        log('auth-utils.jsì—ì„œ ì‚¬ìš©ì ì •ë³´ ë°œê²¬: ' + authUtilsUser.email);
                        currentUser = authUtilsUser;
                    }
                }
                
                log('í˜„ì¬ ì‚¬ìš©ì: ' + (currentUser ? currentUser.email : 'ì—†ìŒ'));
                
                if (currentUser) {
                    log('ì‚¬ìš©ì ì •ë³´: ' + JSON.stringify({
                        uid: currentUser.uid,
                        email: currentUser.email,
                        displayName: currentUser.displayName,
                        emailVerified: currentUser.emailVerified
                    }));
                    
                    // ìˆ˜ë™ìœ¼ë¡œ ìƒíƒœ ì—…ë°ì´íŠ¸ (ë¡œê·¸ì¸ëœ ìƒíƒœë¡œ ê°•ì œ ì„¤ì •)
                    log('ğŸ” ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ìˆ˜ë™ í™•ì¸ - ìƒíƒœ ê°•ì œ ì—…ë°ì´íŠ¸');
                    updateStatus();
                    
                    // ì¹´íŠ¸ ë™ê¸°í™” ì„¤ì •
                    if (window.CartSyncService) {
                        log('ğŸ›’ ìˆ˜ë™ ì¹´íŠ¸ ë™ê¸°í™” ì„¤ì •');
                        window.CartSyncService.setupCartListener(currentUser.uid);
                    }
                } else {
                    log('âŒ í˜„ì¬ ì‚¬ìš©ì ì—†ìŒ');
                }
                
                // ì¸ì¦ ìƒíƒœ ë¦¬ìŠ¤ë„ˆ ê°•ì œ ì‹¤í–‰
                if (typeof firebase.auth.onAuthStateChanged === 'function') {
                    log('âœ… onAuthStateChanged í•¨ìˆ˜ ì¡´ì¬ - ë¦¬ìŠ¤ë„ˆ ì„¤ì •');
                    firebase.auth.onAuthStateChanged((user) => {
                        log('ğŸ” ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€: ' + (user ? user.email : 'ë¡œê·¸ì•„ì›ƒ'));
                        updateStatus();
                    });
                } else {
                    log('âŒ firebase.auth.onAuthStateChanged í•¨ìˆ˜ ì—†ìŒ');
                }
            } else {
                log('âŒ Firebase Auth ì‚¬ìš© ë¶ˆê°€');
            }
            
            // FirebaseService í™•ì¸
            log('FirebaseService: ' + (typeof window.FirebaseService !== 'undefined' ? 'ì¡´ì¬' : 'ì—†ìŒ'));
            log('CartSyncService: ' + (typeof window.CartSyncService !== 'undefined' ? 'ì¡´ì¬' : 'ì—†ìŒ'));
            
            updateStatus();
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ ì¹´íŠ¸ ë™ê¸°í™” í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œ');
            
            // Firebase ì´ˆê¸°í™” ëŒ€ê¸°
            setTimeout(() => {
                updateStatus();
                
                // Firebase ì¸ì¦ ìƒíƒœ ê°ì§€
                if (firebase?.auth) {
                    log('ğŸ” Firebase Auth ìƒíƒœ í™•ì¸ ì¤‘...');
                    
                    // ì¦‰ì‹œ í˜„ì¬ ì‚¬ìš©ì í™•ì¸
                    const currentUser = firebase.auth.currentUser;
                    log('í˜„ì¬ ì‚¬ìš©ì (ì¦‰ì‹œ): ' + (currentUser ? currentUser.email : 'ì—†ìŒ'));
                    
                    // ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                    if (typeof firebase.auth.onAuthStateChanged === 'function') {
                        firebase.auth.onAuthStateChanged((user) => {
                            log('ğŸ” Firebase ì¸ì¦ ìƒíƒœ ë³€ê²½: ' + (user ? user.email : 'ë¡œê·¸ì•„ì›ƒ'));
                            updateStatus();
                            
                            if (user && window.CartSyncService) {
                                log('ğŸ›’ ì‹¤ì‹œê°„ ì¹´íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •');
                                window.CartSyncService.setupCartListener(user.email);
                            }
                        });
                    } else {
                        log('âŒ firebase.auth.onAuthStateChanged í•¨ìˆ˜ ì—†ìŒ - ìˆ˜ë™ í™•ì¸');
                        // ìˆ˜ë™ìœ¼ë¡œ í˜„ì¬ ì‚¬ìš©ì í™•ì¸
                        const currentUser = firebase.auth.currentUser;
                        if (currentUser) {
                            log('ğŸ” ìˆ˜ë™ ì‚¬ìš©ì í™•ì¸: ' + currentUser.email);
                            updateStatus();
                            
                            if (window.CartSyncService) {
                                log('ğŸ›’ ì‹¤ì‹œê°„ ì¹´íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (ìˆ˜ë™)');
                                window.CartSyncService.setupCartListener(currentUser.uid);
                            }
                        }
                    }
                } else {
                    log('âŒ Firebase Auth ì‚¬ìš© ë¶ˆê°€');
                }
            }, 3000);
        });
    </script>
</body>
</html>
